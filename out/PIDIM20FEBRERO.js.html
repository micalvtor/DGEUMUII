<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: PIDIM20FEBRERO.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: PIDIM20FEBRERO.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code> /**

 * @fileoverview Desplegable PIDIM

 *

 * @version                               2.2

 *

 * @author                 Mickael Alvarez Torralba, Manuel Mallén Rodríguez &lt;mickael_at@hotmail.com,gacetuplex@gmail.com>

 * @copyright           Termotecnia


        */
//Inicializamos las variables globales
google.charts.load('current', { packages: ['bar'], 'language': 'es' });
google.charts.load('current', { packages: ['corechart'], 'language': 'es' });
google.charts.load('current', { packages: ['table'], 'language': 'es' });
var selectufindex;
var tgeoAindex;
var demanda = 0;
var consumo = 0;
var integrado = 0;
var data;
var chart;
var condicion=false;
var equiposParam = new Array();
var casosParametricosaCalcular= new Array();
var casosParametricosaCalcularManuel = new Array();
var contDiastipoCreados = 0;
var contT = 0;
var arrayselect;
var elementosSel = new Array();
var cabeceraleido = 0;
var dataArray = new Array();
var miniArray = new Array();
var rango2 = new Array();
var rango3 = new Array();
var x = 0;
var idufSel = "";
var cargarresultados = 0;
var cargar = 0;
var rango;
var unidadesFuncionalesCasoOrdenadas = new Array();
var busesAux = new Array();
var tipoConsumo = 0;
var idCaso = "";
var ordenDias="";
var consumoGuardado = false;
var nombreEquipo = new Array();
var copiaParametros = new Array();
var valoresServicio = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
var valoresServiciosComplementos = new Array();
var datosCasos = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
var nombreCaso = "";
var pre = true;
var UFGmodificadas= new Array();
var sistema = 0;
var exismod = 0;
var situacion = 1;
var prioridad = 0;
var numFlechas = new Array(0);
var numLineas = new Array(0);
var numFlechasInversa = new Array(0);
var numLineasInversa = new Array(0);
var cont = 1;
var topB = 0;
var contadoresFrio = new Array();
var contadoresCalor = new Array();
var contadoresNormales = new Array();
var caracteristicas = new Array();
var caracteristica = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
var lineasCreadas = new Array(false, false, false, false, false, false, false, false, false);
var busesGenerados = new Array(false, false, false, false, false, false, false, false, false);
var nomBuses = new Array(" &lt;105", "87-92", "62-67", "37-42", "37-42", "agua_de_red", "7-12", " >0", "Electricidad", "Ninguno", "62-67", "", "", "30-35", "15-20");
var equipos = new Array();
var serBor = new Array();
copiaSer = new Array();
var datosCambio = false;
var datosUFCambio = false;
copiabuses = new Array();
var consumo = new Array();
var buses = new Array();
var insertarSer = "";
var distancia = 0;
var usuario = "";
var caso = "";
var url = "";
var equiposN = 0;
var equiposE = 0;
var numColector = 1;
var colector = new Array();
var colectores = new Array();
var AnioConsumo = "";
var arrayUF = new Array();
var arrayContador = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
var abierto = false;
var valorIntervencion = "0";
var casosManuel = new Array();
var combinaciones = new Array();
var numFun = 0;
var arcCLi = "";
var unicodia = 0;
var countryApp = angular.module('myApp', []);
var radsel;
var suma = 0;
var n = 0;
var contmeses = 0;
var mesActual = -1;
var mesAntiguo = -1;
var sumaArray = new Array();
var mediaArray = new Array();
var Spinnerstatus;
var usuarioA;
var soloVE;
var objedificiosel = new Object();
var nombremd5;
var haypiscina = false;
var user;
var haypiscina2 = false;
var datoscsv;
var cargaNueva = true;
var Aservicios = new Array();
var AserviciosM = new Array();
var Aselectcellcalendar = new Array();
var ADequipos,ADbusescasos,ADbus,ADufcaso,ADcaso,ADcons,ADprev,ADpiscina,ADcontador,ADcalendario,ADgeometria,ADdiastipocaso,ADvaloreshorarioscaso,ADvariacionestacional,ADdetallescalendario,ADconsumo,ADfacturacion,ADcamposolar,ADusuarios;
var ADVE,diastipoVE,VEAhorario,VEhorario;
var IDcalendarioVE;
var Oequipo = {};
var equipofiltrado = [];;
var equiposfiltrados = [];
var combinacionesparametrico = [];
var jsonparametrico = "";
var equiponofiltrado = [];
var nuevainstalacion = 0;
var EquiposZero = [];
//Creamos una conexión para recibir los datos de la base de datos y los almacenamos
countryApp.factory('http', function ($http, $q) {
    return {
        get: function () {
            var deferred = $q.defer();
            $http.get.apply(null, arguments)
                .success(deferred.resolve)
                .error(deferred.resolve);
            return deferred.promise;
        }
    }
});
//Creamos una excepción en el moento que se produzca un error en el programa
countryApp.factory('$exceptionHandler', function ($log) {
    return function myExceptionHandler(exception, cause) {
        $log.error(exception, cause);
        alert('ERROR: \n' + exception + '');
        OcultarSpinner();
    };
});
//Creamos una conexión para recibir los datos de la base de datos y los almacenamos
//Cargamos también los módulos correspondientes a las distintas secciones del programa
countryApp.controller('tipos', ["$scope", "$http", "$q", "$compile", "$timeout","Hresultados","HgeometriaAvanzada","Hpiscina","Hvehiculo","Hdemandas","Hvariacionestacional","Hborrardatos","Hparametrico","HGeometria","HUtil", function ($scope, $http, $q, $compile, $timeout,Hresultados,HgeometriaAvanzada,Hpiscina,Hvehiculo,Hdemandas,Hvariacionestacional,Hborrardatos,Hparametrico,HGeometria,HUtil) {
    $scope.agrupacionesconsumo = HUtil.agrupacionesconsumo;
    $scope.combinacionesparametrico = combinacionesparametrico;
    $scope.variablesconsumos = HUtil.variablesconsumos;
    $scope.variablesconsumoshint = HUtil.variablesconsumoshint;
    $scope.tablanuevainstalacion = HUtil.tablanuevainstalacion;
    $scope.INFequipos = HUtil.INFequipos;
                $scope.totalcheckboxcont = 0;
                $scope.checkBlocks = [];
                $scope.contcheckbox = function(item) 
                {
                    if (item) {
                      $scope.totalcheckboxcont++;
                    }
                    else if ($scope.totalcheckboxcont > 0) {
                        $scope.totalcheckboxcont--;
                    }
                }
                $scope.isArray = function(obj) { 
                    var fn = Array.isArray(obj);
                    return fn;
                   }
                   $scope.selparametricoconta0 = function()
                   {
                    const inputmarked = $('#tablaparametrico input:checked');
                    for (var c = 0; c &lt; inputmarked.length ; c++)  
                    {
                        inputmarked[c].closest("tr").style.backgroundColor = "white";
                        inputmarked[c].checked = false;
                    }
                    $scope.totalcheckboxcont = 0;
                    $scope.checkBlocks = [];
                   }


                   
     for (var x = 0; x &lt; $scope.tablanuevainstalacion.Sistemas.length; x++) {
        $scope.tablanuevainstalacion.th.push($scope.tablanuevainstalacion.Sistemas[x]);
        if ($scope.tablanuevainstalacion.Sistemas[x] != "") {
            for (var y = 0; y &lt; $scope.tablanuevainstalacion.Circuitos.length; y++)
                $scope.tablanuevainstalacion.th.push($scope.tablanuevainstalacion.Circuitos[y]);
        }
    }
    $http.get('seleccionTipo.php').success(function (data) {
        $scope.tipo = data;
        //Cargamos las variables de usuario al iniciar la sesión
        usuario = sessionStorage.getItem("usuario");
        caso = sessionStorage.getItem("caso");
        abierto = sessionStorage.getItem("abierto");
        //Situamos la tabla y el menu en medio de la página
        var widthBody = ($(document.getElementById("body")).width() / 2);
        var widthEsquema = ($(document.getElementById("esquema")).width() / 2);
        distancia = widthBody - (widthEsquema + 300);
        distancia2 = widthBody - widthEsquema;
        document.getElementById("esquema").style.left = distancia;
        document.getElementById("esquema2").style.left = distancia;
        document.getElementById("menu").style.left = distancia;
        document.getElementById("menu").style = "background-color: none;display:none";
         /**

 * Definimos un nuevo caso


 * @return  {void}

 */
        nuevoCaso = function () {
            MostrarSpinner();
            combinacionesparametrico = [];
            equiposE = 0;
            equiposN = 0;
            contadoresFrio = [];
            contadoresCalor = [];
            contadoresNormales = [];
            var repetido = false;
            var email = "";
            //Pedimos el nuevo nombre por pantalla
            var name = prompt("Introduzca un nuevo nombre para el caso:");
            //Si ha escrito algo avanzamos
            if (name != '' &amp;&amp; name != null) {
                nombreCaso = name;
                //Comprobamos que no esté repetido
                for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                    if ($scope.usuarios[x].id == usuario) {
                        email = $scope.usuarios[x].email;
                    }
                }
                for (var x = 0; x &lt; $scope.caso.length; x++) {
                    if (nombreCaso == $scope.caso[x].nombre) {
                        repetido = true;
                    }
                }
                //Si no es repetido lo creamos 
                if (repetido == false) {
                    $http.post("md5.php", { 'caso': nombreCaso, 'carpeta': user.email, 'base':1}).success(function (data) {
                        nombremd5 = data;
                    })
                    $('#herramientas button').removeClass("bordeAzul");
                    $http.post("insertarCaso.php", {
                        'id': 3, 'nombre': nombreCaso, 'idusuario': usuario, 'idedificio': "-", 'carpeta': email, 'usoEdificio': 0,
                        'superficie': 0, 'altura': 0, 'plantasSobre': 0, 'plantasBajo': 0, 'comunidad': 0,
                        'provincia': 0, 'localidad': 0, 'postal': 0, 'via': 0, 'nombreVia': 0,
                        'numero': 0, 'portal': 0, 'escalera': 0, 'piso': 0, 'puerta': 0, 'bloque': 0,
                        'periodo': 0, 'nivel': 0, 'tiponum': "num", 'clima': 0, 'consim': 0, 'tempalta': 26.00, 'mesinicial': 6,
                        'tempbaja': 20.00, 'mesfinal': 9, 'impedircalefaccion': 0, 'vennocturna': 4.00, 'solove': soloVE, 'base':1
                    }).success(function (data) {
                        console.log(data);
                        datosCasos = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
                        $http.post('casos.php', { 'idusuario': usuario, 'base':1 }).success(function (data) {
                            $scope.caso = data;
                            ADcaso = data;
                            for (var x = 0; x &lt; $scope.caso.length; x++) {
                                //Cargamos los casos en función del usuario
                                if ($scope.caso[x].idusuario == usuario &amp;&amp; $scope.caso[x].nombre == nombreCaso) {
                                    idCaso = $scope.caso[x].id;
                                }
                            }
                            //Hacemos visible los elementos de la página
                            document.getElementById("esquema").style.visibility = "visible";
                            document.getElementById("menu").style.visibility = "visible";
                            document.getElementById("esquema2").style.visibility = "visible";
                            document.getElementById("lineas").style.visibility = "visible";
                            // document.getElementById("alternativas").disabled = false;
                            // document.getElementById('piscina').disabled = false;
                            // document.getElementById('vehiculo').disabled = false;
                            // document.getElementById('demandas').disabled = false;
                            // document.getElementById('nuevas').disabled = false;
                            // document.getElementById('alternativas').disabled = false;
                            // document.getElementById('optimizacion').disabled = false;
                            // document.getElementById('resultados').disabled = false;
                            document.getElementById('nombreDelCaso').innerHTML = "&lt;label>Nombre del caso:&lt;/label> " + nombreCaso;
                            vaciarcontenido();
                            $http.post('equipos.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                                $scope.equipo = data;
                                $http.post('busesCaso.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                    $scope.busesCaso = data;
                                    // document.getElementById('referencia').disabled = false;
                                });
                            });
                            $http.post("tarifaGas.php", { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                $scope.tarifaGas = data;
                            });
                            $http.post('tarifaElectrica.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                $scope.tarifaElectrica = data;
                            });
                            $http.post('facturacion.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                $scope.facturacion = data;
                                ADfacturacion = data;
                            });

                            // $http.post('piscinas.php', { 'idcaso': idCaso, }).success(function (data) {
                            //     ADpiscina = data;
                            // });
                            // $http.post('vehiculoElectrico.php', { 'idcaso': idCaso, }).success(function (data) {
                            //     $scope.vehiculo = data;
                            // });
                            $http.post('datosCaso.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                $scope.datCasos = data;
                            });
                            $http.post('contador.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                $scope.contador = data;
                                ADcontador = data;
                                // document.getElementById('contador').disabled = false;
                            });
                            $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                $scope.valoreshorarioscaso = data;
                                ADvaloreshorarioscaso = data;
                                $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                                    $scope.diastipocaso = data;
                                    ADdiastipocaso = data;
                                    $http.post('calendarios.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                        $scope.calendario = data;
                                        ADcalendario = data;
                                        // $http.post('detallesCalendario.php').success(function (data) {
                                        //     $scope.detallesCalendario = data;
                                        //     // document.getElementById('operacional').disabled = false;
                                        // });
                                    });
                                    $http.post('geometria.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                        ADgeometria = data;
                                        ADgeometria = data;
                                        // document.getElementById('geoycon').disabled = false;
                                    });
                                    $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                        $scope.ufCaso = data;
                                        ADufcaso = data;
                                        // document.getElementById('general').disabled = false;
                                        updateComunidad(1);
                                        OcultarSpinner();
                                    });
                                    document.getElementById("esquema").style.visibility = "visible";
                                    document.getElementById("menu").style.visibility = "visible";
                                    document.getElementById("esquema2").style.visibility = "visible";
                                    document.getElementById("lineas").style.visibility = "visible";
                                });
                            });
                        });
                        $http.post('variacionEstacional.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                            $scope.variacionEstacional = data;
                            ADvariacionestacional = data;
                        });
                    });
                }
                //Si no mostramos el siguiente mensaje 
                else {
                    alert('Ya existe un caso para el usuario con el mismo nombre');
                    OcultarSpinner();
                }
            }
            else
                OcultarSpinner();
        }
        /**

 * Eliminamos un caso

 * @return  {void}

 */
        eliminarCaso = async function (nombrecaso) {
            //Cargamos todos los datos pertenecientes al caso
            await cargartodoBD(nombrecaso);
            for (var u = 0; u &lt; $scope.calendario.length; u++) {
                if ($scope.calendario[u].iduf == 0 &amp;&amp; $scope.calendario[u].idcaso == nombrecaso) {
                    IDcalendarioVE =  $scope.calendario[u].id;
                }
            }
            //Borramos en todas las tablas los valores del caso borrado
            await $http.post("md5.php", { 'caso': objedificiosel.nombredelcaso, 'carpeta': user.email,'base':1 }).success(function (data) {
                nombremd5 = data;
            })
            Hborrardatos.borrardatosBD();
            Hborrardatos.Borrartodo();
            $('#herramientas button').removeClass("bordeAzul");
            $http.post("borrarEquipo.php", { 'idcaso': nombrecaso, 'nuex': "Existente",'base':1 })
                .success(function () {
                });
            //Introducimos la lista actual de equipos
            $http.post("borrarBusesCaso.php", { 'idcaso': nombrecaso, 'nuex': "Existente" ,'base':1})
                .success(function () {
                });
            $http.post("borrarEquipo.php", { 'idcaso': nombrecaso, 'nuex': "Nuevo",'base':1 })
                .success(function () {
                });
            //Introducimos la lista actual de equipos
            $http.post("borrarBusesCaso.php", { 'idcaso': nombrecaso, 'nuex': "Nuevo",'base':1 })
                .success(function () {
                });
            if (typeof ($scope.contador) !== "undefined") {
                for (var x = 0; x &lt; $scope.contador.length; x++) {
                    id = $scope.contador[x].id;
                    $http.post("borrarTodoConsumo.php", { 'idcontador': id,'base':1 })
                        .success(function (data) {
                            console.log(data);
                        });
                }
                $http.post("borrarTodoContador.php", { 'idcaso': nombrecaso,'base':1 })
                    .success(function (data) {
                        console.log(data);
                    });
            }
            $http.post("borrarVariacionEstacional.php", { 'idcaso': nombrecaso,'base':1 })
                .success(function (data) {
                    console.log(data);
                });
            if (typeof (ADgeometria) !== "undefined") {
                if (ADgeometria.length > 0) {
                    $http.post("borrarGeometria.php", { 'idcaso': nombrecaso, 'iduf': ADgeometria[0].iduf,'base':1 }).success(function (data) {
                        console.log(data);
                    });
                }
            }
            if (typeof ($scope.ufCaso) !== "undefined") {
                if ($scope.ufCaso.length > 0) {
                    for (var i = 0; i &lt; $scope.ufCaso.length; i++) {
                        valido = $scope.ufCaso[i].iduf;
                        valido2 = $scope.ufCaso[i].id;
                    $http.post("borrarCalendario.php", { 'idcaso': idCaso, 'iduf': valido2,'base':1 })
                        .success(function (data) {
                            console.log(data);
                            for (var z = 0; z &lt; $scope.calendario.length; z++) {
                                if ($scope.calendario[z].iduf == valido2 &amp;&amp; $scope.calendario[z].idcaso == nombrecaso) {
                                    $http.post('borrarDetalleCalendario.php', { 'idcalendario': $scope.calendario[z].id,'base':1 }).success(function (data) {
                                        console.log(data);

                                    });
                                }
                            }

                        });
                    $http.post("borrarDias2.php", {
                        'id_caso': nombrecaso,'base':1
                    }).success(function (data) {
                        console.log(data);
                        $http.post("borrarUnidadesFuncionalesCaso.php", { 'idcaso': nombrecaso,'base':1 })
                            .success(function (data) {
                                console.log(data);
                            });
                        for (var z = 0; z &lt; $scope.diastipocaso.length; z++) {
                            if ($scope.diastipocaso[z].id_caso == nombrecaso) {
                                idtipodia = $scope.diastipocaso[z].id_diatipo;
                                $http.post("borrarValores.php", {
                                    'id_diatipo': idtipodia,'base':1
                                }).success(function (data) {
                                    console.log(data);
                                });
                            }
                        }
                    });
                }
            }
            }
            $http.post("borrarFacturacion.php", { 'idcaso': nombrecaso,'base':1 })
                .success(function () {
                    $http.post("borrarTarifaElectrica.php", { 'idcaso': nombrecaso,'base':1 })
                        .success(function () {
                            $http.post("borrarTarifaGas.php", { 'idcaso': nombrecaso,'base':1 })
                        .success(function () {
                });
        });
                });
                //Desactivamos todos los botones de la página
            document.getElementById("contenido").style.display = "none";
            document.getElementById("general").disabled = true;
            document.getElementById("contador").disabled = true;
            document.getElementById("referencia").disabled = true;
            document.getElementById("geoycon").disabled = true;
            document.getElementById("operacional").disabled = true;
            document.getElementById("piscina").disabled = true;
            document.getElementById("vehiculo").disabled = true;
            document.getElementById("demandas").disabled = true;
            document.getElementById("nuevas").disabled = true;
            document.getElementById("alternativas").disabled = true;
            document.getElementById("optimizacion").disabled = true;
            document.getElementById("resultados").disabled = true;
            $http.post("borrarCaso.php", { 'id': nombrecaso, 'idusuario': usuario,'base':1 })
                .success(function (data) {
                    console.log(data);
                    $http.post('casos.php', { 'idusuario': usuario,'base':1 }).success(function (data) {
                        $scope.caso = data;
                        ADcaso = data;
                        document.getElementById('nombreDelCaso').innerHTML = "No hay ningún caso asignado";
                        $('#myModalCasos').modal('hide');
                        for (var x = 0; x &lt; datosCasos.length; x++) {
                            datosCasos[x] = 0;
                        }
                        nombreCaso = "";
                    });
                });

        }
        /**

 * Cargamoms el contador

 * @return  {void}

 */
        selectorusocontador = function () 
        {
            //Cargamos las opciones si ya hay un periodo de consumo creado
            if ($('input:radio[name=radioUsos]').length == 0 || $('.dropdown-menu')[1] == undefined)
                return
            var usos = $('input:radio[name=radioUsos]');
            var periodos = $('input:radio[name=tipoConsumo]')
            //Si la opción de vehículos eléctricos es seleccionado cargamos el apartado de vehículo eléctrico
            if (usos[8].checked == true)
                selectorusocontadorVE(usos, periodos);
                //Si no hay periodos no se carga el menú
            else if ($('.dropdown-menu')[1].children.length &lt; 2)
                for (var x = 0; x &lt; periodos.length; x++)
                    periodos[x].disabled = false;
            //Si se cambia el tipo de contadores se bloquean los periodos
            usos.change(function () {
                if (usos[8].checked == true)
                    selectorusocontadorVE(usos, periodos);
                else
                //Si la opción de vehículos eléctricos es seleccionado cargamos el apartado de vehículo eléctrico
                    for (var x = 0; x &lt; periodos.length; x++)
                        periodos[x].disabled = false;
            })
            if (selectorusocontadorVE(usos, periodos) === false)
                return false;
        }
        /**

 * Cargamos los periodos para el contador devehículo eléctrico

 * @return  {boolean}

 */
        selectorusocontadorVE = function (usos, periodos) {
            //Dejamos únicamente la opción horaria
            if (usos[8].checked == true) {
                periodos[0].disabled = true;
                periodos[1].disabled = true;
                periodos[2].checked = true;
                cargarTablas(3);
                //Desactivamos los otros botones de uso
                if ($('.dropdown-menu')[1].children.length > 1) {
                    for (var x = 0; x &lt; usos.length; x++)
                        if (x != 4)
                            usos[x].disabled = true;
                }
                else
                    for (var x = 0; x &lt; usos.length; x++)
                        usos[x].disabled = false;
            }
            else
                return false;
        }
         /**

        * Cargamos el menú de los contadores

        * @return  {void}

         */
        updateContadores = function () {
            //Cargamos el contenido anterior
            vaciarcontenido();
            document.getElementById("esquema").style.display = "none";
            document.getElementById("imagenes").style.display = "flex";
            document.getElementById("contenido").style.display = "initial";
            document.getElementById("menu").style = "background-color: none;display:none";
            var contadores = 1;
            MostrarSpinner();
            //Cargamos los datos
            $http.post('consumoContador.php',{'base':1}).success(function (data) {
                $scope.consumo = data;
                ADconsumo = data;
            });
             //Cargamos el contenido de la sección
            var menu = "";
            menu += "&lt;label style='display: block ;vertical-align: middle'>Contador:&lt;/label>";
            menu += " &lt;div class='input-group' style='display: flex;flex-wrap: wrap-reverse;' >"
            menu += " &lt;input type='text' id='nombreNuevoContador' style='transform: scale(1);  class='form-control' aria-label='Text input with segmented dropdown button' >";
            menu += " &lt;div class='input-group-prepend' style='display:inline;'>";
            menu += "    &lt;button  style='transform: scale(1); margin-left:10px;'class='btnMenu' onclick='crearContadorVacio()'>Añadir&lt;/button>";
            menu += "    &lt;button   style='transform: scale(1);' class='btnMenu' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
            menu += "      Seleccionar&lt;/button>";
            menu += "   &lt;button  style='transform: scale(1);background-color:orangered;' class='btnMenu' onclick='eliminarContador()'>Eliminar&lt;/button>";
            menu += "   &lt;div class='dropdown-menu' style='margin-top:-1px;'>";
            for (var x = 0; x &lt; $scope.contador.length; x++)
                if ($scope.contador[x].idcaso == idCaso) {
                    menu += "&lt;a href='#'>&lt;option class='hover' value='" + x + "' id='contador" + $scope.contador[x].nombre + "' onclick='elegirContador(" + $scope.contador[x].id + ")'>" + $scope.contador[x].nombre + "&lt;/option>&lt;/a>";
                    contadores++;
                }
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style='margin-top:20px;' id='opcionesContador'>";
            menu += "&lt;label style='display: block ;vertical-align: middle'>Vector Energético: &lt;/label>";
            // if (width > 966) {
            menu += "&lt;select id='vectorEnergético' style='width: auto;text-align: center;  text-align-last: center;' onchange='guardarVector(0)'>";
            menu += "&lt;option hidden selected >- Selecciona -&lt;/option>";
            menu += "&lt;option value='Gas Natural'>Gas Natural&lt;/option>";
            menu += "&lt;option value='Electricidad'>Electricidad&lt;/option>";
            menu += "&lt;option value='Biomasa'>Biomasa&lt;/option>";
            menu += "&lt;option value='Gasoil'>Gasoil&lt;/option>";
            menu += "&lt;option value='Energías Renovables'>Energías Renovables&lt;/option>";
            menu += "&lt;/select>";
            // }
            // else
            //     menu += "&lt;button id='vectorEnergético' class='btnMenu' style='background-color:orange' data-toggle='modal' data-target='#myModalVector'>Vector Energético&lt;/button>";
            //cargamos los datos del contador seleccionado
            menu += "&lt;label style='display: block ;vertical-align: middle;margin-top:20px;'>Uso:&lt;/label>";
            menu += "&lt;input type='radio' name='radioUsos' style='margin-bottom: 15px; margin-top:10px;' id='serviciosContador0' onclick='guardarOpcion(0)' value='calefaccion' /> &amp;nbsp; Calefacción &lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador1' onclick='guardarOpcion(1)' value='refrigeracion' /> &amp;nbsp; Refrigeración &lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador2' onclick='guardarOpcion(2)' value='iluminacion' /> &amp;nbsp; ACS &lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador3' onclick='guardarOpcion(3)' value='Otros usos electricos' /> &amp;nbsp; Iluminación&lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador4' onclick='guardarOpcion(4)' value='vehiculo eléctrico' /> &amp;nbsp; Otros eléctricos&lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador5' onclick='guardarOpcion(5)' value='lavanderia' /> &amp;nbsp; Lavandería&lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador6' onclick='guardarOpcion(6)' value='frío industrial' /> &amp;nbsp; Frío Industrial&lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='margin-bottom: 13px;' id='serviciosContador7' onclick='guardarOpcion(7)' value='climatizacion piscina' /> &amp;nbsp; Vehículo eléctrico&lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='display:none;margin-bottom: 13px;' id='serviciosContador8' onclick='guardarOpcion(8)' value='acs piscina' /> &amp;nbsp;&lt;/br>";
            menu += "&lt;input type='radio' name='radioUsos'style='display:none;margin-bottom: 13px;' id='serviciosContador9' onclick='guardarOpcion(9)'  value='calefaccion vaso piscina' /> &amp;nbsp;&lt;/br>";
            menu += "&lt;button class='btnMenu' id='editarConsumo' onclick='cargarConsumo()' style='margin-top:5%' disabled>Editar periodo lectura&lt;/button>&lt;/br>&lt;/br>";
            menu += "&lt;/div> ";
            menu += "&lt;div id='contenidoContador'>";
            menu += "&lt;/div>&lt;br />";
            menu += "&lt;button class='btnMenu' id='botonContador'style='background-color:orange; margin-top:20px;' onclick='guardarContador()'>Aceptar&lt;/button>&lt;/div>\n";
            OcultarSpinner();
            document.getElementById("contenido").innerHTML = menu;
            document.getElementById("menu").innerHTML = "";
            document.getElementById("esquema2").innerHTML = "";
            HUtil.CambiarColor_Children_Select();
            //Recalculamos la distancia de nuevo para situarlo en el centro
            document.getElementById("menu").style.left = distancia;
            document.getElementById("esquema2").innerHTML = "";
            document.getElementById('opcionesContador').style.display = "none";
            document.getElementById('contenidoContador').style.display = "none";
            document.getElementById("lineas").innerHTML = "";
            if (document.getElementById("editarConsumo").disabled == true)
                document.getElementById('opcionesContador').style.position = "static";
            if (contadores > 1) {
                for (var x = 0; x &lt; $scope.contador.length; x++)
                    if ($scope.contador[x].idcaso == idCaso)
                        elegirContador($scope.contador[x].id);
            }
            selectorusocontador();
        }
        
        /**

        * seleccionamos el contador que vamos a modificar

        * @return  {void}

         */
        seleccionContador = function () {
            menu = "";
            for (var x = 0; x &lt; $scope.contador.length; x++)
                if ($scope.contador[x].id == idCaso)
                    menu += "&lt;button class='btnMenu' data-toggle='modal' data-target='#myModalModContador' data-dismiss='modal' onclick='cargarContador(" + $scope.contador[x].nombre + ")'> $scope.contador[x].nombre&lt;/button>&lt;br />";
        }
        /**

        * Cargamos el nombre del contador y sus valores

        * @return  {void}

         */
        cargarContador = function (contador) {
            //Cargamos el nombre del contador
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].id == idCaso &amp;&amp; $scope.contador[x].nombre == contador) {
                    document.getElementById('nombreContador').innerHTML;
                    //Cargamos el uso del contador
                    if ($scope.contador[x].calefaccion == "1") {
                        document.getElementById('serviciosContador3').checked = true;
                        arrayContador[3] = 1;
                    }
                    if ($scope.contador[x].refrigeracion == "1") {
                        document.getElementById('serviciosContador4').checked = true;
                        arrayContador[4] = 1;
                    }
                    if ($scope.contador[x].acs == "1") {
                        document.getElementById('serviciosContador5').checked = true;
                        arrayContador[5] = 1;
                    }
                    if ($scope.contador[x].piscina == "1") {
                        document.getElementById('serviciosContador6').checked = true;
                        arrayContador[6] = 1;
                    }
                    if ($scope.contador[x].iluminacion == "1") {
                        document.getElementById('serviciosContador7').checked = true;
                        arrayContador[7] = 1;
                    }
                    if ($scope.contador[x].fuerza == "1") {
                        document.getElementById('serviciosContador8').checked = true;
                        arrayContador[8] = 1;
                    }
                    if ($scope.contador[x].cocina == "1") {
                        document.getElementById('serviciosContador9').checked = true;
                        arrayContador[9] = 1;
                    }
                    if ($scope.contador[x].otros == "1") {
                        document.getElementById('serviciosContador10').checked = true;
                        arrayContador[10] = 1;
                    }
                }
            }
        }
        /**

        * Cargamos un caso

        * @return  {void}

         */
        updateCasos2 = function (num) {
            var casos = "";
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                //Cargamos los casos en función del usuario
                if (num == 1) {
                    casos += "&lt;button class='mostrarSer' onclick='temporal(" + $scope.caso[x].id + ")'>" + $scope.caso[x].nombre + "&lt;/button>\n&lt;br/>\n";
                } else if (num == 2) {
                    casos += "&lt;button class='mostrarSer' onclick='eliminarCaso(" + $scope.caso[x].id + ")'>" + $scope.caso[x].nombre + "&lt;/button>\n&lt;br/>\n";
                }
            }
            document.getElementById("TiposCasos").innerHTML = casos;
            $('#myModalCasos').modal('hide');
        }
        /**

        * Guardamos el nombre del caso en una variable global

        * @param  {string}
        * @return  {void}

         */
        temporal = function (escogido) {
            //Iniciamos los datos paramétricos
            casosParametricosaCalcularManuel = [];
            $scope.totalcheckboxcont = 0;
            $scope.combinacionesparametrico = [];
            combinacionesparametrico = [];
            equiposParam = [];
            $('#herramientas button').removeClass("bordeAzul");
            equiposE = 0;
            equiposN = 0;
            contadoresFrio = [];
            contadoresCalor = [];
            contadoresNormales = [];
            $scope.guardadobateriainversor = {};
            document.getElementById("esquema").style.visibility = "hidden";
            document.getElementById("menu").style.visibility = "hidden";
            document.getElementById("esquema2").style.visibility = "hidden";
            document.getElementById("lineas").style.visibility = "hidden";
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                //Cargamos los casos en función del usuario
                if ($scope.caso[x].id == escogido) {
                    nombreCaso = $scope.caso[x].nombre;
                    idCaso = $scope.caso[x].id;
                }
            }
            document.getElementById("esquema").style.visibility = "visible";
            document.getElementById("menu").style.visibility = "visible";
            document.getElementById("esquema2").style.visibility = "visible";
            document.getElementById("lineas").style.visibility = "visible";

            //Cargamos sus valores
            document.getElementById('nombreDelCaso').innerHTML = "&lt;label>Nombre del caso:&lt;/label> " + nombreCaso;
            vaciarcontenido();
            $http.post("tarifaGas.php", { 'idcaso': idCaso,'base':1 }).success(function (data) {
                $scope.tarifaGas = data;
            });
            $http.post('tarifaElectrica.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.tarifaElectrica = data;
            });
            $http.post('facturacion.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                $scope.facturacion = data;
                ADfacturacion = data;
            });

            $http.post("md5.php", { 'caso': nombreCaso, 'carpeta': user.email,'base':1 }).success(function (data) {
                nombremd5 = data;
            })
            $http.post('equipos.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.equipo = data;
                for (var x = 0; x &lt; $scope.equipo.length; x++) {
                    if ($scope.equipo[x].nuex == "Nuevo") {
                        equiposN++;
                    }
                    if ($scope.equipo[x].nuex == "Existente") {
                        equiposE++;
                    }
                }
                $http.post('busesCaso.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                    $scope.busesCaso = data;
                    // document.getElementById('referencia').disabled = false;
                });
            });
            $http.post('datosCaso.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                $scope.datCasos = data;
            });
            $http.post('appPidim/Componentes/Piscinas/Piscinas.php', { 'idcaso': idCaso, 'action':'cargar' }).success(function (data) {
                ADpiscina = data;
            });
            // $http.post('vehiculoElectrico.php', { 'idcaso': idCaso, }).success(function (data) {
            //     $scope.vehiculo = data;
            // });
            $http.post('variacionEstacional.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                $scope.variacionEstacional = data;
                ADvariacionestacional = data;
            });
            $http.post('contador.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                $scope.contador = data;
                ADcontador = data;
                // document.getElementById('contador').disabled = false;
            });
            $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.valoreshorarioscaso = data;
                ADvaloreshorarioscaso = data;
                $http.post('diasTipoCaso.php', { 'id_caso': idCaso,'base':1 }).success(function (data) {
                    $scope.diastipocaso = data;
                    ADdiastipocaso = data;
                    $http.post('calendarios.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                        $scope.calendario = data;
                        ADcalendario = data;
                        // $http.post('detallesCalendario.php').success(function (data) {
                        // $scope.detallesCalendario = data;
                        //  // document.getElementById('operacional').disabled = false;
                    });
                    // });
                    $http.post('geometria.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                        ADgeometria = data;
                        ADgeometria = data;
                        // document.getElementById('geoycon').disabled = false;
                    });
                    $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                        $scope.ufCaso = data;
                        ADufcaso = data;
                        // document.getElementById('general').disabled = false;
                        updateComunidad(1);
                        // OcultarSpinner();
                    });
                    document.getElementById("esquema").style.visibility = "visible";
                    document.getElementById("menu").style.visibility = "visible";
                    document.getElementById("esquema2").style.visibility = "visible";
                    document.getElementById("lineas").style.visibility = "visible";
                });
            });
            $http.post('appPidim/Componentes/VehiculoElectrico/VehiculoElectrico.php', {'action':'cargar', 'idcaso': idCaso, }).success(function (data) {
                $scope.vehiculoElectrico = data;
                ADVE = data;
            });
            $('#myModalCasos').modal('hide');
            MostrarSpinner();
        }

        /**

        * Seleccionamos el contador y cargamos las opciones y los datos del contador

        * @param  {string}
        * @return  {void}

         */
        elegirContador = function (id) {
            var nombre = "";
            //Cargamos contador
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].id == id) {
                    nombre = $scope.contador[x].nombre;
                }
            }
            var valido = id;
            //Adaptamos la pantalla y mostramos los valores
            document.getElementById('nombreNuevoContador').value = nombre;
            // if (width > 966) {
            document.getElementById('opcionesContador').style.display = "block";
            if (document.getElementById('opcionesContador').style.visibility == "visible") { document.getElementById('opcionesContador').style.position = "static"; };
            document.getElementById('contenidoContador').innerHTML = "";
            if (valido == "") {
                document.getElementById('opcionesContador').style.visibility = "hidden";
                if (document.getElementById('opcionesContador').style.visibility == "hidden") { document.getElementById('opcionesContador').style.position = "static"; };
                document.getElementById('contenidoContador').innerHTML = "";
                document.getElementById('vectorEnergético').value = "- Selecciona -";
                document.getElementById("editarConsumo").disabled = true;
                for (var x = 0; x &lt; 10; x++) {
                    document.getElementById('serviciosContador' + x).disabled = true;
                }
            } else {
                for (var x = 0; x &lt; 10; x++) {
                    document.getElementById('serviciosContador' + x).disabled = false;
                }
                for (var x = 0; x &lt; $scope.contador.length; x++) {
                    if ($scope.contador[x].id == valido) {
                        document.getElementById('vectorEnergético').value = $scope.contador[x].vector;
                        arrayContador[2] = document.getElementById('vectorEnergético').value;
                        document.getElementById("editarConsumo").disabled = false;
                        for (var z = 0; z &lt; $scope.consumo.length; z++) {
                            if ($scope.consumo[z].idcontador == valido) {
                                cargarConsumo();
                                break;
                            }
                        }
                        for (var y = 0; y &lt; 10; y++) {
                            document.getElementById('serviciosContador' + y).disabled = false;
                        }
                        document.getElementById('serviciosContador' + $scope.contador[x].tipo).checked = true;
                        arrayContador[3] = $scope.contador[x].tipo;
                    }
                }
            }
            // } else {
            //     for (var x = 0; x &lt; $scope.contador.length; x++) {
            //         if ($scope.contador[x].id == valido) {
            //             arrayContador[0] = valido;
            //             arrayContador[2] = $scope.contador[x].vector;
            //             arrayContador[3] = $scope.contador[x].tipo;
            //         }
            //     }
        }
        /**

        * Guardamos la opcion y activamos el botón editar

        * @param  {number}
        * @return  {void}

         */
        guardarOpcion = function (numero) {
            var radiosActivo = false;
            //Marcamos la opción activada y descativamos la anterior
            if (document.getElementById("serviciosContador" + numero).checked == true) {
                document.getElementById('serviciosContador' + numero).checked = true;
                arrayContador[3] = numero;
            } else {
                document.getElementById('serviciosContador' + numero).checked = false;
                arrayContador[3] = numero;
            }
            for (var y = 0; y &lt; 10; y++) {
                if (document.getElementById('serviciosContador' + y).checked == true) {
                    radiosActivo = true;
                    break;
                }
            }
            // Activamos el botón del consumo
            if (radiosActivo == true) {
                document.getElementById("editarConsumo").disabled = false;
            } else {
                document.getElementById("editarConsumo").disabled = true;
            }
        }

        /**

        * Eliminamos el consumo del año seleccionado

        * @return  {void}

         */
        eliminarConsumo = function () {
            consumoGuardado = false;
            var select2 = document.getElementById("nombreNuevoConsumo").value;
            var id = "";
            var select = document.getElementById("nombreNuevoContador").value;
            var contador = "";
            //Cogemos los datos del contador
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == select) {
                    contador = $scope.contador[x].id;
                    break;
                }
            }
            //Cogemos los datos del consumo a borrar
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].periodo == select2 &amp;&amp; $scope.consumo[x].idcontador == contador) {
                    id = $scope.consumo[x].id;
                    break;
                }
            }
            if (id != "") {
                for (var i = 0; i &lt; $scope.consumo.length; i++) {
                    if (id == $scope.consumo[i].id) {
                        var element = document.getElementById("opcionConsumo" + select2);
                        element.parentNode.parentNode.removeChild(element.parentNode)
                    }
                }
                //Borramos el consumo si está seleccionado
                if (select2 != 0) {
                    $http.post("borrarConsumo.php", { 'idcontador': contador, 'periodo': select2,'base':1 })
                        .success(function (data) {
                            console.log(data);
                            $http.post('consumoContador.php',{'base':1}).success(function (data) {
                                $scope.consumo = data;
                                ADconsumo = data;
                                if (document.getElementsByClassName('dropdown-menu')[1].childElementCount > 0) {
                                    document.getElementById("nombreNuevoConsumo").value = document.getElementsByClassName('dropdown-menu')[1].children[0].innerText;
                                    document.getElementsByClassName('dropdown-menu')[1].children[0].children[0].click()
                                }
                                else {
                                    document.getElementById("nombreNuevoConsumo").value = "";
                                    document.getElementById('tipoConsumo').style.display = "none";
                                    document.getElementById('tipoConsumo2').innerHTML = "";
                                }
                            });
                        });
                }
            }
            else
                alert("Escoja el consumo que desee borrar");
        }
        
        /**

        * Cargamos los datos correspondientes a las operaciones

        * @return  {void}

         */
        updateOperaciones = async function () {
            MostrarSpinner();
            //Cargamos la pantalla de operaciones
            await $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                $scope.valoreshorarioscaso = data;
                ADvaloreshorarioscaso = data;
            });
            var numDiasTipo = 0;
            var contVHC = 0;
            //Seleccionamos los datos operacionales corrpsondientes al caso y a la unidad funcional
            for (var x = 0; x &lt; $scope.usuarios.length; x++)
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si")
                    usuarioA = true;
            if ($scope.ufCaso.length > 0) {
                for (var z = 0; z &lt; $scope.ufCaso.length; z++) {
                    for (var x = 0; x &lt; $scope.diastipocaso.length; x++)
                        if ($scope.ufCaso[z].id == $scope.diastipocaso[x].id_uf)
                            numDiasTipo++;
                }
                for (var z = 0; z &lt; $scope.ufCaso.length; z++) {
                    for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                        for (var y = 0; y &lt; $scope.valoreshorarioscaso.length; y++)
                            if ($scope.valoreshorarioscaso[y].id_diatipo == $scope.diastipocaso[x].id_diatipo &amp;&amp; $scope.diastipocaso[x].id_uf == $scope.ufCaso[z].id)
                                contVHC++;
                    }
                }
                //Ajustamos la pantalla
                if (contVHC == (numDiasTipo * 24)) {
                    document.getElementById("imagenes").style.display = "flex";
                    document.getElementById("contenido").style.display = "initial";
                    document.getElementById("menu").style = "background-color: none;display:none";
                    document.getElementById("esquema2").style = 'margin-left:22%';
                    var menu = "";
                    if ($scope.ufCaso.length > 1 &amp;&amp; $scope.ufCaso.length != 0) {
                        menu += " &lt;div class='input-group' style='display: flex;flex-wrap: wrap-reverse;' >"
                        menu += " &lt;input type='text' id='operacionesUF' style='transform: scale(1);  class='form-control' aria-label='Text input with segmented dropdown button' >";
                        menu += " &lt;div class='input-group-prepend' style='display:inline;'>";
                        menu += "    &lt;button   style='transform: scale(1);' class='btnMenu' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                        menu += "      Seleccionar&lt;/button>";
                        menu += "   &lt;div class='dropdown-menu' style='margin-top:-1px;'>";
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso) {
                                menu += "&lt;a href='#'>&lt;option class='hover' value='" + x + "' id='operaciones" + $scope.ufCaso[x].nombre + "' onclick='cargarDiasTipoOperacional(" + $scope.ufCaso[x].id + ")'>" + $scope.ufCaso[x].nombre + "&lt;/option>&lt;/a>";
                            }
                        }
                    } else {
                        menu += "&lt;label style='display: block ;vertical-align: middle; margin-top:10px;'>Unidad funcional: &lt;/label />";
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso) {
                                menu += "&lt;span style='display:flex;margin-bottom:20px;'>" + $scope.ufCaso[x].nombre + "&lt;/span>";
                                menu += "&lt;span id='operacionesUF' style='display:none'>" + $scope.ufCaso[x].iduf + "&lt;/span>";
                            }
                        }
                    }
                    menu += "&lt;/div>";
                    menu += "&lt;/div>";
                    menu += "&lt;/div>";
                    menu += "&lt;label style='display:flex;margin-top:20px;;'>Día Tipo:&lt;/label>";
                    // if (width > 966) {
                    menu += " &lt;div class='input-group' style='display: flex;flex-wrap: wrap-reverse;' >"
                    menu += "&lt;div style='display:inline-block; margin-bottom:20px;'>"
                    menu += " &lt;input type='text' id='nombreDiaTipo' style='transform: scale(1); width: 380px;'  aria-label='Text input with segmented dropdown button' >";
                    menu += "&lt;/div>"
                    menu += " &lt;div class='input-group-prepend' style='display:inline;'>";
                    if (usuarioA == true) {
                        menu += "&lt;button  style='transform: scale(1);margin-left:10px;margin-bottom:10px;'class='btnMenu' onclick='crearDiaTipo()'>Añadir&lt;/button>";
                        menu += "&lt;button  style='transform: scale(1);margin-left:10px;margin-bottom:10px;background-color:orangered;' class='btnMenu' onclick='eliminarDiaTipo()'>Eliminar&lt;/button>";
                    }
                    menu += "&lt;button   style='transform: scale(1);margin-left:10px;margin-bottom:10px;' class='btnMenu' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                    menu += "Seleccionar&lt;/button>";

                    menu += "&lt;div class='dropdown-menu' id='diasUF'style='margin-top: -21px;'>";
                    for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                        if ($scope.diastipocaso[x].id_caso == idCaso &amp;&amp; $scope.ufCaso[0].id == $scope.diastipocaso[x].id_uf) {
                            menu += "&lt;a href='#'>&lt;option class='hover' value='" + x + "' id='dias" + $scope.diastipocaso[x].nombre + "' onclick='updateDatosOperacionales(" + $scope.diastipocaso[x].id_diatipo + ")'>" + $scope.diastipocaso[x].nombre + "&lt;/option>&lt;/a>";
                        }
                    }
                    menu += "&lt;/div>";
                    menu += "&lt;/div>";
                    menu += "&lt;/div>";
                    // } else {
                    //     menu += "&lt;span id='diaTipos'>&lt;/span>";
                    //     menu += "&lt;button class='btnMenu' style='background-color:orange' data-toggle='modal' data-target='#myModalDiaTipo'>Días tipo&lt;/button>";
                    // }
                    menu += "&lt;label style='display:flex;'>Horarios de funcionamiento:&lt;/label>";
                    menu += "&lt;span style='display:flex;'>CALEFACCIÓN&lt;/span>";
                    menu += "&lt;div class='table-responsive'>";
                    menu += "&lt;table id='horarioCalefaccion' class='table'>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 9; x++)
                        menu += "&lt;td style='background-color: lightcoral;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>" + (x + 1) + "&lt;/td>\n";
                    for (var x = 9; x &lt; 24; x++)
                        menu += "&lt;td style='background-color: lightcoral;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>" + (x + 1) + "&lt;/td>\n";
                    menu += "&lt;/tr>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++) {
                        if (usuarioA == true) {
                            menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:25px;height:25px;font-size:75%;'contenteditable='true'>0&lt;/td>";
                        } else {
                            menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:25px;height:25px;font-size:75%;'>0&lt;/td>";
                        }
                    }
                    menu += "&lt;/tr>";
                    menu += "&lt;/table>";
                    menu += "&lt;/div>";
                    menu += "&lt;span style='display:flex; margin-top:10px;'>REFRIGERACIÓN&lt;/span>";
                    menu += "&lt;div class='table-responsive'>";
                    menu += "&lt;table  id='horarioRefrigeracion' class='table'>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++)
                        menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>" + (x + 1) + "&lt;/td>\n";
                    menu += "&lt;/tr>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++) {
                        if (usuarioA == true) {
                            menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:25px;height:25px;font-size:75%;' contenteditable='true'>0&lt;/td>";
                        } else {
                            menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:25px;height:25px;font-size:75%;'>0&lt;/td>";
                        }
                    }
                    menu += "&lt;/tr>";
                    menu += "&lt;/table>";
                    menu += "&lt;/div>";
                    menu += "&lt;label style='display:flex; margin-top:20px;'>Fuentes internas:&lt;/label>";
                    menu += "&lt;div style='margin-bottom:20px;'>"
                    menu += "&lt;span>Ocupación Máxima(persona/m2):&lt;/span>";
                    menu += "&lt;input style='transform:scale(1);margin-left:10px;' size='4' maxlength='5'type='text' id='ocupacionPersona' value='-'>";
                    menu += "&lt;/div>"
                    menu += "&lt;span style='display:flex;'>Fracción Horaria de ocupación &lt;/span>";
                    menu += "&lt;div class='table-responsive'>";
                    menu += "&lt;table style='margin-bottom: 20px;'  id='ocupacionPersonaTabla' class='table'>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++)
                        menu += "&lt;td style='background-color: lightgray;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>" + (x + 1) + "&lt;/td>\n";
                    menu += "&lt;/tr>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++) {
                        if (usuarioA == true) {
                            menu += "&lt;td style='border:solid 1px black;font-size: 75%;white-space: nowrap;width: 100px;' contenteditable='true'>0&lt;/td>";
                        } else {
                            menu += "&lt;td style='border:solid 1px black;font-size: 75%;white-space: nowrap;width: 100px;' >0&lt;/td>";
                        }
                    }
                    menu += "&lt;/tr>";
                    menu += "&lt;/table>";
                    menu += "&lt;/div>";
                    menu += "&lt;div style = 'display: flex; flex-wrap: wrap; justify-content: space-between; margin-top:10px; ' >"
                    menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
                    menu += "&lt;span>Iluminación Máxima(W/m2):&lt;/span>";
                    menu += "&lt;input style='transform:scale(1);margin-left:10px;'maxlength='6' size='4'type='text' id='iluOpera' value='-'>";
                    menu += "&lt;/div>";
                    menu += "&lt;div style='display:inline-block; margin-bottom:20px;'>";
                    menu += "&lt;span>Equipos a potencia Máxima(W/m2):&lt;/span>";
                    menu += "&lt;input style='transform:scale(1);margin-left:10px;'maxlength='6' size='4' type='text' id='potOpera' value='-'>";
                    menu += "&lt;/div>";
                    menu += "&lt;/div>";
                    menu += "&lt;span style='display:flex; '>Fracción Horaria de iluminación y equipos &lt;/span>";
                    menu += "&lt;div class='table-responsive' >";
                    menu += "&lt;table  id='valoresIluminacion' class='table'>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++)
                        menu += "&lt;td style='background-color: lightgray;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>" + (x + 1) + "&lt;/td>\n";
                    menu += "&lt;/tr>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++) {
                        if (usuarioA == true) {
                            menu += "&lt;td style='border:solid 1px black;font-size: 75%;white-space: nowrap;width: 100px;' contenteditable='true'>0&lt;/td>\n";
                        } else {
                            menu += "&lt;td style='border:solid 1px black;font-size: 75%;white-space: nowrap;width: 100px;' >0&lt;/td>\n";
                        }
                    }
                    menu += "&lt;/tr>";
                    menu += "&lt;/table>";
                    menu += "&lt;/div>";
                    menu += "&lt;label style='display:flex; margin-top:20px;'>ACS:&lt;/label>";
                    menu += "&lt;div style = 'display: flex; flex-wrap: wrap; justify-content: space-between; ' >"
                    menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
                    menu += "&lt;span>Demanda L/Día por persona:&lt;/span>";
                    menu += "&lt;input style='transform:scale(1);margin-left:10px;' maxlength='6' size='4' type='text' id='demOpe' value='-'>";
                    menu += "&lt;/div>";
                    menu += "&lt;div style='display:inline-block;margin-bottom:20px;'>";
                    menu += "&lt;span >Temperatura de producción ºC:&lt;/span>";
                    menu += "&lt;input style='transform:scale(1);margin-left:10px;' maxlength='6' size='4' type='text' id='temOpe' value='-'>";
                    menu += "&lt;/div>";
                    menu += "&lt;/div>";
                    menu += "&lt;span style='display:flex;'>Reparto diario de la demanda &lt;/span>";
                    menu += "&lt;div class='table-responsive' >";
                    menu += "&lt;table id='valoresACS' class='table'>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++)
                        menu += "&lt;td style='background-color: lightgray;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>" + (x + 1) + "&lt;/td>\n";
                    menu += "&lt;/tr>";
                    menu += "&lt;tr>";
                    for (var x = 0; x &lt; 24; x++) {
                        if (usuarioA == true) {
                            menu += "&lt;td style='border:solid 1px black;font-size: 75%;white-space: nowrap;width: 100px;' contenteditable='true'>0&lt;/td>\n";
                        } else {
                            menu += "&lt;td style='border:solid 1px black;font-size: 75%;white-space: nowrap;width: 100px;' >0&lt;/td>\n";
                        }
                    }
                    menu += "&lt;/tr>";
                    menu += "&lt;/table>";
                    menu += "&lt;/div>";
                   
                    menu += "&lt;button class='btnMenu' style='margin-right:10px;background-color:orange' onclick='guardarOperaciones()'>Aceptar&lt;/button>";
                    menu += "&lt;button class='btnMenu' style='margin-right:10px;' onclick='updateCalendario(1)'>Calendario&lt;/button>";
                    menu += "&lt;button class='btnMenu' style='margin-right:10px;' onclick='updateVariacionEstacional()'>Variación Estacional del Uso&lt;/button>";
                    document.getElementById("esquema").innerHTML = "";
                    document.getElementById("contenido").innerHTML = menu;
                    if (usuarioA == false)
                        nombreDiaTipo.disabled = true;
                    OcultarSpinner();
                    document.getElementById("menu").innerHTML = "";
                    document.getElementById("lineas").innerHTML = "";
                    //Creamos las restricciones para introducir valores en las celdas
                    var oTabla = document.querySelector("#horarioCalefaccion");
                    var oCeldas = oTabla.getElementsByTagName("td");
                    for (var i = 0; i &lt; oCeldas.length; i++) {
                        oCeldas[i].addEventListener("keydown", writingCap1);
                    }
                    oTabla = document.querySelector("#ocupacionPersonaTabla");
                    oCeldas = oTabla.getElementsByTagName("td");
                    for (var i = 0; i &lt; oCeldas.length; i++) {
                        oCeldas[i].addEventListener("keydown", writingCapEnter);
                    }
                    oTabla = document.querySelector("#horarioRefrigeracion");
                    oCeldas = oTabla.getElementsByTagName("td");
                    for (var i = 0; i &lt; oCeldas.length; i++) {
                        oCeldas[i].addEventListener("keydown", writingCap1);
                    }
                    oTabla = document.querySelector("#valoresIluminacion");
                    oCeldas = oTabla.getElementsByTagName("td");
                    for (var i = 0; i &lt; oCeldas.length; i++) {
                        oCeldas[i].addEventListener("keydown", writingCapEnter2);
                    }
                    oTabla = document.querySelector("#valoresACS");
                    oCeldas = oTabla.getElementsByTagName("td");
                    for (var i = 0; i &lt; oCeldas.length; i++) {
                        oCeldas[i].addEventListener("keydown", writingCapEnter);
                    }
                    // oTabla = document.querySelector("#valoresOtros");
                    // oCeldas = oTabla.getElementsByTagName("td");
                    // for (var i = 0; i &lt; oCeldas.length; i++) {
                    //     oCeldas[i].addEventListener("keydown", writingCapEnter);
                    // }
                    if ($scope.ufCaso.length > 1 &amp;&amp; $scope.ufCaso.length != 0) {
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso) {
                                document.getElementById('operacionesUF').value = $scope.ufCaso[x].nombre;
                                cargarDiasTipoOperacional($scope.ufCaso[x].id);
                                break;
                            }
                        }
                    }
                    else
                        cargarDiasTipoOperacional($scope.ufCaso[0].id);
                    HUtil.CambiarColor_Children_Select();
                }
                else {
                    alert('No se han cargado los valores horarios, por favor vuelva a aceptar datos generales, si el problema persiste, vuevla a definir la unidad funcional')
                    OcultarSpinner();
                    return updateComunidad(1);
                }
            }
            else {
                alert("No se ha definido correctamente la unidad funcional");
                OcultarSpinner();
            }
        }
        /**

        * Cargamos los dias tipo en función de la unidad funcional del caso

        * @param  {string}
        * @return  {void}

         */
        cargarDiasTipoOperacional = function (idUFcaso) {
            var nombre = "";
            //Cargamos el nombre de la unidad funcional
            for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                if ($scope.ufCaso[x].id == idUFcaso) {
                    nombre = $scope.ufCaso[x].nombre;
                }
            }
            var menu = "";
            document.getElementById('operacionesUF').value = nombre;
            for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                if ($scope.diastipocaso[x].id_caso == idCaso &amp;&amp; idUFcaso == $scope.diastipocaso[x].id_uf) {
                    menu += "&lt;a href='#'>&lt;option class='hover' value='" + x + "' id='dias" + $scope.diastipocaso[x].nombre + "' onclick='updateDatosOperacionales(" + $scope.diastipocaso[x].id_diatipo + ")'>" + $scope.diastipocaso[x].nombre + "&lt;/option>&lt;/a>";
                }
            }
            //Cargamos los días tipo caso
            document.getElementById('diasUF').innerHTML = menu;
            for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                if ($scope.diastipocaso[x].id_caso == idCaso &amp;&amp; idUFcaso == $scope.diastipocaso[x].id_uf) {
                    updateDatosOperacionales($scope.diastipocaso[x].id_diatipo);
                    break;
                }
            }
        }
        /**

        * Creamos el nuevo tipo de día

        * @return  {void}

         */
        crearDiaTipo = function () {
            var id = "";
            var myTable1 = document.getElementById('horarioCalefaccion');
            var myTable2 = document.getElementById('horarioRefrigeracion');
            var myTable3 = document.getElementById('ocupacionPersonaTabla');
            var myTable4 = document.getElementById('valoresIluminacion');
            var myTable5 = document.getElementById('valoresACS');
            var ordenM = 0;
            var repe = false;
            var id = "";
            var nombre = "";
            //Comprobamos que el nombre no sea repetido
            for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                if ($scope.diastipocaso[x].nombre == document.getElementById('nombreDiaTipo').value) {
                    repe = true;
                }
                if (parseInt($scope.diastipocaso[x].numeroorden) > ordenM) {
                    ordenM = parseInt($scope.diastipocaso[x].numeroorden);
                }
            }
            //introducimos el nombre si no está repetido
            nombre = document.getElementById('nombreDiaTipo').value;
            if (document.getElementById('nombreDiaTipo').value.length > 0 &amp;&amp; /^[A-Za-z0-9]/.test(document.getElementById('nombreDiaTipo').value) == true) {
                if (repe == false) {
                    //insertamos el día tipo
                    $http.post("insertarDiasTipo.php", {
                        'id_caso': idCaso, 'id_uf': $scope.ufCaso[0].id, 'numeroorden': (ordenM + 1),
                        'nombre': nombre, 'valocup': 0, 'valilum': 0, 'valequip': 0, 'valacs': 0, 'trarepacs': 0, 'valacspiscina': 0,'base':1
                    }).success(function (data) {
                        console.log(data);
                        $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                            $scope.diastipocaso = data;
                            ADdiastipocaso = data;
                            //Introducimos el nuevo caso en la lista y le asignamos valores por defecto
                            for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                                if ($scope.diastipocaso[x].nombre == nombre &amp;&amp; $scope.diastipocaso[x].id_caso == idCaso) {
                                    id = $scope.diastipocaso[x].id_diatipo;
                                    var opt2 = document.createElement('a');
                                    opt2.href = "#"
                                    opt2.innerHTML = "&lt;option class='hover' value='" + x + "' id='dias" + $scope.diastipocaso[x].nombre + "' onclick='updateDatosOperacionales(" + $scope.diastipocaso[x].id_diatipo + ")'>" + $scope.diastipocaso[x].nombre + "&lt;/option>";
                                    document.getElementsByClassName('dropdown-menu')[0].appendChild(opt2);
                                    document.getElementById("ocupacionPersona").value = 0;
                                    document.getElementById("iluOpera").value = 0;
                                    document.getElementById("potOpera").value = 0;
                                    document.getElementById("demOpe").value = 0;
                                    document.getElementById("temOpe").value = 60;
                                    for (var y = 0; y &lt; 24; y++) {
                                        myTable1.rows[1].cells[y].innerHTML = 0;
                                        myTable2.rows[1].cells[y].innerHTML = 0;
                                        myTable3.rows[1].cells[y].innerHTML = 0;
                                        myTable4.rows[1].cells[y].innerHTML = 0;
                                        myTable5.rows[1].cells[y].innerHTML = 0;
                                    }
                                }
                            }
                            HUtil.CambiarColor_Children_Select();
                            for (var z = 1; z &lt; 25; z++) {
                                $http.post("insertarValores.php", {
                                    'id_diatipo': id, 'numerohora': z, 'vh_cal': 0,
                                    'vh_ref': 0, 'vh_ocup': 0, 'vh_ilumequip': 0,
                                    'vh_acs': 0, 'vh_otros': 0, 'idcaso': idCaso,'base':1
                                }).success(function (data) {
                                    console.log(data);
                                });
                            }
                        });
                    });
                } else {
                    alert("ERROR: El nombre del dia está repetido");
                }
            } else {
                alert("ERROR: El nombre del dia no puede estar vacío");
            }
        }
        /**

        * Borramos un tipo de día

        * @return  {void}

         */
        eliminarDiaTipo = function () {
            var numorden = "";
            var myTable1 = document.getElementById('horarioCalefaccion');
            var myTable2 = document.getElementById('horarioRefrigeracion');
            var myTable3 = document.getElementById('ocupacionPersonaTabla');
            var myTable4 = document.getElementById('valoresIluminacion');
            var myTable5 = document.getElementById('valoresACS');
            var select = document.getElementById("nombreDiaTipo").value;
            var id = "";
            //Sacamos los identificadores de los días tipos
            for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                if ($scope.diastipocaso[x].nombre == select) {
                    id = $scope.diastipocaso[x].id_diatipo;
                    numorden = $scope.diastipocaso[x].numeroorden;
                    break;
                }
            }
            if (id != "") {
                for (var i = 0; i &lt; $scope.diastipocaso.length; i++) {
                    if (id == $scope.diastipocaso[i].id_diatipo) {
                        var element = document.getElementById("dias" + $scope.diastipocaso[i].nombre);
                        element.parentNode.removeChild(element);
                    }
                }
                //Borramos el día tipo, sus valores horarios
                $http.post("borrarDiasTipo.php", {
                    'id_caso': idCaso, 'numeroorden': numorden,'base':1
                }).success(function (data) {
                    console.log(data);
                    //Asignamos valores por defecto
                    document.getElementById("ocupacionPersona").value = 0;
                    document.getElementById("iluOpera").value = 0;
                    document.getElementById("potOpera").value = 0;
                    document.getElementById("demOpe").value = 0;
                    document.getElementById("temOpe").value = 60;
                    for (var x = 0; x &lt; 24; x++) {
                        myTable1.rows[1].cells[x].innerHTML = 0;
                        myTable2.rows[1].cells[x].innerHTML = 0;
                        myTable3.rows[1].cells[x].innerHTML = 0;
                        myTable4.rows[1].cells[x].innerHTML = 0;
                        myTable5.rows[1].cells[x].innerHTML = 0;
                        //   myTable6.rows[0].cells[x].innerHTML = 0;
                    }
                    //Cargamos las tablas actualizadas
                    $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                        $scope.diastipocaso = data;
                        ADdiastipocaso = data;
                        $http.post("borrarValores.php", {
                            'id_diatipo': id,'base':1
                        }).success(function (data) {
                            console.log(data);
                            $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                $scope.valoreshorarioscaso = data;
                                ADvaloreshorarioscaso = data;
                            });
                        });
                    });
                });
            } else {
                alert("Escoja el día tipo que desee borrar");
            }
            document.getElementById("nombreDiaTipo").value = "";
        }
        /**

        * Cargamos los datos correspondientes en los elementos

        * @param  {string}
        * @return  {void}

         */
        updateDatosOperacionales = function (id) {
            var nombre = "";
            var valido = 0;
            var myTable1 = document.getElementById('horarioCalefaccion');
            var myTable2 = document.getElementById('horarioRefrigeracion');
            var myTable3 = document.getElementById('ocupacionPersonaTabla');
            var myTable4 = document.getElementById('valoresIluminacion');
            var myTable5 = document.getElementById('valoresACS');
            //Localizamos los valores del día tipo en la base de datos
            for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                if ($scope.diastipocaso[x].id_diatipo == id) {
                    valido = x;
                    nombre = $scope.diastipocaso[x].nombre;
                    ordenDias = $scope.diastipocaso[x].numeroorden;
                }
            }
            //Primeramente ponemos los valores a 0
            document.getElementById("ocupacionPersona").value = 0;
            document.getElementById("iluOpera").value = 0;
            document.getElementById("potOpera").value = 0;
            document.getElementById("demOpe").value = 0;
            document.getElementById("temOpe").value = 60;
            for (var x = 0; x &lt; 24; x++) {
                myTable1.rows[1].cells[x].innerHTML = 0;
                myTable2.rows[1].cells[x].innerHTML = 0;
                myTable3.rows[1].cells[x].innerHTML = 0;
                myTable4.rows[1].cells[x].innerHTML = 0;
                myTable5.rows[1].cells[x].innerHTML = 0;
            }
            //Cargamos los valores del día tipo localizado
            document.getElementById('nombreDiaTipo').value = nombre;
            valido2 = document.getElementById('operacionesUF').innerHTML;
            document.getElementById("ocupacionPersona").value = $scope.diastipocaso[valido].valocup;
            document.getElementById("iluOpera").value = $scope.diastipocaso[valido].valilum;
            document.getElementById("potOpera").value = $scope.diastipocaso[valido].valequip;
            document.getElementById("demOpe").value = $scope.diastipocaso[valido].valacs;
            document.getElementById("temOpe").value = $scope.diastipocaso[valido].trarepacs;
            for (var h = 1; h &lt; 26; h++) {
                for (var y = 0; y &lt; $scope.valoreshorarioscaso.length; y++) {
                    if (parseInt($scope.valoreshorarioscaso[y].numerohora) == h &amp;&amp; $scope.valoreshorarioscaso[y].id_diatipo == id) {
                        myTable1.rows[1].cells[h - 1].innerHTML = $scope.valoreshorarioscaso[y].vh_cal;
                        myTable2.rows[1].cells[h - 1].innerHTML = $scope.valoreshorarioscaso[y].vh_ref;
                        myTable3.rows[1].cells[h - 1].innerHTML = $scope.valoreshorarioscaso[y].vh_ocup;
                        myTable4.rows[1].cells[h - 1].innerHTML = $scope.valoreshorarioscaso[y].vh_ilumequip;
                        myTable5.rows[1].cells[h - 1].innerHTML = $scope.valoreshorarioscaso[y].vh_acs;
                    }
                }
            }
        }
        /**

        * Guardamos los datos operacionales

        * @return  {void}

         */
        guardarOperaciones = function () {
            MostrarSpinner();
            var numOrdenDia = "";
            var usuarioA = false;
            var idDiaTipo = "";
            //Comprobamos si el usuario es avanzado
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            //Localizamos distintos valores del caso
            if ($scope.ufCaso.length > 0) {
                valido = document.getElementById('nombreDiaTipo').value;
                if ($scope.ufCaso.length > 1 &amp;&amp; $scope.ufCaso.length != 0) {
                    var edificio = document.getElementById('operacionesUF').value;
                    for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                        if ($scope.ufCaso[x].nombre == edificio) {
                            edificio = $scope.ufCaso[x].id;
                        }
                    }
                } else {
                    var edificio = document.getElementById('operacionesUF').innerHTML;
                    for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                        if ($scope.ufCaso[x].iduf == edificio) {
                            edificio = $scope.ufCaso[x].id;
                        }
                    }
                }

                var todoCorrecto = true;
                if (valido != "") {
                    for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                        if ($scope.diastipocaso[x].numeroorden == ordenDias &amp;&amp; $scope.diastipocaso[x].id_uf == edificio) {
                            numOrdenDia = $scope.diastipocaso[x].numeroorden;
                            idDiaTipo = $scope.diastipocaso[x].id_diatipo;
                        }
                    }
                    //Comprobamos que no haya valores incorrectos en las distintas casillas
                    for (var y = 0; y &lt; document.getElementById('horarioCalefaccion').rows[1].cells.length; y++) {
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('horarioCalefaccion').rows[1].cells[y].innerHTML) == false) {
                            alert('ERROR: El valor de la celda ' + y + ' de calefacción con valores no numéricos');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                        if (document.getElementById('horarioCalefaccion').rows[1].cells[y].innerHTML != "0" &amp;&amp; document.getElementById('horarioCalefaccion').rows[1].cells[y].innerHTML != "1") {
                            alert('ERROR: El valor de la celda ' + y + ' de calefacción debe ser 0 o 1');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                    }
                    for (var y = 0; y &lt; document.getElementById('horarioRefrigeracion').rows[1].cells.length; y++) {
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('horarioRefrigeracion').rows[1].cells[y].innerHTML) == false) {
                            alert('ERROR: El valor de la celda ' + y + ' de refrigeración con valores no numéricos');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                        if (document.getElementById('horarioRefrigeracion').rows[1].cells[y].innerHTML != "0" &amp;&amp; document.getElementById('horarioRefrigeracion').rows[1].cells[y].innerHTML != "1") {
                            alert('ERROR: El valor de la celda ' + y + ' de refrigeración debe ser 0 o 1');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                    }
                    for (var y = 0; y &lt; document.getElementById('ocupacionPersonaTabla').rows[0].cells.length; y++) {
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('ocupacionPersonaTabla').rows[0].cells[y].innerHTML) == false) {
                            alert('ERROR: El valor de la celda ' + y + ' de ocupación con valores no numéricos');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                    }
                    for (var y = 0; y &lt; document.getElementById('valoresIluminacion').rows[0].cells.length; y++) {
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('valoresIluminacion').rows[0].cells[y].innerHTML) == false) {
                            alert('ERROR: El valor de la celda ' + y + ' de iluminación con valores no numéricos');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                    }
                    for (var y = 0; y &lt; document.getElementById('valoresACS').rows[0].cells.length; y++) {
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('valoresACS').rows[0].cells[y].innerHTML) == false) {
                            alert('ERROR: El valor de la celda ' + y + ' de ACS con valores no numéricos');
                            todoCorrecto = false;
                            OcultarSpinner();
                        }
                    }
                    if (todoCorrecto == true) {
                        //Actualizamos los valores para el día tipo correspondiente.
                        $http.post("updateDiasTipo.php", {
                            'id_caso': idCaso, 'id_uf': edificio, 'numeroorden': numOrdenDia,
                            'nombre': valido, 'valocup': document.getElementById("ocupacionPersona").value,
                            'valilum': document.getElementById("iluOpera").value, 'valequip': document.getElementById("potOpera").value,
                            'valacs': document.getElementById("demOpe").value, 'valacspiscina': 0, 'trarepacs': document.getElementById("temOpe").value,'base':1
                        }).success(function (data) {
                            console.log(data);
                            $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                                $scope.diastipocaso = data;
                                ADdiastipocaso = data;
                            });
                        });
                        //Borramos los valores horarios e introducimos los nuevos.
                        $http.post("borrarValores.php", {
                            'id_diatipo': idDiaTipo,'base':1
                        }).success(function (data) {
                            console.log(data);
                            $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                $scope.valoreshorarioscaso = data;
                                ADvaloreshorarioscaso = data;
                                for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                                    if ($scope.diastipocaso[x].nombre == valido &amp;&amp; $scope.diastipocaso[x].id_uf == edificio) {
                                        numOrdenDia = $scope.diastipocaso[x].numeroorden;
                                        idDiaTipo = $scope.diastipocaso[x].id_diatipo;
                                    }
                                }
                                $timeout(function () { insertarValoresHorarios(idDiaTipo) }, 500);
                            });
                        });
                    }
                } else {
                    alert("ERROR:No hay día tipo seleccionado");
                    OcultarSpinner();
                }
            } else {
                alert("ERROR: No hay unidad funcional asignada");
                OcultarSpinner();
            }
        }
        /**

        * Insertamos los valores horarioscargarConsumo

        * @param  {number}
        * @return  {void}

         */
        insertarValoresHorarios = function (id_dia) {
            //Insertamos los valores horarios en las tablas
            for (var x = 1; x &lt; 25; x++) {
                $http.post("insertarValores.php", {
                    'id_diatipo': id_dia, 'numerohora': x, 'vh_cal': document.getElementById('horarioCalefaccion').rows[1].cells[x - 1].innerHTML,
                    'vh_ref': document.getElementById('horarioRefrigeracion').rows[1].cells[x - 1].innerHTML,
                    'vh_ocup': document.getElementById('ocupacionPersonaTabla').rows[1].cells[x - 1].innerHTML,
                    'vh_ilumequip': document.getElementById('valoresIluminacion').rows[1].cells[x - 1].innerHTML,
                    'vh_acs': document.getElementById('valoresACS').rows[1].cells[x - 1].innerHTML, 
                    'vh_otros': "0", 'idcaso': idCaso,'base':1
                }).success(function (data) {
                    console.log(data);
                });
            }
            //Cargamos las tablas actualizadas
            $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.valoreshorarioscaso = data;
                ADvaloreshorarioscaso = data;
                alert("Datos guardados correctamente");
                OcultarSpinner();
                vaciarcontenido();
            });
        }
        
         /**

        * Cargamos los datos correspondientes a las piscinas

        * @return  {void}

         */
        updatePiscinas = function ()
        {
            Hpiscina.updatePiscinas();

        }
         /**

        * Añadimos una nueva unidad funcional

        * @param  {string}
        * @return  {void}

         */
        aniadirUnidad = function (numero, edificio) {
            var valido2 = datosCasos[19];
            var select;
            var table;
            var diastipoG = false;
            //Cargamos una nueva unidad en la tabla de unidades funcionales
            if (numero == 1) {
                select = document.getElementById("tipoEdificio");
                valido = select.options[select.selectedIndex].value;
                table = document.getElementById("tablaFuncional2");
            } else if (numero == 2) {
                valido = edificio;
                for (var x = 0; x &lt; $scope.edificio.length; x++) {
                    if ($scope.edificio[x].nombre == select) {
                        valido = $scope.edificio[x].id;
                    }
                }
                table = document.getElementById("TablaUFGenericas");
            }
            // Creamos una nueva fila dentro de la tabla
            var row = table.insertRow(table.rows.length);
            row.setAttribute("id", "uniFun" + numFun, 0);
            row.style = "text-align:center;";
            // Insertamos las nuevas celdas
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);
            var cell7 = row.insertCell(6);
            var cell8 = row.insertCell(7);
            var cell9 = row.insertCell(8);
            var cell10 = row.insertCell(9);
            cell1.innerHTML = "0";
            cell1.contentEditable = true;
            // Añadimos el contenido de las celdas
            cell2.innerHTML = " &lt;select style='text-align:center;text-align-last:center'  id='selFun" + numFun + "' onchange='cargarValoresFun(" + numero + "," + numFun + ")'>&lt;/select >";
            var select = document.getElementById('selFun' + numFun);
            var opt = document.createElement('option');
            opt.value = "0";
            opt.innerHTML = " - Selecciona -";
            opt.selected = true;
            opt.hidden = true;
            select.appendChild(opt);
            //Dependiendo de si estamos en la parte de datos generales o en el apartado de genérica cogeremos unas tablas u otras
            if (valorIntervencion == "1" &amp;&amp; numero == 1) {
                for (var x = 0; x &lt; $scope.genericas.length; x++) {
                    for (var y = 0; y &lt; $scope.diastipocaso.length; y++) {
                        if ($scope.diastipocaso[y].id_uf == $scope.genericas[x].id_ufg &amp;&amp; $scope.diastipocaso[y].id_caso == idCaso &amp;&amp; $scope.genericas[x].id_edificio == valido) {
                            diastipoG = true;
                            break;
                        }
                    }
                    /*Comprobamos si estamos en el apartado de genéricas o de datos generales para asignar
                    las unidades funcionales al selector*/
                    if ($scope.genericas[x].id_edificio == valido &amp;&amp; $scope.genericas[x].idusuario == usuario &amp;&amp; diastipoG == true) {
                        //Introducimos en el selector las unidades funcionales genéricas asignadas
                        var opt = document.createElement('option');
                        opt.value = $scope.genericas[x].id_ufg;
                        opt.innerHTML = $scope.genericas[x].nombre;
                        select.appendChild(opt);
                        diastipoG = false;
                        for (var i = 0; i &lt; select.options.length; i++)
                            if (selectufindex == select.options[i].textContent)
                                select.selectedIndex = i;
                        if (selectufindex == undefined)
                            select.selectedIndex = select.options[select.options.length - 1].index;
                    }
                     //Introducimos en el selector las unidades funcionales del edificio asignado
                    if (valido2 == "2") {
                        for (var x = 0; x &lt; $scope.funcionales.length; x++) {
                            if ($scope.funcionales[x].id_edificio == valido) {
                                var opt = document.createElement('option');
                                opt.value = $scope.funcionales[x].id_uf;
                                opt.innerHTML = $scope.funcionales[x].nombre;
                                select.appendChild(opt);
                            }
                        }
                    }
                }
                //Introducimos en el selector las unidades funcionales del edificio asignado,
            } else {
                for (var x = 0; x &lt; $scope.funcionales.length; x++) {
                    if ($scope.funcionales[x].id_edificio == valido) {
                        var opt = document.createElement('option');
                        opt.value = $scope.funcionales[x].id_uf;
                        opt.innerHTML = $scope.funcionales[x].nombre;
                        select.appendChild(opt);
                    }
                }
            }
           
            cell3.contentEditable = true;
            //Cargamos las celdas en función de la sección en la que estamos.
            if (valorIntervencion == "1" &amp;&amp; numero == 1) {
                cell3.innerHTML = document.getElementById("superficie").value;
            }
            else
                cell3.innerHTML = "0";
            cell4.innerHTML = "&lt;input type='checkbox' style='transform: scale(1);' id='calFun" + numFun + "' value='calefaccion'/>\n";
            cell5.innerHTML = "&lt;input type='checkbox' style='transform: scale(1);' id='refFun" + numFun + "' value='calefaccion'/>\n";
            cell6.innerHTML = "&lt;input type='checkbox' style='transform: scale(1);' id='acsFun" + numFun + "' value='calefaccion'/>\n";
            cell7.innerHTML = "&lt;input type='checkbox' style='transform: scale(1);' id='pisFun" + numFun + "' value='calefaccion'/>\n";
            cell8.innerHTML = "&lt;input type='checkbox' style='transform: scale(1);' id='iluFun" + numFun + "' value='calefaccion'/>\n";
            cell9.innerHTML = "&lt;input type='checkbox' style='transform: scale(1);' id='otrFun" + numFun + "' value='calefaccion'/>\n";
            cell10.innerHTML = "&lt;button class='btnMenu' style='background-color:orangered' onclick='borrarUnidad(" + numero + "," + numFun + ")'> Borrar&lt;/button>";
            cell1.style = "border-top:none;"
            cell2.style = "border-top:none;"
            cell3.style = "border-top:none;"
            cell4.style = "border-top:none;"
            cell5.style = "border-top:none;"
            cell6.style = "border-top:none;"
            cell7.style = "border-top:none;"
            cell8.style = "border-top:none;"
            cell9.style = "border-top:none;"
            cell10.style = "border-top:none;"
            if (numero == 1)
                select.onchange();
            numFun++;
            if (valorIntervencion == "1" &amp;&amp; numero == 1 &amp;&amp; table.rows.length > 1) {
                document.getElementById('nuevaFuncional').disabled = true;
            }
            oTabla = table;
            oCeldas = oTabla.getElementsByTagName("td");
            //Aplicamos las restricciones a la hora de introducir valores en las celdas
            for (var i = 0; i &lt; oCeldas.length; i++) {
                oCeldas[0].addEventListener("keydown", writingCapEnter);
                oCeldas[2].addEventListener("keydown", writingCap2);
            }
        }
        /**

        * Añadimos los valores por defecto de las unidades funcionales

        * @return  {void}

         */
        cargarUnidades = function () {
            var menu = "";
            //Una vez localizada en la base de datos se cargan los valores
            for (var x = 0; x &lt; $scope.funcionales.length; x++) {
                if ($scope.funcionales[x].id_edificio == valido) {
                    menu += "&lt;button class='btnMenu' style='background-color:orange' onclick='cargarValoresFun(" + numero + "," + numFun + "," + $scope.genericas[x].nombre + ")' data-dismiss='modal' value='" + $scope.genericas[x].nombre + "'>" + $scope.funcionales[x].nombre + "&lt;/button>&lt;/div>\n";
                }
            }
            document.getElementsById('bodyufg').innerHTML = menu;
        }
        /**

        * Cargamoslas unidades funcionales

        * @param  {string}
        * @return  {void}

         */
        cargarValoresFun = function (numero, filaTabla) {
            var usuarioA = false;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            var casoCargado = false;
            var select = document.getElementById('selFun' + filaTabla);
            
            valido = select.options[select.selectedIndex].value;
            valido2 = select.options[select.selectedIndex].innerHTML;
            //Primeramente se ponen los valores a 0
            document.getElementById("calFun" + filaTabla).checked = false;
            document.getElementById("refFun" + filaTabla).checked = false;
            document.getElementById("acsFun" + filaTabla).checked = false;
            document.getElementById("pisFun" + filaTabla).checked = false;
            document.getElementById("iluFun" + filaTabla).checked = false;
            document.getElementById("otrFun" + filaTabla).checked = false;
            for (var x = 0; x &lt; $scope.genericas.length; x++) {
                if ($scope.genericas[x].nombre == valido2) {
                    valido = x;
                    valorIntervencion = "1";
                }
            }
            for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                if ($scope.ufCaso[x].nombre == valido2) {
                    valido = x;
                    casoCargado = true;
                }
            }
            /*Una vez localizada en la base de datos se cargan los valores correspondientes
            dependiendo de la sección y si había datos guardados*/
            if (valorIntervencion == "1" &amp;&amp; numero == 1) {
                if (casoCargado == false) {
                    //Correspondiente a las genéricas
                    if ($scope.genericas[valido].calefaccion == "1") {
                        document.getElementById("calFun" + filaTabla).checked = true;
                    }
                    if ($scope.genericas[valido].refrigeracion == "1") {
                        document.getElementById("refFun" + filaTabla).checked = true;
                    }
                    if ($scope.genericas[valido].acs == "1") {
                        document.getElementById("acsFun" + filaTabla).checked = true;
                    }
                    if ($scope.genericas[valido].piscina == "1") {
                        document.getElementById("pisFun" + filaTabla).checked = true;
                    }
                    if ($scope.genericas[valido].iluminacion == "1") {
                        document.getElementById("iluFun" + filaTabla).checked = true;
                    }
                    if ($scope.genericas[valido].otros == "1") {
                        document.getElementById("otrFun" + filaTabla).checked = true;
                    }
                    document.getElementById("tablaFuncional2").rows[1].cells[0].innerHTML = "0";
                    document.getElementById("tablaFuncional2").rows[1].cells[2].innerHTML = document.getElementById("superficie").value;
                } else {
                    //Correspondiente a la base de datos
                    if ($scope.ufCaso[valido].calefaccion == "1") {
                        document.getElementById("calFun" + filaTabla).checked = true;
                    }
                    if ($scope.ufCaso[valido].refrigeracion == "1") {
                        document.getElementById("refFun" + filaTabla).checked = true;
                    }
                    if ($scope.ufCaso[valido].acs == "1") {
                        document.getElementById("acsFun" + filaTabla).checked = true;
                    }
                    if ($scope.ufCaso[valido].piscina == "1") {
                        document.getElementById("pisFun" + filaTabla).checked = true;
                    }
                    if ($scope.ufCaso[valido].iluminacion == "1") {
                        document.getElementById("iluFun" + filaTabla).checked = true;
                    }
                    if ($scope.ufCaso[valido].otros == "1") {
                        document.getElementById("otrFun" + filaTabla).checked = true;
                    }
                    document.getElementById("tablaFuncional2").rows[1].cells[0].innerHTML = $scope.ufCaso[valido].nombreusuario;
                    document.getElementById("tablaFuncional2").rows[1].cells[2].innerHTML = $scope.ufCaso[valido].superficie;
                }
            } else {
                if (usuarioA == false) {
                    //Correspondiente a las unidades funcionales
                    if ($scope.funcionales[valido].calefaccion == "1") {
                        document.getElementById("calFun" + filaTabla).checked = true;
                    }
                    if ($scope.funcionales[valido].refrigeracion == "1") {
                        document.getElementById("refFun" + filaTabla).checked = true;
                    }
                    if ($scope.funcionales[valido].acs == "1") {
                        document.getElementById("acsFun" + filaTabla).checked = true;
                    }
                    if ($scope.funcionales[valido].piscina == "1") {
                        document.getElementById("pisFun" + filaTabla).checked = true;
                    }
                    if ($scope.funcionales[valido].iluminacion == "1") {
                        document.getElementById("iluFun" + filaTabla).checked = true;
                    }
                    if ($scope.funcionales[valido].otros == "1") {
                        document.getElementById("otrFun" + filaTabla).checked = true;
                    }
                } else {
                   
                        if ($scope.funcionales[valido].calefaccion == "1") {
                            document.getElementById("calFun" + filaTabla).checked = true;
                        }
                        if ($scope.funcionales[valido].refrigeracion == "1") {
                            document.getElementById("refFun" + filaTabla).checked = true;
                        }
                        if ($scope.funcionales[valido].acs == "1") {
                            document.getElementById("acsFun" + filaTabla).checked = true;
                        }
                        if ($scope.funcionales[valido].piscina == "1") {
                            document.getElementById("pisFun" + filaTabla).checked = true;
                        }
                        if ($scope.funcionales[valido].iluminacion == "1") {
                            document.getElementById("iluFun" + filaTabla).checked = true;
                        }
                        if ($scope.funcionales[valido].otros == "1") {
                            document.getElementById("otrFun" + filaTabla).checked = true;
                        }
                    }
                }
            }
        
        /**

        * Borramos la unidad funcional seleccionada

        * @param  {string}
        * @return  {void}

         */
        borrarUnidad = function (numero, filaTabla) {
            //Sacamos el índice de la fila de la tabla de las unidades funcionales y la eliminamos
            var index = document.getElementById("uniFun" + filaTabla).rowIndex;
            if (numero == 1) {
                document.getElementById("tablaFuncional2").deleteRow(index);
            } else if (numero == 2) {
                document.getElementById("TablaUFGenericas").deleteRow(index);
            }
            if (valorIntervencion == "1" &amp;&amp; numero == 1) {
                //En caso de haber ya una unidad funcional no se puede añadir otra
                if (document.getElementById("tablaFuncional2").rows.length &lt; 2) {
                    document.getElementById('nuevaFuncional').disabled = false;
                }
            }
        }
        /**

        * Cargamos la sección de vehículo eléctrico

        * @return  {void}

         */
        updateVehiculo = function ()
        {
            Hvehiculo.updateVehiculo()
        }
        /**

        * Cargamos la sección de variación estacional

        * @return  {void}

         */
        updateVariacionEstacional = function()
        {
            Hvariacionestacional.updateVariacionEstacional();
        }
        /**

        * Cargamos la sección calendario

        * @param  {number}
        * @return  {void}

         */
        updateCalendario = async function (origen) {
            //Si venimos de la sección de vehículo eléctrico lo guardamos primeramente
            if (origen == 2) {
                await guardarVehiculo();
                if (exito == false)
                    return;
            }
            var idCalendario = "";
            var iduf = "";
            var nombreuf = "";
            MostrarSpinner();
            //Cargamos los calendarios
            $http.post('calendarios.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.calendario = data;
                ADcalendario = data;
                //Sacamos de la base de datos los valores del calendario correspondiente
                if (origen == 1) {
                    //Si hay mas de una unidad funcional sacamos la que corresponde
                    if ($scope.ufCaso.length > 1 &amp;&amp; $scope.ufCaso.length != 0) {
                        nombreuf = document.getElementById('operacionesUF').value;
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso &amp;&amp; $scope.ufCaso[x].nombre == nombreuf) {
                                iduf = $scope.ufCaso[x].id;
                            }
                        }
                    } else {
                        nombreuf = document.getElementById('operacionesUF').innerHTML;
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso &amp;&amp; $scope.ufCaso[x].iduf == nombreuf) {
                                iduf = $scope.ufCaso[x].id;
                            }
                        }
                    }
                }
                else
                    iduf = 0;
                for (var x = 0; x &lt; $scope.calendario.length; x++) {
                    if ($scope.calendario[x].iduf == iduf) {
                        idCalendario = $scope.calendario[x].id;
                    }
                }
                var menu = "";
                var numDiasAnio = 365;
                var d = new Date();
                var anio = d.getFullYear();
                d = new Date(anio, 0, 1);
                var diaSemana = d.getUTCDay();
                var contSemana = 0;
                var semana = 1;
                var cont = 0;
                //cargamos la sección de calendario dibujando el calendario con su correcta distribución de los días en función del año
                var arrayColores = new Array("rosybrown", "yellow", "orange", "orangered", "lightblue", "lightpink", "cornflowerblue", "grey", "yellowgreen", "aqua", "aquamarine", "brown", "burlywood",
                    '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6',
                    '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                    '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A',
                    '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
                    '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC',
                    '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
                    '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680',
                    '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
                    '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3',
                    '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF');
                menu += "&lt;div style= 'padding-bottom: 10px; display: flex;flex-direction: column;border: solid 0.5px gray;margin-bottom: 20px;'>";
                menu += "&lt;label style='border-bottom: solid 0.5px lightslategray;display:flex;justify-content:center;margin-top:5px;'>Leyenda de colores días tipo&lt;/label>";
                if (origen == 1) {
                    for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                        if ($scope.diastipocaso[x].id_caso == idCaso &amp;&amp; iduf == $scope.diastipocaso[x].id_uf) {
                            menu += "&lt;div style ='margin-left: 10px;margin-top: 5px;'>&lt;button style='width: 30px;height: 15px;margin-right: 5px;background-color:" + arrayColores[cont] + ";' disabled>&lt;/button>&lt;span style='vertical-align: middle;'>" + $scope.diastipocaso[x].nombre + "&lt;/span> &lt;/div>";
                            cont++;
                        }
                    }
                }
                else {
                    for (var x = 0; x &lt; diastipoVE.length; x++) {
                        menu += "&lt;div style ='margin-left: 10px;margin-top: 5px;'>&lt;button style='width: 30px;height: 15px;margin-right: 5px;background-color:" + arrayColores[cont] + ";' disabled>&lt;/button>&lt;span style='vertical-align: middle;'>" + diastipoVE[x].nombre + "&lt;/span> &lt;/div>";
                        cont++;
                    }
                }
                menu += "&lt;/div>"
                if (origen == 2)
                    menu += "&lt;h4 style='text-align: center;'>Calendario vehículo eléctrico&lt;/h4>"
                menu += "&lt;div class='table-responsive'>"
                menu += "&lt;table id='calendario' class='table'>";
                menu += "&lt;tr>";
                menu += "&lt;th class='calendario' style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,1,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Lunes&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,2,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Martes&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,3,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Miércoles&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,4,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Jueves&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,5,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Viernes&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,6,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Sábado&lt;/a>&lt;/th>";
                menu += "&lt;th class='calendario' onclick='elegirDia(0,7,1," + iduf + "," + origen + ")'  style='padding: 0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' style='padding:20px;color: white;'>Domingo&lt;/a>&lt;/th>";
                menu += "&lt;/tr>";
                menu += "&lt;tr>";
                menu += "&lt;th onclick='elegirDia(" + semana + ",0,2," + iduf + "," + origen + ")' style='white-space: nowrap;padding:0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a href='#' class='calendariohref' style='padding:20px;color: white;'>Semana " + semana + "&lt;/a>&lt;/th>\n";
                semana++;
                for (var z = 0; z &lt; 7; z++) {
                    if (diaSemana == contSemana) {
                        break;
                    }
                    menu += "&lt;td style='user-select: none;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;/td>\n";
                    contSemana++;
                }
                for (var x = 1; x &lt; 13; x++) {
                    if (x == 1 || x == 3 || x == 5 || x == 7 || x == 8 || x == 10 || x == 12) {
                        for (var y = 1; y &lt; 32; y++) {
                            if (contSemana == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                            else if (contSemana % 6 == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")'  style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                menu += "&lt;/tr>\n";
                                menu += "&lt;tr>\n";
                                menu += "&lt;th onclick='elegirDia(" + semana + ",0,2," + iduf + "," + origen + ")'  style='user-select: none;white-space: nowrap;padding:0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a  class='calendariohref' style='padding:20px;color: white;'>Semana " + semana + "&lt;/th>\n";
                                semana++;
                                contSemana = 0;
                            } else if (contSemana > 0 &amp;&amp; contSemana &lt; 6) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")'  style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;' >" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                        }
                    }
                    else if (x == 2 &amp;&amp; (anio % 4) != 0) {
                        for (var y = 1; y &lt; 29; y++) {
                            if (contSemana == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")'  style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                            else if (contSemana % 6 == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")'  style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                menu += "&lt;/tr>\n";
                                menu += "&lt;tr>\n";
                                menu += "&lt;th onclick='elegirDia(" + semana + ",0,2," + iduf + "," + origen + ")'  style='user-select: none;white-space: nowrap;padding:0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a  class='calendariohref' style='padding:20px;color: white;'>Semana " + semana + "&lt;/th>\n";
                                semana++;
                                contSemana = 0;
                            } else if (contSemana > 0 &amp;&amp; contSemana &lt; 6) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;' >" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                        }
                    }
                    else if (x == 2 &amp;&amp; (anio % 4) == 0) {
                        numDiasAnio = 366;
                        for (var y = 1; y &lt; 30; y++) {
                            if (contSemana == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                            else if (contSemana % 6 == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                menu += "&lt;/tr>\n";
                                menu += "&lt;tr>\n";
                                menu += "&lt;th onclick='elegirDia(" + semana + ",0,2," + iduf + "," + origen + ")'  style='user-select: none;white-space: nowrap;padding:0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a  class='calendariohref' style='padding:20px;color: white;'>Semana " + semana + "&lt;/th>\n";
                                semana++;
                                contSemana = 0;
                            } else if (contSemana > 0 &amp;&amp; contSemana &lt; 6) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;' >" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                        }
                    } else {
                        for (var y = 1; y &lt; 31; y++) {
                            if (contSemana == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                            else if (contSemana % 6 == 0) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")' style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                menu += "&lt;/tr>\n";
                                menu += "&lt;tr>\n";
                                menu += "&lt;th onclick='elegirDia(" + semana + ",0,2," + iduf + "," + origen + ")'  style='user-select: none;white-space: nowrap;padding:0px;text-align:center;vertical-align:middle;font-size: 75%;'>&lt;a  class='calendariohref' style='padding:20px;color: white;'>Semana " + semana + "&lt;/th>\n";
                                semana++;
                                contSemana = 0;
                            } else if (contSemana > 0 &amp;&amp; contSemana &lt; 6) {
                                menu += "&lt;td onmouseup='elegirDia(" + semana + "," + (contSemana + 1) + ",3," + iduf + "," + origen + ")'  style='user-select: none;padding:0px;border:solid 1px black;text-align:center;vertical-align:middle;font-size: 75%;'>" + y + "/" + x + "/" + anio + "&lt;/td>\n";
                                contSemana++;
                            }
                        }
                    }
                }
                menu += "&lt;/tr>";
                menu += "&lt;/table>";
                menu += "&lt;/div>"
                if (origen == 1) {
                    menu += "&lt;button class='btnMenu' style='margin-top:20px; margin-right:15px; background-color:orange;' type='button' onclick='guardarCalendario(" + numDiasAnio + "," + iduf + ")'>Guardar&lt;/button>";
                    menu += "&lt;button class='btnMenu' style='margin-top:20px;' type='button' onclick='updateOperaciones()'>Volver&lt;/button>";
                }
                else {
                    menu += "&lt;button class='btnMenu' style='margin-top:20px; margin-right:15px; background-color:orange;' type='button' onclick='guardarCalendario(" + numDiasAnio + "," + iduf + ")'>Guardar&lt;/button>";
                    menu += "&lt;button class='btnMenu' style='margin-top:20px;' type='button' onclick='updateVehiculo()'>Volver&lt;/button>";
                }
                document.getElementById("contenido").innerHTML = menu;
                seleccionmultiplecalendario();
                $('a.calendariohref').click(function (e) {
                    e.preventDefault();
                });
                //Si existe calendario se colorean los días con el color del día tipo correspondiente
                if ($scope.calendario.length > 0) {
                    document.getElementById("menu").innerHTML = "";
                    $http.post('detallesCalendario.php', { 'idcalendario': idCalendario,'base':1 }).success(function (data) {
                        $scope.detallesCalendario = data;
                        ADdetallescalendario = data;
                        for (var x = 1; x &lt; document.getElementById("calendario").rows.length; x++) {
                            for (var y = 1; y &lt; document.getElementById("calendario").rows[x].cells.length; y++) {
                                for (var z = 0; z &lt; $scope.detallesCalendario.length; z++) {
                                    if (document.getElementById("calendario").rows[x].cells[y].childNodes.length != 0) {
                                        if ($scope.detallesCalendario[z].diatipo != "0" &amp;&amp; $scope.detallesCalendario[z].iddia == document.getElementById("calendario").rows[x].cells[y].innerHTML &amp;&amp; idCalendario == $scope.detallesCalendario[z].idcalendario) {
                                            document.getElementById("calendario").rows[x].cells[y].style.backgroundColor = arrayColores[$scope.detallesCalendario[z].diatipo - 1];
                                        }
                                    }
                                }
                            }
                        }
                        OcultarSpinner();
                    });
                }
                else
                    OcultarSpinner();
            });
        }
        /**

        * Cargamos la sección calendario

        * @return  {void}

         */
        seleccionmultiplecalendario = function ()
        {
            var filaI,columnaI,filaF,columnaF;
            //Seleccionamos la filas, columnas o celdas dependiendo de donde haya seleccionado el usuario
            $("#calendario").on("mouseenter", "td", function() {
                this.classList.add("selectedcolumn");
              });
              $("#calendario").on("mouseleave", "td", function() {
                this.classList.remove("selectedcolumn");
              });
              $("#calendario").on("mousedown", "td", function() {
                filaI = $(this).closest("tr").index();
                columnaI = $(this).closest("td").index();
                this.classList.remove("selectedcolumn");
                this.classList.add("selcalendar");
              });
              $("#calendario").on("mouseup", "td", function() {
                filaF = $(this).closest("tr").index();
                columnaF = $(this).closest("td").index();
                this.classList.remove("selectedcolumn");
                this.classList.add("selcalendar");
                if (filaI > filaF)
                {
                    var reverseI = filaI
                    var reverseF = filaF
                    filaI = reverseF;
                    filaF = reverseI;
                }
                //Dibujamos todas las filas y columnas correspondientes con la selección
               for (var fila = filaI; fila &lt;= filaF;  fila++)
                {
                    for (var columna = 1; columna &lt; $("#calendario tr")[fila].cells.length;columna++)
                    {
                        if (columna >= columnaI &amp;&amp; columna &lt;= columnaF || (columnaI > columnaF &amp;&amp; columna &lt;= columnaI &amp;&amp; columna >= columnaF ))   
                        {
                            $("#calendario tr")[fila].cells[columna].classList.add("selcalendar");
                            Aselectcellcalendar.push($("#calendario tr")[fila].cells[columna]);
                        }
                    }
                }
              });
        }
        /**

        * Guardamos los cambios realizados en el calendario

        * @param  {number}
        * @return  {void}

         */
        guardarCalendario = async function (numDiasAnio, idunidadfuncional) {
            MostrarSpinner();
            var arrayfilas = new Array();
            var arraydiatipo = new Array();
            var nombre = "calendario" + usuario;
            var idcalendario = 0;
            //Sacamos de la base de datos el calendario a guardar
            if ($scope.calendario.length > 0) {
                for (var x = 0; x &lt; $scope.calendario.length; x++)
                    if ($scope.calendario[x].iduf == idunidadfuncional)
                        idcalendario = $scope.calendario[x].id;
            }
            var arrayColores = new Array("rosybrown", "yellow", "orange", "orangered", "lightblue", "lightpink", "cornflowerblue", "grey", "yellowgreen", "aqua", "aquamarine", "brown", "burlywood",
                '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6',
                '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A',
                '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
                '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC',
                '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
                '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680',
                '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
                '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3',
                '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF');

            //Borramos los valores previamente guardados para ese claendario
            await $http.post("borrarCalendario.php", { 'idcaso': idCaso, 'iduf': idunidadfuncional,'base':1 })
             .success(function (data, status, headers, config) {
             console.log(data);

             });
            await $http.post('borrarDetalleCalendario.php', { 'idcalendario': idcalendario,'base':1 })
             //Guardamos el calendario
            await $http.post("insertarCalendario.php", { 'idcaso': idCaso, 'nombre': nombre, 'iduf': idunidadfuncional,'base':1 })
             //Actualizamos la lista de calendarios
            await $http.post('calendarios.php', { 'idcaso': idCaso, 'base':1})
                .success(function (data) {
                    console.log(data);
                    $scope.calendario = data;
                    ADcalendario = data;
                });
            for (var u = 0; u &lt; $scope.calendario.length; u++) {
                if ($scope.calendario[u].iduf == idunidadfuncional) {
                    idcalendario = $scope.calendario[u].id;
                    if (idunidadfuncional == 0)
                    IDcalendarioVE = idcalendario
                }
            }
            //Sacamos el valor del día tipo asignado a cada día del calendario
            for (var x = 1; x &lt; document.getElementById("calendario").rows.length; x++) {
                for (var y = 1; y &lt; document.getElementById("calendario").rows[x].cells.length; y++) {
                    var diatipo = 0;
                    var color = document.getElementById("calendario").rows[x].cells[y].style.backgroundColor;
                    for (var z = 0; z &lt; arrayColores.length; z++) {
                        if (arrayColores[z] == color) {
                            diatipo = (z + 1);
                            break;
                        }
                    }
                    if (diatipo == 0) {
                        diatipo++;
                    }
                    if (document.getElementById("calendario").rows[x].cells[y].textContent.length > 0) {
                        arrayfilas.push(document.getElementById("calendario").rows[x].cells[y].textContent);
                        arraydiatipo.push(diatipo);
                        
                    }
                }
            }
            //Insertamos el valor de los detalles del calendario
            await $http.post("insertarDetallesCalendario.php", { 'idcalendario': idcalendario, 'iddia': arrayfilas, 'diatipo': arraydiatipo,'base':1 }).success(function () {
                alert("Datos guardados con éxito");
                if (idunidadfuncional != 0)
                    updateOperaciones();
                else
                    updateVehiculo();
            });
            
        }
        /**

        * Mostramos los dias tipo

        * @param  {number}
        * @return  {void}

         */
        elegirDia = function (semana, diaSemana, tipo, unidadFuncional, origen) {
            $('#modalColoresDia').modal('show');
            var menu = "";
            var cont = 0;
            var arrayColores = new Array("rosybrown", "yellow", "orange", "orangered", "lightblue", "lightpink", "cornflowerblue", "grey", "yellowgreen", "aqua", "aquamarine", "brown", "burlywood",
                '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6',
                '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A',
                '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
                '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC',
                '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
                '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680',
                '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
                '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3',
                '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF');
                //Los cargamos en función de la sección a la que pertenezca
            if (origen == 1) {
                for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                    if ($scope.diastipocaso[x].id_caso == idCaso &amp;&amp; unidadFuncional == $scope.diastipocaso[x].id_uf) {
                        menu += "&lt;button class='btnMenu' style='margin-10px; background-color:" + arrayColores[cont] + " ' onclick='updateDiaTipoCalendario(" + semana + "," + diaSemana + "," + tipo + "," + cont + ")'  data-dismiss='modal'>" + $scope.diastipocaso[x].nombre + "&lt;/button>&lt;/br>";
                        cont++;
                    }
                }
                document.getElementById("ColoresDia").innerHTML = menu;
            }
            else {
                for (var x = 0; x &lt; diastipoVE.length; x++) {
                    menu += "&lt;button class='btnMenu' style='margin-10px; background-color:" + arrayColores[cont] + " ' onclick='updateDiaTipoCalendario(" + semana + "," + diaSemana + "," + tipo + "," + cont + ")'  data-dismiss='modal'>" + diastipoVE[x].nombre + "&lt;/button>&lt;/br>";
                    cont++;
                }
                document.getElementById("ColoresDia").innerHTML = menu;
            }
        }
        /**

        * Actualizamos los colores de los días tipo en función de la seelcción

        * @param  {number}
        * @return  {void}

         */
        updateDiaTipoCalendario = function (semana, diaSemana, tipo, colorDia) {
            var arrayColores = new Array("rosybrown", "yellow", "orange", "orangered", "lightblue", "lightpink", "cornflowerblue", "grey", "yellowgreen", "aqua", "aquamarine", "brown", "burlywood",
                '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6',
                '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A',
                '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
                '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC',
                '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
                '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680',
                '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
                '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3',
                '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF');
                //En función de la selección dibujamos una columna, fila o celda.
            if (tipo == "3")
                for (tdsel = 0; tdsel &lt; Aselectcellcalendar.length; tdsel++)
                    if ( Aselectcellcalendar[tdsel].textContent != "")
                   Aselectcellcalendar[tdsel].style.backgroundColor = arrayColores[colorDia];
            if (tipo == "2") 
                for (var x = 1; x &lt; document.getElementById('calendario').rows[semana].cells.length; x++) 
                    if (document.getElementById('calendario').rows[semana].cells[x].innerHTML != "") 
                        document.getElementById('calendario').rows[semana].cells[x].style.backgroundColor = arrayColores[colorDia];
            if (tipo == "1") 
                for (var x = 1; x &lt; document.getElementById('calendario').rows.length; x++) 
                    if (document.getElementById('calendario').rows[x].cells[diaSemana].innerHTML != "") 
                        document.getElementById('calendario').rows[x].cells[diaSemana].style.backgroundColor = arrayColores[colorDia];
            for (tdsel = 0; tdsel &lt; Aselectcellcalendar.length; tdsel++)
                Aselectcellcalendar[tdsel].classList.remove("selcalendar");       
            Aselectcellcalendar = [];

        }
        /**

        * Eliminamos el contador escogido

        * @return  {void}

         */
        eliminarContador = function () {
            //Cogemos los datos del contador
            var acuContador = "";
            var select = document.getElementById("nombreNuevoContador").value;
            var id = "";
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == select) {
                    id = $scope.contador[x].id;
                    break;
                }
            }
            if (id != "") {
                for (var i = 0; i &lt; $scope.contador.length; i++) {
                    if (id == $scope.contador[i].id) {
                        var element = document.getElementById("contador" + $scope.contador[i].nombre);
                        element.parentNode.removeChild(element);
                    }
                }
                //Borramos el contador
                $http.post("borrarContador.php", { 'idcaso': idCaso, 'nombre': select,'base':1 })
                    .success(function (data) {
                        console.log(data);
                        $http.post('contador.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                            $scope.contador = data;
                            ADcontador = data;
                            loop1:
                            for (var x = 0; x &lt; equipos.length; x++) {
                                if (equipos[x][6] == "4") {
                                    var contadoresEquipo = equipos[x][8];
                                    for (var y = 0; y &lt; contadoresEquipo.length; y++) {
                                        if (contadoresEquipo[y] != ",") {
                                            acuContador += contadoresEquipo[y];
                                        } else {
                                            if (acuContador == id) {
                                                equipos[x][8] = contadoresEquipo.substring(0, (y - acuContador.length)) + "" + contadoresEquipo.substring(y, contadoresEquipo.length);
                                                break loop1;
                                            }
                                            acuContador = "";
                                        }
                                    }
                                }
                            }
                        });
                    });
                //Y a continuación borramos el consumo
                $http.post("borrarTodoConsumo.php", { 'idcontador': id,'base':1 })
                    .success(function (data) {
                        console.log(data);
                        $http.post('consumoContador.php',{'base':1}).success(function (data) {
                            $scope.consumo = data;
                            ADconsumo = data;
                        });
                    });
                document.getElementById('opcionesContador').style.display = "none"
                document.getElementById('contenidoContador').innerHTML = "";
                document.getElementById("lineas").innerHTML = "";
            } else {
                alert("Escoja el contador que desee borrar");
            }
            document.getElementById("nombreNuevoContador").value = "";
        }
        /**

        * Creamos un nuevo consumo vacío solo con el nombre

        * @return  {void}

         */
        nuevoConsumo = function () {
            //Comprobamos si cumple las restricciones
            if (nombreNuevoConsumo.value &lt; 2014 || nombreNuevoConsumo.value > 2018) {
                alert('El Periodo de lectura debe estar comprendido entre 2014 y 2018');
                return;
            }
            if (nombreNuevoConsumo.value.length != 4) {
                alert('El Periodo de lectura debe tener 4 caracteres');
                return;
            }
            var consumos = 0;
            var todoCorrecto = true;
            var repe = false;
            var idContador = 1;
            var idconsumo = 0;
            var valido = "";
            //introducimos el nuevo consumo en la base de datos
            var select = document.getElementById('nombreNuevoContador').value;
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == select) {
                    valido = $scope.contador[x].id;
                    break;
                }
            }
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].periodo == document.getElementById('nombreNuevoConsumo').value &amp;&amp; $scope.consumo[x].idcontador == valido)
                    repe = true;
                if ($scope.consumo[x].idcontador == valido &amp;&amp; $scope.consumo[x].indice == "1") {
                    consumos++;
                    idconsumo = x;
                }
            }
            //Cancelamos si hay mas de 5.
            if (consumos >= 5) {
                alert('No puede haber más de 5 Consumos ( Periodos de lectura ) Para un mismo contador');
                return;
            }
            var nombreConsumo = document.getElementById('nombreNuevoConsumo').value;
            if (/^[0-9]*$/.test(document.getElementById('nombreNuevoConsumo').value) == false) {
                alert("ERROR: El año debe ser numérico");
                todoCorrecto = false;
            }
            //Si el nombre es correcto le asignamos un tipo por defecto
            if (nombreConsumo.length > 0 &amp;&amp; nombreConsumo != null) {
                if (repe == false) {
                    var select = document.getElementById("nombreNuevoContador").value;
                    idContador = valido;
                    if (todoCorrecto == true) {
                        if (consumos > 0) {
                            for (var x = 0; x &lt; $scope.consumo.length; x++)
                                if ($scope.consumo[x].idcontador == valido)
                                    var tipo = $scope.consumo[x].tipo;
                        }
                        else
                            var tipo = 1;
                        document.getElementById('tipoConsumo').style.display = "block";
                        //Creamos un nuevo consumo vacío solo con el nombre y cargamos la lista de consumos actualizada
                        $http.post("insertarConsumo.php", {
                            'idcontador': idContador, 'periodo': nombreConsumo, 'indice': 1, 'valor': 1, 'tipo': tipo, 'archivohorario': '-','base':1
                        }).success(function (data) {
                            console.log(data);
                            $http.post('consumoContador.php',{'base':1}).success(function (data) {
                                $scope.consumo = data;
                                ADconsumo = data;
                                document.getElementById('tipoConsumo').style.display = "hidden";
                                if (consumos > 0) {
                                    for (var x = 0; x &lt; $scope.consumo.length; x++) {
                                        //Dependiendo del tipo de consumo se activará un botón u otro
                                        if ($scope.consumo[x].idcontador == valido) {
                                            if ($scope.consumo[x].tipo == "1" &amp;&amp; selectorusocontador() === false) {
                                                document.getElementById('radio1').disabled = false;
                                                document.getElementById('radio1').checked = true;
                                                document.getElementById('radio2').disabled = true;
                                                document.getElementById('radio3').disabled = true;
                                                break;
                                            }
                                            if ($scope.consumo[x].tipo == "2" &amp;&amp; selectorusocontador() === false) {
                                                document.getElementById('radio1').disabled = true;
                                                document.getElementById('radio2').checked = true;
                                                document.getElementById('radio2').disabled = false;
                                                document.getElementById('radio3').disabled = true;
                                                break;
                                            }
                                            if ($scope.consumo[x].tipo == "3") {
                                                document.getElementById('radio1').disabled = true;
                                                document.getElementById('radio3').checked = true;
                                                document.getElementById('radio2').disabled = true;
                                                document.getElementById('radio3').disabled = false;
                                                break;
                                            }
                                            if ($scope.consumo[x].tipo == "0" &amp;&amp; selectorusocontador() === false) {
                                                document.getElementById('radio1').disabled = false;
                                                document.getElementById('radio2').disabled = false;
                                                document.getElementById('radio3').disabled = false;
                                            }
                                        }
                                    }
                                }
                                //Si no hay uso seleccionado no se asigna activa ningún botón
                                else if (selectorusocontador() === false) {
                                    document.getElementById('radio1').disabled = false;
                                    document.getElementById('radio2').disabled = false;
                                    document.getElementById('radio3').disabled = false;
                                }
                                //Se introduce en la lista de consumos el nuevoconsumo
                                for (var x = 0; x &lt; $scope.consumo.length; x++) {
                                    if ($scope.consumo[x].periodo == nombreConsumo &amp;&amp; $scope.consumo[x].idcontador == idContador) {
                                        id = $scope.consumo[x].id;
                                        var opt = document.createElement('option');
                                        var opt2 = document.createElement('a');
                                        opt2.href = "#"
                                        opt2.innerHTML = "&lt;option  class='hover' id='opcionConsumo" + $scope.consumo[x].periodo + "' onclick='elegirConsumo(" + $scope.consumo[x].id + ")'value='" + x + "'>" + $scope.consumo[x].periodo + "&lt;/option>";
                                        opt.value = x;
                                        opt.id = "opcionConsumo" + x;
                                        opt.innerHTML = nombreConsumo;
                                        for (var i = 0; i &lt; $('#tipoConsumo')[0].getElementsByTagName('input').length; i++)
                                            if ($('#tipoConsumo')[0].getElementsByTagName('input')[i].checked == true)
                                                cargarTablas(i + 1);
                                        document.getElementsByClassName('dropdown-menu')[1].appendChild(opt2);
                                    }
                                }
                                selectorusocontador();
                                HUtil.CambiarColor_Children_Select();
                            });
                        });
                    }
                }
                else
                    alert("ERROR: El año de consumo no puede ser repetido");
            }
            else
                alert("ERROR: El año de consumo no puede estar vacío");
        }
        /**

        * Le asignamos un año al consumo

        * @param  {string}
        * @return  {void}

         */
        elegirConsumo = function (id) {
            tipoConsumo = 0;
            var idContador = "";
            var nombre = "";
            var consumo = 0;
            //Cargamos los datos del consumo elegido
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].id == id) {
                    nombre = $scope.consumo[x].periodo;
                    idContador = $scope.consumo[x].idcontador;
                }
            }
            document.getElementById('nombreNuevoConsumo').value = nombre;
            var select = document.getElementById('nombreNuevoConsumo').value;
            document.getElementById('tipoConsumo').style.display = "block";
            //Por seguridad bloqueamos los radios
            if (idContador == "input") {
                document.getElementById('radio1').disabled = true;
                document.getElementById('radio2').disabled = true;
                document.getElementById('radio3').disabled = true;
                document.getElementById('tipoConsumo').style.visibility = "hidden";
                document.getElementById('tipoConsumo2').style.visibility = "hidden";
            }
            else {
                //Comprobamos si hay consumos
                for (var f = 0; f &lt; document.getElementsByClassName('dropdown-menu')[1].children.length; f++)
                    consumo++;
                for (var x = 0; x &lt; $scope.consumo.length; x++) {
                    if (consumo > 1) {
                        //Si hay consumos cargamos el primero
                        if ($scope.consumo[x].idcontador == idContador &amp;&amp; $scope.consumo[x].indice == "1" &amp;&amp; $scope.consumo[x].periodo == nombre) {
                            for (var i = 0; i &lt; $('#tipoConsumo')[0].getElementsByTagName('input').length; i++) {
                                if ($('#tipoConsumo')[0].getElementsByTagName('input')[i].disabled == false) {
                                    $('#tipoConsumo')[0].getElementsByTagName('input')[i].checked = true;
                                    cargarTablas(i + 1);
                                    break;
                                }
                            }
                        }
                    }
                    //Si no hay contador ocultamos la sección de consumo
                    else if (selectorusocontador() === false) {
                        document.getElementById('tipoConsumo2').style.visibility = "hidden";
                        document.getElementById('tipoConsumo2').innerHTML = "";
                        document.getElementById('radio1').checked = false;
                        document.getElementById('radio2').checked = false;
                        document.getElementById('radio3').checked = false;
                    }
                    //Si hay consumo lo cargamos
                    if (consumo == 1 &amp;&amp; selectorusocontador() === false) {
                        for (var x = 0; x &lt; $scope.consumo.length; x++) {
                            if ($scope.consumo[x].idcontador == idContador) {
                                $('#tipoConsumo')[0].getElementsByTagName('input')[$scope.consumo[x].tipo - 1].checked = true;
                                cargarTablas($scope.consumo[x].tipo);
                            }
                        }
                        document.getElementById('radio1').disabled = false;
                        document.getElementById('radio2').disabled = false;
                        document.getElementById('radio3').disabled = false;
                        break;
                    }
                }
            }
            
        }
        /**

        * Cargamos el consumo correspondiente y los datos

        * @return  {void}

         */
        cargarConsumo = function () {
            var consumos = 0;
            var creados = false;
            var cargado = false;
            var idContador = "";
            //Sacamos los datos del contador en caso de que tuviera asignados un consumo
            var select = document.getElementById("nombreNuevoContador").value;
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == select) {
                    idContador = $scope.contador[x].id;
                    break;
                }
            }
            //Cargamos la sección
            menu = "";
            menu += "&lt;label style='display: block ;vertical-align: middle; margin-top:20px;'>Periodo de lectura:&lt;/label>";
            menu += " &lt;div class='input-group' style='display:flex;flex-wrap: wrap-reverse;' >"
            menu += " &lt;input type='text' id='nombreNuevoConsumo' style='transform: scale(1); class='form-control' aria-label='Text input with segmented dropdown button' maxlength='5'>";
            menu += " &lt;div class='input-group-prepend' style='display:inline;'>";
            menu += "    &lt;button class='btnMenu' style='transform: scale(1); margin-left:10px;' onclick='nuevoConsumo()'>Añadir&lt;/button>";
            menu += "    &lt;button class='btnMenu' style='transform: scale(1);' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
            menu += "      Seleccionar&lt;/button>";
            menu += "   &lt;button class='btnMenu' style='transform: scale(1); background-color:orangered;' onclick='eliminarConsumo()'>Eliminar&lt;/button>";
            menu += "   &lt;div class='dropdown-menu' style='margin-top:-1px;'>";
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].idcontador == idContador &amp;&amp; $scope.consumo[x].indice == "1") {
                    menu += "&lt;a href='#'>&lt;option class='hover'  id='opcionConsumo" + $scope.consumo[x].periodo + "' onclick='elegirConsumo(" + $scope.consumo[x].id + ")'value='" + x + "'>" + $scope.consumo[x].periodo + "&lt;/option>&lt;/a>";
                    consumos++;
                }
            }
            menu += "    &lt;/div>";
            menu += "   &lt;/div>";
            menu += "    &lt;/div>";
            menu += "&lt;div id='tipoConsumo' style='margin-top:22px;' >";
            if ($scope.consumo.length == 0) {
                menu += "&lt;input type='radio' id='radio1' style='margin-bottom: 13px;' name='tipoConsumo' value='0' onclick='cargarTablas(1)' disabled>&amp;nbsp; Anual &lt;br />";
                menu += "&lt;input type='radio' id='radio2' style='margin-bottom: 13px;' name='tipoConsumo' value='1' onclick='cargarTablas(2)' disabled>&amp;nbsp; Mensual&lt;br />";
                menu += "&lt;input type='radio' id='radio3' style=' display: none;margin-bottom: 13px;' name='tipoConsumo' value='2' onclick='cargarTablas(3)' disabled>&lt;br />";
            }
            else if (consumos > 1) {
                for (var x = 0; x &lt; $scope.consumo.length; x++) {
                    if ($scope.consumo[x].idcontador == idContador &amp;&amp; creados == false) {
                        if ($scope.consumo[x].indice == "1" &amp;&amp; $scope.consumo[x].tipo == "1") {
                            menu += "&lt;input type='radio' id='radio1' style='margin-bottom: 13px;' name='tipoConsumo' value='0' onclick='cargarTablas(1)'  ckecked>&amp;nbsp; Anual &lt;br />";
                        } else {
                            menu += "&lt;input type='radio' id='radio1' style='margin-bottom: 13px;' name='tipoConsumo' value='0' onclick='cargarTablas(1)' disabled>&amp;nbsp; Anual &lt;br />";
                        }
                        if ($scope.consumo[x].indice == "1" &amp;&amp; $scope.consumo[x].tipo == "2") {
                            menu += "&lt;input type='radio' id='radio2' style='margin-bottom: 13px;' name='tipoConsumo' value='1' onclick='cargarTablas(2)'  checked>&amp;nbsp; Mensual&lt;br />";
                        } else {
                            menu += "&lt;input type='radio' id='radio2' style='margin-bottom: 13px;' name='tipoConsumo' value='1' onclick='cargarTablas(2)' disabled>&amp;nbsp; Mensual&lt;br />";
                        }
                        if ($scope.consumo[x].indice == "1" &amp;&amp; $scope.consumo[x].tipo == "3") {
                            menu += "&lt;input type='radio' id='radio3' style='display:none;margin-bottom: 13px;' name='tipoConsumo' value='2' onclick='cargarTablas(3)' checked>&amp;nbsp; &lt;br />";
                        } else {
                            menu += "&lt;input type='radio' id='radio3' style='display:none;margin-bottom: 13px;' name='tipoConsumo' value='2' onclick='cargarTablas(3)' disabled>&amp;nbsp;&lt;br />";
                        }
                        creados = true;
                    }
                }
            } else {
                if ($scope.consumo[0].indice == "1" &amp;&amp; $scope.consumo[0].tipo == "1") {
                    menu += "&lt;input type='radio' id='radio1' style='margin-bottom: 13px;' name='tipoConsumo' value='0' onclick='cargarTablas(1)' ckecked>&amp;nbsp; Anual &lt;br />";
                } else {
                    menu += "&lt;input type='radio' id='radio1' style='margin-bottom: 13px;' name='tipoConsumo' value='0' onclick='cargarTablas(1)'>&amp;nbsp; Anual &lt;br />";
                }
                if ($scope.consumo[0].indice == "1" &amp;&amp; $scope.consumo[0].tipo == "2") {
                    menu += "&lt;input type='radio' id='radio2' style='margin-bottom: 13px;' name='tipoConsumo' value='1' onclick='cargarTablas(2)' checked>&amp;nbsp; Mensual&lt;br />";
                } else {
                    menu += "&lt;input type='radio' id='radio2' style='margin-bottom: 13px;' name='tipoConsumo' value='1' onclick='cargarTablas(2)'>&amp;nbsp; Mensual&lt;br />";
                }
                if ($scope.consumo[0].indice == "1" &amp;&amp; $scope.consumo[0].tipo == "3") {
                    menu += "&lt;input type='radio' id='radio3' style='display:none;margin-bottom: 13px;' name='tipoConsumo' value='2' onclick='cargarTablas(3)' checked>&amp;nbsp;&lt;br />";
                } else {
                    menu += "&lt;input type='radio' id='radio3' style='display:none;margin-bottom: 13px;' name='tipoConsumo' value='2' onclick='cargarTablas(3)'>&amp;nbsp; &lt;br />";
                }
            }
            menu += "&lt;div id='tipoConsumo2'>&lt;/div>";
            menu += "&lt;/div> ";
            document.getElementById('contenidoContador').innerHTML = menu;
            HUtil.CambiarColor_Children_Select();
            document.getElementById('tipoConsumo').style.display = "none";
            document.getElementById('contenidoContador').style.display = "block";
            var menu = "";
            //Cargamos el consumo en caso de haberlo.
            if (consumos > 0) {
                document.getElementById('nombreNuevoConsumo').value = $scope.consumo[0].periodo;
                for (var x = 0; x &lt; $scope.consumo.length; x++) {
                    if ($scope.consumo[x].idcontador == idContador &amp;&amp; $scope.consumo[x].indice == "1" &amp;&amp; cargado == false) {
                        elegirConsumo($scope.consumo[x].id);
                        cargado = true;
                    }
                }
            }
            else
                consumoGuardado = false;
        }

        /**

        * Cargar tablas consumo tipo

        * @param  {number}
        * @return  {void}

         */
        cargarTablas = function (tipo) {
            tipoConsumo = tipo;
            var menu = "";
            document.getElementById('tipoConsumo2').style.visibility = "visible";
            document.getElementById("tipoConsumo2").innerHTML = "";
            //Cargamoslas tablas según el tipo de consumo seleccionado
            if (tipo == 1)
                menu += "&lt;input style='transform:scale(1);margin:5px' type='text' id='consumo1' value='1' maxlength='15'/>kWh&lt;br />\n";
            else if (tipo == 2)
                for (var x = 1; x &lt; 13; x++) {
                    if (x &lt;= 9)
                        menu += "Mes " + x + "&lt;input style='transform:scale(1); margin-left: 22px; margin-top: 3%; margin-right:8px;' type='text' id='consumo" + x + "' value='1' maxlength='6'/>kWh&lt;br />\n";
                    if (x >= 10)
                        menu += "Mes " + x + "&lt;input style='transform:scale(1); margin-left: 14px; margin-top: 3%; margin-right:8px;' type='text' id='consumo" + x + "' value='1' maxlength='6'/>kWh&lt;br />\n";
                }
            else if (tipo == 3)
                menu += "&lt;input style='transform:scale(1)' type='file' id='consumo1' />&lt;br />\n";
            document.getElementById("tipoConsumo2").innerHTML = menu;
            var valido = document.getElementById('nombreNuevoConsumo').value;
            var select2 = document.getElementById('nombreNuevoContador').value;
            var valido2 = "";
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == select2) {
                    valido2 = $scope.contador[x].id;
                    break;
                }
            }
            //Cargamos los valores e las tablas
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].periodo == valido &amp;&amp; tipo == $scope.consumo[x].tipo &amp;&amp; $scope.consumo[x].idcontador == valido2) {
                    if (tipo == $scope.consumo[x].tipo)
                        document.getElementById('consumo' + $scope.consumo[x].indice).value = $scope.consumo[x].valor;
                }
            }
            
        }
        /**

        * Guardamos el vector del contador

        * @param  {number}
        * @return  {void}

         */
        guardarVector = function (num) {
            //Almacenamos el nombre del véctor elegido
            if (num == 0) {
                var select = document.getElementById("vectorEnergético");
                arrayContador[2] = select.options[select.selectedIndex].text;
            } else if (num == 1) {
                arrayContador[2] = "Gas Natural";
                $('#myModalVectores').modal('hide');
            } else if (num == 2) {
                arrayContador[2] = "Gas Propano";
                $('#myModalVectores').modal('hide');
            } else if (num == 3) {
                arrayContador[2] = "Biomasa";
                $('#myModalVectores').modal('hide');
            } else if (num == 4) {
                arrayContador[2] = "Electricidad";
                $('#myModalVectores').modal('hide');
            } else if (num == 5) {
                arrayContador[2] = "Energías Renovables";
                $('#myModalVectores').modal('hide');
            }
        }
        /**

        * Guardamos los valores de consumo

        * @return  {void}

         */
        guardarConsumo = function () {
            var todoCorrecto = true;
            //Comprobamos si efectivamente hay consumo que guardar
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].idcontador == arrayContador[0] &amp;&amp; $scope.consumo[x].indice == "2") {
                    consumoGuardado = true;
                }
            }
            //Comprobamos que los campos estén bien rellenados
            if (/^[0-9]+([.][0-9]+)?$/.test(document.getElementById('consumo1').value) == false) {
                alert('ERROR: El campo mes con valores no numéricos');
                todoCorrecto = false;
            }
            if (tipoConsumo == 2) {
                for (var x = 2; x &lt; 13; x++) {
                    if (/^[0-9]+([.][0-9]+)?$/.test(document.getElementById('consumo' + x).value) == false) {
                        alert('ERROR: El campo mes ' + x + ' con valores no numéricos');
                        todoCorrecto = false;
                    }
                }
            }
            //Sacamos los valores del consumo y de su contador
            var select = document.getElementById('nombreNuevoContador').value;
            var valido = "";
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == select) {
                    valido = $scope.contador[x].id;
                    break;
                }
            }
            var nombreConsumo = document.getElementById('nombreNuevoConsumo').value;
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].idcontador == select &amp;&amp; $scope.consumo[x].indice == "1" &amp;&amp; $scope.consumo[x].periodo == nombreConsumo) {
                    idCaso2 = $scope.consumo[x].id;
                }
            }
            //Guardamos los valores en la base de datos
            if (todoCorrecto = true) {
                if (tipoConsumo == 1) {
                    $http.post("updateConsumo.php", {
                        'idcontador': arrayContador[0], 'periodo': nombreConsumo, 'indice': 1, 'valor': document.getElementById('consumo1').value,
                        'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                    }).success(function (data) {
                        console.log(data);
                    });
                } else if (tipoConsumo == 2) {
                    $http.post("updateConsumo.php", {
                        'idcontador': arrayContador[0], 'periodo': nombreConsumo, 'indice': 1, 'valor': document.getElementById('consumo1').value,
                        'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                    }).success(function (data) {
                        console.log(data);
                    });
                    if (consumoGuardado == false) {
                        for (var x = 2; x &lt; 13; x++) {
                            $http.post("insertarConsumo.php", {
                                'idcontador': arrayContador[0], 'periodo': nombreConsumo, 'indice': x, 'valor': document.getElementById('consumo' + x).value,
                                'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                            }).success(function (data) {
                                console.log(data);
                            });
                        }
                    } else {
                        for (var x = 2; x &lt; 13; x++) {
                            $http.post("updateConsumo.php", {
                                'idcontador': arrayContador[0], 'periodo': nombreConsumo, 'indice': x, 'valor': document.getElementById('consumo' + x).value,
                                'tipo': document.getElementById('consumo1').value, 'archivohorario': "-",'base':1
                            }).success(function (data) {
                                console.log(data);
                            });
                        }
                    }
                } else if (tipoConsumo == 3) {
                    $http.post("updateConsumo.php", {
                        'idcontador': arrayContador[0], 'periodo': nombreConsumo, 'indice': 1, 'valor': "-",
                        'tipo': tipoConsumo, 'archivohorario': document.getElementById('consumo1').value,'base':1
                    }).success(function (data) {
                        console.log(data);
                    });
                }
                //Actualizamos la tabla
                $http.post('consumoContador.php',{'base':1}).success(function (data) {
                    $scope.consumo = data;
                    ADconsumo = data;
                });
                $('#myModalConsumo').modal('hide');
            }
        }
        /**

        * Guardamos el nuevo contador con el nombre solamente

        * @return  {void}

         */
        crearContadorVacio = function () {
            var repe = false;
            var id = "";
            //Comprobamos si en el caso hay un contador con el mismo nombre
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == document.getElementById('nombreNuevoContador').value) {
                    repe = true;
                }
            }
            //Comprobamos si el nombre es correcto
            arrayContador[0] = document.getElementById('nombreNuevoContador').value;
            if (document.getElementById('nombreNuevoContador').value.length > 0 &amp;&amp; /^[A-Za-z0-9]/.test(document.getElementById('nombreNuevoContador').value) == true) {
                if (repe == false) {
                    //insertamos el caso
                    $http.post("insertarContador.php", {
                        'id': 1, 'nombre': arrayContador[0], 'idcaso': idCaso, 'tipo': 0, 'vector': '- Selecciona -','base':1
                    }).success(function (data) {
                        console.log(data);
                        document.getElementById('nombreNuevoContador').value = "";
                        $http.post('contador.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                            $scope.contador = data;
                            ADcontador = data;
                            for (var x = 0; x &lt; $scope.contador.length; x++) {
                                if ($scope.contador[x].nombre == arrayContador[0]) {
                                    id = $scope.contador[x].id;
                                    console.log(id);
                                    var opt = document.createElement('option');
                                    var opt2 = document.createElement('a');
                                    opt.value = x;
                                    opt.id = "contador" + x;
                                    opt.innerHTML = arrayContador[0];
                                    opt.click = addEventListener("click", elegirContador(id));
                                    opt2.href = "#"
                                    opt2.innerHTML = "&lt;option class='hover' value='" + x + "' id='contador" + $scope.contador[x].nombre + "' onclick='elegirContador(" + $scope.contador[x].id + ")'>" + $scope.contador[x].nombre + "&lt;/option>";
                                    document.getElementsByClassName('dropdown-menu')[0].appendChild(opt2);
                                    document.getElementById('opcionesContador').style.display = "inline-block";
                                }
                            }
                            HUtil.CambiarColor_Children_Select();
                        });
                    });
                } else {
                    alert("ERROR: El nombre del contador está repetido");
                }
            } else {
                alert("ERROR: El nombre del contador no puede estar vacío");
            }
        }
        /**

        * Guardamos los valores del contador

        * @return  {void}

         */
        guardarContador = function () {
            //Comprobamos que haya un periodo
            if ($('#tipoConsumo :input').length &lt; 4) {
                alert('Debe definir un periodo de lectura para el contador')
                return;
            }
            MostrarSpinner();
            for (var i = 0; i &lt; $('#tipoConsumo :input').length; i++) {
                if ($('#tipoConsumo :input')[i].checked == true) {
                    tipoConsumo = i + 1;
                    break;
                }
            }
            for (var vc = 0; vc &lt; $('#tipoConsumo2 input').length; vc++) {
                
                if ($('#tipoConsumo2 input')[vc].value == "") {
                    if ($('input:radio[name=tipoConsumo]')[2].checked == true)
                        alert('Debe incluir un archivo horario')
                    else
                        alert('Debe rellenar el valor de consumo kWh')
                    return OcultarSpinner();
                }
            }
            var todoCorrecto = true;
            var contador = "";
            var nombreConsumo = "";
            var valido = "";
            var contador = document.getElementById('nombreNuevoContador').value;
            var id = "";
            for (var x = 0; x &lt; $scope.contador.length; x++) {
                if ($scope.contador[x].nombre == contador) {
                    valido = $scope.contador[x].id;
                    break;
                }
            }
            if (document.getElementById('contenidoContador').innerHTML != "")
                var nombreConsumo = document.getElementById('nombreNuevoConsumo').value;
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].idcontador == valido &amp;&amp; $scope.consumo[x].periodo == nombreConsumo)
                    id = $scope.consumo[x].id;
            }
            //Comprobamos que todo esté correcto
            if (arrayContador[2] == "- Selecciona -") {
                alert('ERROR: Selecciona un vector');
                todoCorrecto = false;
                OcultarSpinner();
                return;
            }
            if (/^[0-9]*$/.test(document.getElementById('consumo1').value) == false) {
                alert('ERROR: El campo mes con valores no numéricos');
                todoCorrecto = false;
            }
            if (tipoConsumo == 2) {
                for (var x = 2; x &lt; 13; x++) {
                    if (/^[0-9]*$/.test(document.getElementById('consumo' + x).value) == false) {
                        alert('ERROR: El campo mes ' + x + ' con valores no numéricos');
                        todoCorrecto = false;
                    }
                }
            }
            for (var x = 0; x &lt; $scope.consumo.length; x++) {
                if ($scope.consumo[x].idcontador == valido &amp;&amp; $scope.consumo[x].periodo == nombreConsumo &amp;&amp; $scope.consumo[x].indice == "12") {
                    consumoGuardado = true;
                    break;
                }
                else
                    consumoGuardado = false;
            }
            //Si todo es correcto
            if (todoCorrecto == true) {
                MostrarSpinner();
                if (valido != 0) {
                    //Comprobamos si la tabla de casos está vacía en función de ello asignaremos un id al caso
                    document.getElementById('botonContador').disabled = true;
                    //Actulizamos el caso
                    $http.post("updateContador.php", {
                        'id': valido, 'nombre': contador, 'idcaso': idCaso, 'tipo': arrayContador[3], 'vector': arrayContador[2],'base':1
                    }).success(function (data) {
                        console.log(data);
                        $http.post('contador.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                            $scope.contador = data;
                            ADcontador = data;
                        });
                    });
                    //Dependiendo del tipo de consumo
                    if (id != 0) {
                        if (tipoConsumo == 1) {
                            //Borramos el consumo antiguo
                            var valorconsumo = document.getElementById('consumo1').value;
                            $http.post("borrarConsumo.php", { 'idcontador': valido, 'periodo': nombreConsumo,'base':1 })
                                .success(function (data) {
                                    //E insertamos el nuevo índice 1
                                    console.log(data);
                                    $http.post("insertarConsumo.php", {
                                        'idcontador': valido, 'periodo': nombreConsumo, 'indice': 1, 'valor': valorconsumo,
                                        'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                        $http.post('consumoContador.php',{'base':1}).success(function (data) {
                                            $scope.consumo = data;
                                            ADconsumo = data;
                                            alert("Datos guardados correctamente");
                                            OcultarSpinner();
                                            vaciarcontenido();
                                        });
                                    });
                                });
                        }
                        else if (tipoConsumo == 2) {
                            //Actualizamos el vlaor del índice 1
                            $http.post("updateConsumo.php", {
                                'idcontador': valido, 'periodo': nombreConsumo, 'indice': 1, 'valor': document.getElementById('consumo1').value,
                                'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                            }).success(function (data) {
                                console.log(data);
                                $http.post('consumoContador.php',{'base':1}).success(function (data) {
                                    $scope.consumo = data;
                                    ADconsumo = data;
                                    alert("Datos guardados correctamente");
                                    OcultarSpinner();
                                    vaciarcontenido();
                                });
                            });
                            //Si no hubiera consumo insertamos los valores
                            if (consumoGuardado == false) {
                                for (var x = 2; x &lt; 13; x++) {
                                    $http.post("insertarConsumo.php", {
                                        'idcontador': valido, 'periodo': nombreConsumo, 'indice': x, 'valor': document.getElementById('consumo' + x).value,
                                        'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                }
                            }
                            else {
                                //Si no actualizamos los valores del consumo
                                for (var x = 1; x &lt; 13; x++) {
                                    $http.post("updateConsumo.php", {
                                        'idcontador': valido, 'periodo': nombreConsumo, 'indice': x, 'valor': document.getElementById('consumo' + x).value,
                                        'tipo': tipoConsumo, 'archivohorario': "-",'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                }
                            }
                        }
                        //En el caso 3 actualizamos
                        else if (tipoConsumo == 3) {
                            $http.post("updateConsumo.php", {
                                'id': id, 'idcontador': valido, 'periodo': nombreConsumo, 'indice': 1, 'valor': "-",
                                'tipo': tipoConsumo, 'archivohorario': document.getElementById('consumo1').value,'base':1
                            }).success(function (data) {
                                console.log(data);
                                alert("Datos guardados correctamente");
                                OcultarSpinner();
                                vaciarcontenido();
                            });
                        }
                        else if (tipoConsumo == 0) {
                            alert('Selecciona un Consumo( Periodo de lectura ) para el contador');
                            botonContador.disabled = false;
                            return OcultarSpinner();
                        }
                    } else {
                        alert("Datos guardados correctamente");
                        OcultarSpinner();
                        vaciarcontenido();
                    }
                }
            }
            OcultarSpinner();
            vaciarcontenido();
            
        }
        /**

        * Cargamos la geometría y construcción de los casos

        * @return  {void}

         */
        updateGeometria = function () 
        {
            MostrarSpinner();
            HGeometria.UpdateGeometria();
        }
        //Guardamos los datos correspondientes a la geometria
        
        //Cargamos los datos de la geometria con respecto a la unidad funcional
        
        /**

        * Añadimos una nueva pared a la geometría o a la piscina

        * @return  {void}

         */
        aniadirPared = function (pared) {
            //Añadimos la nueva columna correspondiente dependiendo de si estamos en piscina o geometría
            if (pared == 1) {
                th = document.createElement('th');
                var row = document.getElementById("cabGeo");
                th.innerHTML = document.getElementById("cabGeo").cells.length;
                var x = row.appendChild(th);
                row = document.getElementById("oriGeo");
                x = row.insertCell(document.getElementById("oriGeo").cells.length);
                x.innerHTML = "-";
                x.contentEditable = true;
                row = document.getElementById("supGeo");
                x = row.insertCell(document.getElementById("supGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("porGeo");
                x = row.insertCell(document.getElementById("porGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("cerGeo");
                x = row.insertCell(document.getElementById("cerGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("hueGeo");
                x = row.insertCell(document.getElementById("hueGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("solGeo");
                x = row.insertCell(document.getElementById("solGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("facGeo");
                x = row.insertCell(document.getElementById("facGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("obsGeo");
                x = row.insertCell(document.getElementById("obsGeo").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
            } else if (pared == 2) {
                th = document.createElement('th');
                var row = document.getElementById("cabPis");
                th.innerHTML = document.getElementById("cabPis").cells.length;
                var x = row.appendChild(th);
                row = document.getElementById("oriPis");
                x = row.insertCell(document.getElementById("oriPis").cells.length);
                x.innerHTML = "-";
                x.contentEditable = true;
                row = document.getElementById("supPis");
                x = row.insertCell(document.getElementById("supPis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("porPis");
                x = row.insertCell(document.getElementById("porPis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("cerPis");
                x = row.insertCell(document.getElementById("cerPis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("huePis");
                x = row.insertCell(document.getElementById("huePis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("solPis");
                x = row.insertCell(document.getElementById("solPis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("facPis");
                x = row.insertCell(document.getElementById("facPis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
                row = document.getElementById("obsPis");
                x = row.insertCell(document.getElementById("obsPis").cells.length);
                x.innerHTML = 0;
                x.contentEditable = true;
            }
        }

        /**

        *Borramos una pared a la geometría o de la piscina

        * @return  {void}

         */
        eliminarPared = function (pared) {
            //Eliminamos la última columna correspondiente dependiendo de si estamos en piscina o geometría
            if (pared == 1) {
                //La eliminamos si hay 3 o mas paredes
                if (document.getElementById("cabGeo").cells.length > 2) {
                    var row = document.getElementById("cabGeo");
                    row.deleteCell(document.getElementById("cabGeo").cells.length - 1);
                    row = document.getElementById("oriGeo");
                    row.deleteCell(document.getElementById("oriGeo").cells.length - 1);
                    row = document.getElementById("supGeo");
                    row.deleteCell(document.getElementById("supGeo").cells.length - 1);
                    row = document.getElementById("porGeo");
                    row.deleteCell(document.getElementById("porGeo").cells.length - 1);
                    row = document.getElementById("cerGeo");
                    row.deleteCell(document.getElementById("cerGeo").cells.length - 1);
                    row = document.getElementById("hueGeo");
                    row.deleteCell(document.getElementById("hueGeo").cells.length - 1);
                    row = document.getElementById("solGeo");
                    row.deleteCell(document.getElementById("solGeo").cells.length - 1);
                    row = document.getElementById("facGeo");
                    row.deleteCell(document.getElementById("facGeo").cells.length - 1);
                    row = document.getElementById("obsGeo");
                    row.deleteCell(document.getElementById("obsGeo").cells.length - 1);
                } else {
                    alert("El número de elementos debe ser como mínimo 2");
                }
            } else if (pared == 2) {
                if (document.getElementById("cabPis").cells.length > 2) {
                    var row = document.getElementById("cabPis");
                    row.deleteCell(document.getElementById("cabPis").cells.length - 1);
                    row = document.getElementById("oriPis");
                    row.deleteCell(document.getElementById("oriPis").cells.length - 1);
                    row = document.getElementById("supPis");
                    row.deleteCell(document.getElementById("supPis").cells.length - 1);
                    row = document.getElementById("porPis");
                    row.deleteCell(document.getElementById("porPis").cells.length - 1);
                    row = document.getElementById("cerPis");
                    row.deleteCell(document.getElementById("cerPis").cells.length - 1);
                    row = document.getElementById("huePis");
                    row.deleteCell(document.getElementById("huePis").cells.length - 1);
                    row = document.getElementById("solPis");
                    row.deleteCell(document.getElementById("solPis").cells.length - 1);
                    row = document.getElementById("facPis");
                    row.deleteCell(document.getElementById("facPis").cells.length - 1);
                    row = document.getElementById("obsPis");
                    row.deleteCell(document.getElementById("obsPis").cells.length - 1);
                } else {
                    alert("El número de elementos debe ser como mínimo 2");
                }
            }
        }
        /**

        *Eliminamos o cargamos las columnas e inputs

        * @return  {void}

         */
        borrarSeccion = function (seccion) {
            var row;
            //Eliminamos o añadimos la sección correspondiente al pulsar las casillas
            if (document.getElementById('seccion1').checked == true) {
                document.getElementById('acristalado').style.display = "none";
            } else { document.getElementById('acristalado').style.display = "inline-block"; }
            if (document.getElementById('seccion2').checked == true) {
                document.getElementById('muro').style.display = "none";
            } else { document.getElementById('muro').style.display = "inline-block"; }
            if (document.getElementById('seccion3').checked == true) {
                document.getElementById('invierno').style.display = "none";
            } else { document.getElementById('invierno').style.display = "inline-block"; }
            if (document.getElementById('operacionesUF').innerHTML.length > 0) {
                var edificio = document.getElementById('operacionesUF').innerHTML;
                for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                    if ($scope.ufCaso[x].iduf == edificio) {
                        edificio = $scope.ufCaso[x].id;
                    }
                }
            } else {
                var edificio = document.getElementById('operacionesUF').value;
                for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                    if ($scope.ufCaso[x].nombre == edificio) {
                        edificio = $scope.ufCaso[x].id;
                    }
                }
            }
            //Eliminamos las columnas correspondientes en función del checkbox
            switch (seccion) {
                case 1:
                    if (document.getElementById('seccion' + seccion).checked == false) {
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "%Acristalado") {
                                for (var i = 1; i &lt; 11; i++) {
                                    row = document.getElementById("ori" + i);
                                    row.deleteCell(x);
                                }
                                row = document.getElementById("cabGeo");
                                row.deleteCell(x);
                                
                                break;
                            }
                        }
                    } else {
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "Superficie(m2)") {
                                var TH = document.getElementById("cabGeo").querySelectorAll("th");
                                for (var i = 1; i &lt; 11; i++) {
                                    row = document.getElementById("ori" + i);
                                    celda = row.insertCell(x + 1);
                                    celda.innerHTML = 0;
                                    for (var z = 0; z &lt; ADgeometria.length; z++) {
                                        if (ADgeometria[x].orientacion == document.getElementById('geometria').rows[i].cells[0].innerHTML &amp;&amp; ADgeometria[x].iduf == edificio) {
                                            celda.innerHTML = ADgeometria[x].porcenacristalado;
                                            break;
                                        }
                                    }
                                    celda.contentEditable = true;
                                }
                                row = document.getElementById("cabGeo");
                                th = document.createElement('th');
                                th.innerHTML = "%Acristalado";
                                row.insertBefore(th, TH[2]);
                                updateDatosGeo(edificio);
                                break;
                            }
                        }
                    }
                    break;
                case 2:
                    if (document.getElementById('seccion' + seccion).checked == false) {
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "u Muro(W/m2k)") {
                                for (var i = 1; i &lt; 11; i++) {
                                    row = document.getElementById("ori" + i);
                                    row.deleteCell(x);
                                    row.deleteCell(x);
                                    row.deleteCell(x);
                                }
                                row = document.getElementById("cabGeo");
                                row.deleteCell(x);
                                row.deleteCell(x);
                                row.deleteCell(x);

                                document.getElementById('muro2').disabled = false;
                                document.getElementById('hueco').style.visibility = "visible";
                                document.getElementById('hueco').disabled = false;
                                document.getElementById('ghueco').style.visibility = "visible";
                                document.getElementById('ghueco').disabled = false;
                                break;
                            }
                        }
                    } else {
                        var esta = false;
                        var posCab = 2;
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "%Acristalado") {
                                esta = true;
                                posCab = 3;
                            }
                        }
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "%Acristalado" || (document.getElementById("cabGeo").cells[x].innerHTML == "Superficie(m2)" &amp;&amp; esta == false)) {
                                var TH = document.getElementById("cabGeo").querySelectorAll("th");
                                for (var i = 1; i &lt; 11; i++) {
                                    row = document.getElementById("ori" + i);
                                    celda = row.insertCell(x + 1);
                                    celda.innerHTML = 0;
                                    for (var z = 0; z &lt; ADgeometria.length; z++) {
                                        if (ADgeometria[x].orientacion == document.getElementById('geometria').rows[i].cells[0].innerHTML &amp;&amp; ADgeometria[x].iduf == edificio) {
                                            celda.innerHTML = ADgeometria[x].umuro;
                                            break;
                                        }
                                    }
                                    celda.contentEditable = true;
                                    celda = row.insertCell(x + 1);
                                    celda.innerHTML = 0;
                                    for (var z = 0; z &lt; ADgeometria.length; z++) {
                                        if (ADgeometria[x].orientacion == document.getElementById('geometria').rows[i].cells[0].innerHTML &amp;&amp; ADgeometria[x].iduf == edificio) {
                                            celda.innerHTML = ADgeometria[x].uhueco;
                                            break;
                                        }
                                    }
                                    celda.contentEditable = true;
                                    celda = row.insertCell(x + 1);
                                    celda.innerHTML = 0;
                                    for (var z = 0; z &lt; ADgeometria.length; z++) {
                                        if (ADgeometria[x].orientacion == document.getElementById('geometria').rows[i].cells[0].innerHTML &amp;&amp; ADgeometria[x].iduf == edificio) {
                                            celda.innerHTML = ADgeometria[x].ghueco;
                                            break;
                                        }
                                    }
                                    celda.contentEditable = true;
                                }
                                row = document.getElementById("cabGeo");
                                th = document.createElement('th');
                                th.innerHTML = "u Muro(W/m2k)";
                                row.insertBefore(th, TH[posCab]);
                                th = document.createElement('th');
                                th.innerHTML = "u Ventana(W/m2k)";
                                row.insertBefore(th, TH[posCab]);
                                th = document.createElement('th');
                                th.innerHTML = "g Ventana";
                                row.insertBefore(th, TH[posCab]);
                                updateDatosGeo(edificio);
                                break;
                            }
                        }
                    }
                    break;
                case 3:
                    if (document.getElementById('seccion' + seccion).checked == false) {
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "F.S. Invierno") {
                                for (var i = 1; i &lt; 11; i++) {
                                    row = document.getElementById("ori" + i);
                                    row.deleteCell(x);
                                    row.deleteCell(x);
                                }
                                row = document.getElementById("cabGeo");
                                row.deleteCell(x);
                                row.deleteCell(x);
                                document.getElementById('invierno').style.visibility = "visible";
                                document.getElementById('invierno2').disabled = false;
                                document.getElementById('verano').style.visibility = "visible";
                                document.getElementById('verano').disabled = false;
                                break;
                            }
                        }
                    } else {
                        var esta = false;
                        var esta2 = false;
                        var posCab = 2;
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "%Acristalado") {
                                esta = true;
                                posCab = 3;
                            }
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "g Ventana") {
                                esta2 = true;
                                if (esta) {
                                    posCab = 6;
                                }
                                else {
                                    posCab = 5;
                                }
                            }
                        }
                        for (var x = 0; x &lt; document.getElementById("cabGeo").cells.length; x++) {
                            if (document.getElementById("cabGeo").cells[x].innerHTML == "g Ventana" || (document.getElementById("cabGeo").cells[x].innerHTML == "Superficie(m2)" &amp;&amp; esta == false &amp;&amp; esta2 == false) || (document.getElementById("cabGeo").cells[x].innerHTML == "%Acristalado" &amp;&amp; esta2 == false)) {
                                var TH = document.getElementById("cabGeo").querySelectorAll("th");
                                for (var i = 1; i &lt; 11; i++) {
                                    row = document.getElementById("ori" + i);
                                    celda = row.insertCell(x + 1);
                                    celda.innerHTML = 0;
                                    for (var z = 0; z &lt; ADgeometria.length; z++) {
                                        if (ADgeometria[x].orientacion == document.getElementById('geometria').rows[i].cells[0].innerHTML &amp;&amp; ADgeometria[x].iduf == edificio) {
                                            celda.innerHTML = ADgeometria[x].fsinvierno;
                                            break;
                                        }
                                    }
                                    celda.contentEditable = true;
                                    celda = row.insertCell(x + 1);
                                    celda.innerHTML = 0;
                                    for (var z = 0; z &lt; ADgeometria.length; z++) {
                                        if (ADgeometria[x].orientacion == document.getElementById('geometria').rows[i].cells[0].innerHTML &amp;&amp; ADgeometria[x].iduf == edificio) {
                                            celda.innerHTML = ADgeometria[x].fsverano;
                                            break;
                                        }
                                    }
                                    celda.contentEditable = true;
                                }
                                row = document.getElementById("cabGeo");
                                th = document.createElement('th');
                                th.innerHTML = "F.S. Invierno";
                                row.insertBefore(th, TH[posCab]);
                                th = document.createElement('th');
                                th.innerHTML = "F.S. Verano";
                                row.insertBefore(th, TH[posCab]);
                                th = document.createElement('th');
                                document.getElementById('invierno').style.visibility = "hidden";
                                document.getElementById('invierno').disabled = true;
                                document.getElementById('verano').style.visibility = "hidden";
                                document.getElementById('verano').disabled = true;
                                updateDatosGeo(edificio);
                                break;
                            }
                        }
                    }
                    break;
            }
        }
        /**

        *Cargamos la geometría avanzada

        * @return  {void}

         */
        GeometriaAvanzada = async function () {
            MostrarSpinner();
            await cargartodoBD();
            HgeometriaAvanzada.updateGeometriaAvanzada();
        }
        $scope.setClickedColumn = function (index, rango) {
            $scope.selectedTDx = null;
            $scope.selectedTDy = null;
            $scope.selectedRow = null;
            switch (rango) {
                case 0:
                    $scope.selectedColumn = index;
                    break;
                case 1:
                    if (index >= 1)
                        index++;
                    $scope.selectedColumn = index + 10;
                    break;
                case 2:

                    $scope.selectedColumn = index + 20;
                    break;
            }
        }
        $scope.setClickedRow = function (x) {
            $scope.selectedTDx = null;
            $scope.selectedTDy = null;
            $scope.selectedColumn = null;
            switch (x) {
                case 0:
                case 1:
                case 2:
                    $scope.selectedRow = 1;
                    break;
                case 4:
                case 5:
                case 6:
                    $scope.selectedRow = 5;
                    break;
                case 7:
                case 8:
                case 9:
                    $scope.selectedRow = 8;
                    break;
                case 10:
                case 11:
                case 12:
                    $scope.selectedRow = 11;
                    break;
                case 13:
                case 14:
                case 15:
                    $scope.selectedRow = 14;
                    break;
                case 17:
                case 18:
                case 19:
                    $scope.selectedRow = 18;
                    break;
            }
        }
        $scope.setClickedTD = function (x, y) {
            $scope.selectedTDx = x;
            $scope.selectedTDy = y;
            $scope.selectedColumn = null;
            $scope.selectedRow = null;
            $scope.chktext = tnueva.rows[$scope.selectedTDx + 1].children[$scope.selectedTDy + 1].textContent;
            switch ($scope.selectedTDx) {
                case 0:
                case 1:
                case 2:
                    $scope.selectedTDx = 1;
                    break;
                case 4:
                case 5:
                case 6:
                    $scope.selectedTDx = 5;
                    break;
                case 7:
                case 8:
                case 9:
                    $scope.selectedTDx = 8;
                    break;
                case 10:
                case 11:
                case 12:
                    $scope.selectedTDx = 11;
                    break;
                case 13:
                case 14:
                case 15:
                    $scope.selectedTDx = 14;
                    break;
                case 17:
                case 18:
                case 19:
                    $scope.selectedTDx = 18;
                    break;
            }
        }
        /**

        *Mostramos la información de los equipos

        * @return  {void}

         */
        updateEquipos = function () {
            //Creamos la tabla del listado de equipos en función de los equipos creados
            var equ = "";
            //Por defecto creamos la cabecera
            equ += "&lt;table id=' equipos'>&lt;th style='text-align:center;vertical-align:center;width:120px'>equipos&lt;/th>&lt;th style='text-align:center;vertical-align:center;width:120px'>Colector(GEN)&lt;/th>&lt;th style='text-align:center;vertical-align:center;width:120px'>Colector(ALI)&lt;/th>&lt;th style='text-align:center;vertical-align:center;width:120px'>Nuevo/ Existente&lt;/th> &lt;th style='text-align:center;vertical-align:center;width:120px'>Definido&lt;/th>";
            //Si existen equipos creados creamos las filas en función del número de equipos creados
            if (equipos.length != 0) {
                for (var x = 0; x &lt; equipos.length; x++) {
                    equ += "&lt;tr>&lt;td class='equipos' style='text-align:center;vertical-align:center;width:120px'>" + equipos[x][1] + "&lt;/td>";
                    equ += "&lt;td class='equipos'style='text-align:center;vertical-align:center;width:120px'>" + equipos[x][2] + "&lt;/td>";
                    equ += "&lt;td class='equipos' style='text-align:center;vertical-align:center;width:120px'>" + equipos[x][3] + "&lt;/td>";
                    equ += "&lt;td class='equipos'style='text-align:center;vertical-align:center;width:120px'>" + equipos[x][4] + "&lt;/td>";
                    equ += "&lt;td class='equipos'style='text-align:center;vertical-align:center;width:120px'>" + equipos[x][5] + "&lt;/td>&lt;/tr>";
                }
            }
            equ += "&lt;/table>";
            //Guardamos la tabla en la ventana emergente de equipos
            document.getElementById("equipos").innerHTML = equ;
            $('#modal').on('show.bs.modal', function () {
                $(this).find('.modal-body').css({
                    width: 'auto', //probably not needed
                    height: 'auto', //probably not needed
                });
            });
        }

        /**

        *Guardamos los datos generales del caso

        * @return  {void}

         */
        cargarDatosCasos = function () {
            //Comprobamos que haya unidad funcional
            for (var m = 1; m &lt; tablaFuncional2.rows.length + 1; m++)
                if (m != tablaFuncional2.rows.length || tablaFuncional2.rows.length == 1) {

                    if (tablaFuncional2.rows.length &lt; 2 || tablaFuncional2.rows[m].cells[1].children[0].selectedIndex == 0) {
                        alert('Debe Seleccionar una unidad funcional')
                        if (tablaFuncional2.rows.length == 1)
                            aniadirUnidad(1);
                        return;
                    }
                }
            var usuarioA = false;
            contDiastipoCreados = 0
            contT = 0;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }

            MostrarSpinner();
            
            var idFun = "";
            var nombre = "";
            var email = "";
            var cal = "0";
            var ref = "0";
            var acs = "0";
            var ilu = "0";
            var pis = "0";
            var otr = "0";
            var idCasoActual = "";
            var lastid = "";
            var CONSIN = "no";
            datosCambio = false;
            datosUFCambio = false;
            var ufIguales = 0;
            var periodo = "";
            var supTotal = 0;
            var clima = "";
            var intervencion = "";
            var todoCorrecto = true;
            var numDiasCaso=1;
            //Comprobamos que sea usuario avanzado y si los valores de los campos son correctos
            if (usuarioA==true){
            if (document.getElementById('conSim').checked == false) {
                CONSIN = "no";
            } else {
                CONSIN = "si";
            }
            } else {
                CONSIN = "si";
            }
            var select = document.getElementById('tipoEdificio');
            var edificio = select.options[select.selectedIndex].value;

            if (/^[0-9]*$/.test(document.getElementById('superficie').value) == false) {
                alert('ERROR: El campo superficie con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();

            }
            if (/^[0-9]*$/.test(document.getElementById('postal').value) == false) {
                alert('ERROR: El campo código postal con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();

            }
            if (superficie.value == 0) {
                alert('La superficie del edificio no puede ser 0')
                return OcultarSpinner();
            }
            if (/^[0-9]*$/.test(document.getElementById('altura').value) == false) {
                alert('ERROR: El campo altura con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();
            }
            if (/^[0-9]*$/.test(document.getElementById('superficie').value) == false) {
                alert('ERROR: El campo superficie con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();
            }
            if (document.getElementById('altura').value == 0) {
                alert('La altura del edificio no puede ser 0')
                return OcultarSpinner();
            }
            if (/^[0-9]*$/.test(document.getElementById('plantasSobre').value) == false) {
                alert('ERROR: El campo plantas sobre rasante con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();
            }
            if (/^[0-9]*$/.test(document.getElementById('plantasBajo').value) == false) {
                alert('ERROR: El campo plantas bajo rasante con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();
            }
            if (/^[0-9]*$/.test(document.getElementById('numero').value) == false) {
                alert('ERROR: El campo número con valores no numéricos');
                todoCorrecto = false;
                return OcultarSpinner();
            }
            if (usuarioA == true) {
                if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('tempAlta').value) == false) {
                    alert('ERROR: El campo temperatura de consigna alta con valores no numéricos');
                    todoCorrecto = false;
                    return OcultarSpinner();
                }
                if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('tempBaja').value) == false) {
                    alert('ERROR: El campo temperatura de consigna baja con valores no numéricos');
                    todoCorrecto = false;
                    return OcultarSpinner();
                }
                if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('venNoc').value) == false) {
                    alert('ERROR: El campo ventilación nocturna con valores no numéricos');
                    todoCorrecto = false;
                    return OcultarSpinner();
                }
            }
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                //Cargamos los casos en función del usuario
                if ($scope.caso[x].id == idCaso) {
                    idCasoActual = x;
                }
            }
            if (document.getElementById('tablaFuncional2').rows.length - 1 == $scope.ufCaso.length) {
                //Cargamos los valores e las casillas
                for (var x = 1; x &lt; document.getElementById('tablaFuncional2').rows.length; x++) {
                    idSelect = document.getElementById('tablaFuncional2').rows[x].cells[1].getElementsByTagName('select')[0].id;
                    var select = document.getElementById(idSelect);
                    if (parseInt(idSelect.slice(-2)) >= 10) {
                        lastid = idSelect.slice(-2);
                    } else {
                        lastid = idSelect.slice(-1);
                    }
                    if (document.getElementById("calFun" + lastid).checked == true) {
                        cal = "1";
                    }
                    if (document.getElementById("refFun" + lastid).checked == true) {
                        ref = "1";
                    }
                    if (document.getElementById("acsFun" + lastid).checked == true) {
                        acs = "1";
                    }
                    if (document.getElementById("pisFun" + lastid).checked == true) {
                        pis = "1";
                    }
                    if (document.getElementById("iluFun" + lastid).checked == true) {
                        ilu = "1";
                    }
                    if (document.getElementById("otrFun" + lastid).checked == true) {
                        otr = "1";
                    }
                    //Comprobamos que los valores de las unidades funcionales hayan sufrido cambios
                    for (var y = 0; y &lt; $scope.ufCaso.length; y++) {
                        if (document.getElementById('tablaFuncional2').rows[x].cells[0].innerHTML == $scope.ufCaso[y].nombreusuario &amp;&amp;
                            document.getElementById('tablaFuncional2').rows[x].cells[1].children[0].value == $scope.ufCaso[y].iduf &amp;&amp;
                            document.getElementById('tablaFuncional2').rows[x].cells[2].innerHTML == $scope.ufCaso[y].superficie &amp;&amp;
                            cal == $scope.ufCaso[y].calefaccion &amp;&amp; ref == $scope.ufCaso[y].refrigeracion &amp;&amp;
                            acs == $scope.ufCaso[y].acs &amp;&amp; pis == $scope.ufCaso[y].piscina &amp;&amp;
                            ilu == $scope.ufCaso[y].iluminacion &amp;&amp; otr == $scope.ufCaso[y].otros) {
                            ufIguales++;
                        }
                    }
                        for (var z = 0; z &lt; $scope.casotipodias.length; z++) {
                            if ($scope.ufCaso[0].iduf == $scope.casotipodias[z].id_uf &amp;&amp; $scope.casotipodias[z].id_caso == idCaso) {
                                    numDiasCaso++;
                                    loop1:
                                    for (var i = 0; i &lt; $scope.diastipocaso.length; i++) {
                                    if ($scope.diastipocaso[i].valocup == $scope.casotipodias[z].valocup &amp;&amp; $scope.diastipocaso[i].valilum == $scope.casotipodias[z].valilum &amp;&amp;
                                        $scope.diastipocaso[i].valequip == $scope.casotipodias[z].valequip &amp;&amp; $scope.diastipocaso[i].valacs == $scope.casotipodias[z].valacs &amp;&amp;
                                        $scope.diastipocaso[i].valacspiscina == $scope.casotipodias[z].valacspiscina &amp;&amp; $scope.diastipocaso[i].trarepacs == $scope.casotipodias[z].trarepacs &amp;&amp;
                                        $scope.ufCaso[0].id==$scope.diastipocaso[i].id_uf &amp;&amp; $scope.diastipocaso[i].numeroorden == $scope.casotipodias[z].numeroorden &amp;&amp; 
                                        $scope.diastipocaso[i].id_caso == $scope.casotipodias[z].id_caso &amp;&amp; $scope.diastipocaso[i].id_diatipo != $scope.casotipodias[z].id_diatipo) {
                                        ufIguales++;
                                        break loop1;

                }
            }
        }
    }

}
var igualesBasico=0;
                if (edificio == "1" || edificio == "2" || edificio == "3" || edificio == "4" || edificio == "5" || edificio == "6") {
                    igualesBasico=4;
                    } else {
                    igualesBasico = 7;
                    }
            //Comprobamos si hay alguna uf cambiada        
    if (ufIguales != igualesBasico) {
                    datosUFCambio = true;
                }
            
    } else {
        datosUFCambio = true;
    }
    //Comprobamos si los valores introducidos son correctos
            for (var x = 1; x &lt; document.getElementById('tablaFuncional2').rows.length; x++) {
                idFun = document.getElementById('tablaFuncional2').rows[x].cells[1].children[0].id;
                supTotal += parseInt(document.getElementById('tablaFuncional2').rows[x].cells[2].innerHTML);
                if (/^[0-9]*$/.test(document.getElementById('tablaFuncional2').rows[x].cells[2].innerHTML) == false) {
                    alert("ERROR: El campo superficie de la unidad funcional " + x + " con valores no numéricos");
                    todoCorrecto = false;
                    OcultarSpinner();
                    document.getElementById("botonDatos").disabled = false;
                }
                if (document.getElementById('tablaFuncional2').rows[x].cells[2].innerHTML == "0") {
                    alert("ERROR: El campo superficie de la unidad funcional " + x + " no puede ser 0");
                    todoCorrecto = false;
                    OcultarSpinner();
                    document.getElementById("botonDatos").disabled = false;
                }
            }
            if (supTotal > parseInt(document.getElementById('superficie').value)) {
                alert("ERROR: La suma de las superficies de las unidades funcionales no puede ser superior a la superficie total");
                todoCorrecto = false;
                OcultarSpinner();
                document.getElementById("botonDatos").disabled = false;
            }
            if (typeof ($scope.valoreshorarios) === "undefined" &amp;&amp; document.getElementById('tablaFuncional2').rows.length > 1) {
                alert('ERROR: Error al acceder a la base de datos, vuelva a intentarlo en unos segundos');
                todoCorrecto = false;
                OcultarSpinner();
                document.getElementById("botonDatos").disabled = false;
            }
            //Si son correctos comprobamos que los datos del caso han cambiado
            if (todoCorrecto == true) {
                intervencion = "1";
                clima = document.getElementById("clima").value;
                periodo = document.getElementById("periodoConstruccion").value;
                if ($scope.caso[idCasoActual].consim !=CONSIN  ||$scope.caso[idCasoActual].idedificio != edificio || $scope.caso[idCasoActual].periodo != document.getElementById("periodoConstruccion").options[periodo].innerHTML || $scope.caso[idCasoActual].nivel != "1" ||
                    $scope.caso[idCasoActual].clima != document.getElementById("clima").options[clima].innerHTML || $scope.caso[idCasoActual].altura != document.getElementById("altura").value || $scope.caso[idCasoActual].plantassobre != document.getElementById("plantasSobre").value ||
                    $scope.caso[idCasoActual].plantasbajo != document.getElementById("plantasBajo").value|| $scope.caso[idCasoActual].superficie != document.getElementById("superficie").value) {
                    datosCambio = true;
                }
                datosCasos[1] = select.options[select.selectedIndex].innerHTML;
                //Copiamos los datos del formulario en una lista para guardarlo en la base de datos relacionado con el caso actual
                nombre = nombreCaso;
                datosCasos[0] = nombreCaso;
                datosCasos[2] = document.getElementById("superficie").value;
                datosCasos[3] = document.getElementById("altura").value;
                datosCasos[4] = document.getElementById("plantasSobre").value;
                datosCasos[5] = document.getElementById("plantasBajo").value;

                //Comporbamos que se han seleccionado la localidad y almacenamos los valores
                if (document.getElementById("comunidad").value > 0) {
                    datosCasos[6] = $scope.comunidad[(document.getElementById("comunidad").value - 1)].nombre;
                } else {
                    alert('Debe seleccionar una Comunidad Autónoma')
                    return OcultarSpinner();
                }
                if (document.getElementById("provincia").value > 0) {
                    datosCasos[7] = $scope.provincia[(document.getElementById("provincia").value - 1)].nombre;
                } else {
                    alert('Debe seleccionar una Provincia')
                    return OcultarSpinner();
                }
                if (document.getElementById("localidad").value > 0) {
                    datosCasos[8] = $scope.localidad[(document.getElementById("localidad").value - 1)].nombre;
                } else {
                    datosCasos[8] = "-";
                }
                datosCasos[9] = document.getElementById("postal").value;
                var select2 = document.getElementById("via");
                datosCasos[10] = select2.options[select2.selectedIndex].innerHTML;
                datosCasos[11] = document.getElementById("nombreVia").value;
                datosCasos[12] = document.getElementById("numero").value;
                datosCasos[13] = document.getElementById("portal").value;
                datosCasos[14] = document.getElementById("escalera").value;
                datosCasos[15] = document.getElementById("piso").value;
                datosCasos[16] = document.getElementById("puerta").value;
                datosCasos[17] = document.getElementById("bloque").value;
                if (document.getElementById("periodoConstruccion").value > 0) {
                    periodo = document.getElementById("periodoConstruccion").value;
                    datosCasos[18] = document.getElementById("periodoConstruccion").options[periodo].innerHTML;
                } else {
                    alert('Debe Seleccionar Un periodo Constructivo');
                    return OcultarSpinner();
                }
                    intervencion = "1";
                    datosCasos[19] = "Nivel 0";
                 
                if (document.getElementById("clima").value > 0) {
                    clima = document.getElementById("clima").value;
                    datosCasos[20] = document.getElementById("clima").options[clima].innerHTML;
                } else {
                    alert('Debe Seleccionar Una Zona Climática');
                    return OcultarSpinner();
                }
                datosCasos[21] = "si";
                //Si es avanzado cargamos nuevos valores
                if (usuarioA == true) {
                    datosCasos[22] = document.getElementById("tempAlta").value;
                    datosCasos[23] = document.getElementById("mesI").value;
                    datosCasos[24] = document.getElementById("tempBaja").value;
                    datosCasos[25] = document.getElementById("mesF").value;
                    datosCasos[27] = document.getElementById("venNoc").value;
                    if (document.getElementById("impedircalefaccion").checked == true) {
                        datosCasos[26] = "si";
                    } else {
                        datosCasos[26] = "no";
                    }
                    if (document.getElementById('conSim').checked == false) {
                        datosCasos[21] = "no";
                    }
                    //Si no los ponemos a 0
                } else {
                    datosCasos[22] = 0;
                    datosCasos[23] = 0;
                    datosCasos[24] = 0;
                    datosCasos[25] = 0;
                    datosCasos[26] = 0;
                    datosCasos[27] = 0;
                }
                
                for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                    if ($scope.usuarios[x].id == usuario) {
                        email = $scope.usuarios[x].email;
                    }
                }
                //Si ha habido cambios en la unidad funcional
                if (datosUFCambio == true) {
                    if ($scope.ufCaso.length > 0) {
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso) {
                                valido = $scope.ufCaso[x].iduf;
                                valido2 = $scope.ufCaso[x].id;
                                //Borramos los  datos de las secciones previamente almacenados y actualizamos las tablas
                                for (var z = 0; z &lt; $scope.diastipocaso.length; z++) {
                                    if (datosCasos[19] == "Nivel 0") {
                                        if ($scope.diastipocaso[z].id_caso == idCaso &amp;&amp; $scope.diastipocaso[z].id_uf == valido2) {
                                            idtipodia = $scope.diastipocaso[z].id_diatipo;
                                            $http.post("borrarValores.php", {
                                                'id_diatipo': idtipodia,'base':1
                                            }).success(function (data) {
                                                console.log(data);

                                            });
                                        }

                                    } else {
                                        if ($scope.diastipocaso[z].id_caso == idCaso &amp;&amp; $scope.diastipocaso[z].id_uf == valido2) {
                                            idtipodia = $scope.diastipocaso[z].id_diatipo;
                                            $http.post("borrarValores.php", {
                                                'id_diatipo': idtipodia,'base':1
                                            }).success(function (data) {
                                                console.log(data);

                                            });
                                        }
                                    }
                                }
                            }
                        }

                    }
                    $http.post("borrarVariacionEstacional.php", { 'idcaso': idCaso,'base':1 })
                        .success(function (data) {
                            console.log(data);
                        });
                    $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                        $scope.valoreshorarioscaso = data;
                        ADvaloreshorarioscaso = data;
                    });
                    if ($scope.ufCaso.length > 0) {
                        for (var x = 0; x &lt; $scope.ufCaso.length; x++) {
                            if ($scope.ufCaso[x].idcaso == idCaso) {
                                valido = $scope.ufCaso[x].iduf;
                                valido2 = $scope.ufCaso[x].id;
                                if (datosCasos[19] == "Nivel 0") {
                                    $http.post("borrarDias.php", {
                                        'id_caso': idCaso, 'id_uf': valido2,'base':1
                                    }).success(function (data) {
                                        console.log(data);

                                    });
                                } else {
                                    $http.post("borrarDias.php", {
                                        'id_caso': idCaso, 'id_uf': valido2,'base':1
                                    }).success(function (data) {
                                        console.log(data);

                                    });
                                }
                            }
                        }

                    }
                    if ($scope.equipo.length > 0) {
                        $http.post("borrarEquipo.php", { 'idcaso': idCaso, 'nuex': "Existente",'base':1 })
                            .success(function () {
                            });
                        $http.post("borrarEquipo.php", { 'idcaso': idCaso, 'nuex': "Nuevo",'base':1 })
                            .success(function () {
                            });
                        $http.post("borrarBusesCaso.php", { 'idcaso': idCaso, 'nuex': "Existente",'base':1 })
                            .success(function () {
                            });
                        $http.post("borrarBusesCaso.php", { 'idcaso': idCaso, 'nuex': "Nuevo",'base':1 })
                            .success(function () {
                            });
                    }
                    $http.post('diasTipoCaso.php', { 'id_caso': idCaso,'base':1 }).success(function (data) {
                        $scope.diastipocaso = data;
                        ADdiastipocaso = data;
                    });
                    $http.post("borrarGeometria2.php", { 'idcaso': idCaso, 'base':1}).success(function (data) {
                        console.log(data);
                        $http.post('geometria.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                            ADgeometria = data;
                            ADgeometria = data;
                        });
                    });
                }
                //Borrado todo actualizamos el caso
                $http.post("updateCaso.php", {
                    'id': 3, 'nombre': nombreCaso, 'idusuario': usuario, 'idedificio': edificio, 'carpeta': email, 'usoEdificio': datosCasos[1],
                    'superficie': datosCasos[2], 'altura': datosCasos[3], 'plantasSobre': datosCasos[4], 'plantasBajo': datosCasos[5], 'comunidad': datosCasos[6],
                    'provincia': datosCasos[7], 'localidad': datosCasos[8], 'postal': datosCasos[9], 'via': datosCasos[10], 'nombreVia': datosCasos[11],
                    'numero': datosCasos[12], 'portal': datosCasos[13], 'escalera': datosCasos[14], 'piso': datosCasos[15], 'puerta': datosCasos[16], 'bloque': datosCasos[17],
                    'periodo': datosCasos[18], 'nivel': datosCasos[19], 'tiponum': "num", 'clima': datosCasos[20], 'consim': datosCasos[21], 'tempalta': datosCasos[22], 'mesinicial': datosCasos[23],
                    'tempbaja': datosCasos[24], 'mesfinal': datosCasos[25], 'impedircalefaccion': datosCasos[26], 'vennocturna': datosCasos[27], 'solove': soloVE, 'base':1
                }).success(function (data) {
                    console.log(data);
                    $http.post('casos.php', { 'idusuario': usuario, 'base':1}).success(function (data) {
                        $scope.caso = data;
                        ADcaso = data;
                    });
                });
                if (datosUFCambio == true) {
                    $http.post("borrarUnidadesFuncionalesCaso.php", { 'idcaso': idCaso, 'base':1})
                        .success(function (data) {
                            console.log(data);
                            $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                $scope.ufCaso = data;
                                ADufcaso = data;
                            });
                        });
                }
                if (document.getElementById("tablaFuncional2").rows.length > 1 &amp;&amp; (datosUFCambio == true || datosCambio == true)) {
                    if (document.getElementById(idFun).value != "0") {
                        //Introducimos la lista actual de equipos
                        $timeout(function () { insertarUFCaso() }, 500);
                    } else {
                        alert("Datos Guardados Correctamente");
                        numFun = 0;
                        OcultarSpinner();
                        vaciarcontenido();
                    }
                } else {
                    alert("Datos Guardados Correctamente");
                    numFun = 0;
                    OcultarSpinner();
                    vaciarcontenido();
                }
            }
            obtenerdatosedificio();
        }
        /**

        *Obtenemos los datos del edificio

        * @return  {void}

         */
        obtenerdatosedificio = async function () {
            idscalendario = new Object();
            //Sacamos ciertos datos del caso y los almacenamos en una variable para su uso posterior
           await $http.post('calendarios.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.calendario = data;
                ADcalendario = data;
            });
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if ($scope.usuarios[x].id == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    objedificiosel.usuarioA = true;
                    break;
                }
                else if ($scope.usuarios[x].id == usuario &amp;&amp; $scope.usuarios[x].ua == "no")
                    objedificiosel.usuarioA = false;

            }
            for (var x = 0; x &lt; $scope.caso.length; x++)
                if ($scope.caso[x].id == idCaso) {
                    objedificiosel.nombre = $scope.caso[x].usoedificio;
                    objedificiosel.idedificio = $scope.caso[x].idedificio;
                    objedificiosel.nombredelcaso = $scope.caso[x].nombre;
                    objedificiosel.localidad = $scope.caso[x].localidad;
                    objedificiosel.via = $scope.caso[x].via;
                    objedificiosel.nombrevia = $scope.caso[x].nombrevia;
                    objedificiosel.numero = $scope.caso[x].numero;
                    objedificiosel.clima = $scope.caso[x].clima;
                }
            for (var y = 0; y &lt; $scope.edificio.length; y++) {
                if (objedificiosel.idedificio == $scope.edificio[y].id) {
                    objedificiosel.tipoedificio = $scope.edificio[y].idtipoedificio;
                    objedificiosel.edificio = $scope.edificio[y].nombre;
                }
            }
            for (var a = 0; a &lt; $scope.ve_uf_unidadesfuncionales.length; a++)
                if ($scope.ve_uf_unidadesfuncionales[a].id_edificio == objedificiosel.idedificio)
                    objedificiosel.idufve = $scope.ve_uf_unidadesfuncionales[a].id_uf;
            if (objedificiosel.usuarioA == true) {
                for (var x = 0; x &lt; $scope.calendario.length; x++)
                    if ($scope.calendario[x].iduf == "0")
                        objedificiosel.idcalendarioVE = $scope.calendario[x].id;
            }
            for (var x = 0; x &lt; $scope.calendario.length; x++)
                idscalendario[x] = $scope.calendario[x].id
            objedificiosel.idcalendario = idscalendario;
        }

        /**

        *Insertamos las UF en la base de datos

        * @return  {void}

         */
        insertarUFCaso = function () {
            var valido4 = "";
            var valido = "";
            var kglobal = 0;
            var numdias = 0;
            var esgenerica = 0;
            var usuarioA = false;
            var altura = document.getElementById('altura').value
            var superficie = document.getElementById('superficie').value;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            
            var repite = false;
            var select2 = document.getElementById("intervencion");
            valorIntervencion = "1";
            var cal = "0";
            var ref = "0";
            var acs = "0";
            var ilu = "0";
            var pis = "0";
            var coc = "0";
            var fue = "0";
            var otr = "0";
            var idSelect = "";
            var lastid = "";
            var inv = "";
            var periodo = "";
            var constO = 0;
            var numPlantas = 0;
            var consin = "no";
            //Seleccionamos la unidad funcional correspondiente
            for (var x = 2; x &lt; document.getElementById("tablaFuncional2").rows.length + 1; x++) {
                var diasA = x;
                cal = "0";
                ref = "0";
                acs = "0";
                ilu = "0";
                pis = "0";
                coc = "0";
                fue = "0";
                otr = "0";
                var valido4 = "";
                //Cogemos los valores de la unidad funional que van a ser almacenados
                idSelect = document.getElementById('tablaFuncional2').rows[x - 1].cells[1].getElementsByTagName('select')[0].id;
                var select = document.getElementById(idSelect);
                if (parseInt(idSelect.slice(-2)) >= 10) {
                    lastid = idSelect.slice(-2);
                } else {
                    lastid = idSelect.slice(-1);
                }
                valido3 = select.options[select.selectedIndex].value;
                valido2 = select.options[select.selectedIndex].innerHTML;
                if (valido != "0") {
                    if (datosCasos[19] == "Nivel 0") {
                        for (var y = 0; y &lt; $scope.genericas.length; y++) {
                            if ($scope.genericas[y].nombre == valido2) {
                                valido = y;
                                valido3 = $scope.genericas[y].id_ufg;
                                valorIntervencion = "1";
                                esgenerica = 1;
                            }
                        }
                    }
                    if (document.getElementById("calFun" + lastid).checked == true) {
                        cal = "1";
                    }
                    if (document.getElementById("refFun" + lastid).checked == true) {
                        ref = "1";
                    }
                    if (document.getElementById("acsFun" + lastid).checked == true) {
                        acs = "1";
                    }
                    if (document.getElementById("pisFun" + lastid).checked == true) {
                        pis = "1";
                    }
                    if (document.getElementById("iluFun" + lastid).checked == true) {
                        ilu = "1";
                    }
                    if (esgenerica == 1) {
                        if (document.getElementById("otrFun" + lastid).checked == true || $scope.genericas[valido].cocina == "1" || $scope.genericas[valido].fuerza == "1") {
                            otr = "1";
                        }
                    } else {
                        valido = valido3;
                        if (document.getElementById("otrFun" + lastid).checked == true || $scope.funcionales[valido3 - 1].cocina == "1" || $scope.funcionales[valido3 - 1].fuerza == "1") {
                            otr = "1";
                        }
                    }
                    if (esgenerica == 1) {
                        numdias = parseInt($scope.genericas[valido].numdiastipo);
                    } else {
                        numdias = parseInt($scope.funcionales[valido3 - 1].numdiastipo);
                    }
                    //Si hay cambios la metemos en base de datos
                    if (datosUFCambio == true) {
                        $http.post("insertarUnidadesFuncionalesCaso.php", {
                            'id': 3, 'idcaso': idCaso, 'iduf': valido3, 'superficie': document.getElementById('tablaFuncional2').rows[x - 1].cells[2].innerHTML,
                            'calefaccion': cal, 'refrigeracion': ref, 'acs': acs, 'iluminacion': ilu, 'piscina': pis, 'cocina': otr,
                            'fuerza': otr, 'otros': otr, 'nombre': valido2,
                            'nombreusuario': document.getElementById('tablaFuncional2').rows[x - 1].cells[0].innerHTML, 'generica': esgenerica,'base':1
                        }).success(function (data) {
                            console.log(data);
                            $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                                $scope.ufCaso = data;
                                ADufcaso = data;
                                console.log(kglobal);
                                valido = $scope.ufCaso[kglobal].iduf;
                                valido2 = $scope.ufCaso[kglobal].id;
                                superficie2 = parseFloat($scope.ufCaso[kglobal].superficie);
                                kglobal++;

                                if (ADgeometria.length > 0) {
                                    for (var u = 0; u &lt; ADgeometria.length; u++) {
                                        if (ADgeometria[u].iduf == valido) {
                                            valido4 = ADgeometria[u].iduf;
                                            repite = true;
                                            break;
                                        }
                                    }
                                }

                                //Sacamos los datos útiles para la geometría
                                for (var y = 0; y &lt; $scope.caso.length; y++) {
                                    if ($scope.caso[y].nombre == nombreCaso &amp;&amp; $scope.caso[y].idusuario == usuario) {
                                        inv = $scope.caso[y].clima;
                                        periodo = $scope.caso[y].periodo;
                                        inv = inv[0];
                                        consin = $scope.caso[y].consim;
                                        altura = $scope.caso[y].altura;
                                        if (parseInt($scope.caso[y].plantassobre) > 0) {
                                            numPlantas = parseInt($scope.caso[y].plantassobre);
                                        }
                                        if (parseInt($scope.caso[y].plantasbajo) > 0) {
                                            numPlantas += parseInt($scope.caso[y].plantasbajo);
                                        }
                                        if (numPlantas > 0) {
                                            superficie2 = superficie2 / numPlantas;
                                        }
                                        if (inv == "a") {
                                            inv = "A";
                                        }
                                        switch (periodo) {
                                            case "Anterior a 1900":
                                                periodo = "1";
                                                break;
                                            case "1900 - 1940":
                                                periodo = "2";
                                                break;
                                            case "1940 - 1960":
                                                periodo = "3";
                                                break;
                                            case "1960 - 1979":
                                                periodo = "4";
                                                break;
                                            case "1979 - 2006":
                                                periodo = "5";
                                                break;
                                            case "2006 - 2013":
                                                periodo = "6";
                                                break;
                                            case "Posterior a 2013":
                                                periodo = "7";
                                                break;
                                        }
                                    }
                                }
                                //Sacamos los datos constructivos en funcíon del periodo y la zona climática
                                for (var i = 0; i &lt; $scope.construcciones.length; i++) {
                                    if ($scope.construcciones[i].zona_inv == inv &amp;&amp; $scope.construcciones[i].periodo == periodo) {

                                        constO = i;
                                    }
                                }
                                //Insertamos la pare de geometría en la base de datos.
                                if (consin == "si") {
                                    //Si la tabla de geometría está vacía introducimos nuevos datos
                                    if (repite == false) {
                                        var orientacion = new Array("Cubierta", "Suelo", "N", "NE", "E", "SE", "S", "SO", "O", "NO");
                                        if (ADgeometria.length > 0) {
                                            //Distinguimos el suelo y la cubierta de las otras orientaciones
                                            for (var w = 0; w &lt; orientacion.length; w++) {
                                                if (orientacion[w] == "Cubierta") {
                                                    $http.post("insertarGeometria.php", {
                                                        'idcaso': idCaso, 'iduf': valido2, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                                        'acristalado': 0, 'umuro': $scope.construcciones[constO].uc, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                    });
                                                } else if (orientacion[w] == "Suelo") {
                                                    $http.post("insertarGeometria.php", {
                                                        'idcaso': idCaso, 'iduf': valido2, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                                        'acristalado': 0, 'umuro': $scope.construcciones[constO].us, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                    });
                                                } else {
                                                    $http.post("insertarGeometria.php", {
                                                        'idcaso': idCaso, 'iduf': valido2, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                                        'acristalado': 15, 'umuro': $scope.construcciones[constO].um, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': 0, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                    });
                                                }
                                            }
                                            //Y actualizamos la tabla
                                            $http.post('geometria.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                                ADgeometria = data;
                                                ADgeometria = data;
                                            });

                                        } else {
                                            //Distinguimos el suelo y la cubierta de las otras orientaciones
                                            for (var w = 0; w &lt; orientacion.length; w++) {
                                                if (orientacion[w] == "Cubierta") {
                                                    $http.post("insertarGeometria.php", {
                                                        'idcaso': idCaso, 'iduf': valido2, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                                        'acristalado': 0, 'umuro': $scope.construcciones[constO].uc, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                    });
                                                } else if (orientacion[w] == "Suelo") {
                                                    $http.post("insertarGeometria.php", {
                                                        'idcaso': idCaso, 'iduf': valido2, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                                        'acristalado': 0, 'umuro': $scope.construcciones[constO].us, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                    });
                                                } else {
                                                    $http.post("insertarGeometria.php", {
                                                        'idcaso': idCaso, 'iduf': valido2, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                                        'acristalado': 15, 'umuro': $scope.construcciones[constO].um, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': 0, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                    });
                                                }
                                            }
                                            //Y actualizamos la tabla
                                            $http.post('geometria.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                                ADgeometria = data;
                                                ADgeometria = data;
                                            });
                                        }
                                    } else {
                                        //Si había datos los actualizamos
                                        $http.post("updateGeometria.php", {
                                            'idcaso': idCaso, 'superficie': superficie2, 'longitud': superficie2, 'iduf': valido2,'base':1
                                        }).success(function (data) {
                                            console.log(data);
                                            $http.post('geometria.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                                ADgeometria = data;
                                                ADgeometria = data;
                                            });
                                        });
                                    }
                                    repite = false;
                                } else {
                                    $http.post("borrarGeometria2.php", { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                        console.log(data);
                                    });
                                }

                                $http.post('diasTipoCaso.php', { 'id_caso': idCaso,'base':1 }).success(function (data) {
                                    $scope.diastipocaso = data;
                                    ADdiastipocaso = data;
                                    $timeout(function () { insertarDiasTipo(1, numdias, valido3, diasA) }, 500);
                                });
                            });
                        });
                    }
                    //En este caso se distingue  del anterior debido a que borramos previamente la geometría
                } if (datosUFCambio == false &amp;&amp; datosCambio == true) {
                    var UFcalculadas=2;
                    for (var y = 0; y &lt; $scope.caso.length; y++) {
                        if ($scope.caso[y].nombre == nombreCaso &amp;&amp; $scope.caso[y].idusuario == usuario) {
                            inv = $scope.caso[y].clima;
                            periodo = datosCasos[18];
                            inv = inv[0];
                            consin = datosCasos[21];
                            altura = datosCasos[3];
                            if (parseInt($scope.caso[y].plantassobre) > 0) {
                                numPlantas = parseInt($scope.caso[y].plantassobre);
                            }
                            if (parseInt($scope.caso[y].plantasbajo) > 0) {
                                numPlantas += parseInt($scope.caso[y].plantasbajo);
                            }
                            
                            if (inv == "a") {
                                inv = "A";
                            }
                            switch (periodo) {
                                case "Anterior a 1900":
                                    periodo = "1";
                                    break;
                                case "1900 - 1940":
                                    periodo = "2";
                                    break;
                                case "1940 - 1960":
                                    periodo = "3";
                                    break;
                                case "1960 - 1979":
                                    periodo = "4";
                                    break;
                                case "1979 - 2006":
                                    periodo = "5";
                                    break;
                                case "2006 - 2013":
                                    periodo = "6";
                                    break;
                                case "Posterior a 2013":
                                    periodo = "7";
                                    break;
                            }
                        }
                    }
                    for (var i = 0; i &lt; $scope.construcciones.length; i++) {
                        if ($scope.construcciones[i].zona_inv == inv &amp;&amp; $scope.construcciones[i].periodo == periodo) {

                            constO = i;
                        }
                    }
                    var orientacion = new Array("Cubierta", "Suelo", "N", "NE", "E", "SE", "S", "SO", "O", "NO");
                    if(x==2){
                    $http.post("borrarGeometria2.php", { 'idcaso': idCaso, 'base':1}).success(function () {
                        if (consin == "si") {
                        for (var i = 0; i &lt; $scope.ufCaso.length; i++) {
                            superficie2 = parseFloat($scope.ufCaso[i].superficie);
                            if (numPlantas > 0) {
                                superficie2 = superficie2 / numPlantas;
                            }
                            for (var w = 0; w &lt; orientacion.length; w++) {
                                if (orientacion[w] == "Cubierta") {
                                    $http.post("insertarGeometria.php", {
                                        'idcaso': idCaso, 'iduf': $scope.ufCaso[i].id, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                        'acristalado': 0, 'umuro': $scope.construcciones[constO].uc, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                } else if (orientacion[w] == "Suelo") {
                                    $http.post("insertarGeometria.php", {
                                        'idcaso': idCaso, 'iduf': $scope.ufCaso[i].id, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                        'acristalado': 0, 'umuro': $scope.construcciones[constO].us, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                } else {
                                    $http.post("insertarGeometria.php", {
                                        'idcaso': idCaso, 'iduf': $scope.ufCaso[i].id, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                        'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                        'acristalado': 15, 'umuro': $scope.construcciones[constO].um, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                        'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': 0, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                }
                            }
                        }
                        }
                        $http.post('geometria.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                            ADgeometria = data;
                            ADgeometria = data;
                        });
                        if (UFcalculadas == document.getElementById("tablaFuncional2").rows.length){
                        alert("Datos Guardados Correctamente");
                        numFun = 0;
                        UFcalculadas=2;
                        OcultarSpinner();
                        vaciarcontenido();
                        } else {
                            UFcalculadas++;
                        }
                    });
                } else {
                        if (consin == "si") {
                            for (var i = 0; i &lt; $scope.ufCaso.length; i++) {
                                superficie2 = parseFloat($scope.ufCaso[i].superficie);
                                if (numPlantas > 0) {
                                    superficie2 = superficie2 / numPlantas;
                                }
                                for (var w = 0; w &lt; orientacion.length; w++) {
                                    if (orientacion[w] == "Cubierta") {
                                        $http.post("insertarGeometria.php", {
                                            'idcaso': idCaso, 'iduf': $scope.ufCaso[i].id, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                            'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                            'acristalado': 0, 'umuro': $scope.construcciones[constO].uc, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                            'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                        }).success(function (data) {
                                            console.log(data);
                                        });
                                    } else if (orientacion[w] == "Suelo") {
                                        $http.post("insertarGeometria.php", {
                                            'idcaso': idCaso, 'iduf': $scope.ufCaso[i].id, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                            'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                            'acristalado': 0, 'umuro': $scope.construcciones[constO].us, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                            'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': superficie2, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                        }).success(function (data) {
                                            console.log(data);
                                        });
                                    } else {
                                        $http.post("insertarGeometria.php", {
                                            'idcaso': idCaso, 'iduf': $scope.ufCaso[i].id, 'descripcion': valido2, 'superficie': superficie, 'altura': altura,
                                            'multiplicador': 1, 'achequiv': 1, 'orientacion': orientacion[w],
                                            'acristalado': 15, 'umuro': $scope.construcciones[constO].um, 'uhueco': $scope.construcciones[constO].uv, 'ghueco': $scope.construcciones[constO].gv, 'fsinvierno': 1, 'fsverano': 0.5, 'fsconsombramovil': 0, 'ret': 0,
                                            'vold': 0, 'voll': 0, 'numOrden': 0, 'longitud': 0, 'nombreuf': 0, 'slatd': 0, 'slatl': 0, 'h1': 0, 'h2': 0, 'h3': 0, 'h4': 0, 'l1': 0, 'l2': 0, 'l3': 0, 'l4': 0,'base':1
                                        }).success(function (data) {
                                            console.log(data);
                                        });
                                    }
                                }
                            }
                        }
                        $http.post('geometria.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                            ADgeometria = data;
                            ADgeometria = data;
                        });
                        if (UFcalculadas == document.getElementById("tablaFuncional2").rows.length) {
                            alert("Datos Guardados Correctamente");
                            numFun = 0;
                            UFcalculadas = 2;
                            OcultarSpinner();
                            vaciarcontenido();
                        } else {
                            UFcalculadas++;
                        }
                }
                }
               
            }
           
           
        }
        
        /**

        *Cargamos las unidades funcionales o las genéricas

        * @param  {number}
        * @return  {void}

         */
        cargaTipoFuncional = function (origen) {
            var usuarioA = false;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            cargaFuncional();
           
            var select2 = document.getElementById("intervencion");
            valorIntervencion = "1";
            
            //Activamos o desactivamos los botones y la visualizamos
            if (valorIntervencion == "0") {
                document.getElementById("nuevaFuncional").disabled = true;
                document.getElementById("Ufbotones").style.display = "none";
            } else {
                document.getElementById("nuevaFuncional").disabled = false;
                document.getElementById("Ufbotones").style.display = "flex";
                document.getElementById("Ufbotones").style.display = "flex";
                
                    if ($scope.ufCaso.length == 0)
                        aniadirUnidad(1);
               
            }
            //Cargamos las tablas en función de la sección
            if (origen == 1) {
                if (valorIntervencion != "0") {
                    if (usuarioA == false)
                        document.getElementById("nuevaFuncionalG").disabled = false;
                }
                else {
                    if (usuarioA == false)
                        document.getElementById("nuevaFuncionalG").disabled = false;
                    document.getElementById("Ufbotones").style.display = "none";
                }
                if ($('#intervencion')[0].selectedIndex == 1) {
                    alert("Seleccione o cree una unidad funcional genérica");
                    if (tablaFuncional2.rows.length &lt; 2)
                        aniadirUnidad(1);
                }

                if ($('#intervencion')[0].selectedIndex == 2) {
                    alert("Seleccione las unidades funcionales del edificio");
                    if (tablaFuncional2.rows.length &lt; 2)
                        aniadirUnidad(1);
                }
            }
        }
        /**

        *Cargamos las comunidades, provincias y localidades

        * @param  {number}
        * @return  {void}

         */
        updateComunidad = function (origen) {
            vaciarcontenido();
            numFun = 0;
            $('#general').addClass("bordeAzul");
            $('#herramientas button').click(function () {
                $('#herramientas button').removeClass("bordeAzul");
                $(this).addClass("bordeAzul");
            });
            var usuarioA = false;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            document.getElementById("esquema").style.display = "none";
            document.getElementById("contenido").style.display = "initial";
            document.getElementById("menu").style = "background-color: none;display:none";
            document.getElementById("imagenes").style.display = "flex";
            MostrarSpinner();
            var borrado = true;
            //Cargamos la sección
            var menu = "";
            menu += "&lt;label style='display:flex'>Nombre del proyecto:&lt;/label>";
            menu += "&lt;div style='display: flex;flex-wrap: wrap;justify-content: space-between;margin-bottom: 20px;'> "
            menu += "&lt;div style='display:inline-block'>";
            menu += "&lt;span style=' display: flex;margin-bottom: 20px; '>" + nombreCaso + "&lt;/span>"
            menu += "&lt;/div>";         
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex; flex-wrap: wrap; justify-content: space-evenly; margin-bottom:20px;'>"
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Tipo de edificio: &lt;/span>";
            menu += "&lt;select style='width: auto;text-align: center; text-align-last: center;' onchange='cargaFuncional()'id='tipoEdificio'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            for (var x = 0; x &lt; $scope.edificio.length; x++) {
                menu += "&lt;option value='" + $scope.edificio[x].id + "'>" + $scope.edificio[x].nombre + "&lt;/option>";
            }
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Periodo Constructivo: &lt;/span>";
            menu += "&lt;select style='width: auto;text-align: center; text-align-last: center; display: flex;' id='periodoConstruccion'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>Anterior a 1900&lt;/option>";
            menu += "&lt;option value='2'>1900 - 1940&lt;/option>";
            menu += "&lt;option value='3'>1940 - 1960&lt;/option>";
            menu += "&lt;option value='4'>1960 - 1979&lt;/option>";
            menu += "&lt;option value='5'>1979 - 2006&lt;/option>";
            menu += "&lt;option value='6'>2006 - 2013&lt;/option>";
            menu += "&lt;option value='7'>Posterior a 2013&lt;/option>";
            menu += "&lt;/select>";           
            menu += "&lt;/div>";          
            menu += "&lt;div style='display:inline-block;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Zona climática:&lt;/span>";
            menu += "&lt;select style='width: auto;text-align: center;  text-align-last: center; display:flex' id='clima'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option style='display:none' value='1'>A1&lt;/option>";
            menu += "&lt;option style='display:none' value='2'>A2&lt;/option>";
            menu += "&lt;option value='3'>A3&lt;/option>";
            menu += "&lt;option value='4'>A4&lt;/option>";
            menu += "&lt;option style='display:none' value='5'>B1&lt;/option>";
            menu += "&lt;option style='display:none' value='6'>B2&lt;/option>";
            menu += "&lt;option value='7'>B3&lt;/option>";
            menu += "&lt;option value='8'>B4&lt;/option>";
            menu += "&lt;option value='9'>C1&lt;/option>";
            menu += "&lt;option value='10'>C2&lt;/option>";
            menu += "&lt;option value='11'>C3&lt;/option>";
            menu += "&lt;option value='12'>C4&lt;/option>";
            menu += "&lt;option value='13'>D1&lt;/option>";
            menu += "&lt;option value='14'>D2&lt;/option>";
            menu += "&lt;option value='15'>D3&lt;/option>";
            menu += "&lt;option style='display:none' value='16'>D4&lt;/option>";
            menu += "&lt;option value='17'>E1&lt;/option>";
            menu += "&lt;option style='display:none' value='18'>E2&lt;/option>";
            menu += "&lt;option style='display:none' value='19'>E3&lt;/option>";
            menu += "&lt;option style='display:none' value='20'>E4&lt;/option>";
            menu += "&lt;option value='21'>a1&lt;/option>";
            menu += "&lt;option value='22'>a2&lt;/option>";
            menu += "&lt;option value='23'>a3&lt;/option>";
            menu += "&lt;option value='24'>a4&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style = 'display: flex; flex-wrap: wrap; justify-content: space-evenly; margin-bottom:20px;' >"
            menu += "&lt;div style='display:inline-block;margin-right: 20px;margin-bottom:15px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Superficie construida:(m2)&lt;/span>";
            menu += "&lt;input maxlength='6' style='margin-right: 10px;transform:scale(1);text-align:center; '  type='text' id='superficie' value='0.00'>";
            menu += "&lt;/div>";
            if (usuarioA == true) {
                menu += "&lt;div style='display:inline-block;margin-right: 20px;margin-bottom:15px;'>";
                menu += "&lt;span style='justify-content: center;'>Construcción&lt;/br> simplificada:&lt;/span>";
                menu += "&lt;input  style='margin-right: 10px;transform:scale(1.3);text-align:center; margin-left: 5px'  type='checkbox' id='conSim' value='0.00'>";
                menu += "&lt;/div>";
            }
            menu += "&lt;div style='display:inline-block;margin-right: 20px;margin-bottom:15px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Altura total: (m)&lt;/span>";
            menu += "&lt;input maxlength='6' style='margin-right: 10px;transform:scale(1);text-align:center;'  type='text' id='altura' value='0.00'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-right: 20px;margin-bottom:15px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Plantas sobre rasante:&lt;/span>";
            menu += "&lt;input maxlength='6' style='margin-right: 10px;transform:scale(1);text-align:center; '  type='text' id='plantasSobre' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-right: 20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Plantas bajo rasante:&lt;/span>";
            menu += "&lt;input maxlength='6' style='margin-right: 10px;transform:scale(1);text-align:center;' type='text' id='plantasBajo' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style = 'display: flex; flex-wrap: wrap; justify-content: space-evenly; margin-bottom:20px;' >"
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;' >Comunidad Autónoma:&lt;/span>";
           
            menu += "&lt;select style='width: auto;text-align: center;text-align-last: center;display:flex;' id='comunidad' onchange='filtrarProvincias()' >&lt;/select>";
            
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Provincia:&lt;/span>";
            
            menu += "&lt;select style='width: auto;text-align: center;text-align-last: center; display:flex' id='provincia' onchange='filtrarLocalidades()'>&lt;/select>";
           
            menu += "&lt;/div>";
            
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Localidad:&lt;/span>";
         
            menu += "&lt;select id='localidad' style='width: auto;text-align: center; text-align-last: center; display:flex;' onchange='cargarClima()'>";
            menu += "&lt;/select>";
            
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Código postal:&lt;/span>";
            menu += "&lt;input style='transform:scale(1);text-align:center;' type='text' id='postal' maxlength='5' value='00000'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style = 'display: flex; flex-wrap: wrap; justify-content: space-evenly; margin-bottom:20px;' >"
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Tipo de vía:&lt;/span>";
           
            menu += "&lt;select style='width: auto;text-align: center; text-align-last: center;' id='via'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>Acceso&lt;/option>"
            menu += "&lt;option value='2'>Acequia&lt;/option>"
            menu += "&lt;option value='3'>Acera&lt;/option>"
            menu += "&lt;option value='4'>Alameda&lt;/option>"
            menu += "&lt;option value='5'>Aldea&lt;/option>"
            menu += "&lt;option value='6'>Alquería&lt;/option>"
            menu += "&lt;option value='7'>Alto&lt;/option>"
            menu += "&lt;option value='8'>Andador&lt;/option>"
            menu += "&lt;option value='9'>Angosta&lt;/option>"
            menu += "&lt;option value='10'>Apartamentos&lt;/option>"
            menu += "&lt;option value='11'>Apeadero&lt;/option>"
            menu += "&lt;option value='12'>Arboleda&lt;/option>"
            menu += "&lt;option value='13'>Arrabal&lt;/option>"
            menu += "&lt;option value='14'>Arroyo&lt;/option>"
            menu += "&lt;option value='15'>Autopista&lt;/option>"
            menu += "&lt;option value='16'>Autovía&lt;/option>"
            menu += "&lt;option value='17'>Avenida&lt;/option>"
            menu += "&lt;option value='18'>Bajada&lt;/option>"
            menu += "&lt;option value='19'>Balneario&lt;/option>"
            menu += "&lt;option value='20'>Barranco&lt;/option>"
            menu += "&lt;option value='21'>Barranquil&lt;/option>"
            menu += "&lt;option value='22'>Barreduela&lt;/option>"
            menu += "&lt;option value='23'>Barriada&lt;/option>"
            menu += "&lt;option value='24'>Barrio&lt;/option>"
            menu += "&lt;option value='25'>Baserría&lt;/option>"
            menu += "&lt;option value='26'>Belena&lt;/option>"
            menu += "&lt;option value='27'>Bloque&lt;/option>"
            menu += "&lt;option value='28'>Brazal&lt;/option>"
            menu += "&lt;option value='29'>Bulevar&lt;/option>"
            menu += "&lt;option value='30'>Calexon&lt;/option>"
            menu += "&lt;option value='31'>Caleya&lt;/option>"
            menu += "&lt;option value='32'>Caleyón&lt;/option>"
            menu += "&lt;option value='33'>Calle&lt;/option>"
            menu += "&lt;option value='34'>Calleja&lt;/option>"
            menu += "&lt;option value='35'>Callejón&lt;/option>"
            menu += "&lt;option value='36'>Callejuela&lt;/option>"
            menu += "&lt;option value='37'>Callizo&lt;/option>"
            menu += "&lt;option value='38'>Calzada&lt;/option>"
            menu += "&lt;option value='39'>Calzadas&lt;/option>"
            menu += "&lt;option value='40'>Camino&lt;/option>"
            menu += "&lt;option value='41'>Camping&lt;/option>"
            menu += "&lt;option value='42'>Campo&lt;/option>"
            menu += "&lt;option value='43'>Canal&lt;/option>"
            menu += "&lt;option value='44'>Canella&lt;/option>"
            menu += "&lt;option value='45'>Cantera&lt;/option>"
            menu += "&lt;option value='46'>Cantina&lt;/option>"
            menu += "&lt;option value='47'>Cantiño&lt;/option>"
            menu += "&lt;option value='48'>Cantón&lt;/option>"
            menu += "&lt;option value='49'>Cañada&lt;/option>"
            menu += "&lt;option value='50'>Carrera&lt;/option>"
            menu += "&lt;option value='51'>Carrerada&lt;/option>"
            menu += "&lt;option value='52'>Carrero&lt;/option>"
            menu += "&lt;option value='53'>Carretera&lt;/option>"
            menu += "&lt;option value='54'>Carreterín&lt;/option>"
            menu += "&lt;option value='55'>Carretil&lt;/option>"
            menu += "&lt;option value='56'>Carril&lt;/option>"
            menu += "&lt;option value='57'>Caserío&lt;/option>"
            menu += "&lt;option value='58'>Cerro&lt;/option>"
            menu += "&lt;option value='59'>Chalet&lt;/option>"
            menu += "&lt;option value='60'>Cinturón&lt;/option>"
            menu += "&lt;option value='61'>Circunvalación&lt;/option>"
            menu += "&lt;option value='62'>Camino hondo&lt;/option>"
            menu += "&lt;option value='63'>Camino nuevo&lt;/option>"
            menu += "&lt;option value='64'>Camino viejo&lt;/option>"
            menu += "&lt;option value='65'>Cobertizo&lt;/option>"
            menu += "&lt;option value='66'>Colonia&lt;/option>"
            menu += "&lt;option value='67'>Complejo&lt;/option>"
            menu += "&lt;option value='68'>Conjunto&lt;/option>"
            menu += "&lt;option value='69'>Convento&lt;/option>"
            menu += "&lt;option value='70'>Cooperativa&lt;/option>"
            menu += "&lt;option value='71'>Corral&lt;/option>"
            menu += "&lt;option value='72'>Corralillo&lt;/option>"
            menu += "&lt;option value='73'>Corredor&lt;/option>"
            menu += "&lt;option value='74'>Corrillo&lt;/option>"
            menu += "&lt;option value='75'>Cortijo&lt;/option>"
            menu += "&lt;option value='76'>Costa&lt;/option>"
            menu += "&lt;option value='77'>Costanilla&lt;/option>"
            menu += "&lt;option value='78'>Costera&lt;/option>"
            menu += "&lt;option value='79'>Cruceiro&lt;/option>"
            menu += "&lt;option value='80'>Cuadra&lt;/option>"
            menu += "&lt;option value='81'>Cuesta&lt;/option>"
            menu += "&lt;option value='82'>Cueva/s&lt;/option>"
            menu += "&lt;option value='83'>Dehesa&lt;/option>"
            menu += "&lt;option value='84'>Demarcación&lt;/option>"
            menu += "&lt;option value='85'>Diseminado&lt;/option>"
            menu += "&lt;option value='86'>Drecera&lt;/option>"
            menu += "&lt;option value='87'>Edificio/s&lt;/option>"
            menu += "&lt;option value='88'>Eirado&lt;/option>"
            menu += "&lt;option value='89'>Empresa&lt;/option>"
            menu += "&lt;option value='90'>Entrada&lt;/option>"
            menu += "&lt;option value='91'>Escalera&lt;/option>"
            menu += "&lt;option value='92'>Escalinata&lt;/option>"
            menu += "&lt;option value='93'>Espalda&lt;/option>"
            menu += "&lt;option value='94'>Espigo&lt;/option>"
            menu += "&lt;option value='95'>Estación&lt;/option>"
            menu += "&lt;option value='96'>Estrada&lt;/option>"
            menu += "&lt;option value='97'>Explanada&lt;/option>"
            menu += "&lt;option value='98'>Extramuros&lt;/option>"
            menu += "&lt;option value='99'>Extraradio&lt;/option>"
            menu += "&lt;option value='100'>Fábrica&lt;/option>"
            menu += "&lt;option value='101'>Falda&lt;/option>"
            menu += "&lt;option value='102'>Finca&lt;/option>"
            menu += "&lt;option value='103'>Galería&lt;/option>"
            menu += "&lt;option value='104'>Gallizo&lt;/option>"
            menu += "&lt;option value='105'>Glorieta&lt;/option>"
            menu += "&lt;option value='106'>Gran vía&lt;/option>"
            menu += "&lt;option value='107'>Granja&lt;/option>"
            menu += "&lt;option value='108'>Grupo&lt;/option>"
            menu += "&lt;option value='109'>Hegi&lt;/option>"
            menu += "&lt;option value='110'>Hipódromo&lt;/option>"
            menu += "&lt;option value='111'>Hoya&lt;/option>"
            menu += "&lt;option value='112'>Illa&lt;/option>"
            menu += "&lt;option value='113'>Inda&lt;/option>"
            menu += "&lt;option value='114'>Jardín&lt;/option>"
            menu += "&lt;option value='115'>Ladera&lt;/option>"
            menu += "&lt;option value='116'>Lago&lt;/option>"
            menu += "&lt;option value='117'>Llanura&lt;/option>"
            menu += "&lt;option value='118'>Loma&lt;/option>"
            menu += "&lt;option value='119'>Lomo&lt;/option>"
            menu += "&lt;option value='120'>Lugar&lt;/option>"
            menu += "&lt;option value='121'>Malecón&lt;/option>"
            menu += "&lt;option value='122'>Masía/s&lt;/option>"
            menu += "&lt;option value='123'>Mazo&lt;/option>"
            menu += "&lt;option value='124'>Mercado&lt;/option>"
            menu += "&lt;option value='125'>Mirador&lt;/option>"
            menu += "&lt;option value='126'>Monasterio&lt;/option>"
            menu += "&lt;option value='127'>Monte&lt;/option>"
            menu += "&lt;option value='128'>Muelle&lt;/option>"
            menu += "&lt;option value='129'>Nave/s&lt;/option>"
            menu += "&lt;option value='130'>Núcleo&lt;/option>"
            menu += "&lt;option value='131'>Nudo&lt;/option>"
            menu += "&lt;option value='132'>Pago&lt;/option>"
            menu += "&lt;option value='133'>Palacio&lt;/option>"
            menu += "&lt;option value='134'>Pantano&lt;/option>"
            menu += "&lt;option value='135'>Paraje&lt;/option>"
            menu += "&lt;option value='136'>Parque&lt;/option>"
            menu += "&lt;option value='137'>Particular&lt;/option>"
            menu += "&lt;option value='138'>Partida&lt;/option>"
            menu += "&lt;option value='139'>Pas&lt;/option>"
            menu += "&lt;option value='140'>Pasadizo&lt;/option>"
            menu += "&lt;option value='141'>Pasaje&lt;/option>"
            menu += "&lt;option value='142'>Paseo&lt;/option>"
            menu += "&lt;option value='143'>Paseo marítimo&lt;/option>"
            menu += "&lt;option value='144'>Pasillo&lt;/option>"
            menu += "&lt;option value='145'>Patio&lt;/option>"
            menu += "&lt;option value='146'>Pinar&lt;/option>"
            menu += "&lt;option value='147'>Pista&lt;/option>"
            menu += "&lt;option value='148'>Playa&lt;/option>"
            menu += "&lt;option value='149'>Plaza&lt;/option>"
            menu += "&lt;option value='150'>Plazoleta&lt;/option>"
            menu += "&lt;option value='151'>Poblado&lt;/option>"
            menu += "&lt;option value='152'>Polígono&lt;/option>"
            menu += "&lt;option value='153'>Portal&lt;/option>"
            menu += "&lt;option value='154'>Praciña&lt;/option>"
            menu += "&lt;option value='155'>Prolongación&lt;/option>"
            menu += "&lt;option value='156'>Puente&lt;/option>"
            menu += "&lt;option value='157'>Puerta&lt;/option>"
            menu += "&lt;option value='158'>Puerto&lt;/option>"
            menu += "&lt;option value='159'>Pujada&lt;/option>"
            menu += "&lt;option value='160'>Raconada&lt;/option>"
            menu += "&lt;option value='161'>Ramal&lt;/option>"
            menu += "&lt;option value='162'>Rambla&lt;/option>"
            menu += "&lt;option value='163'>Rampa&lt;/option>"
            menu += "&lt;option value='164'>Recanto&lt;/option>"
            menu += "&lt;option value='165'>Residencial&lt;/option>"
            menu += "&lt;option value='166'>Ribera&lt;/option>"
            menu += "&lt;option value='167'>Rincón&lt;/option>"
            menu += "&lt;option value='168'>Rinconada&lt;/option>"
            menu += "&lt;option value='169'>Ronda&lt;/option>"
            menu += "&lt;option value='170'>Rotonda&lt;/option>"
            menu += "&lt;option value='171'>Rueiro&lt;/option>"
            menu += "&lt;option value='172'>Sanatorio&lt;/option>"
            menu += "&lt;option value='173'>Santuario&lt;/option>"
            menu += "&lt;option value='174'>Sector&lt;/option>"
            menu += "&lt;option value='175'>Senda&lt;/option>"
            menu += "&lt;option value='176'>Sendera&lt;/option>"
            menu += "&lt;option value='177'>Sendero&lt;/option>"
            menu += "&lt;option value='178'>Subida&lt;/option>"
            menu += "&lt;option value='179'>Torrente&lt;/option>"
            menu += "&lt;option value='180'>Tránsito&lt;/option>"
            menu += "&lt;option value='181'>Transversal&lt;/option>"
            menu += "&lt;option value='182'>Trasera&lt;/option>"
            menu += "&lt;option value='183'>Traviesa&lt;/option>"
            menu += "&lt;option value='184'>Urbanización&lt;/option>"
            menu += "&lt;option value='185'>Valle&lt;/option>"
            menu += "&lt;option value='186'>Vecindario&lt;/option>"
            menu += "&lt;option value='187'>Vega&lt;/option>"
            menu += "&lt;option value='188'>Veinat&lt;/option>"
            menu += "&lt;option value='189'>Venela&lt;/option>"
            menu += "&lt;option value='190'>Vereda&lt;/option>"
            menu += "&lt;option value='191'>Vía&lt;/option>"
            menu += "&lt;option value='192'>Viaducto&lt;/option>"
            menu += "&lt;option value='193'>Vial&lt;/option>"
            menu += "&lt;option value='194'>Villa&lt;/option>"
            menu += "&lt;option value='195'>Vivienda/s&lt;/option>"
            menu += "&lt;option value='196'>Zona&lt;/option>"
            menu += "&lt;/select>";
            
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;''>Nombre vía:&lt;/span>";
            menu += "&lt;input  style='transform:scale(1);text-align:center;' size='20' type='text' id='nombreVia'>";
            
            menu += "&lt;/div>";

            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Número:&lt;/span>";
            menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' size='4' type='text' id='numero' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Bloque:&lt;/span>";
            menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' size='4' type='text' id='bloque' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style = 'display: flex; flex-wrap: wrap; justify-content: space-evenly; margin-bottom:20px;' >"
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Portal:&lt;/span>";
            menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' size='4' type='text' id='portal' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Escalera:&lt;/span>";
            menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' size='4' type='text' id='escalera' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;margin-bottom:20px;margin-right:20px;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Piso:&lt;/span>";
            menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' size='4' type='text' id='piso' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display:inline-block;'>";
            menu += "&lt;span style='display:flex;justify-content: center;'>Puerta:&lt;/span>";
            menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' size='4' type='text' id='puerta' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;label style='display:flex;margin-top: 25px;'>Unidades funcionales y usos&lt;/label>";
            menu += "&lt;div style='width:100%' id='tablaFuncional'>";
            menu += "&lt;/div>";
            if (usuarioA == true) {
                menu += "&lt;div style='display:flex; flex-direction:column;'>";
                menu += "&lt;label style='display:flex;margin-top: 25px;justify-content: center'>Ventilación, Temperaturas de consigna, Periodos de verano e invierno y ventilación nocturna durante los meses de verano&lt;/label>";
                menu += "&lt;div style='display: flex;flex-wrap: wrap;justify-content: space-around;    border: solid 1px darkgray;    flex-flow: nowrap;'>";
                menu += "&lt;div style='display: inline-block;    margin: 10px;'>";
                menu += "&lt;div style='flex-direction: column;display: flex;flex-wrap: wrap;justify-content: space-evenly;'>";
                menu += "&lt;div style='display: inline-block;margin-bottom: 20px;'>";
                menu += "&lt;span style='display: flex;'>Temperatura de consigna alta(ºC)&lt;/span>";
                menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' type='text' id='tempAlta' value='26.00'>";
                menu += "&lt;/div>";
                menu += "&lt;div style='display: inline-block;margin-bottom: 20px;'>";
                menu += "&lt;span style='display: flex;'>Temperatura de consigna baja(ºC)&lt;/span>";
                menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' type='text' id='tempBaja' value='20.00'>";
                menu += "&lt;/div>";
                menu += "&lt;div style='display: inline-block;'>";
                menu += "&lt;input  style='margin-right: 10px;transform:scale(1);text-align:center;'  type='checkbox' id='impedircalefaccion'>";
                menu += "&lt;span>Impedir que se proporcione calefacción en periodo de &lt;/br> aplicación de sombras móviles y refrigeración en el de no aplicación&lt;/span>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;div style='display: inline-block;    margin: 10px;'>";
                menu += "&lt;div style='flex-direction: column;display: flex;flex-wrap: wrap;justify-content: space-evenly;'>";
                menu += "&lt;div style='display: inline-block;margin-bottom: 27px;'>";
                menu += "&lt;span style='display: flex;'>Mes inicial de aplicación de sombras y ventilación nocturna&lt;/span>";
                menu += "&lt;select style='width: auto;text-align: center; text-align-last: center;' id='mesI'>";
                menu += "&lt;option value='0' hidden '> - Selecciona -&lt;/option>";
                menu += "&lt;option value='1'>Enero&lt;/option>";
                menu += "&lt;option value='2'>Febrero&lt;/option>";
                menu += "&lt;option value='3'>Marzo&lt;/option>";
                menu += "&lt;option value='4'>Abril&lt;/option>";
                menu += "&lt;option value='5'>Mayo&lt;/option>";
                menu += "&lt;option value='6' selected >Junio&lt;/option>";
                menu += "&lt;option value='7'>Julio&lt;/option>";
                menu += "&lt;option value='8'>Agosto&lt;/option>";
                menu += "&lt;option value='9'>Septiembre&lt;/option>";
                menu += "&lt;option value='10'>Octubre&lt;/option>";
                menu += "&lt;option value='11'>Noviembre&lt;/option>";
                menu += "&lt;option value='12'>Diciembre&lt;/option>";
                menu += "&lt;/select>";
                menu += "&lt;/div>";
                menu += "&lt;div style='display: inline-block;margin-bottom: 27px;'>";
                menu += "&lt;span style='display: flex;'>Mes Final de aplicación de sombras y ventilación nocturna&lt;/span>\n";
                menu += "&lt;select style='width: auto;text-align: center; text-align-last: center;' id='mesF'>";
                menu += "&lt;option value='0' hidden '> - Selecciona -&lt;/option>";
                menu += "&lt;option value='1'>Enero&lt;/option>";
                menu += "&lt;option value='2'>Febrero&lt;/option>";
                menu += "&lt;option value='3'>Marzo&lt;/option>";
                menu += "&lt;option value='4'>Abril&lt;/option>";
                menu += "&lt;option value='5'>Mayo&lt;/option>";
                menu += "&lt;option value='6'>Junio&lt;/option>";
                menu += "&lt;option value='7'>Julio&lt;/option>";
                menu += "&lt;option value='8'>Agosto&lt;/option>";
                menu += "&lt;option value='9' selected >Septiembre&lt;/option>";
                menu += "&lt;option value='10'>Octubre&lt;/option>";
                menu += "&lt;option value='11'>Noviembre&lt;/option>";
                menu += "&lt;option value='12'>Diciembre&lt;/option>";
                menu += "&lt;/select>";
                menu += "&lt;/div>";
                menu += "&lt;div style='display: inline-block'>";
                menu += "&lt;span style='display: flex;'>Ventilación nocturna en el régimen de verano (1/h)&lt;/span>\n";
                menu += "&lt;input maxlength='6' style='transform:scale(1);text-align:center;' type='text' id='venNoc' value='4.00'>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
            }
            menu += "&lt;button class='btnMenu' style=' background-color: orange;    margin-top: 20px;' id='botonDatos' onClick='cargarDatosCasos()'>Aceptar&lt;/button>";
            OcultarSpinner();
            
            document.getElementById("contenido").innerHTML = menu;
            tipoEdificio.options[tipoEdificio.options.length-1].style.display = "none";
            if (document.getElementById('tipoEdificio').options[document.getElementById('tipoEdificio').selectedIndex].value == "0")
                document.getElementById("botonDatos").style.display = "none";
            else
                document.getElementById("botonDatos").style.display = "initial";
            document.getElementById("menu").width = "100%";
            document.getElementById("esquema2").innerHTML = "";
            document.getElementById("menu").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("esquema").style.left = document.getElementById("esquema").style.left - 500;
            var select = "";
            //Cargamos los datos de la sección en caso de que hubiera en la base de datos
            select += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
            for (var x = 0; x &lt; $scope.comunidad.length; x++) {
                select += "&lt;option value='" + $scope.comunidad[x].id + "'>" + $scope.comunidad[x].nombre + "&lt;/option>\n";
            }
            document.getElementById("comunidad").innerHTML = select;
            select = "";
            select += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
            for (var x = 0; x &lt; $scope.provincia.length; x++) {
                select += "&lt;option value='" + $scope.provincia[x].id + "'>" + $scope.provincia[x].nombre + "&lt;/option>\n";
            }
            document.getElementById("provincia").innerHTML = select;
            select = "";
            select += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
            for (var x = 0; x &lt; $scope.localidad.length; x++) {
                select += "&lt;option value='" + $scope.localidad[x].id + "'>" + $scope.localidad[x].nombre + "&lt;/option>\n";
            }
            document.getElementById("localidad").innerHTML = select;
            if (nombreCaso != "") {
                if (origen == 1) {
                    for (var x = 0; x &lt; $scope.caso.length; x++) {
                        if ($scope.caso[x].nombre == nombreCaso &amp;&amp; $scope.caso[x].idusuario == usuario) {
                            document.getElementById("superficie").value = $scope.caso[x].superficie;
                            document.getElementById("altura").value = $scope.caso[x].altura;
                            document.getElementById("plantasSobre").value = $scope.caso[x].plantassobre;
                            document.getElementById("plantasBajo").value = $scope.caso[x].plantasbajo;
                            for (var y = 0; y &lt; $scope.comunidad.length; y++) {
                                if ($scope.caso[x].comunidad == $scope.comunidad[y].nombre) {
                                    document.getElementById("comunidad").value = $scope.comunidad[y].id;
                                    filtrarProvincias();
                                    break;
                                }
                            }
                            for (var y = 0; y &lt; $scope.provincia.length; y++) {
                                if ($scope.caso[x].provincia == $scope.provincia[y].nombre) {
                                    document.getElementById("provincia").value = $scope.provincia[y].id;
                                    filtrarLocalidades();
                                    break;
                                }
                            }
                            for (var y = 0; y &lt; $scope.localidad.length; y++) {
                                if ($scope.caso[x].localidad == $scope.localidad[y].nombre) {
                                    document.getElementById("localidad").value = $scope.localidad[y].id;
                                    break;
                                }
                            }
                            for (var y = 0; y &lt; document.getElementById("periodoConstruccion").length; y++) {
                                if ($scope.caso[x].periodo == document.getElementById("periodoConstruccion").options[y].innerHTML) {
                                    document.getElementById("periodoConstruccion").value = document.getElementById("periodoConstruccion").options[y].value;
                                    break;
                                }
                            }
                            
                            if (usuarioA == true) {
                                if ($scope.caso[x].consim == "si") {
                                    document.getElementById('conSim').checked = true;
                                } else {
                                    document.getElementById('conSim').checked = false;
                                }
                                if ($scope.caso[x].impedircalefaccion == "si") {
                                    document.getElementById('impedircalefaccion').checked = true;
                                } else {
                                    document.getElementById('impedircalefaccion').checked = false;
                                }
                                if ($scope.caso[x].tempalta != 0) {
                                    document.getElementById('tempAlta').value = $scope.caso[x].tempalta;
                                }
                                if ($scope.caso[x].tempbaja != 0) {
                                    document.getElementById('tempBaja').value = $scope.caso[x].tempbaja;
                                }
                                if ($scope.caso[x].vennocturna != 0) {
                                    document.getElementById('venNoc').value = $scope.caso[x].vennocturna;
                                }
                                document.getElementById("mesI").value = $scope.caso[x].mesinicial;
                                document.getElementById("mesF").value = $scope.caso[x].mesfinal;
                            }
                            for (var y = 0; y &lt; document.getElementById("clima").length; y++) {
                                if ($scope.caso[x].clima == document.getElementById("clima").options[y].innerHTML) {
                                    document.getElementById("clima").value = document.getElementById("clima").options[y].value;
                                    break;
                                }
                            }
                            for (var y = 0; y &lt; document.getElementById("via").length; y++) {
                                if ($scope.caso[x].via == document.getElementById("via").options[y].innerHTML) {
                                    document.getElementById("via").value = document.getElementById("via").options[y].value;
                                    break;
                                }
                            }
                            //Cargamos los datos de las uf si los hubiera.
                            for (var y = 0; y &lt; $scope.edificio.length; y++) {
                                if ($scope.caso[x].idedificio == $scope.edificio[y].id) {
                                    document.getElementById("tipoEdificio").value = $scope.edificio[y].id;
                                    cargaTipoFuncional(2)
                                    for (var z = 0; z &lt; $scope.ufCaso.length; z++) {
                                        if ($scope.ufCaso[z].idcaso == idCaso) {
                                            if (usuarioA == true) {
                                                borrado = false;
                                            }
                                            for (var i = 0; i &lt; $scope.genericas.length; i++) {
                                                if ($scope.ufCaso[z].nombre == $scope.genericas[i].nombre) {
                                                    borrado = false;
                                                }
                                            }
                                            if (borrado == false) {
                                                aniadirUnidad(1);
                                                document.getElementById("tablaFuncional2").rows[document.getElementById("tablaFuncional2").rows.length - 1].cells[0].innerHTML = $scope.ufCaso[z].nombreusuario;
                                                document.getElementById("tablaFuncional2").rows[document.getElementById("tablaFuncional2").rows.length - 1].cells[2].innerHTML = $scope.ufCaso[z].superficie;
                                                var ufgenerica = false;
                                                for (var i = 0; i &lt; $scope.genericas.length; i++) {
                                                    if ($scope.ufCaso[z].id == $scope.genericas[i].id_ufg) {
                                                        ufgenerica = true;
                                                    }
                                                }
                                                if (ufgenerica == false) {
                                                    document.getElementById("selFun" + (numFun - 1)).value = $scope.ufCaso[z].iduf;
                                                } else {
                                                    document.getElementById("selFun" + (numFun - 1)).value = $scope.ufCaso[z].nombre;
                                                }
                                                if ($scope.ufCaso[z].calefaccion == "1") {
                                                    document.getElementById("calFun" + (numFun - 1)).checked = true;
                                                }
                                                if ($scope.ufCaso[z].refrigeracion == "1") {
                                                    document.getElementById("refFun" + (numFun - 1)).checked = true;
                                                }
                                                if ($scope.ufCaso[z].acs == "1") {
                                                    document.getElementById("acsFun" + (numFun - 1)).checked = true;
                                                }
                                                if ($scope.ufCaso[z].piscina == "1") {
                                                    document.getElementById("pisFun" + (numFun - 1)).checked = true;
                                                }
                                                if ($scope.ufCaso[z].iluminacion == "1") {
                                                    document.getElementById("iluFun" + (numFun - 1)).checked = true;
                                                }
                                                if ($scope.ufCaso[z].otros == "1" || $scope.ufCaso[z].cocina == "1" || $scope.ufCaso[z].fuerza == "1") {
                                                    document.getElementById("otrFun" + (numFun - 1)).checked = true;
                                                }
                                            } else {
                                                $http.post("borrarUnidadesFuncionalesCaso.php", { 'idcaso': idCaso,'base':1 })
                                                    .success(function (data) {
                                                        console.log(data);
                                                        $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                                            $scope.ufCaso = data;
                                                            ADufcaso = data;
                                                        });
                                                    });
                                                $http.post("borrarGeometria.php", { 'idcaso': idCaso, 'iduf': $scope.ufCaso[z].iduf,'base':1 }).success(function (data) {
                                                    console.log(data);
                                                    $http.post('geometria.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                                                        ADgeometria = data;
                                                        ADgeometria = data;
                                                    });
                                                });
                                                alert("Su unidad funcional genérica fue borrada");
                                                OcultarSpinner();
                                            }
                                        }
                                    }
                                    break;
                                }
                            }
                            
                            document.getElementById("postal").value = $scope.caso[x].postal;
                            document.getElementById("nombreVia").value = $scope.caso[x].nombrevia;
                            document.getElementById("numero").value = $scope.caso[x].numero;
                            document.getElementById("portal").value = $scope.caso[x].portal;
                            document.getElementById("escalera").value = $scope.caso[x].escalera;
                            document.getElementById("piso").value = $scope.caso[x].piso;
                            document.getElementById("puerta").value = $scope.caso[x].puerta;
                            document.getElementById("bloque").value = $scope.caso[x].bloque;
                            datosCasos[0] = nombreCaso;
                            datosCasos[1] = $scope.caso[x].usoedificio;
                            datosCasos[2] = $scope.caso[x].superficie;
                            datosCasos[3] = $scope.caso[x].altura;
                            datosCasos[4] = $scope.caso[x].plantassobre;
                            datosCasos[5] = $scope.caso[x].plantasbajo;
                            datosCasos[6] = $scope.caso[x].comunidad;
                            datosCasos[7] = $scope.caso[x].provincia;
                            datosCasos[8] = $scope.caso[x].localidad;
                            datosCasos[9] = $scope.caso[x].postal;
                            datosCasos[10] = $scope.caso[x].via;
                            datosCasos[11] = $scope.caso[x].nombrevia;
                            datosCasos[12] = $scope.caso[x].numero;
                            datosCasos[13] = $scope.caso[x].portal;
                            datosCasos[14] = $scope.caso[x].escalera;
                            datosCasos[15] = $scope.caso[x].piso;
                            datosCasos[16] = $scope.caso[x].puerta;
                            datosCasos[17] = $scope.caso[x].bloque;
                            datosCasos[18] = $scope.caso[x].periodo;
                            datosCasos[19] = $scope.caso[x].nivel;
                            datosCasos[20] = $scope.caso[x].clima;
                            datosCasos[21] = $scope.caso[x].consim;
                            if ($scope.caso[x].solove == "si") {
                                soloVE = "si";
                            }
                            else {
                                soloVE = "no";
                            }

                            if (usuarioA == true) {
                                datosCasos[22] = tempAlta.value;
                                datosCasos[23] = tempBaja.value;
                                datosCasos[24] = mesI.value;
                                datosCasos[25] = mesF.value;
                                datosCasos[26] = impedircalefaccion.che;
                                datosCasos[27] = venNoc.value;
                            }
                        }
                    }
                    //En caso de estar en la sección de genéricas cargamos los datos previamente rellenados
                } else if (origen == 2) {
                    numFun = 0;
                    document.getElementById("tipoEdificio").value = datosCasos[1];
                    document.getElementById("superficie").value = datosCasos[2];
                    document.getElementById("altura").value = datosCasos[3];
                    document.getElementById("plantasSobre").value = datosCasos[4];
                    document.getElementById("plantasBajo").value = datosCasos[5];
                    document.getElementById("comunidad").value = datosCasos[6];
                    filtrarProvincias();
                    document.getElementById("provincia").value = datosCasos[7];
                    filtrarLocalidades();
                    document.getElementById("localidad").value = datosCasos[8];
                    document.getElementById("postal").value = datosCasos[9];
                    document.getElementById("via").value = datosCasos[10];
                    document.getElementById("nombreVia").value = datosCasos[11];
                    document.getElementById("numero").value = datosCasos[12];
                    document.getElementById("portal").value = datosCasos[13];
                    document.getElementById("escalera").value = datosCasos[14];
                    document.getElementById("piso").value = datosCasos[15];
                    document.getElementById("puerta").value = datosCasos[16];
                    document.getElementById("bloque").value = datosCasos[17];
                    document.getElementById("periodoConstruccion").value = datosCasos[18];
                    document.getElementById("clima").value = datosCasos[20];
                    
                    if (usuarioA == true) {
                        if (datosCasos[21] == "si") {
                            document.getElementById('conSim').checked = true;
                        } else {
                            document.getElementById('conSim').checked = false;
                        }
                        document.getElementById('tempAlta').value = datosCasos[22];
                        document.getElementById('tempBaja').value = datosCasos[23];
                        document.getElementById('venNoc').value = datosCasos[27];
                        document.getElementById("mesI").value = datosCasos[24];
                        document.getElementById("mesF").value = datosCasos[25];
                        if (datosCasos[26] == "si") {
                            document.getElementById('impedircalefaccion').checked = true;
                        } else {
                            document.getElementById('impedircalefaccion').checked = false;
                        }
                    }
                    if (document.getElementById("tipoEdificio").value > 0) {
                        cargaTipoFuncional(2);
                        var uf = 0;
                        for (var z = 0; z &lt; $scope.ufCaso.length; z++) {
                            if ($scope.ufCaso[z].idcaso == idCaso) {
                                for (var i = 0; i &lt; $scope.genericas.length; i++) {
                                    if ($scope.ufCaso[z].nombre == $scope.genericas[i].nombre) {
                                        borrado = false;
                                        uf = z;
                                    }
                                }
                                if (borrado == false) {
                                    aniadirUnidad(1);
                                    document.getElementById("tablaFuncional2").rows[document.getElementById("tablaFuncional2").rows.length - 1].cells[0].innerHTML = $scope.ufCaso[uf].nombreusuario;
                                    document.getElementById("tablaFuncional2").rows[document.getElementById("tablaFuncional2").rows.length - 1].cells[2].innerHTML = $scope.ufCaso[z].superficie;
                                    if ($scope.ufCaso[uf].calefaccion == "1") {
                                        document.getElementById("calFun" + (numFun - 1)).checked = true;
                                    }
                                    if ($scope.ufCaso[uf].refrigeracion == "1") {
                                        document.getElementById("refFun" + (numFun - 1)).checked = true;
                                    }
                                    if ($scope.ufCaso[uf].acs == "1") {
                                        document.getElementById("acsFun" + (numFun - 1)).checked = true;
                                    }
                                    if ($scope.ufCaso[uf].piscina == "1") {
                                        document.getElementById("pisFun" + (numFun - 1)).checked = true;
                                    }
                                    if ($scope.ufCaso[uf].iluminacion == "1") {
                                        document.getElementById("iluFun" + (numFun - 1)).checked = true;
                                    }
                                    if ($scope.ufCaso[uf].otros == "1" || $scope.ufCaso[uf].cocina == "1" || $scope.ufCaso[uf].fuerza == "1") {
                                        document.getElementById("otrFun" + (numFun - 1)).checked = true;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            $('#tipoEdificio').change(function () {
                if (tablaFuncional2.rows.length &lt; 2)
                    aniadirUnidad(1);
            })
            OcultarSpinner();
        }
        /**

        *Adaptamos el nombre de la provincia

        * @return  {void}

         */
        capitalprovincia = function (casoProvincia) {
            switch (casoProvincia) {
                case "Álava":
                    casoProvincia = "Vitoria";
                    break;
                case "Ciudad Real":
                    casoProvincia = "Ciudad_Real";
                    break;
                case "Asturias":
                    casoProvincia = "Oviedo";
                    break;
                case "Cantabria":
                    casoProvincia = "Santander";
                    break;
                case "Coruña, A":
                    casoProvincia = "La_Coruna";
                    break;
                case "Castellón de la Plana/Castelló de la Plana":
                    casoProvincia = "Castellon";
                    break;
                case "Girona":
                    casoProvincia = "Gerona";
                    break;
                case "Guipúzcoa":
                    casoProvincia = "S_sebast";
                    break;
                case "Islas Baleares":
                    casoProvincia = "Palma";
                    break;
                case "Navarra":
                    casoProvincia = "Pamplona";
                    break;
                case "Ourense":
                    casoProvincia = "Orense";
                    break;
                case "Gran Canaria":
                    casoProvincia = "Las_palma";
                    break;
                case "La Rioja":
                    casoProvincia = "Logrono";
                    break;
                case "Vizcaya":
                    casoProvincia = "Bilbao";
                    break;
                case "Tarragona":
                    casoProvincia = "Tortosa";
                    break;
            }
            casoProvincia = casoProvincia.normalize('NFD').replace(/[\u0300-\u036f]/g, "") // QUITAR ACENTOS
            return casoProvincia;
        }
        /**

        *Adaptamos las secciones al definir solamente el vehículo eléctrico

        * @return  {void}

         */
        selectorsolove = function () {
            var oEvento = event || window.event;
            var oTarget = oEvento.target;
            if ($(oTarget).is(':checked')) {
                soloVE = "si";
                menudisabled(3);
            } else {
                soloVE = "no";
                menudisabled(1)
                // contador.disabled = false;
                // contador.style.color = "black";
                // referencia.disabled = false;
                // referencia.style.color = "black";
                // geoycon.disabled = false;
                // geoycon.style.color = "black";
                // operacional.disabled = false;
                // operacional.style.color = "black";
                // piscina.disabled = false;
                // piscina.style.color = "black";
                // nuevas.disabled = false;
                // nuevas.style.color = "black";
                // alternativas.disabled = false;
                // alternativas.style.color = "black";
                // optimizacion.disabled = false;
                // optimizacion.style.color = "black";
            }

        }
        /**

        *Cargamos las unidades funcionales de un edificio

        * @return  {void}

         */
        cargaFuncional = function () {
            var select = document.getElementById('tipoEdificio');
            valido = select.options[select.selectedIndex].value;
            valido2 = "1";
            //Cargamos la sección
            var menu = "";
            menu += "&lt;div class='table-responsive'>";
            menu += "&lt;table style='width:100%;' class='table' id='tablaFuncional2'>";
            menu += "&lt;tr>";
            menu += "&lt;th style= 'text-align:center;font-size:75%;vertical-align:middle;' > Nombre &lt;/th >";
            menu += "&lt;th style= 'text-align:center;font-size:75%;vertical-align:middle;' > Tipo &lt;/th >";
            menu += "&lt;th style= 'text-align:center;font-size: 75%;vertical-align:middle;'> Superficie(m2) &lt;/th >";
            menu += "&lt;th style= 'text-align:center;font-size: 75%;vertical-align:middle;'> Calefacción &lt;/th >";
            menu += "&lt;th style= 'text-align:center;font-size: 75%;vertical-align:middle;'> Refrigeración &lt;/th >";
            menu += "&lt;th style='text-align:center;font-size: 75%;vertical-align:middle;'> ACS &lt;/th>";
            menu += "&lt;th style='text-align:center;font-size: 75%;vertical-align:middle;'> Piscinas &lt;/th>";
            menu += "&lt;th style='text-align:center;vertical-align:middle;font-size: 75%;'> Iluminación &lt;/th>";
            menu += "&lt;th style='text-align:center;vertical-align:middle;font-size:75%;'> Otros &lt;/th>";
            menu += "&lt;/tr>";
            menu += "&lt;/table>";
            menu += "&lt;/div>";
            menu += "&lt;div id='Ufbotones' style='display:none;flex-wrap: wrap; margin-bottom: 20px;'>"
            menu += "&lt;div style='display:inline-block;'>";
            menu += "&lt;button class='btnMenu' id='nuevaFuncional' style='background-color:orangered;margin-bottom:15px;margin-right:10px' onclick='aniadirUnidad(1)' disabled> Añadir Unidad&lt;/button>";
            menu += "&lt;/div>";
            if (valido2 != "2") {
                menu += "&lt;div style='display:inline-block;'>";
                menu += "&lt;button class='btnMenu' id='nuevaFuncionalG' onclick='aniadirUnidadGenerica()' disabled> Definición/modificación Unidad Funcional Genérica&lt;/button>\n";
                menu += "&lt;/div>"
                menu += "&lt;/div>"
            }
            //Activamos o desactivamos elementos
            document.getElementById("tablaFuncional").innerHTML = menu;
            if (valido == "0") {
                document.getElementById("Ufbotones").style.display = "none";
                document.getElementById("nuevaFuncional").disabled = true;
                document.getElementById("tablaFuncional").style.display = "none";
                document.getElementById("botonDatos").style.display = "none";
            } else {
                document.getElementById("tablaFuncional").style.display = "initial";
                if (valido2 != "0") {
                    document.getElementById("nuevaFuncional").disabled = false;
                    document.getElementById("Ufbotones").style.display = "flex";
                    document.getElementById("botonDatos").style.display = "initial";
                }
            }
            valorIntervencion = "1";
            if (valorIntervencion == "1") {
                document.getElementById("nuevaFuncionalG").disabled = false;
            }
        }
        /**

        *Creamos una nueva unidad funcional

        * @return  {void}

         */
        aniadirUnidadGenerica = function () {
            var usuarioA = false;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            document.getElementById("esquema2").style = $(document.getElementById("body")).width().style = 'margin-left:22%; margin-right:10%;';
            numFun = 0;
            var genericas = 0;
            var select = document.getElementById("tipoEdificio");
            valido = select.options[select.selectedIndex].text;
            var UFedificio = select.options[select.selectedIndex].value;
            //Almacenamos los valores de todos los elementos de la sección de datos generales
            if (UFedificio > 0) {
                datosCasos[1] = document.getElementById("tipoEdificio").value;
                datosCasos[2] = document.getElementById("superficie").value;
                datosCasos[3] = document.getElementById("altura").value;
                datosCasos[4] = document.getElementById("plantasSobre").value;
                datosCasos[5] = document.getElementById("plantasBajo").value;
                if (document.getElementById("comunidad").value > 0) {
                    datosCasos[6] = $scope.comunidad[(document.getElementById("comunidad").value - 1)].id;
                } else {
                    datosCasos[6] = 0;
                }
                if (document.getElementById("provincia").value > 0) {
                    datosCasos[7] = $scope.provincia[(document.getElementById("provincia").value - 1)].id;
                } else {
                    datosCasos[7] = 0;
                }
                if (document.getElementById("localidad").value > 0) {
                    datosCasos[8] = $scope.localidad[(document.getElementById("localidad").value - 1)].id;
                } else {
                    datosCasos[8] = 0;
                }
                datosCasos[9] = document.getElementById("postal").value;
                datosCasos[10] = document.getElementById("via").value;
                datosCasos[11] = document.getElementById("nombreVia").value;
                datosCasos[12] = document.getElementById("numero").value;
                datosCasos[13] = document.getElementById("portal").value;
                datosCasos[14] = document.getElementById("escalera").value;
                datosCasos[15] = document.getElementById("piso").value;
                datosCasos[16] = document.getElementById("puerta").value;
                datosCasos[17] = document.getElementById("bloque").value;
                if (document.getElementById("periodoConstruccion").value > 0) {
                    periodo = document.getElementById("periodoConstruccion").value;
                    datosCasos[18] = document.getElementById("periodoConstruccion").options[periodo].value;
                } else {
                    datosCasos[18] = 0;
                }
                
                    intervencion = "1";
                    datosCasos[19] = "Nivel 0";
               
                if (document.getElementById("clima").value > 0) {
                    clima = document.getElementById("clima").value;
                    datosCasos[20] = document.getElementById("clima").options[clima].value;
                } else {
                    datosCasos[20] = 0;
                }
                datosCasos[21] = "si";
                //Amacenamos los valores de la sección si es usuario avanzado
                if (usuarioA == true) {
                    if (document.getElementById('conSim').checked == false) {
                        datosCasos[21] = "no";
                    }

                    datosCasos[22] = tempAlta.value;
                    datosCasos[23] = tempBaja.value;
                    datosCasos[24] = mesI.value;
                    datosCasos[25] = mesF.value;
                    datosCasos[26] = impedircalefaccion.checked;
                    datosCasos[27] = venNoc.value;
                    if (document.getElementById("impedircalefaccion").checked == true) {
                        datosCasos[26] = "si";
                    } else {
                        datosCasos[26] = "no";
                    }
                    if (document.getElementById('conSim').checked == false) {
                        datosCasos[21] = "no";
                    }
                    //Si no los almacena a 0
                } else {
                    datosCasos[22] = 0;
                    datosCasos[23] = 0;
                    datosCasos[24] = 0;
                    datosCasos[25] = 0;
                    datosCasos[26] = 0;
                    datosCasos[27] = 0;
                }
                //Cargamos la sección
                var menu = "";
                menu += "&lt;label style='display:flex'>Tipo de Edificio: &lt;/label>";
                menu += "&lt;p id='edificioGenerico'>" + valido + "&lt;/p>\n";
                /*
                menu += "&lt;select onchange='elegirGenerica(" + UFedificio + ")'style='width: 265px;' id='UFGenericas'>\n";
                menu += "&lt;option value= '0' selected= 'selected' > - seleccionar genérica -&lt;/option>\n";
                for (var x = 0; x &lt; $scope.genericas.length; x++) {
                    if ($scope.genericas[x].id_edificio == UFedificio) {
                        menu += "&lt;option value='" + $scope.genericas[x].id_ufg + "'>" + $scope.genericas[x].nombre + "&lt;/option>\n";
                    }
                }
                menu += "&lt;/select>";
                */
                menu += " &lt;div class='input-group' style='display: flex;flex-wrap: wrap-reverse;' >"
                menu += "&lt;div style='display:inline-block;margin-bottom:20px;'>";
                menu += " &lt;input type='text' id='nombreNuevaGenerica' style='transform: scale(1);  class='form-control' aria-label='Text input with segmented dropdown button' >";
                menu += "&lt;/div>";
                menu += " &lt;div class='input-group-prepend' style='display:inline;'>";
                menu += "&lt;button  style='transform: scale(1); margin-left:10px;margin-bottom:20px;'class='btnMenu'' onclick='crearGenericaVacia(" + UFedificio + ")'> Crear genérica&lt;/button>\n";
                menu += "    &lt;button style='transform: scale(1);margin-left:10px;margin-bottom:20px;' class='btnMenu' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                menu += "      Seleccionar&lt;/button>";
                menu += "&lt;button style='transform: scale(1);background-color:orangered;margin-left:9px;margin-bottom:20px;' id='eliGen' class='btnMenu' onclick='borrarGenerica()' disabled>Eliminar&lt;/button>\n";
                menu += "   &lt;div class='dropdown-menu' style='margin-top:-20px;'>";
                for (var x = 0; x &lt; $scope.genericas.length; x++) {
                    if ($scope.genericas[x].id_edificio == UFedificio &amp;&amp; $scope.genericas[x].idusuario == usuario) {
                        menu += "&lt;a href='#'>&lt;option class='hover' value='" + x + "' id='generica" + $scope.genericas[x].nombre + "' onclick='elegirGenerica(" + UFedificio + "," + $scope.genericas[x].id_ufg + ")'>" + $scope.genericas[x].nombre + "&lt;/option>&lt;/a>";
                        genericas++;
                    }
                }
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;/div>";
                menu += "&lt;div class='table-responsive'>";
                menu += "&lt;table id='TablaUFGenericas' class='table' style='border-collapse:separate'>";
                menu += "&lt;tr>";
                menu += "&lt;th style= 'text-align:center;font-size:75%;vertical-align:middle;' > Nombre &lt;/th >";
                menu += "&lt;th style= 'text-align:center;font-size:75%;vertical-align:middle;' > Tipo &lt;/th >";
                menu += "&lt;th style= 'text-align:center;font-size: 75%;vertical-align:middle;'> Porcentaje&lt;/th >";
                menu += "&lt;th style= 'text-align:center;font-size: 75%;vertical-align:middle;'> Calefacción&lt;/th >";
                menu += "&lt;th style= 'text-align:center;font-size: 75%;vertical-align:middle;'> Refrigeración&lt;/th >";
                menu += "&lt;th style='text-align:center;font-size: 75%;vertical-align:middle;'>ACS&lt;/th>";
                menu += "&lt;th style='text-align:center;font-size: 75%;vertical-align:middle;'>Piscinas&lt;/th>";
                menu += "&lt;th style='text-align:center;vertical-align:middle;font-size: 75%;'>Iluminación&lt;/th>";
                menu += "&lt;th style='text-align:center;vertical-align:middle;font-size:75%;'>Otros&lt;/th>";
                menu += "&lt;/tr>";
                menu += "&lt;/table>";
                menu += "&lt;/div>";
                menu += "&lt;button class='btnMenu' id='guardarGen' style='background-color:orange;margin-left:10px;margin-bottom:20px;' onclick='guardarGenerica(" + UFedificio + ")' disabled='true'> Guardar&lt;/button>\n";
                menu += "&lt;button class='btnMenu' id='aniadirGen' style='background-color:orangered;margin-top:5px;display:none' onclick='aniadirUnidad(2," + UFedificio + ")'> Añadir Unidad&lt;/button>\n";
                menu += "&lt;button class='btnMenu' id='volverUF' style='background-color:orangered' onclick='updateComunidad(2)'> Volver&lt;/button>&lt;br />&lt;br />\n";
                document.getElementById("contenido").innerHTML = menu;
                document.getElementById("esquema").innerHTML = "";
                $("#nombreNuevaGenerica").keyup(function () {
                    var check = $(this).val();
                    if (check.length > 0 &amp;&amp; document.getElementById('aniadirGen').style.display == 'inline-block' &amp;&amp; document.getElementById("nombreNuevaGenerica").value != "" &amp;&amp; document.getElementById('nombreNuevaGenerica').value == nombre) {
                        eliGen.disabled = false;
                        document.getElementById('guardarGen').disabled = false
                    }
                    else {
                        eliGen.disabled = true;
                        document.getElementById('guardarGen').disabled = true
                    }
                });
                eliGen.disabled = true;
                document.getElementById('guardarGen').disabled = true;
                HUtil.CambiarColor_Children_Select();
                // if (genericas > 0) {
                //     for (var x = 0; x &lt; $scope.genericas.length; x++) {
                //         if ($scope.genericas[x].id_edificio == UFedificio &amp;&amp; $scope.genericas[x].idusuario == usuario) {
                //             elegirGenerica(UFedificio, $scope.genericas[x].id_ufg);
                //             break;
                //         }
                //     }
                // }
            } else {
                alert("ERROR: Elija un tipo de caso antes de definir las undades genéricas");
            }
            document.getElementsByClassName('dropdown-menu')[0].style.display = 'block';
        }
        /**

        *Creamos una unidad genérica vacía

        
        * @param  {number}
        * @return  {void}

         */
        crearGenericaVacia = function (edificio) {
            var repe = false;
            var nombreGen = document.getElementById('nombreNuevaGenerica').value;
            for (var x = 0; x &lt; $scope.genericas.length; x++) {
                if ($scope.genericas[x].nombre == nombreGen &amp;&amp; $scope.genericas[x].id_edificio == edificio &amp;&amp; $scope.genericas[x].idusuario == usuario) {
                    repe = true;
                }
            }
            //Comprobamos que haya algo escrito y que sea correcto
            if (nombreGen.length > 0) {
                if (/^[A-Za-z0-9]/.test(nombreGen) == true) {
                    if (repe == false) {
                        document.getElementById('guardarGen').disabled = false;
                        //insertamos la unida genérica solo con los datos del edificio 
                        $http.post("insertarUnidadGenerica.php", {
                            'idusuario': usuario, 'id_tipedif': $scope.edificio[edificio - 1].idtipoedificio,
                            'id_edificio': edificio, 'nombre': nombreGen, 'calefaccion': 0, 'refrigeracion': 0,
                            'acs': 0, 'iluminacion': 0, 'piscina': 0, 'cocina': 0, 'fuerza': 0, 'otros': 0, 'numdiastipo': 0

                        }).success(function (data) {
                            console.log(data);
                            $http.get('unidadesGenericas.php').success(function (data) {
                                $scope.genericas = data;
                                $timeout(function () { cargarGenerica(edificio) }, 1500);
                            });
                        });
                    } else {
                        alert("ERROR: El nombre está repetido");
                    }
                } else {
                    alert("ERROR: El nombre debe tener solo letras o números");
                }
            }
            else {
                alert("ERROR: El nombre no puede estar vacío");
            }
        }
        /**

        *cargamos la nueva unidad en el selector

        
        * @param  {number}
        * @return  {void}

         */
        cargarGenerica = function (edificio) {
            var id = "";
            var posgen = 0;
            var generica = document.getElementById('nombreNuevaGenerica').value;
            //Cogemos sus atributos en función del nombre
            for (var x = 0; x &lt; $scope.genericas.length; x++) {
                if ($scope.genericas[x].nombre == generica) {
                    id = $scope.genericas[x].id_ufg;
                    posgen = x;
                }
            }
            //Creamos la nueva unidad en el selector
            var opt = document.createElement('option');
            var opt2 = document.createElement('a');
            opt2.href = "#"
            opt2.innerHTML = "&lt;option class='hover' value='" + posgen + "' id='generica" + generica + "' onclick='elegirGenerica(" + edificio + "," + id + ")'>" + generica + "&lt;/option>";
            opt.value = posgen;
            opt.id = "generica" + posgen;
            opt.innerHTML = generica;
            opt.click = addEventListener("click", elegirGenerica(document.getElementById('edificioGenerico').value, id));
            document.getElementsByClassName('dropdown-menu')[0].appendChild(opt2);
            document.getElementById('aniadirGen').style.display = "inline-block";
            HUtil.CambiarColor_Children_Select();
        }
         /**

        *borrar genérica

        * @return  {void}

         */
        borrarGenerica = function () {
            var ufCaso = "";
            var coinciden = false;
            var select = document.getElementById("nombreNuevaGenerica").value;
            var UFedificio = document.getElementById("edificioGenerico").innerHTML;
            var valido3 = "";
            if ($scope.ufCaso.length > 0) {
                ufCaso = $scope.ufCaso[0].id;
            }
            //La localizamos y la borramos de la base de datos
            for (var x = 0; x &lt; $scope.genericas.length; x++) {
                if ($scope.genericas[x].nombre == select &amp;&amp; $scope.edificio[$scope.genericas[x].id_edificio - 1].nombre == UFedificio) {
                    valido3 = $scope.genericas[x].id_ufg;
                    if ($scope.ufCaso.length > 0) {
                        if (valido3 == $scope.ufCaso[0].iduf) {
                            coinciden = true;
                            $http.post("borrarUnidadesFuncionalesCaso.php", { 'idcaso': idCaso, 'idusuario': usuario,'base':1 })
                                .success(function (data) {
                                    console.log(data);
                                });
                        }
                    }
                    break;
                }
            }
            for (var z = 0; z &lt; $scope.diastipocaso.length; z++) {
                // if ($scope.diastipocaso[z].id_caso == idCaso) {
                if ($scope.diastipocaso[z].id_uf == valido3) {
                    idtipodia = $scope.diastipocaso[z].id_diatipo;
                    $http.post("borrarValores.php", {
                        'id_diatipo': idtipodia,'base':1
                    }).success(function (data) {
                        console.log(data);
                        $http.post("borrarDias.php", {
                            'id_caso': idCaso, 'id_uf': valido3,'base':1
                        }).success(function (data) {
                            console.log(data);
                        });
                    });
                }
                
            }
            //Borramos los datos de las otras tablas de la base de datos y las actualizamos
            var element = document.getElementById("generica" + select);
            element.parentNode.removeChild(element);
            document.getElementById('aniadirGen').style.display = "none";
            document.getElementById('guardarGen').disabled = true;
            $http.post("borrarComposicion.php", {
                'id_ufg': valido3,
            }).success(function (data) {
                console.log(data);
                $http.get('composicionGenericas.php').success(function (data) {
                    $scope.compgenericas = data;
                });
            });
            $http.post("borrarGenerica.php", {
                'id_ufg': valido3,
            }).success(function (data) {
                console.log(data);
                $http.get('unidadesGenericas.php').success(function (data) {
                    $scope.genericas = data;
                });
            });
            while (document.getElementById("TablaUFGenericas").rows.length > 1) {
                document.getElementById("TablaUFGenericas").deleteRow(document.getElementById("TablaUFGenericas").rows.length - 1);
            }
            document.getElementById("nombreNuevaGenerica").value = "";
            $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.ufCaso = data;
                ADufcaso = data;
            });
            $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                $scope.valoreshorarioscaso = data;
                ADvaloreshorarioscaso = data;
            });
            $http.post('diasTipoCaso.php', { 'id_caso': idCaso,'base':1 }).success(function (data) {
                $scope.diastipocaso = data;
                ADdiastipocaso = data;
            });
        }
        /**

        *Cargamos las unidades funcionales en función de la unidad genérica seleccionada

        
        * @param  {number}
        * @return  {void}

         */
        elegirGenerica = function (edificio, id) {
            var valido3 = "";
            while (document.getElementById("TablaUFGenericas").rows.length > 1) {
                document.getElementById("TablaUFGenericas").deleteRow(document.getElementById("TablaUFGenericas").rows.length - 1);
            }
            valido3 = id;
            for (var x = 0; x &lt; $scope.genericas.length; x++) {
                if ($scope.genericas[x].id_ufg == id) {
                    nombre = $scope.genericas[x].nombre;
                }
            }
            //Activamos los botones o los desactivamos 
            document.getElementById('nombreNuevaGenerica').value = nombre;
            if (valido3 == "0") {
                document.getElementById("guardarGen").disabled = true;
                document.getElementById("eliGen").disabled = true;
                document.getElementById("aniadirGen").style.display = "none";
                document.getElementById('guardarGen').disabled = true;
            } else {
                document.getElementById("guardarGen").disabled = false;
                document.getElementById("eliGen").disabled = false;
                document.getElementsByClassName('dropdown-menu')[0].style.display = '';
                document.getElementById("aniadirGen").style.display = "inline-block";
                //Añadimos la genérica del caso si la hubiera
                for (var x = 0; x &lt; $scope.compgenericas.length; x++) {
                    if ($scope.compgenericas[x].id_ufg == valido3) {
                        aniadirUnidad(2, edificio);
                        document.getElementById("TablaUFGenericas").rows[document.getElementById("TablaUFGenericas").rows.length - 1].cells[0].innerHTML = $scope.compgenericas[x].nombreusuario;
                        document.getElementById("TablaUFGenericas").rows[document.getElementById("TablaUFGenericas").rows.length - 1].cells[2].innerHTML = $scope.compgenericas[x].porcentaje;
                        console.log($scope.compgenericas[x].id_uf);
                        document.getElementById("selFun" + (numFun - 1)).value = $scope.compgenericas[x].id_uf;
                        if ($scope.compgenericas[x].calefaccion == "1") {
                            document.getElementById("calFun" + (numFun - 1)).checked = true;
                        }
                        if ($scope.compgenericas[x].refrigeracion == "1") {
                            document.getElementById("refFun" + (numFun - 1)).checked = true;
                        }
                        if ($scope.compgenericas[x].acs == "1") {
                            document.getElementById("acsFun" + (numFun - 1)).checked = true;
                        }
                        if ($scope.compgenericas[x].piscina == "1") {
                            document.getElementById("pisFun" + (numFun - 1)).checked = true;
                        }
                        if ($scope.compgenericas[x].iluminacion == "1") {
                            document.getElementById("iluFun" + (numFun - 1)).checked = true;
                        }
                        if ($scope.compgenericas[x].otros == "1" || $scope.compgenericas[x].cocina == "1" || $scope.compgenericas[x].fuerza == "1") {
                            document.getElementById("otrFun" + (numFun - 1)).checked = true;
                        }
                    }
                }
            }
        }
        /**

        *Cargamos el spinner

        * @return  {void}

         */
        MostrarSpinner = function (timing) {
            //Desactivamos todas las secciones y cargamos el spinner
            if (document.getElementById('spinner').style.display == "block") {
                document.getElementById('contenido').style.display = "none";
                return
            }
            document.getElementById('spinner').style.display = "block";
            document.getElementById('contenido').style.display = "none";
            var status = 0;
            menudisabled(status);
            if(timing != "notime")
            //Asignamos un tiempo máximo al spinner
            Spinnerstatus = setTimeout(function () {
                alert('ERROR:La carga de la aplicación se ha demorado mucho');
                OcultarSpinner();
            }, 90000)
        }
        /**

        *Quitamos el spinner

        * @return  {void}

         */
        OcultarSpinner = function () {
            clearTimeout(Spinnerstatus);
            //Desactivamos el spinner y cargamos la sección correspondiente
            document.getElementById('spinner').style.display = "none";
            if (esquema.style.display == "none" || esquema.innerHTML == "")
                document.getElementById('contenido').style.display = "initial";
            else
                document.getElementById('contenido').style.display = "none";
            var status = 1;
            if (soloVE == "si")
                var status = 3;
            menudisabled(status);
        }
        /**

        *Desactivamos o activamos los elementos correspondientes y dependiendo de la acción que se produzca

        * @return  {void}

         */
        menudisabled = function (status) {
            switch (status) {
                case 0:
                    general.disabled = true;
                    contador.disabled = true;
                    referencia.disabled = true;
                    geoycon.disabled = true;
                    operacional.disabled = true;
                    piscina.disabled = true;
                    vehiculo.disabled = true;
                    demandas.disabled = true;
                    nuevas.disabled = true;
                    alternativas.disabled = true;
                    facturacion.disabled = true;
                    optimizacion.disabled = true;
                    resultados.disabled = true;
                    babrircaso.disabled = true;
                    bnuevocaso.disabled = true;
                    beliminarcaso.disabled = true;
                    break;
                case 1:
                    contador.style.color = "black";
                    referencia.style.color = "black";
                    geoycon.style.color = "black";
                    operacional.style.color = "black";
                    piscina.style.color = "black";
                    nuevas.style.color = "black";
                    facturacion.style.color = "black";
                    alternativas.style.color = "black";
                    optimizacion.style.color = "black";
                    general.disabled = false;
                    contador.disabled = false;
                    referencia.disabled = false;
                    geoycon.disabled = false;
                    operacional.disabled = false;
                    piscina.disabled = false;
                    vehiculo.disabled = false;
                    demandas.disabled = false;
                    nuevas.disabled = false;
                    facturacion.disabled = false;
                    alternativas.disabled = false;
                    optimizacion.disabled = false;
                    resultados.disabled = false;
                    babrircaso.disabled = false;
                    bnuevocaso.disabled = false;
                    beliminarcaso.disabled = false;
                    break;
                case 2:
                    general.disabled = true;
                    contador.disabled = true;
                    referencia.disabled = true;
                    geoycon.disabled = true;
                    operacional.disabled = true;
                    piscina.disabled = true;
                    vehiculo.disabled = true;
                    demandas.disabled = true;
                    nuevas.disabled = true;
                    facturacion.disabled = true;
                    alternativas.disabled = true;
                    optimizacion.disabled = true;
                    resultados.disabled = true;
                    break;
                case 3:
                    general.disabled = false;
                    contador.disabled = true;
                    contador.style.color = "darkgray";
                    referencia.disabled = true;
                    referencia.style.color = "darkgray";
                    geoycon.disabled = true;
                    geoycon.style.color = "darkgray";
                    operacional.disabled = true;
                    operacional.style.color = "darkgray";
                    piscina.disabled = true;
                    piscina.style.color = "darkgray";
                    vehiculo.disabled = false;
                    demandas.disabled = false;
                    nuevas.disabled = true;
                    nuevas.style.color = "darkgray";
                    alternativas.disabled = true;
                    facturacion.disabled = true;
                    facturacion.style.color = "darkgray";
                    alternativas.style.color = "darkgray";
                    optimizacion.disabled = true;
                    optimizacion.style.color = "darkgray";
                    resultados.disabled = false;
                    babrircaso.disabled = false;
                    bnuevocaso.disabled = false;
                    beliminarcaso.disabled = false;
                    break;
            }
        }
        /**

        *Guardar unidad genérica

        
        * @param  {number}
        * @return  {void}

         */
        guardarGenerica = async function (edificio) {
            //Comprobamos que se ha seleccionado alguna
            for (var x = 1; x &lt; TablaUFGenericas.rows.length; x++) {
                if (TablaUFGenericas.rows[x].cells[1].children[0].selectedIndex == 0) {
                    alert('Selecciona una o más Unidades funcionales de la lista.')
                    return;
                }
            }
            var todoCorrecto = true;
            var numDias = "";
            var select = document.getElementById("nombreNuevaGenerica").value;
            var valido2 = "";
            var valido3 = select;
            for (var x = 0; x &lt; $scope.genericas.length; x++) {
                if ($scope.genericas[x].nombre == select &amp;&amp; $scope.genericas[x].id_edificio == edificio) {
                    valido2 = $scope.genericas[x].id_ufg;
                    break;
                }
            }
            var cal = "0";
            var ref = "0";
            var acs = "0";
            var ilu = "0";
            var pis = "0";
            var coc = "0";
            var fue = "0";
            var otr = "0";
            var idSelect = "";
            var lastid = "";
            var porcentaje = 0;
            contT = 0;
            //Comprobamos que los valores introducidos son correctos
            for (var x = 1; x &lt; document.getElementById("TablaUFGenericas").rows.length; x++) {
                porcentaje += parseInt(document.getElementById('TablaUFGenericas').rows[x].cells[2].innerHTML);
                if (x > 0) {
                    if (/^[0-9]*$/.test(document.getElementById('TablaUFGenericas').rows[x].cells[2].innerHTML) == false) {
                        alert('ERROR: El campo porcentaje de la unidad funcional ' + x + ' con valores no numéricos');
                        todoCorrecto = false;
                    }
                    if (document.getElementById('TablaUFGenericas').rows[x].cells[2].innerHTML == "0") {
                        alert('ERROR: El campo porcentaje de la unidad funcional ' + x + ' no puede ser 0');
                        todoCorrecto = false;
                    }
                    if (valido2 == "0") {
                        todoCorrecto = false;
                    }
                }
            } if (todoCorrecto == true) {
                if (document.getElementById('TablaUFGenericas').rows.length > 1) {
                    MostrarSpinner();
                    if (porcentaje == 100 || document.getElementById("TablaUFGenericas").rows.length == 1) {
                        for (var x = 0; $scope.funcionales.length; x++) {
                            if ($scope.funcionales[x].id_edificio == edificio) {
                                numDias = $scope.funcionales[x].numdiastipo;
                                break;
                            }
                        }
                        //Adaptamos los valores de los elementos si hay que hacerlo
                        for (var x = 2; x &lt; document.getElementById("TablaUFGenericas").rows.length + 1; x++) {
                            idSelect = document.getElementById('TablaUFGenericas').rows[x - 1].cells[1].getElementsByTagName('select')[0].id;
                            var select = document.getElementById(idSelect);
                            if (parseInt(idSelect.slice(-2)) >= 10) {
                                lastid = idSelect.slice(-2);
                            } else {
                                lastid = idSelect.slice(-1);
                            }
                            if (select === null) {
                            } else {
                                valido = select.options[select.selectedIndex].value;
                                if (document.getElementById("calFun" + lastid).checked == true) {
                                    cal = "1";
                                }
                                if (document.getElementById("refFun" + lastid).checked == true) {
                                    ref = "1";
                                }
                                if (document.getElementById("acsFun" + lastid).checked == true) {
                                    acs = "1";
                                }
                                if (document.getElementById("pisFun" + lastid).checked == true) {
                                    pis = "1";
                                }
                                if (document.getElementById("iluFun" + lastid).checked == true) {
                                    ilu = "1";
                                }
                                if (document.getElementById("otrFun" + lastid).checked == true || $scope.funcionales[valido].cocina == "1" || $scope.funcionales[valido].fuerza == "1") {
                                    otr = "1";
                                }
                            }
                        }
                        selectufindex = valido3;
                        //Actualizamos los datos de la unidad si existía
                        await $http.post("updateUnidadGenerica.php", {
                            'id_tipedif': $scope.edificio[edificio - 1].idtipoedificio, 'id_edificio': edificio,
                            'nombre': valido3, 'calefaccion': cal, 'refrigeracion': ref,
                            'acs': acs, 'iluminacion': ilu, 'piscina': pis, 'cocina': coc, 'fuerza': fue, 'otros': otr, 'numdiastipo': numDias,
                        }).success(async function (data) {
                            console.log(data);
                            await $http.get('unidadesGenericas.php').success(async function (data) {
                                $scope.genericas = data;
                            });
                        });
                        //Borramos los demás datos relacionados
                        $http.post("borrarComposicion.php", {
                            'id_ufg': valido2,
                        }).success(function (data) {
                            console.log(data);
                            $http.get('composicionGenericas.php').success(function (data) {
                                $scope.compgenericas = data;
                            });
                        });
                        if (document.getElementById("TablaUFGenericas").rows.length > 1) {
                            //Insertamos ahora la composición
                            $timeout(function () { insertarComposicion(valido2) }, 500);
                        }
                        for (var z = 0; z &lt; $scope.diastipocaso.length; z++) {
                            if ($scope.diastipocaso[z].id_caso == idCaso &amp;&amp; $scope.diastipocaso[z].id_uf == valido2) {
                                idtipodia = $scope.diastipocaso[z].id_diatipo;
                                $http.post("borrarValores.php", {
                                    'id_diatipo': idtipodia,'base':1
                                }).success(function (data) {
                                    console.log(data);
                                });
                            }
                        }
                        $http.post("borrarDias.php", {
                            'id_caso': idCaso, 'id_uf': valido2,'base':1
                        }).success(function (data) {
                            console.log(data);
                            $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                                $scope.diastipocaso = data;
                                ADdiastipocaso = data;
                                alert("Datos Guardados Correctamente");
                            });
                        });
                        //Insertamos los días tipo
                        $timeout(function () { insertarDiasTipo(2, numDias, valido, edificio) }, 500);
                    } else {
                        alert("ERROR: El porcentaje total es " + porcentaje + ", el porcentaje total debe ser 100");
                        OcultarSpinner();
                    }
                } else {
                    alert("Añada una nueva unidad funcional");
                }
            }
        }
        /**

        *Insertamos los valores de la composición

        
        * @param  {number}
        * @return  {void}

         */
        insertarComposicion = function (UFGenerica) {
            var cal = "0";
            var ref = "0";
            var acs = "0";
            var ilu = "0";
            var pis = "0";
            var coc = "0";
            var fue = "0";
            var otr = "0";
            var idSelect = "";
            var lastid = "";
            for (var x = 2; x &lt; document.getElementById("TablaUFGenericas").rows.length + 1; x++) {
                cal = "0";
                ref = "0";
                acs = "0";
                ilu = "0";
                pis = "0";
                coc = "0";
                fue = "0";
                otr = "0";
                idSelect = document.getElementById('TablaUFGenericas').rows[x - 1].cells[1].getElementsByTagName('select')[0].id;
                var select = document.getElementById(idSelect);
                if (parseInt(idSelect.slice(-2)) >= 10) {
                    lastid = idSelect.slice(-2);
                } else {
                    lastid = idSelect.slice(-1);
                }
                if (select === null) {
                } else {
                    //Adaptamos los datos de los elementos necesarios
                    valido = select.options[select.selectedIndex].value;
                    valido2 = select.options[select.selectedIndex].innerHTML;
                    if (document.getElementById("calFun" + lastid).checked == true) {
                        cal = "1";
                    }
                    if (document.getElementById("refFun" + lastid).checked == true) {
                        ref = "1";
                    }
                    if (document.getElementById("acsFun" + lastid).checked == true) {
                        acs = "1";
                    }
                    if (document.getElementById("pisFun" + lastid).checked == true) {
                        ilu = "1";
                    }
                    if (document.getElementById("iluFun" + lastid).checked == true) {
                        pis = "1";
                    }
                    if (document.getElementById("otrFun" + lastid).checked == true || $scope.funcionales[valido - 1].cocina == "1" || $scope.funcionales[valido - 1].fuerza == "1") {
                        otr = "1";
                    }
                    //insertamos los datos en la base de datos y actualizamos la tabla
                    $http.post("insertarComposicionGenerica.php", {
                        'id_ufg': UFGenerica, 'id_uf': valido, 'nombreusuario': document.getElementById('TablaUFGenericas').rows[x - 1].cells[0].innerHTML,
                        'porcentaje': document.getElementById('TablaUFGenericas').rows[x - 1].cells[2].innerHTML, 'calefaccion': cal, 'refrigeracion': ref,
                        'acs': acs, 'iluminacion': ilu, 'piscina': pis, 'cocina': coc, 'fuerza': fue, 'otros': otr,
                    }).success(function (data) {
                        console.log(data);
                        $http.get('composicionGenericas.php').success(function (data) {
                            $scope.compgenericas = data;
                            OcultarSpinner();
                            //Y volvemos a los datos generales
                            updateComunidad(2);
                        });
                    });
                }
            }
        }
        
        /**

        *Insertamos los dias tipo correspondientes a la unidad genérica

        
        * @param  {string}
        * @return  {void}

         */
        insertarDiasTipo = function (tipoD, numDias, UFGenerica, edificio) {
            var usuarioA = false;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            var nombreUF = "";
            var nombreUF2 = "";
            var valocup = 0;
            var valilum = 0;
            var valequip = 0;
            var valacs = 0;
            var trarepacs = 0;
            var tipoEnum = "";
            var valacspiscina = 0;
            var tipoDia = new Array();
            var numOrden = 0;
            var valido = "";
            var esGenerica = false;
            idSelect = "";
            if (tipoD == 1) {
                tipoDia = [];
                //Seleccionamos valores y comprobamos si es una unidad genérica
                idSelect = document.getElementById('tablaFuncional2').rows[contDiastipoCreados + 1].cells[1].getElementsByTagName('select')[0].id;
                var select = document.getElementById(idSelect);
                nombreUF = select.options[select.selectedIndex].innerHTML;
                nombreUF2 = select.options[select.selectedIndex].value;
                var select2 = document.getElementById('tipoEdificio');
                var edificioG = select2.options[select2.selectedIndex].value;
                for (var o = 1; o &lt;= tablaFuncional2.rows.length - 1; o++)
                    if (tablaFuncional2.rows[o].cells[1].children[0].selectedOptions[0].textContent == $scope.ufCaso[contDiastipoCreados].nombre)
                        valido = $scope.ufCaso[contDiastipoCreados].id
                for (var z = 0; z &lt; $scope.genericas.length; z++) {
                    if (nombreUF == $scope.genericas[z].nombre &amp;&amp; edificioG == $scope.genericas[z].id_edificio) {
                        numOrden = $scope.genericas[z].numdiastipo;
                        valido2 = $scope.genericas[z].id_ufg;
                        esGenerica = true;
                    }
                }
                if (valido != "0") {
                    
                    if (esGenerica == true) {
                        //Si existe y es genéricabuscamos por el id de la genérica 
                        for (var y = 0; y &lt; $scope.diastipocaso.length; y++) {
                            if ($scope.diastipocaso[y].id_uf == valido2) {
                                $http.post("insertarDiasTipo.php", {
                                    'id_caso': idCaso, 'id_uf': valido, 'numeroorden': $scope.diastipocaso[y].numeroorden,
                                    'nombre': $scope.diastipocaso[y].nombre, 'valocup': $scope.diastipocaso[y].valocup,
                                    'valilum': $scope.diastipocaso[y].valilum, 'valequip': $scope.diastipocaso[y].valequip,
                                    'valacs': $scope.diastipocaso[y].valacs, 'valacspiscina': $scope.diastipocaso[y].valacspiscina,
                                    'trarepacs': $scope.diastipocaso[y].trarepacs,'base':1
                                }).success(function (data) {
                                    console.log(data);
                                    $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                                        $scope.diastipocaso = data;
                                        ADdiastipocaso = data;
                                        for (var u = 0; u &lt; $scope.diastipocaso.length; u++) {
                                            if ($scope.diastipocaso[u].id_uf == valido) {
                                                tipoDia.push($scope.diastipocaso[u].id_diatipo);
                                            }
                                        }
                                        numOrden = parseInt(numOrden);
                                        contT++;
                                        parseInt(numOrden);
                                        if (contT == numOrden) {
                                            for (var i = 0; i &lt; numOrden; i++) {
                                                insertarValoresHorarios2(1, tipoDia, (i + 1), valido);
                                            }
                                            if (i == numOrden) {
                                                
                                                alert("Datos guardados correctamente");
                                                vaciarcontenido();
                                                $timeout(function () { OcultarSpinner() }, 3000);
                                            }
                                        }
                                    });
                                });
                            }
                        }
                    } else {
                        //Si no buscamos los valores mediante el id de la unidad funcional
                        numDias = parseInt(numDias);
                        for (var z = 0; z &lt; numDias; z++) {
                            valocup = 0;
                            valilum = 0;
                            valequip = 0;
                            valacs = 0;
                            valacspiscina = 0;
                            trarepacs = 0;
                            tipoDia = "";
                            for (var y = 0; y &lt; $scope.tipodias.length; y++) {

                                if ($scope.tipodias[y].id_uf == nombreUF2 &amp;&amp; (z + 1) == $scope.tipodias[y].numeroorden) {
                                    if (usuarioA == true) {
                                        tipoDia = $scope.tipodias[y].id_diatipo;
                                    }
                                    $http.post("insertarDiasTipo.php", {
                                        'id_caso': idCaso, 'id_uf': valido, 'numeroorden': $scope.tipodias[y].numeroorden,
                                        'nombre': $scope.tipodias[y].nombre, 'valocup': $scope.tipodias[y].valocup,
                                        'valilum': $scope.tipodias[y].valilum, 'valequip': $scope.tipodias[y].valequip,
                                        'valacs': $scope.tipodias[y].valacs, 'valacspiscina': $scope.tipodias[y].valacspiscina,
                                        'trarepacs': $scope.tipodias[y].trarepacs,'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                        $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1}).success(function (data) {
                                            $scope.diastipocaso = data;
                                            ADdiastipocaso = data;
                                            if (usuarioA == false) {
                                                for (var u = 0; u &lt; $scope.diastipocaso.length; u++) {
                                                    if ($scope.diastipocaso[u].id_uf == valido) {
                                                        tipoDia.push($scope.diastipocaso[u].id_diatipo);
                                                    }
                                                }
                                            }
                                            numOrden = parseInt(numOrden);
                                            contT++;
                                            parseInt(numOrden);
                                            if (contT == (numDias * (edificio - 1))) {
                                                for (var i = 0; i &lt; numDias; i++) {
                                                    insertarValoresHorarios2(1, tipoDia, (i + 1), valido, x);
                                                }
                                                if ((i * (document.getElementById("tablaFuncional2").rows.length - 1)) == contT) {
                                                    /*
                                                    $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, }).success(function (data) {
                                                        $scope.valoreshorarioscaso = data;
                                                    });
                                                    */
                                                    alert("Datos guardados correctamente");
                                                    vaciarcontenido();
                                                    $timeout(function () { OcultarSpinner() }, 3000);
                                                }
                                            }
                                        });
                                    });
                                }
                            }
                        }
                    }
                }
               
            } else {
                //En caso de que la sección sea de la genérica
                ordenDia = new Array();
                var porcentajesTablas = new Array();
                numDias = parseInt(numDias);
                for (var z = 0; z &lt; numDias; z++) {
                    valocup = 0;
                    valilum = 0;
                    valequip = 0;
                    valacs = 0;
                    valacspiscina = 0;
                    trarepacs = 0;
                    if (document.getElementById("TablaUFGenericas").rows.length > 1) {
                        for (var x = 2; x &lt; document.getElementById("TablaUFGenericas").rows.length + 1; x++) {
                            idSelect = document.getElementById('TablaUFGenericas').rows[x - 1].cells[1].getElementsByTagName('select')[0].id;
                            var select = document.getElementById(idSelect);
                            if (select === null) {
                            } else {
                                //Hacemos el cálculo de los valores de los días tipo en función del porcentaje
                                valido = select.options[select.selectedIndex].value;
                                for (var y = 0; y &lt; $scope.tipodias.length; y++) {
                                    if ($scope.tipodias[y].id_uf == valido &amp;&amp; (z + 1) == $scope.tipodias[y].numeroorden) {
                                        orden = $scope.tipodias[y].numeroorden;
                                        tipoEnum = $scope.tipodias[y].nombre;
                                        tipoDia.push($scope.tipodias[y].id_diatipo);
                                        ordenDia
                                        porcentajesTablas.push(document.getElementById("TablaUFGenericas").rows[x - 1].cells[2].innerHTML);
                                        valocup += parseFloat($scope.tipodias[y].valocup) * (document.getElementById('TablaUFGenericas').rows[x - 1].cells[2].innerHTML / 100);
                                        valilum += parseFloat($scope.tipodias[y].valilum) * (document.getElementById('TablaUFGenericas').rows[x - 1].cells[2].innerHTML / 100);
                                        valequip += parseFloat($scope.tipodias[y].valequip) * (document.getElementById('TablaUFGenericas').rows[x - 1].cells[2].innerHTML / 100);
                                        valacs += parseFloat($scope.tipodias[y].valacs) * (document.getElementById('TablaUFGenericas').rows[x - 1].cells[2].innerHTML / 100);
                                        trarepacs += parseFloat($scope.tipodias[y].trarepacs) * (document.getElementById('TablaUFGenericas').rows[x - 1].cells[2].innerHTML / 100);
                                    }
                                }
                            }
                        }
                        //Buscamos el id de la unidad genérica
                        UFGenerica = document.getElementById("nombreNuevaGenerica").value;
                        for (var x = 0; x &lt; $scope.genericas.length; x++) {
                            if ($scope.genericas[x].nombre == UFGenerica &amp;&amp; edificio == $scope.genericas[x].id_edificio) {
                                UFGenerica = $scope.genericas[x].id_ufg;
                                break;
                            }
                        }
                        //Almacenamos los días tipo calculados
                        $http.post("insertarDiasTipo.php", {
                            'id_caso': idCaso, 'id_uf': UFGenerica, 'numeroorden': (z + 1),
                            'nombre': tipoEnum, 'valocup': valocup,
                            'valilum': valilum,
                            'valequip': valequip,
                            'valacs': valacs,
                            'valacspiscina': valacspiscina,
                            'trarepacs': trarepacs,'base':1
                        }).success(function (data) {
                            console.log(data);
                            //Actualizamos la tabla
                            $http.post('diasTipoCaso.php', { 'id_caso': idCaso,'base':1 }).success(function (data) {
                                $scope.diastipocaso = data;
                                ADdiastipocaso = data;
                                contT++;
                                if (contT == numDias) {
                                    //Ahora calculamos los valores horarios
                                    for (var y = 0; y &lt; numDias; y++) {
                                        insertarValoresHorarios2(2, tipoDia, (y + 1), UFGenerica, porcentajesTablas, ordenDia);
                                    }
                                }
                                //Después actualizamos los valores de la tabla de días tipo y valores horarios
                                $http.get('casoDiasTipo.php',{'base':1}).success(function (data) {
                                    $scope.casotipodias = data;
                                });
                            });
                        });
                    }
                }
                $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1}).success(function (data) {
                    $scope.valoreshorarioscaso = data;
                    ADvaloreshorarioscaso = data;

                });
            }
            contDiastipoCreados++;
        }
        wait = function (ms) {
            var start = new Date().getTime();
            var end = start;
            while (end &lt; start + ms) {
                end = new Date().getTime();
            }
        }
        $scope.uploadedFile = function (element) {
            $scope.$apply(function ($scope) {
                $scope.files = element.files;
            });
        }
    
        /**

        *Insertamos los valores horarios correspondientes a la unidad genérica

        
        * @param  {string}
        * @return  {void}

         */
        insertarValoresHorarios2 = function (tipoV, tipoDia, orden, unidad, porcentajesTablas) {
            var usuarioA = false;
            for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                if (parseInt($scope.usuarios[x].id) == usuario &amp;&amp; $scope.usuarios[x].ua == "si") {
                    usuarioA = true;
                }
            }
            
            var contOrdenTipo = 1;
            var contNumVal = 0;
            var vh_cal = 0;
            var vh_ref = 0;
            var vh_ocup = 0;
            var vh_ilumequip = 0;
            var vh_acs = 0;
            var vh_otros = 0;
            var idtipodia = "";
            var idtipodiacaso = "";
            var idtipodiacaso2 = "";
            var idtipodiaUFG = "";
            var nombreUF = "";
            var valido2 = "";
            if (tipoV == 1) {
                for (var x = 2; x &lt; document.getElementById("tablaFuncional2").rows.length + 1; x++) {
                    idSelect = document.getElementById('tablaFuncional2').rows[x - 1].cells[1].getElementsByTagName('select')[0].id;
                    var select = document.getElementById(idSelect);
                    nombreUF = select.options[select.selectedIndex].value;
                    for (var i = 0; i &lt; $scope.genericas.length; i++) {
                        if (nombreUF == $scope.genericas[i].nombre) {
                            valido2 = $scope.genericas[i].id_ufg;
                        }
                    }
                    //Sacamos el id de la uf
                    if (datosCasos[19] == "Nivel 0") {
                        for (var y = 0; y &lt; $scope.diastipocaso.length; y++) {
                            if ($scope.diastipocaso[y].id_uf == $scope.ufCaso[0].iduf &amp;&amp; $scope.diastipocaso[y].numeroorden == orden) {
                                idtipodiaUFG = $scope.diastipocaso[y].id_diatipo;
                            }
                        }
                        for (var y = 0; y &lt; $scope.diastipocaso.length; y++) {
                            if ($scope.diastipocaso[y].id_uf == $scope.ufCaso[0].id &amp;&amp; $scope.diastipocaso[y].numeroorden == orden) {
                                idtipodiacaso = $scope.diastipocaso[y].id_diatipo;
                            }
                        }
                    } else {
                        for (var y = 0; y &lt; $scope.diastipocaso.length; y++) {
                            if ($scope.diastipocaso[y].id_uf == $scope.ufCaso[x - 2].id &amp;&amp; $scope.diastipocaso[y].numeroorden == orden) {
                                idtipodiacaso2 = $scope.diastipocaso[y].id_diatipo;
                            }
                        }
                        for (var y = 0; y &lt; $scope.tipodias.length; y++) {
                            if ($scope.tipodias[y].id_uf == $scope.ufCaso[x - 2].iduf &amp;&amp; $scope.tipodias[y].numeroorden == orden) {
                                idtipodiacaso = $scope.tipodias[y].id_diatipo;
                            }
                        }
                    }
                    for (var z = 1; z &lt; 25; z++) {
                        //Insertamos los valores de la uf genérica o de la normal dependiendo de la sección
                        if (datosCasos[19] == "Nivel 0") {

                            for (var y = 0; y &lt; $scope.valoreshorarioscaso.length; y++) {
                                if ($scope.valoreshorarioscaso[y].id_diatipo == idtipodiaUFG &amp;&amp; z == $scope.valoreshorarioscaso[y].numerohora) {
                                    $http.post("insertarValores.php", {
                                        'id_diatipo': idtipodiacaso, 'numerohora': z, 'vh_cal': $scope.valoreshorarioscaso[y].vh_cal,
                                        'vh_ref': $scope.valoreshorarioscaso[y].vh_ref, 'vh_ocup': $scope.valoreshorarioscaso[y].vh_ocup, 'vh_ilumequip': $scope.valoreshorarioscaso[y].vh_ilumequip,
                                        'vh_acs': $scope.valoreshorarioscaso[y].vh_acs, 'vh_otros': $scope.valoreshorarioscaso[y].vh_otros, 'idcaso': idCaso,'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                    contNumVal++;
                                }
                            }
                        } else {
                            for (var y = 0; y &lt; $scope.valoreshorarios.length; y++) {
                                if ($scope.valoreshorarios[y].id_diatipo == idtipodiacaso &amp;&amp; z == $scope.valoreshorarios[y].numerohora) {
                                    $http.post("insertarValores.php", {
                                        'id_diatipo': idtipodiacaso2, 'numerohora': z, 'vh_cal': $scope.valoreshorarios[y].vh_cal,
                                        'vh_ref': $scope.valoreshorarios[y].vh_ref, 'vh_ocup': $scope.valoreshorarios[y].vh_ocup, 'vh_ilumequip': $scope.valoreshorarios[y].vh_ilumequip,
                                        'vh_acs': $scope.valoreshorarios[y].vh_acs, 'vh_otros': $scope.valoreshorarios[y].vh_otros, 'idcaso': idCaso,'base':1
                                    }).success(function (data) {
                                        console.log(data);
                                    });
                                    contNumVal++;
                                }
                            }
                        }
                    }
                }
            } else {
                //En caso de ser genérica hacemos un cálculo en función del porcentaje
                for (var x = 0; x &lt; $scope.diastipocaso.length; x++) {
                    if ($scope.diastipocaso[x].id_caso == idCaso &amp;&amp; $scope.diastipocaso[x].numeroorden == orden &amp;&amp; unidad == $scope.diastipocaso[x].id_uf) {
                        idtipodia = $scope.diastipocaso[x].id_diatipo;
                    }
                }
                for (var z = 1; z &lt; 25; z++) {
                    contOrdenTipo = 1;
                    vh_cal = 0;
                    vh_ref = 0;
                    vh_ocup = 0;
                    vh_ilumequip = 0;
                    vh_acs = 0;
                    vh_otros = 0;
                    for (var x = 0; x &lt; tipoDia.length; x++) {
                        for (var y = 0; y &lt; $scope.valoreshorarios.length; y++) {
                            if ($scope.valoreshorarios[y].id_diatipo == tipoDia[x] &amp;&amp; z == $scope.valoreshorarios[y].numerohora &amp;&amp; $scope.tipodias[parseInt(tipoDia[x]) - 1].numeroorden == orden) {

                                vh_cal += parseFloat($scope.valoreshorarios[y].vh_cal) * (porcentajesTablas[x] / 100);
                                vh_ref += parseFloat($scope.valoreshorarios[y].vh_ref) * (porcentajesTablas[x] / 100);
                                vh_ocup += parseFloat($scope.valoreshorarios[y].vh_ocup) * (porcentajesTablas[x] / 100);
                                vh_ilumequip += parseFloat($scope.valoreshorarios[y].vh_ilumequip) * (porcentajesTablas[x] / 100);
                                vh_acs += parseFloat($scope.valoreshorarios[y].vh_acs) * (porcentajesTablas[x] / 100);
                                vh_otros += parseFloat($scope.valoreshorarios[y].vh_otros) * (porcentajesTablas[x] / 100);
                            }
                        }
                    }
                    if (vh_cal &lt; 0.5) {
                        vh_cal = 0;
                    } else {
                        vh_cal = 1;
                    }
                    if (vh_ref &lt; 0.5) {
                        vh_ref = 0;
                    } else {
                        vh_ref = 1;
                    }
                    //Una vez calculados se insertan sus valores
                    $http.post("insertarValores.php", {

                        'id_diatipo': idtipodia, 'numerohora': z, 'vh_cal': vh_cal,
                        'vh_ref': vh_ref, 'vh_ocup': vh_ocup,
                        'vh_ilumequip': vh_ilumequip,
                        'vh_acs': vh_acs,
                        'vh_otros': vh_otros, 'idcaso': idCaso,'base':1
                    }).success(function (data) {
                        console.log(data);
                    });
                }
            }
        }

        /**

        *Filtramos las provincias

        * @return  {void}

         */
        filtrarProvincias = function () {
            //Filtramos las provincias en función de la comunidad escogida
            var comunidad = document.getElementById("comunidad").value;
            var select = "";
            select += "&lt;option value= '0' hidden selected > - Selecciona -&lt;/option>\n";
            for (var x = 0; x &lt; $scope.provincia.length; x++) {
                if (comunidad == $scope.provincia[x].idcomunidad) {
                    select += "&lt;option value='" + $scope.provincia[x].id + "'>" + $scope.provincia[x].nombre + "&lt;/option>\n";
                }
            }
            document.getElementById("provincia").innerHTML = select;
        }
        /**

        *Filtramos las localidades

        * @return  {void}

         */
        filtrarLocalidades = function () {
            //Filtramos las localidades en función de la provincia escogida
            var provincia = document.getElementById("provincia").value;
            var select = "";
            select += "&lt;option value= '0' hidden selected > - Selecciona -&lt;/option>\n";
            for (var x = 0; x &lt; $scope.localidad.length; x++) {
                if (provincia == $scope.localidad[x].idprovincia) {
                    select += "&lt;option value='" + (x + 1) + "'>" + $scope.localidad[x].nombre + "&lt;/option>\n";
                }
            }
            document.getElementById("localidad").innerHTML = select;
        }
        /**

        *Cambiamos la zona climática

        * @return  {void}

         */
        cargarClima = function () {
            var zonaclimatica = "";
            var select = document.getElementById("localidad");
            var select2 = document.getElementById("clima");
            valido = select.options[select.selectedIndex].text;
            var localidad = select.options[select.selectedIndex].value;
            //Cambiamos la zona climática en función de la localidad seleccionada
            for (var x = 0; x &lt; document.getElementById("clima").options.length; x++) {
                if (document.getElementById("clima").options[x].text == $scope.localidad[localidad - 1].zonaclimatica) {
                    zonaclimatica = x;
                }
            }
            if (localidad == "0") {
                document.getElementById('clima').value = zonaclimatica;
            } else {
                var retVal = confirm("¿Desea cambiar la zona climática por la genérica?");
                if (retVal == true) {
                    document.getElementById('clima').value = zonaclimatica;
                }
            }
        }
        /**

        *Cargamos la sección de resultados
        * @return  {void}

         */
        updateResultados = async function () 
        {
            Hresultados.updateresultados();
        }
        /**

        *Creamos las restricciones de teclas 1

        
        * @return  {void}

         */
        writingCap1 = function (event) {
            var oEvento = event || window.event;
            var sText = oEvento.target.textContent;
            if (sText.length > 0 &amp;&amp; oEvento.keyCode == 49 || oEvento.keyCode == 97 || oEvento.keyCode == 96 || oEvento.keyCode == 48 || oEvento.keyCode == 49)
                oEvento.target.textContent = oEvento.key;
            if (oEvento.keyCode != 8 &amp;&amp; oEvento.keyCode != 39 &amp;&amp; oEvento.keyCode != 37 &amp;&amp; oEvento.keyCode != 9 &amp;&amp; oEvento.keyCode != 46 || oEvento.keyCode == 13 &amp;&amp; oEvento.keyCode != 8)
                oEvento.preventDefault();
        }
        /**

        *Creamos las restricciones de teclas 2
        * @return  {void}

         */
        writingCap2 = function (event) {
            var oEvento = event || window.event;
            var sText = oEvento.target.textContent;
            if (sText.length > 5 &amp;&amp; oEvento.keyCode != 8 &amp;&amp; oEvento.keyCode != 39 &amp;&amp; oEvento.keyCode != 37 &amp;&amp; oEvento.keyCode != 9 || oEvento.keyCode == 13 &amp;&amp; oEvento.keyCode != 8) {
                oEvento.preventDefault();
            }
        }
        /**

        *Creamos las restricciones de teclas 3

        * @return  {void}

         */
        writingCapEnter = function (event) {
            var oEvento = event || window.event;
            var sText = oEvento.target.textContent;
            if (sText.length > 5 &amp;&amp; oEvento.keyCode != 8 &amp;&amp; oEvento.keyCode != 39 &amp;&amp; oEvento.keyCode != 37 &amp;&amp; oEvento.keyCode != 9 || oEvento.keyCode == 13 &amp;&amp; oEvento.keyCode != 8) {
                oEvento.preventDefault();
            }
        }
        /**

        *Creamos las restricciones de teclas 4

        * @return  {void}

         */
        writingCapEnter2 = function (event) {
            var oEvento = event || window.event;
            if (oEvento.keyCode == 13) {
                oEvento.preventDefault();
            }
        }
        /**

        *Creamos las restricciones de teclas para facturación

        * @return  {void}

         */
        writingCapFacturacion = function (event) {
            var oEvento = event || window.event;
            var sText = oEvento.target.textContent;
            if (sText.length > 3 &amp;&amp; oEvento.keyCode != 8 &amp;&amp; oEvento.keyCode != 39 &amp;&amp; oEvento.keyCode != 37 &amp;&amp; oEvento.keyCode != 9 || oEvento.keyCode == 13 &amp;&amp; oEvento.keyCode != 8) {
                oEvento.preventDefault();
            }
        }
         /**

        *Guardamos el caso abierto

        * @return  {void}

         */
        guardarCaso = function () {
            document.getElementById('referencia').disabled = true;
            document.getElementById('nuevas').disabled = true;
            var nuex = "";
            var contE = 0;
            var usoTipo = 0;
            var numCol = 0;
            var equiposGAcorrecto = false;
            for (var x = 0; x &lt; colectores.length; x++) {
                usoTipo = parseInt(colectores[x][1]);
                if ($scope.uso[usoTipo - 1].idtipouso != "2" &amp;&amp; usoTipo!=5) {
                    numCol++;
                    loop1:
                    for (var y = 0; y &lt; equipos.length; y++) {
                        if ((colectores[x][0] == equipos[y][2] || colectores[x][0] == equipos[y][3]) &amp;&amp; equipos[y][6] != "2") {
                            contE++;
                            break loop1;
                        }
                    }
                }
                if (contE == numCol) {
                    equiposGAcorrecto = true;
                    break;
                }
            }
            if (equiposGAcorrecto == true) {
                if (sistema == 0) {
                    nuex = "Existente";
                    equiposE = equipos.length;
                } else {
                    nuex = "Nuevo";
                    equiposN = equipos.length;
                }
                canvasfunction();
                //Comprobamos si la tabla de casos está vacía en función de ello asignaremos un id al caso
                for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                    if ($scope.usuarios[x].id == usuario) {
                        email = $scope.usuarios[x].email;
                    }
                }
                //Borramos los equipos que tenía asignados
                $http.post("borrarEquipo.php", { 'idcaso': idCaso, 'nuex': nuex,'base':1 })
                    .success(function () {
                    });
                $http.post("borrarBusesCaso.php", { 'idcaso': idCaso, 'nuex': nuex,'base':1 })
                    .success(function () {
                    });
                    //Actualizamos los casos
                $timeout(function () { insertarEquipo() }, 500);
                $http.post('casos.php', { 'idusuario': usuario,'base':1 }).success(function (data) {
                    $scope.caso = data;
                    ADcaso = data;
                });
                document.getElementById("opciones").style.display = "none";
                document.getElementById("menu").style.display = "none";
                document.getElementById("termotecnia").style.display = "none";
                document.getElementById("pidim").style.display = "none";
                document.getElementById("esquema2").innerHTML = "";
                MostrarSpinner();
                Hparametrico.guardarinstalacion().then(function(val) {
                OcultarSpinner();
                $scope.totalcheckboxcont = 0;
                $scope.combinacionesparametrico = combinacionesparametrico;
                if (val == 1)
                $scope.combinacionesparametrico = [];
                });
            } else {
                alert("ERROR: Los equipos no están correctamente definidos");
            }
        }
        function wait(ms) {
            var start = new Date().getTime();
            var end = start;
            while (end &lt; start + ms) {
                end = new Date().getTime();
            }
        }
        /**

        *Con esta función hacemos una captura de pantalla a la instalación existente

        * @return  {void}

         */
        canvasfunction = function () {
            //Calculamos la altura de la sección
            var i,
                tags = document.getElementById("lineas").getElementsByTagName("*"),
                total = tags.length;
            for (i = 0; i &lt; total; i++) {
                var actual = tags[i].style.left;
                tags[i].style.left = parseFloat(actual) - distancia + "px";
            }
            esquema.style.left = "0px";
            capturar.style.position = 'relative';
            capturar.style.width = "fit-content";
            capturar.style.height = $('#esquema').height() + 80 + "px";
            capturar.style.top = $('#esquema')[0].offsetTop + "px";
            capturar.style.width = parseFloat($('#capturar').width() + 50) + "px";
            html2canvas(capturar).then(canvas => {
                saveAs(canvas.toDataURL());
            });
            /**

            *Con esta función desacargamos la captura y guardamos en la base de datos la drección de la imagen

            * @return  {void}

            */
            function saveAs(uri) {
                $http.post('capturaresquema.php', { 'contenido': uri, 'md5': nombremd5, 'exismod': exismod }).success(function () {
                    capturar.style.position = 'unset';
                }).catch(function (error) {
                    alert('Ha habido un error al capturar el esquema:\r\n ' + error.data + '');
                    capturar.style.position = 'unset';
                    return OcultarSpinner();
                })
            }
        }
        /**

            *Insertamos los equipos

            * @return  {void}

            */
        insertarEquipo = function () {
            var nuex = "";
            if (sistema == 0) {
                nuex = "Existente";
            } else {
                nuex = "Nuevo";
            }
            if (equipos.length > 0) {
                for (var x = 0; x &lt; equipos.length; x++) {
                    //Guardamos los equipos en la base de datos con pequeñas para el equipo batería + inversor
                    if (equipos[x][1].trim() == "Li-ion + Inversor" &amp;&amp; $scope.guardadobateriainversor != undefined &amp;&amp; $scope.bateriainversorseleccionado != undefined &amp;&amp; $scope.guardadobateriainversor.input != undefined) {
                        var valoresinversorbateria = Object.values($scope.bateriainversorseleccionado)
                        $http.post("insertarEquipo.php", {
                            'nombre': equipos[x][1], 'busg': equipos[x][2], 'busa': equipos[x][3], 'nuex': nuex, 'definido': equipos[x][5], 'tipo': equipos[x][6], 'idcaso': idCaso, 'idcontador': equipos[x][8], 'nombreequipo': equipos[x][9], 'tipoequipo': "FVInversoresBateria", 'tipoinstalacion': 0, 'numequiposiguales': equipos[x][10],
                            'atr1': $scope.guardadobateriainversor.select[0],
                            'atr2': $scope.guardadobateriainversor.select[1],
                            'atr3': $scope.guardadobateriainversor.select[2],
                            'atr4': $scope.guardadobateriainversor.input[0],
                            'atr5': $scope.guardadobateriainversor.input[1],
                            'atr6': $scope.guardadobateriainversor.input[2],
                            'atr7': $scope.guardadobateriainversor.input[3],
                            'atr8': $scope.guardadobateriainversor.input[4],
                            'atr9': $scope.guardadobateriainversor.input[5],
                            'atr10': caracteristicas[x][9],
                            'atr11': caracteristicas[x][10],
                            'atr12': caracteristicas[x][11],
                            'atr13': caracteristicas[x][12],
                            'atr14': caracteristicas[x][13],
                            'atr15': caracteristicas[x][14],
                            'atr16': caracteristicas[x][15],
                            'valoresServicio1': valoresinversorbateria[0], 'valoresServicio2': valoresinversorbateria[1], 'valoresServicio3': valoresinversorbateria[2], 'valoresServicio4': valoresinversorbateria[3], 'valoresServicio5': valoresinversorbateria[4], 'valoresServicio6': valoresinversorbateria[5], 'valoresServicio7': valoresinversorbateria[6],
                            'valoresServicio8': valoresinversorbateria[7], 'valoresServicio9': valoresinversorbateria[8], 'valoresServicio10': valoresinversorbateria[9], 'valoresServicio11': valoresinversorbateria[10], 'valoresServicio12': valoresinversorbateria[11], 'valoresServicio13': valoresinversorbateria[12], 'valoresServicio14': valoresinversorbateria[13],
                            'valoresServicio15': valoresinversorbateria[14], 'valoresServicio16': valoresinversorbateria[15], 'valoresServicio17': valoresinversorbateria[16], 'valoresServicio18': valoresinversorbateria[17], 'valoresServicio19': valoresinversorbateria[18], 'valoresServicio20': valoresinversorbateria[19], 'valoresServicio21': valoresinversorbateria[20],
                            'valoresServicio22': valoresinversorbateria[21], 'valoresServicio23': valoresinversorbateria[22], 'valoresServicio24': valoresinversorbateria[23], 'valoresServicio25': valoresinversorbateria[24], 'valoresServicio26': valoresinversorbateria[25], 'valoresServicio27': valoresinversorbateria[26], 'valoresServicio28': valoresinversorbateria[27],
                            'valoresServicio29': valoresinversorbateria[28], 'valoresServicio30': valoresinversorbateria[29], 'valoresServicio31': valoresinversorbateria[30], 'valoresServicio32': valoresinversorbateria[31], 'valoresServicio33': valoresinversorbateria[32], 'valoresServicio34': valoresinversorbateria[33], 'valoresServicio35': valoresinversorbateria[34],
                            'valoresServicio36': valoresinversorbateria[35], 'valoresServicio37': valoresinversorbateria[36], 'valoresServicio38': valoresinversorbateria[37], 'valoresServicio39': valoresinversorbateria[38], 'valoresServicio40': valoresinversorbateria[39], 'valoresServicio41': valoresinversorbateria[40], 'valoresServicio42': valoresinversorbateria[41],
                            'valoresServicio43': valoresinversorbateria[42], 'valoresServicio44': valoresinversorbateria[43], 'valoresServicio45': valoresServiciosComplementos[x][44], 'valoresServicio46': valoresServiciosComplementos[x][45], 'valoresServicio47': valoresServiciosComplementos[x][46], 'valoresServicio48': valoresServiciosComplementos[x][47], 'valoresServicio49': valoresServiciosComplementos[x][48],
                            'valoresServicio50': valoresServiciosComplementos[x][49], 'valoresServicio51': valoresServiciosComplementos[x][50], 'valoresServicio52': valoresServiciosComplementos[x][51], 'valoresServicio53': valoresServiciosComplementos[x][52], 'valoresServicio54': valoresServiciosComplementos[x][53], 'valoresServicio55': valoresServiciosComplementos[x][54], 'valoresServicio56': valoresServiciosComplementos[x][55],
                            'valoresServicio57': valoresServiciosComplementos[x][56], 'valoresServicio58': valoresServiciosComplementos[x][57], 'valoresServicio59': valoresServiciosComplementos[x][58], 'valoresServicio60': valoresServiciosComplementos[x][59], 'valoresServicio61': valoresServiciosComplementos[x][60], 'valoresServicio62': valoresServiciosComplementos[x][61], 'valoresServicio63': valoresServiciosComplementos[x][62],
                            'valoresServicio64': valoresServiciosComplementos[x][63], 'valoresServicio65': valoresServiciosComplementos[x][64], 'valoresServicio66': valoresServiciosComplementos[x][65], 'valoresServicio67': valoresServiciosComplementos[x][66], 'valoresServicio68': valoresServiciosComplementos[x][67], 'valoresServicio69': valoresServiciosComplementos[x][68], 'valoresServicio70': valoresServiciosComplementos[x][69],
                            'valoresServicio71': valoresServiciosComplementos[x][70], 'valoresServicio72': valoresServiciosComplementos[x][71], 'valoresServicio73': valoresServiciosComplementos[x][72], 'valoresServicio74': valoresServiciosComplementos[x][73], 'valoresServicio75': valoresServiciosComplementos[x][74],'base':1
                        })
                    }
                    else
                        $http.post("insertarEquipo.php", {
                            'nombre': equipos[x][1], 'busg': equipos[x][2], 'busa': equipos[x][3], 'nuex': nuex, 'definido': equipos[x][5], 'tipo': equipos[x][6], 'idcaso': idCaso, 'idcontador': equipos[x][8], 'nombreequipo': equipos[x][9], 'tipoequipo': equipos[x][7], 'tipoinstalacion': 0, 'numequiposiguales': equipos[x][10], 'atr1': caracteristicas[x][0], 'atr2': caracteristicas[x][1], 'atr3': caracteristicas[x][2], 'atr4': caracteristicas[x][3], 'atr5': caracteristicas[x][4], 'atr6': caracteristicas[x][5], 'atr7': caracteristicas[x][6], 'atr8': caracteristicas[x][7], 'atr9': caracteristicas[x][8], 'atr10': caracteristicas[x][9], 'atr11': caracteristicas[x][10], 'atr12': caracteristicas[x][11], 'atr13': caracteristicas[x][12], 'atr14': caracteristicas[x][13], 'atr15': caracteristicas[x][14], 'atr16': caracteristicas[x][15], 'valoresServicio1': valoresServiciosComplementos[x][0], 'valoresServicio2': valoresServiciosComplementos[x][1], 'valoresServicio3': valoresServiciosComplementos[x][2], 'valoresServicio4': valoresServiciosComplementos[x][3], 'valoresServicio5': valoresServiciosComplementos[x][4], 'valoresServicio6': valoresServiciosComplementos[x][5], 'valoresServicio7': valoresServiciosComplementos[x][6],
                            'valoresServicio8': valoresServiciosComplementos[x][7], 'valoresServicio9': valoresServiciosComplementos[x][8], 'valoresServicio10': valoresServiciosComplementos[x][9], 'valoresServicio11': valoresServiciosComplementos[x][10], 'valoresServicio12': valoresServiciosComplementos[x][11], 'valoresServicio13': valoresServiciosComplementos[x][12], 'valoresServicio14': valoresServiciosComplementos[x][13],
                            'valoresServicio15': valoresServiciosComplementos[x][14], 'valoresServicio16': valoresServiciosComplementos[x][15], 'valoresServicio17': valoresServiciosComplementos[x][16], 'valoresServicio18': valoresServiciosComplementos[x][17], 'valoresServicio19': valoresServiciosComplementos[x][18], 'valoresServicio20': valoresServiciosComplementos[x][19], 'valoresServicio21': valoresServiciosComplementos[x][20],
                            'valoresServicio22': valoresServiciosComplementos[x][21], 'valoresServicio23': valoresServiciosComplementos[x][22], 'valoresServicio24': valoresServiciosComplementos[x][23], 'valoresServicio25': valoresServiciosComplementos[x][24], 'valoresServicio26': valoresServiciosComplementos[x][25], 'valoresServicio27': valoresServiciosComplementos[x][26], 'valoresServicio28': valoresServiciosComplementos[x][27],
                            'valoresServicio29': valoresServiciosComplementos[x][28], 'valoresServicio30': valoresServiciosComplementos[x][29], 'valoresServicio31': valoresServiciosComplementos[x][30], 'valoresServicio32': valoresServiciosComplementos[x][31], 'valoresServicio33': valoresServiciosComplementos[x][32], 'valoresServicio34': valoresServiciosComplementos[x][33], 'valoresServicio35': valoresServiciosComplementos[x][34],
                            'valoresServicio36': valoresServiciosComplementos[x][35], 'valoresServicio37': valoresServiciosComplementos[x][36], 'valoresServicio38': valoresServiciosComplementos[x][37], 'valoresServicio39': valoresServiciosComplementos[x][38], 'valoresServicio40': valoresServiciosComplementos[x][39], 'valoresServicio41': valoresServiciosComplementos[x][40], 'valoresServicio42': valoresServiciosComplementos[x][41],
                            'valoresServicio43': valoresServiciosComplementos[x][42], 'valoresServicio44': valoresServiciosComplementos[x][43], 'valoresServicio45': valoresServiciosComplementos[x][44], 'valoresServicio46': valoresServiciosComplementos[x][45], 'valoresServicio47': valoresServiciosComplementos[x][46], 'valoresServicio48': valoresServiciosComplementos[x][47], 'valoresServicio49': valoresServiciosComplementos[x][48],
                            'valoresServicio50': valoresServiciosComplementos[x][49], 'valoresServicio51': valoresServiciosComplementos[x][50], 'valoresServicio52': valoresServiciosComplementos[x][51], 'valoresServicio53': valoresServiciosComplementos[x][52], 'valoresServicio54': valoresServiciosComplementos[x][53], 'valoresServicio55': valoresServiciosComplementos[x][54], 'valoresServicio56': valoresServiciosComplementos[x][55],
                            'valoresServicio57': valoresServiciosComplementos[x][56], 'valoresServicio58': valoresServiciosComplementos[x][57], 'valoresServicio59': valoresServiciosComplementos[x][58], 'valoresServicio60': valoresServiciosComplementos[x][59], 'valoresServicio61': valoresServiciosComplementos[x][60], 'valoresServicio62': valoresServiciosComplementos[x][61], 'valoresServicio63': valoresServiciosComplementos[x][62],
                            'valoresServicio64': valoresServiciosComplementos[x][63], 'valoresServicio65': valoresServiciosComplementos[x][64], 'valoresServicio66': valoresServiciosComplementos[x][65], 'valoresServicio67': valoresServiciosComplementos[x][66], 'valoresServicio68': valoresServiciosComplementos[x][67], 'valoresServicio69': valoresServiciosComplementos[x][68], 'valoresServicio70': valoresServiciosComplementos[x][69],
                            'valoresServicio71': valoresServiciosComplementos[x][70], 'valoresServicio72': valoresServiciosComplementos[x][71], 'valoresServicio73': valoresServiciosComplementos[x][72], 'valoresServicio74': valoresServiciosComplementos[x][73], 'valoresServicio75': valoresServiciosComplementos[x][74],'base':1
                        }).success(function (data) {
                            console.log(data);
                        });
                }
                //Actualizamos la lista de equipos
                $http.post('equipos.php', { 'idcaso': idCaso,'base':1 }).success(function (data) {
                    $scope.equipo = data;
                });
                //Guardamos los colectores
                if (colectores.length > 0) {
                    for (var x = 0; x &lt; colectores.length; x++) {
                        $http.post("insertarBusesCaso.php", {
                            'idcaso': idCaso, 'nombre': colectores[x][0], 'idbus': colectores[x][1],
                            'tempmin': colectores[x][3], 'tempmax': colectores[x][2], 'nuex': nuex,
                            'consumoc': colectores[x][4], 'consumof': colectores[x][5], 'consumoacs': colectores[x][6],'base':1 
                        }).success(function (data) {
                            console.log(data);
                        });
                    }
                    $http.post('busesCaso.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                        $scope.busesCaso = data;
                        document.getElementById('referencia').disabled = false;
                        document.getElementById('nuevas').disabled = false;
                    });
                }
            }
            document.getElementById("opciones").style.display = "flex";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("esquema").innerHTML = "";
            document.getElementById("termotecnia").style.display = "initial";
            document.getElementById("pidim").style.display = "initial";

        }
        /**

            *Cargar el caso seleccionado

            * @return  {void}

            */
        abrir = function () {
            var numequiposBD = 0;
            equiposActual = 0;
            var instalacion = "";
            if (exismod == "0") {
                instalacion = "Existente";
                equiposActual = equiposE;
            } else {
                instalacion = "Nuevo";
                equiposActual = equiposN;
            }
            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                if ($scope.equipo[x].nuex == instalacion) {
                    numequiposBD++;
                }
                if ($scope.equipo[x].nuex == instalacion) {

                }
            }

            document.getElementById("menu").style = "left: 43%;background-color: white; width: auto;";
            if (equiposActual == numequiposBD) {

                cont = 1;
                numColector = 1;
                colector = [];
                colectores = [];
                equipos = [];
                caracteristicas = [];
                valoresServiciosComplementos = [];
                numFlechas = [];
                numFlechasInversa = [];
                numLineas = [];
                numLineasInversa = [];
                var edificio = "";
                var contador = 0;
                for (var x = 0; x &lt; $scope.caso.length; x++) {
                    if ($scope.caso[x].nombre == nombreCaso) {
                        edificio = $scope.caso[x].idedificio;
                    }
                }
                cargaNueva = true;
                var menu = "";
                var esquema = "";
                //Creamos de nuevo los botones y su funcionalidad
                menu += "&lt;button class='btnMenu' id='foto' style='background-color:orange; margin-left: 10px;' onclick='guardarCaso()'> Guardar&lt;/button>";
                if (exismod == 0) {
                    menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updatePredefinido(" + edificio + ")'> Existente&lt;/button>";
                    menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2()'> Configurar&lt;/button>";
                } else {
                    menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='cargarTablaNuevo()'> Nuevo&lt;/button>";
                    menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2()'> Configurar&lt;/button>";
                }
                document.getElementById("menu").innerHTML = menu;
                var widthBody = $(document.getElementById("body")).width();
                document.getElementById("menu").style.left = distancia;
                
                cargaNueva = false;
                document.getElementById("esquema").innerHTML = esquema;
                var widthBody = ($(document.getElementById("body")).width() / 2);
                var widthEsquema = ($(document.getElementById("esquema")).width() / 2);
                distancia = widthBody - widthEsquema;
                document.getElementById("esquema").style.left = distancia;
                // document.getElementById("menu").style.left = distancia;
                document.getElementById("esquema2").innerHTML = "";
                document.getElementById("lineas").innerHTML = "";
                for (var x = 0; x &lt; $scope.equipo.length; x++) {
                    //Comprobamos que los casos y el usuario coincidan
                    if ($scope.equipo[x].idcaso == idCaso &amp;&amp; $scope.equipo[x].tipo == "2" &amp;&amp; $scope.equipo[x].nuex == instalacion) {
                        //Comprobamos que sea servicio o uso y creamos el equipo
                        updateBusUso(x, "2", "0");
                        //Cargamos los datos de los equipos
                        equipos[contador][8] = $scope.equipo[x].idcontador;
                        equipos[contador][9] = $scope.equipo[x].nombreequipo;
                        nombreEquipo[contador] = $scope.equipo[x].nombreequipo;
                        caracteristicas[contador][0] = $scope.equipo[x].atr1;
                        caracteristicas[contador][1] = $scope.equipo[x].atr2;
                        caracteristicas[contador][2] = $scope.equipo[x].atr3;
                        caracteristicas[contador][3] = $scope.equipo[x].atr4;
                        caracteristicas[contador][4] = $scope.equipo[x].atr5;
                        caracteristicas[contador][5] = $scope.equipo[x].atr6;
                        caracteristicas[contador][6] = $scope.equipo[x].atr7;
                        caracteristicas[contador][7] = $scope.equipo[x].atr8;
                        caracteristicas[contador][8] = $scope.equipo[x].atr9;
                        caracteristicas[contador][9] = $scope.equipo[x].atr10;
                        caracteristicas[contador][10] = $scope.equipo[x].atr11;
                        caracteristicas[contador][11] = $scope.equipo[x].atr12;
                        caracteristicas[contador][12] = $scope.equipo[x].atr13;
                        caracteristicas[contador][13] = $scope.equipo[x].atr14;
                        caracteristicas[contador][14] = $scope.equipo[x].atr15;
                        caracteristicas[contador][15] = $scope.equipo[x].atr16;
                        valoresServiciosComplementos[contador][0] = $scope.equipo[x].valoresservicio1;
                        valoresServiciosComplementos[contador][1] = $scope.equipo[x].valoresservicio2;
                        valoresServiciosComplementos[contador][2] = $scope.equipo[x].valoresservicio3;
                        valoresServiciosComplementos[contador][3] = $scope.equipo[x].valoresservicio4;
                        valoresServiciosComplementos[contador][4] = $scope.equipo[x].valoresservicio5;
                        valoresServiciosComplementos[contador][5] = $scope.equipo[x].valoresservicio6;
                        valoresServiciosComplementos[contador][6] = $scope.equipo[x].valoresservicio7;
                        valoresServiciosComplementos[contador][7] = $scope.equipo[x].valoresservicio8;
                        valoresServiciosComplementos[contador][8] = $scope.equipo[x].valoresservicio9;
                        valoresServiciosComplementos[contador][9] = $scope.equipo[x].valoresservicio10;
                        valoresServiciosComplementos[contador][10] = $scope.equipo[x].valoresservicio11;
                        valoresServiciosComplementos[contador][11] = $scope.equipo[x].valoresservicio12;
                        valoresServiciosComplementos[contador][12] = $scope.equipo[x].valoresservicio13;
                        valoresServiciosComplementos[contador][13] = $scope.equipo[x].valoresservicio14;
                        valoresServiciosComplementos[contador][14] = $scope.equipo[x].valoresservicio15;
                        valoresServiciosComplementos[contador][15] = $scope.equipo[x].valoresservicio16;
                        valoresServiciosComplementos[contador][16] = $scope.equipo[x].valoresservicio17;
                        valoresServiciosComplementos[contador][17] = $scope.equipo[x].valoresservicio18;
                        valoresServiciosComplementos[contador][18] = $scope.equipo[x].valoresservicio19;
                        valoresServiciosComplementos[contador][19] = $scope.equipo[x].valoresservicio20;
                        valoresServiciosComplementos[contador][20] = $scope.equipo[x].valoresservicio21;
                        valoresServiciosComplementos[contador][21] = $scope.equipo[x].valoresservicio22;
                        valoresServiciosComplementos[contador][22] = $scope.equipo[x].valoresservicio23;
                        valoresServiciosComplementos[contador][23] = $scope.equipo[x].valoresservicio24;
                        valoresServiciosComplementos[contador][24] = $scope.equipo[x].valoresservicio25;
                        valoresServiciosComplementos[contador][25] = $scope.equipo[x].valoresservicio26;
                        valoresServiciosComplementos[contador][26] = $scope.equipo[x].valoresservicio27;
                        valoresServiciosComplementos[contador][27] = $scope.equipo[x].valoresservicio28;
                        valoresServiciosComplementos[contador][28] = $scope.equipo[x].valoresservicio29;
                        valoresServiciosComplementos[contador][29] = $scope.equipo[x].valoresservicio30;
                        valoresServiciosComplementos[contador][30] = $scope.equipo[x].valoresservicio31;
                        valoresServiciosComplementos[contador][31] = $scope.equipo[x].valoresservicio32;
                        valoresServiciosComplementos[contador][32] = $scope.equipo[x].valoresservicio33;
                        valoresServiciosComplementos[contador][33] = $scope.equipo[x].valoresservicio34;
                        valoresServiciosComplementos[contador][34] = $scope.equipo[x].valoresservicio35;
                        valoresServiciosComplementos[contador][35] = $scope.equipo[x].valoresservicio36;
                        valoresServiciosComplementos[contador][36] = $scope.equipo[x].valoresservicio37;
                        valoresServiciosComplementos[contador][37] = $scope.equipo[x].valoresservicio38;
                        valoresServiciosComplementos[contador][38] = $scope.equipo[x].valoresservicio39;
                        valoresServiciosComplementos[contador][39] = $scope.equipo[x].valoresservicio40;
                        valoresServiciosComplementos[contador][40] = $scope.equipo[x].valoresservicio41;
                        valoresServiciosComplementos[contador][41] = $scope.equipo[x].valoresservicio42;
                        valoresServiciosComplementos[contador][42] = $scope.equipo[x].valoresservicio43;
                        valoresServiciosComplementos[contador][43] = $scope.equipo[x].valoresservicio44;
                        valoresServiciosComplementos[contador][44] = $scope.equipo[x].valoresservicio45;
                        valoresServiciosComplementos[contador][45] = $scope.equipo[x].valoresservicio46;
                        valoresServiciosComplementos[contador][46] = $scope.equipo[x].valoresservicio47;
                        valoresServiciosComplementos[contador][47] = $scope.equipo[x].valoresservicio48;
                        valoresServiciosComplementos[contador][48] = $scope.equipo[x].valoresservicio49;
                        valoresServiciosComplementos[contador][49] = $scope.equipo[x].valoresservicio50;
                        valoresServiciosComplementos[contador][50] = $scope.equipo[x].valoresservicio51;
                        valoresServiciosComplementos[contador][51] = $scope.equipo[x].valoresservicio52;
                        valoresServiciosComplementos[contador][52] = $scope.equipo[x].valoresservicio53;
                        valoresServiciosComplementos[contador][53] = $scope.equipo[x].valoresservicio54;
                        valoresServiciosComplementos[contador][54] = $scope.equipo[x].valoresservicio55;
                        valoresServiciosComplementos[contador][55] = $scope.equipo[x].valoresservicio56;
                        valoresServiciosComplementos[contador][56] = $scope.equipo[x].valoresservicio57;
                        valoresServiciosComplementos[contador][57] = $scope.equipo[x].valoresservicio58;
                        valoresServiciosComplementos[contador][58] = $scope.equipo[x].valoresservicio59;
                        valoresServiciosComplementos[contador][59] = $scope.equipo[x].valoresservicio60;
                        valoresServiciosComplementos[contador][60] = $scope.equipo[x].valoresservicio61;
                        valoresServiciosComplementos[contador][61] = $scope.equipo[x].valoresservicio62;
                        valoresServiciosComplementos[contador][62] = $scope.equipo[x].valoresservicio63;
                        valoresServiciosComplementos[contador][63] = $scope.equipo[x].valoresservicio64;
                        valoresServiciosComplementos[contador][64] = $scope.equipo[x].valoresservicio65;
                        valoresServiciosComplementos[contador][65] = $scope.equipo[x].valoresservicio66;
                        valoresServiciosComplementos[contador][66] = $scope.equipo[x].valoresservicio67;
                        valoresServiciosComplementos[contador][67] = $scope.equipo[x].valoresservicio68;
                        valoresServiciosComplementos[contador][68] = $scope.equipo[x].valoresservicio69;
                        valoresServiciosComplementos[contador][69] = $scope.equipo[x].valoresservicio70;
                        valoresServiciosComplementos[contador][70] = $scope.equipo[x].valoresservicio71;
                        valoresServiciosComplementos[contador][71] = $scope.equipo[x].valoresservicio72;
                        valoresServiciosComplementos[contador][72] = $scope.equipo[x].valoresservicio73;
                        valoresServiciosComplementos[contador][73] = $scope.equipo[x].valoresservicio74;
                        valoresServiciosComplementos[contador][74] = $scope.equipo[x].valoresservicio75;
                        contador++;
                    }
                }
                for (var x = 0; x &lt; $scope.equipo.length; x++) {
                    //Comprobamos que los casos y el usuario coincidan
                    if ($scope.equipo[x].idcaso == idCaso &amp;&amp; $scope.equipo[x].tipo != "2" &amp;&amp; $scope.equipo[x].nuex == instalacion) {
                        //Comprobamos que sea servicio o uso y creamos el equipo
                        if ($scope.equipo[x].tipo == "1") {
                            updateTable(x, "2", "1");
                        } else if ($scope.equipo[x].tipo == "3") {
                            updateComplemento(x, "2", "0");
                        } else if ($scope.equipo[x].tipo == "4") {
                            updateTable(x, "2", "4");
                        }
                        //Cargamos los datos de los equipos
                        equipos[contador][8] = $scope.equipo[x].idcontador;
                        equipos[contador][9] = $scope.equipo[x].nombreequipo;
                        nombreEquipo[contador] = $scope.equipo[x].nombreequipo;
                        caracteristicas[contador][0] = $scope.equipo[x].atr1;
                        caracteristicas[contador][1] = $scope.equipo[x].atr2;
                        caracteristicas[contador][2] = $scope.equipo[x].atr3;
                        caracteristicas[contador][3] = $scope.equipo[x].atr4;
                        caracteristicas[contador][4] = $scope.equipo[x].atr5;
                        caracteristicas[contador][5] = $scope.equipo[x].atr6;
                        caracteristicas[contador][6] = $scope.equipo[x].atr7;
                        caracteristicas[contador][7] = $scope.equipo[x].atr8;
                        caracteristicas[contador][8] = $scope.equipo[x].atr9;
                        caracteristicas[contador][9] = $scope.equipo[x].atr10;
                        caracteristicas[contador][10] = $scope.equipo[x].atr11;
                        caracteristicas[contador][11] = $scope.equipo[x].atr12;
                        caracteristicas[contador][12] = $scope.equipo[x].atr13;
                        caracteristicas[contador][13] = $scope.equipo[x].atr14;
                        caracteristicas[contador][14] = $scope.equipo[x].atr15;
                        caracteristicas[contador][15] = $scope.equipo[x].atr16;
                        valoresServiciosComplementos[contador][0] = $scope.equipo[x].valoresservicio1;
                        valoresServiciosComplementos[contador][1] = $scope.equipo[x].valoresservicio2;
                        valoresServiciosComplementos[contador][2] = $scope.equipo[x].valoresservicio3;
                        valoresServiciosComplementos[contador][3] = $scope.equipo[x].valoresservicio4;
                        valoresServiciosComplementos[contador][4] = $scope.equipo[x].valoresservicio5;
                        valoresServiciosComplementos[contador][5] = $scope.equipo[x].valoresservicio6;
                        valoresServiciosComplementos[contador][6] = $scope.equipo[x].valoresservicio7;
                        valoresServiciosComplementos[contador][7] = $scope.equipo[x].valoresservicio8;
                        valoresServiciosComplementos[contador][8] = $scope.equipo[x].valoresservicio9;
                        valoresServiciosComplementos[contador][9] = $scope.equipo[x].valoresservicio10;
                        valoresServiciosComplementos[contador][10] = $scope.equipo[x].valoresservicio11;
                        valoresServiciosComplementos[contador][11] = $scope.equipo[x].valoresservicio12;
                        valoresServiciosComplementos[contador][12] = $scope.equipo[x].valoresservicio13;
                        valoresServiciosComplementos[contador][13] = $scope.equipo[x].valoresservicio14;
                        valoresServiciosComplementos[contador][14] = $scope.equipo[x].valoresservicio15;
                        valoresServiciosComplementos[contador][15] = $scope.equipo[x].valoresservicio16;
                        valoresServiciosComplementos[contador][16] = $scope.equipo[x].valoresservicio17;
                        valoresServiciosComplementos[contador][17] = $scope.equipo[x].valoresservicio18;
                        valoresServiciosComplementos[contador][18] = $scope.equipo[x].valoresservicio19;
                        valoresServiciosComplementos[contador][19] = $scope.equipo[x].valoresservicio20;
                        valoresServiciosComplementos[contador][20] = $scope.equipo[x].valoresservicio21;
                        valoresServiciosComplementos[contador][21] = $scope.equipo[x].valoresservicio22;
                        valoresServiciosComplementos[contador][22] = $scope.equipo[x].valoresservicio23;
                        valoresServiciosComplementos[contador][23] = $scope.equipo[x].valoresservicio24;
                        valoresServiciosComplementos[contador][24] = $scope.equipo[x].valoresservicio25;
                        valoresServiciosComplementos[contador][25] = $scope.equipo[x].valoresservicio26;
                        valoresServiciosComplementos[contador][26] = $scope.equipo[x].valoresservicio27;
                        valoresServiciosComplementos[contador][27] = $scope.equipo[x].valoresservicio28;
                        valoresServiciosComplementos[contador][28] = $scope.equipo[x].valoresservicio29;
                        valoresServiciosComplementos[contador][29] = $scope.equipo[x].valoresservicio30;
                        valoresServiciosComplementos[contador][30] = $scope.equipo[x].valoresservicio31;
                        valoresServiciosComplementos[contador][31] = $scope.equipo[x].valoresservicio32;
                        valoresServiciosComplementos[contador][32] = $scope.equipo[x].valoresservicio33;
                        valoresServiciosComplementos[contador][33] = $scope.equipo[x].valoresservicio34;
                        valoresServiciosComplementos[contador][34] = $scope.equipo[x].valoresservicio35;
                        valoresServiciosComplementos[contador][35] = $scope.equipo[x].valoresservicio36;
                        valoresServiciosComplementos[contador][36] = $scope.equipo[x].valoresservicio37;
                        valoresServiciosComplementos[contador][37] = $scope.equipo[x].valoresservicio38;
                        valoresServiciosComplementos[contador][38] = $scope.equipo[x].valoresservicio39;
                        valoresServiciosComplementos[contador][39] = $scope.equipo[x].valoresservicio40;
                        valoresServiciosComplementos[contador][40] = $scope.equipo[x].valoresservicio41;
                        valoresServiciosComplementos[contador][41] = $scope.equipo[x].valoresservicio42;
                        valoresServiciosComplementos[contador][42] = $scope.equipo[x].valoresservicio43;
                        valoresServiciosComplementos[contador][43] = $scope.equipo[x].valoresservicio44;
                        valoresServiciosComplementos[contador][44] = $scope.equipo[x].valoresservicio45;
                        valoresServiciosComplementos[contador][45] = $scope.equipo[x].valoresservicio46;
                        valoresServiciosComplementos[contador][46] = $scope.equipo[x].valoresservicio47;
                        valoresServiciosComplementos[contador][47] = $scope.equipo[x].valoresservicio48;
                        valoresServiciosComplementos[contador][48] = $scope.equipo[x].valoresservicio49;
                        valoresServiciosComplementos[contador][49] = $scope.equipo[x].valoresservicio50;
                        valoresServiciosComplementos[contador][50] = $scope.equipo[x].valoresservicio51;
                        valoresServiciosComplementos[contador][51] = $scope.equipo[x].valoresservicio52;
                        valoresServiciosComplementos[contador][52] = $scope.equipo[x].valoresservicio53;
                        valoresServiciosComplementos[contador][53] = $scope.equipo[x].valoresservicio54;
                        valoresServiciosComplementos[contador][54] = $scope.equipo[x].valoresservicio55;
                        valoresServiciosComplementos[contador][55] = $scope.equipo[x].valoresservicio56;
                        valoresServiciosComplementos[contador][56] = $scope.equipo[x].valoresservicio57;
                        valoresServiciosComplementos[contador][57] = $scope.equipo[x].valoresservicio58;
                        valoresServiciosComplementos[contador][58] = $scope.equipo[x].valoresservicio59;
                        valoresServiciosComplementos[contador][59] = $scope.equipo[x].valoresservicio60;
                        valoresServiciosComplementos[contador][60] = $scope.equipo[x].valoresservicio61;
                        valoresServiciosComplementos[contador][61] = $scope.equipo[x].valoresservicio62;
                        valoresServiciosComplementos[contador][62] = $scope.equipo[x].valoresservicio63;
                        valoresServiciosComplementos[contador][63] = $scope.equipo[x].valoresservicio64;
                        valoresServiciosComplementos[contador][64] = $scope.equipo[x].valoresservicio65;
                        valoresServiciosComplementos[contador][65] = $scope.equipo[x].valoresservicio66;
                        valoresServiciosComplementos[contador][66] = $scope.equipo[x].valoresservicio67;
                        valoresServiciosComplementos[contador][67] = $scope.equipo[x].valoresservicio68;
                        valoresServiciosComplementos[contador][68] = $scope.equipo[x].valoresservicio69;
                        valoresServiciosComplementos[contador][69] = $scope.equipo[x].valoresservicio70;
                        valoresServiciosComplementos[contador][70] = $scope.equipo[x].valoresservicio71;
                        valoresServiciosComplementos[contador][71] = $scope.equipo[x].valoresservicio72;
                        valoresServiciosComplementos[contador][72] = $scope.equipo[x].valoresservicio73;
                        valoresServiciosComplementos[contador][73] = $scope.equipo[x].valoresservicio74;
                        valoresServiciosComplementos[contador][74] = $scope.equipo[x].valoresservicio75;
                        contador++;
                    }
                }
            } else {
                equiposE=0;
                equiposN=0;
                $http.post('equipos.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                    $scope.equipo = data;
                    for (var x = 0; x &lt; $scope.equipo.length; x++) {
                        if ($scope.equipo[x].nuex == "Nuevo") {
                            equiposN++;
                        }
                        if ($scope.equipo[x].nuex == "Existente") {
                            equiposE++;
                        }
                    }
                    abrir();
                });
            }
        }
        /**

            *Cargamos el caso en una nueva pestaña

        
            * @param  {string}
            * @return  {void}

            */
        updateCaso = function (num, caso) {
            var existe = false;
            var num2 = 0;
            var numCaso = "";
            sessionStorage.setItem("caso", caso);
            sessionStorage.setItem("abierto", true);
            if (equipos.length > 0) {
                //Si el caso no tiene nombre o está recién cargado le asiganmos un nombre
                if (pre == true &amp;&amp; datosCasos[0] == "0" &amp;&amp; datosCasos[0] != "-") {
                    var name = prompt("Por favor, introduzca un nombre para el caso");
                    nombreCaso = name;
                } else if (datosCasos[0] != "0" &amp;&amp; datosCasos[0] != "-") {
                    nombreCaso = datosCasos[0];
                }
                if (nombreCaso != '' &amp;&amp; nombreCaso != null) {
                    document.getElementById("nombre").value = nombreCaso;
                    for (var x = 0; x &lt; $scope.caso.length; x++) {
                        //Comprobamos si el equipo existe en la base de datos
                        if (nombreCaso == $scope.caso[x].nombre &amp;&amp; usuario == $scope.caso[x].usuario &amp;&amp; num == $scope.caso[x].tipo) {
                            existe = true;
                        }
                    }
                    if (existe == false) {
                        //Le asignamos un id en función de los valores de la tabla de datos
                        if (('' + $scope.caso).length > 0) {
                            for (var i = 0; i &lt; $scope.caso.length; i++) {
                                if (!numCaso || parseInt($scope.caso[i].id) > parseInt(numCaso))
                                    numCaso = $scope.caso[i].id;
                                numCaso = parseInt(numCaso) + 1;
                            }
                        } else {
                            numCaso = "1";
                        }
                        cambiosCasoE = false;
                        cambiosCasoN = false;
                        //Insertamos el caso
                        $http.post("insertarCaso.php", {
                            'id': 3, 'nombre': nombreCaso, 'idusuario': usuario, 'idedificio': edificio, 'carpeta': email, 'usoEdificio': datosCasos[1],
                            'superficie': datosCasos[2], 'altura': datosCasos[3], 'plantasSobre': datosCasos[4], 'plantasBajo': datosCasos[5], 'comunidad': datosCasos[6],
                            'provincia': datosCasos[7], 'localidad': datosCasos[8], 'postal': datosCasos[9], 'via': datosCasos[10], 'nombreVia': datosCasos[11],
                            'numero': datosCasos[12], 'portal': datosCasos[13], 'escalera': datosCasos[14], 'piso': datosCasos[15], 'puerta': datosCasos[16], 'bloque': datosCasos[17],
                            'periodo': datosCasos[18], 'nivel': datosCasos[19], 'tiponum': "num", 'clima': datosCasos[20], 'consim': datosCasos[21], 'tempalta': datosCasos[22], 'mesinicial': datosCasos[23],
                            'tempbaja': datosCasos[24], 'mesfinal': datosCasos[25], 'impedircalefaccion': datosCasos[26], 'vennocturna': datosCasos[27], 'solove': soloVE, 'base':1 
                        }).success(function (data) {
                            console.log(data);
                        });
                        //Insertamos los equipos en la tabla de datos
                        $timeout(function () { insertarEquipo(num) }, 500);
                        //Comprobamos si hay cambios en los datos del caso
                    } else if (cambiosCasoE == true || cambiosCasoN == true) {
                        //Volvemos a comprobar el id de los casos para volver a asignárselo
                        if (('' + $scope.caso).length > 0) {
                            for (var i = 0; i &lt; $scope.caso.length; i++) {
                                if (!numCaso || parseInt($scope.caso[i].id) > parseInt(numCaso))
                                    numCaso = $scope.caso[i].id;
                                numCaso = parseInt(numCaso) + 1;
                            }
                        } else {
                            numCaso = "1";
                        }
                        if (num == "0") {
                            cambiosCasoE = false;
                        } else if (num == "1") {
                            cambiosCasoN = false;
                        }
                        //Actualizamos el caso con los nuevos datos
                        $http.post("updateCaso.php", {
                            'id': 3, 'nombre': nombreCaso, 'idusuario': usuario, 'idedificio': edificio, 'carpeta': email, 'usoEdificio': datosCasos[1],
                            'superficie': datosCasos[2], 'altura': datosCasos[3], 'plantasSobre': datosCasos[4], 'plantasBajo': datosCasos[5], 'comunidad': datosCasos[6],
                            'provincia': datosCasos[7], 'localidad': datosCasos[8], 'postal': datosCasos[9], 'via': datosCasos[10], 'nombreVia': datosCasos[11],
                            'numero': datosCasos[12], 'portal': datosCasos[13], 'escalera': datosCasos[14], 'piso': datosCasos[15], 'puerta': datosCasos[16], 'bloque': datosCasos[17],
                            'periodo': datosCasos[18], 'nivel': datosCasos[19], 'tiponum': "num", 'clima': datosCasos[20], 'consim': datosCasos[21], 'tempalta': datosCasos[22], 'mesinicial': datosCasos[23],
                            'tempbaja': datosCasos[24], 'mesfinal': datosCasos[25], 'impedircalefaccion': datosCasos[26], 'vennocturna': datosCasos[27], 'solove': soloVE,'base':1 
                        })
                            .success(function (data) {
                                console.log(data);
                            });
                        //Borramos los equipos asigandos al caso correspondiente y el tipo de caso
                        $http.post("borrarEquipo.php", { 'idcaso': nombreCaso, 'tipoinstalacion': "0",'base':1  })
                            .success(function (data) {
                                console.log(data);
                            });
                        //Volvemos a introducir los equipos
                        $timeout(function () { insertarEquipo(num) }, 500);
                    }
                    else {
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            if (nombreCaso == $scope.equipo[x].caso &amp;&amp; usuario == $scope.equipo[x].usuario &amp;&amp; num == $scope.equipo[x].tipocaso) {
                                num2 = parseInt($scope.equipo[x].id);
                                break;
                            }
                        }
                        //Borramos los equipos asigandos al caso correspondiente y el tipo de caso
                        $http.post("borrarEquipo.php", { 'idcaso': nombreCaso, 'tipoinstalacion ': "0",'base':1  })
                            .success(function (data) {
                                console.log(data);
                            });
                        //Volvemos a introducir los equipos
                        $timeout(function () { insertarEquipo(num) }, 500);
                    }
                    //Abrimos el caso en una nueva pestaña
                    window.open("index2.html", "_blank");
                } else {
                    alert("La operación de guardado ha sido cancelada");
                    window.open("index2.html", "_blank");
                }
            }
            window.open("index2.html", "_blank");
        }
        /**

            *Cargamos los buses en función del equipo uso seleccionado

        
            * @param  {number}
            * @return  {void}

            */
        updateUso = function (tipo) {
            var hayAutoF = false;
            var hayAutoC = false;
            if (tipo == 1) { document.getElementById("usosheader").innerText = "Térmico" };
            if (tipo == 2) { document.getElementById("usosheader").innerText = "Eléctrico" };
            if (tipo == 3) { document.getElementById("usosheader").innerText = "Autónomo" };
            var servs = "";
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][1] == "Autónomo Cal.") {
                    hayAutoC = true;
                }
                if (equipos[x][1] == "Autónomo Ref.") {
                    hayAutoF = true;
                }
            }
            for (var x = 0; x &lt; $scope.uso.length; x++) {
                //Comprobamos su tipo y si son iguales creamos los buses con los que puede conectarse tanto para genera como alimenta
                if ($scope.uso[x].idtipouso == tipo) {
                    if ($scope.uso[x].id == "17" &amp;&amp; hayAutoC == true) {

                    } else if ($scope.uso[x].id == "18" &amp;&amp; hayAutoF == true) {

                    } else {
                        servs += "&lt;button class='mostrarSer' onclick='updateBusesUso(" + $scope.uso[x].id + ")'data-dismiss='modal' data-toggle='modal' data-target='#myModalUso3'>" + $scope.uso[x].nombre + "&lt;/button>\n&lt;br/>\n";
                    }
                }
            }
            //Los almacenamos en la ventana emergente y cerramos la ventana de elección de usos
            document.getElementById("usos").innerHTML = servs;
            $('#myModalUso2').modal('hide');
        }
        /**

            *Activamos los buses cuando se pulsa el botón radio pulsado

        
            * @param  {number}
            * @return  {void}

            */
        cargarBuses = function (bus) {
            var lineas = new Array();
            var flechas = new Array();
            var lineasI = new Array();
            var flechasI = new Array();
            //Distinguimos caso en función de si el botón radio se selecciona o deselecciona
            //Comprobamos si se ha creado algún botón ya que en ese caso también se han generado los buses

            //Lo mismo para el caso contrario, se comprueba si los buses se han generado y en este caso se hacen invisibles
            //Comprobamos si hay líneas y flechas creadas
            if (lineasCreadas[bus - 1] == true &amp;&amp; document.getElementsByClassName('connectingLines' + bus).length > 0) {
                var retVal = confirm("Si deselecciona el colector se borrarán también los equipos y usos conectados con él, ¿está de acuerdo?");
                //str.slice(-1);
                if (retVal == true) {
                    if (lineasCreadas[bus - 1] == true) {
                        //Hacemos visible todas las líneas y flechas que se unan a ese bus
                        for (var x = 0; x &lt; document.getElementsByClassName("connectingLines" + bus).length; x++) {
                            document.getElementsByClassName("connectingLines" + bus)[x].style.visibility = "visible";
                            document.getElementsByClassName("flecha" + bus)[x].style.visibility = "visible";
                        }
                    }
                    var numero = document.getElementsByClassName("connectingLines" + bus).length - 1;
                    for (var x = 0; x &lt; (numero + 1); x++) {
                        var str = $(document.getElementsByClassName("connectingLines" + bus)[numero - x]).attr('id');
                        //Eliminamos el botón de equipo
                        if (str.length > 9) {
                            var slice = str.length - 8;
                            slice = slice * -1;
                            str = str.slice(slice);
                        } else {
                            str = str.slice(-1);
                        }
                        str = parseInt(str);
                        $("#trSer" + str).remove();
                        $("#trSerEspacio" + str).remove();
                        //Quitamos el equipo de la lista equipo
                        for (var a = 0; a &lt; equipos.length; a++) {
                            var equipo = equipos[a];
                            equipo = equipo.indexOf(str);
                            if (equipos[a][0] == str) {
                                equipos.splice(a, 1);
                            }
                        }
                        if (numLineas.length > 0) {
                            //Recorremos el array de las líneas
                            for (var y = 0; y &lt; numLineas.length; y++) {
                                //Comprobamos si existe línea genera
                                if (str == numLineas[y]) {
                                    lineas.push(str);
                                }
                                if (str &lt; numLineas[y]) {
                                    //Recalculamos la altura de la línea
                                    alturaL = $(document.getElementById("lineaSer" + numLineas[y])).position().top;
                                    document.getElementById("lineaSer" + numLineas[y]).style.top = alturaL - 80;
                                }
                            }
                        }
                        //Comprobamos si hay flechas genera creadas después del botón borrado
                        if (numFlechas.length > 0) {
                            //Recorremos el array de las flechas genera
                            for (var y = 0; y &lt; numFlechas.length; y++) {
                                //Comprobamos si existe flecha genera
                                if (str == numFlechas[y]) {
                                    flechas.push(str);
                                    //En caso afirmativo la borramos
                                }
                                if (str &lt; numFlechas[y]) {
                                    //Recalculamos la altura de la línea
                                    alturaL = $(document.getElementById("flechaSer" + numFlechas[y])).position().top;
                                    document.getElementById("flechaSer" + numFlechas[y]).style.top = alturaL - 87.5;
                                }
                            }
                        }
                        //Comprobamos si hay flechas alimenta creadas después del botón borrado
                        if (numFlechasInversa.length > 0) {
                            //Recorremos el array de las línea alimenta
                            for (var y = 0; y &lt; numFlechasInversa.length; y++) {
                                //Comprobamos si existe línea alimenta
                                if (str == numFlechasInversa[y]) {
                                    flechasI.push(str);
                                    //En caso afirmativo la borramos
                                }
                                if (str &lt; numFlechasInversa[y]) {
                                    //Recalculamos la altura de la línea
                                    alturaL = $(document.getElementById("flechaSerInversa" + numFlechasInversa[y])).position().top;
                                    document.getElementById("flechaSerInversa" + numFlechasInversa[y]).style.top = alturaL - 87.5;
                                }
                            }
                        }
                        //Comprobamos si hay líneas alimenta creadas después del botón borrado
                        if (numLineasInversa.length > 0) {
                            //Recorremos el array de las líneas alimenta
                            for (var y = 0; y &lt; numLineasInversa.length; y++) {
                                //Comprobamos si existe líneas alimenta
                                if (str == numLineasInversa[y]) {
                                    lineasI.push(str);
                                }
                                if (str &lt; numLineasInversa[y]) {
                                    //Recalculamos la altura de la línea
                                    alturaL = $(document.getElementById("lineaSerInversa" + numLineasInversa[y])).position().top;
                                    document.getElementById("lineaSerInversa" + numLineasInversa[y]).style.top = alturaL - 80;
                                }
                            }
                        }
                    }
                    //Removemos el elemento de la lista y de la tabla
                    if (lineas.length > 0) {
                        for (var z = 0; z &lt; lineas.length; z++) {
                            //En caso genera y alimenta borramos también la línea y flecha contraria
                            var str2 = $(document.getElementById("lineaSer" + lineas[z])).attr('class');
                            str2 = str2.slice(-1);
                            str2 = parseInt(str2);
                            //Borramos el elemento correspondiente
                            $("#lineaSer" + lineas[z]).remove();
                            var index = numLineas.indexOf(lineas[z]);
                            if (index > -1) {
                                numLineas.splice(index, 1);
                            }
                            //Si el bus al que va la otra flecha y línea está vacío desconectamos el bus y el radio
                            if (document.getElementsByClassName("connectingLines" + str2).length == 0) {
                                for (var y = 0; y &lt; document.getElementsByClassName("bus" + str2).length; y++) {
                                    document.getElementsByClassName("bus" + str2)[y].style.visibility = "hidden";
                                }
                            }
                        }
                    }
                    //Removemos el elemento de la lista y de la tabla
                    if (flechas.length > 0) {
                        for (var z = 0; z &lt; flechas.length; z++) {
                            //Borramos el elemento correspondiente
                            $("#flechaSer" + flechas[z]).remove();
                            var index = numFlechas.indexOf(flechas[z]);
                            if (index > -1) {
                                numFlechas.splice(index, 1);
                            }
                        }
                    }
                    //Removemos el elemento de la lista y de la tabla
                    if (flechasI.length > 0) {
                        for (var z = 0; z &lt; flechasI.length; z++) {
                            //Borramos el elemento correspondiente
                            $("#flechaSerInversa" + flechasI[z]).remove();
                            var index = numFlechasInversa.indexOf(flechasI[z]);
                            if (index > -1) {
                                numFlechasInversa.splice(index, 1);
                            }
                        }
                    }
                    //Removemos el elemento de la lista y de la tabla
                    if (lineasI.length > 0) {
                        for (var z = 0; z &lt; lineasI.length; z++) {
                            //En caso genera y alimenta borramos también la línea y flecha contraria
                            var str2 = $(document.getElementById("lineaSerInversa" + lineasI[z])).attr('class');
                            str2 = str2.slice(-1);
                            str2 = parseInt(str2);
                            //Borramos el elemento correspondiente
                            $("#lineaSerInversa" + lineasI[z]).remove();
                            var index = numLineasInversa.indexOf(lineasI[z]);
                            if (index > -1) {
                                numLineasInversa.splice(index, 1);
                            }
                            //Si el bus al que va la otra flecha y línea está vacío desconectamos el bus y el radio
                            if (document.getElementsByClassName("connectingLines" + str2).length == 0) {
                                document.getElementById("radio" + str2).checked = false;
                                for (var y = 0; y &lt; document.getElementsByClassName("bus" + str2).length; y++) {
                                    document.getElementsByClassName("bus" + str2)[y].style.visibility = "hidden";
                                }
                            }
                        }
                    }
                    lineasCreadas[bus - 1] = false;
                    document.getElementById("radio" + bus).checked = false;
                }
            } else {
                lineasCreadas[bus - 1] = false;
                document.getElementById("radio" + bus).checked = false;
                for (var y = 0; y &lt; document.getElementsByClassName("bus" + bus).length; y++) {
                    document.getElementsByClassName("bus" + bus)[y].style.visibility = "hidden";
                }
            }

        }
        /**

            *Cargamos el menú principal al pulsar el botón Aceptar del 2º menú

            * @return  {void}

            */
        updatePrincipal = function () {
            document.getElementById("menu").style = "left: 43%;background-color: white;    width: auto;";
            var edificio = "";
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                if ($scope.caso[x].nombre == nombreCaso) {
                    edificio = $scope.caso[x].idedificio;
                }
            }
            var menu = "";
            //Creamos de nuevo los botones y su funcionalidad
            menu += "&lt;button class='btnMenu' id='foto' style='background-color:orange;margin-left: 10px;' onclick='guardarCaso()'> Guardar&lt;/button>";
            if (exismod == 0) {
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updatePredefinido(" + edificio + ")'> Existente&lt;/button>";
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2()'> Configurar&lt;/button>";
            } else {
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='cargarTablaNuevo()'> Nuevo&lt;/button>";
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2()'> Configurar&lt;/button>";
            }
            document.getElementById("menu").innerHTML = menu;
                }
        
        /**

            *Cargamos el tercer menú al seleccionar configurar del 2º menú

            * @return  {void}

            */
        updateMenu2 = function () {
            document.getElementById("menu").style = "left: 40%;background-color: white;width: auto;"
            var menu = "";
            if (sistema == 0) {
                menu += "&lt;button class='btnMenu' data-toggle='modal' onclick='updateServsEx()'data-target='#myModal'> Añadir equipo&lt;/button >&lt;/td >";
            } else {
                menu += "&lt;button class='btnMenu' data-toggle='modal' style='margin-left: 10px;' onclick='updateTiposEquipos()'data-target='#myModal'> Añadir equipo&lt;/button >&lt;/td >";
            }
            menu += "&lt;button class='btnMenu' data-toggle='modal'style='margin-left: 10px;' onclick='updateTiposComplemento()'data-target='#myModalComplemento'> Añadir complemento&lt;/button >&lt;/td >";
            menu += "&lt;button class='btnMenu' data-toggle='modal' style='margin-left: 10px;' data-target='#myModalUso'> Añadir Servicio&lt;/button >&lt;/td >";
            menu += "&lt;button class='btnMenu' id='foto' style='background-color:orange;margin-left: 10px;' onclick='guardarCaso()'> Guardar&lt;/button >&lt;/td >";
            menu += "&lt;button class='btnMenu' onclick='updateEquipos()' style='margin-left: 10px;' data-toggle='modal' data-target='#modalEquipos' > Equipos&lt;/button >&lt;/td >";
            menu += "&lt;button class='btnMenu' onclick='updatePrincipal()' style='margin-left: 10px;'> Volver&lt;/button >&lt;/td >";
            document.getElementById("menu").innerHTML = menu;
            document.getElementById("menu").style.left = distancia;
        }
        /**

            *Cargamos los tipos de equipo

            * @return  {void}

            */
        updateTiposEquipos = function () {
            var tipos = "";
            for (var x = 0; x &lt; $scope.tipoServicio.length; x++) {
                if (x != 2) {
                    tipos += "&lt;button class='mostrarSer' onclick='updateServs(" + $scope.tipoServicio[x].id + ")' data-toggle='modal' data-target='#myModal2'>" + $scope.tipoServicio[x].nombre + "&lt;/button> &lt;br />\n";
                }
            }
            document.getElementById("tiposServicios").innerHTML = tipos;
        }
        /**

            *Cargamos los tipos de complemento

            * @return  {void}

            */
        updateTiposComplemento = function () {
            var tipos = "";
            for (var x = 0; x &lt; $scope.tipoComplemento.length; x++) {
                if (x != 2) {
                    if (exismod == 0 ) {
                        //En existente no cargamos los tipos eléctricos
                        if ($scope.tipoComplemento[x].id!="1"){
                        tipos += "&lt;button class='mostrarSer' onclick='updateComplementos(" + $scope.tipoComplemento[x].id + ")' data-toggle='modal' data-target='#myModalComplemento2'>" + $scope.tipoComplemento[x].nombre + "&lt;/button> &lt;br />\n";
                        }
                    } else {
                        tipos += "&lt;button class='mostrarSer' onclick='updateComplementos(" + $scope.tipoComplemento[x].id + ")' data-toggle='modal' data-target='#myModalComplemento2'>" + $scope.tipoComplemento[x].nombre + "&lt;/button> &lt;br />\n";
                    }
                }
            }
            document.getElementById("tipoComplemento").innerHTML = tipos;
        }
        /**

            *Cargamos  los servicios en función del tipo de servicio seleccionado

            * @param  {number}
            * @return  {void}

            */
        updateTipoEd = function (dispositivo) {
            var tipos = "";
            //Recorremos la tabla servicios
            for (var x = 0; x &lt; $scope.tipoEdificio.length; x++) {
                tipos += "&lt;button class='mostrarSer' onclick='updateEd(" + dispositivo + "," + $scope.tipoEdificio[x].id + ")'data-dismiss='modal' data-toggle='modal' data-target='#myModalEdificios'>" + $scope.tipoEdificio[x].nombre + "&lt;/button>\n&lt;br/>\n";
            }
            //Cargamos los botones y cerramos la ventana emergente
            document.getElementById("TiposEdificios").innerHTML = tipos;
            $('#myModalTipoEdificios').modal('hide');
        }
        /**

            *Cargamos los botones de los edificios en relación al tipo de edificio seleccionado

            * @param  {number}
            * @return  {void}

            */
        updateEd = function (dispositivo, tipo) {
            var ed = "";
            //Recorremos la tabla edificios
            for (var x = 0; x &lt; $scope.edificio.length; x++) {
                //Comprobamos que el tipo de edificio coincida
                if ($scope.edificio[x].idtipoedificio == tipo) {
                    //Si coincide cargamos ese edificio en la ventana emergente
                    if (dispositivo == 2) {
                        ed += "&lt;button class='mostrarSer' data-dismiss='modal' onclick='updatePredefinido(" + $scope.edificio[x].id + ")'>" + $scope.edificio[x].nombre + "&lt;/button>\n&lt;br/>\n";
                    } else {
                        document.getElementById('tipoEdificio').innerHTML = $scope.edificio[x].nombre;
                        ed += "&lt;button class='mostrarSer' data-dismiss='modal' onclick='cargaFuncional()'>" + $scope.edificio[x].nombre + "&lt;/button>\n&lt;br/>\n";
                    }
                }
            }
            //Cargamos los botones y cerramos la ventana emergente
            document.getElementById("edificios").innerHTML = ed;
            $('#myModalEdificios').modal('hide');
        }
        /**

            *Cargamos el tipo de caso correspondienteo

            * @param  {number}
            * @return  {void}

            */
        updatePredefinido = function (ed) {
            document.getElementById("menu").style = "width: auto;;left:42%;background-color:white;"
            var edificio = "";
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                if ($scope.caso[x].nombre == nombreCaso) {
                    edificio = $scope.caso[x].idedificio;
                }
            }
            document.getElementById("lineas").innerHTML = "";
            for (var x = 0; x &lt; equipos.length; x++) {
                borrarPredefinido(equipos[x][0]);
            }
            cargaNueva = true;
            var hayAuto = false;
            sistema = 0;
            cont = 1;
            numColector = 1;
            colector = [];
            colectores = [];
            equipos = [];
            caracteristicas = [];
            numFlechas = [];
            numFlechasInversa = [];
            numLineas = [];
            numLineasInversa = [];
            //Reiniciamos los radios
            total = equipos.length;
            var menu = "";
            //Creamos de nuevo los botones y su funcionalidad
            menu += "&lt;button class='btnMenu' id='foto' style='background-color:orange;margin-left: 10px;' onclick='guardarCaso()'> Guardar&lt;/button>";
            if (exismod == 0) {
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updatePredefinido(" + edificio + ")'> Existente&lt;/button>";
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2(" + exismod + ")'> Configurar&lt;/button>";
            } else {
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;'onclick='cargarTablaNuevo()'> Nuevo&lt;/button>";
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2(" + exismod + ")'> Configurar&lt;/button>";
            }
            var widthBody = ($(document.getElementById("body")).width() / 2);
            var widthEsquema = ($(document.getElementById("esquema")).width() / 2);
            distancia = widthBody - widthEsquema;
            document.getElementById("esquema").style.left = distancia;
            document.getElementById("esquema2").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("menu").innerHTML = menu;
            
            //Cargamos los equipos, usos y complementos correspondientes
            for (var x = 0; x &lt; $scope.edificioUsoBusEx.length; x++) {
                if ($scope.edificioUsoBusEx[x].idbus != "10" &amp;&amp; $scope.edificioUsoBusEx[x].idbus != "9" &amp;&amp; $scope.edificioUsoBusEx[x].idedificio == ed) {
                    updateBusUso($scope.edificioUsoBusEx[x].iduso, "3", "0");
                    if ($scope.edificioUsoBusEx[x].iduso == "17" || $scope.edificioUsoBusEx[x].iduso == "17") {
                        hayAuto = true;
                    }
                }
            }
           
            for (var x = 0; x &lt; $scope.edificioServicioBusEx.length; x++) {
                if ($scope.edificioServicioBusEx[x].idbusgenera != "10" &amp;&amp; $scope.edificioServicioBusEx[x].idedificio == ed &amp;&amp; $scope.serviciosEx[$scope.edificioServicioBusEx[x].idservicio - 1].nombretabladatos != "FALTA") {
                    if ($scope.edificioServicioBusEx[x].idbusgenera == "14" &amp;&amp; $scope.edificioServicioBusEx[x].idservicio == "3") {
                        updateTable("6", "3", "4");
                        updateTable("7", "3", "4");
                    } else {
                        updateTable($scope.edificioServicioBusEx[x].idservicio, "3", "4");
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioComplementoBusEx.length; x++) {
                if ($scope.edificioComplementoBusEx[x].idbusgenera != "10" &amp;&amp; $scope.edificioComplementoBusEx[x].idedificio == ed) {
                    updateComplemento($scope.edificioComplementoBusEx[x].idcomplemento, "3", "4");
                }
            }

        }
        /**

            *Cargamos el caso predefinido relcionado con nuestro caso o el caso en curso

            * @param  {number}
            * @return  {void}

            */
        cargarSituacion = function (num) {
            if (num == "0") {
                //guardamos el caso
                exismod = "0";
                guardarCaso("1");
                updatePrincipal();
                if (nombreCaso != '' &amp;&amp; nombreCaso != null) {
                    //LLamamos a la función que carga los tipos de caso
                    $timeout(function () { updateExistModi(exismod) }, 1500);
                } else {
                    //Si el nombre del caso no está bien definido no se carga
                    document.getElementById("radioDefinido1").checked = false;
                    document.getElementById("radioDefinido2").checked = true;
                }
            } else {
                
                exismod = "1";
                guardarCaso("0");
                updatePrincipal();
                if (nombreCaso != '' &amp;&amp; nombreCaso != null) {
                    $timeout(function () { updateExistModi(exismod) }, 1500);
                } else {
                    document.getElementById("radioDefinido1").checked = true;
                    document.getElementById("radioDefinido2").checked = false;
                }
            }
        }
        /**

            *Cargamos el caso correpsondiente al botón radio pulsado
            *Borramos los equipos cargados

            * @param  {number}
            * @return  {void}

            */
        borrarPredefinido = function (cont2) {
            $("#trSer" + cont2).remove();
            $("#lineaSer" + cont2).remove();
            $("#lineaSerInversa" + cont2).remove();
            $("#flechaSerInversa" + cont2).remove();
            $("#flechaSer" + cont2).remove();
            $("#trSerEspacio" + cont2).remove();
        }
        /**

            *cargamos  los servicios en función del tipo de servicio seleccionado

            * @param  {number}
            * @return  {void}

            */
        updateServs = function (tipo) {
            var servs = "";
            var foto = false;
            var hayFrio = false;
            var hayCalor = false;
            //Comprobamos la existencia de equipos especiales
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][1] == " Monocristalino" || equipos[x][1] == " Policristalino" || equipos[x][1] == " PERC") {
                    foto = true;
                }
            }
            for (var x = 0; x &lt; colectores.length; x++) {
                if (colectores[x][1] == "7" || colectores[x][1] == "8") {
                    hayFrio = true;
                }
                if (colectores[x][1] == "1" || colectores[x][1] == "2" || colectores[x][1] == "3" || colectores[x][1] == "4" || colectores[x][1] == "5" || colectores[x][1] == "11") {
                    hayCalor = true;
                }
            }
            //Recorremos la tabla servicios
            for (var x = 0; x &lt; $scope.servicios.length; x++) {
                //Comprobamos que el tipo de servicio coincida
                if ($scope.servicios[x].idtiposervicio == tipo &amp;&amp; $scope.servicios[x].nombretabladatos != "FALTA") {
                    //Si coincide cargamos ese servicio en la ventana emergente
                    if (tipo == "4") {
                        if (foto == false) {
                            servs += "&lt;button class='mostrarSer' onclick='updateBuses(" + $scope.servicios[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.servicios[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                    } else if (tipo == "5" || tipo == "2") {
                        if ($scope.servicios[x].id == "5" || $scope.servicios[x].id == "6" || $scope.servicios[x].id == "33" || $scope.servicios[x].id == "34") {
                            if (hayFrio == true &amp;&amp; hayCalor == true) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBuses(" + $scope.servicios[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.servicios[x].nombre + "&lt;/button>\n&lt;br/>\n";
                            }
                        }
                        else if ($scope.servicios[x].id != "5" &amp;&amp; $scope.servicios[x].id != "6" &amp;&amp; $scope.servicios[x].id != "33" &amp;&amp; $scope.servicios[x].id != "34"){
                            servs += "&lt;button class='mostrarSer' onclick='updateBuses(" + $scope.servicios[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.servicios[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                        
                    }
                        else if ($scope.servicios[x].id != "5" &amp;&amp; $scope.servicios[x].id != "6" &amp;&amp; $scope.servicios[x].id != "33" &amp;&amp; $scope.servicios[x].id != "34") {
                            servs += "&lt;button class='mostrarSer' onclick='updateBuses(" + $scope.servicios[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.servicios[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                } else if ($scope.servicios[x].idtiposervicio == tipo &amp;&amp; $scope.servicios[x].nombretabladatos == "FALTA") {

                }
            }
            //Cargamos los botones y cerramos la ventana emergente
            document.getElementById("bodyServs").innerHTML = servs;
            $('#myModal').modal('hide');
        }
        /**

            *cargamos  los servicios existentes

            * @return  {void}

            */
        updateServsEx = function () {
            var servs = "";
            var autoC = false;
            var autoF = false;
            var hayFrio = false;
            var hayCalor = false;
            var hayElectricidad = false;
            //Recorremos la tabla servicios
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][1] == "Autónomo Cal.") {
                    autoC = true;
                }
                if (equipos[x][1] == "Autónomo Ref.") {
                    autoF = true;
                }
            }
            for (var x = 0; x &lt; colectores.length; x++) {
                if (colectores[x][1] == "1" || colectores[x][1] == "2" || colectores[x][1] == "3" || colectores[x][1] == "4" || colectores[x][1] == "5" || colectores[x][1] == "11") {
                    hayCalor = true;
                }
               
                    if (colectores[x][1] == "7" || colectores[x][1] == "8") {
                        hayFrio = true;
                    }
                    if (colectores[x][1] == "13" || colectores[x][1] == "12" || colectores[x][1] == "14") {
                        hayElectricidad = true;
                    }
                }
            
            for (var x = 0; x &lt; $scope.serviciosEx.length; x++) {
                //Comprobamos que el tipo de servicio coincida
                //Si coincide cargamos ese servicio en la ventana emergente
                if ($scope.serviciosEx[x].nombre != "Autonomo Calor" &amp;&amp; $scope.serviciosEx[x].nombre != "Autonomo Frio") {
                    if ($scope.serviciosEx[x].id == "11" || $scope.serviciosEx[x].id == "12" || $scope.serviciosEx[x].id == "16") {
                        if (hayFrio == true &amp;&amp; hayCalor == true) {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesEx(" + $scope.serviciosEx[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.serviciosEx[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                    }/*
                    else if ($scope.serviciosEx[x].id == "15") {
                        if (hayElectricidad == true) {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesEx(" + $scope.serviciosEx[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.serviciosEx[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                    }*/
                    else if ($scope.serviciosEx[x].id == "4") {
                        if (hayFrio == true) {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesEx(" + $scope.serviciosEx[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.serviciosEx[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                    }
                    else if ($scope.serviciosEx[x].id != "11" &amp;&amp; $scope.serviciosEx[x].id != "12" &amp;&amp; $scope.serviciosEx[x].id != "15" &amp;&amp; $scope.serviciosEx[x].id != "16") {
                        servs += "&lt;button class='mostrarSer' onclick='updateBusesEx(" + $scope.serviciosEx[x].id + ")'data-toggle='modal' data-target='#myModal3'>" + $scope.serviciosEx[x].nombre + "&lt;/button>\n&lt;br/>\n";
                    }
                }
            }


            //Cargamos los botones y cerramos la ventana emergente
            document.getElementById("tiposServicios").innerHTML = servs;
            $('#myModal').modal('hide');
        }
        /**

            *cargamos  los servicios en función del tipo de complemento seleccionado

            * @param  {number}
            * @return  {void}

            */
        updateComplementos = function (tipo) {
            var servs = "";
            var foto = false;
            var solar = false;
            var acuSolar = false;
            var battery = false;
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][1] == " Monocristalino" || equipos[x][1] == " Policristalino" || equipos[x][1] == " PERC") {
                    foto = true;
                }
                if (equipos[x][1] == " captadores planos" || equipos[x][1] == " Tubo de vacío" || equipos[x][1] == "Solar Térmica") {
                    solar = true;
                }
                if (equipos[x][1] == "Acumulación solar") {
                    acuSolar = true;
                }
                if (equipos[x][1] == " Li-ion + Inversor") {
                    battery = true;
                }
            }

            document.getElementById("complementoheader").innerText = $scope.tipoComplemento[tipo - 1].nombre;
            //Recorremos la tabla servicios
            for (var x = 0; x &lt; $scope.complementos.length; x++) {
                //Comprobamos que el tipo de servicio coincida

                if ($scope.complementos[x].idtipocomplemento == tipo &amp;&amp; $scope.complementos[x].nombretabladatos != "FALTA" &amp;&amp; $scope.complementos[x].id != "8" &amp;&amp; $scope.complementos[x].id != "10" &amp;&amp; $scope.complementos[x].id != "11" &amp;&amp; $scope.complementos[x].id != "12" &amp;&amp; $scope.complementos[x].id != "17" &amp;&amp; $scope.complementos[x].id != "18" &amp;&amp; $scope.complementos[x].id != "19") {
                    //Si coincide cargamos ese servicio en la ventana emergente
                    if (foto == true &amp;&amp; tipo == 1 &amp;&amp; battery == false) {
                        if ($scope.complementos[x].id == "12" || $scope.complementos[x].id == "13" || $scope.complementos[x].id == "14") {
                            if (solar == true &amp;&amp; acuSolar == false) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Acumulación solar&lt;/button>\n&lt;br/>\n";
                            } else if (solar == true &amp;&amp; acuSolar == true) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Acumulación ACS&lt;/button>\n&lt;br/>\n";
                            } else if ((solar == false &amp;&amp; acuSolar == false) || (solar == true &amp;&amp; acuSolar == true)) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Almacenamiento sensible&lt;/button>\n&lt;br/>\n";
                            }
                        } else if ($scope.complementos[x].id == "16") {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Intercambiador de calor&lt;/button>\n&lt;br/>\n";
                        } else {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>" + $scope.complementos[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                    } else if (tipo != 1) {
                        if ($scope.complementos[x].id == "9") {

                            if (solar == true &amp;&amp; acuSolar == false) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Acumulación solar&lt;/button>\n&lt;br/>\n";
                            } else if (solar == true &amp;&amp; acuSolar == true) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Acumulación ACS&lt;/button>\n&lt;br/>\n";
                            } else if (solar == false &amp;&amp; acuSolar == false) {
                                servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Almacenamiento sensible&lt;/button>\n&lt;br/>\n";
                            }
                        }
                        else if ($scope.complementos[x].id == "16") {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>Intercambiador de calor&lt;/button>\n&lt;br/>\n";
                        } else {
                            servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>" + $scope.complementos[x].nombre + "&lt;/button>\n&lt;br/>\n";
                        }
                    }
                }
                /* else {
                     if ($scope.complementos[x].idtipocomplemento == tipo &amp;&amp; $scope.complementos[x].nombretabladatos != "FALTA") {
                         if (foto == true &amp;&amp; tipo == 1) {
                             servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>" + $scope.complementos[x].nombre + "&lt;/button>\n&lt;br/>\n";
                         } else if (tipo != 1) {
                             servs += "&lt;button class='mostrarSer' onclick='updateBusesComplemento(" + $scope.complementos[x].id + ")'data-toggle='modal' data-target='#myModalComplemento3'>" + $scope.complementos[x].nombre + "&lt;/button>\n&lt;br/>\n";
                         }
                     }
                 }*/
            }
            //Cargamos los botones y cerramos la ventana emergente
            document.getElementById("bodyComple").innerHTML = servs;
            $('#myModalComplemento').modal('hide');
        }
        /**

            *Si se elige un equipo sin tabla de características salta el siguiente mensaje

            * @param  {number}
            * @return  {void}

            */
        faltaEquipo = function (tipo) {
            alert("Este equipo actualmente no se encuentra disponible");
            $('#myModal').modal('show');
            updateServs(tipo);
        }
        /**

            *Cargamos los usos en función del tipo uso

            * @return  {void}

            */
        updateBusesUso = function (uso) {
            if (uso > 8) {
                document.getElementById("headerusos").innerText = $scope.uso[uso - 4].nombre
            } else {
                document.getElementById("headerusos").innerText = $scope.uso[uso - 1].nombre
            }
            document.getElementById("tempGU").innerHTML = "";
            document.getElementById("headerusos").style.display = "inline";
            var contG = 0;
            var colBus = "";
            var primerBus = "";
            var uso2 = "";

            if (uso == "15" || uso == "16") {
                uso2 = "3";
            } else if (uso == "14") {
                uso2 = "9";
            } else {
                uso2 = uso;
            }
            if (uso == "17") {
                uso2 = "14";
                colBus = "4";
            }
            if (uso == "18") {
                uso2 = "15";
                colBus = "6";
            }

            if (uso2 == "14" || uso2 == "15") {
                for (var x = 0; x &lt; $scope.bus.length; x++) {
                    if ($scope.bus[x].id == uso2) {
                        
                        if (contG == 0) {
                            //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                            var busG = "&lt;table>\n";
                            busG += "&lt;tr style='height: 100px'>\n";
                            var radioG = "&lt;tr>\n";
                            //Creamos la columna
                            primerBus = (parseInt(uso2) - 3);
                            busG += "&lt;td class='buses" + colBus + "' style='color: white; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + nomBuses[uso2 - 1] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left:20px;' value='" + uso2 + "' onclick='temperaturaBus(1," + uso2 + ",2)' name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        } else {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colBus + "' style='color: white; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + nomBuses[uso2 - 1] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + uso2 + "' onclick='temperaturaBus(1," + uso2 + ",2)' name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        }
                    }
                }
            }

            else {
                if (uso == "14") {
                    uso2 = uso;
                }
                //Recorremos la tabla servicio buses
                for (var x = 0; x &lt; $scope.usobus.length; x++) {
                    //Recorremos hasta encontrar el servicio seleccionado
                    if ($scope.usobus[x].iduso == uso2) {
                        //Comprobamos si hay un bus que genera
                        if ($scope.usobus[x].prioridad == 1) {
                            //Si se da el caso comprobamos si la tabla estaba vacía
                            if (contG == 0) {
                                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                                var busG = "&lt;table>\n";
                                busG += "&lt;tr style='height: 100px'>\n";
                                var radioG = "&lt;tr>\n";
                                //Creamos la columna
                                primerBus = (parseInt($scope.usobus[x].idbus) - 1);
                                busG += "&lt;td class='buses" + $scope.usobus[x].idbus + "' style='color: white; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + nomBuses[$scope.usobus[x].idbus - 1] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left:20px;' value='" + $scope.usobus[x].idbus + "' onclick='temperaturaBus(1," + (parseInt($scope.usobus[x].idbus) - 1) + ",2)' name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                                contG++;
                            } else {
                                //En caso contrario añadimos otra columna
                                busG += "&lt;td class='buses" + $scope.usobus[x].idbus + "' style='color: white; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + nomBuses[$scope.usobus[x].idbus - 1] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + $scope.usobus[x].idbus + "' onclick='temperaturaBus(1," + (parseInt($scope.usobus[x].idbus) - 1) + ",2)' name='idBusGenera' type='radio' />&lt;/td>\n";
                                contG++;
                            }
                        }
                    }
                }
            }
            //Comprobamos que haya una tabla genera creada
            if (contG > 0) {
                //Si está creada creamos una tabla para distinguir entre existente y nuevo
                radioG += "&lt;table>\n";
                //Almacenamos la variable del bus elegido
                document.getElementById("busesUsoG").innerHTML = "&lt;h4>Colectores generados&lt;/h4>" + busG + "" + radioG;
                
            } else {
                //Si no almacenamos los valores de buses y nuevo/existente a cero
                document.getElementById("busesUsoG").innerHTML = "";
            }
            var usoMod = 0;
            if (uso > 8) {
                usoMod = uso - 4;
            } else {
                usoMod = uso - 1;
            }
            if ($scope.uso[usoMod].idtipouso == "1" || $scope.uso[usoMod].idtipouso == "3") {
                temp = "&lt;span style='margin-right:7px'>temp. máxima(ºC)&lt;/span> &lt;input id=tempMaxG style='transform: scale(1); margin-right:20%;'  size='5' type='text'  maxlength='5'/>";
                temp += "&lt;span style ='margin-right:7px'>temp. mínima(ºC)&lt;/span> &lt;input id=tempMinG style='transform: scale(1);' size='5' type='text'  maxlength='5'/>&lt;/br>";
                if (uso == "1" || uso == "2" || uso == "3" || uso == "4" || uso == "5" || uso == "15" || uso == "17" ) {
                    temp += "&lt;span style ='margin-right:7px'>Consumo total calor(%)&lt;/span> &lt;input id='porConC' style='transform: scale(1);' step='any' class='+1000 -0  float' type='number' max='100' min='1'size='5' type='text' value='100.0' maxlength='5'/>";
                }
                if (uso == "7" || uso == "8" || uso == "5" || uso == "18") {
                    temp += "&lt;span style ='margin-right:7px'>Consumo total frio(%)&lt;/span> &lt;input id='porConF' style='transform: scale(1);' step='any' class='+1000 -0  float' type='number' max='100' min='1' size='5' type='text' value='100.0' maxlength='5'/>";
                }
                if (uso == "16" || uso == "5") {
                    temp += "&lt;span style ='margin-right:7px'>Consumo total ACS(%)&lt;/span> &lt;input id='porConACS' style='transform: scale(1);' step='any' class='+1000 -0  float' type='number' max='100' min='1'size='5' type='text' value='100.0' maxlength='5'/>";
                }
                document.getElementById("tempGU").innerHTML = temp;
                temperaturaBus(1, primerBus, 2);
            }
            //Creamos el botón aceptar en la ventana emergente con el servicio elegido
            var aceptar = "&lt;img id='logo' class='deshacer' src='deshacer.png' data-toggle='modal' data-target='#myModalUso2' data-dismiss='modal'>&lt;img />"
            aceptar += "&lt;button type='button' class='btn btn-default' onclick='updateBusUso(" + uso + ",1)'>Aceptar&lt;/button>";
            document.getElementById("footerUso").innerHTML = aceptar;
            
        }
        /**

            *Creamos los buses genera y alimenta en función del servicio

            * @param  {number}
            * @return  {void}

            */
        updateBuses = function (serv) {
            var contG = 0;
            var contA = 0;
            var color = "";
            var colector = "";

            document.getElementById("headerequipo").innerText = $scope.servicios[serv - 1].nombre;
            document.getElementById("headerequipo").style.display = "inline";
            document.getElementById("busesG").innerHTML = "";
            document.getElementById("busesA").innerHTML = "";
            //Recorremos la tabla servicio buses   

            for (var x = 0; x &lt; colectores.length; x++) {
                colector = colectores[x][1];
                if (colector == "11") {
                    colector = "3";
                }
                //Recorremos hasta encontrar el servicio seleccionado
                color = "white";
                //Si se da el caso comprobamos si la tabla estaba vacía
                if (x == 9) {
                    color = "black";
                }

                if (colector != "14" &amp;&amp; colector != "15") {
                    //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido                  
                    if (contG == 0) {
                        //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                        var busG = "&lt;table>\n";
                        busG += "&lt;tr style='height: 100px'>\n";
                        var radioG = "&lt;tr>\n";
                        //Creamos la columna
                        if ((serv == "19" || serv == "20" || serv == "23") &amp;&amp; colector == "9") {
                            busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        } else if ((serv == "27" || serv == "28" || serv == "29") &amp;&amp; (colector == "1" || colector == "2" || colector == "4" || colector == "3")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        }
                        else if (serv == "1" &amp;&amp; colector == "3") {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        }
                        else if (serv == "2" &amp;&amp; (colector == "1" || colector == "2" || colector == "4" || colector == "3")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        }
                        else if ((serv == "5" || serv == "6" || serv == "7" || serv == "8" || serv == "9" || serv == "10") &amp;&amp; (colector == "8" || colector == "7")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        }
                        else if ((serv == "32" || serv == "33" || serv == "34") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4" )) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                            contG++;
                        }
                    } 
                    else {
                        if ((serv == "19" || serv == "20" || serv == "23") &amp;&amp; colector == "9") {
                            //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido

                            //Creamos la columna
                            busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        } else if ((serv == "27" || serv == "28" || serv == "29") &amp;&amp; (colector == "1" || colector == "2" || colector == "4" ||  colector == "3")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        }
                        else if (serv == "1" &amp;&amp; colector == "3") {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        }
                        else if (serv == "2" &amp;&amp; (colector == "1" || colector == "2" || colector == "4" || colector == "3")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        }
                        else if ((serv == "5" || serv == "6" || serv == "7" || serv == "8" || serv == "9" || serv == "10") &amp;&amp; (colector == "8" || colector == "7")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        }
                        else if ((serv == "32" || serv == "33" || serv == "34") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                            //En caso contrario añadimos otra columna
                            busG += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' />&lt;/td>\n";
                            contG++;
                        }
                    }
                }

                //Comprobamos si hay un bus que alimenta
                //Si se da el caso comprobamos si la tabla estaba vacía
                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                if (colector != "14" &amp;&amp; colector != "15") {
                    if (serv == "5" || serv == "32" || serv == "33" || serv == "34" || serv == "27" || serv == "28" || serv == "29" || serv == "5" || serv == "6" || serv == "7" || serv == "8" || serv == "9" || serv == "10") {
                        if (contA == 0) {
                            //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                            var busA = "&lt;table>\n";
                            busA += "&lt;tr style='height: 100px'>\n";
                            var radioA = "&lt;tr>\n";
                            if ((serv == "19" || serv == "20" || serv == "23") &amp;&amp; colector == "9") {
                                //Creamos la columna
                                busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                                contA++;
                            } else if ((serv == "27" || serv == "28" || serv == "29") &amp;&amp; (colector == "1" || colector == "2" || colector == "4" || colector == "3")) {
                                //En caso contrario añadimos otra columna
                                busA += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                                contA++;
                            }
                            else if ((serv == "5" || serv == "6" || serv == "7" || serv == "8" || serv == "9" || serv == "10") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                                //En caso contrario añadimos otra columna
                                busA += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                                contA++;
                            }
                            else if ((serv == "32" || serv == "33" || serv == "34") &amp;&amp; (colector == "8" || colector == "7")) {
                                //En caso contrario añadimos otra columna
                                busA += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                                contA++;
                            }

                        } 
                        else {
                            if ((serv == "19" || serv == "20" || serv == "23") &amp;&amp; colector == "9") {
                                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido

                                //Creamos la columna
                                busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' />&lt;/td>\n";
                                contA++;
                            } else if ((serv == "1" || serv == "2" || serv == "27" || serv == "28" || serv == "29") &amp;&amp; (colector == "1" || colector == "2" || colector == "4" || colector == "3")) {
                                //En caso contrario añadimos otra columna
                                busA += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' />&lt;/td>\n";
                                contA++;
                            }
                            else if ((serv == "5" || serv == "6" || serv == "7" || serv == "8" || serv == "9" || serv == "10") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                                //En caso contrario añadimos otra columna
                                busA += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' />&lt;/td>\n";
                                contA++;
                            }
                            else if ((serv == "32" || serv == "33" || serv == "34") &amp;&amp; (colector == "8" || colector == "7")) {
                                //En caso contrario añadimos otra columna
                                busA += "&lt;td class='buses" + colector + "' style='color:" + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                                //Creamos el botón radio
                                radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' />&lt;/td>\n";
                                contA++;
                            }
                        }
                    }
                }
            }
            if (serv == "32" &amp;&amp; contG > 0 &amp;&amp; contA > 0) {
                busG += "&lt;td  style='border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>Ninguno&lt;/div>\n";
                //Creamos el botón radio
                radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='0'  name='idBusGenera' type='radio' />&lt;/td>\n";
                busA += "&lt;td  style='border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);     margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>Ninguno&lt;/div>\n";
                //Creamos el botón radio
                radioA += "&lt;td>&lt;input style='margin-top:20px;    margin-left: 20px;' value='0'  name='idBusAlimenta' type='radio' />&lt;/td>\n";


            }
            //Comprobamos que haya una tabla genera creada
            //Si está creada creamos una tabla para distinguir entre existente y nuevo
            //Almacenamos la variable del bus elegido
            if (contG > 0) {
                document.getElementById("busesG").innerHTML = "&lt;h4>Colectores generados&lt;/h4>" + busG + "" + radioG;
            }
            //Creamos los radios de nuevo y existente
            

            //Si está creada creamos una tabla para distinguir entre existente y nuevo
            //Almacenamos la variable del bus elegido
            if (serv == "32" || serv == "33" || serv == "34" || serv == "35" || serv == "36" || serv == "37" || serv == "5" || serv == "6" || serv == "7" || serv == "8" || serv == "9" || serv == "10") {
                if (contA > 0) {
                    document.getElementById("busesA").innerHTML = "&lt;h4>Colectores de los que se alimenta&lt;/h4>" + busA + "" + radioA;
                }
            }
            //Creamos los radios de nuevo y existente
            
            //Creamos el botón aceptar en la ventana emergente con el servicio elegido
            var aceptar = "&lt;img id='logo' class='deshacer' src='deshacer.png' data-dismiss='modal' data-toggle='modal' data-target='#myModal'>&lt;img />";
            aceptar += "&lt;button type='button' class='btn btn-default' onclick='updateTable(" + serv + ",1,1)'>Aceptar&lt;/button>";
            document.getElementById("footerSer").innerHTML = aceptar;
            $('#myModal2').modal('hide');
        }
        /**

            *Bloquemas las temperaturas en función del bus

            * @return  {void}

            */
        temperaturaBus = function (letra, numBus, tipoT) {
            if (letra == "1") {
                letra = "G";
            } else {
                letra = "A";
            }
           //Cargamos las temperaturas y activamos las casillas
            if (tipoT == "2") {
                document.getElementById("tempMin" + letra).value = $scope.bus[numBus].tmin;
                document.getElementById("tempMax" + letra).value = $scope.bus[numBus].tmax;
                document.getElementById("tempMin" + letra).disabled = false;
                document.getElementById("tempMax" + letra).disabled = false;
            } else {
                document.getElementById("tempMin" + letra).value = colectores[numBus][3];
                document.getElementById("tempMax" + letra).value = colectores[numBus][2];
                document.getElementById("tempMin" + letra).disabled = false;
                document.getElementById("tempMax" + letra).disabled = false;
                
            }
        }
        /**

            *Bloquemas las temperaturas en función del bus

            * @return  {void}

            */
        temperaturaBus2 = function (letra, numBus) {
            if (letra == "1") {
                letra = "GC";
            } else {
                letra = "AC";
            }
            //Cargamos las temperaturas y activamos las casillas
            document.getElementById("tempMin" + letra).value = colectores[numBus][3];
            document.getElementById("tempMax" + letra).value = colectores[numBus][3];
            document.getElementById("tempMin" + letra).disabled = false;
            document.getElementById("tempMax" + letra).disabled = false;
            
        }
        /**

            *Creamos los buses genera y alimenta en función del servicio Existente

            * @param  {number}
            * @return  {void}

            */
        updateBusesEx = function (serv) {
            var contG = 0;
            var contA = 0;
            var color = "";
            var colector = "";
            document.getElementById("busesG").innerHTML = "";
            document.getElementById("busesA").innerHTML = "";
            document.getElementById("headerequipo").innerText = $scope.serviciosEx[serv - 1].nombre;
            document.getElementById("headerequipo").style.display = "inline";
            //Recorremos la tabla servicio buses
            for (var x = 0; x &lt; colectores.length; x++) {
                colector = colectores[x][1];
                if (colector == "11") {
                    colector = "3";
                }
                //Recorremos hasta encontrar el servicio seleccionado
                color = "white";
                //Si se da el caso comprobamos si la tabla estaba vacía
                if (x == 9) {
                    color = "black";
                }
                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                if (contG == 0) {
                    //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                    var busG = "&lt;table>\n";
                    busG += "&lt;tr style='height: 100px'>\n";
                    var radioG = "&lt;tr>\n";
                    //Creamos la columna
                    if ( serv == "15" &amp;&amp; colector == "9") {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if ((serv == "4" || serv == "16") &amp;&amp; (colector == "7" || colector == "8")) {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if (serv == "6" &amp;&amp; colector == "14") {
                        var colector = "";
                        if (colector == "14") {
                            colector = "4";
                        }
                        if (colector == "15") {
                            colector = "6";
                        }
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if (serv == "7" &amp;&amp; colector == "15") {
                        var colector = "";
                        if (colector == "14") {
                            colector = "4";
                        }
                        if (colector == "15") {
                            colector = "6";
                        }
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if ((serv == "1" || serv == "3" || serv == "8" || serv == "9" || serv == "10" || serv == "11" || serv == "12" || serv == "13" || serv == "14") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4" )) {

                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if ((serv == "2" || serv == "5") &amp;&amp; colector == "3") {

                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }


                } else {
                    if ( serv == "15" &amp;&amp; colector == "9") {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if ((serv == "4" || serv == "16") &amp;&amp; (colector == "7" || colector == "8")) {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if (serv == "6" &amp;&amp; colector == "14") {
                        var colector = "";
                        if (colector == "14") {
                            colector = "4";
                        }
                        if (colector == "15") {
                            colector = "6";
                        }
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if (serv == "7" &amp;&amp; colector == "15") {
                        var colector = "";
                        if (colector == "14") {
                            colector = "4";
                        }
                        if (colector == "15") {
                            colector = "6";
                        }
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if ((serv == "1" || serv == "3" || serv == "8" || serv == "9" || serv == "10" || serv == "11" || serv == "12" || serv == "13" || serv == "14") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {

                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }
                    else if ((serv == "2" || serv == "5") &amp;&amp; colector == "3") {

                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusGenera' type='radio' checked/>&lt;/td>\n";
                        contG++;
                    }

                }
                //Comprobamos si hay un bus que alimenta
                //Si se da el caso comprobamos si la tabla estaba vacía
                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                if (serv == "3" || serv == "10" || serv == "11" || serv == "12") {
                    if (contA == 0) {
                        //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                        var busA = "&lt;table>\n";
                        busA += "&lt;tr style='height: 100px'>\n";
                        var radioA = "&lt;tr>\n";
                        //Creamos la columna
                        if ((serv == "3" || serv == "10" || serv == "11" || serv == "12") &amp;&amp; (colector == "7" || colector == "8")) {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;    margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                            contA++;
                        } else if (serv == "16" &amp;&amp; (colector == "1" || colector == "2" || colector == "4" || colector == "3")) {

                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                            contA++;
                        }

                    } else {
                        //En caso contrario añadimos otra columna
                        //Creamos la columna
                        if ((serv == "3" || serv == "10" || serv == "11" || serv == "12") &amp;&amp; (colector == "7" || colector == "8")) {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;    margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                            contA++;
                        } else if (serv == "16" &amp;&amp; (colector == "1" || colector == "2" || colector == "4" ||  colector == "3")) {

                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px; ' value='" + colectores[x][0] + "'  name='idBusAlimenta' type='radio' checked/>&lt;/td>\n";
                            contA++;
                        }
                    }

                }
            }
            if ((serv == "3" || serv == "10") &amp;&amp; contG > 0 &amp;&amp; contA > 0) {
                busG += "&lt;td  style='border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);  margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>Ninguno&lt;/div>\n";
                //Creamos el botón radio
                radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='0'  name='idBusGenera' type='radio' />&lt;/td>\n";
                busA += "&lt;td  style='border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg);     margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>Ninguno&lt;/div>\n";
                //Creamos el botón radio
                radioA += "&lt;td>&lt;input style='margin-top:20px;    margin-left: 20px;' value='0'  name='idBusAlimenta' type='radio' />&lt;/td>\n";


            }
            //Comprobamos que haya una tabla genera creada
            //Si está creada creamos una tabla para distinguir entre existente y nuevo
            //Almacenamos la variable del bus elegido
            document.getElementById("busesG").innerHTML = "&lt;h4>Colectores generados&lt;/h4>" + busG + "" + radioG;
            if (serv == "3" || serv == "10" || serv == "11" || serv == "12") {
                document.getElementById("busesA").innerHTML = "&lt;h4>Colectores alimenta&lt;/h4>" + busA + "" + radioA;
            }
           
            //Creamos el botón aceptar en la ventana emergente con el servicio elegido
            var aceptar = "&lt;img id='logo' class='deshacer' src='deshacer.png' data-dismiss='modal' data-toggle='modal' data-target='#myModal'>&lt;img />";
            aceptar += "&lt;button type='button' class='btn btn-default' onclick='updateTable(" + serv + ",1,4)'>Aceptar&lt;/button>";
            document.getElementById("footerSer").innerHTML = aceptar;
            $('#myModal').modal('hide');
        }
        /**

            *Creamos los buses genera y alimenta en función del servicio

            * @param  {number}
            * @return  {void}

            */
        updateBusesComplemento = function (comp) {

            nombre2 = "";
            if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                nombre2 = "Almacenamiento sensible";
            } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                nombre2 = "Intercambiador de calor";
            } else {
                nombre2 = $scope.complementos[comp - 1].nombre;
            }
            document.getElementById("headercomplemento").innerText = nombre2;
            document.getElementById("headercomplemento").style.display = "inline";
            var contG = 0;
            var contA = 0;
            var colector = "";
            //Recorremos la tabla servicio buses
            $('#myModalComplemento2').modal('hide');
            for (var x = 0; x &lt; colectores.length; x++) {
                colector = colectores[x][1];
                if (colector == "11") {
                    colector = "3";
                }
                document.getElementById("busesGC").innerHTML = "";
                document.getElementById("busesAC").innerHTML = "";
                //Recorremos hasta encontrar el servicio seleccionado
                color = "white";
                //Si se da el caso comprobamos si la tabla estaba vacía
                if (x == 9) {
                    color = "black";
                }
                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                if (contG == 0) {
                    //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                    var busG = "&lt;table>\n";
                    busG += "&lt;tr style='height: 100px'>\n";
                    var radioG = "&lt;tr>\n";
                    //Creamos la columna
                    if ((comp == "1" || comp == "2" || comp == "3" || comp == "4" || comp == "5") &amp;&amp; colector == "9") {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusGeneraC' type='radio' checked/>&lt;/td>\n";
                    } else if ((comp == "16" || comp == "17" || comp == "18" || comp == "19") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusGeneraC' type='radio' checked/>&lt;/td>\n";
                    } else if (comp != "1" &amp;&amp; comp != "2" &amp;&amp; comp != "3" &amp;&amp; comp != "4" &amp;&amp; comp != "5" &amp;&amp; comp != "16" &amp;&amp; comp != "17" &amp;&amp; comp != "18" &amp;&amp; comp != "19" &amp;&amp; colector != "9" &amp;&amp; colector != "7" &amp;&amp; colector != "8" &amp;&amp; colector != "14" &amp;&amp; colector != "15") {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusGeneraC' type='radio' checked/>&lt;/td>\n";
                    }
                    contG++;
                } else {
                    //En caso contrario añadimos otra columna
                    if ((comp == "1" || comp == "2" || comp == "3" || comp == "4" || comp == "5") &amp;&amp; colector == "9") {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusGeneraC' type='radio' checked/>&lt;/td>\n";
                    } else if ((comp == "16" || comp == "17" || comp == "18" || comp == "19") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusGeneraC' type='radio' checked/>&lt;/td>\n";
                    }
                    else if (comp != "1" &amp;&amp; comp != "2" &amp;&amp; comp != "3" &amp;&amp; comp != "4" &amp;&amp; comp != "5" &amp;&amp; comp != "16" &amp;&amp; comp != "17" &amp;&amp; comp != "18" &amp;&amp; comp != "19" &amp;&amp; colector != "9" &amp;&amp; colector != "14" &amp;&amp; colector != "15" &amp;&amp; colector != "7" &amp;&amp; colector != "8" &amp;&amp; colector != "5") {
                        busG += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                        //Creamos el botón radio
                        radioG += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusGeneraC' type='radio' checked/>&lt;/td>\n";
                    }
                    contG++;
                }
                //Comprobamos si hay un bus que alimenta
                //Si se da el caso comprobamos si la tabla estaba vacía
                //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                if (comp == "16" || comp == "17" || comp == "18" || comp == "19") {
                    if (contA == 0) {
                        letra = "A";
                        //Si estaba vacía creamos la tabla metemos la primera columna con el bus elegido
                        var busA = "&lt;table>\n";
                        busA += "&lt;tr style='height: 100px'>\n";
                        var radioA = "&lt;tr>\n";
                        //Creamos la columna
                        if ((comp == "1" || comp == "2" || comp == "3" || comp == "4" || comp == "5") &amp;&amp; colector == "9" &amp;&amp; colector != "14" &amp;&amp; colector != "15") {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'name='idBusAlimentaC' type='radio' checked/>&lt;/td>\n";
                        } else if ((comp == "16" || comp == "17" || comp == "18" || comp == "19") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusAlimentaC' type='radio' checked/>&lt;/td>\n";
                        }
                        else if (comp != "1" &amp;&amp; comp != "2" &amp;&amp; comp != "3" &amp;&amp; comp != "4" &amp;&amp; comp != "5" &amp;&amp; comp != "16" &amp;&amp; comp != "17" &amp;&amp; comp != "18" &amp;&amp; comp != "19" &amp;&amp; colector != "9" &amp;&amp; colector != "14" &amp;&amp; colector != "15" &amp;&amp; colector != "7" &amp;&amp; colector != "8") {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'name='idBusAlimentaC' type='radio' checked/>&lt;/td>\n";
                        }
                        contA++;
                    } else {
                        letra = "A";
                        //En caso contrario añadimos otra columna
                        //Creamos la columna
                        if ((comp == "1" || comp == "2" || comp == "3" || comp == "4" || comp == "5") &amp;&amp; colector == "9" &amp;&amp; colector != "14" &amp;&amp; colector != "15") {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'name='idBusAlimentaC' type='radio' checked/>&lt;/td>\n";
                        } else if ((comp == "16" || comp == "17" || comp == "18" || comp == "19") &amp;&amp; (colector == "1" || colector == "2" || colector == "3" || colector == "4")) {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "' name='idBusAlimentaC' type='radio' checked/>&lt;/td>\n";
                        }
                        else if (comp != "1" &amp;&amp; comp != "2" &amp;&amp; comp != "3" &amp;&amp; comp != "4" &amp;&amp; comp != "5" &amp;&amp; comp != "16" &amp;&amp; comp != "17" &amp;&amp; comp != "18" &amp;&amp; comp != "19" &amp;&amp; colector != "9" &amp;&amp; colector != "5" &amp;&amp;  colector != "14" &amp;&amp; colector != "15" &amp;&amp; colector != "7" &amp;&amp; colector != "8") {
                            busA += "&lt;td class='buses" + colector + "' style='color: " + color + "; border: solid 1px black;width:50px'>&lt;div style='transform: rotate(270deg); margin-left: -11px; margin-right: -11px; margin-top: -20px;   margin-bottom: 50%;'>" + colectores[x][0] + "&lt;/div>\n";
                            //Creamos el botón radio
                            radioA += "&lt;td>&lt;input style='margin-top:20px;margin-left: 20px;' value='" + colectores[x][0] + "'name='idBusAlimentaC' type='radio' checked/>&lt;/td>\n";
                        }
                        contA++;
                    }
                }
            }
            //Comprobamos que haya una tabla genera creada
            //Si está creada creamos una tabla para distinguir entre existente y nuevo
            //Almacenamos la variable del bus elegido
            if (contG > 0) {
                document.getElementById("busesGC").innerHTML = "&lt;h4>Colectores generados&lt;/h4>" + busG + "" + radioG;
            }
            

            //Almacenamos la variable del bus elegido
            if (comp == "16" || comp == "17" || comp == "18" || comp == "19") {
                document.getElementById("busesAC").innerHTML = "&lt;h4>Colectores de los que se alimenta&lt;/h4>" + busA + "" + radioA;
            }


            //Creamos el botón aceptar en la ventana emergente con el servicio elegido
            var aceptar = "&lt;img id='logo' class='deshacer' src='deshacer.png'  data-toggle='modal' data-target='#myModalComplemento2'>&lt;img />";
            aceptar += "&lt;button type='button' class='btn btn-default' onclick='updateComplemento(" + comp + ",1)'>Aceptar&lt;/button>";
            document.getElementById("footerCom").innerHTML = aceptar;
            $('#myModalComplemento2').modal('hide');
        }
        /**

            *Creamos la función de borrar botón cuando es pulsado un botón

            * @param  {number}
            * @return  {void}

            */
        borrarButton = function (tipo, tipo2, busGenera, busAlimenta, cont) {
            var nombreE = "";
            var borrados = new Array();
            //confirmamos que desea borrar el botón
            var retVal = confirm("¿Está seguro de querer borrar el botón?");
            //Si es afirmativo borramos los botones en función del tipo de botón
            if (retVal == true) {
                // MMR : BORRAR CAMPO SOLAR SI EL EQUIPO ES FOTOVOLTAICO
                for (var x = 0; x &lt; equipos.length; x++) {
                    if (equipos[x][0] == cont) {
                        if (equipos[x][7] == "FVPERC" || equipos[x][7] == "FVmonocristalino" || equipos[x][7] == "FVpolicristalino") {
                            $http.post("CampoSolar.php", { 'action': "borrar", 'id': idCaso, }).catch(function (error) {
                                alert('Se ha encontrado el siguiente error:\r\n ' + error.data + '');
                            });
                            break;
                        }
                    }
                }
                
                for (var i = 0; i &lt; busesAux.length; i++) {
                    if (busesAux[i][1] == nombreE) {
                        busesAux.splice(i, 1);
                    }
                }
                //Comprobamos si es un servicio o un uso
                if (tipo == 1 || tipo == 4 || tipo == 3) {
                    //Borramos los componentes en función de las líneas del botón y el espacio generado después
                    if (tipo2 == 0) {
                        //alert('tipo2 == 0');
                        borrados.push(cont);
                        $("#trSer" + cont).remove();
                        $("#lineaSer" + cont).remove();
                        $("#flechaSer" + cont).remove();
                        $("#flechaSerInversa" + cont).remove();
                        $("#trSerEspacio" + cont).remove();
                        var index = numLineas.indexOf(cont);
                        if (index > -1) {
                            numLineas.splice(index, 1);
                        }
                        //Eliminamos el elemento de la lista
                        if (numFlechas.length == 1) {
                            numFlechas = [];
                        } else {
                            while (numFlechas.indexOf(cont) > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont), 1);
                            }
                        }
                        if (numFlechasInversa.length == 1) {
                            numFlechasInversa = [];
                        } else {
                            while (numFlechasInversa.indexOf(cont) > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numLineas.length == 1) {
                            numLineas = [];
                        } else {
                            while (numLineas.indexOf(cont) > 0) {
                                numLineas.splice(numLineas.indexOf(cont), 1);
                            }
                        }
                        //Si no hay mas equipos en ese bus lo desconectamos
                        if (document.getElementsByClassName('connectingLines' + busGenera).length == 0) {
                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busGenera).length; x++) {
                                document.getElementsByClassName("bus" + busGenera)[x].style.visibility = "hidden";
                            }
                        }
                        for (var x = 0; x &lt; borrados.length; x++) {
                            for (var y = 0; y &lt; equipos.length; y++) {
                                if (borrados[x] == equipos[y][0]) {
                                    if (equipos[y][1].trim() == "Li-ion + Inversor")
                                        $scope.guardadobateriainversor = undefined;
                                    equipos.splice(y, 1);
                                    valoresServiciosComplementos.splice(y, 1);
                                    caracteristicas.splice(y, 1);
                                    break;
                                }
                            }
                        }
                    }
                    if (tipo2 == 1) {
                        borrados.push(cont);
                        $("#trSer" + cont).remove();
                        $("#flechaSer" + cont + "A").remove();
                        $("#flechaSerInversa" + cont + "A").remove();
                        $("#lineaSerInversa" + cont).remove();
                        $("#trSerEspacio" + cont).remove();
                        if (numFlechas.length == 1) {
                            numFlechas = [];
                        } else {
                            while (numFlechas.indexOf(cont) > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont), 1);
                            }
                        }
                        if (numLineasInversa.length == 1) {
                            numLineasInversa = [];
                        } else {
                            while (numLineasInversa.indexOf(cont) > 0) {
                                numLineasInversa.splice(numLineasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numFlechasInversa.length == 1) {
                            numFlechasInversa = [];
                        } else {
                            while (numFlechasInversa.indexOf(cont) > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont), 1);
                            }
                        }
                        //Si no hay mas equipos en ese bus lo desconectamos
                        if (document.getElementsByClassName('connectingLines' + busAlimenta).length == 0) {
                            //Desconectamos el radio
                            //Quitamos el equipo de la lista equipo

                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busAlimenta).length; x++) {
                                document.getElementsByClassName("bus" + busAlimenta)[x].style.visibility = "hidden";
                            }
                        }
                        for (var x = 0; x &lt; borrados.length; x++) {
                            for (var y = 0; y &lt; equipos.length; y++) {
                                if (borrados[x] == equipos[y][0]) {
                                    equipos.splice(y, 1);
                                    valoresServiciosComplementos.splice(y, 1);
                                    caracteristicas.splice(y, 1);
                                    break;
                                }
                            }
                        }
                    }
                    if (tipo2 == 2) {
                        borrados.push(cont);
                        $("#trSer" + cont).remove();
                        $("#lineaSer" + cont).remove();
                        $("#lineaSerInversa" + cont).remove();
                        if (busGenera != busAlimenta) {
                            $("#flechaSerInversa" + cont + "A").remove();
                            $("#flechaSer" + cont + "A").remove();
                        }
                        $("#flechaSerInversa" + cont).remove();
                        $("#flechaSer" + cont).remove();
                        $("#trSerEspacio" + cont).remove();
                        if (busGenera != busAlimenta) {
                            while (numFlechas.indexOf(cont + "A") > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont + "A"), 1);
                            }
                            while (numFlechasInversa.indexOf(cont + "A") > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont + "A"), 1);
                            }
                        } if (numFlechas.length == 1) {
                            numFlechas = [];
                        } else {
                            while (numFlechas.indexOf(cont) > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont), 1);
                            }
                        }
                        if (numLineasInversa.length == 1) {
                            numLineasInversa = [];
                        } else {
                            while (numLineasInversa.indexOf(cont) > 0) {
                                numLineasInversa.splice(numLineasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numFlechasInversa.length == 1) {
                            numFlechasInversa = [];
                        } else {
                            while (numFlechasInversa.indexOf(cont) > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numLineas.length == 1) {
                            numLineas = [];
                        } else {
                            while (numLineas.indexOf(cont) > 0) {
                                numLineas.splice(numLineas.indexOf(cont), 1);
                            }
                        }
                        //Si no hay mas equipos en ese bus lo desconectamos
                        if (document.getElementsByClassName('connectingLines' + busGenera).length == 0) {
                            //Quitamos el equipo de la lista equipo

                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busGenera).length; x++) {
                                document.getElementsByClassName("bus" + busGenera)[x].style.visibility = "hidden";
                            }
                        }
                        //Desconectamos el radio
                        if (document.getElementsByClassName('connectingLines' + busAlimenta).length == 0) {
                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busAlimenta).length; x++) {
                                document.getElementsByClassName("bus" + busAlimenta)[x].style.visibility = "hidden";
                            }
                        }
                        for (var x = 0; x &lt; borrados.length; x++) {
                            for (var y = 0; y &lt; equipos.length; y++) {
                                if (borrados[x] == equipos[y][0]) {
                                    equipos.splice(y, 1);
                                    valoresServiciosComplementos.splice(y, 1);
                                    caracteristicas.splice(y, 1);
                                    break;
                                }
                            }
                        }
                    }
                }
                else {
                    if (tipo2 == 0) {
                        var cont3 = 0;
                        for (var x = 0; x &lt; equipos.length; x++) {
                            if (equipos[x][0] == cont) {
                                cont3 = equipos[x][3];
                            }
                        }

                        borrados.push(cont);
                        $("#trSer" + cont).remove();
                        $("#lineaSer" + cont).remove();
                        $("#flechaSer" + cont).remove();
                        $("#flechaSerInversa" + cont).remove();
                        $("#trSerEspacio" + cont).remove();
                        for (var x = 0; x &lt; equipos.length; x++) {
                            $("#" + cont3 + "-" + equipos[x][0]).remove();
                            $("#" + cont3 + "-" + equipos[x][0] + "e").remove();
                            $("#" + cont3 + "-" + equipos[x][0] + "s").remove();
                            $("#" + cont3 + "-" + equipos[x][0] + "se").remove();
                        }
                        for (var x = 0; x &lt; colectores.length; x++) {
                            if (colectores[x][0] == cont3) {
                                colectores.splice(x, 1);
                            }
                        }
                        for (var x = 0; x &lt; equipos.length; x++) {
                            if (equipos[x][2] == cont3 || equipos[x][3] == cont3 &amp;&amp; equipos[x][6] != "2") {
                                borrados.push(equipos[x][0]);
                                $("#trSer" + equipos[x][0]).remove();
                                $("#lineaSer" + equipos[x][0]).remove();
                                $("#flechaSer" + equipos[x][0]).remove();
                                $("#lineaSerInversa" + equipos[x][0]).remove();
                                if (busGenera != busAlimenta) {
                                    $("#flechaSerInversa" + equipos[x][0] + "A").remove();
                                    $("#flechaSer" + equipos[x][0] + "A").remove();
                                }
                                $("#flechaSerInversa" + equipos[x][0]).remove();
                                $("#trSerEspacio" + equipos[x][0]).remove();
                                if (equipos[x][2] != equipos[x][3] &amp;&amp; equipos[x][3] != "-" &amp;&amp; equipos[x][2] != "-") {
                                    while (numFlechas.indexOf(equipos[x][0] + "A") > 0) {
                                        numFlechas.splice(numFlechas.indexOf(equipos[x][0] + "A"), 1);
                                    }
                                    while (numFlechasInversa.indexOf(equipos[x][0] + "A") > 0) {
                                        numFlechasInversa.splice(numFlechasInversa.indexOf(equipos[x][0] + "A"), 1);
                                    }
                                } if (numFlechas.length == 1) {
                                    numFlechas = [];
                                } else {
                                    while (numFlechas.indexOf(equipos[x][0]) > 0) {
                                        numFlechas.splice(numFlechas.indexOf(equipos[x][0]), 1);
                                    }
                                }
                                if (numLineasInversa.length == 1) {
                                    numLineasInversa = [];
                                } else {
                                    while (numLineasInversa.indexOf(equipos[x][0]) > 0) {
                                        numLineasInversa.splice(numLineasInversa.indexOf(equipos[x][0]), 1);
                                    }
                                }
                                if (numFlechasInversa.length == 1) {
                                    numFlechasInversa = [];
                                } else {
                                    while (numFlechasInversa.indexOf(equipos[x][0]) > 0) {
                                        numFlechasInversa.splice(numFlechasInversa.indexOf(equipos[x][0]), 1);
                                    }
                                }
                                if (numLineas.length == 1) {
                                    numLineas = [];
                                } else {
                                    while (numLineas.indexOf(equipos[x][0]) > 0) {
                                        numLineas.splice(numLineas.indexOf(equipos[x][0]), 1);
                                    }
                                }
                            }
                        }
                        for (var x = 0; x &lt; borrados.length; x++) {
                            for (var y = 0; y &lt; equipos.length; y++) {
                                if (borrados[x] == equipos[y][0]) {
                                    equipos.splice(y, 1);
                                    valoresServiciosComplementos.splice(y, 1);
                                    caracteristicas.splice(y, 1);
                                    break;
                                }
                            }
                        }
                        if (numFlechas.length == 1) {
                            numFlechas = [];
                        } else {
                            while (numFlechas.indexOf(cont) > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont), 1);
                            }
                        }
                        if (numFlechasInversa.length == 1) {
                            numFlechasInversa = [];
                        } else {
                            while (numFlechasInversa.indexOf(cont) > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numLineas.length == 1) {
                            numLineas = [];
                        } else {
                            while (numLineas.indexOf(cont) > 0) {
                                numLineas.splice(numLineas.indexOf(cont), 1);
                            }
                        }
                        //Lo borramos también de la lista de equipos
                        for (var a = 0; a &lt; equipos.length; a++) {
                            if (equipos[a][0] == cont) {
                                equipos.splice(a, 1);
                            }
                        }
                        //Si no hay mas equipos en ese bus lo desconectamos
                        if (document.getElementsByClassName('connectingLines' + busGenera).length == 0) {
                            //Quitamos el equipo de la lista equipo
                            for (var a = 0; a &lt; equipos.length; a++) {
                                if (equipos[a][0] == cont) {
                                    equipos.splice(a, 1);
                                }
                            }
                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busGenera).length; x++) {
                                document.getElementsByClassName("bus" + busGenera)[x].style.visibility = "hidden";
                            }
                        }
                        //Realizamos el mismo procedimiento en este caso
                    }
                    if (tipo2 == 1) {
                        $("#trSer" + equipos[cont][0]).remove();
                        $("#flechaSer" + equipos[cont][0]).remove();
                        $("#flechaSerInversa" + equipos[cont][0]).remove();
                        $("#lineaSerInversa" + equipos[cont][0]).remove();
                        $("#trSerEspacio" + equipos[cont][0]).remove();
                        if (numFlechas.length == 1) {
                            numFlechas = [];
                        } else {
                            while (numFlechas.indexOf(cont) > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont), 1);
                            }
                        }
                        if (numLineasInversa.length == 1) {
                            numLineasInversa = [];
                        } else {
                            while (numLineasInversa.indexOf(cont) > 0) {
                                numLineasInversa.splice(numLineasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numFlechasInversa.length == 1) {
                            numFlechasInversa = [];
                        } else {
                            while (numFlechasInversa.indexOf(cont) > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont), 1);
                            }
                        }
                        //Si no hay mas equipos en ese bus lo desconectamos
                        if (document.getElementsByClassName('connectingLines' + busAlimenta).length == 0) {
                            //Desconectamos el radio

                            //Quitamos el equipo de la lista equipo
                            for (var a = 0; a &lt; equipos.length; a++) {
                                if (equipos[a][0] == cont) {
                                    equipos.splice(a, 1);
                                }
                            }
                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busAlimenta).length; x++) {
                                document.getElementsByClassName("bus" + busAlimenta)[x].style.visibility = "hidden";
                            }
                        }
                        //Realizamos el mismo procedimiento en este caso
                    }
                    if (tipo2 == 2) {
                        $("#trSer" + cont).remove();
                        $("#lineaSer" + cont).remove();
                        $("#lineaSerInversa" + cont).remove();
                        $("#flechaSerInversa" + cont).remove();
                        /*    $("#flechaSerInversa" + cont).remove(); */
                        $("#flechaSer" + cont).remove();
                        /*  $("#flechaSer" + cont).remove(); */
                        $("#trSerEspacio" + cont).remove();
                        if (numFlechas.length == 1) {
                            numFlechas = [];
                        } else {
                            while (numFlechas.indexOf(cont) > 0) {
                                numFlechas.splice(numFlechas.indexOf(cont), 1);
                            }
                        }
                        if (numLineasInversa.length == 1) {
                            numLineasInversa = [];
                        } else {
                            while (numLineasInversa.indexOf(cont) > 0) {
                                numLineasInversa.splice(numLineasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numFlechasInversa.length == 1) {
                            numFlechasInversa = [];
                        } else {
                            while (numFlechasInversa.indexOf(cont) > 0) {
                                numFlechasInversa.splice(numFlechasInversa.indexOf(cont), 1);
                            }
                        }
                        if (numLineas.length == 1) {
                            numLineas = [];
                        } else {
                            while (numLineas.indexOf(cont) > 0) {
                                numLineas.splice(numLineas.indexOf(cont), 1);
                            }
                        }
                        //Si no hay mas equipos en ese bus lo desconectamos
                        if (document.getElementsByClassName('connectingLines' + busGenera).length == 0) {
                            //Quitamos el equipo de la lista equipo
                            for (var a = 0; a &lt; equipos.length; a++) {
                                if (equipos[a][0] == cont) {
                                    equipos.splice(a, 1);
                                }
                            }
                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busGenera).length; x++) {
                                document.getElementsByClassName("bus" + busGenera)[x].style.visibility = "hidden";
                            }
                        }
                        //Desconectamos el radio
                        if (document.getElementsByClassName('connectingLines' + busAlimenta).length == 0) {
                            //Ocultamos los buses si no hay elementos
                            for (var x = 0; x &lt; document.getElementsByClassName("bus" + busAlimenta).length; x++) {
                                document.getElementsByClassName("bus" + busAlimenta)[x].style.visibility = "hidden";
                            }
                        }
                    }
                    //Comprobamos si hay líneas genera creadas después del botón borrado
                }
                if (equipos.length > 0) {

                    for (var x = 0; x &lt; equipos.length; x++) {
                        var busModG = 0;
                        var busModA = 0;
                        var numeroC = equipos[x][2];
                        if (numeroC != "-") {
                            for (var y = 0; y &lt; colectores.length > 0; y++) {
                                if (numeroC == colectores[y][0]) {
                                    numeroC = colectores[y][1];
                                }
                            }
                        }
                        var numeroC1 = equipos[x][3];
                        if (numeroC1 != "-") {
                            for (var y = 0; y &lt; colectores.length > 0; y++) {
                                if (numeroC1 == colectores[y][0]) {
                                    numeroC1 = colectores[y][1];
                                }
                            }
                        }
                        for (var y = 1; y &lt; colectores.length + 1; y++) {
                            if (parseInt(colectores[y - 1][1]) == numeroC &amp;&amp; (y - 1) &lt; numColector) {
                                busModG++;
                            }
                            if (parseInt(colectores[y - 1][1]) == numeroC1 &amp;&amp; (y - 1) &lt; numColector) {
                                busModA++;
                            }
                        }
                        if (equipos[x][6] == "3" || equipos[x][6] == "1" || equipos[x][6] == "4") {
                            if (numeroC != "-") {
                                left = document.getElementById(equipos[x][2] + "-" + equipos[x][0]);
                                altura = document.getElementsByClassName("btnSerUso")[x];
                                izq = $(left).position().left;
                                long = $(left).width();
                                topB = $(altura).position().top;
                                leftB = $(altura).position().left;
                                topLineas = topB + (alt / 2) + 70;
                                topFlecha = topB + (alt / 2) + 57;
                                leftLineas = long + distancia;
                                widthLineas = izq - (leftB + 120);
                                //widthLineas = izq - (leftB + long) + 5;
                                topLineas = topB + (alt / 2) + 70;
                                leftFlecha = long + distancia - 10;
                                document.getElementById("lineaSer" + equipos[x][0]).style.width = widthLineas + "px";
                                document.getElementById("flechaSer" + equipos[x][0]).style.left = (izq + distancia - 28) + "px";
                                document.getElementById("flechaSerInversa" + equipos[x][0]).style.top = topFlecha + "px";
                                document.getElementById("lineaSer" + equipos[x][0]).style.top = topLineas + "px";
                                document.getElementById("flechaSer" + equipos[x][0]).style.top = topFlecha + "px";
                            }
                            if (numeroC1 != "-" &amp;&amp; equipos[x][2] != equipos[x][3]) {
                                left = document.getElementById(equipos[x][3] + "-" + equipos[x][0]);
                                altura = document.getElementsByClassName("btnSerUso")[x];
                                izq = $(left).position().left;
                                long = $(left).width();
                                topB = $(altura).position().top;
                                leftB = $(altura).position().left;
                                leftLineasInversa = long + distancia;
                                widthLineasInversa = izq - (leftB + 120);
                                topLineasInversa = topB + (alt / 2) + 90;
                                leftFlechaInversa = long + distancia - 10;
                                topFlechaInversa = topB + (alt / 2) + 77;
                                document.getElementById("lineaSerInversa" + equipos[x][0]).style.width = (widthLineasInversa) + "px";
                                document.getElementById("flechaSer" + equipos[x][0] + "A").style.left = (izq + distancia - 28) + "px";
                                document.getElementById("flechaSerInversa" + equipos[x][0] + "A").style.top = topFlechaInversa + "px";
                                document.getElementById("lineaSerInversa" + equipos[x][0]).style.top = topLineasInversa + "px";
                                document.getElementById("flechaSer" + equipos[x][0] + "A").style.top = topFlechaInversa + "px";
                            }
                        } else {
                            left = document.getElementById(equipos[x][3] + "-" + equipos[x][0]);
                            altura = document.getElementsByClassName("btnSerUso")[x];
                            izq = $(left).position().left;
                            long = $(left).width();
                            topB = $(altura).position().top;
                            leftB = $(altura).position().left;
                            topLineas = topB + (alt / 2) + 80;
                            topFlecha = topB + (alt / 2) + 67;
                            widthLineas = leftB - izq - 10;
                            leftLineas = izq + long + distancia;
                            leftFlecha = leftB - 25 + distancia;
                            document.getElementById("flechaSerInversa" + equipos[x][0]).style.left = (leftLineas - 8) + "px";
                            document.getElementById("lineaSer" + equipos[x][0]).style.left = leftLineas + "px";
                            document.getElementById("lineaSer" + equipos[x][0]).style.width = (widthLineas) + "px";
                            document.getElementById("flechaSer" + equipos[x][0]).style.left = leftFlecha + "px";
                            document.getElementById("flechaSerInversa" + equipos[x][0]).style.top = topFlecha + "px";
                            document.getElementById("lineaSer" + equipos[x][0]).style.top = topLineas + "px";
                            document.getElementById("flechaSer" + equipos[x][0]).style.top = topFlecha + "px";
                        }
                    }
                }
                
              
                $('#myModalCaracteristicas').modal('hide');
            }
        }
        /**

            *Hacemos visible el selector de modelos
            * @param  {number}
            * @return  {void}

            */
        updateModelos = function (tipo,cont,condicion) {
            document.getElementById('modelos').style.visibility = "visible";
            var keyword = document.getElementById("fabricante2").value;
            var select = document.getElementById("modelos2");
            //Cargamos el valor del fabricante elegido
            if (keyword != "0" &amp;&amp; document.getElementById("fabricante2").text != "Todos") {
                var fabri = $scope.valoresServicio[$scope.valoresServicio[keyword - 1].id - 1].fabricante;

                for (var j = 1; j &lt; select.length; j++) {
                    select.options[j].style.display = 'none';
                }
                //Filtramos los valores en función del fabricante
                for (var i = 0; i &lt; $scope.valoresServicio.length; i++) {
                    if ($scope.valoresServicio[i].fabricante == fabri) {
                        for (var j = 0; j &lt; select.length; j++) {
                            var txt = select.options[j].text;
                            if (txt == $scope.valoresServicio[i].modelo) {
                                select.options[j].style.display = 'list-item';
                                break;
                            }
                        }
                    }
                }
                var usedNames = {};
                $("select[id='modelos2'] > option").each(function () {
                    if (usedNames[this.text]) {
                        $(this).remove();
                    } else {
                        usedNames[this.text] = this.text;
                    }
                });
            } else if (document.getElementById("fabricante2").options[document.getElementById("fabricante2").selectedIndex].text == "Todos") {
                var fabri = "0";

                for (var j = 0; j &lt; select.length; j++) {
                    select.options[j].style.display = 'list-item';
                }
            }
            //Después filtramos los valores repetidos
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword == "0" &amp;&amp; document.getElementById("fabricante2").options[document.getElementById("fabricante2").selectedIndex].text != "Todos") {
                //En caso contrario se pondrá el valor por defecto y se hará invisible
                document.getElementById('modelos').style.visibility = "hidden";
                if ($scope.valoresTipo.length > 1) {
                    document.getElementById('tipos').style.visibility = "hidden";
                }
                for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                    document.getElementsByClassName('inputs')[y].style.visibility = "hidden";
                }
                
                valoresServiciosComplementos[a][0] = "0";
            } else if (keyword != "0") {
                //En caso contrario se harán visibles
               var e = document.getElementById("fabricante2");

                //Almacenamos el valor en una lista
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][0] = $scope.valoresServicio[strUser - 1].fabricante;
            } else if (document.getElementById("fabricante2").options[document.getElementById("fabricante2").selectedIndex].text == "Todos") {
                valoresServiciosComplementos[a][0] = "0";
                updateTipos(tipo, cont, condicion);
            }
        }
        /**

            *Hacemos visible el selector de modelos para fabricante
            * @param  {number}
            * @return  {void}

            */
        updateModelosComplemento = function (cont, clase) {
            //Hacemos visible el select de modelos
            document.getElementById('modelosComplemento').style.visibility = "visible";
            var keyword = document.getElementById("fabricanteComplemento2").value;
            var select = document.getElementById("modelosComplemento2");
            //Cargamos el valor del fabricante elegido
            var fabri = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].fabricante;
            for (var j = 0; j &lt; select.length; j++) {
                select.options[j].style.display = 'none';
            }
            for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {
                if ($scope.valoresComplemento[i].fabricante == fabri) {
                    for (var j = 0; j &lt; select.length; j++) {
                        var txt = select.options[j].text;
                        if (txt == $scope.valoresComplemento[i].modelo) {
                            select.options[j].style.display = 'list-item';
                            break;
                        }
                    }
                }
            }
            //Después filtramos los valores repetidos
            var usedNames = {};
            $("select[id='modelosComplemento2'] > option").each(function () {
                if (usedNames[this.text]) {
                    $(this).remove();
                } else {
                    usedNames[this.text] = this.text;
                }
            });
            var e = document.getElementById("fabricanteComplemento2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword == "0") {
                document.getElementById('modelosComplemento').style.visibility = "hidden";
                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                }
                document.getElementById("modelosComplemento2").value = '0';
                if (clase == "15") {
                    document.getElementById('tiposRegulacionComplemento').style.visibility = "hidden";
                    document.getElementById("tiposRegulacionComplemento2").value = '0';
                } else {
                    if ($scope.valoresTipo.length > 1) {
                        document.getElementById('tiposComplemento').style.visibility = "hidden";
                        document.getElementById("tiposComplemento2").value = '0';
                    }
                }
                valoresServiciosComplementos[a][0] = "0";
            } else {
                //En caso contrario se harán visibles
                document.getElementById("modelosComplemento2").value = '0';
                if (clase == "15") {
                    document.getElementById("tiposRegulacionComplemento2").value = '0';
                } else {
                    if ($scope.valoresTipo.length > 1) {
                        document.getElementById("tiposComplemento2").value = '0';
                    }
                }
                //almacenamos el valor escogido en un array
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][0] = $scope.valoresComplemento[strUser - 1].fabricante;
            }
        }
        /**

            *Hacemos visible el selector de modelos para nombre
            * @param  {number}
            * @return  {void}

            */
        updateModelosComplemento2 = function (cont, clase) {
            //Hacemos visible el select de modelo
            document.getElementById('modelosComplemento').style.visibility = "visible";
            var keyword = document.getElementById("nombreComplemento2").value;
            var select = document.getElementById("modelosComplemento2");
            //Cargamos el valor del nombre elegido
            var fabri = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].nombre;
            for (var j = 0; j &lt; select.length; j++) {
                select.options[j].style.display = 'none';
            }
            for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {
                if ($scope.valoresComplemento[i].nombre == fabri) {
                    for (var j = 0; j &lt; select.length; j++) {
                        var txt = select.options[j].text;
                        if (txt == $scope.valoresComplemento[i].modelo) {
                            select.options[j].style.display = 'list-item';
                            break;
                        }
                    }
                }
            }
            //Después filtramos los valores repetidos
            var usedNames = {};
            $("select[id='modelosComplemento2'] > option").each(function () {
                if (usedNames[this.text]) {
                    $(this).remove();
                } else {
                    usedNames[this.text] = this.text;
                }
            });
            var e = document.getElementById("nombreComplemento2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
                //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            } if (keyword == "0") {
                document.getElementById('modelosComplemento').style.visibility = "hidden";
                if (clase == "15") {
                    document.getElementById('tiposRegulacionComplemento').style.visibility = "hidden";
                    document.getElementById("tiposRegulacionComplemento2").value = '0';
                } else {
                    if ($scope.valoresTipo.length > 1) {
                        document.getElementById('tiposComplemento').style.visibility = "hidden";
                        document.getElementById("tiposComplemento2").value = '0';
                    }
                }
                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                }
                document.getElementById("modelosComplemento2").value = '0';
                valoresServiciosComplementos[a][0] = "0";
            } else {
                //En caso contrario se harán visibles
                document.getElementById("modelosComplemento2").value = '0';
                if (clase == "15") {
                    document.getElementById("tiposRegulacionComplemento2").value = '0';
                } else {
                    if ($scope.valoresTipo.length > 1) {
                        document.getElementById("tiposComplemento2").value = '0';
                    }
                }
                //almacenamos el valor escogido en un array
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][0] = $scope.valoresComplemento[strUser - 1].nombre;
            }
        }
        /**

            *Hacemos visibles los inputs
            * @param  {number}
            * @return  {void}

            */
        updateTipos = function (tipo, cont, condicion) {
            var keyword = document.getElementById("fabricante2").value;
            if (keyword != "0") {
                var fabri = $scope.valoresServicio[$scope.valoresServicio[keyword - 1].id - 1].fabricante;
            } else {
                var fabri = 0;
            }
            var keyword2 = document.getElementById("modelos2").value;
            if (keyword2 != "0" &amp;&amp; document.getElementById("modelos2").options[document.getElementById("modelos2").selectedIndex].text != "Todos" &amp;&amp; fabri != 0) {
                var modelo = $scope.valoresServicio[$scope.valoresServicio[keyword2 - 1].id - 1].modelo;


                if ($scope.valoresTipo.length > 1) {
                    var select = document.getElementById("tipos2");
                    document.getElementById('tipos').style.visibility = "visible";
                    for (var j = 1; j &lt; select.length; j++) {
                        select.options[j].style.display = 'none';
                    }
                    var select = document.getElementById("tipos2");
                    for (var i = 0; i &lt; $scope.valoresServicio.length; i++) {
                        if ($scope.valoresServicio[i].modelo == modelo &amp;&amp; $scope.valoresServicio[i].fabricante == fabri) {
                            for (var j = 0; j &lt; select.length; j++) {
                                var txt = select.options[j].text;
                                if (txt == $scope.valoresServicio[i].tipo) {
                                    select.options[j].style.display = 'list-item';
                                    break;
                                }
                            }
                        }
                    }
                    //Después filtramos los valores repetidos
                    var usedNames = {};
                    $("select[id='tipos2'] > option").each(function () {
                        if (usedNames[this.text]) {
                            $(this).remove();
                        } else {
                            usedNames[this.text] = this.text;
                        }
                    });
                }
            } if (keyword2 != "0" &amp;&amp; document.getElementById("modelos2").options[document.getElementById("modelos2").selectedIndex].text != "Todos" &amp;&amp; fabri == 0) {
                var modelo = $scope.valoresServicio[$scope.valoresServicio[keyword2 - 1].id - 1].modelo;


                if ($scope.valoresTipo.length > 1) {
                    var select = document.getElementById("tipos2");
                    
                    document.getElementById('tipos').style.visibility = "visible";
                    for (var j = 1; j &lt; select.length; j++) {
                        select.options[j].style.display = 'none';
                    }
                    var select = document.getElementById("tipos2");
                    for (var i = 0; i &lt; $scope.valoresServicio.length; i++) {
                        if ($scope.valoresServicio[i].modelo == modelo) {
                            for (var j = 1; j &lt; select.length; j++) {
                                var txt = select.options[j].text;
                                if (txt == $scope.valoresServicio[i].tipo) {
                                    select.options[j].style.display = 'list-item';
                                    break;
                                }
                            }
                        }
                    }
                    //Después filtramos los valores repetidos
                    var usedNames = {};
                    $("select[id='tipos2'] > option").each(function () {
                        if (usedNames[this.text]) {
                            $(this).remove();
                        } else {
                            usedNames[this.text] = this.text;
                        }
                    });
                }
            } else if (document.getElementById("modelos2").options[document.getElementById("modelos2").selectedIndex].text == "Todos") {
                var modelo ="0";
                if ($scope.valoresTipo.length > 1) {
                    
                var select = document.getElementById("tipos2");
                    var select2 = document.getElementById("modelos2");
                    for (var j = 1; j &lt; select.length; j++) {
                        select.options[j].style.display = 'none';
                    }
                    for (var i = 0; i &lt; select2.length; i++) {
                        if (select2.options[i].style.display == 'list-item' &amp;&amp; select2.options[i].text !="Todos") {
                            for (var j = 1; j &lt; select.length; j++) {
                                var txt = select2.options[i].text;
                                if (j != select.length - 1) {
                                if (txt == $scope.valoresTipo[j].modelo) {
                                    select.options[j].style.display = 'list-item';
                                }
                                }
                            }
                        }
                    }
               
                }
            }
            var e = document.getElementById("modelos2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword2 == "0" &amp;&amp; document.getElementById("modelos2").options[document.getElementById("modelos2").selectedIndex].text != "Todos") {
            
                for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                    document.getElementsByClassName('inputs')[y].style.visibility = "hidden";
                }
                valoresServiciosComplementos[a][1] = "0";
            } else if (keyword2 != "0") {
                //En caso contrario se harán 
                
                if ($scope.valoresTipo.length > 1) {
                   // document.getElementById("tipos2").value = '0';
                } else {
                    valoresServiciosComplementos[a][1] = $scope.valoresServicio[$scope.valoresServicio[keyword2 - 1].id - 1].modelo;
                    updateInputs(tipo, cont,1);
                }
                //almacenamos el valor escogido en un array
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][1] = $scope.valoresServicio[strUser - 1].modelo;
            } else if (document.getElementById("modelos2").options[document.getElementById("modelos2").selectedIndex].text == "Todos") {
                if ($scope.valoresTipo.length > 1) {
                document.getElementById('tipos').style.visibility = "visible";
                } else {
                    valoresServiciosComplementos[a][1] = "0";
                    updateInputs(tipo, cont, condicion);
                }
                valoresServiciosComplementos[a][1] = "0";
                updateInputs(tipo, cont, condicion);
                
            }
        }
       
         /**

            *Hacemos visibles los inputs
            * @param  {number}
            * @return  {void}

            */
        updateTiposComplementos = function (cont, clase) {
            if ($scope.valoresTipo.length > 1) {
                document.getElementById('tiposComplemento').style.visibility = "visible";
            }
            //cargamos los valores en función del tipo de complemento
            if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                var keyword = document.getElementById("nombreComplemento2").value;
                var nombre = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].nombre;
            } else {
                var keyword = document.getElementById("fabricanteComplemento2").value;
                var fabri = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].fabricante;
            }
            var keyword2 = document.getElementById("modelosComplemento2").value;
            if ($scope.valoresTipo.length > 1) {
                var select = document.getElementById("tiposComplemento2");
                var modelo = $scope.valoresComplemento[$scope.valoresComplemento[keyword2 - 1].id - 1].modelo;
                //A continuación filtramos los valores por fabricante o nombre dependiendo del complemento
                if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                    for (var j = 0; j &lt; select.length; j++) {
                        select.options[j].style.display = 'none';
                    }
                    for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {
                        if ($scope.valoresComplemento[i].modelo == modelo &amp;&amp; $scope.valoresComplemento[i].nombre == nombre) {
                            for (var j = 0; j &lt; select.length; j++) {
                                var txt = select.options[j].text;
                                if (txt == $scope.valoresComplemento[i].tipo) {
                                    select.options[j].style.display = 'list-item';
                                    break;
                                }
                            }
                        }
                    }
                } else {
                    for (var j = 0; j &lt; select.length; j++) {
                        select.options[j].style.display = 'none';
                    }
                    for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {
                        if ($scope.valoresComplemento[i].modelo == modelo &amp;&amp; $scope.valoresComplemento[i].fabricante == fabri) {
                            for (var j = 0; j &lt; select.length; j++) {
                                var txt = select.options[j].text;
                                if (txt == $scope.valoresComplemento[i].tipo) {
                                    select.options[j].style.display = 'list-item';
                                    break;
                                }
                            }
                        }
                    }
                }
            }//Después filtramos los valores repetidos
            var usedNames = {};
            $("select[id='tiposComplemento2'] > option").each(function () {
                if (usedNames[this.text]) {
                    $(this).remove();
                } else {
                    usedNames[this.text] = this.text;
                }
            });
            var e = document.getElementById("modelosComplemento2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword == "0") {
                //En caso contrario se cargará el valor por defecto y se hará invisible el select
                if ($scope.valoresTipo.length > 1) {
                    document.getElementById('tiposComplemento').style.visibility = "hidden";
                }
                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                }
                if ($scope.valoresTipo.length > 1) {
                    document.getElementById("tiposComplemento2").value = '0';
                }
                valoresServiciosComplementos[a][1] = "0";
            } else {
                if ($scope.valoresTipo.length > 1) {
                    document.getElementById("tiposComplemento2").value = '0';
                } else {
                    updateInputsComplemento(cont, clase);
                }
                //Almacenamos el valor escogida en un array
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][1] = $scope.valoresComplemento[strUser - 1].modelo;
            }
        }
         /**

            *Hacemos visible el selector de regulación
            * @param  {number}
            * @return  {void}

            */
        updateRegulacion = function (cont) {
            document.getElementById('regulacionComplemento').style.visibility = "visible";
            var keyword = document.getElementById("nombreComplemento2").value;
            var keyword2 = document.getElementById("tiposComplemento2").value;
            var keyword3 = document.getElementById("modelosComplemento2").value;
            var select = document.getElementById("regulacionComplemento2");
            var nombre = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].nombre;
            var modelo = $scope.valoresComplemento[$scope.valoresComplemento[keyword3 - 1].id - 1].modelo;
            var tipo = $scope.valoresComplemento[$scope.valoresComplemento[keyword2 - 1].id - 1].tipo;
            for (var j = 0; j &lt; select.length; j++) {
                select.options[j].style.display = 'none';
            }
            for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {

                if ($scope.valoresComplemento[i].tipo == tipo &amp;&amp; $scope.valoresComplemento[i].nombre == nombre &amp;&amp; $scope.valoresComplemento[i].modelo == modelo) {
                    for (var j = 0; j &lt; select.length; j++) {
                        var txt = select.options[j].text;
                        if (txt == $scope.valoresComplemento[i].regulaciÓn) {
                            select.options[j].style.display = 'list-item';
                            break;
                        }
                    }
                }
            }
            var usedNames = {};
            $("select[id='regulacionComplemento2'] > option").each(function () {
                if (usedNames[this.text]) {
                    $(this).remove();
                } else {
                    usedNames[this.text] = this.text;
                }
            });
            var e = document.getElementById("tiposComplemento2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword == "0") {
                //En caso contrario se cargará el valor por defecto y se hará invisible el select
                document.getElementById('regulacionComplemento').style.visibility = "hidden";
                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                }
                document.getElementById("regulacionComplemento2").value = '0';
                valoresServiciosComplementos[a][2] = "0";
            } else {
                document.getElementById("regulacionComplemento2").value = '0';
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][2] = $scope.valoresComplemento[strUser - 1].tipo;
            }
        }
        /**

            *Hacemos visibles los inputs
            * @param  {number}
            * @return  {void}

            */
        updateModeloInversorComplementos = function (cont, clase) {
            if ($scope.valoresTipo.length > 1) {
                document.getElementById('modeloInversorComplementos').style.visibility = "visible";
            }
            //cargamos los valores en función del tipo de complemento
            if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                var keyword = document.getElementById("nombreComplemento2").value;
            } else {
                var keyword = document.getElementById("fabricanteComplemento2").value;
                var fabri = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].fabricante;
            }
            var keyword2 = document.getElementById("modelosComplemento2").value;
            var select = document.getElementById("modeloInversorComplementos2");
            var modelo = $scope.valoresComplemento[$scope.valoresComplemento[keyword2 - 1].id - 1].modelo;
            //A continuación filtramos los valores por fabricante o nombre dependiendo del complemento

            for (var j = 0; j &lt; select.length; j++) {
                select.options[j].style.display = 'none';
            }
            for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {
                if ($scope.valoresComplemento[i].modelo == modelo &amp;&amp; $scope.valoresComplemento[i].fabricante == fabri) {
                    for (var j = 0; j &lt; select.length; j++) {
                        var txt = select.options[j].text;
                        if (txt == $scope.valoresComplemento[i].tipo) {
                            select.options[j].style.display = 'list-item';
                            break;
                        }
                    }
                }
            }

            //Después filtramos los valores repetidos
            var usedNames = {};
            $("select[id='modeloInversorComplementos2'] > option").each(function () {
                if (usedNames[this.text]) {
                    $(this).remove();
                } else {
                    usedNames[this.text] = this.text;
                }
            });
            var e = document.getElementById("modelosComplemento2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword == "0") {
                //En caso contrario se cargará el valor por defecto y se hará invisible el select

                document.getElementById('modeloInversorComplementos').style.visibility = "hidden";

                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                }

                document.getElementById("modeloInversorComplementos2").value = '0';

            } else {

                document.getElementById("modeloInversorComplementos2").value = '0';

                //Almacenamos el valor escogida en un array
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][1] = $scope.valoresComplemento[strUser - 1].modelo;
            }
        }
        /**

            *Hacemos visible el selector de precios
            * @param  {number}
            * @return  {void}

            */
        updatePreciosComplementos = function (cont) {
            document.getElementById('preciosComplemento').style.visibility = "visible";
            var keyword = document.getElementById("nombreComplemento2").value;
            var keyword2 = document.getElementById("modeloInversorComplementos2").value;
            var keyword3 = document.getElementById("modelosComplemento2").value;
            var select = document.getElementById("preciosComplemento2");
            var nombre = $scope.valoresComplemento[$scope.valoresComplemento[keyword - 1].id - 1].nombre;
            var modelo = $scope.valoresComplemento[$scope.valoresComplemento[keyword3 - 1].id - 1].modelo;
            var modelo_inversor = $scope.valoresComplemento[$scope.valoresComplemento[keyword2 - 1].id - 1].modelo_inversor;
            for (var j = 0; j &lt; select.length; j++) {
                select.options[j].style.display = 'none';
            }
            for (var i = 0; i &lt; $scope.valoresComplemento.length; i++) {
                if ($scope.valoresComplemento[i].modelo_inversor == modelo_inversor &amp;&amp; $scope.valoresComplemento[i].modelo_inversor == modelo_inversor &amp;&amp; $scope.valoresComplemento[i].nombre == nombre &amp;&amp; $scope.valoresComplemento[i].modelo == modelo) {
                    for (var j = 0; j &lt; select.length; j++) {
                        var txt = select.options[j].text;
                        if (txt == $scope.valoresComplemento[i].regulaciÓn) {
                            select.options[j].style.display = 'list-item';
                            break;
                        }
                    }
                }
            }
            //Filtramos los repetidos
            var usedNames = {};
            $("select[id='preciosComplemento2'] > option").each(function () {
                if (usedNames[this.text]) {
                    $(this).remove();
                } else {
                    usedNames[this.text] = this.text;
                }
            });
            var e = document.getElementById("modeloInversorComplementos2");
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //SI seleccionamos un valor del select se harán visibles los valores y se cargarán los valores correspondientes
            if (keyword == "0") {
                //En caso contrario se cargará el valor por defecto y se hará invisible el select
                document.getElementById('preciosComplemento').style.visibility = "hidden";
                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                }
                document.getElementById("preciosComplemento2").value = '0';
                valoresServiciosComplementos[a][3] = "0";
            } else {
                document.getElementById("preciosComplemento2").value = '0';
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                valoresServiciosComplementos[a][3] = $scope.valoresComplemento[strUser - 1].precio_euros_pack;
            }
        }
        /**

            *Cargamos los valores de los campos correspondientes
            * @param  {number}
            * @return  {void}

            */
        updateInputs = function (tipS, cont,condicion) {
            //Cargamos los valores elegidos en los select anteriores
            var contEquiposFiltrados=0;
            var valFabri = false;
            var valModelo = false;
            var valTipo = false;
            var modelo = document.getElementById("modelos2").value;
            var fabri = document.getElementById("fabricante2").value;
            if ($scope.valoresTipo.length > 1) {
                var tipos = document.getElementById("tipos2").value;
            } else {
                
                tipos = $scope.valoresServicio[0].id;
                
            }
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    a = x;
                }
            }
            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                document.getElementsByClassName('inputs')[y].style.visibility = "visible";
            }

            for (var x = 0; x &lt; copiaParametros.length; x++) {
                document.getElementById(copiaParametros[x]).value = "0";
            }   
            //asigamos los valores en función del tipo de equipo
            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||$scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" || $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" || $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                for (var x = 0; x &lt; $scope.valoresServicio.length; x++) {
                    valFabri = false;
                    valModelo = false;
                    valTipo = false;
                    if (document.getElementById("fabricante2").value == "0") {
                        valFabri = true;
                    } else {
                        if ($scope.valoresServicio[document.getElementById("fabricante2").value - 1].fabricante == $scope.valoresServicio[x].fabricante) {
                            valFabri = true;
                    }                       
                    }
                    if (document.getElementById("modelos2").value == "0") {
                        valModelo = true;
                    } else {
                        if ($scope.valoresServicio[document.getElementById("modelos2").value - 1].modelo == $scope.valoresServicio[x].modelo) {
                            valModelo = true;
                        }
                    }
                    if ($scope.valoresServicio[0].idservicio == "5" || $scope.valoresServicio[0].idservicio == "32" || $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34"){
                    if (document.getElementById("tipos2").value == "0") {
                        valTipo = true;
                    } else {
                        if ($scope.valoresServicio[document.getElementById("tipos2").value - 1].tipo == $scope.valoresServicio[x].tipo) {
                            valTipo = true;
                        }
                    }
                    } else {
                        valTipo = true;
                    }
                    //Creamos el filtro en función de cual de los selectores esté a 0 de los selectores
                    if (valFabri == true &amp;&amp; valTipo == true &amp;&amp; valModelo== true) {
                            for (var contadorparametro = 0; contadorparametro &lt; copiaParametros.length; contadorparametro++) {
                                if (copiaParametros[contadorparametro] == "Precio (€)") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["Precio (€)"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {

                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["Precio (€)"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["Precio (€)"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["Precio (€)"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["Precio (€)"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["Precio (€)"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["Precio (€)"];
                                    }
                                } else if (copiaParametros[contadorparametro] == "area_captador_m2") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["area_captador_m2"];
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["area_captador_m2"];
                                    }
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["area_captador_m2"];
                                    }
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseInt($scope.valoresServicio[x]["area_captador_m2"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["area_captador_m2"];
                                    }
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseInt($scope.valoresServicio[x]["area_captador_m2"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["area_captador_m2"];
                                    }

                                } else if (copiaParametros[contadorparametro] == "potencia_refrigeracion_kw") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["potencia_refrigeracion_kw"];
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["potencia_refrigeracion_kw"];
                                    }
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["potencia_refrigeracion_kw"];
                                    }
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseInt($scope.valoresServicio[x]["potencia_refrigeracion_kw"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["potencia_refrigeracion_kw"];
                                    }
                                    if (parseInt(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseInt($scope.valoresServicio[x]["potencia_refrigeracion_kw"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["potencia_refrigeracion_kw"];
                                    }
                                }else if (copiaParametros[contadorparametro] == "capacidad_nominal_calefaccion_kw") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["capacidad_nominal_calefaccion_kw"];
                                    }
                                } else if (copiaParametros[contadorparametro] == "capacidad_nominal_refrigeracion_kw") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["capacidad_nominal_refrigeracion_kw"];
                                    }
                                } else if (copiaParametros[contadorparametro] == "Número de calderas") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["Número de calderas"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["Número de calderas"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["Número de calderas"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["Número de calderas"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["Número de calderas"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["Número de calderas"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["Número de calderas"];
                                    }
                                }
                                else if (copiaParametros[contadorparametro] == "Potencia útil (kW)") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["Potencia útil (kW)"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["Potencia útil (kW)"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["Potencia útil (kW)"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["Potencia útil (kW)"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["Potencia útil (kW)"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["Potencia útil (kW)"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["Potencia útil (kW)"];
                                    }
                                }
                                else if (copiaParametros[contadorparametro] == "COP nominal") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["COP nominal"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["COP nominal"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["COP nominal"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["COP nominal"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["COP nominal"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["COP nominal"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["COP nominal"];
                                    }
                                }
                                else if (copiaParametros[contadorparametro] == "EER nominal") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["EER nominal"];
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["EER nominal"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) == 0) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["EER nominal"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 1]).value) >= parseFloat($scope.valoresServicio[x]["EER nominal"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 1]).value = $scope.valoresServicio[x]["EER nominal"];
                                    }
                                    if (parseFloat(document.getElementById(copiaParametros[contadorparametro + 2]).value) &lt;= parseFloat($scope.valoresServicio[x]["EER nominal"])) {
                                        document.getElementById(copiaParametros[contadorparametro + 2]).value = $scope.valoresServicio[x]["EER nominal"];
                                    }
                                }
                                else {
                                    var copiaP = copiaParametros[contadorparametro];
                                    copiaP = copiaP.substring(0, 3);
                                    if (copiaP != "min" &amp;&amp; copiaP != "max") {
                                        document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x][copiaParametros[contadorparametro]];
                                    }

                                }
                            }
                        }
                    }
                
            } else {
                for (var x = 0; x &lt; $scope.valoresServicio.length; x++) {
                    if ($scope.valoresServicio[x].modelo == $scope.valoresServicio[modelo - 1].modelo &amp;&amp; $scope.valoresServicio[x].tipo == $scope.valoresServicio[tipos - 1].tipo &amp;&amp; $scope.valoresServicio[x].fabricante == $scope.valoresServicio[fabri - 1].fabricante) {
                        if (tipS == "1") {
                            for (var contadorparametro = 0; contadorparametro &lt; copiaParametros.length; contadorparametro++) {
                                if (copiaParametros[contadorparametro] == "min" || copiaParametros[contadorparametro] == "max") {
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x]["Potencia útil (kW)"]
                                }
                                else
                                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresServicio[x][copiaParametros[contadorparametro]];
                            }
                        }
                    }
                }
            }

            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //Creamos la separación de contadores de frío y calor para determinados equipos
            if (($scope.valoresServicio[0].idservicio == "3" || $scope.valoresServicio[0].idservicio == "16" || $scope.valoresServicio[0].idservicio == "10" || $scope.valoresServicio[0].idservicio == "12" || $scope.valoresServicio[0].idservicio == "11") &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                if ($scope.valoresServicio[0].idservicio != "12") {
                    for (var y = 0; y &lt; document.getElementsByClassName('inputs').length / 2; y++) {
                        //Sacamos los valores de los atributos
                        caracteristicas[a][y] = document.getElementById(copiaParametros[y] + " calor").value;
                        if (caracteristicas[a][y] == "") {
                            ceros++;
                        }
                        par = x;
                    }
                } else {
                    caracteristicas[a][0] = document.getElementById(copiaParametros[0] + " frio").value;
                    if (caracteristicas[a][0] == "") {
                        ceros++;
                    }
                    caracteristicas[a][1] = document.getElementById(copiaParametros[1] + " frio").value;
                    if (caracteristicas[a][1] == "") {
                        ceros++;
                    }
                    par = x;
                }
                if ($scope.valoresServicio[0].idservicio != "12") {
                    for (var y = 0; y &lt; document.getElementsByClassName('inputs').length / 2; y++) {
                        //Sacamos los valores de los atributos
                        caracteristicas[a][(y + copiaParametros.length)] = document.getElementById(copiaParametros[y] + " frio").value;
                        if (caracteristicas[a][(y + copiaParametros.length)] == "") {
                            ceros++;
                        }
                        par = x;
                    }
                } else {
                    caracteristicas[a][2] = document.getElementById(copiaParametros[0] + " recuperacion").value;
                    if (caracteristicas[a][2] == "") {
                        ceros++;
                    }

                    caracteristicas[a][3] = document.getElementById("% demanda recuperacion").value;
                    if (caracteristicas[a][3] == "") {
                        ceros++;
                    }
                    par = x;

                }
            } else {
                for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                    //Sacamos los valores de los atributos
                    caracteristicas[a][y] = document.getElementById(copiaParametros[y]).value;
                    if (caracteristicas[a][y] == "") {
                        ceros++;
                    }
                    par = x;
                }
                }
            if ($scope.valoresTipo.length > 1) {
                var e = document.getElementById("tipos2");
                var strUser = e.options[e.selectedIndex].value;
                strUser = Number(strUser);
                if (document.getElementById("tipos2").options[document.getElementById("tipos2").selectedIndex].text != "Todos") {
                    valoresServiciosComplementos[a][2] = $scope.valoresServicio[strUser - 1].tipo;
                } else {
                    valoresServiciosComplementos[a][2] = "0";
                }
            } else {
                valoresServiciosComplementos[a][2] = $scope.valoresServicio[0].tipo;
                
            }
            //Filtramos los equipos
            if ((valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][2] == "0") &amp;&amp; condicion==1) {
                if (equipos[a][1] == " captadores planos") {
                    for (var y = 0; y &lt; $scope.captadores.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0") {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0" ) {
                            valModelo = true;
                        }

                        if ((valFabri == true || valModelo == true ) &amp;&amp; parseFloat($scope.captadores[y]["area_captador_m2"]) >= parseFloat(document.getElementById("min area_captador_m2").value) &amp;&amp; parseFloat($scope.captadores[y]["area_captador_m2"]) &lt;= parseFloat(document.getElementById("max area_captador_m2").value)) {
                            contEquiposFiltrados++;

                        }
                    }
                }
                if (equipos[a][1] == " Tubo de vacío") {
                    for (var y = 0; y &lt; $scope.tubosVacio.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0") {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0" ) {
                            valModelo = true;
                        }
                        if ((valFabri == true || valModelo == true) &amp;&amp; parseFloat($scope.tubosVacio[y]["area_captador_m2"]) >= parseFloat(document.getElementById("min area_captador_m2").value) &amp;&amp; parseFloat($scope.tubosVacio[y]["area_captador_m2"]) &lt;= parseFloat(document.getElementById("max area_captador_m2").value)) {
                            contEquiposFiltrados++;

                        }
                    }
                }
                if (equipos[a][1] == " Simple efecto") {
                    for (var y = 0; y &lt; $scope.mase.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0" ) {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0" ) {
                            valModelo = true;
                        }
                        if (valoresServiciosComplementos[a][2] == "0" ) {
                            valTipo = true;
                        }
                        if ((valFabri == true || valModelo == true || valTipo == true) &amp;&amp; parseFloat($scope.mase[y]["potencia_refrigeracion_kw"]) >= parseFloat(document.getElementById("min potencia_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.mase[y]["potencia_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max potencia_refrigeracion_kw").value)) {
                            contEquiposFiltrados++;

                        }
                    }
                }
                if (equipos[a][1] == " Baja temperatura") {
                    for (var y = 0; y &lt; $scope.calderasbt.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0") {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0" ) {
                            valModelo = true;
                        }

                        if ((valFabri == true || valModelo == true) &amp;&amp; parseFloat($scope.calderasbt[y]["Potencia útil (kW)"]) >= parseFloat(document.getElementById("min Potencia útil (kW)").value) &amp;&amp; parseFloat($scope.calderasbt[y]["Potencia útil (kW)"]) &lt;= parseFloat(document.getElementById("max Potencia útil (kW)").value)) {
                            contEquiposFiltrados++;

                        }
                    }
                }
                if (equipos[a][1] == "Caldera condensación") {
                    for (var y = 0; y &lt; $scope.calderascondensacion.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0") {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0") {
                            valModelo = true;
                        }

                        if ((valFabri == true || valModelo == true) &amp;&amp; parseFloat($scope.calderascondensacion[y]["Potencia útil (kW)"]) >= parseFloat(document.getElementById("min Potencia útil (kW)").value) &amp;&amp; parseFloat($scope.calderascondensacion[y]["Potencia útil (kW)"]) &lt;= parseFloat(document.getElementById("max Potencia útil (kW)").value)) {
                            contEquiposFiltrados++;
                        }
                    }
                }
                if (equipos[a][1] == "Calderas de biomasa") {
                    for (var y = 0; y &lt; $scope.calderasbiomasa.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0" ) {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0") {
                            valModelo = true;
                        }

                        if ((valFabri == true || valModelo == true) &amp;&amp; parseFloat($scope.calderasbiomasa[y]["Potencia útil (kW)"]) >= parseFloat(document.getElementById("min Potencia útil (kW)").value) &amp;&amp; parseFloat($scope.calderasbiomasa[y]["Potencia útil (kW)"]) &lt;= parseFloat(document.getElementById("max Potencia útil (kW)").value)) {
                            contEquiposFiltrados++;
                        }
                    }

                }
                if (equipos[a][1] == "Bomba de calor aire agua") {
                    for (var y = 0; y &lt; $scope.bombacaloraireagua.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0") {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0") {
                            valModelo = true;
                        }
                        if (valoresServiciosComplementos[a][2] == "0") {
                            valTipo = true;
                        }
                        if ((valFabri == true || valModelo == true || valTipo == true) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_refrigeracion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_refrigeracion_kw").value) &amp;&amp;
                            parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_calefaccion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_calefaccion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_calefaccion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_calefaccion_kw").value) &amp;&amp;
                            parseFloat($scope.bombacaloraireagua[y]["COP nominal"]) >= parseFloat(document.getElementById("min COP nominal").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["COP nominal"]) &lt;= parseFloat(document.getElementById("max COP nominal").value) &amp;&amp;
                            parseFloat($scope.bombacaloraireagua[y]["EER nominal"]) >= parseFloat(document.getElementById("min EER nominal").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["EER nominal"]) &lt;= parseFloat(document.getElementById("max EER nominal").value)) {
                            contEquiposFiltrados++;
                        }
                    }
                }
                if (equipos[a][1] == "Bomba de calor agua agua") {
                    for (var y = 0; y &lt; $scope.bombacaloraguaagua.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0" ) {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0" ) {
                            valModelo = true;
                        }
                        if (valoresServiciosComplementos[a][2] == "0" ) {
                            valTipo = true;
                        }
                        if ((valFabri == true || valModelo == true || valTipo == true) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_refrigeracion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_refrigeracion_kw").value) &amp;&amp;
                            parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_calefaccion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_calefaccion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_calefaccion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_calefaccion_kw").value) &amp;&amp;
                            parseFloat($scope.bombacaloraguaagua[y]["COP nominal"]) >= parseFloat(document.getElementById("min COP nominal").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["COP nominal"]) &lt;= parseFloat(document.getElementById("max COP nominal").value) &amp;&amp;
                            parseFloat($scope.bombacaloraguaagua[y]["EER nominal"]) >= parseFloat(document.getElementById("min EER nominal").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["EER nominal"]) &lt;= parseFloat(document.getElementById("max EER nominal").value)) {
                            contEquiposFiltrados++;
                        }
                    }
                }
                if (equipos[a][1] == "Enfriadora con recuperación") {
                    for (var y = 0; y &lt; $scope.enfriadorarecuperacion.length; y++) {
                        valFabri = false;
                        valModelo = false;
                        valTipo = false;
                        if (valoresServiciosComplementos[a][0] == "0") {
                            valFabri = true;
                        }
                        if (valoresServiciosComplementos[a][1] == "0") {
                            valModelo = true;
                        }
                        if (valoresServiciosComplementos[a][2] == "0" ) {
                            valTipo = true;
                        }
                        if ((valFabri == true || valModelo == true || valTipo == true) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_refrigeracion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_refrigeracion_kw").value) &amp;&amp;
                            parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_calefaccion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_calefaccion_kw").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_calefaccion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_calefaccion_kw").value) &amp;&amp;
                            parseFloat($scope.enfriadorarecuperacion[y]["COP nominal"]) >= parseFloat(document.getElementById("min COP nominal").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["COP nominal"]) &lt;= parseFloat(document.getElementById("max COP nominal").value) &amp;&amp;
                            parseFloat($scope.enfriadorarecuperacion[y]["EER nominal"]) >= parseFloat(document.getElementById("min EER nominal").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["EER nominal"]) &lt;= parseFloat(document.getElementById("max EER nominal").value)) {
                            contEquiposFiltrados++;
                        }
                    }

                }
            }

            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" || $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" || $scope.valoresServicio[0].idservicio == "32" || $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
            }
        }
        /**

            *Cargamos los valores de los campos correspondientes
            * @param  {number}
            * @return  {void}

            */
        updateInputsComplemento = function (cont, clase) {
            var fabri = ""
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    a = x;
                }
            }
            //Cargamos los valores elegidos en los select anteriores
            if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                fabri = document.getElementById("nombreComplemento2").value;
            } else {
                fabri = document.getElementById("fabricanteComplemento2").value;
            }
            var tipos = "";
            if (clase == "15") {
                tipos = document.getElementById("tiposRegulacionComplemento2").value;
                tipos = Number(tipos);
                tipos = tipos + 1;
            } else if (clase == "1") {

                tipos = document.getElementById("preciosComplemento2").value;
                tipos = Number(tipos);
                tipos = tipos + 1;
            } else {
                if ($scope.valoresTipo.length > 1) {
                    tipos = document.getElementById("tiposComplemento2").value;
                } else {
                    var tipos = $scope.valoresComplemento[0].id;
                }
            }
            for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                document.getElementsByClassName('inputsComplemento')[y].style.visibility = "visible";
            }
            //Obtenemos los valores en función del complemento
            for (var x = 0; x &lt; $scope.valoresComplemento.length; x++) {
                for (var contadorparametro = 0; contadorparametro &lt; copiaParametros.length; contadorparametro++)
                    document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresComplemento[x][copiaParametros[contadorparametro]];
            }
            if (clase == "15") {
                var e = document.getElementById("tiposRegulacionComplemento2");
                var strUser = e.options[e.selectedIndex].value;
                for (var x = 0; x &lt; equipos.length; x++) {
                    var a = x;
                }
                strUser = Number(strUser);
                strUser = strUser + 1;
                valoresServiciosComplementos[a][2] = $scope.valoresComplemento[strUser - 1].tipo_regulacion;
            } else {
                for (var x = 0; x &lt; equipos.length; x++) {
                    if (equipos[x][0] == cont) {
                        var a = x;
                    }
                } if ($scope.valoresTipo.length > 1) {
                    var e = document.getElementById("tiposComplemento2");
                    var strUser = e.options[e.selectedIndex].value;
                    //Almacenamos los valores
                    strUser = Number(strUser);

                    valoresServiciosComplementos[a][2] = $scope.valoresComplemento[strUser - 1].tipo;
                } else {
                    valoresServiciosComplementos[a][2] = $scope.valoresComplemento[0].tipo;
                }
            }
        }
        /**

            *Cargamos los valores de los campos correspondientes
            * @param  {number}
            * @return  {void}

            */
        updateInputsComplemento2 = function (cont) {
            //Sacamos los valores de los select anteriores
            var modelo = document.getElementById("modelosComplemento2").value;
            var fabri = document.getElementById("nombreComplemento2").value;
            if ($scope.valoresTipo.length > 1) {
                var tipos = document.getElementById("tiposComplemento2").value;
            } else {
                var tipos = $scope.valoresServicio[0].id;
            }
            var regulacion = document.getElementById("regulacionComplemento2").value;
            for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                document.getElementsByClassName('inputsComplemento')[y].style.visibility = "visible";
            }
            //Obtenemos los valores en función del complemento
            for (var x = 0; x &lt; $scope.valoresComplemento.length; x++) {
                if ($scope.valoresComplemento[x].modelo == $scope.valoresComplemento[modelo - 1].modelo &amp;&amp; $scope.valoresComplemento[x].tipo == $scope.valoresComplemento[tipos - 1].tipo &amp;&amp; $scope.valoresComplemento[x].fabricante == $scope.valoresComplemento[fabri - 1].fabricante &amp;&amp; $scope.valoresComplemento[x].regulaciÓn == $scope.valoresComplemento[regulacion - 1].regulaciÓn) {
                    for (var contadorparametro = 0; contadorparametro &lt; copiaParametros.length; contadorparametro++)
                        document.getElementById(copiaParametros[contadorparametro]).value = $scope.valoresComplemento[x][copiaParametros[contadorparametro]];
                }
            }
            var e = document.getElementById("regulacionComplemento2");
            var strUser = e.options[e.selectedIndex].value;
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            //Asigamos el valor escogido
            strUser = Number(strUser);
            valoresServiciosComplementos[a][3] = $scope.valoresComplemento[strUser - 1].regulaciÓn;
        }
        /**

            *Guardamos los valores de los atributos del equipo
            * @param  {string}
            * @return  {void}

            */
        guardarValores = function (cont, clase) {
           var nofiltres = Hparametrico.guardarequipo();
            var ceros = 0;
            var par;
            var contadoresrepetidos = false;
            var a = cont;
            var todoCorrecto=true;
            var contadoresCheck = "";
            var tipoEquipo = "";
            contadoresFrio = [];
            contadoresCalor = [];
            contadoresNormales = [];
            //Sacamos los nombres de los campos del equipo
            $http.post("selectoresServicios" + clase + ".php").success(function (data) {
                $scope.valoresServicios = data;
                $http.post("parametrosServicios" + clase + ".php").success(function (data) {
                    valores = data;
                    for (var x = 0; x &lt; equipos.length; x++) {
                        if (equipos[x][0] == cont) {
                            a = x;
                            tipoEquipo = equipos[x][6];
                            if (nofiltres == 1)
                            {
                                for (var x = 0; x &lt; equipos.length; x++) 
                                {
                                    if (equipos[x][0] == cont &amp;&amp; 
                                    (nombreEquipo[x].trim() != "Monocristalino" &amp;&amp; nombreEquipo[x].trim() != "Policristalino" &amp;&amp; nombreEquipo[x].trim() != "PERC"  )
                                    &amp;&amp; equipos[x][6] != "4" )
                                    {
                                        var fil = Hparametrico.eqnofil(nombreEquipo[x]);
                                        if (fil == 1)
                                        equiponofiltrado.push(nombreEquipo[x]);
                                    }
                                }
                            }
                        }
                    }
                    
                    for (var x = 0; x &lt; equipos.length; x++) {
                        if (equipos[x][0] == cont) {
                            a = x;
                            tipoEquipo = equipos[x][6];
                        }
                    }
                    equipos[a][8] = "";
                    if ((clase == "3" || clase == "16" || clase == "10" || clase == "12" || clase == "11") &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                        if (clase != "12") {
                            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length / 2; y++) {
                                //Sacamos los valores de los atributos
                                caracteristicas[a][y] = document.getElementById(copiaParametros[y] + " calor").value;
                                if (caracteristicas[a][y] == "") {
                                    ceros++;
                                }
                                par = x;
                            }
                        } else {
                            caracteristicas[a][0] = document.getElementById(copiaParametros[0] + " frio").value;
                            if (caracteristicas[a][0] == "") {
                                ceros++;
                            }
                            caracteristicas[a][1] = document.getElementById(copiaParametros[1] + " frio").value;
                            if (caracteristicas[a][1] == "") {
                                ceros++;
                            }
                            par = x;
                        }
                        //Creamos los campos de contadores y filtramos los asignados
                        if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica") {
                            for (var x = 0; x &lt; $scope.contador.length; x++) {
                                if ($scope.contador[x].idcaso == idCaso) {
                                    var Asignado = false;
                                    var idcon = "";
                                    numContadores = "";

                                    loop1:
                                    for (var i = 0; i &lt; equipos.length; i++) {
                                        if (equipos[i][8] != equipos[a][8]) {
                                            numContadores = "";
                                            idcon = equipos[i][8];
                                            for (var z = 0; z &lt; idcon.length; z++) {
                                                if (idcon[z] != ",") {
                                                    if (idcon[z] != "-") {
                                                        numContadores = numContadores + "" + idcon[z];
                                                    }
                                                } else {
                                                    if (numContadores == $scope.contador[x].id) {
                                                        Asignado = true;
                                                        break loop1;
                                                    }
                                                    numContadores = "";
                                                }
                                            }
                                        } else {
                                            numContadores = "";
                                            idcon = equipos[i][8];
                                            for (var z = 0; z &lt; idcon.length; z++) {
                                                if (idcon[z] != ",") {
                                                    if (idcon[z] != "-") {
                                                        numContadores = numContadores + "" + idcon[z];
                                                    }
                                                } else {
                                                    if (numContadores == $scope.contador[x].id) {
                                                        Asignado = false;
                                                        break loop1;
                                                    }
                                                    numContadores = "";
                                                }
                                            }

                                        }
                                    } if (Asignado == false) {
                                        if (clase != "12") {
                                            if (document.getElementById($scope.contador[x].id + " calor").checked == true) {
                                                contadoresCheck += $scope.contador[x].id + ",";
                                                contadoresCalor.push($scope.contador[x].id);
                                            }
                                        } else {
                                            if (document.getElementById($scope.contador[x].id + " frio").checked == true) {
                                                contadoresCheck += $scope.contador[x].id + ",";
                                                contadoresFrio.push($scope.contador[x].id);
                                            }
                                        }
                                    }
                                }
                            }
                            if (clase != "12") {
                            contadoresCheck = contadoresCheck + "-";
                        } else {
                            contadoresCheck = contadoresCheck;
                        }
                        for (var i = 0; i &lt; busesAux.length; i++) {
                                if (busesAux[i][1] == equipos[a][1]) {
                                    busesAux[i][1] = nombreEquipo[a];
                                }
                            }
                        } else {
                            equipos[a][8] = "";
                            equipos[a][9] = nombreEquipo[a];

                        }
                        if (clase != "12") {
                            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length / 2; y++) {
                                //Sacamos los valores de los atributos
                                caracteristicas[a][(y + copiaParametros.length)] = document.getElementById(copiaParametros[y] + " frio").value;
                                if (caracteristicas[a][(y + copiaParametros.length)] == "") {
                                    ceros++;
                                }
                                par = x;
                            }
                        } else {
                            caracteristicas[a][2] = document.getElementById(copiaParametros[0] + " recuperacion").value;
                            if (caracteristicas[a][2] == "") {
                                ceros++;
                            }
                           
                            caracteristicas[a][3] = document.getElementById("% demanda recuperacion").value;
                            if (caracteristicas[a][3] == "") {
                                ceros++;
                            }
                            par = x;

                        }
                        if (clase != "12") {
                            if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica") {
                                for (var x = 0; x &lt; $scope.contador.length; x++) {
                                    if ($scope.contador[x].idcaso == idCaso) {
                                        var Asignado = false;
                                        var idcon = "";
                                        numContadores = "";
                                        loop1:
                                        for (var i = 0; i &lt; equipos.length; i++) {
                                            if (equipos[i][8] != equipos[a][8]) {
                                                numContadores = "";
                                                idcon = equipos[i][8];
                                                for (var z = 0; z &lt; idcon.length; z++) {
                                                    if (idcon[z] != ",") {
                                                        if (idcon[z] != "-") {
                                                            numContadores = numContadores + "" + idcon[z];
                                                        }
                                                    } else {
                                                        if (numContadores == $scope.contador[x].id) {
                                                            Asignado = true;
                                                            break loop1;
                                                        }
                                                        numContadores = "";
                                                    }
                                                }
                                            } else {
                                                numContadores = "";
                                                idcon = equipos[i][8];
                                                for (var z = 0; z &lt; idcon.length; z++) {
                                                    if (idcon[z] != ",") {
                                                        if (idcon[z] != "-") {
                                                            numContadores = numContadores + "" + idcon[z];
                                                        }
                                                    } else {
                                                        if (numContadores == $scope.contador[x].id) {
                                                            Asignado = false;
                                                            break loop1;
                                                        }
                                                        numContadores = "";
                                                    }
                                                }

                                            }
                                        } if (Asignado == false) {
                                            if (document.getElementById($scope.contador[x].id + " frio").checked == true) {
                                                contadoresCheck += $scope.contador[x].id + ",";
                                                contadoresFrio.push($scope.contador[x].id);
                                            }
                                        }
                                    }
                                }
                                equipos[a][8] += contadoresCheck;
                                equipos[a][9] = nombreEquipo[a];

                                for (var i = 0; i &lt; busesAux.length; i++) {
                                    if (busesAux[i][1] == equipos[a][1]) {
                                        busesAux[i][1] = nombreEquipo[a];
                                    }
                                }
                            } else {
                                equipos[a][8] = "";
                                equipos[a][9] = nombreEquipo[a];

                            }
                            for (var x = 0; x &lt; contadoresFrio.length; x++) {
                                if (contadoresCalor.includes(contadoresFrio[x])) {
                                    contadoresrepetidos = true;
                                    if (document.getElementById(contadoresFrio[x]+" frio") != null || document.getElementById(contadoresFrio[x]+" frio") != undefined)
                                    document.getElementById(contadoresFrio[x]+" frio").checked = false;
                                   if (document.getElementById(contadoresFrio[x]+" calor") != null || document.getElementById(contadoresFrio[x]+" calor") != undefined)
                                    document.getElementById(contadoresFrio[x]+" calor").checked = false;
                                }
                            }
                        } else {
                            equipos[a][8] = contadoresCheck;
                            equipos[a][9] = nombreEquipo[a];
                        }
                    }
                    else {
                        for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                            //Sacamos los valores de los atributos
                            caracteristicas[a][y] = document.getElementById(copiaParametros[y]).value;
                            if (caracteristicas[a][y] == "") {
                                ceros++;
                            }
                            par = x;
                        }
                        //Creamos los campos de contadores y filtramos los asignados
                        if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Captador plano" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Tubos de vacio" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica") {
                            for (var x = 0; x &lt; $scope.contador.length; x++) {
                                if ($scope.contador[x].idcaso == idCaso) {
                                    var Asignado = false;
                                    var idcon = "";
                                    numContadores = "";
                                    loop1:
                                    for (var i = 0; i &lt; equipos.length; i++) {
                                        if (equipos[i][8] != equipos[a][8]) {
                                            numContadores = "";
                                            idcon = equipos[i][8];
                                            for (var z = 0; z &lt; idcon.length; z++) {
                                                if (idcon[z] != ",") {
                                                    if (idcon[z] != "-") {
                                                        numContadores = numContadores + "" + idcon[z];
                                                    }
                                                } else {
                                                    if (numContadores == $scope.contador[x].id) {
                                                        Asignado = true;
                                                        break loop1;
                                                    }
                                                    numContadores = "";
                                                }
                                            }
                                        } else {
                                            numContadores = "";
                                            idcon = equipos[i][8];
                                            for (var z = 0; z &lt; idcon.length; z++) {
                                                if (idcon[z] != ",") {
                                                    if (idcon[z] != "-") {
                                                        numContadores = numContadores + "" + idcon[z];
                                                    }
                                                } else {
                                                    if (numContadores == $scope.contador[x].id) {
                                                        Asignado = false;
                                                        break loop1;
                                                    }
                                                    numContadores = "";
                                                }
                                            }

                                        }
                                    } if (Asignado == false) {
                                        if (document.getElementById($scope.contador[x].id).checked == true) {
                                            contadoresCheck += $scope.contador[x].id + ",";
                                            contadoresNormales.push($scope.contador[x].id);
                                        }
                                    }
                                }
                            }
                            equipos[a][8] = contadoresCheck;
                            equipos[a][9] = nombreEquipo[a];

                            for (var i = 0; i &lt; busesAux.length; i++) {
                                if (busesAux[i][1] == equipos[a][1]) {
                                    busesAux[i][1] = nombreEquipo[a];
                                }
                            }
                        } else {
                            equipos[a][8] = "";
                            equipos[a][9] = nombreEquipo[a];

                        }
                    }

                    if ($scope.valoresServicio[0].idservicio != "19" &amp;&amp; $scope.valoresServicio[0].idservicio != "20" &amp;&amp; $scope.valoresServicio[0].idservicio != "23") {
                        if (document.getElementById("numEquipos").value == "" || /^[0-9]*$/.test(document.getElementById('numEquipos').value) == false) {
                            ceros++;
                        }
                    }
                    if (tipoEquipo == "1") {
                        //Guardamos los valores en función del equipo
                        for (var z = 0; z &lt; $scope.valoresServicio.length; z++) {
                            if (($scope.valoresServicios[z].fabricante == valoresServiciosComplementos[a][0] || "0" == valoresServiciosComplementos[a][0]) &amp;&amp; ($scope.valoresServicio[z].modelo == valoresServiciosComplementos[a][1] || "0" == valoresServiciosComplementos[a][1])) {
                                if (($scope.valoresServicio[z].idservicio == "27" || $scope.valoresServicio[z].idservicio == "28" || $scope.valoresServicio[z].idservicio == "29") &amp;&amp; $scope.valoresServicio[z]["Potencia útil (kW)"] == caracteristicas[a][2] &amp;&amp; $scope.valoresServicio[z]["Rendimiento 100 (%)"] == caracteristicas[a][5]) {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].plr_min;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].plr_opt;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].plr_max;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].curva_1_p0;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].curva_1_p1;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].curva_1_p2;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].curva_1_p3;
                                } else if (($scope.valoresServicio[z].idservicio == "1" || $scope.valoresServicio[z].idservicio == "2") &amp;&amp; $scope.valoresServicio[z].area_captador_m2 == caracteristicas[a][0]) {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].rendimiento_optico_a0;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].curva_rendimiento_optico_a0;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].curva_coeficiente_perdida_captador_a1_wm2c;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].curva_coeficiente_perdidas_fluido_trabajo_a2_wm2c;
                                } else if ($scope.valoresServicio[z].idservicio == "8" || $scope.valoresServicio[z].idservicio == "10") {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].temp_nominal_entrada_gen;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].temp_nominal_salida_gen;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].temp_min_entrada_generador;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].temp_max_entrada_generador;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].cp_fluido_generador_kjkgk;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].temp_entrada_nominal_evaporador;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].temp_nominal_salida_evaporador;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].temp_minima_salida_evaporador;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].temp_maxima_salida_evaporador;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].cp_fluido_evaporador_kjkgk;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].temp_entrada_nominal_condensador;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].temp_salida_nominal_condensador;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].temp_minima_entrada_condensador;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].temp_maxima_entrada_condensador;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].cp_fluido_condensador_kjkgk;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].curva_1_p0;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].curva_1_p1;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].curva_1_p2;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].curva_1_p3;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].curva_1_p4;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].curva_1_p5;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].curva_2_p0;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].curva_2_p1;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].curva_2_p2;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].curva_2_p3;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].curva_2_p4;
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z].curva_2_p5;
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z].curva_3_a;
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z].curva_3_b;
                                    valoresServiciosComplementos[a][32] = $scope.valoresServicio[z].curva_3_c;
                                    valoresServiciosComplementos[a][33] = $scope.valoresServicio[z].curva_3_d;
                                    valoresServiciosComplementos[a][34] = $scope.valoresServicio[z].curva_4_a;
                                    valoresServiciosComplementos[a][35] = $scope.valoresServicio[z].curva_4_b;
                                    valoresServiciosComplementos[a][36] = $scope.valoresServicio[z].curva_4_c;
                                    valoresServiciosComplementos[a][37] = $scope.valoresServicio[z].curva_4_d;
                                }
                                else if ($scope.valoresServicio[z].idservicio == "11" || $scope.valoresServicio[z].idservicio == "12" || $scope.valoresServicio[z].idservicio == "13") {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].temp_maxima_salida_calefaccion_dhw;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].temp_maxima_entrada_calefaccion_dhw;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].temp_maxima_salida_dhw;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].temp_maxima_entrada_dhw;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].temp_maxima_exterior_dry_bulb_c;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].temp_minima_exterior_dry_bulb_c;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].curva_1_p_0;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].curva_1_p_1;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].curva_1_p_2;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].curva_1_p_3;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].curva_1_p_4;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].curva_1_p_5;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].curva_2_p_0;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].curva_2_p_1;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].curva_2_p_2;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].curva_2_p_3;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].curva_2_p_4;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].curva_2_p_5;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].curva_3_p_0;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].curva_3_p_1;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].curva_3_p_2;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].curva_3_p_3;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].curva_4_p_0;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].curva_4_p_1;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].curva_4_p_2;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].curva_4_p_3;
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z].curva_5_p_0;
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z].curva_5_p_1;
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z].curva_5_p_2;
                                    valoresServiciosComplementos[a][32] = $scope.valoresServicio[z].curva_5_p_3;
                                    valoresServiciosComplementos[a][33] = $scope.valoresServicio[z].curva_6_p_0;
                                    valoresServiciosComplementos[a][34] = $scope.valoresServicio[z].curva_6_p_1;
                                    valoresServiciosComplementos[a][35] = $scope.valoresServicio[z].curva_6_p_2;
                                    valoresServiciosComplementos[a][36] = $scope.valoresServicio[z].curva_6_p_3;
                                    valoresServiciosComplementos[a][37] = $scope.valoresServicio[z].curva_7_p_0;
                                    valoresServiciosComplementos[a][38] = $scope.valoresServicio[z].curva_7_p_1;
                                    valoresServiciosComplementos[a][39] = $scope.valoresServicio[z].curva_7_p_2;
                                    valoresServiciosComplementos[a][40] = $scope.valoresServicio[z].curva_7_p_3;
                                } else if ($scope.valoresServicio[z].idservicio == "14") {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].tecnologia;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].modelo_motor;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].combustible;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].refrigeracion;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].temperatura_maxima_impulsion_c;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].temperatura_maxima_retorno_c;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].prl_min;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].prl_max;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].curva_1_p0;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].curva_1_p1;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].curva_1_p2;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].curva_1_p3;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].curva_2_p0;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].curva_2_p1;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].curva_2_p2;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].curva_2_p3;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].curva_3_p0;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].curva_3_p1;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].curva_3_p2;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].curva_3_p3;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].curva_4_p0;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].curva_4_p1;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].curva_4_p2;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].curva_4_p3;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].curva_5_p0;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].curva_5_p1;
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z].curva_5_p2;
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z].curva_5_p3;
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z].curva_6_p0;
                                    valoresServiciosComplementos[a][32] = $scope.valoresServicio[z].curva_6_p1;
                                    valoresServiciosComplementos[a][33] = $scope.valoresServicio[z].curva_6_p2;
                                    valoresServiciosComplementos[a][34] = $scope.valoresServicio[z].curva_6_p3;
                                } else if ($scope.valoresServicio[z].idservicio == "19" || $scope.valoresServicio[z].idservicio == "20" || $scope.valoresServicio[z].idservicio == "23") {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z]["Precio (€)"];
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z]["Número de placas"];
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z]["Fuente"];
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z]["Tensión máxima potencia (VMP)"];
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z]["Corriente máxima potencia (IMP)"];
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z]["Tension_Circuito_Abierto_Vop"];
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z]["CorrienteDeCortocircuito_Iscc"];
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z]["FF"];
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z]["potencia_w_m2"];
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z]["Maxima_Tension_Sistema_V"];
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z]["Temperatura_Funcinamineto_Normal_Celula_Tonc_C"];
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z]["Coef_TempIsc_c"];
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z]["Coef_TempVoc_C"];
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z]["Coef_Temp_Pmax_C"];
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z]["Temperatura_Minima_Funcionamiento_C"];
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z]["Temperatura_Maxima_Funcinamineto_C"];
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z]["Ncoef"];
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z]["Nvar"];
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z]["a1"];
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z]["b1"];
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z]["c1"];
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z]["d1"];
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z]["a2"];
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z]["b2"];
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z]["c2"];
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z]["d2"];
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z]["Peso_kg"];
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z]["Alto"];
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z]["Ancho"];
                                } else if ($scope.valoresServicio[z].idservicio == "25" || $scope.valoresServicio[z].idservicio == "26") {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].veloc_min_puesta_marcha_ms;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].velocidad_max_viento;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].velocidad_frenado_automatico;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].rpm_min;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].rpm_max;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].prl_min;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].prl_opt;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].prl_max;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].velocidad_ms_1_0;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].velocidad_ms_1_1;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].velocidad_ms_1_2;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].velocidad_ms_1_3;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].velocidad_ms_1_4;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].velocidad_ms_1_5;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].velocidad_ms_1_6;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].velocidad_ms_1_7;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].velocidad_ms_1_8;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].velocidad_ms_1_9;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].velocidad_ms_1_10;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].velocidad_ms_1_11;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].velocidad_ms_1_12;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].velocidad_ms_1_13;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].velocidad_ms_1_14;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].velocidad_ms_1_15;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].velocidad_ms_1_16;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].velocidad_ms_1_17;
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z].velocidad_ms_1_18;
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z].velocidad_ms_1_19;
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z].velocidad_ms_1_20;
                                    valoresServiciosComplementos[a][32] = $scope.valoresServicio[z].velocidad_ms_1_21;
                                    valoresServiciosComplementos[a][33] = $scope.valoresServicio[z].velocidad_ms_1_22;
                                    valoresServiciosComplementos[a][34] = $scope.valoresServicio[z].velocidad_ms_1_23;
                                    valoresServiciosComplementos[a][35] = $scope.valoresServicio[z].velocidad_ms_1_24;
                                    valoresServiciosComplementos[a][36] = $scope.valoresServicio[z].velocidad_ms_1_25;
                                    valoresServiciosComplementos[a][37] = $scope.valoresServicio[z].velocidad_ms_1_26;
                                    valoresServiciosComplementos[a][38] = $scope.valoresServicio[z].velocidad_ms_1_27;
                                    valoresServiciosComplementos[a][39] = $scope.valoresServicio[z].velocidad_ms_1_28;
                                    valoresServiciosComplementos[a][40] = $scope.valoresServicio[z].velocidad_ms_1_29;
                                    valoresServiciosComplementos[a][41] = $scope.valoresServicio[z].velocidad_ms_1_30;
                                    valoresServiciosComplementos[a][42] = $scope.valoresServicio[z].velocidad_ms_1_31;
                                    valoresServiciosComplementos[a][43] = $scope.valoresServicio[z].velocidad_ms_1_32;
                                    valoresServiciosComplementos[a][44] = $scope.valoresServicio[z].velocidad_ms_1_33;
                                    valoresServiciosComplementos[a][45] = $scope.valoresServicio[z].velocidad_ms_1_34;
                                    valoresServiciosComplementos[a][46] = $scope.valoresServicio[z].velocidad_ms_1_35;
                                } else if (($scope.valoresServicio[z].idservicio == "5" || $scope.valoresServicio[z].idservicio == "6" || $scope.valoresServicio[z].idservicio == "7") &amp;&amp; ($scope.valoresServicio[z].tipo == valoresServiciosComplementos[a][2] || "0" == valoresServiciosComplementos[a][2])) {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].efectos;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].uso;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].modo;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].susceptible_uso_solar;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].temp_max_entrada_gen;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].temp_min_entrada_gen;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].temperatura_entrada_generador_nominal_c;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].temperatura_salida_generador_nominal_c;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].curva_1_p0;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].curva_1_p1;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].curva_1_p2;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].curva_1_p3;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].curva_1_p4;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].curva_1_p5;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].curva_2_p0;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].curva_2_p1;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].curva_2_p2;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].curva_2_p3;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].curva_2_p4;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].curva_2_p5;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].curva_5_p0;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].curva_5_p1;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].curva_5_p2;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].curva_5_p3;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].curva_5_p4;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].curva_5_p5;
                                } else if ($scope.valoresServicio[z].idservicio == "30" || $scope.valoresServicio[z].idservicio == "31") {
                                    valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].hidro_kit;
                                    valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].temp_limite_prod_agua_caliente;
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].temp_limite_prod_agua_fria;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].temp_limite_rec_acs;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].factor_carga_parcial_min;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].factor_carga_parcial_max;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].curva_1_p0;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].curva_1_p1;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].curva_1_p2;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].curva_1_p3;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].curva_1_p4;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].curva_1_p5;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].curva_2_p0;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].curva_2_p1;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].curva_2_p2;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].curva_2_p3;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].curva_2_p4;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].curva_2_p5;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].curva_3_p0;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].curva_3_p1;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].curva_3_p2;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].curva_3_p3;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].curva_4_p0;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].curva_4_p1;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].curva_4_p2;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].curva_4_p3;
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z].curva_5_p0;
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z].curva_5_p1;
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z].curva_5_p2;
                                    valoresServiciosComplementos[a][32] = $scope.valoresServicio[z].curva_5_p3;
                                    valoresServiciosComplementos[a][33] = $scope.valoresServicio[z].curva_5_p4;
                                    valoresServiciosComplementos[a][34] = $scope.valoresServicio[z].curva_5_p5;
                                    valoresServiciosComplementos[a][35] = $scope.valoresServicio[z].curva_6_p0;
                                    valoresServiciosComplementos[a][36] = $scope.valoresServicio[z].curva_6_p1;
                                    valoresServiciosComplementos[a][37] = $scope.valoresServicio[z].curva_6_p2;
                                    valoresServiciosComplementos[a][38] = $scope.valoresServicio[z].curva_6_p3;
                                    valoresServiciosComplementos[a][39] = $scope.valoresServicio[z].curva_7_p0;
                                    valoresServiciosComplementos[a][40] = $scope.valoresServicio[z].curva_7_p1;
                                    valoresServiciosComplementos[a][41] = $scope.valoresServicio[z].curva_7_p2;
                                    valoresServiciosComplementos[a][42] = $scope.valoresServicio[z].curva_7_p3;
                                    valoresServiciosComplementos[a][43] = $scope.valoresServicio[z].curva_7_p4;
                                    valoresServiciosComplementos[a][44] = $scope.valoresServicio[z].curva_7_p5;
                                }
                                else if (($scope.valoresServicio[z].idservicio == "32" || $scope.valoresServicio[z].idservicio == "33" || $scope.valoresServicio[z].idservicio == "34") &amp;&amp; ($scope.valoresServicio[z].tipo == valoresServiciosComplementos[a][2] || "0" == valoresServiciosComplementos[a][2]) &amp;&amp; $scope.valoresServicio[z]["COP nominal"] == caracteristicas[a][0]
                                    &amp;&amp; $scope.valoresServicio[z]["EER nominal"] == caracteristicas[a][3] &amp;&amp; $scope.valoresServicio[z].capacidad_nominal_calefaccion_kw == caracteristicas[a][6] &amp;&amp; $scope.valoresServicio[z].capacidad_nominal_refrigeracion_kw == caracteristicas[a][9]) {
                                    // valoresServiciosComplementos[a][3] = $scope.valoresServicio[z].capacidad_nominal_calefaccion_kw; MMR: INDEX2 NO TIENE ESTO 25-02-2019:9.50h
                                    // valoresServiciosComplementos[a][4] = $scope.valoresServicio[z].capacidad_nominal_refrigeracion_kw; MMR: INDEX2 NO TIENE ESTO 25-02-2019:9.50h
                                    //Mickael: Que tu sepas que esto lo había quitado yo ya
                                    valoresServiciosComplementos[a][5] = $scope.valoresServicio[z].temperatura_impulsion_agua_max_refrigeracion;
                                    valoresServiciosComplementos[a][6] = $scope.valoresServicio[z].temperatura_impulsion_min_refrigeracion;
                                    valoresServiciosComplementos[a][7] = $scope.valoresServicio[z].temperatura_impulsion_agua_max_calefaccion;
                                    valoresServiciosComplementos[a][8] = $scope.valoresServicio[z].temperatura_impulsion_min_calefaccion;
                                    valoresServiciosComplementos[a][9] = $scope.valoresServicio[z].prl_min;
                                    valoresServiciosComplementos[a][10] = $scope.valoresServicio[z].prl_max;
                                    valoresServiciosComplementos[a][11] = $scope.valoresServicio[z].curva_1_p0;
                                    valoresServiciosComplementos[a][12] = $scope.valoresServicio[z].curva_1_p1;
                                    valoresServiciosComplementos[a][13] = $scope.valoresServicio[z].curva_1_p2;
                                    valoresServiciosComplementos[a][14] = $scope.valoresServicio[z].curva_1_p3;
                                    valoresServiciosComplementos[a][15] = $scope.valoresServicio[z].curva_1_p4;
                                    valoresServiciosComplementos[a][16] = $scope.valoresServicio[z].curva_1_p5;
                                    valoresServiciosComplementos[a][17] = $scope.valoresServicio[z].curva_2_p0;
                                    valoresServiciosComplementos[a][18] = $scope.valoresServicio[z].curva_2_p1;
                                    valoresServiciosComplementos[a][19] = $scope.valoresServicio[z].curva_2_p2;
                                    valoresServiciosComplementos[a][20] = $scope.valoresServicio[z].curva_2_p3;
                                    valoresServiciosComplementos[a][21] = $scope.valoresServicio[z].curva_2_p4;
                                    valoresServiciosComplementos[a][22] = $scope.valoresServicio[z].curva_2_p5;
                                    valoresServiciosComplementos[a][23] = $scope.valoresServicio[z].curva_3_p0;
                                    valoresServiciosComplementos[a][24] = $scope.valoresServicio[z].curva_3_p1;
                                    valoresServiciosComplementos[a][25] = $scope.valoresServicio[z].curva_3_p2;
                                    valoresServiciosComplementos[a][26] = $scope.valoresServicio[z].curva_3_p3;
                                    valoresServiciosComplementos[a][27] = $scope.valoresServicio[z].curva_3_p4;
                                    valoresServiciosComplementos[a][28] = $scope.valoresServicio[z].curva_3_p5;
                                    valoresServiciosComplementos[a][29] = $scope.valoresServicio[z].curva_4_p0;
                                    valoresServiciosComplementos[a][30] = $scope.valoresServicio[z].curva_4_p1;
                                    valoresServiciosComplementos[a][31] = $scope.valoresServicio[z].curva_4_p2;
                                    valoresServiciosComplementos[a][32] = $scope.valoresServicio[z].curva_4_p3;
                                    valoresServiciosComplementos[a][33] = $scope.valoresServicio[z].curva_4_p4;
                                    valoresServiciosComplementos[a][34] = $scope.valoresServicio[z].curva_4_p5;
                                    valoresServiciosComplementos[a][35] = $scope.valoresServicio[z].curva_5_p_0;
                                    valoresServiciosComplementos[a][36] = $scope.valoresServicio[z].curva_5_p_1;
                                    valoresServiciosComplementos[a][37] = $scope.valoresServicio[z].curva_5_p_2;
                                    valoresServiciosComplementos[a][38] = $scope.valoresServicio[z].curva_5_p_3;
                                    valoresServiciosComplementos[a][39] = $scope.valoresServicio[z].curva_5_p_4;
                                    valoresServiciosComplementos[a][40] = $scope.valoresServicio[z].curva_5_p_5;
                                    valoresServiciosComplementos[a][41] = $scope.valoresServicio[z].curva_6_p_0;
                                    valoresServiciosComplementos[a][42] = $scope.valoresServicio[z].curva_6_p_1;
                                    valoresServiciosComplementos[a][43] = $scope.valoresServicio[z].curva_6_p_2;
                                    valoresServiciosComplementos[a][44] = $scope.valoresServicio[z].curva_6_p_3;
                                    valoresServiciosComplementos[a][45] = $scope.valoresServicio[z].curva_6_p_4;
                                    valoresServiciosComplementos[a][46] = $scope.valoresServicio[z].curva_6_p_5;
                                    valoresServiciosComplementos[a][47] = $scope.valoresServicio[z].curva_7_p0;
                                    valoresServiciosComplementos[a][48] = $scope.valoresServicio[z].curva_7_p1;
                                    valoresServiciosComplementos[a][49] = $scope.valoresServicio[z].curva_7_p2;
                                    valoresServiciosComplementos[a][50] = $scope.valoresServicio[z].curva_7_p3;
                                    valoresServiciosComplementos[a][51] = $scope.valoresServicio[z].curva_7_p4;
                                    valoresServiciosComplementos[a][52] = $scope.valoresServicio[z].curva_7_p5;
                                }
                            }
                        }
                    }
                    for (var contadorparametro = 0; contadorparametro &lt; copiaParametros.length; contadorparametro++) {
                        if (clase == "27" || clase == "28" || clase == "29"){
                            if (contadorparametro>1){
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro]).value) == false) {
                            alert('ERROR: El campo ' + contadorparametro +' con valores no numéricos');
                            todoCorrecto = false;
                        }
                        }
                        } else {
                            if ((clase == "3" || clase == "10" || clase == "12" || clase == "11") &amp;&amp; tipoEquipo == "4" &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                                if (clase != "12"){
                                if (contadorparametro ==0) {
                            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro]+" calor").value) == false) {
                                alert('ERROR: El campo Potencia (kW) calor con valores no numéricos');
                                todoCorrecto = false;
                                break;
                            }
							if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro]+" frio").value) == false) {
                                alert('ERROR: El campo Potencia (kW) frio con valores no numéricos');
                                todoCorrecto = false;
                                break;
                            }
                            } else {
                                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro] + " calor").value) == false) {
                                        alert('ERROR: El campo Rendimiento estacional (%) calor  con valores no numéricos');
                                        todoCorrecto = false;
                                        break;
                                    }
									
									if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro] + " frio").value) == false) {
                                        alert('ERROR: El campo Rendimiento estacional (%) frio  con valores no numéricos');
                                        todoCorrecto = false;
                                        break;
                                    }
                            }
                            } else {
                                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById("Potencia (kW) frio").value) == false) {
                                        alert('ERROR: El campo Potencia (kW) frio con valores no numéricos');
                                        todoCorrecto = false;
                                        break;
                                    }
                                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById("Rendimiento estacional (%) frio").value) == false) {
                                        alert('ERROR: El campo Rendimiento estacional (%) frio con valores no numéricos');
                                        todoCorrecto = false;
                                        break;
                                    }
                                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById("Potencia (kW) recuperacion").value) == false) {
                                        alert('ERROR: El campo Potencia (kW) recuperacion con valores no numéricos');
                                        todoCorrecto = false;
                                        break;
                                    }
                                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById("% demanda recuperacion").value) == false) {
                                        alert('ERROR: El campo % demanda recuperacion con valores no numéricos');
                                        todoCorrecto = false;
                                        break;
                                    }
                                }
                            } else {
                                if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro]).value) == false) {
                                    alert('ERROR: El campo ' + contadorparametro + ' con valores no numéricos');
                                    todoCorrecto = false;
                                }
                            }
                        }
                        }
                    if (ceros > 0) {
                        alert("ERROR: Algunos de los parámetros está vacío o tienen valores incorrectos.");
                        todoCorrecto = false;
                    }
                    if (todoCorrecto == false) 
                        equiposfiltrados.splice(equiposfiltrados.length-1,1);
                    else {
                    if (contadoresrepetidos == true) {
                        alert("ERROR: Un contador solo puede estar asignado a calor o a frío");
                    } else {
                        if ($scope.valoresServicio[0].idservicio != "19" &amp;&amp; $scope.valoresServicio[0].idservicio != "20" &amp;&amp; $scope.valoresServicio[0].idservicio != "23") {
                        if (tipoEquipo == "1" &amp;&amp; parseInt(document.getElementById("numEquiposFiltrados").innerHTML) &lt; 1) {
                            alert("ERROR: El número de equipos filtrados debe ser mayor que 0");
                        } else {
                        
                            if (/^[0-9]*$/.test(document.getElementById("numEquipos").value) == true) {
                                //Guardamos las características para el equipo en concreto
                                Hparametrico.EquiposZero(cont,a,valoresServiciosComplementos,$scope.equipo);
                                equipos[a][10] = document.getElementById("numEquipos").value;
                                equipos[a][5] = "si";
                                document.getElementById(equipos[a][0]).style.border = "solid 1px black";
                                $('#myModalCaracteristicas').modal('hide');
                                document.getElementById('caracteristicas').innerHTML = "";
                            } else {
                                alert("ERROR: El número de equipos debe ser un número entero");
                                equiposfiltrados.splice(equiposfiltrados.length-1,1);
                            }
                        }} else {
                            Hparametrico.EquiposZero(cont,a,valoresServiciosComplementos,$scope.equipo);
                            equipos[a][10] = "1";
                            equipos[a][5] = "si";
                            document.getElementById(equipos[a][0]).style.border = "solid 1px black";
                            $('#myModalCaracteristicas').modal('hide');
                            document.getElementById('caracteristicas').innerHTML = "";
                        }
                    }
                }
                
                ceros = 0;
            });
        });
    }
        /**

            *Guardamos los valores de los atributos del equipo
            * @param  {number}
            * @return  {void}

            */
        guardarValoresComplemento = function (cont, clase) {
            var todoCorrecto=true;
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    var a = x;
                }
            }
            if (clase == 1) {
                var chk = guardarbateriainversor();
                if (chk == false)
                    return;
                equipos[a][5] = "si";
                document.getElementById(cont).style.border = "solid 1px black";
                $('#myModalCaracteristicas').modal('hide');
                document.getElementById('caracteristicas').innerHTML = "";
            }

            var ceros = 0;
            var par;
            //Sacamos los valors de selectores
            $http.post("selectoresComplemento" + clase + ".php").success(function (data) {
                $scope.valoresComplementos = data;
              
                //Sacamos los valores de la base de datos en función del complemento
                if ($scope.valoresComplemento != undefined)
                for (var z = 0; z &lt; $scope.valoresComplemento.length; z++) {
                    if ($scope.valoresComplementos[z].fabricante == valoresServiciosComplementos[a][0] &amp;&amp; $scope.valoresComplementos[z].modelo == valoresServiciosComplementos[a][1] &amp;&amp; $scope.valoresComplementos[z].tipo == valoresServiciosComplementos[a][2]) {
                        if ($scope.valoresComplemento[z].idcomplemento == "1") {
                            valoresServiciosComplementos[a][0] = $scope.guardadobateriainversor.select[0];
                            valoresServiciosComplementos[a][1] = $scope.guardadobateriainversor.select[1];
                            valoresServiciosComplementos[a][2] = $scope.guardadobateriainversor.select[2];
                            valoresServiciosComplementos[a][3] = $scope.bateriainversorseleccionado[5];
                            valoresServiciosComplementos[a][4] = $scope.bateriainversorseleccionado[6];
                            valoresServiciosComplementos[a][5] = $scope.bateriainversorseleccionado[7];
                            valoresServiciosComplementos[a][6] = $scope.bateriainversorseleccionado[8];
                            valoresServiciosComplementos[a][7] = $scope.bateriainversorseleccionado[10];
                            valoresServiciosComplementos[a][8] = $scope.bateriainversorseleccionado[11];
                            valoresServiciosComplementos[a][9] = $scope.bateriainversorseleccionado[12];
                            valoresServiciosComplementos[a][10] = $scope.bateriainversorseleccionado[13];
                            valoresServiciosComplementos[a][11] = $scope.bateriainversorseleccionado[14];
                            valoresServiciosComplementos[a][12] = $scope.bateriainversorseleccionado[15];
                            valoresServiciosComplementos[a][13] = $scope.bateriainversorseleccionado[17];
                            valoresServiciosComplementos[a][14] = $scope.bateriainversorseleccionado[18];
                            valoresServiciosComplementos[a][15] = $scope.bateriainversorseleccionado[19];
                            valoresServiciosComplementos[a][16] = $scope.bateriainversorseleccionado[20];
                            valoresServiciosComplementos[a][17] = $scope.bateriainversorseleccionado[21];
                            valoresServiciosComplementos[a][18] = $scope.bateriainversorseleccionado[22];
                            valoresServiciosComplementos[a][19] = $scope.bateriainversorseleccionado[24];
                            valoresServiciosComplementos[a][20] = $scope.bateriainversorseleccionado[25];
                            valoresServiciosComplementos[a][21] = $scope.bateriainversorseleccionado[27];
                            valoresServiciosComplementos[a][22] = $scope.bateriainversorseleccionado[28];
                            valoresServiciosComplementos[a][23] = $scope.bateriainversorseleccionado[29];
                            valoresServiciosComplementos[a][24] = $scope.bateriainversorseleccionado[30];
                            valoresServiciosComplementos[a][25] = $scope.bateriainversorseleccionado[31];
                            valoresServiciosComplementos[a][26] = $scope.bateriainversorseleccionado[32];
                            valoresServiciosComplementos[a][27] = $scope.bateriainversorseleccionado[33];
                            valoresServiciosComplementos[a][28] = $scope.bateriainversorseleccionado[34];
                            valoresServiciosComplementos[a][29] = $scope.bateriainversorseleccionado[35];
                            valoresServiciosComplementos[a][30] = $scope.bateriainversorseleccionado[36];
                            valoresServiciosComplementos[a][31] = $scope.bateriainversorseleccionado[39];
                            valoresServiciosComplementos[a][32] = $scope.bateriainversorseleccionado[40];
                            valoresServiciosComplementos[a][33] = $scope.bateriainversorseleccionado[41];
                            valoresServiciosComplementos[a][34] = $scope.bateriainversorseleccionado[42];
                            valoresServiciosComplementos[a][35] = $scope.bateriainversorseleccionado[43];
                        } else if ($scope.valoresComplemento[z].idcomplemento == "14") {
                            valoresServiciosComplementos[a][3] = $scope.valoresComplementos[z].regulacion
                            valoresServiciosComplementos[a][4] = $scope.valoresComplemento[z].potencia_ventilador_kw;
                            valoresServiciosComplementos[a][5] = $scope.valoresComplemento[z].caudal_entrada_nominal_aire_m3s;
                            valoresServiciosComplementos[a][6] = $scope.valoresComplemento[z].resist_electrica_1_kw;
                            valoresServiciosComplementos[a][7] = $scope.valoresComplemento[z].resist_electrica_2_kw;
                            valoresServiciosComplementos[a][8] = $scope.valoresComplemento[z].caudal_agua_ls;
                            valoresServiciosComplementos[a][9] = $scope.valoresComplemento[z].caudal_agua_recirculada_ls;
                            valoresServiciosComplementos[a][10] = $scope.valoresComplemento[z].potencia_bomba_kw;
                            valoresServiciosComplementos[a][11] = $scope.valoresComplemento[z].temp_consigna_salida;
                            valoresServiciosComplementos[a][12] = $scope.valoresComplemento[z].temp_entrada_nominal;
                            valoresServiciosComplementos[a][13] = $scope.valoresComplementos[z].salto_temp_nominal
                            valoresServiciosComplementos[a][14] = $scope.valoresComplemento[z].temp_encendido_calefactor;
                            valoresServiciosComplementos[a][15] = $scope.valoresComplemento[z].temp_encendido_2_calefactor;
                            valoresServiciosComplementos[a][16] = $scope.valoresComplemento[z].curva_1_p0;
                            valoresServiciosComplementos[a][17] = $scope.valoresComplemento[z].curva_1_p1;
                            valoresServiciosComplementos[a][18] = $scope.valoresComplemento[z].curva_1_p2;
                            valoresServiciosComplementos[a][19] = $scope.valoresComplemento[z].curva_1_p3;
                            valoresServiciosComplementos[a][20] = $scope.valoresComplemento[z].curva_1_p4;
                            valoresServiciosComplementos[a][21] = $scope.valoresComplemento[z].curva_1_p5;
                            valoresServiciosComplementos[a][22] = $scope.valoresComplemento[z].curva_2_p0;
                            valoresServiciosComplementos[a][23] = $scope.valoresComplemento[z].curva_2_p1;
                            valoresServiciosComplementos[a][24] = $scope.valoresComplemento[z].curva_2_p2;
                            valoresServiciosComplementos[a][25] = $scope.valoresComplemento[z].curva_2_p3;
                            valoresServiciosComplementos[a][26] = $scope.valoresComplemento[z].curva_2_p4;
                            valoresServiciosComplementos[a][27] = $scope.valoresComplemento[z].curva_2_p5;
                            valoresServiciosComplementos[a][28] = $scope.valoresComplemento[z].curva_3_p0;
                            valoresServiciosComplementos[a][29] = $scope.valoresComplemento[z].curva_3_p1;
                            valoresServiciosComplementos[a][30] = $scope.valoresComplemento[z].curva_3_p2;
                            valoresServiciosComplementos[a][31] = $scope.valoresComplemento[z].curva_4_p0;
                            valoresServiciosComplementos[a][32] = $scope.valoresComplemento[z].curva_4_p1;
                            valoresServiciosComplementos[a][33] = $scope.valoresComplemento[z].curva_4_p2;
                            valoresServiciosComplementos[a][34] = $scope.valoresComplemento[z].curva_4_p3;
                        } else if ($scope.valoresComplemento[z].idcomplemento == "8" || $scope.valoresComplemento[z].idcomplemento == "9" || $scope.valoresComplemento[z].idcomplemento == "10" || $scope.valoresComplemento[z].idcomplemento == "11" || $scope.valoresComplemento[z].idcomplemento == "12") {
                        } else if ($scope.valoresComplemento[z].idcomplemento == "15") {
                            valoresServiciosComplementos[a][3] = $scope.valoresComplemento[z].capacidad_kw;
                            valoresServiciosComplementos[a][4] = $scope.valoresComplemento[z].caudal_entrada_nominal_liquido_m3h;
                            valoresServiciosComplementos[a][5] = $scope.valoresComplemento[z].caudal_entrada_nominal_aire_m3h;
                            valoresServiciosComplementos[a][6] = $scope.valoresComplemento[z].temperatura_consignanominal_salida_fluido;
                        }
                        else if ($scope.valoresComplemento[z].idcomplemento == "16" || $scope.valoresComplemento[z].idcomplemento == "17" || $scope.valoresComplemento[z].idcomplemento == "18" || $scope.valoresComplemento[z].idcomplemento == "19") {
                        }
                    }
                }
                if (clase == 1) {
                    for (var y = 0; y &lt; $scope.guardadobateriainversor.input.length; y++) {
                        //Sacamos los valores de los atributos
                        caracteristicas[a][y] = $scope.guardadobateriainversor.input[y];
                        if (caracteristicas[a][y] == "") {
                            ceros++;
                        }

                        par = x;
                    }
                } else {
                    for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                        //Sacamos los valores de los atributos
                        caracteristicas[a][y] = document.getElementById(copiaParametros[y]).value;
                        if (caracteristicas[a][y] == "") {
                            ceros++;
                        }
                        par = x;
                    }
                }
                if (clase != 1)
                {
                    for (var contadorparametro = 0; contadorparametro &lt; copiaParametros.length; contadorparametro++) 
                    {
                        if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById(copiaParametros[contadorparametro]).value) == false) 
                        {
                            alert('ERROR: El campo ' + contadorparametro + ' con valores no numéricos');
                            todoCorrecto = false;
                        }
                    }
                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][1] == "0") 
                    {
                        alert("ERROR: Debe seleccionar un fabricante y un modelo");
                        todoCorrecto=false;
                    }
                    if (ceros > 0) 
                    {
                        alert("ERROR: Algunos de los parámetros está vacío.");
                        todoCorrecto = false;
                    }
                }
                equipos[a][9] = nombreEquipo[a];
                if (todoCorrecto == false){
                } else {
                    //Guardamos las características para el equipo en concreto
                    equipos[a][5] = "si";
                    document.getElementById(cont).style.border = "solid 1px black";
                    $('#myModalCaracteristicas').modal('hide');
                    document.getElementById('caracteristicas').innerHTML = "";
                }
                ceros = 0;
            });
            //    });
        }
        /**

            *Creamos el modal con las caraacteristicas del equipo existente
            * @param  {string}
            * @return  {void}

            */
        updateCaracteristicasEx = function (tipo, tipo2, gen, ali, cont, clase) {
            document.getElementById('caracteristicas').innerHTML = "";
            var parametro = "";
            var parametrosServicio = new Array();
            var parametros = "";
            var valores;
            var contCalor = "";
            var contFrio = "";
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    a = x;
                }
            }
            contadoresCalor=[];
            contadoresFrio = [];
            //Comprobamos si el equipo ha sido definido con anterioridad
            if (equipos[a][5] == "si") {
                $('#myModalCaracteristicas').modal('show');
                equipos[a][5] = "si";
                //Sacamos los nombres e los campos del equipo de la base de datos y filtramos los repetidos
                $http.post("parametrosServicios" + clase + "Ex.php").success(function (data) {
                    valores = data;
                    parametrosServicio.push(parametro);
                    valoresSinRepetir = new Array();
                    valoresSinRepetir2 = new Array();
                    valoresSinRepetir3 = new Array();
                    parametro = [];
                    $http.post("selectoresServicios" + clase + "Ex.php").success(function (data) {
                        $scope.valoresServicio = data;
                        $scope.valoresFabricante = $scope.valoresServicio;
                        $scope.valoresModelo = $scope.valoresServicio;
                        $scope.valoresTipo = $scope.valoresServicio;
                        $scope.valoresFabricante = $scope.valoresFabricante.filter(function (currentObject) {
                            if (currentObject.fabricante in valoresSinRepetir) {
                                return false;
                            } else {
                                valoresSinRepetir[currentObject.fabricante] = true;
                                return true;
                            }
                        });
                        $scope.valoresModelo = $scope.valoresModelo.filter(function (currentObject) {
                            if (currentObject.modelo in valoresSinRepetir2) {
                                return false;
                            } else {
                                valoresSinRepetir2[currentObject.modelo] = true;
                                return true;
                            }
                        });
                        $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                            if (currentObject.tipo in valoresSinRepetir3) {
                                return false;
                            } else {
                                valoresSinRepetir3[currentObject.tipo] = true;
                                return true;
                            }
                        });
                        parametros += "&lt;label style='margin-bottom:5%'>";
                        parametros += $scope.serviciosEx[clase - 1].nombretabladatos + "     " + equipos[a][9];
                        parametros += "&lt;/label>"
                        if ((clase == "3" || clase == "10" || clase == "11" || clase == "12" ) &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                            if (clase != "12") {
                            for (var x = 0; x &lt; valores.length; x++) {
                                parametros += "&lt;div class='inputs'>" + valores[x] + " calor:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + " calor' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                }
                            } else {
                                parametros += "&lt;div class='inputs'>" + valores[0] + " frio:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[0] + " frio' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                parametros += "&lt;div class='inputs'>" + valores[1] + " frio:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[1] + " frio' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                            }
                            numContadores = "";

                            for (var x = 0; x &lt; equipos[a][8].length; x++) {
                                if (equipos[a][8][x] == "-") {
                                    contCalor = equipos[a][8].substring(0, x);
                                    contFrio = equipos[a][8].substring((x + 1), equipos[a][8].length);
                                    break;
                                }
                            }
                            for (var z = 0; z &lt; contCalor.length; z++) {
                                if (contCalor[z] != ",") {
                                    numContadores = numContadores + "" + contCalor[z];
                                } else {
                                    contadoresCalor.push(numContadores);
                                    numContadores = "";
                                }
                            }
                            for (var z = 0; z &lt; contFrio.length; z++) {
                                if (contFrio[z] != ",") {
                                    numContadores = numContadores + "" + contFrio[z];
                                } else {
                                    contadoresFrio.push(numContadores);
                                    numContadores = "";
                                }
                            }
                            if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Captador plano" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Tubos de vacio") {
                                parametros += "&lt;label style='display:flex'>Contadores calor:&lt;/label>\n";
                                for (var x = 0; x &lt; $scope.contador.length; x++) {
                                    if ($scope.contador[x].idcaso == idCaso) {
                                        var Asignado = false;
                                        var AsignadoEquipo = false;
                                        var idcon = "";
                                        numContadores = "";
                                        loop1:
                                        for (var i = 0; i &lt; equipos.length; i++) {
                                            if (equipos[i][8] != equipos[a][8]) {
                                                numContadores = "";
                                                idcon = equipos[i][8];
                                                for (var z = 0; z &lt; idcon.length; z++) {
                                                    if (idcon[z] != ",") {
                                                        if (idcon[z] != "-") {
                                                            numContadores = numContadores + "" + idcon[z];
                                                        }
                                                    } else {
                                                        if (numContadores == $scope.contador[x].id) {
                                                            Asignado = true;
                                                            break loop1;
                                                        }
                                                        numContadores = "";
                                                    }
                                                }
                                            } else {
                                                if (clase != "12") {
                                                numContadores = "";
                                                for (var z = 0; z &lt; contadoresCalor.length; z++) {
                                                    if (contadoresCalor[z] == $scope.contador[x].id) {
                                                        Asignado = true;
                                                        AsignadoEquipo = true;
                                                        break loop1;
                                                    }
                                                    numContadores = "";
                                                }

                                            } else {
                                                for (var z = 0; z &lt; contadoresFrio.length; z++) {
                                                    if (contadoresFrio[z] == $scope.contador[x].id) {
                                                        Asignado = true;
                                                        AsignadoEquipo = true;
                                                        break loop1;
                                            }
                                            numContadores = "";
                                        }
                                    }
                                }
                            }
                                        if (clase != "12") {
                                            if (Asignado == false) {
                                                parametros += "&lt;div>";
                                                parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " calor' type='checkbox'/>" + $scope.contador[x].nombre;
                                                parametros += "&lt;/div>";
                                            }
                                            if (AsignadoEquipo == true) {
                                                parametros += "&lt;div>";
                                                parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " calor' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                                parametros += "&lt;/div>";
                                            }
                                        } else {
                                            if (Asignado == false) {
                                                parametros += "&lt;div>";
                                                parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox'/>" + $scope.contador[x].nombre;
                                                parametros += "&lt;/div>";
                                            }
                                            if (AsignadoEquipo == true) {
                                                parametros += "&lt;div>";
                                                parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                                parametros += "&lt;/div>";
                                            }
                                        }
                                    }
                                }
                            }
                            if (clase != "12") {
                            for (var x = 0; x &lt; valores.length; x++) {
                                parametros += "&lt;div class='inputs'>" + valores[x] + " frio:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + " frio' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                            }
                            } else {
                                parametros += "&lt;div class='inputs'>" + valores[0] + " recuperacion:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[0] + " recuperacion' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                parametros += "&lt;div class='inputs'>% demanda recuperacion:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='% demanda recuperacion' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                            }
                            if (clase != "12") {
                            if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Captador plano" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Tubos de vacio") {
                                parametros += "&lt;label style='display:flex'>Contadores frío:&lt;/label>\n";
                                for (var x = 0; x &lt; $scope.contador.length; x++) {
                                    if ($scope.contador[x].idcaso == idCaso) {
                                        var Asignado = false;
                                        var AsignadoEquipo = false;
                                        var idcon = "";
                                        numContadores = "";
                                        loop1:
                                        for (var i = 0; i &lt; equipos.length; i++) {
                                            if (equipos[i][8] != equipos[a][8]) {
                                                numContadores = "";
                                                idcon = equipos[i][8];
                                                for (var z = 0; z &lt; idcon.length; z++) {
                                                    if (idcon[z] != ",") {
                                                        if (idcon[z] != "-") {
                                                            numContadores = numContadores + "" + idcon[z];
                                                        }
                                                    } else {
                                                        if (numContadores == $scope.contador[x].id) {
                                                            Asignado = true;
                                                            break loop1;
                                                        }
                                                        numContadores = "";
                                                    }
                                                }
                                            } else {
                                                numContadores = "";
                                                for (var z = 0; z &lt; contadoresFrio.length; z++) {
                                                    if (contadoresFrio[z] == $scope.contador[x].id) {
                                                        Asignado = true;
                                                        AsignadoEquipo = true;
                                                        break loop1;
                                                    }
                                                    numContadores = "";
                                                }


                                            }
                                        }
                                        if (Asignado == false) {
                                            parametros += "&lt;div>";
                                            parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox'/>" + $scope.contador[x].nombre;
                                            parametros += "&lt;/div>";
                                        }
                                        if (AsignadoEquipo == true) {
                                            parametros += "&lt;div>";
                                            parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                            parametros += "&lt;/div>";
                                        }
                                    }
                                }
                            }
                        } 
                        }
                        else {
                            for (var x = 0; x &lt; valores.length; x++) {
                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                            }
                            if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Captador plano" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Tubos de vacio") {
                                parametros += "&lt;label style='display:flex'>Contadores:&lt;/label>\n";
                                for (var x = 0; x &lt; $scope.contador.length; x++) {
                                    if ($scope.contador[x].idcaso == idCaso) {
                                        var Asignado = false;
                                        var AsignadoEquipo = false;
                                        var idcon = "";
                                        numContadores = "";
                                        loop1:
                                        for (var i = 0; i &lt; equipos.length; i++) {
                                            if (equipos[i][8] != equipos[a][8]) {
                                                numContadores = "";
                                                idcon = equipos[i][8];
                                                for (var z = 0; z &lt; idcon.length; z++) {
                                                    if (idcon[z] != ",") {
                                                        if (idcon[z] != "-") {
                                                            numContadores = numContadores + "" + idcon[z];
                                                        }
                                                    } else {
                                                        if (numContadores == $scope.contador[x].id) {
                                                            Asignado = true;
                                                            break loop1;
                                                        }
                                                        numContadores = "";
                                                    }
                                                }
                                            } else {
                                                numContadores = "";
                                                idcon = equipos[i][8];
                                                for (var z = 0; z &lt; idcon.length; z++) {
                                                    if (idcon[z] != ",") {
                                                        if (idcon[z] != "-") {
                                                            numContadores = numContadores + "" + idcon[z];
                                                        }
                                                    } else {
                                                        if (numContadores == $scope.contador[x].id) {
                                                            Asignado = true;
                                                            AsignadoEquipo = true;
                                                            break loop1;
                                                        }
                                                        numContadores = "";
                                                    }
                                                }

                                            }
                                        }
                                        if (Asignado == false) {
                                            parametros += "&lt;div>";
                                            parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + "' type='checkbox'/>" + $scope.contador[x].nombre;
                                            parametros += "&lt;/div>";
                                        }
                                        if (AsignadoEquipo == true) {
                                            parametros += "&lt;div>";
                                            parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + "' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                            parametros += "&lt;/div>";
                                        }
                                    }
                                }
                            }
                        }
                        if (clase != "15") {
                        parametros += "&lt;label style='display:flex;margin-top:20px;'>Número de equipos repetidos:&lt;/label>";
                        parametros += "&lt;div>&lt;input style='transform:scale(1)' type='text' id='numEquipos' value='" + equipos[a][10] + "' maxlength='3'>&lt;/div>";
                        }
                        document.getElementById('caracteristicas').innerHTML = parametros;

                        $compile(document.getElementById("caracteristicas"))($scope);
                        //Se cargan los valores escogidos con anterioridad
                        if ((clase == "3" || clase == "10" || clase == "11") &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length / 2; y++) {
                                document.getElementById(valores[y] + " calor").value = caracteristicas[a][y];
                            }

                            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length / 2; y++) {
                                document.getElementById(valores[y] + " frio").value = caracteristicas[a][(y + document.getElementsByClassName('inputs').length / 2)];
                            }

                        } else if (clase == "12"){
                            document.getElementById(valores[0] + " frio").value = caracteristicas[a][0];
                            document.getElementById(valores[1] + " frio").value = caracteristicas[a][1];
                            document.getElementById(valores[0] + " recuperacion").value = caracteristicas[a][2];
                            document.getElementById("% demanda recuperacion").value = caracteristicas[a][3];

                        } else {

                            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                                document.getElementById(valores[y]).value = caracteristicas[a][y];
                            }
                        }
                        var buttons = "";
                        copiaParametros = valores;

                        //Le pasamos las características del botón a borrar, aceptar y cancelar
                        buttons += "&lt;button type='button' class='btn btn-default' onclick='guardarValores(" + cont + "," + clase + ")'>Aceptar&lt;/button>\n";
                        buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
                        buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
                        document.getElementById('footerCaracteristicas').innerHTML = buttons;
                    });
                });

            }
            if (equipos[a][5] == "no") {
                var nombreRepetido = false;
                var name = prompt("Por favor, introduzca un nombre para el equipo");
                if ($scope.equipo.length > 0) {
                    for (var i = 0; i &lt; $scope.equipo.length; i++) {
                        if ($scope.equipo[i].nombreequipo == name) {
                            nombreRepetido = true;
                        }
                    }

                }
                for (var i = 0; i &lt; equipos.length; i++) {
                    if (equipos[i][9] == name &amp;&amp; a != i) {
                        nombreRepetido = true;
                    }
                }
                if (name != '' &amp;&amp; name != null) {
                    if (nombreRepetido == false) {
                        $('#myModalCaracteristicas').modal('show');
                        nombreEquipo[a] = name;
                        $http.post("parametrosServicios" + clase + "Ex.php").success(function (data) {

                            valores = data;
                            // valores.replace(/ /g, '')
                            // for (var x = 0; x &lt; valores.length; x++) {
                            //     if (valores[x] == ">") {
                            //         for (var y = (x + 2); y &lt; valores.length - 3; y++) {
                            //             if (valores[y] != " ") {
                            //                 parametro += valores[y];
                            //             } else {
                            //                 parametro = parametro.substring(0, parametro.length - 1);
                            //                 parametrosServicio.push(parametro);
                            //                 parametro = [];
                            //                 cont2++;
                            //                 break;
                            //             }
                            //         }
                            //     }
                            // }
                            parametrosServicio.push(parametro);
                            valoresSinRepetir = new Array();
                            valoresSinRepetir2 = new Array();
                            valoresSinRepetir3 = new Array();
                            parametro = [];
                            $http.post("selectoresServicios" + clase + "Ex.php").success(function (data) {
                                $scope.valoresServicio = data;
                                $scope.valoresFabricante = $scope.valoresServicio;
                                $scope.valoresModelo = $scope.valoresServicio;
                                $scope.valoresTipo = $scope.valoresServicio;
                                $scope.valoresFabricante = $scope.valoresFabricante.filter(function (currentObject) {
                                    if (currentObject.fabricante in valoresSinRepetir) {
                                        return false;
                                    } else {
                                        valoresSinRepetir[currentObject.fabricante] = true;
                                        return true;
                                    }
                                });
                                $scope.valoresModelo = $scope.valoresModelo.filter(function (currentObject) {
                                    if (currentObject.modelo in valoresSinRepetir2) {
                                        return false;
                                    } else {
                                        valoresSinRepetir2[currentObject.modelo] = true;
                                        return true;
                                    }
                                });
                                $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                                    if (currentObject.tipo in valoresSinRepetir3) {
                                        return false;
                                    } else {
                                        valoresSinRepetir3[currentObject.tipo] = true;
                                        return true;
                                    }
                                });
                                parametros += "&lt;label style='margin-bottom:5%'>"
                                parametros += $scope.serviciosEx[clase - 1].nombretabladatos + "   " + nombreEquipo[a] + "&lt;/br>";
                                parametros += "&lt;/label>"
                                if ((clase == "3"  || clase == "10" || clase == "11" || clase == "12") &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                                    if (clase != "12"){
                                    for (var x = 0; x &lt; valores.length; x++) {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + " calor:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + " calor' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                    }
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[0] + " frio:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[0] + " frio' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                        parametros += "&lt;div class='inputs'>" + valores[1] + " frio:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[1] + " frio' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                    }
                                    if (exismod == 0) {
                                        if (clase != "12") {
                                        parametros += "&lt;label style='display:flex'>Contadores calor:&lt;/label>\n";
                                        } else {
                                            parametros += "&lt;label style='display:flex'>Contadores frío:&lt;/label>\n";
                                        }
                                        for (var x = 0; x &lt; $scope.contador.length; x++) {
                                            if ($scope.contador[x].idcaso == idCaso) {
                                                var Asignado = false;
                                                var AsignadoEquipo = false;
                                                var idcon = "";
                                                numContadores = "";
                                                loop1:
                                                for (var i = 0; i &lt; equipos.length; i++) {
                                                    if (equipos[i][8] != equipos[a][8]) {
                                                        numContadores = "";
                                                        idcon = equipos[i][8];
                                                        for (var z = 0; z &lt; idcon.length; z++) {
                                                            if (idcon[z] != ",") {
                                                                if (idcon[z] != "-") {
                                                                    numContadores = numContadores + "" + idcon[z];
                                                                }
                                                            } else {
                                                                if (numContadores == $scope.contador[x].id) {
                                                                    Asignado = true;
                                                                    break loop1;
                                                                }
                                                                numContadores = "";
                                                            }
                                                        }
                                                    } else {
                                                        numContadores = "";
                                                        idcon = equipos[i][8];
                                                        for (var z = 0; z &lt; idcon.length; z++) {
                                                            if (idcon[z] != ",") {
                                                                if (idcon[z] != "-") {
                                                                    numContadores = numContadores + "" + idcon[z];
                                                                }
                                                            } else {
                                                                if (numContadores == $scope.contador[x].id) {
                                                                    Asignado = true;
                                                                    AsignadoEquipo = true;
                                                                    break loop1;
                                                                }
                                                                numContadores = "";
                                                            }
                                                        }

                                                    }
                                                }
                                                if (clase != "12") {
                                                if (Asignado == false) {
                                                    parametros += "&lt;div>";
                                                    parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " calor' type='checkbox'/>" + $scope.contador[x].nombre;
                                                    parametros += "&lt;/div>";
                                                }
                                                if (AsignadoEquipo == true) {
                                                    parametros += "&lt;div>";
                                                    parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " calor' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                                    parametros += "&lt;/div>";
                                                }
                                                } else {
                                                    if (Asignado == false) {
                                                        parametros += "&lt;div>";
                                                        parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox'/>" + $scope.contador[x].nombre;
                                                        parametros += "&lt;/div>";
                                                    }
                                                    if (AsignadoEquipo == true) {
                                                        parametros += "&lt;div>";
                                                        parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                                        parametros += "&lt;/div>";
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    if (clase != "12") {
                                    for (var x = 0; x &lt; valores.length; x++) {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + " frio:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + " frio' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                    }
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[0] + " recuperacion:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[0] + " recuperacion' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                        parametros += "&lt;div class='inputs'>% demanda recuperacion:&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='% demanda recuperacion' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                    }if(clase!="12"){
                                    if (exismod == 0) {
                                        parametros += "&lt;label style='display:flex'>Contadores frío:&lt;/label>\n";
                                        for (var x = 0; x &lt; $scope.contador.length; x++) {
                                            if ($scope.contador[x].idcaso == idCaso) {
                                                var Asignado = false;
                                                var AsignadoEquipo = false;
                                                var idcon = "";
                                                numContadores = "";
                                                loop1:
                                                for (var i = 0; i &lt; equipos.length; i++) {
                                                    if (equipos[i][8] != equipos[a][8]) {
                                                        numContadores = "";
                                                        idcon = equipos[i][8];
                                                        for (var z = 0; z &lt; idcon.length; z++) {
                                                            if (idcon[z] != ",") {
                                                                if (idcon[z] != "-") {
                                                                    numContadores = numContadores + "" + idcon[z];
                                                                }
                                                            } else {
                                                                if (numContadores == $scope.contador[x].id) {
                                                                    Asignado = true;
                                                                    break loop1;
                                                                }
                                                                numContadores = "";
                                                            }
                                                        }
                                                    } else {
                                                        numContadores = "";
                                                        idcon = equipos[i][8];
                                                        for (var z = 0; z &lt; idcon.length; z++) {
                                                            if (idcon[z] != ",") {
                                                                if (idcon[z] != "-") {
                                                                    numContadores = numContadores + "" + idcon[z];
                                                                }
                                                            } else {
                                                                if (numContadores == $scope.contador[x].id) {
                                                                    Asignado = true;
                                                                    AsignadoEquipo = true;
                                                                    break loop1;
                                                                }
                                                                numContadores = "";
                                                            }
                                                        }

                                                    }
                                                }
                                                if (Asignado == false) {
                                                    parametros += "&lt;div>";
                                                    parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox'/>" + $scope.contador[x].nombre;
                                                    parametros += "&lt;/div>";
                                                }
                                                if (AsignadoEquipo == true) {
                                                    parametros += "&lt;div>";
                                                    parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + " frio' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                                    parametros += "&lt;/div>";
                                                }
                                            }
                                        }
                                    }
                                }}
                                else {
                                    for (var x = 0; x &lt; valores.length; x++) {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>&lt;/div>&lt;/br>\n";
                                    }
                                    if (exismod == 0 &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Fotovoltaica" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Captador plano" &amp;&amp; $scope.serviciosEx[clase - 1].nombre != "Solar Térmica Tubos de vacio") {
                                        parametros += "&lt;label style='display:flex'>Contadores:&lt;/label>\n";
                                        for (var x = 0; x &lt; $scope.contador.length; x++) {
                                            if ($scope.contador[x].idcaso == idCaso) {
                                                var Asignado = false;
                                                var AsignadoEquipo = false;
                                                var idcon = "";
                                                numContadores = "";
                                                loop1:
                                                for (var i = 0; i &lt; equipos.length; i++) {
                                                    if (equipos[i][8] != equipos[a][8]) {
                                                        numContadores = "";
                                                        idcon = equipos[i][8];
                                                        for (var z = 0; z &lt; idcon.length; z++) {
                                                            if (idcon[z] != ",") {
                                                                if (idcon[z] != "-") {
                                                                    numContadores = numContadores + "" + idcon[z];
                                                                }
                                                            } else {
                                                                if (numContadores == $scope.contador[x].id) {
                                                                    Asignado = true;
                                                                    break loop1;
                                                                }
                                                                numContadores = "";
                                                            }
                                                        }
                                                    } else {
                                                        numContadores = "";
                                                        idcon = equipos[i][8];
                                                        for (var z = 0; z &lt; idcon.length; z++) {
                                                            if (idcon[z] != ",") {
                                                                if (idcon[z] != "-") {
                                                                    numContadores = numContadores + "" + idcon[z];
                                                                }
                                                            } else {
                                                                if (numContadores == $scope.contador[x].id) {
                                                                    Asignado = true;
                                                                    AsignadoEquipo = true;
                                                                    break loop1;
                                                                }
                                                                numContadores = "";
                                                            }
                                                        }

                                                    }
                                                }
                                                if (Asignado == false) {
                                                    parametros += "&lt;div>";
                                                    parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + "' type='checkbox'/>" + $scope.contador[x].nombre;
                                                    parametros += "&lt;/div>";
                                                }
                                                if (AsignadoEquipo == true) {
                                                    parametros += "&lt;div>";
                                                    parametros += " &lt;input style='margin-top:3%; margin-left:1%;margin-right: 0.7%; transform:scale(1)' value='" + $scope.contador[x].id + "'  id='" + $scope.contador[x].id + "' type='checkbox' checked/>" + $scope.contador[x].nombre;
                                                    parametros += "&lt;/div>";
                                                }
                                            }
                                        }
                                    }
                                }

                                if (clase != "15"){
                                parametros += "&lt;label>Número de equipos repetidos:&lt;/label>";
                                    parametros += "&lt;div>&lt;input style='transform:scale(1)' type='text' id='numEquipos' value='1' maxlength='3'>&lt;/div>";
                                }
                                document.getElementById('caracteristicas').innerHTML = parametros;
                                var posArray = 0;
                                for (var u = 0; u &lt; equipos.length; u++) {
                                    if (equipos[u][0] == cont) {
                                        posArray = u;
                                    }
                                }

                                if ((clase == "3" || clase == "10" || clase == "11" ) &amp;&amp; equipos[a][2] != "-" &amp;&amp; equipos[a][3] != "-") {
                                    document.getElementById(valores[0] + " calor").value = $scope.valoresServicio[0][valores[0]];
                                    document.getElementById(valores[1] + " calor").value = $scope.valoresServicio[0][valores[1]];
                                    document.getElementById(valores[0] + " frio").value = $scope.valoresServicio[0][valores[0]];
                                    document.getElementById(valores[1] + " frio").value = $scope.valoresServicio[0][valores[1]];
                                } else if (clase == "12"){
                                    document.getElementById(valores[0] + " frio").value = $scope.valoresServicio[0][valores[0]];
                                    document.getElementById(valores[1] + " frio").value = $scope.valoresServicio[0][valores[1]];
                                    document.getElementById(valores[0] + " recuperacion").value = $scope.valoresServicio[0][valores[0]];
                                    document.getElementById("% demanda recuperacion").value = 100;
                                } else {
                                    document.getElementById(valores[0]).value = $scope.valoresServicio[0][valores[0]];
                                    document.getElementById(valores[1]).value = $scope.valoresServicio[0][valores[1]];
                                }
                                valoresServiciosComplementos[posArray][0] = $scope.valoresServicio[0].fabricante;
                                valoresServiciosComplementos[posArray][1] = $scope.valoresServicio[0].modelo;
                                valoresServiciosComplementos[posArray][2] = $scope.valoresServicio[0].tipo;
                                $compile(document.getElementById("caracteristicas"))($scope);
                                var buttons = "";
                                copiaParametros = valores;
                                //Le pasamos las características del botón a borrar, aceptar y cancelar
                                buttons += "&lt;button type='button' class='btn btn-default' onclick='guardarValores(" + cont + "," + clase + ")'>Aceptar&lt;/button>\n";
                                buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
                                buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
                                document.getElementById('footerCaracteristicas').innerHTML = buttons;
                            });
                        })
                    } else {
                        alert("ERROR: Los nombres de los equipos no pueden estar repetidos");
                    }
                } else {
                    alert("Guardado cancelado");
                }
            }
        }
        /**

            *Creamos el modal con las caraacteristicas del equipo existente
            * @param  {string}
            * @return  {void}

            */
        updateCaracteristicas = function (tipo, tipo2, gen, ali, cont, clase) {
            document.getElementById('caracteristicas').innerHTML = "";
            var nombreRepetido = false;
            var parametro = "";
            var parametrosServicio = new Array();
            var parametros = "";
            var valores;
            var valFabri = false;
            var valModelo = false;
            var valTipo= false;
            var contEquiposFiltrados=0;
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    a = x;
                }

            }
            if (clase != "18" &amp;&amp; clase != "16" &amp;&amp; clase != "17") {
                //Comprobamos si el equipo ha sido definido con anterioridad
                if (equipos[a][5] == "si") {
                    $('#myModalCaracteristicas').modal('show');
                    equipos[a][5] = "si";
                    //Sacamos los nombres e los campos del equipo de la base de datos y filtramos los repetidos
                    $http.post("parametrosServicios" + clase + ".php").success(function (data) {
                        valores = data;
                        
                        parametrosServicio.push(parametro);
                        valoresSinRepetir = new Array();
                        valoresSinRepetir2 = new Array();
                        valoresSinRepetir3 = new Array();
                        parametro = [];
                        $http.post("selectoresServicios" + clase + ".php").success(function (data) {
                            $scope.valoresServicio = data;
                            $scope.valoresFabricante = $scope.valoresServicio;
                            $scope.valoresModelo = $scope.valoresServicio;
                            $scope.valoresTipo = $scope.valoresServicio;
                            $scope.valoresFabricante = $scope.valoresFabricante.filter(function (currentObject) {
                                if (currentObject.fabricante in valoresSinRepetir) {
                                    return false;
                                } else {
                                    valoresSinRepetir[currentObject.fabricante] = true;
                                    return true;
                                }
                            });
                            $scope.valoresModelo = $scope.valoresModelo.filter(function (currentObject) {
                                if (currentObject.modelo in valoresSinRepetir2) {
                                    return false;
                                } else {
                                    valoresSinRepetir2[currentObject.modelo] = true;
                                    return true;
                                }
                            });
                            $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                                if (currentObject.tipo in valoresSinRepetir3) {
                                    return false;
                                } else {
                                    valoresSinRepetir3[currentObject.tipo] = true;
                                    return true;
                                }
                            });
                            parametros += $scope.servicios[clase - 1].nombretabladatos + "     " + equipos[a][9] + "&lt;/br>";
                            parametros += "&lt;div id='fabricante'>Fabricantes:&lt;/br>";
                            parametros += "&lt;select onchange='updateModelos(" + tipo + "," + cont + ",1)'style='width: auto;text-align: center; text-align-last: center;' id='fabricante2'>\n";
                            if (clase == "1" || clase == "2" || clase == "5" || clase == "27" || clase == "28" || clase == "29" || clase == "30" || clase == "31" || clase == "32" || clase == "33" || clase == "34") {
                                parametros += "&lt;option value= '0'>Todos&lt;/option>\n";
                                
                            } else {
                                parametros += "&lt;option value= '0' hidden selected  >- Selecciona -&lt;/option>\n";
                            }
                            for (var x = 0; x &lt; $scope.valoresFabricante.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresFabricante[x].id + "'>" + $scope.valoresFabricante[x].fabricante + "&lt;/option>\n";
                            }
                            //Cargamos los modelos de los equipos
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                            parametros += "&lt;div id='modelos'>Modelos:&lt;/br>";
                            parametros += "&lt;select onchange='updateTipos(" + tipo + "," + cont + ",1)' style='width: auto;text-align: center; text-align-last: center;' id='modelos2' >\n";
                            if (clase == "1" || clase == "2" || clase == "5" || clase == "27" || clase == "28" || clase == "29" || clase == "30" || clase == "31" || clase == "32" || clase == "33" || clase == "34") {
                                parametros += "&lt;option value= '0'>Todos&lt;/option>\n";
                            } else {
                                parametros += "&lt;option value= '0'>- Selecciona -&lt;/option>\n";
                            }
                            for (var x = 0; x &lt; $scope.valoresModelo.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresModelo[x].id + "' style='display:none'>" + $scope.valoresModelo[x].modelo + "&lt;/option>&lt;/br>\n";
                            }
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                            //Cargamos el resto de parametros correspondientes al servicio elegido
                            if ($scope.valoresTipo.length > 1) {
                                //Creamos los inputs de los atributos
                                parametros += "&lt;div id='tipos'>Tipos:&lt;/br>";
                                parametros += "&lt;select onchange='updateInputs(" + tipo + "," + cont + ")' style='width: auto;text-align: center; text-align-last: center;' id='tipos2' >\n";
                                if (clase == "1" || clase == "2" || clase == "5" || clase == "27" || clase == "28" || clase == "29" || clase == "30" || clase == "31" || clase == "32" || clase == "33" || clase == "34") {
                                    parametros += "&lt;option value= '0'>Todos&lt;/option>\n";
                                } else {
                                    parametros += "&lt;option value= '0' hidden selected  >- Selecciona -&lt;/option>\n";
                                }
                                for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                    parametros += "&lt;option value='" + $scope.valoresTipo[x].id + "' style='display:none'>" + $scope.valoresTipo[x].tipo + "&lt;/option>\n";
                                }
                                parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                            } var numAtr = 0;
                            var atrPos = new Array();
                            var posicion = new Array();
                            for (var x = 0; x &lt; valores.length; x++) {

                                if (valores[x] == "Precio (€)") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>&lt;/br>     \n";

                                    }
                                } else if (valores[x] == "capacidad_nominal_refrigeracion_kw") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                else if (valores[x] == "area_captador_m2") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                        $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                else if (valores[x] == "potencia_refrigeracion_kw") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                        $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                else if (valores[x] == "capacidad_nominal_calefaccion_kw") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>&lt;/br>     \n";

                                    }
                                } else if (valores[x] == "Número de calderas") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                else if (valores[x] == "Potencia útil (kW)") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" || 
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                else if (valores[x] == "COP nominal") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" || 
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                else if (valores[x] == "EER nominal") {

                                    if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" || 
                                    $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                        $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                        $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                        parametros += "&lt;div>";
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                        parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                        Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                        atrPos.push(valores[x]);
                                        posicion.push(x + (numAtr * 2));
                                        numAtr++;
                                    } else {
                                        parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                    }
                                }
                                 else {
                                    parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                }
                            }
                            var nuevaVar = "";
                            if (posicion.length > 0) {
                                for (var x = 0; x &lt; posicion.length; x++) {
                                    nuevaVar = "max " + atrPos[x];
                                    valores.splice((posicion[x] + 1), 0, nuevaVar);
                                    nuevaVar = "min " + atrPos[x];
                                    valores.splice((posicion[x] + 1), 0, nuevaVar);
                                }
                            }
                            if (clase != "19" &amp;&amp; clase != "20" &amp;&amp; clase != "23") {
                            parametros += "&lt;label>Número de equipos repetidos:&lt;/label>";
                                parametros += "&lt;div>&lt;input style='transform:scale(1)' type='text' id='numEquipos' value='" + equipos[a][10] + "' maxlength='3'>&lt;/div>";
                            }
                            if (clase == "1" || clase == "2" || clase == "5" ||clase == "27" || clase == "28" || clase == "29" || clase == "32" || clase == "33" || clase == "34") {
                                parametros += "&lt;div>&lt;label>Número de equipos filtrados: &lt;/label>&lt;span id='numEquiposFiltrados'>&lt;/span>&lt;/div>"; 
                            }
                            if (clase == "19" || clase == "20" || clase == "21" || clase == "22" || clase == "23" || clase == "24") {
                                parametros += "&lt;div>&lt;button type='button' class='btn btn-default' onclick='updateCampoSolar()'>Campo Solar&lt;/button>&lt;/div>";
                            }

                            document.getElementById('caracteristicas').innerHTML = parametros;
                            $compile(document.getElementById("caracteristicas"))($scope);
                            $compile(document.getElementById("fabricante"))($scope);
                            $compile(document.getElementById("modelos"))($scope);
                            // Se cargan los valores escogidos con anterioridad
                            copiaParametros = valores;
                            if (valoresServiciosComplementos[a][0] == "0") {
                                $('#fabricante2').val("0");
                                
                            } else {
                                for (var x = 0; x &lt; $scope.valoresFabricante.length; x++) {
                                    if (valoresServiciosComplementos[a][0] == $scope.valoresFabricante[x].fabricante) {
                                        $('#fabricante2').val($scope.valoresFabricante[x].id);
                                        updateModelos(tipo, cont,0);
                                    }
                                }
                            }
                            if (valoresServiciosComplementos[a][1] == "0") {
                                $('#modelos2').val("0");
                             
                            } else {
                                for (var x = 0; x &lt; $scope.valoresModelo.length; x++) {
                                    if (valoresServiciosComplementos[a][1] == $scope.valoresModelo[x].modelo) {
                                        $('#modelos2').val($scope.valoresModelo[x].id);
                                        updateTipos(tipo, cont,0);
                                       
                                    }
                                }
                            }
                            if ($scope.valoresTipo.length > 1) {
                                $compile(document.getElementById("tipos"))($scope);
                                if (valoresServiciosComplementos[a][2] == "0") {
                                    $('#tipos2').val("0");
                                    
                                } else {
                                    for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                        if (valoresServiciosComplementos[a][2] == $scope.valoresTipo[x].tipo) {
                                            $('#tipos2').val($scope.valoresTipo[x].id);
                                        }
                                    }
                                }
                            }
                            for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                                document.getElementById(valores[y]).value = caracteristicas[a][y];
                            }

                            var buttons = "";
                            if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][2] == "0"){
                            if (equipos[a][1] == " captadores planos") {
                                for (var y = 0; y &lt; $scope.captadores.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.captadores[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.captadores[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                   
                                    if (valFabri == true &amp;&amp; valModelo == true  &amp;&amp; parseFloat($scope.captadores[y]["area_captador_m2"]) >= parseFloat(document.getElementById("min area_captador_m2").value) &amp;&amp; parseFloat($scope.captadores[y]["area_captador_m2"]) &lt;= parseFloat(document.getElementById("max area_captador_m2").value)) {
                                        contEquiposFiltrados++;

                                    }
                                }
                            }
                            if (equipos[a][1] == " Tubo de vacío") {
                                for (var y = 0; y &lt; $scope.tubosVacio.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.tubosVacio[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.tubosVacio[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp; parseFloat($scope.tubosVacio[y]["area_captador_m2"]) >= parseFloat(document.getElementById("min area_captador_m2").value) &amp;&amp; parseFloat($scope.tubosVacio[y]["area_captador_m2"]) &lt;= parseFloat(document.getElementById("max area_captador_m2").value)) {
                                        contEquiposFiltrados++;

                                    }
                                }
                            }
                            if (equipos[a][1] == " Simple efecto") {
                                for (var y = 0; y &lt; $scope.mase.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.mase[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.mase[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                    if (valoresServiciosComplementos[a][2] == "0" || valoresServiciosComplementos[a][2] == $scope.mase[y]["tipo"]) {
                                        valTipo = true;
                                    }
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp; valTipo == true &amp;&amp; parseFloat($scope.mase[y]["potencia_refrigeracion_kw"]) >= parseFloat(document.getElementById("min potencia_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.mase[y]["potencia_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max potencia_refrigeracion_kw").value)) {
                                        contEquiposFiltrados++;

                                    }
                                }
                            }
                            if (equipos[a][1] == " Baja temperatura") {
                                for (var y = 0; y &lt; $scope.calderasbt.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.calderasbt[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.calderasbt[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                   
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp; parseFloat($scope.calderasbt[y]["Potencia útil (kW)"]) >= parseFloat(document.getElementById("min Potencia útil (kW)").value) &amp;&amp; parseFloat($scope.calderasbt[y]["Potencia útil (kW)"]) &lt;= parseFloat(document.getElementById("max Potencia útil (kW)").value)) {
                                        contEquiposFiltrados++;

                                    }
                                }
                            }
                            else if (equipos[a][1] == "Caldera condensación") {
                                for (var y = 0; y &lt; $scope.calderascondensacion.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.calderascondensacion[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.calderascondensacion[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                    
                                    if (valFabri == true &amp;&amp; valModelo == true  &amp;&amp; parseFloat($scope.calderascondensacion[y]["Potencia útil (kW)"]) >= parseFloat(document.getElementById("min Potencia útil (kW)").value) &amp;&amp; parseFloat($scope.calderascondensacion[y]["Potencia útil (kW)"]) &lt;= parseFloat(document.getElementById("max Potencia útil (kW)").value)) {
                                        contEquiposFiltrados++;
                                    }
                                }
                            }
                            else if (equipos[a][1] == "Calderas de biomasa") {
                                for (var y = 0; y &lt; $scope.calderasbiomasa.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.calderasbiomasa[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.calderasbiomasa[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                  
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp;  parseFloat($scope.calderasbiomasa[y]["Potencia útil (kW)"]) >= parseFloat(document.getElementById("min Potencia útil (kW)").value) &amp;&amp; parseFloat($scope.calderasbiomasa[y]["Potencia útil (kW)"]) &lt;= parseFloat(document.getElementById("max Potencia útil (kW)").value)) {
                                        contEquiposFiltrados++;
                                    }
                                }

                            }
                            else if (equipos[a][1] == "Bomba de calor aire agua") {
                                for (var y = 0; y &lt; $scope.bombacaloraireagua.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.bombacaloraireagua[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.bombacaloraireagua[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                    if (valoresServiciosComplementos[a][2] == "0" || valoresServiciosComplementos[a][2] == $scope.bombacaloraireagua[y]["tipo"]) {
                                        valTipo = true;
                                    }
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp; valTipo == true &amp;&amp;parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_refrigeracion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_refrigeracion_kw").value) &amp;&amp;
                                        parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_calefaccion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_calefaccion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["capacidad_nominal_calefaccion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_calefaccion_kw").value) &amp;&amp;
                                        parseFloat($scope.bombacaloraireagua[y]["COP nominal"]) >= parseFloat(document.getElementById("min COP nominal").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["COP nominal"]) &lt;= parseFloat(document.getElementById("max COP nominal").value) &amp;&amp;
                                        parseFloat($scope.bombacaloraireagua[y]["EER nominal"]) >= parseFloat(document.getElementById("min EER nominal").value) &amp;&amp; parseFloat($scope.bombacaloraireagua[y]["EER nominal"]) &lt;= parseFloat(document.getElementById("max EER nominal").value)) {
                                        contEquiposFiltrados++;
                                    }
                                }
                            }
                            else if (equipos[a][1] == "Bomba de calor agua agua") {
                                for (var y = 0; y &lt; $scope.bombacaloraguaagua.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.bombacaloraguaagua[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.bombacaloraguaagua[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                    if (valoresServiciosComplementos[a][2] == "0" || valoresServiciosComplementos[a][2] == $scope.bombacaloraguaagua[y]["tipo"]) {
                                        valTipo = true;
                                    }
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp; valTipo == true &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_refrigeracion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_refrigeracion_kw").value) &amp;&amp;
                                        parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_calefaccion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_calefaccion_kw").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["capacidad_nominal_calefaccion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_calefaccion_kw").value) &amp;&amp;
                                        parseFloat($scope.bombacaloraguaagua[y]["COP nominal"]) >= parseFloat(document.getElementById("min COP nominal").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["COP nominal"]) &lt;= parseFloat(document.getElementById("max COP nominal").value) &amp;&amp;
                                        parseFloat($scope.bombacaloraguaagua[y]["EER nominal"]) >= parseFloat(document.getElementById("min EER nominal").value) &amp;&amp; parseFloat($scope.bombacaloraguaagua[y]["EER nominal"]) &lt;= parseFloat(document.getElementById("max EER nominal").value)) {
                                        contEquiposFiltrados++;
                                    }
                                }
                            }
                            else if (equipos[a][1] == "Enfriadora con recuperación") {
                                for (var y = 0; y &lt; $scope.enfriadorarecuperacion.length; y++) {
                                    valFabri = false;
                                    valModelo = false;
                                    valTipo = false;
                                    if (valoresServiciosComplementos[a][0] == "0" || valoresServiciosComplementos[a][0] == $scope.enfriadorarecuperacion[y]["fabricante"]) {
                                        valFabri = true;
                                    }
                                    if (valoresServiciosComplementos[a][1] == "0" || valoresServiciosComplementos[a][1] == $scope.enfriadorarecuperacion[y]["modelo"]) {
                                        valModelo = true;
                                    }
                                    if (valoresServiciosComplementos[a][2] == "0" || valoresServiciosComplementos[a][2] == $scope.enfriadorarecuperacion[y]["tipo"]) {
                                        valTipo = true;
                                    }
                                    if (valFabri == true &amp;&amp; valModelo == true &amp;&amp; valTipo == true &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_refrigeracion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_refrigeracion_kw").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_refrigeracion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_refrigeracion_kw").value) &amp;&amp;
                                        parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_calefaccion_kw"]) >= parseFloat(document.getElementById("min capacidad_nominal_calefaccion_kw").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["capacidad_nominal_calefaccion_kw"]) &lt;= parseFloat(document.getElementById("max capacidad_nominal_calefaccion_kw").value) &amp;&amp;
                                        parseFloat($scope.enfriadorarecuperacion[y]["COP nominal"]) >= parseFloat(document.getElementById("min COP nominal").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["COP nominal"]) &lt;= parseFloat(document.getElementById("max COP nominal").value) &amp;&amp;
                                        parseFloat($scope.enfriadorarecuperacion[y]["EER nominal"]) >= parseFloat(document.getElementById("min EER nominal").value) &amp;&amp; parseFloat($scope.enfriadorarecuperacion[y]["EER nominal"]) &lt;= parseFloat(document.getElementById("max EER nominal").value)) {
                                        contEquiposFiltrados++;
                                    }
                                }

                            }
                            }
                            Hparametrico.applyfilter(1);
                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||$scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" || $scope.valoresServicio[0].idservicio == "32" || $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                // document.getElementById("numEquiposFiltrados").value = contEquiposFiltrados;
                            }
                            //Le pasamos las características del botón a borrar, aceptar y cancelar
                            buttons += "&lt;button type='button' class='btn btn-default' onclick='guardarValores(" + cont + "," + clase + ")'>Aceptar&lt;/button>\n";
                            buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
                            buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
                            document.getElementById('footerCaracteristicas').innerHTML = buttons;
                        });
                    });
                }
                if (equipos[a][5] == "no")  {
                    var name = prompt("Por favor, introduzca un nombre para el equipo");

                    if (name != '' &amp;&amp; name != null) {
                        if ($scope.equipo.length > 0) {
                            for (var i = 0; i &lt; $scope.equipo.length; i++) {
                                if ($scope.equipo[i].nombreequipo == name) {
                                    nombreRepetido = true;
                                }
                            }

                        }
                        for (var i = 0; i &lt; equipos.length; i++) {
                            if (equipos[i][9] == name &amp;&amp; a != i) {
                                nombreRepetido = true;
                            }
                        }
                        if (nombreRepetido == false) {
                            $('#myModalCaracteristicas').modal('show');
                            nombreEquipo[a] = name;
                            $http.post("parametrosServicios" + clase + ".php").success(function (data) {
                                valores = data;
                                // valores.replace(/ /g, '')
                                // for (var x = 0; x &lt; valores.length; x++) {
                                //     if (valores[x] == ">") {
                                //         for (var y = (x + 2); y &lt; valores.length - 3; y++) {
                                //             if (valores[y] != " ") {
                                //                 parametro += valores[y];
                                //             } else {
                                //                 parametro = parametro.substring(0, parametro.length - 1);
                                //                 parametrosServicio.push(parametro);
                                //                 parametro = [];
                                //                 cont2++;
                                //                 break;
                                //             }
                                //         }
                                //     }
                                // }
                                parametrosServicio.push(parametro);
                                valoresSinRepetir = new Array();
                                valoresSinRepetir2 = new Array();
                                valoresSinRepetir3 = new Array();
                                parametro = [];
                                $http.post("selectoresServicios" + clase + ".php").success(function (data) {
                                    $scope.valoresServicio = data;
                                    $scope.valoresFabricante = $scope.valoresServicio;
                                    $scope.valoresModelo = $scope.valoresServicio;
                                    $scope.valoresTipo = $scope.valoresServicio;
                                    $scope.valoresFabricante = $scope.valoresFabricante.filter(function (currentObject) {
                                        if (currentObject.fabricante in valoresSinRepetir) {
                                            return false;
                                        } else {
                                            valoresSinRepetir[currentObject.fabricante] = true;
                                            return true;
                                        }
                                    });
                                    $scope.valoresModelo = $scope.valoresModelo.filter(function (currentObject) {
                                        if (currentObject.modelo in valoresSinRepetir2) {
                                            return false;
                                        } else {
                                            valoresSinRepetir2[currentObject.modelo] = true;
                                            return true;
                                        }
                                    });
                                    $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                                        if (currentObject.tipo in valoresSinRepetir3) {
                                            return false;
                                        } else {
                                            valoresSinRepetir3[currentObject.tipo] = true;
                                            return true;
                                        }
                                    });
                                    if (tipo == "1") {
                                        parametros += $scope.servicios[clase - 1].nombretabladatos + "     " + nombreEquipo[a] + "&lt;/br>";
                                    } else {
                                        parametros += $scope.serviciosEx[clase - 1].nombretabladatos + "     " + nombreEquipo[a] + "&lt;/br>";
                                    }
                                    parametros += "&lt;div id='fabricante'>Fabricantes:&lt;/br>";
                                    parametros += "&lt;select onchange='updateModelos(" + tipo + "," + cont + ",1)'style='width: auto;text-align: center; text-align-last: center;' id='fabricante2'>\n";
                                    if (clase == "1" || clase == "2" || clase == "5" ||clase == "27" || clase == "28" || clase == "29" || clase == "30" || clase == "31" || clase == "32" || clase == "33" || clase == "34") {
                                        parametros += "&lt;option value= '0' >Todos&lt;/option>\n";
                                        
                                    } else {
                                        parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    }
                                    for (var x = 0; x &lt; $scope.valoresFabricante.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresFabricante[x].id + "'>" + $scope.valoresFabricante[x].fabricante + "&lt;/option>\n";
                                    }
                                    //Cargamos los modelos de los equipos
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                    parametros += "&lt;div id='modelos'>Modelos:&lt;/br>";
                                    parametros += "&lt;select onchange='updateTipos(" + tipo + "," + cont + ",1)' style='width: auto;text-align: center; text-align-last: center;' id='modelos2' >\n";
                                    if (clase == "1" || clase == "2" || clase == "5" || clase == "27" || clase == "28" || clase == "29" || clase == "30" || clase == "31" || clase == "32" || clase == "33" || clase == "34") {
                                        parametros += "&lt;option value= '0' >Todos&lt;/option>\n";
                                    } else {
                                        parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    }
                                    for (var x = 0; x &lt; $scope.valoresModelo.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresModelo[x].id + "' style='display:none'>" + $scope.valoresModelo[x].modelo + "&lt;/option>\n";
                                    }
                                    //Cargamos el resto de parametros correspondientes al servicio elegido
                                    //Creamos los inputs de los atributos
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                    if ($scope.valoresTipo.length > 1) {
                                        parametros += "&lt;div id='tipos'>Tipos:&lt;/br>";
                                        parametros += "&lt;select onchange='updateInputs(" + tipo + "," + cont + ")' style='width: auto;text-align: center; text-align-last: center;' id='tipos2' >\n";
                                       if (clase == "1" || clase == "2" || clase == "5" || clase == "27" || clase == "28" || clase == "29" || clase == "30" || clase == "31" || clase == "32" || clase == "33" || clase == "34") {
                                            parametros += "&lt;option value= '0' >Todos&lt;/option>\n";
                                        } else {
                                            parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                        }
                                        for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                            parametros += "&lt;option value='" + $scope.valoresTipo[x].id + "' style='display:none'>" + $scope.valoresTipo[x].tipo + "&lt;/option>\n";
                                        }
                                        parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                    } else {
                                        parametros += "&lt;/br>\n";
                                    }

                                    var numAtr = 0;
                                    var atrPos = new Array();
                                    var posicion = new Array();
                                    for (var x = 0; x &lt; valores.length; x++) {

                                        if (valores[x] == "Precio (€)") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>&lt;/br>     \n";

                                                    }
                                        } else if (valores[x] == "capacidad_nominal_refrigeracion_kw") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }
                                        else if (valores[x] == "area_captador_m2") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }
                                        else if (valores[x] == "potencia_refrigeracion_kw") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }
                                        else if (valores[x] == "capacidad_nominal_calefaccion_kw") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>&lt;/br>     \n";

                                            }
                                        } else if (valores[x] == "Número de calderas") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }
                                        else if (valores[x] == "Potencia útil (kW)") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }
                                        else if (valores[x] == "COP nominal") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }
                                        else if (valores[x] == "EER nominal") {

                                            if ($scope.valoresServicio[0].idservicio == "1" || $scope.valoresServicio[0].idservicio == "2" || $scope.valoresServicio[0].idservicio == "5" ||
                                                $scope.valoresServicio[0].idservicio == "27" || $scope.valoresServicio[0].idservicio == "28" || $scope.valoresServicio[0].idservicio == "29" ||
                                                $scope.valoresServicio[0].idservicio == "30" || $scope.valoresServicio[0].idservicio == "31" || $scope.valoresServicio[0].idservicio == "32" ||
                                                $scope.valoresServicio[0].idservicio == "33" || $scope.valoresServicio[0].idservicio == "34") {
                                                parametros += "&lt;div>";
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>min:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='min " + valores[x] + "' maxlength='4' value='" + 0 + "'>";
                                                parametros += "&lt;div class='inputs'>max:&lt;input style='transform:scale(1);width: 50px;text-align:center;'type='text'  id='max " + valores[x] + "' maxlength='4' value='" + 0 + "'>&lt;/div>&lt;/br>";
                                                Hparametrico.Getlabels(valores[x],equipos[a][1].trim(),nombreEquipo[a],equipos[a][7]);
                                                atrPos.push(valores[x]);
                                                posicion.push(x + (numAtr * 2));
                                                numAtr++;
                                            } else {
                                                parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                            }
                                        }else {
                                    parametros += "&lt;div class='inputs'>" + valores[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valores[x] + "' value='" + 0 + "'> &lt;/br>    \n";

                                }
                                        
                                    }
                                    var nuevaVar = "";
                                    if (posicion.length > 0) {
                                        for (var x = 0; x &lt; posicion.length; x++) {
                                            nuevaVar = "max " + atrPos[x];
                                            valores.splice((posicion[x] + 1), 0, nuevaVar);
                                            nuevaVar = "min " + atrPos[x];
                                            valores.splice((posicion[x] + 1), 0, nuevaVar);
                                        }
                                    }
                                    if (clase != "19" &amp;&amp; clase != "20" &amp;&amp; clase != "23"){
                                    parametros += "&lt;label>Número de equipos repetidos:&lt;/label>";
                                        parametros += "&lt;div>&lt;input style='transform:scale(1)' type='text' id='numEquipos' value='1'  maxlength='3'>&lt;/div>";
                                    }
                                    if (clase == "1" || clase == "2" || clase == "5" || clase == "27" || clase == "28" || clase == "29" || clase == "32" || clase == "33" || clase == "34") {
                                        parametros += "&lt;div>&lt;label>Número de equipos filtrados: &lt;/label>&lt;span id='numEquiposFiltrados'>&lt;/span>&lt;/div>"; 
                                    }
                                    if (clase == "19" || clase == "20" || clase == "21" || clase == "22" || clase == "23" || clase == "24") {
                                        parametros += "&lt;div>&lt;button type='button' class='btn btn-default' onclick='updateCampoSolar()'>Campo Solar&lt;/button >&lt;/div>";
                                    
                                    }
                                    document.getElementById('caracteristicas').innerHTML = parametros;
                                    copiaParametros = valores;
                                    Hparametrico.applyfilter(0);
                                    $compile(document.getElementById("caracteristicas"))($scope);
                                    $compile(document.getElementById("fabricante"))($scope);
                                    $compile(document.getElementById("modelos"))($scope);
                                    if ($scope.valoresTipo.length > 1) {
                                        $compile(document.getElementById("tipos"))($scope);
                                        document.getElementById('tipos').style.visibility = "hidden";
                                    }
                                    document.getElementById('modelos').style.visibility = "hidden";
                                    
                                    for (var y = 0; y &lt; document.getElementsByClassName('inputs').length; y++) {
                                        document.getElementsByClassName('inputs')[y].style.visibility = "hidden";
                                    }
                                    var buttons = "";

                                    
                                    //Le pasamos las características del botón a borrar, aceptar y cancelar
                                    buttons += "&lt;button type='button' class='btn btn-default' onclick='guardarValores(" + cont + "," + clase + ")'>Aceptar&lt;/button>\n";
                                    buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
                                    buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
                                    document.getElementById('footerCaracteristicas').innerHTML = buttons;
                                    updateModelos(tipo, cont,1);
                                });
                            });
                        } else {
                            alert("ERROR: Los nombres de los equipos no pueden estar repetidos");
                        }
                    } else {
                        alert("Guardado cancelado");
                    }
                }
            } else {
                alert("Todavía no definido");
            }
        }
        /**

            *Creamos el campo campo solar

            * @return  {void}

            */
        updateCampoSolar = function () {
            var menu = "";
            menu += "&lt;div>";
            menu += "&lt;label>Campo Solar &lt;/label>";
            menu += "&lt;/div>";
            menu += "&lt;div>";
            menu += "&lt;span>Campo Dato&lt;/span>";
            menu += "&lt;select id='Campo Dato' style='width: auto;text-align: center; text-align-last: center;margin-left:5px;'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>SI&lt;/option>";
            menu += "&lt;option value='2'>NO&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            //OPTION CAMPO DATO = SI
            menu += "&lt;div id='campodatosi' style='display:none; flex-wrap:wrap;     justify-content: space-between;'>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;span style='margin-top:10px;'>Número Paneles Serie en cada string&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Número de strings&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Factor anual pérdidas por sombras (%)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Azimut del campo (180º Sur) (º)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Inclinación de los paneles (º)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Separación entre hileras (m)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Altura de módulo (m)&lt;/span>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;input maxlength='4' step='any' class='+1000 -1  natural' type='number' max='1000' min='1' id='Número Paneles'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='10'>";
            menu += "&lt;input maxlength='4' step='any' class='+1000 -1 natural' type='number' max='1000' min='1' id='Número Strings'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='1'>";
            menu += "&lt;input maxlength='6' step='any' class='+100 -0 float' type='number'  max='100' min='1' id='Pérdidas Sombras'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>";
            menu += "&lt;input maxlength='6' step='any' class='+360 -0 float' type='number'  max='360' min='0' id='Azimut'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='214'>";
            menu += "&lt;input maxlength='6' step='any' class='+90 -0 float' type='number'  max='90' min='0' id='Inclinación1'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='25'>";
            menu += "&lt;input maxlength='6' step='any' class='+10 -1 float' type='number'  max='10' min='1' id='Separación entre hileras' style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='2.2'>";
            menu += "&lt;input maxlength='6' step='any' class='+100 -1 float'  type='number'  max='100' min='1'  id ='Altura'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='2.2'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            //OPTION CAMPO DATO = NO
            menu += "&lt;div id='campodatosno' style='display:none;'>";
            menu += "&lt;div style='margin-top: 25px;display: flex; justify-content: space-between;'>";
            menu += "&lt;label>Superficie Disponible&lt;/label>";
            menu += "&lt;div>";
            menu += "&lt;select id='Superficie Disponible' style='width: auto;text-align: center; text-align-last: center;margin-left:5px;'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>SI&lt;/option>";
            menu += "&lt;option value='2'>NO&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div id='superficiepredim' style='display:none;'>";
            menu += "&lt;div style='display:flex; flex-wrap:wrap; justify-content: space-between;'>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;span style='margin-top:10px;'>x1 (m)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>x2 (m)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>a (º)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Área bruta disponible (m2)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>¿Hay Inclinación?&lt;/span>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;input maxlength='14' step='any' class='+1000 -1 float'  id='x1' type='number' min='1' max='1000' id='x1'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;'value='30'>";
            menu += "&lt;input class='+1000 -1 float'maxlength='14' step='any' id='x2' type='number' min='1' max='1000' id='x2'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;'value='10'>";
            menu += "&lt;input class='+360 -0 float' maxlength='6' step='any'  id='a' type='number' min='0' max='360'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;'value='0'>";
            menu += "&lt;input id='Área bruta disponible' step='any' type='number' id='Área bruta disponible' disabled='true'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='300'>";

            menu += "&lt;select id='Hay inclinacion' style='margin-top: 10px;width: auto;text-align: center; text-align-last: center;margin-left:5px;'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>SI&lt;/option>";
            menu += "&lt;option value='2'>NO&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            menu += "&lt;div style='transform: scale(0.7);'>";
            menu += "&lt;img src='camposolar.PNG'>&lt;/img>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style='margin-top:10px'>";
            menu += "&lt;div id='divinclinacion2' style='margin-top:10px;display:none; flex-wrap:wrap; justify-content: space-around;' >";
            menu += "&lt;span id='inclinacion2' margin-top:10px;>Inclinación (º)&lt;/span>";
            menu += "&lt;input maxlength='6' step='any' class='+90 -0 float'  id='Inclinación2' type='number' min='0' max='90'  style='margin-top: 4px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div style='margin-top: 25px;display: flex; justify-content: space-between;' >";
            menu += "&lt;label>Potencia Pico&lt;/label>";
            menu += "&lt;div >";
            menu += "&lt;select id='Potencia pico' style='width: auto;text-align: center; text-align-last: center;margin-left:5px;'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>SI&lt;/option>";
            menu += "&lt;option value='2'>NO&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div id='potenciapredim' style='display:none; flex-wrap:wrap;     justify-content: space-between;'>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;span style='margin-top:10px;'>Valor (kW)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Valor mínimo (kW)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Valor Máximo (kW)&lt;/span>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;input type='number' maxlength='6' step='any' class='+100 -0 float' id='Potencia pico valor' max='100' min='0'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;'value='7'>";
            menu += "&lt;input type='number' id='Potencia pico valor mínimo' disabled='true' step='any'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>";
            menu += "&lt;input type='number' id='Potencia pico valor máximo' step='any' disabled='true'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='margin-left: 10px;display: flex;flex-direction: column;    justify-content: flex-end;'>";
            menu += "&lt;span style='margin-top:10px;'>Tolerancia (%)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;margin-bottom: 6px;'>Tolerancia (%)&lt;/span>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex;flex-direction: column;    justify-content: flex-end;'>";
            menu += "&lt;input type='number' maxlength='6' class='+100 -0 float' step='any' min='0' max='100' id='Potencia pico valor mínimo tolerancia'   style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='30'>";
            menu += "&lt;input type='number' maxlength='6' class='+100 -0 float' step='any' min='0' max='100' id='Potencia pico valor máximo tolerancia'   style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='30'>";
            menu += "&lt;/div>";

            menu += "&lt;/div>";
            menu += "&lt;div style='margin-top: 25px;display: flex; justify-content: space-between;' >";
            menu += "&lt;label>% de demanda cubierta&lt;/label>";
            menu += "&lt;div >";
            menu += "&lt;select id='Demanda cubierta' style='width: auto;text-align: center; text-align-last: center;margin-left:5px;'>";
            menu += "&lt;option value='0' hidden selected '> - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>SI&lt;/option>";
            menu += "&lt;option value='2'>NO&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;div id='demandapredim' style='display:none; flex-wrap:wrap;     justify-content: space-between;'>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;span>Valor esperado (%)&lt;/span>";
            menu += "&lt;span>Valor mínimo (%)&lt;/span>";
            menu += "&lt;span>Valor Máximo (%)&lt;/span>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex;flex-direction: column;justify-content: space-evenly;'>";
            menu += "&lt;input maxlength='6' id='Demanda cubierta valor' type='number' class='+100 -0 float' step='any' max='100' min='0'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;'value='0'>";
            menu += "&lt;input type='number' step='any' id='Demanda cubierta valor mínimo'  disabled='true' style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>";
            menu += "&lt;input type='number' step='any' id='Demanda cubierta valor máximo'  disabled='true'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>";
            menu += "&lt;/div>";
            menu += "&lt;div style='margin-left: 10px;display: flex;flex-direction: column;    justify-content: flex-end;'>";
            menu += "&lt;span style='margin-top:10px;'>Tolerancia (%)&lt;/span>";
            menu += "&lt;span style='margin-top:10px;margin-bottom: 6px;'>Tolerancia (%)&lt;/span>";
            menu += "&lt;/div>";
            menu += "&lt;div style='display: flex;flex-direction: column;    justify-content: flex-end;'>";
            menu += "&lt;input type='number' maxlength='6' class='+100 -0 float' step='any' min='0' max='100' id='Demanda cubierta valor mínimo tolerancia'   style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='30'>";
            menu += "&lt;input type='number' maxlength='6' class='+100 -0 float' step='any' min='0' max='100' id='Demanda cubierta valor máximo tolerancia'   style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='30'>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";
            menu += "&lt;/div>";

            document.getElementById("body-camposolar").innerHTML = menu;
            $('#myModalCampoSolar').modal('show');
            document.getElementById('Campo Dato').addEventListener("change", IniCampodato);
            document.getElementById('Superficie Disponible').addEventListener("change", IniPredim);
            document.getElementById('Potencia pico').addEventListener("change", IniPredim);
            document.getElementById('Demanda cubierta').addEventListener("change", IniPredim);
            document.getElementById('Hay inclinacion').addEventListener("change", IniPredim);
            x1.addEventListener("change", Areabrutapredim);
            x2.addEventListener("change", Areabrutapredim);
            document.getElementById('Potencia pico valor máximo tolerancia').addEventListener("change", Potenciapicopredim);
            document.getElementById('Potencia pico valor mínimo tolerancia').addEventListener("change", Potenciapicopredim);
            document.getElementById('Potencia pico valor').addEventListener("change", Potenciapicopredim);
            document.getElementById('Demanda cubierta valor máximo tolerancia').addEventListener("change", Demandacubiertapredim);
            document.getElementById('Demanda cubierta valor mínimo tolerancia').addEventListener("change", Demandacubiertapredim);
            document.getElementById('Demanda cubierta valor').addEventListener("change", Demandacubiertapredim);
            var event = new Event("change", { bubbles: true });
            document.getElementById('Potencia pico valor máximo tolerancia').dispatchEvent(event);
            document.getElementById('Potencia pico valor mínimo tolerancia').dispatchEvent(event);
            document.getElementById('Demanda cubierta valor máximo tolerancia').dispatchEvent(event);
            document.getElementById('Demanda cubierta valor mínimo tolerancia').dispatchEvent(event);
            cargarcamposolar();
        }
        /**

            *Cargamos el campo campo solar

            * @return  {void}

            */
        cargarcamposolar = async function () {
            //Cargamos los datos
            await $http.post("CampoSolar.php", { 'action': "cargar", 'id': idCaso, })
                .success(function (data) {
                    $scope.camposolarcaso = data;
                    ADcamposolar = data;
                })
                if ($scope.camposolarcaso != "false")
                {
            $.each($scope.camposolarcaso, function (index, value) {
                for (var continput = 0; continput &lt; $('#body-camposolar input').length; continput++) {
                    if (index == $('#body-camposolar input')[continput].id) {
                        $('#body-camposolar input')[continput].value = value;
                        break;
                    }
                }
                for (var contselect = 0; contselect &lt; $('#body-camposolar select').length; contselect++) {
                    if (index == $('#body-camposolar select')[contselect].id) {
                        switch (value) {
                            case " - Selecciona -":
                                var res = 0;
                                break;
                            case "SI":
                                var res = 1;
                                break;
                            case "NO":
                                var res = 2;
                                break;
                        }
                        $('#body-camposolar select')[contselect].value = res;
                        break;
                    }
                }
            })
            var event = new Event("change", { bubbles: true });
            document.getElementById('Campo Dato').dispatchEvent(event);
        }
        }
        /**

            *Cargamos el campo cubierta predim
            * @return  {void}

            */
        Demandacubiertapredim = function () {
            var oEvento = event || window.event;
            var target = oEvento.target;
            if (target.id == 'Demanda cubierta valor') {
                var calcporcentajemin = parseInt(document.getElementById('Demanda cubierta valor mínimo tolerancia').value) * parseInt(document.getElementById('Demanda cubierta valor').value) / 100;
                var calcporcentajemax = parseInt(document.getElementById('Demanda cubierta valor máximo tolerancia').value) * parseInt(document.getElementById('Demanda cubierta valor').value) / 100;
                document.getElementById('Demanda cubierta valor máximo').value = (calcporcentajemax + parseInt(document.getElementById('Demanda cubierta valor').value)).toFixed(2);
                document.getElementById('Demanda cubierta valor mínimo').value = (parseInt(document.getElementById('Demanda cubierta valor').value) - calcporcentajemin).toFixed(2);
                return;
            }
            var calcporcentaje = parseInt(target.value) * parseInt(document.getElementById('Demanda cubierta valor').value) / 100;
            if (target.id == 'Demanda cubierta valor máximo tolerancia')
                document.getElementById('Demanda cubierta valor máximo').value = (calcporcentaje + parseInt(document.getElementById('Demanda cubierta valor').value)).toFixed(2);
            else
                document.getElementById('Demanda cubierta valor mínimo').value = (parseInt(document.getElementById('Demanda cubierta valor').value) - calcporcentaje).toFixed(2);
        }
        /**

            *Cargamos el campo cubierta predim
            * @return  {void}

            */
        Potenciapicopredim = function () {
            var oEvento = event || window.event;
            var target = oEvento.target;
            if (target.id == 'Potencia pico valor') {

                var calcporcentajemin = parseInt(document.getElementById('Potencia pico valor mínimo tolerancia').value) * parseInt(document.getElementById('Potencia pico valor').value) / 100;
                var calcporcentajemax = parseInt(document.getElementById('Potencia pico valor máximo tolerancia').value) * parseInt(document.getElementById('Potencia pico valor').value) / 100;
                document.getElementById('Potencia pico valor máximo').value = (calcporcentajemax + parseInt(document.getElementById('Potencia pico valor').value)).toFixed(2);
                document.getElementById('Potencia pico valor mínimo').value = (parseInt(document.getElementById('Potencia pico valor').value) - calcporcentajemin).toFixed(2);
                return;
            }
            var calcporcentaje = parseInt(target.value) * parseInt(document.getElementById('Potencia pico valor').value) / 100;
            if (target.id == 'Potencia pico valor máximo tolerancia')
                document.getElementById('Potencia pico valor máximo').value = (calcporcentaje + parseInt(document.getElementById('Potencia pico valor').value)).toFixed(2);
            else
                document.getElementById('Potencia pico valor mínimo').value = (parseInt(document.getElementById('Potencia pico valor').value) - calcporcentaje).toFixed(2);
        }
        /**

            *Cargamos el campo area bruta

            * @return  {void}

            */
        Areabrutapredim = function () {
            var calcareabruta = x1.value * x2.value;
            document.getElementById('Área bruta disponible').value = calcareabruta;
        }
        /**

            *Guardamos los datos del campo solar en la base de datos

            * @return  {void}

            */
        guardarcamposolar = function () {
                var selectcd = document.getElementById('Campo Dato');
                var select1 = document.getElementById('Superficie Disponible');
                var select2 = document.getElementById('Potencia pico');
                var select3 = document.getElementById('Demanda cubierta');
            if (selectcd.value == 2 &amp;&amp; (select1.value == 0 || select1.value == 2) &amp;&amp; (select2.value == 0 || select2.value == 2) &amp;&amp; (select3.value == 0 || select3.value == 2)) {
                    alert('ERROR: Debe seleccionar alguna opción a "SI"');
                        return;
                }
            var selector = $('#body-camposolar select');
            for (var chkselect = 0; chkselect &lt; selector.length; chkselect++) {
                if (selector[chkselect].value == 0)
                    selector[chkselect].value = 2;
            }
            //Los guardamos en la base de datos
            $http.post("CampoSolar.php", {
                'action': "guardar",
                'id': idCaso,
                'campodato': document.getElementById('Campo Dato').selectedOptions[0].textContent,
                'numeropaneles': $('#campodatosi input')[0].value,
                'numerostrings': $('#campodatosi input')[1].value,
                'perdidassombras': $('#campodatosi input')[2].value,
                'azimut': $('#campodatosi input')[3].value,
                'inclinacion1': $('#campodatosi input')[4].value,
                'separacion': $('#campodatosi input')[5].value,
                'altura': $('#campodatosi input')[6].value,
                'superficie': document.getElementById('Superficie Disponible').selectedOptions[0].textContent,
                'x1': $('#superficiepredim input')[0].value,
                'x2': $('#superficiepredim input')[1].value,
                'a': $('#superficiepredim input')[2].value,
                'areabruta': $('#superficiepredim input')[3].value,
                'hayinclinacion': $('#superficiepredim select')[0].selectedOptions[0].textContent,
                'inclinacion2': $('#superficiepredim input')[4].value,
                'potenciapico': document.getElementById('Potencia pico').selectedOptions[0].textContent,
                'potenciapicovalor': $('#potenciapredim input')[0].value,
                'potenciapicovalormin': $('#potenciapredim input')[1].value,
                'potenciapicovalormax': $('#potenciapredim input')[2].value,
                'potenciapicotoleranciamin': $('#potenciapredim input')[3].value,
                'potenciapicotoleranciamax': $('#potenciapredim input')[4].value,
                'demandacubierta': document.getElementById('Demanda cubierta').selectedOptions[0].textContent,
                'demandacubiertavalor': $('#demandapredim input')[0].value,
                'demandacubiertavalormin': $('#demandapredim input')[1].value,
                'demandacubiertavalormax': $('#demandapredim input')[2].value,
                'demandacubiertatoleranciamin': $('#demandapredim input')[3].value,
                'demandacubiertatoleranciamax': $('#demandapredim input')[4].value,
            }).catch(function (error) {
                alert('Se ha encontrado el siguiente error:\r\n ' + error.data + '');
                return OcultarSpinner();
            });

        }
        /**

            *Cargamos los datos de un equipo

            * @return  {void}

            */
        IniPredim = function () {
            var oEvento = event || window.event;
            var target = oEvento.target;
            if (target.id == "Hay inclinacion") {
                if (target.value == 1)
                    divinclinacion2.style.display = "flex";
                else
                    divinclinacion2.style.display = "none";
                return;
            }
            //Cargamos la minisección
            if (document.getElementById('Potencia pico').value == 1 || document.getElementById('Demanda cubierta').value == 1) {
                if (document.getElementById('Potencia pico').value == 1) {
                    document.getElementById('Demanda cubierta').disabled = true;
                    document.getElementById('Demanda cubierta').style.backgroundColor = "#d3d3d3";
                }
                else {
                    document.getElementById('Potencia pico').disabled = true;
                    document.getElementById('Potencia pico').style.backgroundColor = "#d3d3d3";
                }
            }
            else {
                document.getElementById('Potencia pico').disabled = false;
                document.getElementById('Potencia pico').style.backgroundColor = "white";
                document.getElementById('Demanda cubierta').disabled = false;
                document.getElementById('Demanda cubierta').style.backgroundColor = "white";
            }

            if (target.value == 1)
                switch (target.id) {
                    case "Superficie Disponible":
                        superficiepredim.style.display = "initial";

                        break;
                    case "Potencia pico":
                        potenciapredim.style.display = "flex";

                        demandapredim.style.display = "none";
                        document.getElementById('Demanda cubierta').value = 2;
                        break;
                    case "Demanda cubierta":
                        demandapredim.style.display = "flex";
                        potenciapredim.style.display = "none";
                        document.getElementById('Potencia pico').value = 2;

                        break;
                }
            else
                switch (target.id) {
                    case "Superficie Disponible":
                        superficiepredim.style.display = "none";

                        break;
                    case "Potencia pico":
                        potenciapredim.style.display = "none";

                        break;
                    case "Demanda cubierta":
                        demandapredim.style.display = "none";

                        break;
                }
        }
        /**

            *Guardamos los datos del campo solar en la base de datos
            * @return  {void}

            */
        IniCampodato = function () {
            var oEvento = event || window.event;
            var target = oEvento.target;
            //Cargamos la sección
            if (target.value == 1) {
                campodatosi.style.display = "flex";
                campodatosno.style.display = "none";
            }
            else if (target.value == 2) {
                campodatosi.style.display = "none";
                campodatosno.style.display = "initial";
                var event = new Event("change", { bubbles: true });
                document.getElementById('Superficie Disponible').dispatchEvent(event);
                document.getElementById('Potencia pico').dispatchEvent(event);
                document.getElementById('Demanda cubierta').dispatchEvent(event);
                document.getElementById('Hay inclinacion').dispatchEvent(event);
                document.getElementById('Potencia pico valor máximo tolerancia').dispatchEvent(event);
                document.getElementById('Potencia pico valor mínimo tolerancia').dispatchEvent(event);
                document.getElementById('Demanda cubierta valor máximo tolerancia').dispatchEvent(event);
                document.getElementById('Demanda cubierta valor mínimo tolerancia').dispatchEvent(event);
            }
        }
        /**

            *Función de levantar tecla
            * @param  {number}
            * @return  {void}

            */
        $(window).keyup(function (e) {
            // EJEMPLO DE FUNCIONAMIENTO (Propiedades requerdias)
            // maxlength='4' step='any' class='+1000 -1  natural' type='number' max='1000' min='1'
            //Filtramos teclas
            if ($('input[type=number]').index($(e.target)) != -1) {
                if (
                    ($.inArray(e.keyCode, [9, 37, 38, 39, 40, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 8, 13, 189, 188, 190]) == -1) // digitos permitidos
                    || ((e.keyCode == 190 || e.keyCode == 188) &amp;&amp; ($(e.target).val().indexOf(".") || $(e.target).val().indexOf(",")) != -1) // no doble punto doble coma
                    || ((e.keyCode == 190 || e.keyCode == 188) &amp;&amp; $(e.target).val().length == 0 // no . o , al principio
                    )
                ) {
                    e.target.value = e.target.value.slice(0, -1)
                }

                var valormin;
                var valormax;
                //Filtramos valores
                $.each(e.target.classList, function (index, value) {
                    if (value.indexOf('+') != -1) {
                        valormax = value.substring(value.lastIndexOf('+') + 1, value.lastIndexOf(value.slice(-1)) + 1);
                        if (parseFloat(e.target.value) >= parseFloat(valormax))
                            e.target.value = valormax;
                    }
                    if (value.indexOf('-') != -1) {
                        valormin = value.substring(value.lastIndexOf('-') + 1, value.lastIndexOf(value.slice(-1)) + 1);
                       
                    }
                  
                    if (value == 'int' || value == 'natural') // ENTERO
                    {
                        if (e.keyCode == 188 || e.keyCode == 190)
                            e.target.value = e.target.value.slice(0, -1)
                    }
                    if (value == 'natural') //NO NEGATIVO
                    {
                
                    }
                    if (e.target.value.length > e.target.maxLength &amp;&amp; e.target.maxLength != -1)
                        e.target.value = e.target.value.slice(0, e.target.maxLength)
                })
            }
        });
         /**

            *Creamos el modal con las caracteristicas del equipo
            * @param  {string}
            * @return  {void}

            */
        updateCaracteristicasComplemento = function (tipo, tipo2, gen, ali, cont, clase) {
            var parametro = "";
            var nombreRepetido = false;
            var parametros = "";
            document.getElementById('caracteristicas').innerHTML = "";
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    a = x;
                }

            }

            //Comprobamos si el complemento ha sido definido
            if (equipos[a][5] == "si") {
                $('#myModalCaracteristicas').modal('show');
                equipos[a][5] = "si";
                //Sacamos los nombres de los campos del complemento seleccionado
                if (equipos[a][1].trim() == "Li-ion + Inversor") {
                    $http.post("parametrosComplemento1.php", { 'idcaso': idCaso, 'nombre': equipos[a][1] })
                        .success(function (data) {
                            var header = document.createElement('label');
                            header.innerText = "FVInversoresBateria" + "     " + nombreEquipo[a];
                            updatebateriainversor(header, cont, 1, data[0], tipo, tipo2, gen, ali);
                        })
                    return;
                }
                $http.post("parametrosComplemento" + clase + ".php", { 'idcaso': idCaso, 'nombre ': equipos[a][9] }).success(function (data) {
                    valoresComplemento = data;
                    
                    valoresSinRepetir = new Array();
                    valoresSinRepetir2 = new Array();
                    valoresSinRepetir3 = new Array();
                    valoresSinRepetir4 = new Array();
                    parametro = [];
                    $http.post("selectoresComplemento" + clase + ".php").success(function (data) {
                        $scope.valoresComplemento = data;
                        $scope.valoresFabricante = $scope.valoresComplemento;
                        $scope.valoresModelo = $scope.valoresComplemento;
                        $scope.valoresTipo = $scope.valoresComplemento;
                        $scope.valoresmodeloInversor = $scope.valoresComplemento;
                        $scope.valoresPrecio = $scope.valoresComplemento;
                        $scope.valoresTipoRegulacion = $scope.valoresComplemento;
                        $scope.valoresRegulacion = $scope.valoresComplemento;
                        $scope.valoresNombre = $scope.valoresComplemento;
                        $scope.valoresModelo = $scope.valoresModelo.filter(function (currentObject) {
                            if (currentObject.modelo in valoresSinRepetir2) {
                                return false;
                            } else {
                                valoresSinRepetir2[currentObject.modelo] = true;
                                return true;
                            }
                        });
                        if (clase == "1") {
                            
                        }
                        else if (clase == "14") {
                            $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                                if (currentObject.tipo in valoresSinRepetir3) {
                                    return false;
                                } else {
                                    valoresSinRepetir3[currentObject.tipo] = true;
                                    return true;
                                }
                            });
                            $scope.valoresRegulacion = $scope.valoresRegulacion.filter(function (currentObject) {
                                if (currentObject.regulacion in valoresSinRepetir4) {
                                    return false;
                                } else {
                                    valoresSinRepetir4[currentObject.regulaciÓn] = true;
                                    return true;
                                }
                            });
                        }
                        else if (clase == "15") {
                            $scope.valoresTipoRegulacion = $scope.valoresTipoRegulacion.filter(function (currentObject) {
                                if (currentObject.tipo_regulacion in valoresSinRepetir3) {
                                    return false;
                                } else {
                                    valoresSinRepetir3[currentObject.tipo_regulacion] = true;
                                    return true;
                                }
                            });
                        } else {
                            $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                                if (currentObject.tipo in valoresSinRepetir3) {
                                    return false;
                                } else {
                                    valoresSinRepetir3[currentObject.tipo] = true;
                                    return true;
                                }
                            });
                        }
                        if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                            $scope.valoresNombre = $scope.valoresNombre.filter(function (currentObject) {
                                if (currentObject.nombre in valoresSinRepetir) {
                                    return false;
                                } else {
                                    valoresSinRepetir[currentObject.nombre] = true;
                                    return true;
                                }
                            });
                        } else {
                            $scope.valoresFabricante = $scope.valoresFabricante.filter(function (currentObject) {
                                if (currentObject.fabricante in valoresSinRepetir) {
                                    return false;
                                } else {
                                    valoresSinRepetir[currentObject.fabricante] = true;
                                    return true;
                                }
                            });
                        }
                        parametros += "&lt;label style='margin-bottom:5%'>"
                        parametros += $scope.complementos[clase - 1].nombretabladatos + "     " + equipos[a][9];
                        parametros += "&lt;/label>"
                        if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                            parametros += "&lt;div id='nombreComplemento'>Nombres complemento:&lt;/br>";
                            parametros += "&lt;select onchange='updateModelosComplemento2(" + cont + "," + clase + ")'style='width: auto;text-align: center;text-align-last: center;' id='nombreComplemento2'>\n";
                            parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                            for (var x = 0; x &lt; $scope.valoresNombre.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresNombre[x].id + "' >" + $scope.valoresNombre[x].nombre + " &lt;/option>\n";
                            }
                        } else {
                            parametros += "&lt;div id='fabricanteComplemento'>Fabricantes complemento:&lt;/br>";
                            parametros += "&lt;select onchange='updateModelosComplemento(" + cont + "," + clase + ")'style='width: auto;text-align: center;text-align-last: center;' id='fabricanteComplemento2'>\n";
                            parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                            for (var x = 0; x &lt; $scope.valoresFabricante.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresFabricante[x].id + "' >" + $scope.valoresFabricante[x].fabricante + "&lt;/option>\n";
                            }
                        }
                        //Cargamos los nombres de los equipos
                        if (clase == "1") {
                            

                        } else {
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                            parametros += "&lt;div id='modelosComplemento'>Modelos complemento:&lt;/br>";
                            parametros += "&lt;select onchange='updateTiposComplementos(" + cont + "," + clase + ")' style='width: 30%;text-align: center;text-align-last: center;' id='modelosComplemento2' >\n";
                            parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                            for (var x = 0; x &lt; $scope.valoresModelo.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresModelo[x].id + "' style='display:none'>" + $scope.valoresModelo[x].modelo + "&lt;/option>\n";
                            }
                            //Creamos los tipos de los atributos
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                        }
                        if (clase == "15") {
                            parametros += "&lt;div id='tiposRegulacionComplemento'>Tipos_regulación complemento:&lt;/br>";
                            parametros += "&lt;select onchange='updateInputsComplemento(" + cont + "," + clase + ")' style='width: auto;text-align: center;text-align-last: center;' id='tiposRegulacionComplemento2' >\n";
                            parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                            for (var x = 0; x &lt; $scope.valoresTipoRegulacion.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresTipoRegulacion[x].id + "' style='display:none'>" + $scope.valoresTipoRegulacion[x].tipo_regulacion + "&lt;/option>\n";
                            }
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                        } else if (clase == "14") {
                            parametros += "&lt;div id='tiposComplemento'>Tipos complemento:&lt;/br>";
                            parametros += "&lt;select onchange='updateRegulacion(" + cont + "," + clase + ")' style='width: auto;text-align: center;text-align-last: center;' id='tiposComplemento2' >\n";
                            parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                            for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresTipo[x].id + "' style='display:none'>" + $scope.valoresTipo[x].tipo + "&lt;/option>\n";
                            }
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                            parametros += "&lt;div id=' regulacionComplemento'>Regulación complemento:&lt;/br>";
                            parametros += "&lt;select onchange='updateInputsComplemento2(" + cont + "," + clase + ")' style='width: auto;text-align: center;text-align-last: center;' id='regulacionComplemento2' >\n";
                            parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                            for (var x = 0; x &lt; $scope.valoresRegulacion.length; x++) {
                                parametros += "&lt;option value='" + $scope.valoresRegulacion[x].id + "' style='display:none'>" + $scope.valoresRegulacion[x].regulacion + "&lt;/option>\n";
                            }
                            parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                        } else if (clase == "1") {
                            $http.post("parametrosComplemento1.php", { 'idcaso': idCaso, 'nombre': equipos[a][1] })
                                .success(function (data) {
                                    var header = document.createElement('label');
                                    header.innerText = "FVInversoresBateria" + "     " + nombreEquipo[a];
                                    updatebateriainversor(header, cont, 1, data[0], tipo, tipo2, gen, ali);

                                })
                            return;
                        } else {
                            if ($scope.valoresTipo.length > 1) {
                                parametros += "&lt;div id='tiposComplemento'>Tipos complemento:&lt;/br>";
                                parametros += "&lt;select onchange='updateInputsComplemento(" + cont + "," + clase + ")' style='width: auto;text-align: center;text-align-last: center;' id='tiposComplemento2' >\n";
                                parametros += "&lt;option value= '0' hidden selected ' > - Selecciona -&lt;/option>\n";
                                for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                    parametros += "&lt;option value='" + $scope.valoresTipo[x].id + "' style='display:none'>" + $scope.valoresTipo[x].tipo + "&lt;/option>\n";
                                }
                                parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                            } else {
                                parametros += "&lt;/br>\n";
                            }
                        }
                        //Creamos los inputs de los atributos
                        if (clase != '1')
                            for (var x = 0; x &lt; valoresComplemento.length; x++) {
                                parametros += "&lt;div class='inputsComplemento'>" + valoresComplemento[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valoresComplemento[x] + "' value='" + caracteristicas[a][x] + "'>&lt;/div>&lt;/br>\n";
                            }

                        document.getElementById('caracteristicas').innerHTML = parametros;

                        copiaParametros = valoresComplemento;
                        $compile(document.getElementById("caracteristicas"))($scope);
                        //cargamos los valores introducidos con anterioridad
                        if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                            $compile(document.getElementById("nombreComplemento"))($scope);
                            for (var x = 0; x &lt; $scope.valoresNombre.length; x++) {
                                if (valoresServiciosComplementos[a][0] == $scope.valoresNombre[x].nombre) {
                                    $('#nombreComplemento2').val($scope.valoresNombre[x].id);
                                    updateModelosComplemento2(cont, clase);
                                }
                            }
                        } else {
                            $compile(document.getElementById("fabricanteComplemento"))($scope);
                            for (var x = 0; x &lt; $scope.valoresFabricante.length; x++) {
                                if (valoresServiciosComplementos[a][0] == $scope.valoresFabricante[x].fabricante) {
                                    $('#fabricanteComplemento2').val($scope.valoresFabricante[x].id);
                                    updateModelosComplemento(cont, clase);
                                }
                            }
                        }
                        $compile(document.getElementById("modelosComplemento"))($scope);
                        for (var x = 0; x &lt; $scope.valoresModelo.length; x++) {
                            if (valoresServiciosComplementos[a][1] == $scope.valoresModelo[x].modelo) {
                                $('#modelosComplemento2').val($scope.valoresModelo[x].id);
                                updateTiposComplementos(cont, clase);
                            }
                        }
                        if (clase == "15") {
                            $compile(document.getElementById("tiposRegulacionComplemento"))($scope);
                            for (var x = 0; x &lt; $scope.valoresTipoRegulacion.length; x++) {
                                if (valoresServiciosComplementos[a][2] == $scope.valoresTipoRegulacion[x].tipo_regulacion) {
                                    $('#tiposRegulacionComplemento2').val($scope.valoresTipoRegulacion[x].id);
                                }
                            }
                        }
                        else if (clase == "1") {
                            
                        }
                        else if (clase == "14") {
                            $compile(document.getElementById("tiposComplemento"))($scope);
                            for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                if (valoresServiciosComplementos[a][2] == $scope.valoresTipo[x].tipo) {
                                    $('#tiposComplemento2').val($scope.valoresTipo[x].id);
                                }
                            }
                            $compile(document.getElementById("regulacionComplemento"))($scope);
                            for (var x = 0; x &lt; $scope.valoresRegulacion.length; x++) {
                                if (valoresServiciosComplementos[a][3] == $scope.valoresRegulacion[x].regulacion) {
                                    $('#regulacionComplemento2').val($scope.valoresRegulacion[x].id);
                                }
                            }
                        } else {
                            if ($scope.valoresTipo.length > 1) {
                                $compile(document.getElementById("tiposComplemento"))($scope);
                                for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                    if (valoresServiciosComplementos[a][2] == $scope.valoresTipo[x].tipo) {
                                        $('#tiposComplemento2').val($scope.valoresTipo[x].id);
                                    }
                                }
                            }
                        }
                        for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                            document.getElementById(valoresComplemento[y]).value = caracteristicas[a][y];
                        }
                        var buttons = "";
                        //Le pasamos las características del botón a borrar, aceptar y cancelar
                        buttons += "&lt;button type='button' class='btn btn-default' onclick='guardarValoresComplemento(" + cont + "," + clase + ")'>Aceptar&lt;/button>\n";
                        buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
                        buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
                        document.getElementById('footerCaracteristicas').innerHTML = buttons;
                    });
                });

            }
            if (equipos[a][5] == "no") {
                var name = prompt("Por favor, introduzca un nombre para el equipo");
                if (name != '' &amp;&amp; name != null) {
                    if ($scope.equipo.length > 0) {
                        for (var i = 0; i &lt; $scope.equipo.length; i++) {
                            if ($scope.equipo[i].nombreequipo == name) {
                                nombreRepetido = true;
                            }
                        }

                    }
                    for (var i = 0; i &lt; equipos.length; i++) {
                        if (equipos[i][9] == name &amp;&amp; a != i) {
                            nombreRepetido = true;
                        }
                    }
                    if (nombreRepetido == false) {
                        $('#myModalCaracteristicas').modal('show');
                        nombreEquipo[a] = name;
                        $http.post("parametrosComplemento" + clase + ".php", { 'idcaso': idCaso, 'nombre ': equipos[a][9] }).success(function (data) {
                            valoresComplemento = data;
                            
                            valoresSinRepetir = new Array();
                            valoresSinRepetir2 = new Array();
                            valoresSinRepetir3 = new Array();
                            valoresSinRepetir4 = new Array();
                            parametro = [];
                            $http.post("selectoresComplemento" + clase + ".php").success(function (data) {
                                $scope.valoresComplemento = data;
                                $scope.valoresFabricante = $scope.valoresComplemento;
                                $scope.valoresModelo = $scope.valoresComplemento;
                                $scope.valoresTipo = $scope.valoresComplemento;
                                $scope.valoresmodeloInversor = $scope.valoresComplemento;
                                $scope.valoresPrecio = $scope.valoresComplemento;
                                $scope.valoresTipoRegulacion = $scope.valoresComplemento;
                                $scope.valoresRegulacion = $scope.valoresComplemento;
                                $scope.valoresNombre = $scope.valoresComplemento;
                                $scope.valoresModelo = $scope.valoresModelo.filter(function (currentObject) {
                                    if (currentObject.modelo in valoresSinRepetir2) {
                                        return false;
                                    } else {
                                        valoresSinRepetir2[currentObject.modelo] = true;
                                        return true;
                                    }
                                });
                                if (clase == "15") {
                                    $scope.valoresRegulacion = $scope.valoresRegulacion.filter(function (currentObject) {
                                        if (currentObject.regulacion in valoresSinRepetir4) {
                                            return false;
                                        } else {
                                            valoresSinRepetir4[currentObject.regulacion] = true;
                                            return true;
                                        }
                                    });
                                }
                                if (clase == "1") {
                                    
                                }
                                else if (clase == "14") {
                                    $scope.valoresTipoRegulacion = $scope.valoresTipoRegulacion.filter(function (currentObject) {
                                        if (currentObject.tipo_regulacion in valoresSinRepetir3) {
                                            return false;
                                        } else {
                                            valoresSinRepetir3[currentObject.tipo_regulacion] = true;
                                            return true;
                                        }
                                    });
                                } else {
                                    $scope.valoresTipo = $scope.valoresTipo.filter(function (currentObject) {
                                        if (currentObject.tipo in valoresSinRepetir3) {
                                            return false;
                                        } else {
                                            valoresSinRepetir3[currentObject.tipo] = true;
                                            return true;
                                        }
                                    });
                                }
                                if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                                    if ($scope.valoresNombre.length > 1) {
                                        $scope.valoresNombre = $scope.valoresNombre.filter(function (currentObject) {
                                            if (currentObject.nombre in valoresSinRepetir) {
                                                return false;
                                            } else {
                                                valoresSinRepetir[currentObject.nombre] = true;
                                                return true;
                                            }
                                        });
                                    }
                                } else {
                                    $scope.valoresFabricante = $scope.valoresFabricante.filter(function (currentObject) {
                                        if (currentObject.fabricante in valoresSinRepetir) {
                                            return false;
                                        } else {
                                            valoresSinRepetir[currentObject.fabricante] = true;
                                            return true;
                                        }
                                    });
                                }
                                parametros += "&lt;label style='margin-bottom:5%'>"
                                parametros += $scope.complementos[clase - 1].nombretabladatos + "     " + nombreEquipo[a];
                                parametros += "&lt;/label>"
                                if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                                    parametros += "&lt;div id='nombreComplemento'>Nombres complemento:&lt;/br>";
                                    parametros += "&lt;select onchange='updateModelosComplemento2(" + cont + "," + clase + ")'style='width: auto;text-align: center; text-align-last: center;' id='nombreComplemento2'>\n";
                                    parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    for (var x = 0; x &lt; $scope.valoresNombre.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresNombre[x].id + "'>" + $scope.valoresNombre[x].nombre + "&lt;/option>\n";
                                    }
                                } else {
                                    parametros += "&lt;div id='fabricanteComplemento'>Fabricantes complemento:&lt;/br>";
                                    parametros += "&lt;select onchange='updateModelosComplemento(" + cont + "," + clase + ")'style='width: auto;text-align: center; text-align-last: center;' id='fabricanteComplemento2'>\n";
                                    parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    for (var x = 0; x &lt; $scope.valoresFabricante.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresFabricante[x].id + "'>" + $scope.valoresFabricante[x].fabricante + "&lt;/option>\n";
                                    }
                                }
                                if (clase == "1") {
                                    var header = document.createElement('label');
                                    header.innerText = "FVInversoresBateria" + "     " + nombreEquipo[a];
                                    updatebateriainversor(header, cont, clase, undefined, tipo, tipo2, gen, ali);
                                    return;
                                } else {
                                    //Cargamos los nombres de los equipos
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                    parametros += "&lt;div id='modelosComplemento'>Modelos complemento:&lt;/br>";
                                    parametros += "&lt;select onchange='updateTiposComplementos(" + cont + "," + clase + ")' style='width: auto;text-align: center; text-align-last: center;' id='modelosComplemento2' >\n";
                                    parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    for (var x = 0; x &lt; $scope.valoresModelo.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresModelo[x].id + "' style='display:none'>" + $scope.valoresPrecio[x].modelo + "&lt;/option>\n";
                                    }
                                    //Creamos los tipos de los atributos
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                }
                                if (clase == "15") {
                                    parametros += "&lt;div id='tiposRegulacionComplemento'>Tipos_regulación complemento:&lt;/br>";
                                    parametros += "&lt;select onchange='updateInputsComplemento(" + cont + "," + clase + ")' style='width: auto;text-align: center; text-align-last: center;' id='tiposRegulacionComplemento2' >\n";
                                    parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    for (var x = 0; x &lt; $scope.valoresTipoRegulacion.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresTipoRegulacion[x].id + "'style='display:none'>" + $scope.valoresTipoRegulacion[x].tipo_regulacion + "&lt;/option>\n";
                                    }
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                } else if (clase == "14") {
                                    parametros += "&lt;div id='tiposComplemento'>Tipos complemento:&lt;/br>";
                                    parametros += "&lt;select onchange='updateRegulacion(" + cont + "," + clase + ")' style='width: auto;text-align: center; text-align-last: center;' id='tiposComplemento2' >\n";
                                    parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresTipo[x].id + "' style='display:none'>" + $scope.valoresTipo[x].tipo + " &lt;/option>\n";
                                    }
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                    parametros += "&lt;div id='regulacionComplemento'>Regulación complemento:&lt;/br>";
                                    parametros += "&lt;select onchange='updateInputsComplemento2(" + cont + "," + clase + ")' style='width: auto;text-align: center; text-align-last: center;' id='regulacionComplemento2' >\n";
                                    parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                    for (var x = 0; x &lt; $scope.valoresRegulacion.length; x++) {
                                        parametros += "&lt;option value='" + $scope.valoresRegulacion[x].id + "' style='display:none'>" + $scope.valoresRegulacion[x].regulacion + "&lt;/option>\n";
                                    }
                                    parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                } else if (clase == "1") {
                                    parametros += "&lt;div id='modeloInversorComplementos'>Modelo inversor complemento:&lt;/br>";
                                    
                                } else {
                                    if ($scope.valoresTipo.length > 1) {
                                        parametros += "&lt;div id='tiposComplemento'>Tipos complemento:&lt;/br>";
                                        parametros += "&lt;select onchange='updateInputsComplemento(" + cont + "," + clase + ")' style='width: auto;text-align: center; text-align-last: center;' id='tiposComplemento2' >\n";
                                        parametros += "&lt;option value= '0' hidden selected  > - Selecciona -&lt;/option>\n";
                                        for (var x = 0; x &lt; $scope.valoresTipo.length; x++) {
                                            parametros += "&lt;option value='" + $scope.valoresTipo[x].id + "' style='display:none'>" + $scope.valoresTipo[x].tipo + "&lt;/option>\n";
                                        }
                                        parametros += "&lt;/select>&lt;/div>&lt;/br>\n";
                                    } else {
                                        parametros += "&lt;/br>\n";
                                    }
                                }
                                //Creamos los inputs de los atributos
                                for (var x = 0; x &lt; valoresComplemento.length; x++) {
                                    parametros += "&lt;div class='inputsComplemento'>" + valoresComplemento[x] + ":&lt;/br>&lt;input style='transform:scale(1)'type='text'  id='" + valoresComplemento[x] + "' value='" + 0 + "'>&lt;/div>&lt;br>\n";
                                }

                                document.getElementById('caracteristicas').innerHTML = parametros;
                                $compile(document.getElementById("caracteristicas"))($scope);
                                if (clase == "16" || clase == "17" || clase == "18" || clase == "19" || clase == "14" || clase == "8" || clase == "9" || clase == "10" || clase == "11" || clase == "12") {
                                    $compile(document.getElementById("nombreComplemento"))($scope);
                                } else {
                                    $compile(document.getElementById("fabricanteComplemento"))($scope);
                                } if (clase == "15") {
                                    $compile(document.getElementById("tiposRegulacionComplemento"))($scope);
                                    document.getElementById('tiposRegulacionComplemento').style.visibility = "hidden";
                                } else {
                                    if ($scope.valoresTipo.length > 1) {
                                        $compile(document.getElementById("tiposComplemento"))($scope);
                                        document.getElementById('tiposComplemento').style.visibility = "hidden";
                                    }
                                }
                                if (clase == "14") {
                                    $compile(document.getElementById("regulacionComplemento"))($scope);
                                    document.getElementById('regulacionComplemento').style.visibility = "hidden";
                                }
                                $compile(document.getElementById("modelosComplemento"))($scope);
                                document.getElementById('modelosComplemento').style.visibility = "hidden";
                                for (var y = 0; y &lt; document.getElementsByClassName('inputsComplemento').length; y++) {
                                    document.getElementsByClassName('inputsComplemento')[y].style.visibility = "hidden";
                                }
                                var buttons = "";
                                copiaParametros = valoresComplemento;
                                //Le pasamos las características del botón a borrar, aceptar y cancelar
                                buttons += "&lt;button type='button' class='btn btn-default' onclick='guardarValoresComplemento(" + cont + "," + clase + ")'>Aceptar&lt;/button>\n";
                                buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
                                buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
                                document.getElementById('footerCaracteristicas').innerHTML = buttons;
                            });
                        });
                    } else {
                        alert("ERROR: El nombre no puede estar repetido");
                    }
                } else {
                    alert("Guardado cancelado");
                }
            }
        }
        /**

            *Cargamos el formulario de los usos
            * @param  {string}
            * @return  {void}

            */
        updateCaracteristicasUso = function (tipo, tipo2, gen, ali, cont, colectorUso) {
            var parametros = "";
            var a = 0;
            var colectorUso2 = 0;
            document.getElementById('caracteristicas').innerHTML = "";
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][0] == cont) {
                    a = x;
                }
            }
            $('#myModalCaracteristicas').modal('show');
            
            for (var x = 0; x &lt; colectores.length; x++) {
                if (colectores[x][0] == "C" + colectorUso) {
                    colectorUso2 = x;
                    break;
                }
            }
            if (colectores[colectorUso2][1] != "9") {
                parametros += "&lt;span style='margin-right:7px'>temp. máxima(ºC)&lt;/span> &lt;input id=tempMaxGM style='transform: scale(1); margin-right:20%;'  size='5' type='text'  value='" + colectores[colectorUso2][2] + "' maxlength='5'/>";
                parametros += "&lt;span style ='margin-right:7px'>temp. mínima(ºC)&lt;/span> &lt;input id=tempMinGM style='transform: scale(1);' size='5' type='text'  value='" + colectores[colectorUso2][3] + "' maxlength='5'/>&lt;/br>";

                if (colectores[colectorUso2][1] == "1" || colectores[colectorUso2][1] == "2" || colectores[colectorUso2][1] == "3" || colectores[colectorUso2][1] == "4" || colectores[colectorUso2][1] == "5" || colectores[colectorUso2][1] == "14") {
                    parametros += "&lt;span style ='margin-right:7px'>Consumo total calor(%)&lt;/span> &lt;input step='any' class='+1000 -0  float' type='number' max='100' min='0' id='porConC' style='transform: scale(1);' size='5' type='text' value='" + colectores[colectorUso2][4] + "' maxlength='5'/>";
                }
                if (colectores[colectorUso2][1] == "7" || colectores[colectorUso2][1] == "8" || colectores[colectorUso2][1] == "5" || colectores[colectorUso2][1] == "15") {
                    parametros += "&lt;span style ='margin-right:7px'>Consumo total frio(%)&lt;/span> &lt;input step='any' class='+1000 -0  float' type='number' max='100' min='0' id='porConF' style='transform: scale(1);' size='5' type='text' value='" + colectores[colectorUso2][5] + "' maxlength='5'/>";
                }
                if (colectores[colectorUso2][1] == "5" || colectores[colectorUso2][1] == "11") {
                    parametros += "&lt;span style ='margin-right:7px'>Consumo total ACS(%)&lt;/span> &lt;input step='any' class='+1000 -0  float' type='number' max='100' min='0' id='porConACS' style='transform: scale(1);' size='5' type='text' value='" + colectores[colectorUso2][6] + "' maxlength='5'/>";
                }
                document.getElementById("caracteristicas").innerHTML = parametros;
            }
            var buttons = "";
            //Le pasamos las características del botón a borrar, aceptar y cancelar

            if (colectores[colectorUso2][1] != "9") {
                buttons += "&lt;button type='button' class='btn btn-default' onclick='CambiarTemperatura(" + colectorUso2 + ")'>Aceptar&lt;/button>\n";
            }
            buttons += "&lt;button type='button' class='btn btn-default' onclick='borrarButton(" + tipo + "," + tipo2 + "," + gen + "," + ali + "," + cont + ")'>Borrar&lt;/button>\n";
            buttons += "&lt;button type='button' class='btn btn-default' data-dismiss='modal'>Cancelar&lt;/button>\n";
            document.getElementById('footerCaracteristicas').innerHTML = buttons;
        }
        
        /**

            *Guardamos los cambios de temperatura de los colectores
            * @param  {string}
            * @return  {void}

            */
        CambiarTemperatura = function (colectorUso2) {
            var C = true;
            if (colectores[colectorUso2][1] == "1" || colectores[colectorUso2][1] == "2" || colectores[colectorUso2][1] == "3" || colectores[colectorUso2][1] == "4" || colectores[colectorUso2][1] == "5" || colectores[colectorUso2][1] == "14") {

                if (parseFloat(document.getElementById('porConC').value) &lt;= 0.0 || parseFloat(document.getElementById('porConC').value) > 100.0) {
                    alert("ERROR: Los porcentajes de consumo calor no pueden ser menor o igual que 0 ni mayor que 100");
                    C = false;
                }
            }
            if (colectores[colectorUso2][1] == "7" || colectores[colectorUso2][1] == "8" || colectores[colectorUso2][1] == "5" || colectores[colectorUso2][1] == "15") {

                if (parseFloat(document.getElementById('porConF').value) &lt;= 0.0 || parseFloat(document.getElementById('porConF').value) > 100.0) {
                    alert("ERROR: Los porcentajes de consumo frío no pueden ser menor o igual que 0 ni mayor que 100");
                    C = false;
                }
            }
            if (colectores[colectorUso2][1] == "11" || colectores[colectorUso2][1] == "5") {

                if (parseFloat(document.getElementById('porConACS').value) &lt;= 0.0 || parseFloat(document.getElementById('porConACS').value) > 100.0) {
                    alert("ERROR: Los porcentajes de consumo acs no pueden ser menor o igual que 0 ni mayor que 100");
                    C = false;
                }
            }
            if (/^[0-9]*$/.test(document.getElementById('tempMaxGM').value) == false) {
                alert('ERROR: El campo temperatura máxima con valores no numéricos');
                C = false;
            }

            if (/^[-]?\d+$/.test(document.getElementById('tempMinGM').value) == false) {
                alert('ERROR: El campo temperatura mínima con valores no numéricos');
                C = false;
            }
            if (colectores[colectorUso2][1] == "1" || colectores[colectorUso2][1] == "2" || colectores[colectorUso2][1] == "3" || colectores[colectorUso2][1] == "4" || colectores[colectorUso2][1] == "5" || colectores[colectorUso2][1] == "7" || colectores[colectorUso2][1] == "8" || colectores[colectorUso2][1] == "11" || colectores[colectorUso2][1] == "14" || colectores[colectorUso2][1] == "15") {

                if (parseFloat(document.getElementById('tempMaxGM').value) &lt;= parseFloat(document.getElementById('tempMinGM').value)) {
                    alert('ERROR: La temperatura mínima no puede ser menor ni igual que la máxima');
                    C = false;
                }

                if (colectores[colectorUso2][1] == "1" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 120 || parseFloat(document.getElementById('tempMinGM').value) &lt; 30)) {
                    alert('ERROR: La temperatura del servicio calor técnico debe ser menor que 120 y mayor que 30 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "2" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 120 || parseFloat(document.getElementById('tempMinGM').value) &lt; 60)) {
                    alert('ERROR: La temperatura del servicio cal. alta debe ser menor que 120 y mayor que 60 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "3" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 90 || parseFloat(document.getElementById('tempMinGM').value) &lt; 30)) {
                    alert('ERROR: La temperatura del servicio cal. media debe ser menor que 90 y mayor que 30 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "4" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 50 || parseFloat(document.getElementById('tempMinGM').value) &lt; 30)) {
                    alert('ERROR: La temperatura del servicio condensación debe ser menor que 50 y mayor que 30 ');
                    C = false;
                }

                if (colectores[colectorUso2][1] == "7" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 20 || parseFloat(document.getElementById('tempMinGM').value) &lt; 0)) {
                    alert('ERROR: La temperatura del servicio frío climatización debe ser menor que 20 y mayor que 0 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "8" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 0 || parseFloat(document.getElementById('tempMinGM').value) &lt; -30)) {
                    alert('ERROR: La temperatura del servicio frío subcero debe ser menor que 0 y mayor que -30 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "11" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 90 || parseFloat(document.getElementById('tempMinGM').value) &lt; 30)) {
                    alert('ERROR: La temperatura del servicio ACS debe ser menor que 90 y mayor que 30 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "17" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 40 || parseFloat(document.getElementById('tempMinGM').value) &lt; 25)) {
                    alert('ERROR: La temperatura del servicio calor técnico debe ser menor que 40 y mayor que 25 ');
                    C = false;
                }
                if (colectores[colectorUso2][1] == "18" &amp;&amp; (parseFloat(document.getElementById('tempMaxGM').value) > 35 || parseFloat(document.getElementById('tempMinGM').value) &lt; 15)) {
                    alert('ERROR: La temperatura del servicio calor técnico debe ser menor que 35 y mayor que 15 ');
                    C = false;
                }

            }
            if (C == true) {
                colectores[colectorUso2][3] = document.getElementById('tempMinGM').value;
                colectores[colectorUso2][2] = document.getElementById('tempMaxGM').value;
                switch (parseInt(colectores[colectorUso2][1])) {
                    case 1:
                    case 2:
                    case 3:
                    case 4:
                    case 14:
                        colectores[colectorUso2][4] = document.getElementById('porConC').value;
                        break;
                    case 7:
                    case 8:
                    case 15:
                        colectores[colectorUso2][5] = document.getElementById('porConF').value;
                        break;
                    case 11:
                        colectores[colectorUso2][6] = document.getElementById('porConACS').value;
                        break;
                    case 5:
                        colectores[colectorUso2][4] = document.getElementById('porConC').value;
                        colectores[colectorUso2][5] = document.getElementById('porConF').value;
                        colectores[colectorUso2][6] = document.getElementById('porConACS').value;
                        break;
                }
                $('#myModalCaracteristicas').modal('hide');

            }
        }
        /**

            *Cargamos todos los valores de la base de datos
            * @param  {string}
            * @return  {void}

            */
        cargartodoBD = async function (nombrecaso) {
            if (nombrecaso != undefined)
            idCaso = nombrecaso.toString();
            await obtenerdatosedificio();
            var arrayidcalendario = Object.values(objedificiosel.idcalendario)
            await cargabasedatosVEavanzado();
            $http.post('bd_relacionCasoUuff.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                $scope.ufCaso = data;
                ADufcaso = data;

            });
            ADgeometria = $http.post('geometria.php', { 'idcaso': idCaso, 'base':1 });
            $scope.diastipocaso = $http.post('diasTipoCaso.php', { 'id_caso': idCaso, 'base':1 });
            $scope.valoreshorarioscaso = $http.post('valoresHorarioCaso.php', { 'idcaso': idCaso, 'base':1 });
            $scope.variacionEstacional = $http.post('variacionEstacional.php', { 'idcaso': idCaso, 'base':1 });
            $scope.calendario = $http.post('calendarios.php', { 'idcaso': idCaso, 'base':1 });
            $scope.detallesCalendario = $http.post('detallesCalendario.php', { 'idcalendario': arrayidcalendario,'base':1  });
            ADpiscina = $http.post('appPidim/Componentes/Piscinas/Piscinas.php', { 'idcaso': idCaso,'action':'cargar' });
            $scope.vehiculoElectrico = $http.post('appPidim/Componentes/VehiculoElectrico/VehiculoElectrico.php', { 'action':'cargar', 'idcaso': idCaso, });
            $scope.contador = $http.post('contador.php', { 'idcaso': idCaso,'base':1  });
            $scope.consumo = $http.post('consumoContador.php',{'base':1 });
            $scope.equipo = $http.post('equipos.php', { 'idcaso': idCaso, 'base':1 });
            $scope.busesCaso = $http.post('busesCaso.php', { 'idcaso': idCaso, 'nuex': "Existente",'base':1  });
            $scope.caso = $http.post('casos.php', { 'idusuario': usuario, 'base':1 });
            $scope.camposolarcaso = $http.post("CampoSolar.php", { 'action': "cargar", 'id': idCaso, });
            $scope.bombacaloraireagua = $http.post('selectoresServicios32.php');
            $scope.bombacaloraguaagua = $http.post('selectoresServicios33.php');
            $scope.enfriadorarecuperacion = $http.post('selectoresServicios34.php');
            await $q.all([ADgeometria, $scope.diastipocaso, $scope.valoreshorarioscaso, $scope.variacionEstacional, $scope.calendario, $scope.detallesCalendario, ADpiscina, $scope.vehiculoElectrico, $scope.contador, $scope.consumo, $scope.equipo, $scope.busesCaso, $scope.caso, $scope.camposolarcaso, $scope.bombacaloraireagua, $scope.bombacaloraguaagua, $scope.enfriadorarecuperacion])
                .then(function (data) {
                    ADgeometria = data[0].data; ADgeometria = data[0].data;
                    $scope.diastipocaso = data[1].data; ADdiastipocaso = data[1].data;
                    $scope.valoreshorarioscaso = data[2].data; ADvaloreshorarioscaso = data[2].data;
                    $scope.variacionEstacional = data[3].data; ADvariacionestacional = data[3].data;
                    $scope.calendario = data[4].data; ADcalendario = data[4].data;
                    $scope.detallesCalendario = data[5].data;ADdetallescalendario = data[5].data;
                    ADpiscina = data[6].data;
                    $scope.vehiculoElectrico = data[7].data; ADVE = data[7].data;
                    $scope.contador = data[8].data; ADcontador = data[8].data;
                    $scope.consumo = data[9].data;ADconsumo = data[9].data;
                    $scope.equipo = data[10].data; ADequipos = data[10].data;
                    $scope.busesCaso = data[11].data; ADbusescasos = data[11].data;
                    $scope.caso = data[12].data; ADcaso = data[12].data;
                    $scope.camposolarcaso = data[13].data; ADcamposolar = data[13].data;
                    $scope.bombacaloraireagua = data[14].data;
                    $scope.bombacaloraguaagua = data[15].data;
                    $scope.enfriadorarecuperacion = data[16].data;
                })
                .catch(function (error) {
                    alert('Se ha encontrado el siguiente error:\r\n  ' + error.status + ' ' + error.data + '\n : ' + error.data + '');
                    return OcultarSpinner();
                })
        }
        /**

            *Cambiamos algunos nombres de provincia con repsecto a los que están en la base de datos
            * @param  {string}
            * @return  {void}

            */
        provinciascdcyr = function (provincia) {
            switch (provincia) {
                case "Vizcaya":
                    provincia = "Bilbao"
                    break;
                case "Castellón de la Plana/Castelló de la Plana":
                    provincia = "Castellón";
                    break;
                case "Girona":
                    provincia = "Gerona";
                    break;
                case "Jaén":
                    provincia = "Jaen";
                    break;
                case "Coruña, A":
                    provincia = "La Coruña";
                    break;
                case "Gran Canaria":
                    provincia = "Las Palmas";
                    break;
                case "Lleida":
                    provincia = "Lérida";
                    break;
                case "La Rioja":
                    provincia = "Logroño";
                    break;
                case "Ourense":
                    provincia = "Orense";
                    break;
                case "Asturias":
                    provincia = "Oviedo";
                    break;
                case "Islas Baleares":
                    provincia = "Palma de Malorca";
                    break;
                case "Navarra":
                    provincia = "Pamplona";
                    break;
                case "Guipúzcoa":
                    provincia = "San Sebastián";
                    break;
                case "Cantabria":
                    provincia = "Santander";
                    break;
                case "Álava":
                    provincia = "Vitoria";
                    break;
            }
            return provincia;
        }
        /**

            *Almacenamos los datos del caso y enviamos la orden de cálculo
            * @return  {void}

            */
        calcularCaso = async function () {
            await cargartodoBD();
            Hdemandas.CalculoDemandas();
            Hborrardatos.BorrarDemandas();
        }
        /**

            *Eliminamos la sección actual del programa
            * @return  {void}

            */
        vaciarcontenido = function () {
            document.getElementById("imagenes").style.display = "flex";
            contenido.innerHTML = "";
            esquema.innerHTML = "";
            document.getElementById('menu').style.display = "none";
            document.getElementById('capturar').style.display = "none";
            menu.innerHTML = "";
            lineas.innerHTML = "";
            $('#herramientas button').removeClass("bordeAzul");
        }
        /**

            *Calculamos las alternativas
            * @param  {string}
            * @return  {void}

            */
        diccionarioTipoNombre = function (str) {
            var res;
            switch (str) {
                case "SolarPlana":
                case "SolarTubosVacio":
                    res = "SolarTermica";
                    break;
                case "AbsorcionSimple":
                case "AbsorcionDoble":
                case "AbsorcionMultienergia":
                case "AdsorcionSilicaGel":
                case "AdsorcionZeolita":
                case "GAHPaire":
                case "GAHPterreno":
                case "GAHPagua":
                    res = "AbsorcionSimple";
                    break;
                case "CalderasBT":
                case "CalderasCondensacion":
                case "CalderasBiomasa":
                    res = "Caldera";
                    break
                case "ex_calderas":
                case "ex_solartermica":
                case "ex_bombadecalor":
                case "ex_enfriadora":
                case "ex_interacumuladorelectrico":
                case "ex_autonomofrio":
                case "ex_autonomocalor":
                case "ex_calderacondensacion":
                case "ex_calderabiomasa":
                case "ex_bdcaireagua":
                case "ex_bdcaguaagua":
                case "ex_perecuperacion":
                case "ex_stcaptadorplano":
                case "ex_sttubosvacio": 
                case "ex_mase":
                    res = "RendimientoConstante";
                    break;
                case "BCgas":
                case "BCgasHidronico":
                case "bombacaloraguaagua":
                case "bombacaloraireagua":
                case "enfriadorarecuperacion":

                    res = "BombaCalor";
                    break;
                case "Almacenamiento sensible":
                case "Acumulación ACS":
                    res = "AlmacenamientoSensible";
                    break;
                case "Intercambiador de calor":
                    res = "Intercambiadores";
                    break;
                case "Acumulación solar":
                    res = "AlmacenamientoSolar";
                    break;
                case "1":
                case "2":
                case "3":
                case "4":
                case "5":
                case "15":
                case "17":
                    res = "Calor";
                    break;
                case "7":
                case "17":
                case "8":
                case "18":
                    res = "Frio";
                    break;
                case "16":
                    res = "ACS";
                    break;
            }
            return res;
        }
        /**

            *Calculamos las alternativas
            * @param  {string}
            * @return  {void}

            */
        diccionarioTipoIndice = function (str) {
            var res;
            switch (str) {
                case "AbsorcionSimple":
                case "AlmacenamientoSensible":
                case "ACS":
                    res = 0;
                    break;
                case "BombaCalor":
                case "AlmacenamientoSolar":
                case "Calor":
                    res = 1;
                    break;
                case "Caldera":
                case "Intercambiadores":
                case "Frio":
                    res = 2;
                    break;
                case "RendimientoConstante":
                    res = 3;
                    break;
                case "SolarTermica":
                    res = 4;
                    break;
                case "AlmacenamientoSensible":
            }
            return res;
        }
        /**

            *Calculamos las equipos de la alternativas
            * @param  {string}
            * @return  {void}

            */
        equiposalternativas = function (equipo) {
            var arrayequipos =
                [
                    "[EQUIPO=AbsorcionSimple]",
                    "[EQUIPO=BombaCalor]",
                    "[EQUIPO=Caldera]",
                    "[EQUIPO=RendimientoConstante]",
                    "[EQUIPO=SolarTermica]",
                ]
            var nombreArrayEquipo = diccionarioTipoNombre(equipo.tipoequipo.trim());
            var indiceArrayEquipo = diccionarioTipoIndice(nombreArrayEquipo);
            return arrayequipos[indiceArrayEquipo];
        }
        /**

            *Calculamos los servicios alternativas
            * @param  {string}
            * @return  {void}

            */
        serviciosalternativas = function (servicio) {
            var arrayservicios =
                [
                    "[SERVICIO=ACS]",
                    "[SERVICIO=Calor]",
                    "[SERVICIO=Frio]",
                ]
            var nombreArrayServicio = diccionarioTipoNombre(servicio);
            var indiceArrayServicio = diccionarioTipoIndice(nombreArrayServicio);
            return arrayservicios[indiceArrayServicio];
        }
        /**

            *Calculamos los complementos alternativas
            * @param  {string}
            * @return  {void}

            */
        complementosalternativas = function (complemento) {
            var arraycomplementos =
                [
                    "[COMPLEMENTO=AlmacenamientoSensible]",
                    "[COMPLEMENTO=AlmacenamientoSolar]",
                    "[COMPLEMENTO=Intercambiadores]",
                ]
            var nombreArrayComplemento = diccionarioTipoNombre(complemento.nombre);
            var indiceArrayComplemento = diccionarioTipoIndice(nombreArrayComplemento);
            return arraycomplementos[indiceArrayComplemento];
        }
        /**

            *Cargamos los archivos meteorológicos por provincia

            * @return  {void}

            */
        diccionarioMeteorologia = function (str) {
            switch (str) {
                case "Almería":
                    res = "almeria.met";
                    break;
                case "Cádiz":
                    res = "cadiz.met";
                    break;
                case "Córdoba":
                    res = "cordoba.met";
                    break;
                case "Granada":
                    res = "granada.met";
                    break;
                case "Huelva":
                    res = "huelva.met";
                    break;
                case "Jaén":
                    res = "jaen.met";
                    break;
                case "Málaga":
                    res = "malaga.met";
                    break;
                case "Sevilla":
                    res = "sevilla.met";
                    break;
                case "Huesca":
                    res = "huesca.met";
                    break;
                case "Teruel":
                    res = "teruel.met";
                    break;
                case "Zaragoza":
                    res = "zaragoza.met";
                    break;
                case "Asturias":
                    res = "oviedo.met";
                    break;
                case "Islas Baleares":
                    res = "palma.met";
                    break;
                case "Gran Canaria":
                    res = "laspalma.met";
                    break;
                case "Tenerife":
                    res = "tenerife.met";
                    break;
                case "Cantabria":
                    res = "santand.met";
                    break;
                case "Ávila":
                    res = "avila.met";
                    break;
                case "Burgos":
                    res = "burgos.met";
                    break;
                case "León":
                    res = "leon.met";
                    break;
                case "Palencia":
                    res = "palencia.met";
                    break;
                case "Salamanca":
                    res = "salamanc.met";
                    break;
                case "Segovia":
                    res = "segovia.met";
                    break;
                case "Soria":
                    res = "soria.met";
                    break;
                case "Valladolid":
                    res = "valladol.met";
                    break;
                case "Zamora":
                    res = "zamora.met";
                    break;
                case "Albacete":
                    res = "albacete.met";
                    break;
                case "Ciudad Real":
                    res = "cd_real.met";
                    break;
                case "Cuenca":
                    res = "cuenca.met";
                    break;
                case "Guadalajara":
                    res = "guadalaj.met";
                    break;
                case "Toledo":
                    res = "toledo.met";
                    break;
                case "Barcelona":
                    res = "barcelon.met";
                    break;
                case "Girona":
                    res = "gerona.met";
                    break;
                case "Lleida":
                    res = "lleida.met";
                    break;
                case "Tarragona":
                    res = "tortosa.met";
                    break;
                case "Alicante/Alacant":
                    res = "alicante.met";
                    break;
                case "Castellón de la Plana/Castelló de la Plana":
                    res = "castello.met";
                    break;
                case "Valencia":
                    res = "valencia.met";
                    break;
                case "Badajoz":
                    res = "badajoz.met";
                    break;
                case "Cáceres":
                    res = "caceres.met";
                    break;
                case "Coruña, A":
                    res = "lacoruna.met";
                    break;
                case "Lugo":
                    res = "lugo.met";
                    break;
                case "Ourense":
                    res = "orense.met";
                    break;
                case "Pontevedra":
                    res = "ponteved.met";
                    break;
                case "Madrid":
                    res = "madrid.met";
                    break;
                case "Murcia":
                    res = "s_javier.met";
                    break;
                case "Navarra":
                    res = "pamplona.met";
                    break;
                case "Álava":
                    res = "vitoria.met";
                    break;
                case "Guipúzcoa":
                    res = "s_sebast.met";
                    break;
                case "Vizcaya":
                    res = "bilbao.met";
                    break;
                case "La Rioja":
                    res = "logrono.met";
                    break;
                case "Ceuta":
                    res = "ceuta.met";
                    break;
                case "Melilla":
                    res = "melilla.met";
                    break;
            }
            return res;
        }
        /**

            *Calculamos el consumo

            * @return  {void}

            */
        CalcularConsumo = function () {
            function activartodas() {
                var oEvento = event || window.event;
                var target = oEvento.target;
                if (target.checked == true) {
                    var agrupacionactual;
                    var tipoactual;
                    var arraytipos = new Array();
                    //Selecciona los casos paramétricos a calcular
                    var agrupaciones = $('#bodyvariables >table >tbody > tr td:first-child');
                    for (var contagrupacion = 0; contagrupacion &lt; agrupaciones.length; contagrupacion++) {
                        tipoactual = $('#bodyvariables >table >tbody > tr:eq(' + contagrupacion + ') td:eq(1) input')
                        etiquetatipoactual = $('#bodyvariables >table >tbody > tr:eq(' + contagrupacion + ') td:eq(1) #etiquetatipo')
                        agrupacionactual = new VariablesConsumoSel();
                        arraytipos = [];
                        agrupacionactual.nombreagrupacion = agrupaciones[contagrupacion].innerText.trim().toUpperCase();
                        for (var conttipo = 0; conttipo &lt; tipoactual.length; conttipo++)
                            tipoactual[conttipo].checked = true
                    }
                }
                else {
                    var agrupacionactual;
                    var tipoactual;
                    var arraytipos = new Array();
                    var agrupaciones = $('#bodyvariables >table >tbody > tr td:first-child');
                    for (var contagrupacion = 0; contagrupacion &lt; agrupaciones.length; contagrupacion++) {
                        tipoactual = $('#bodyvariables >table >tbody > tr:eq(' + contagrupacion + ') td:eq(1) input')
                        etiquetatipoactual = $('#bodyvariables >table >tbody > tr:eq(' + contagrupacion + ') td:eq(1) #etiquetatipo')
                        agrupacionactual = new VariablesConsumoSel();
                        arraytipos = [];
                        agrupacionactual.nombreagrupacion = agrupaciones[contagrupacion].innerText.trim().toUpperCase();
                        for (var conttipo = 0; conttipo &lt; tipoactual.length; conttipo++)
                            tipoactual[conttipo].checked = false
                    }
                }
            }
            var activa = 1;
            if ( casosParametricosaCalcularManuel.length == 1)
            {
                $('#myModalCparametrico').on('hidden.bs.modal', function () {
                    if (activa == 1)
                    $('#myModalcalculoconsumo').modal('show')
                    activa = 0;
                })
            }
            else
                $('#myModalcalculoconsumo').modal('show')
            Todas.addEventListener('change', activartodas);
        }
         /**

            *Reemplazamos ciertos valores

            * @return  {void}

            */
        pp = function (numero)
        {
            if (typeof numero === 'string')
            {
                numero = numero.replace(/,/g, '.');
                if (numero.includes("E-") || numero.includes("e-"))
                    numero = parseFloat(numero);
            }
            return numero;
        } 
        /**

            *Cargamos los casos paramétricos

            * @return  {void}

            */
        cargarCasosP =  function() {
        var todoCorrecto=true;
        for(var x=0;x&lt;$scope.equipo.length;x++){
            //Si los equipo no están todos definidos cancela
            if ($scope.equipo[x].definido == "no" &amp;&amp; $scope.equipo[x].nuex == "Nuevo" &amp;&amp; $scope.equipo[x].tipo != "2") {
            alert("ERROR: Alguno de los equipos de la nueva instalación no están definidos");
                todoCorrecto = false;
                break;
            }
        }
            if (todoCorrecto == true){
                //Cargamos la tabla con los datos
            casosParametricosaCalcularManuel = [];
            vaciarcontenido();
            MostrarSpinner('notime');
            if($scope.combinacionesparametrico.length == 0)
            Hparametrico.LoadTable().then(function(val) {
                $scope.combinacionesparametrico = val;
                if ($scope.combinacionesparametrico.length != 0)
                {
                    $scope.$digest();
                    OcultarSpinner();
                    $('#myModalCparametrico').modal('show');
                    Hparametrico.PrintTable();
                    $scope.totalcheckboxcont = 0;
                    for (var c = 0; c &lt; $('#tablaparametrico input').length ; c++)  
                    {
                        if ($('#tablaparametrico input')[c].checked == true)
                        $scope.totalcheckboxcont++;
                    }
                }
                else
                {
                    OcultarSpinner()
                    CalcularConsumo();
                }
              });
          else 
          {
            OcultarSpinner();
            $('#myModalCparametrico').modal('show');
            Hparametrico.PrintTable();
            $scope.totalcheckboxcont = 0;
            for (var c = 0; c &lt; $('#tablaparametrico input').length ; c++)  
            {
                if ($('#tablaparametrico input')[c].checked == true)
                $scope.totalcheckboxcont++;
            }
            $scope.$digest();
          }
            return;
        }
       
        }
        /**

            *Guardamos los casos paramétricos seleccionados

            * @return  {void}

            */
        guardarCasosP = function () {
            casosParametricosaCalcular = [];
            casosParametricosaCalcularManuel = [];
            equiposParam = [];
            if (combinacionesparametrico.length == 0)
                combinacionesparametrico = $scope.combinacionesparametrico;
            if (combinacionesparametrico.length == 0) {
                alert('Hay un problema con las combinaciones de equipos, por favor vuelva a definir la Nueva Instalación.')
                return;
            }
            //Calcula todas las combinaciones de parámetricos posible
            for (var x = 0; x &lt; combinacionesparametrico.length; x++) {
                if (document.getElementById("casoParametrico" + (x + 1)).checked == true) {
                    equiposParam.push((x + 1));
                    casosParametricosaCalcular.push(combinaciones[x]);
                    casosParametricosaCalcularManuel.push(combinacionesparametrico[x]);
                }
            }
            //Cargamos 10 casos como máximo
            if (casosParametricosaCalcularManuel.length &lt; 11 &amp;&amp; casosParametricosaCalcularManuel.length > 0) {
                $http.post("selparametrico.php", { 'idcaso': idCaso, 'datos': 'none', 'action': 'borrar', 'type': 'none', 'equipos': 'none' })
                    .success(function () {
                        let arrout = [];
                        for (var c = 0; c &lt; casosParametricosaCalcularManuel.length; c++) {
                            let jsonsel = {};
                            jsonsel = JSON.stringify(casosParametricosaCalcularManuel[c]);
                            arrout.push(jsonsel);
                        }
                        $http.post("selparametrico.php", { 'idcaso': idCaso, 'datos': equiposParam, 'equipos': arrout, 'action': 'insert', 'type': 'none' })
                    })
                $('#myModalCparametrico').modal('hide');
                if (casosParametricosaCalcularManuel.length > 1)
                    updateAlternativas();
                else
                    CalcularConsumo();
            } else {
                alert("ERROR: El número de elementos seleccionados debe ser entre 1 y 10");
            }
        }
        /**

            *Calculamos las alternativas

            * @return  {void}

            */
        updateAlternativas = async function (variablesconsumo) {
            var errorsaltarim = 0;
            await    $http.post("CheckErrorArchivo.php", { 'md5': nombremd5, 'tipoarchivo': 'SALTARIM' }).error(function (data) 
        {
            alert (data);
            errorsaltarim = 1;
        });
        if (errorsaltarim == 1)
        return;
            await cargartodoBD();
            $http.post("CheckErrorArchivo.php", { 'md5': nombremd5, 'tipoarchivo': 'entedim' }).success(function () {
                vaciarcontenido();
                $('#myModalcalculoconsumo').modal('hide');
                MostrarSpinner();
                var parametrizados = 0;
                var priCalor = [[1,"1"], [1,"2"], [1,"33"],[1, "32"], [1,"27"], [1,"28"], [1,"29"], [4], [3]];
                var priFrio = [[1,"5"],[1,"34"],[1, "33"],[1, "32"],  [3], [4]];
                var textoEquipos = '';
                var numColectores = 0;
                var contEquipos = 1;
                var TCA = '\r\n[COLECTORES ACTIVOS]\r\n'; // Texto Colectores activos
                var TRD = '';
                var TRDeq = '';
                var TRDC = '[RESULTADOS DETALLADOS]\r\n';
                var TCcabecera = '\r\n[COLECTOR=numero]\r\n';
                var TC = ""; //texto colector
                var TLOC = ""; //texto localidad.
                var TLEY = ""; //texto leyes de control
                var tipoequipo;
                var numcasosParametricos= new Array();
                var tipocomplemento;
                var tiposervicio;
                var leyesCalor = new Array();
                var leyesFrio = new Array();
                var leyesDiferencial = new Array();
                var ley = new Array();
                var nombreservicio
                var contadorequipos;
                var localidad;
                var meteorologia;
                var texto;
                var arrayequipos = new Array();
                var rutaserviciofrio = 'C:\\ProgramasTMT\\GasNatural\\PIDIM\\AlmacenCasos\\CASOSTERMINADOS\\' + nombremd5 + '.DEM_REF \r\n';
                var rutaserviciocalor = 'C:\\ProgramasTMT\\GasNatural\\PIDIM\\AlmacenCasos\\CASOSTERMINADOS\\' + nombremd5 + '.DEM_CAL \r\n';
                var rutaservicioacs1 = 'C:\\ProgramasTMT\\GasNatural\\PIDIM\\AlmacenCasos\\CASOSTERMINADOS\\' + nombremd5 + '.DEM_ACS1 \r\n';
                var rutaservicioacs2 = 'C:\\ProgramasTMT\\GasNatural\\PIDIM\\AlmacenCasos\\CASOSTERMINADOS\\' + nombremd5 + '.DEM_ACS2 \r\n';
                var colectorleido;
                var colectoractual;
                var colectorreferencia;
                var servicioreferencia;
                var colectores = [];
                var samplecolectores = [];
                var sampleequipos = [];
                var samplecomplementos = [];
                var sampleservicios = [];
                var equipoactual;
                var complementoactual;
                var servicioactual;
                var numbus;
                var samplebusg;
                var samplebusa;
                var media = false;
                var conden = false;
                var servacs = false;
                var contEquiposCasos=0;
                var textoEquipos3 = '(';
                var textoEquipos4 = '(';
                var textoEquipos5 = '(';
                var textoEquipos6 = '(';
                var textoEquipos7 = '(';
                var textoEquipos8 = '(';
                var textoEquipos9 = '(';
                var textoEquipos10 = '(';
                var textoEquipos11 = '(';
                var textoEquipos12 = '(';
                var textoEquipos13 = '(';
                var textoEquipos14 = '(';
                var textoEquipos15 = '(';
                var textoEquipos16 = '(';
                var textoEquipos17 = '(';
                var textoEquipos18 = '(';
                var textoEquipos19 = '(';
                var textoEquipos20 = '(';
                var textoEquipos21 = '(';
                var textoEquipos22 = '(';
                var textoEquipos23 = '(';
                var textoEquipos24 = '(';
                var textoEquipos25 = '(';
                var textoEquipos26 = '(';
                var textoEquipos27 = '(';
                var textoEquipos28 = '(';
                var textoEquipos29 = '(';
                var textoEquipos30 = '(';
                var textoEquipos31 = '(';
                var textoEquipos32 = '(';
                var textoEquipos33 = '(';
                var textoEquipos34 = '(';
                var textoEquipos35 = '(';
                var textoEquipos36 = '(';
                var textoEquipos37 = '(';
                var textoEquipos38 = '(';
                var textoEquipos39 = '(';
                var textoEquipos40 = '(';
                var textoEquipos41 = '(';
                var textoEquipos42 = '(';
                var textoEquipos43 = '(';
                var textoEquipos44 = '(';
                var textoEquipos45 = '(';
                var textoEquipos46 = '(';
                var textoEquipos36 = '(';
                var textoEquipos47 = '(';
                var textoEquipos48 = '(';
                var textoEquipos49 = '(';
                var textoEquipos50 = '(';
                var textoEquipos51 = '(';
                var textoEquipos52 = '(';
                var textoEquipos53 = '(';
                var textoEquipos54 = '(';
                var textoEquipos55 = '(';
                var textoEquipos56 = '(';
                var textoEquipos57 = '(';
                var PARAMETRICO='';
                var temperatura = new Array();
                var temperaturas = new Array();
                var arraycomplementos = [];
                var nombrequiporepetido = [];
                var nombrecomplementorepetido = [];
                var leyactual;
                var oLeyes = new Ley();
                var variableactual;
                var Aleyesdecontrol = new Array();
                var tempfGm = "";
                var tempfAm = "";
                var tempfGM = "";
                var tempfAM = "";
                var busgf = "-";
                var busaf = "-";
                var porC = 0.0;
                var porF = 0.0;
                var porACS = 0.0;
                var serfan = 0;
                var hayCM=false;
                var hayACS = false;

                bdlEquipos = function(hayfantasma){
                    for (var x = 0; x &lt; $scope.equipo.length; x++) {
                        if ($scope.equipo[x].nuex == "Nuevo") {
                            numColectores = 0;
                            var busGenera = 0;
                            var busAlimenta = 0;
                            //Sacamos la temepratura del colector asignado a cada equipo
                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp;
                                    "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                    tempbusamin = parseFloat($scope.busesCaso[y].tempmin);
                                    tempbusamax = parseFloat($scope.busesCaso[y].tempmax);
                                    busAlimenta = $scope.busesCaso[y].idbus;
                                    
                                }
                                if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp;
                                    "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                    tempbusgmin = parseFloat($scope.busesCaso[y].tempmin);
                                    tempbusgmax = parseFloat($scope.busesCaso[y].tempmax);
                                    busGenera = $scope.busesCaso[y].idbus;
                                    
                                }
                                if ($scope.busesCaso[y].idbus=="3"){
                                    hayCM=true;
                            }

                                if ($scope.busesCaso[y].idbus == "11") {
                                    hayACS = true;
                                }
                                }
                            if (hayCM == true &amp;&amp; hayACS == true &amp;&amp; busAlimenta=="3") {
                                tempbusamin += 5;
                                tempbusamax += 5;
                            }

                            if (hayCM == true &amp;&amp; hayACS == true &amp;&amp; busGenera == "3") {
                                tempbusgmin += 5;
                                tempbusgmax += 5;
                            }
                            /*Sacamos los atributos necesarios
                            El proceso es para cada tipo de equipo sacamos los atributos que necesita el programa de cálculo
                            Para los equipos existentes*/
                            if ($scope.equipo[x].tipo == "4") {
                                var textoEquipos2 = "";
                                if (($scope.equipo[x].nombre == "Bomba de calor aire-agua" || $scope.equipo[x].nombre == "Bomba de calor agua-agua"  || $scope.equipo[x].nombre == "Bomba de Calor" || $scope.equipo[x].nombre == "Planta enfriadora con recuperación") &amp;&amp; $scope.equipo[x].busg != "-" &amp;&amp; $scope.equipo[x].busa != "-" ) {
                                    textoEquipos += '[EQUIPO=RendimientoConstante]\r\n';
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo;// MMR : ESTO  LO TIENES QUE HACER EN CADA EQUIPO PARA PASARME LA LEY
                                    ley.push($scope.equipo[x].nombreequipo);
                                    textoEquipos += '       10 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' 1 //Nombre del equipo\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busg + ' //Nombre del colector\r\n';
                                    
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' //Numero_Equipos_Iguales \r\n';
                                    if ($scope.equipo[x].tipoequipo == "ex_enfriadora") {
                                        textoEquipos += '       GAS NATURAL //Combustible \r\n';
                                    } else {
                                        textoEquipos += '       ELECTRICIDAD //Combustible \r\n';
                                    }
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr1) + ' //Potencia_Util_kW de cada equipo\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Rendimiento_100 \r\n';
                                    textoEquipos += '       5 //Diferencia de Temperatura para cálculo de flujo másico \r\n';

                                    if (busGenera != "7" &amp;&amp; busGenera != "8" &amp;&amp; busGenera != "18") {
                                            textoEquipos += '       ' + parseFloat(tempbusgmax) + ' //Temperatura de consigna \r\n';
                                        } else {
                                            textoEquipos += '       ' + parseFloat(tempbusgmin) + ' //Temperatura de consigna \r\n';
                                        }
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusgmax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusgmax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        if (tempbusgmax > 20) {
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(tempbusgmax);
                                            ley.push(tempbusgmin);
                                        ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesCalor.push(ley);
                                            ley = [];
                                        } else {
                                            ley.push("ACTIVACION-FRIO");
                                            ley.push(tempbusgmax);
                                            ley.push(tempbusgmin);
                                        ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesFrio.push(ley);
                                            ley = [];
                                        }
                                        oLeyes.aLeyes.push('L' + contEquipos); // MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                    
                                    


                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';
                                    textoEquipos += '       \r\n';
                                    contEquipos++;

                                    textoEquipos += '[EQUIPO=RendimientoConstante]\r\n';
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo;// MMR : ESTO  LO TIENES QUE HACER EN CADA EQUIPO PARA PASARME LA LEY
                                    ley.push($scope.equipo[x].nombreequipo);
                                    textoEquipos += '       10 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' 2 //Nombre del equipo\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' //Numero_Equipos_Iguales \r\n';
                                    if ($scope.equipo[x].tipoequipo == "ex_enfriadora") {
                                        textoEquipos += '       GAS NATURAL //Combustible \r\n';
                                    } else {
                                        textoEquipos += '       ELECTRICIDAD //Combustible \r\n';
                                    }
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr1) + ' //Potencia_Util_kW de cada equipo\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Rendimiento_100 \r\n';
                                    textoEquipos += '       5 //Diferencia de Temperatura para cálculo de flujo másico \r\n';
                                    if (busAlimenta != "7" &amp;&amp; busAlimenta != "8" &amp;&amp; busGenera != "18") {
                                            textoEquipos += '       ' + parseFloat(tempbusamax) + ' //Temperatura de consigna \r\n';
                                        } else {
                                            textoEquipos += '       ' + parseFloat(tempbusamin) + ' //Temperatura de consigna \r\n';
                                        }
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusamax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusamax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        if (tempbusamax > 20) {
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(tempbusamax);
                                            ley.push(tempbusamin);
                                        ley.push($scope.equipo[x].busa);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesCalor.push(ley);
                                            ley = [];
                                        } else {
                                            ley.push("ACTIVACION-FRIO");
                                            ley.push(tempbusamax);
                                            ley.push(tempbusamin);
                                        ley.push($scope.equipo[x].busa);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesFrio.push(ley);
                                            ley = [];
                                        }
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';
                                    textoEquipos += '       \r\n';
                                    contEquipos++;
                                
                                } 
                                else {
                                    textoEquipos += '[EQUIPO=RendimientoConstante]\r\n';
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo;// MMR : ESTO  LO TIENES QUE HACER EN CADA EQUIPO PARA PASARME LA LEY
                                    ley.push($scope.equipo[x].nombreequipo);
                                    textoEquipos += '       10 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del equipo\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';

                                    if ($scope.equipo[x].busg != "-" &amp;&amp; busGenera != "12" &amp;&amp; busGenera != "13" &amp;&amp; busGenera != "9") {
                                        textoEquipos += '       ' + $scope.equipo[x].busg + ' //Nombre del colector\r\n';
                                    } else {
                                        textoEquipos += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                    }
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' //Numero_Equipos_Iguales \r\n';
                                    if ($scope.equipo[x].tipoequipo == "ex_enfriadora") {
                                        textoEquipos += '       GAS NATURAL //Combustible \r\n';
                                    } else {
                                        textoEquipos += '       ELECTRICIDAD //Combustible \r\n';
                                    }
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr1) + ' //Potencia_Util_kW de cada equipo\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Rendimiento_100 \r\n';
                                    textoEquipos += '       5 //Diferencia de Temperatura para cálculo de flujo másico \r\n';
                                    
                                    if ($scope.equipo[x].busg != "-" &amp;&amp; busGenera != "12" &amp;&amp; busGenera != "0" &amp;&amp; busGenera != "13" &amp;&amp;  busGenera != "9") {
                                        if (busGenera != "7" &amp;&amp; busGenera != "8" &amp;&amp; busGenera != "15" &amp;&amp; $scope.equipo[x].nombre != "Máquina absorción simple efecto") {
                                            textoEquipos += '       ' + parseFloat(tempbusgmax) + ' //Temperatura de consigna \r\n';
                                        } else {
                                            textoEquipos += '       ' + parseFloat(tempbusgmin) + ' //Temperatura de consigna \r\n';
                                        }
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusgmax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusgmax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        if (tempbusgmax > 20) {
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(tempbusgmax);
                                            ley.push(tempbusgmin);
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesCalor.push(ley);
                                            ley = [];
                                        } else {
                                            ley.push("ACTIVACION-FRIO");
                                            ley.push(tempbusgmax);
                                            ley.push(tempbusgmin);
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesFrio.push(ley);
                                            ley = [];
                                        }
                                        oLeyes.aLeyes.push('L' + contEquipos); // MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();

                                    } else {
                                        if (busAlimenta != "7" &amp;&amp; busAlimenta != "8" &amp;&amp; busAlimenta != "15" &amp;&amp; $scope.equipo[x].nombre != "Máquina absorción simple efecto") {
                                            textoEquipos += '       ' + parseFloat(tempbusamax) + ' //Temperatura de consigna \r\n';
                                        } else {
                                            textoEquipos += '       ' + parseFloat(tempbusamin) + ' //Temperatura de consigna \r\n';
                                        }
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusamax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusamax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        if (tempbusamax > 20) {
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(tempbusamax);
                                            ley.push(tempbusamin);
                                            ley.push($scope.equipo[x].busa);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesCalor.push(ley);
                                            ley = [];
                                        } else {
                                            ley.push("ACTIVACION-FRIO");
                                            ley.push(tempbusamax);
                                            ley.push(tempbusamin);
                                            ley.push($scope.equipo[x].busa);
                                            ley.push('L' + contEquipos);
                                            ley.push(4);
                                            ley.push(1);
                                            leyesFrio.push(ley);
                                            ley = [];
                                        }
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                    }


                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';
                                    textoEquipos += '       \r\n';
                                    contEquipos++; 
                            }
                            }
                            //Para los usos
                            else if ($scope.equipo[x].tipo == "2") {
                                var porConsumoC = 0.0;
                                var porConsumoF = 0.0;
                                var porConsumoACS = 0.0;
                                var idUso = "";
                                var nombre2 = "";


                                loop6:
                                for (var y = 0; y &lt; $scope.uso.length; y++) {
                                    nombre2 = $scope.uso[y].nombre;

                                    if ($scope.equipo[x].nombre == nombre2) {
                                        idUso = $scope.uso[y].id;
                                        break loop6;
                                    }
                                }
                                if (idUso == "1" || idUso == "15" || idUso == "2" || idUso == "4" || idUso == "17") {
                                    textoEquipos += '[SERVICIO=Calor]\r\n';
                                    textoEquipos += '6 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombre + ' ' + $scope.equipo[x].id + ' //Nombre del servicio o SERVICIO\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                    loop3:
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            if (hayfantasma == true &amp;&amp; idUso == "15"){
                                            textoEquipos += '       ' + (parseFloat($scope.busesCaso[y].tempmin) + 3.0) + ' //Temperatura máxima de suministro\r\n';
                                        } else {
                                                textoEquipos += '       ' + (parseFloat($scope.busesCaso[y].tempmin) - 2.0) + ' //Temperatura máxima de suministro\r\n';
                                        }
                                            if (parseFloat($scope.busesCaso[y].consumoc) > 1.0) {
                                                porConsumoC = parseFloat($scope.busesCaso[y].consumoc) / 100.0;
                                            } else if (porConsumoC &lt; 0.1) {
                                                porConsumoC = 0.01;
                                            } else {
                                                porConsumoC = parseFloat($scope.busesCaso[y].consumoc);
                                            }
                                            if (idUso == "5") {
                                                if (parseFloat($scope.busesCaso[y].consumof) > 1.0) {
                                                    porConsumoF = parseFloat($scope.busesCaso[y].consumof) / 100.0;

                                                } else if (porConsumoF &lt; 0.1) {
                                                    porConsumoF = 0.01;
                                                }
                                                else {
                                                    porConsumoF = parseFloat($scope.busesCaso[y].consumof);
                                                }
                                                if (parseFloat($scope.busesCaso[y].consumoacs) > 1.0) {
                                                    porConsumoACS = parseFloat($scope.busesCaso[y].consumoacs) / 100.0;

                                                } else if (porConsumoACS &lt; 0.1) {
                                                    porConsumoACS = 0.01;
                                                } else {
                                                    porConsumoACS = parseFloat($scope.busesCaso[y].consumoacs);
                                                }
                                            }
                                            break loop3;
                                        }
                                    }
                                    textoEquipos += '       ' + rutaserviciocalor;
                                    textoEquipos += '       ' + porConsumoC + ' //Fracción de la demanda de calor que debe ser cubierta con este servicio\r\n';
                                    if (idUso == "5") {
                                        textoEquipos += '       ' + porConsumoF + ' //Fracción de la demanda de frío que debe ser cubierta con este servicio\r\n';
                                        textoEquipos += '       ' + porConsumoACS + ' //Fracción de la demanda de acs que debe ser cubierta con este servicio\r\n';
                                    }

                                    textoEquipos += '       \r\n';
                                } else if (idUso == "7" || idUso == "8" || idUso == "18") {
                                    textoEquipos += '[SERVICIO=Frio]\r\n';
                                    textoEquipos += '6 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombre + ' ' + $scope.equipo[x].id + ' //Nombre del servicio o SERVICIO\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';

                                    loop3:
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            textoEquipos += '       ' + (parseFloat($scope.busesCaso[y].tempmax) + 2.0) + ' //Temperatura máxima de suministro\r\n';
                                            if (parseFloat($scope.busesCaso[y].consumof) > 1.0) {
                                                porConsumoF = parseFloat($scope.busesCaso[y].consumof) / 100.0;
                                            } else if (porConsumoF &lt; 0.1) {
                                                porConsumoF = 0.01;
                                            } else {
                                                porConsumoF = parseFloat($scope.busesCaso[y].consumof);
                                            }
                                            break loop3;
                                        }
                                    }
                                    textoEquipos += '       ' + rutaserviciofrio;
                                    textoEquipos += '       ' + porConsumoF + ' //Fracción de la demanda de frío que debe ser cubierta con este servicio\r\n';
                                    textoEquipos += '       \r\n';
                                }
                                else if (idUso == "16") {
                                    textoEquipos += '[SERVICIO=ACS]\r\n';
                                    textoEquipos += '8 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombre + ' ' + $scope.equipo[x].id + ' //Nombre del servicio o SERVICIO\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                    loop3:
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            textoEquipos += '       ' + (parseFloat($scope.busesCaso[y].tempmin) - 2.0) + ' //Temperatura mínima de suministro\r\n';
                                            if (parseFloat($scope.busesCaso[y].consumoacs) > 1.0) {
                                                porConsumoACS = parseFloat($scope.busesCaso[y].consumoacs) / 100.0;
                                            } else if (porConsumoACS &lt; 0.1) {
                                                porConsumoACS = 0.01;
                                            }  else {
                                                porConsumoACS = parseFloat($scope.busesCaso[y].consumoacs);
                                            }
                                            break loop3;
                                        }
                                    }
                                    textoEquipos += '       5 //Diferencia de temperatura de recirculación con respecto a impulsión\r\n';
                                    textoEquipos += '       ' + rutaservicioacs1;
                                    textoEquipos += '       ' + rutaservicioacs2;
                                    textoEquipos += '       ' + porConsumoACS + ' //Fracción de la demanda de acs que debe ser cubierta con este servicio\r\n';
                                    textoEquipos += '       \r\n';
                                }
                            }
                            //Para los complementos
                            else if ($scope.equipo[x].tipo == "3") {
                                var textoEquipos2 = "";
                                var idComplemento = "";
                                var nombre2 = "";
                                loop5:
                                for (var y = 0; y &lt; $scope.complementos.length; y++) {
                                    nombre2 = $scope.complementos[y].nombre;
                                    if ($scope.complementos[y].id == "8" || $scope.complementos[y].id == "9" || $scope.complementos[y].id == "10" || $scope.complementos[y].id == "11" || $scope.complementos[y].id == "12") {
                                        nombre2 = "Almacenamiento sensible";
                                    } else if ($scope.complementos[y].id == "16" || $scope.complementos[y].id == "17" || $scope.complementos[y].id == "18" || $scope.complementos[y].id == "19") {
                                        nombre2 = "Intercambiador de calor";
                                    }
                                    if ($scope.equipo[x].nombre == nombre2) {
                                        idComplemento = $scope.complementos[y].id;
                                        break loop5;
                                    }

                                }if (idComplemento == "8" || idComplemento == "9" || idComplemento == "10" || idComplemento == "11" || idComplemento == "12" || $scope.equipo[x].nombre == "Acumulación ACS") {
                                    if ($scope.equipo[x].nombre != "Acumulación solar") {
                                        textoEquipos += '[COMPLEMENTO=AlmacenamientoSensible] //El nombre del complemento coincide con el nombre de la tabla de dichos complementos\r\n';

                                        textoEquipos += '       11 //Número de datos\r\n';
                                        textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del complemento\r\n';
                                        textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                        if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg != "-") {
                                            textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';


                                        } else if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg == "-") {
                                            textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                        }
                                        else if ($scope.equipo[x].busg != "-" &amp;&amp; $scope.equipo[x].busa == "-") {
                                            textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector\r\n';
                                        }
                                        textoEquipos += '       ' + textoEquipos2;
                                        textoEquipos += '       ' + $scope.equipo[x].id + ' //id en Base de Datos\r\n';
                                        if ($scope.equipo[x].nombre == "Acumulación ACS") {
                                            textoEquipos += '       9 //idComplemento\r\n';
                                        } else {
                                            textoEquipos += '       ' + idComplemento + ' //idComplemento\r\n';
                                        }

                                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio1) + ' //Fabricante\r\n';
                                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio2) + ' //MODELO\r\n';
                                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio3) + ' //TIPO \r\n';
                                        textoEquipos += '       ' + pp($scope.equipo[x].atr1) + ' //Volumen_m3\r\n';
                                        textoEquipos += '       2 //Transmitancia_WK\r\n';
                                        textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Precio\r\n';
                                        textoEquipos += '       \r\n';
                                    }
                                } else if (idComplemento == "16" || idComplemento == "17" || idComplemento == "18" || idComplemento == "19") {
                                    textoEquipos += '[COMPLEMENTO=Intercambiadores] //El nombre del complemento coincide con el nombre de la tabla de dichos complementos\r\n';
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo;
                                    var textoEquipos2 = "";
                                    textoEquipos += '       16 //Número de datos\r\n';
                                    ley.push($scope.equipo[x].nombreequipo);
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del complemento\r\n';

                                    if (tempbusgmax > tempbusamax) {
                                        textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector\r\n';
                                        textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                    } else {
                                        textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                        textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector\r\n';
                                    }

                                    textoEquipos += '       2 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += textoEquipos2;
                                    textoEquipos += '       ' + $scope.equipo[x].id + ' //id en Base de Datos\r\n';
                                    textoEquipos += '       ' + idComplemento + ' //idComplemento\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio1) + ' //Fabricante\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio2) + ' //MODELO\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio3) + ' //TIPO \r\n';

                        textoEquipos += '       ' + pp($scope.equipo[x].atr1) + ' //Volumen_m3\r\n';
                                    textoEquipos += '       0.8 //Efectividad constante\r\n';
                                    textoEquipos += '       200.0 //Potencia_Util_kW  \r\n';
                                    textoEquipos += '       5.0 //Diferencia de Temperatura para cálculo de flujo másico \r\n';


                                    if (tempbusgmax > tempbusamax) {
                                        textoEquipos += '       ' + tempbusamax + ' //Temperatura de consigna 	\r\n';
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusamax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusamax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        ley.push("ACTIVACION-FRIO");

                                        ley.push(tempbusamax);
                                        ley.push(tempbusamin);
                                        ley.push($scope.equipo[x].busa);
                                        ley.push('L' + contEquipos);
                                        ley.push(3);
                                        ley.push(idComplemento);
                                        leyesCalor.push(ley);
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                        ley = [];

                                        ley.push($scope.equipo[x].nombreequipo);
                                        ley.push("ACTIVACION-FRIO");

                                        ley.push(tempbusgmax);
                                        ley.push(tempbusgmin);
                                        ley.push($scope.equipo[x].busg);
                                        ley.push('L' + contEquipos);
                                        ley.push(3);
                                        ley.push(idComplemento);
                                        leyesCalor.push(ley);
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                        ley = [];
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusamax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusamax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }



                                    } 
                                    else {
                                        textoEquipos += '       ' + tempbusgmax + ' //Temperatura de consigna 	\r\n';
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusgmax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusgmax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        ley.push("ACTIVACION-FRIO");

                                        ley.push(tempbusgmax);
                                        ley.push(tempbusgmin);
                                        ley.push($scope.equipo[x].busg);
                                        ley.push('L' + contEquipos);
                                        ley.push(3);
                                        ley.push(idComplemento);
                                        leyesCalor.push(ley);
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                        ley = [];


                                        ley.push($scope.equipo[x].nombreequipo);
                                        ley.push("ACTIVACION-FRIO");

                                        ley.push(tempbusamax);
                                        ley.push(tempbusamin);
                                        ley.push($scope.equipo[x].busa);
                                        ley.push('L' + contEquipos);
                                        ley.push(3);
                                        ley.push(idComplemento);
                                        leyesCalor.push(ley);
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                        Aleyesdecontrol.push(oLeyes);
                                        oLeyes = new Ley();
                                        ley = [];
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusgmax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusgmax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }

                                    }

                        textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Precio (€) \r\n';
                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';

                                    textoEquipos += '       \r\n';
                                    contEquipos++;

                                }

                                else if ($scope.equipo[x].nombre == "Acumulación solar") {
                                    textoEquipos += '[COMPLEMENTO=AlmacenamientoSolar] //El nombre del complemento coincide con el nombre de la tabla de dichos complementos\r\n';
                                    textoEquipos += '       11 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del complemento\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busa + ' //Nombre del colector\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].id + ' //id en Base de Datos\r\n';
                                    textoEquipos += '       9 //idComplemento\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio1) + ' //Fabricante\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio2) + ' //MODELO\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio3) + ' //TIPO \r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr1) + ' //Volumen_m3\r\n';
                                    textoEquipos += '       2 //Transmitancia_WK\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Precio (€) \r\n';
                                    textoEquipos += '       \r\n';
                                }/*
                    else if (idComplemento == "14") {
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio1) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio2) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio3) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr1) + '\r\n';
                        textoEquipos += '       ' +pp( $scope.equipo[x].atr2) + '\r\n';
                        textoEquipos += '       CALEFACCION\r\n';
                        textoEquipos += '       GAS NATURAL\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr3) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr4) + '\r\n';
                        textoEquipos += '       5.00\r\n';
                        textoEquipos += '       65.00\r\n';
                        textoEquipos += '       ' +pp( $scope.equipo[x].valoresservicio4) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio5) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio6) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio7) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio8) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio9) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio10) + '\r\n';
                    }
                    else if (idComplemento == "15") {
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio1) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio2) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio3) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr1) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr2) + '\r\n';
                        textoEquipos += '       CALEFACCION\r\n';
                        textoEquipos += '       GAS NATURAL\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr3) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].atr4) + '\r\n';
                        textoEquipos += '       5.00\r\n';
                        textoEquipos += '       65.00\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio4) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio5) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio6) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio7) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio8) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio9) + '\r\n';
                        textoEquipos += '       ' + pp($scope.equipo[x].valoresservicio10) + '\r\n';
                    }*/
                            }
                            //Para los equipos
                            else if ($scope.equipo[x].tipo == "1") {
                                var idServicio = "";
                                var textoEquipos2 = "";
                                var nombre2 = "";
                                loop2:
                                for (var y = 0; y &lt; $scope.servicios.length; y++) {
                                    nombre = $scope.servicios[y].nombre;
                                    if ($scope.servicios[y].id == "28") {
                                        nombre3 = "Caldera condensación";
                                    } else {
                                        nombre3 = nombre.substring(nombre.indexOf(":") + 1);
                                    }
                                    if ($scope.equipo[x].nombre == nombre3) {
                                        idServicio = $scope.servicios[y].id;
                                        break loop2;
                                    }
                                }

                                if (idServicio == "1" || idServicio == "2" || idServicio == "3" || idServicio == "4") {
                                    var temperaturamaxsolar = "";
                                    parametrizados=0;
                                    textoEquipos += '[EQUIPO=SolarTermica] //El nombre del equipo coincide con el nombre de la tabla de dichos equipos\r\n';
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo;// MMR : ESTO  LO TIENES QUE HACER EN CADA EQUIPO PARA PASARME LA LEY
                                    ley.push($scope.equipo[x].nombreequipo);
                                    for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length > 1) {
                                            for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                                if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                    parametrizados++;
                                                }
                                            }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                parametrizados++;
                                            }
                                        }
                                    }
                                    if (parametrizados > 0) {
                                        for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length>1) {

                                        
                                        for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++){
                                            if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo){
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j][k]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j][k]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j][k]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j][k]["area_captador_m2"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j][k]["rendimiento_optico_a0"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j][k]["curva_rendimiento_optico_a0"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j][k]["curva_coeficiente_perdida_captador_a1_wm2c"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j][k]["curva_coeficiente_perdidas_fluido_trabajo_a2_wm2c"]) + ",";
                                    }
                                        }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j]["area_captador_m2"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j]["rendimiento_optico_a0"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j]["curva_rendimiento_optico_a0"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j]["curva_coeficiente_perdida_captador_a1_wm2c"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j]["curva_coeficiente_perdidas_fluido_trabajo_a2_wm2c"]) + ",";
                                        }
                                    }
                                }
                                    
                                    if (textoEquipos3 != "(") {
                                        textoEquipos3 = textoEquipos3.substring(0, textoEquipos3.length - 1);
                                        textoEquipos4 = textoEquipos4.substring(0, textoEquipos4.length - 1);
                                        textoEquipos5 = textoEquipos5.substring(0, textoEquipos5.length - 1);
                                        textoEquipos6 = textoEquipos6.substring(0, textoEquipos6.length - 1);
                                        textoEquipos7 = textoEquipos7.substring(0, textoEquipos7.length - 1);
                                        textoEquipos8 = textoEquipos8.substring(0, textoEquipos8.length - 1);
                                        textoEquipos9 = textoEquipos9.substring(0, textoEquipos9.length - 1);
                                        textoEquipos10 = textoEquipos10.substring(0, textoEquipos10.length - 1);

                                        textoEquipos3 = textoEquipos3 + ')';
                                        textoEquipos4 = textoEquipos4 + ')';
                                        textoEquipos5 = textoEquipos5 + ')';
                                        textoEquipos6 = textoEquipos6 + ')';
                                        textoEquipos7 = textoEquipos7 + ')';
                                        textoEquipos8 = textoEquipos8 + ')';
                                        textoEquipos9 = textoEquipos9 + ')';
                                        textoEquipos10 = textoEquipos10 + ')';
                                    }
                                }else {
                                    textoEquipos3 = pp($scope.equipo[x].valoresservicio1);
                                        textoEquipos4 = pp($scope.equipo[x].valoresservicio2);
                                        textoEquipos5 = pp($scope.equipo[x].valoresservicio3);
                                        textoEquipos6 = pp($scope.equipo[x].atr1);
                                        textoEquipos7 = pp($scope.equipo[x].valoresservicio1);
                                        textoEquipos8 = pp($scope.equipo[x].valoresservicio5);
                                        textoEquipos9 = pp($scope.equipo[x].valoresservicio6);
                                        textoEquipos10 = pp($scope.equipo[x].valoresservicio7);
                                    }
                                    textoEquipos += '       16 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del equipo\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busg + ' //Nombre del colector\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].id + ' //id \r\n';
                                    textoEquipos += '       ' + idServicio + ' //idServicio\r\n';
                                    textoEquipos += '       ' + textoEquipos3 + ' //Fabricante\r\n';
                                    textoEquipos += '       ' + textoEquipos4 + ' //MODELO\r\n';
                                    textoEquipos += '       ' + textoEquipos5 + ' //TIPO \r\n';
                                    textoEquipos += '       1 //Precio_euros\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' // Número de colectores\r\n';
                                    textoEquipos += '       0 //azimuth con respecto al sur\r\n';
                                    textoEquipos += '       45 //inclinación\r\n';
                                    textoEquipos += '       0.02 //gasto másico en kg/s-m2 según ISO 9806-1\r\n';

                                    loop3:
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            var existe = false;
                                            temperaturamaxsolar = $scope.busesCaso[y].tempmax;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == temperaturamaxsolar) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push($scope.busesCaso[y].tempmax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push($scope.busesCaso[y].tempmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            ley.push("DIFERENCIAL");
                                            ley.push($scope.busesCaso[y].tempmax);
                                            ley.push($scope.busesCaso[y].tempmin);
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                            Aleyesdecontrol.push(oLeyes);
                                            oLeyes = new Ley();
                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesDiferencial.push(ley);
                                            ley = [];

                                            ley.push($scope.equipo[x].nombreequipo);
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(parseInt($scope.busesCaso[y].tempmax));
                                            ley.push(parseInt($scope.busesCaso[y].tempmin));
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                            Aleyesdecontrol.push(oLeyes);
                                            oLeyes = new Ley();
                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesCalor.push(ley);
                                            ley = [];
                                            break loop3;
                                        }
                                    }
                                    textoEquipos += '       ' + textoEquipos6 + '//Area captacion de cada uno \r\n';
                                    textoEquipos += '       100//Temperatura máxima de salida del captador\r\n';
                                    textoEquipos += '       ' + textoEquipos8 + ' //coeficiente a0\r\n';
                                    textoEquipos += '       ' + textoEquipos9 + ' //coeficiente a1\r\n';
                                    textoEquipos += '       ' + textoEquipos10 + ' //coeficiente a2c\r\n';
                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';

                                    textoEquipos += '       \r\n';

                                    contEquipos++;
                                    textoEquipos3 = '(';
                                    textoEquipos4 = '(';
                                    textoEquipos5 = '(';
                                    textoEquipos6 = '(';
                                    textoEquipos7 = '(';
                                    textoEquipos8 = '(';
                                    textoEquipos9 = '(';
                                    textoEquipos10 = '(';
                                }

                                else if (idServicio == "5" || idServicio == "6" || idServicio == "7" || idServicio == "8" || idServicio == "9") {
                                    textoEquipos += '[EQUIPO=AbsorcionSimple] //El nombre del equipo coincide con el nombre de la tabla de dichos equipos\r\n';
                                    textoEquipos += '       19 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del equipo\r\n';
                                    parametrizados = 0;
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            tempbusgmin = parseInt($scope.busesCaso[y].tempmin);
                                            tempbusgmax = parseInt($scope.busesCaso[y].tempmax);
                                        }
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            tempbusamin = parseInt($scope.busesCaso[y].tempmin);
                                            tempbusamax = parseInt($scope.busesCaso[y].tempmax);
                                        }

                                    }


                                    if (parseFloat(tempbusgmax) > parseFloat(tempbusamax)) {
                                        textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector frío\r\n';
                                        textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector caliente\r\n';
                                        numColectores = ' 2 //Número de colectores\r\n';
                                    } else {
                                        textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector frío\r\n';
                                        textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector caliente\r\n';
                                        numColectores = ' 2 //Número de colectores\r\n';
                                    }
                                    for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length > 1) {
                                            for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                                if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                    parametrizados++;
                                                }
                                            }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                parametrizados++;
                                            }
                                        }
                                    }
                                    if (parametrizados > 0) {
                                        for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length>1){
                                        for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                            if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j][k]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j][k]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j][k]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j][k]["potencia_refrigeracion_kw"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j][k]["consumo_electrico_condiciones_nominales_kw"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j][k]["cop_refrigeracion_nominal"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j][k]["temp_max_entrada_gen"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j][k]["temp_min_entrada_gen"]) + ",";
                                                textoEquipos11 += pp(casosParametricosaCalcularManuel[j][k]["temperatura_entrada_generador_nominal_c"]) + ",";
                                                textoEquipos12 += pp(casosParametricosaCalcularManuel[j][k]["temperatura_salida_generador_nominal_c"]) + ",";
                                                textoEquipos13 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p0"]) + ",";
                                                textoEquipos14 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p1"]) + ",";
                                                textoEquipos15 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p2"]) + ",";
                                                textoEquipos16 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p3"]) + ",";
                                                textoEquipos17 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p4"]) + ",";
                                                textoEquipos18 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p5"]) + ",";
                                                textoEquipos19 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p0"]) + ",";
                                                textoEquipos20 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p1"]) + ",";
                                                textoEquipos21 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p2"]) + ",";
                                                textoEquipos22 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p3"]) + ",";
                                                textoEquipos23 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p4"]) + ",";
                                                textoEquipos24 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p5"]) + ",";
                                                textoEquipos25 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p0"]) + ",";
                                                textoEquipos26 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p1"]) + ",";
                                                textoEquipos27 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p2"]) + ",";
                                                textoEquipos28 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p3"]) + ",";
                                                textoEquipos29 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p4"]) + ",";
                                                textoEquipos30 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p5"]) + ",";
                                            }
                                            }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j]["potencia_refrigeracion_kw"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j]["consumo_electrico_condiciones_nominales_kw"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j]["cop_refrigeracion_nominal"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j]["temp_max_entrada_gen"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j]["temp_min_entrada_gen"]) + ",";
                                                textoEquipos11 += pp(casosParametricosaCalcularManuel[j]["temperatura_entrada_generador_nominal_c"]) + ",";
                                                textoEquipos12 += pp(casosParametricosaCalcularManuel[j]["temperatura_salida_generador_nominal_c"]) + ",";
                                                textoEquipos13 += pp(casosParametricosaCalcularManuel[j]["curva_1_p0"]) + ",";
                                                textoEquipos14 += pp(casosParametricosaCalcularManuel[j]["curva_1_p1"]) + ",";
                                                textoEquipos15 += pp(casosParametricosaCalcularManuel[j]["curva_1_p2"]) + ",";
                                                textoEquipos16 += pp(casosParametricosaCalcularManuel[j]["curva_1_p3"]) + ",";
                                                textoEquipos17 += pp(casosParametricosaCalcularManuel[j]["curva_1_p4"]) + ",";
                                                textoEquipos18 += pp(casosParametricosaCalcularManuel[j]["curva_1_p5"]) + ",";
                                                textoEquipos19 += pp(casosParametricosaCalcularManuel[j]["curva_2_p0"]) + ",";
                                                textoEquipos20 += pp(casosParametricosaCalcularManuel[j]["curva_2_p1"]) + ",";
                                                textoEquipos21 += pp(casosParametricosaCalcularManuel[j]["curva_2_p2"]) + ",";
                                                textoEquipos22 += pp(casosParametricosaCalcularManuel[j]["curva_2_p3"]) + ",";
                                                textoEquipos23 += pp(casosParametricosaCalcularManuel[j]["curva_2_p4"]) + ",";
                                                textoEquipos24 += pp(casosParametricosaCalcularManuel[j]["curva_2_p5"]) + ",";
                                                textoEquipos25 += pp(casosParametricosaCalcularManuel[j]["curva_5_p0"]) + ",";
                                                textoEquipos26 += pp(casosParametricosaCalcularManuel[j]["curva_5_p1"]) + ",";
                                                textoEquipos27 += pp(casosParametricosaCalcularManuel[j]["curva_5_p2"]) + ",";
                                                textoEquipos28 += pp(casosParametricosaCalcularManuel[j]["curva_5_p3"]) + ",";
                                                textoEquipos29 += pp(casosParametricosaCalcularManuel[j]["curva_5_p4"]) + ",";
                                                textoEquipos30 += pp(casosParametricosaCalcularManuel[j]["curva_5_p5"]) + ",";
                                            }
                                        }
                                    }

                                            if (textoEquipos3 != "(") {
                                                textoEquipos3 = textoEquipos3.substring(0, textoEquipos3.length - 1);
                                                textoEquipos4 = textoEquipos4.substring(0, textoEquipos4.length - 1);
                                                textoEquipos5 = textoEquipos5.substring(0, textoEquipos5.length - 1);
                                                textoEquipos6 = textoEquipos6.substring(0, textoEquipos6.length - 1);
                                                textoEquipos7 = textoEquipos7.substring(0, textoEquipos7.length - 1);
                                                textoEquipos8 = textoEquipos8.substring(0, textoEquipos8.length - 1);
                                                textoEquipos9 = textoEquipos9.substring(0, textoEquipos9.length - 1);
                                                textoEquipos10 = textoEquipos10.substring(0, textoEquipos10.length - 1);
                                                textoEquipos11 = textoEquipos11.substring(0, textoEquipos11.length - 1);
                                                textoEquipos12 = textoEquipos12.substring(0, textoEquipos12.length - 1);
                                                textoEquipos13 = textoEquipos13.substring(0, textoEquipos13.length - 1);
                                                textoEquipos14 = textoEquipos14.substring(0, textoEquipos14.length - 1);
                                                textoEquipos15 = textoEquipos15.substring(0, textoEquipos15.length - 1);
                                                textoEquipos16 = textoEquipos16.substring(0, textoEquipos16.length - 1);
                                                textoEquipos17 = textoEquipos17.substring(0, textoEquipos17.length - 1);
                                                textoEquipos18 = textoEquipos18.substring(0, textoEquipos18.length - 1);
                                                textoEquipos19 = textoEquipos19.substring(0, textoEquipos19.length - 1);
                                                textoEquipos20 = textoEquipos20.substring(0, textoEquipos20.length - 1);
                                                textoEquipos21 = textoEquipos21.substring(0, textoEquipos21.length - 1);
                                                textoEquipos22 = textoEquipos22.substring(0, textoEquipos22.length - 1);
                                                textoEquipos23 = textoEquipos23.substring(0, textoEquipos23.length - 1);
                                                textoEquipos24 = textoEquipos24.substring(0, textoEquipos24.length - 1);
                                                textoEquipos25 = textoEquipos25.substring(0, textoEquipos25.length - 1);
                                                textoEquipos26 = textoEquipos26.substring(0, textoEquipos26.length - 1);
                                                textoEquipos27 = textoEquipos27.substring(0, textoEquipos27.length - 1);
                                                textoEquipos28 = textoEquipos28.substring(0, textoEquipos28.length - 1);
                                                textoEquipos29 = textoEquipos29.substring(0, textoEquipos29.length - 1);
                                                textoEquipos30 = textoEquipos30.substring(0, textoEquipos30.length - 1);

                                                textoEquipos3 = textoEquipos3 + ')';
                                                textoEquipos4 = textoEquipos4 + ')';
                                                textoEquipos5 = textoEquipos5 + ')';
                                                textoEquipos6 = textoEquipos6 + ')';
                                                textoEquipos7 = textoEquipos7 + ')';
                                                textoEquipos8 = textoEquipos8 + ')';
                                                textoEquipos9 = textoEquipos9 + ')';
                                                textoEquipos10 = textoEquipos10 + ')';
                                                textoEquipos11 = textoEquipos11 + ')';
                                                textoEquipos12 = textoEquipos12 + ')';
                                                textoEquipos13 = textoEquipos13 + ')';
                                                textoEquipos14 = textoEquipos14 + ')';
                                                textoEquipos15 = textoEquipos15 + ')';
                                                textoEquipos16 = textoEquipos16 + ')';
                                                textoEquipos17 = textoEquipos17 + ')';
                                                textoEquipos18 = textoEquipos18 + ')';
                                                textoEquipos19 = textoEquipos19 + ')';
                                                textoEquipos20 = textoEquipos20 + ')';
                                                textoEquipos21 = textoEquipos21 + ')';
                                                textoEquipos22 = textoEquipos22 + ')';
                                                textoEquipos23 = textoEquipos23 + ')';
                                                textoEquipos24 = textoEquipos24 + ')';
                                                textoEquipos25 = textoEquipos25 + ')';
                                                textoEquipos26 = textoEquipos26 + ')';
                                                textoEquipos27 = textoEquipos27 + ')';
                                                textoEquipos28 = textoEquipos28 + ')';
                                                textoEquipos29 = textoEquipos29 + ')';
                                                textoEquipos30 = textoEquipos30 + ')';
                                            }
                                    } else {
                                        textoEquipos3 = pp($scope.equipo[x].valoresservicio1);
                                        textoEquipos4 = pp($scope.equipo[x].valoresservicio2);
                                        textoEquipos5 = pp($scope.equipo[x].valoresservicio3);
                                        textoEquipos6 = pp($scope.equipo[x].atr1);
                                        textoEquipos7 = pp($scope.equipo[x].atr4);
                                        textoEquipos8 = pp($scope.equipo[x].atr5);
                                        textoEquipos9 = pp($scope.equipo[x].valoresservicio8);
                                        textoEquipos10 = pp($scope.equipo[x].valoresservicio9);
                                        textoEquipos11 = pp($scope.equipo[x].valoresservicio10);
                                        textoEquipos12 = pp($scope.equipo[x].valoresservicio11);
                                        textoEquipos13 = pp($scope.equipo[x].valoresservicio12);
                                        textoEquipos14 = pp($scope.equipo[x].valoresservicio13);
                                        textoEquipos15 = pp($scope.equipo[x].valoresservicio14);
                                        textoEquipos16 = pp($scope.equipo[x].valoresservicio15);
                                        textoEquipos17 = pp($scope.equipo[x].valoresservicio16);
                                        textoEquipos18 = pp($scope.equipo[x].valoresservicio17);
                                        textoEquipos19 = pp($scope.equipo[x].valoresservicio18);
                                        textoEquipos20 = pp($scope.equipo[x].valoresservicio19);
                                        textoEquipos21 = pp($scope.equipo[x].valoresservicio20);
                                        textoEquipos22 = pp($scope.equipo[x].valoresservicio21);
                                        textoEquipos23 = pp($scope.equipo[x].valoresservicio22);
                                        textoEquipos24 = pp($scope.equipo[x].valoresservicio23);
                                        textoEquipos25 = pp($scope.equipo[x].valoresservicio24);
                                        textoEquipos26 = pp($scope.equipo[x].valoresservicio25);
                                        textoEquipos27 = pp($scope.equipo[x].valoresservicio26);
                                        textoEquipos28 = pp($scope.equipo[x].valoresservicio27);
                                        textoEquipos29 = pp($scope.equipo[x].valoresservicio28);
                                        textoEquipos30 = pp($scope.equipo[x].valoresservicio29);
                                    }
                                   
                                    textoEquipos += '       ' + numColectores;
                                    textoEquipos += '       ' + textoEquipos2;
                                    textoEquipos += '       ' + $scope.equipo[x].id + ' //id \r\n';
                                    textoEquipos += '       ' + idServicio + ' //idServicio\r\n';
                                 
                                    textoEquipos += '       ' + textoEquipos3 + ' //Fabricante\r\n';
                                 
                                    textoEquipos += '       ' + textoEquipos4 + ' //MODELO\r\n';
                                   
                                    textoEquipos += '       ' + textoEquipos5 + ' //TIPO \r\n';
                                    
                                    textoEquipos += '       1 //precio\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' ////Numero_Equipos    \r\n';
                                    textoEquipos += '       ' + textoEquipos6 + ' // Capacidad_Nominal_Refrigeracion_kW \r\n';
                                    textoEquipos += '       ' + textoEquipos7 + ' //Consumo eléctrico nominal_kW\r\n';
                                    textoEquipos += '       ' + textoEquipos8 + ' // cop_refrigeracion_nominal\r\n';
                                    textoEquipos += '       5.00 //Diferencia de Temperatura para cálculo de flujo másico \r\n';
                                    textoEquipos += '       15//Temperatura_Impulsion_Agua_Max_Refrigeracion\r\n';
                                    textoEquipos += '       -5//uso//Temperatura_Impulsion_Min_Refrigeracion\r\n';
                                    if (parseFloat(tempbusgmax) > parseFloat(tempbusamax)) {
                                        textoEquipos += '       ' + tempbusamin + '//Temperatura consigna de Refrigeración\r\n';
                                    } else {
                                        textoEquipos += '       ' + tempbusgmin + '//Temperatura consigna de Refrigeración\r\n';
                                    }
                                    textoEquipos += '       ' + textoEquipos9 + '// //Temperatura máxima de entrada al generador\r\n';
                                    textoEquipos += '       ' + textoEquipos10 + '////Temperatura mínima de entrada al generador\r\n';
                                    textoEquipos += '       ' + textoEquipos11 + '//temperatura entrada generador nominal c\r\n';
                                    textoEquipos += '       ' + textoEquipos12 + '//temperatura salida generador nominal c\r\n';
                                    textoEquipos += '       0 //PRL_min\r\n';
                                    textoEquipos += '       1 //PRL_opt\r\n';
                                    textoEquipos += '       1 //PRL_max\r\n';
                                    textoEquipos += '       ' + textoEquipos13 + '//Coefficient P0 Of POT_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos14 + '//Coefficient P1 Of POT_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos15 + '//Coefficient P2 Of POT_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos16 + '//Coefficient P3 Of POT_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos17 + '//Coefficient P4 Of POT_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos18 + '//Coefficient P5 Of POT_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos19 + '//Coefficient P0 Of POT_GEN_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos20 + '//Coefficient P1 Of POT_GEN_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos21 + '//Coefficient P2 Of POT_GEN_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos22 + '//Coefficient P3 Of POT_GEN_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos23 + '//Coefficient P4 Of POT_GEN_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos24 + '//Coefficient P5 Of POT_GEN_NOM_T\r\n';
                                    textoEquipos += '       ' + textoEquipos25 + '//Coefficient P0 Of CON_ELEC_FCP\r\n';
                                    textoEquipos += '       ' + textoEquipos26 + '//Coefficient P1 Of CON_ELEC_FCP\r\n';
                                    textoEquipos += '       ' + textoEquipos27 + '//Coefficient P2 Of CON_ELEC_FCP\r\n';
                                    textoEquipos += '       ' + textoEquipos28 + '//Coefficient P3 Of CON_ELEC_FCP\r\n';
                                    textoEquipos += '       ' + textoEquipos29 + '//Coefficient P4 Of CON_ELEC_FCP\r\n';
                                    textoEquipos += '       ' + textoEquipos30 + '//Coefficient P5 Of CON_ELEC_FCP\r\n';
                                    textoEquipos += '       0.135512 		//Coefficient P0 Of POT_GEN_NOM_FCP\r\n';
                                    textoEquipos += '       0.617981 		//Coefficient P1 Of POT_GEN_NOM_FCP\r\n';
                                    textoEquipos += '       0.246513 		//Coefficient P2 Of POT_GEN_NOM_FCP\r\n';
                                    textoEquipos += '       0  				//Coefficient P3 Of POT_GEN_NOM_FCP\r\n';
                                    textoEquipos += '       0  				//Coefficient P4 Of POT_GEN_NOM_FCP\r\n';
                                    textoEquipos += '       0  				//Coefficient P5 Of POT_GEN_NOM_FCP\r\n';
                                    if (parseFloat(tempbusgmax) > parseFloat(tempbusamax)) {
                                        ley.push($scope.equipo[x].nombreequipo);
                                        //textoEquipos += '       ' + tempbusamin + '\r\n';
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusamax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusamax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        if (busAlimenta != "7" &amp;&amp; busAlimenta != "8") {
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(tempbusamax);
                                            ley.push(tempbusamin);
                                            ley.push($scope.equipo[x].busa);
                                            ley.push('L' + (contEquipos));

                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesCalor.push(ley);
                                            ley = [];
                                        } else {
                                            ley.push("ACTIVACION-FRIO");
                                            ley.push(tempbusamax);
                                            ley.push(tempbusamin);
                                            ley.push($scope.equipo[x].busa);
                                            ley.push('L' + (contEquipos));

                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesFrio.push(ley);
                                            ley = [];
                                        }

                                    } else {
                                        ley.push($scope.equipo[x].nombreequipo);
                                        //textoEquipos += '       ' + tempbusgmax + '\r\n';
                                        var existe = false;
                                        if (temperaturas.length > 0) {
                                            for (var z = 0; z &lt; temperaturas.length; z++) {
                                                if (temperaturas[z][0] == tempbusgmax) {
                                                    existe = true;
                                                    temperaturas[z][1] = temperaturas[z][1] + 1;
                                                }
                                            }
                                            if (existe == false) {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                        } else {
                                            temperatura.push(tempbusgmax);
                                            temperatura.push(1);
                                            temperatura.push(1);
                                            temperaturas.push(temperatura);
                                            temperatura = [];
                                        }
                                        if (busGenera != "7" &amp;&amp; busGenera != "8") {
                                            ley.push("ACTIVACION-CALOR");
                                            ley.push(tempbusgmax);
                                            ley.push(tempbusgmin);
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + (contEquipos));

                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesCalor.push(ley);
                                            ley = [];
                                        } else {
                                            ley.push("ACTIVACION-FRIO");
                                            ley.push(tempbusgmax);
                                            ley.push(tempbusgmin);
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + (contEquipos));

                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesFrio.push(ley);
                                            ley = [];
                                        }

                                    }




                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';
                                    oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
                                    contEquipos++;

                                    textoEquipos += '       \r\n';
                                    Aleyesdecontrol.push(oLeyes);
                                    oLeyes = new Ley();
                                    textoEquipos3 = '(';
                                    textoEquipos4 = '(';
                                    textoEquipos5 = '(';
                                    textoEquipos6 = '(';
                                    textoEquipos7 = '(';
                                    textoEquipos8 = '(';
                                    textoEquipos9 = '(';
                                    textoEquipos10 = '(';
                                    textoEquipos11 = '(';
                                    textoEquipos12 = '(';
                                    textoEquipos13 = '(';
                                    textoEquipos14 = '(';
                                    textoEquipos15 = '(';
                                    textoEquipos16 = '(';
                                    textoEquipos17 = '(';
                                    textoEquipos18 = '(';
                                    textoEquipos19 = '(';
                                    textoEquipos20 = '(';
                                    textoEquipos21 = '(';
                                    textoEquipos22 = '(';
                                    textoEquipos23 = '(';
                                    textoEquipos24 = '(';
                                    textoEquipos25 = '(';
                                    textoEquipos26 = '(';
                                    textoEquipos27 = '(';
                                    textoEquipos28 = '(';
                                    textoEquipos29 = '(';
                                    textoEquipos30 = '(';
                                }
                                
                                else if (idServicio == "27" || idServicio == "28" || idServicio == "29") {
                                var aumento =0;
                                var numCalderas=0;
                                parametrizados=0;
                                    ley.push($scope.equipo[x].nombreequipo);
                                    textoEquipos += '[EQUIPO=Caldera]\r\n';
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo;// MMR : ESTO  LO TIENES QUE HACER EN CADA EQUIPO PARA PASARME LA LEY
                                    textoEquipos += '       24 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + '  //Nombre del equipo\r\n';
                                    textoEquipos += '       1 //Número de colectores a los que está conectado\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].busg + ' //Nombre del colector    \r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].id + ' //id en Base de Datos\r\n';
                                    textoEquipos += '       ' + idServicio + ' //idServicio\r\n';
                                    for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length > 1) {
                                            for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                                if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                    parametrizados ++;
                                        }
                                        }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                parametrizados++;
                                            }
                                        }
                                    }
                                    if (parametrizados > 0) {
                                        for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length>1){
                                        for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                            if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j][k]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j][k]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j][k]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j][k]["Potencia útil (kW)"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j][k]["Rendimiento 100 (%)"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j][k]["plr_min"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j][k]["plr_opt"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j][k]["plr_max"]) + ",";
                                                textoEquipos11 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p0"]) + ",";
                                                textoEquipos12 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p1"]) + ",";
                                                textoEquipos13 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p2"]) + ",";
                                                textoEquipos14 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p3"]) + ",";
                                                textoEquipos15 += pp(casosParametricosaCalcularManuel[j][k]["Uso"]) + ",";
                                                textoEquipos16 += pp(casosParametricosaCalcularManuel[j][k]["Combustible"]) + ",";

                                            }
                                        }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j]["Potencia útil (kW)"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j]["Rendimiento 100 (%)"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j]["plr_min"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j]["plr_opt"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j]["plr_max"]) + ",";
                                                textoEquipos11 += pp(casosParametricosaCalcularManuel[j]["curva_1_p0"]) + ",";
                                                textoEquipos12 += pp(casosParametricosaCalcularManuel[j]["curva_1_p1"]) + ",";
                                                textoEquipos13 += pp(casosParametricosaCalcularManuel[j]["curva_1_p2"]) + ",";
                                                textoEquipos14 += pp(casosParametricosaCalcularManuel[j]["curva_1_p3"]) + ",";
                                                textoEquipos15 += pp(casosParametricosaCalcularManuel[j]["Uso"]) + ",";
                                                textoEquipos16 += pp(casosParametricosaCalcularManuel[j]["Combustible"]) + ",";

                                            }
                                        }
                                    }

                                            if (textoEquipos3 != "(") {
                                                textoEquipos3 = textoEquipos3.substring(0, textoEquipos3.length - 1);
                                                textoEquipos4 = textoEquipos4.substring(0, textoEquipos4.length - 1);
                                                textoEquipos5 = textoEquipos5.substring(0, textoEquipos5.length - 1);
                                                textoEquipos6 = textoEquipos6.substring(0, textoEquipos6.length - 1);
                                                textoEquipos7 = textoEquipos7.substring(0, textoEquipos7.length - 1);
                                                textoEquipos8 = textoEquipos8.substring(0, textoEquipos8.length - 1);
                                                textoEquipos9 = textoEquipos9.substring(0, textoEquipos9.length - 1);
                                                textoEquipos10 = textoEquipos10.substring(0, textoEquipos10.length - 1);
                                                textoEquipos11 = textoEquipos11.substring(0, textoEquipos11.length - 1);
                                                textoEquipos12 = textoEquipos12.substring(0, textoEquipos12.length - 1);
                                                textoEquipos13 = textoEquipos13.substring(0, textoEquipos13.length - 1);
                                                textoEquipos14 = textoEquipos14.substring(0, textoEquipos14.length - 1);
                                                textoEquipos15 = textoEquipos15.substring(0, textoEquipos15.length - 1);
                                                textoEquipos16 = textoEquipos16.substring(0, textoEquipos16.length - 1);

                                                textoEquipos3 = textoEquipos3 + ')';
                                                textoEquipos4 = textoEquipos4 + ')';
                                                textoEquipos5 = textoEquipos5 + ')';
                                                textoEquipos6 = textoEquipos6 + ')';
                                                textoEquipos7 = textoEquipos7 + ')';
                                                textoEquipos8 = textoEquipos8 + ')';
                                                textoEquipos9 = textoEquipos9 + ')';
                                                textoEquipos10 = textoEquipos10 + ')';
                                                textoEquipos11 = textoEquipos11 + ')';
                                                textoEquipos12 = textoEquipos12 + ')';
                                                textoEquipos13 = textoEquipos13 + ')';
                                                textoEquipos14 = textoEquipos14 + ')';
                                                textoEquipos15 = textoEquipos15 + ')';
                                                textoEquipos16 = textoEquipos16 + ')';

                                      
                                    }
                                    } else {
                                        textoEquipos3 = pp($scope.equipo[x].valoresservicio1);
                                        textoEquipos4 = pp($scope.equipo[x].valoresservicio2);
                                        textoEquipos5 = pp($scope.equipo[x].valoresservicio3);
                                        textoEquipos6 = pp($scope.equipo[x].atr3);
                                        textoEquipos7 = pp($scope.equipo[x].atr6);
                                        textoEquipos8 = pp($scope.equipo[x].valoresservicio4);
                                        textoEquipos9 = pp($scope.equipo[x].valoresservicio5);
                                        textoEquipos10 = pp($scope.equipo[x].valoresservicio6);
                                        textoEquipos11 = pp($scope.equipo[x].valoresservicio7);
                                        textoEquipos12 = pp($scope.equipo[x].valoresservicio8);
                                        textoEquipos13 = pp($scope.equipo[x].valoresservicio9);
                                        textoEquipos14 = pp($scope.equipo[x].valoresservicio10);
                                        textoEquipos15 = pp($scope.equipo[x].atr1);
                                        textoEquipos16 = pp($scope.equipo[x].atr2);

                                    }
                                    if (numCalderas > 1) {
                                        numcasosParametricos.push(numCalderas);
                                    }
                                    if (textoEquipos3 != "(") {
                                        textoEquipos3 = textoEquipos3.substring(0, textoEquipos3.length - 1);

                                        textoEquipos3 = textoEquipos3 + ')';
                                    }
                                  
                                    textoEquipos += '       ' + textoEquipos3 + ' //Fabricante\r\n';
                                    
                                    textoEquipos += '       ' + textoEquipos4 + ' //MODELO\r\n';
                                    
                                    textoEquipos += '       ' + textoEquipos5 + ' //TIPO \r\n';
                                    
                                    
                                    textoEquipos += '       0 //Precio_euros \r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' //Numero_Calderas \r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr1)+ ' //SERVICIO\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].atr2) + ' //Combustible \r\n';
                                    
                                    textoEquipos += '       ' + textoEquipos6 + ' //Potencia_Util_kW \r\n';
                                    textoEquipos += '       ' + textoEquipos7 + ' //Rendimiento_100 \r\n';
                                    
                                    contEquiposCasos++;
                                    contEquiposCasos++;
                                    textoEquipos += '       ' + '       5.00 //Diferencia de Temperatura para cálculo de flujo másico \r\n';
                                    loop3:
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            if (hayfantasma == true &amp;&amp; $scope.busesCaso[y].idbus == "3") {
                                                aumento = 5;
                                            }
                                            textoEquipos += '       ' + (parseFloat($scope.busesCaso[y].tempmax)+aumento) + ' //Temperatura de consigna \r\n';
                                            var existe = false;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == (parseFloat($scope.busesCaso[y].tempmax) + aumento)) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push((parseFloat($scope.busesCaso[y].tempmax) + aumento));
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push((parseFloat($scope.busesCaso[y].tempmax) + aumento));
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            ley.push("ACTIVACION-CALOR");

                                            ley.push((parseFloat($scope.busesCaso[y].tempmax) + aumento));
                                            ley.push((parseFloat($scope.busesCaso[y].tempmin) + aumento));
                                            ley.push($scope.equipo[x].busg);
                                            ley.push('L' + contEquipos);
                                            oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                                            Aleyesdecontrol.push(oLeyes);
                                            oLeyes = new Ley();
                                            ley.push(1);
                                            ley.push(idServicio);
                                            leyesCalor.push(ley);
                                            ley = [];
                                            break loop3;
                                        }
                                    }

                                    textoEquipos += '       ' + textoEquipos8 + ' //PLR_min\r\n';
                                    textoEquipos += '       ' + textoEquipos9 + ' //PLR_opt \r\n';
                                    textoEquipos += '       ' + textoEquipos10 + ' //PLR_max\r\n';
                                    textoEquipos += '       ' + textoEquipos11 + ' //Curva_1_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos12 + ' //Curva_1_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos13 + ' //Curva_1_P2 \r\n';
                                    textoEquipos += '       ' + textoEquipos14 + ' //Curva_1_P3\r\n';
                                    textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';

                                    textoEquipos += '       \r\n';
                                    contEquipos++;
                                    textoEquipos3 = '(';
                                    textoEquipos4 = '(';
                                    textoEquipos5 = '(';
                                    textoEquipos6 = '(';
                                    textoEquipos7 = '(';
                                    textoEquipos8 = '(';
                                    textoEquipos9 = '(';
                                    textoEquipos10 = '(';
                                    textoEquipos11 = '(';
                                    textoEquipos12 = '(';
                                    textoEquipos13 = '(';
                                    textoEquipos14 = '(';
                                    textoEquipos15 = '(';
                                    textoEquipos16 = '(';

                                }
                               
                                else if (idServicio == "32" || idServicio == "33" || idServicio == "34") {
                                    var numBombas=0;
                                    textoEquipos += '[EQUIPO=BombaCalor] //El nombre del equipo coincide con el nombre de la tabla de dichos equipos\r\n';
                                    parametrizados =0;
                                    oLeyes.nombre = $scope.equipo[x].nombreequipo; // MMR : ESTO LO TIENES QUE HACER PARA PASARME LA LEY
                                    textoEquipos += '       70 //Número de datos\r\n';
                                    textoEquipos += '       ' + $scope.equipo[x].nombreequipo + ' //Nombre del equipo\r\n';
                                    var tempbusgmin = ""; //MMR : SE HA AÑADIDO EL SIGUIENTE CODIGO PARA ASIGNAR LOS COLECTORES A LA BOMBA DE CALOR
                                    var tempbusamin = "";
                                    var tempbusgmax = ""; //MMR : SE HA AÑADIDO EL SIGUIENTE CODIGO PARA ASIGNAR LOS COLECTORES A LA BOMBA DE CALOR
                                    var tempbusamax = "";

                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            numColectores++;
                                            tempbusgmin = parseFloat($scope.busesCaso[y].tempmin);
                                            tempbusgmax = parseFloat($scope.busesCaso[y].tempmax);
                                            busGenera = $scope.busesCaso[y].idbus;
                                            if (hayfantasma == true &amp;&amp; busGenera == "3") {
                                                tempbusgmin += 5;
                                                tempbusgmax += 5;
                                            }
                                        }
                                        if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                            numColectores++;
                                            tempbusamin = parseFloat($scope.busesCaso[y].tempmin);
                                            tempbusamax = parseFloat($scope.busesCaso[y].tempmax);
                                            busAlimenta = $scope.busesCaso[y].idbus;
                                            if (hayfantasma == true &amp;&amp; busAlimenta == "3") {
                                                tempbusamin += 5;
                                                tempbusamax += 5;
                                            }
                                        }

                                    }
                                    

                                    if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg != "-") {
                                        if (parseFloat(tempbusgmax) > parseFloat(tempbusamax)) {
                                            textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector frío\r\n';
                                            textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector caliente\r\n';
                                            numColectores = ' 2 //Número de colectores\r\n';
                                        } else {
                                            textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector frío\r\n';
                                            textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector caliente\r\n';
                                            numColectores = ' 2 //Número de colectores\r\n';
                                        }

                                    } else {
                                        if ($scope.equipo[x].busa != "-") {
                                            if (busAlimenta != "7" &amp;&amp; busAlimenta != "8") {
                                                textoEquipos2 += '       AIRE //Nombre del colector frío\r\n';
                                                textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector caliente\r\n';
                                                numColectores = ' 1 //Número de colectores\r\n';
                                            } else {
                                                textoEquipos2 += '       ' + $scope.equipo[x].busa + ' //Nombre del colector frío\r\n';
                                                textoEquipos2 += '       AIRE //Nombre del colector caliente\r\n';
                                                numColectores = ' 1 //Número de colectores\r\n';
                                            }

                                        }
                                        else {
                                            if ($scope.equipo[x].busg != "-") {
                                                if (busAlimenta != "7" &amp;&amp; busAlimenta != "8") {
                                                    textoEquipos2 += '       AIRE //Nombre del colector frío\r\n';
                                                    textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector caliente\r\n';
                                                    numColectores = ' 1 //Número de colectores\r\n';
                                                } else {
                                                    textoEquipos2 += '       ' + $scope.equipo[x].busg + ' //Nombre del colector frío\r\n';
                                                    textoEquipos2 += '       AIRE //Nombre del colector caliente\r\n';
                                                    numColectores = ' 1 //Número de colectores\r\n';
                                                }
                                            }
                                        }
                                    }

                                    textoEquipos += '       ' + numColectores;
                                    textoEquipos += '       ' + textoEquipos2;
                                    if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg != "-") {
                                        textoEquipos += '       ' + $scope.equipo[x].tipoequipo.trim() + ' //tipo de bomba \r\n';
                                    } else {
                                        textoEquipos += '       ' + $scope.equipo[x].tipoequipo.trim() + ' //tipo de bomba \r\n';
                                    }
                                    textoEquipos += '       ' + $scope.equipo[x].id + ' //id\r\n';
                                    textoEquipos += '       ' + idServicio + ' //idServicio\r\n';
                                    for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                        if (casosParametricosaCalcularManuel[j].length > 1) {
                                            for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                                if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                    parametrizados++;
                                                }
                                            }
                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                parametrizados++;
                                            }
                                        }
                                    }
                                    if (parametrizados > 0) {
                                        for (var j = 0; j &lt; casosParametricosaCalcularManuel.length; j++) {
                                            if (casosParametricosaCalcularManuel[j].length > 1) {
                                        for (var k = 0; k &lt; casosParametricosaCalcularManuel[j].length; k++) {
                                            if (casosParametricosaCalcularManuel[j][k]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j][k]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j][k]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j][k]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j][k]["capacidad_nominal_calefaccion_kw"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j][k]["capacidad_nominal_refrigeracion_kw"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j][k]["COP nominal"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j][k]["EER nominal"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j][k]["temperatura_impulsion_agua_max_refrigeracion"]) + ",";
                                                textoEquipos11 += pp(casosParametricosaCalcularManuel[j][k]["temperatura_impulsion_min_refrigeracion"]) + ",";
                                                textoEquipos12 += pp(casosParametricosaCalcularManuel[j][k]["temperatura_impulsion_agua_max_calefaccion"]) + ",";
                                                textoEquipos13 += pp(casosParametricosaCalcularManuel[j][k]["temperatura_impulsion_min_calefaccion"]) + ",";
                                                textoEquipos14 += pp(casosParametricosaCalcularManuel[j][k]["prl_min"]) + ",";
                                                textoEquipos15 += pp(casosParametricosaCalcularManuel[j][k]["prl_max"]) + ",";
                                                textoEquipos16 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p0"]) + ",";
                                                textoEquipos17 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p1"]) + ",";
                                                textoEquipos18 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p2"]) + ",";
                                                textoEquipos19 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p3"]) + ",";
                                                textoEquipos20 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p4"]) + ",";
                                                textoEquipos21 += pp(casosParametricosaCalcularManuel[j][k]["curva_1_p5"]) + ",";
                                                textoEquipos22 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p0"]) + ",";
                                                textoEquipos23 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p1"]) + ",";
                                                textoEquipos24 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p2"]) + ",";
                                                textoEquipos25 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p3"]) + ",";
                                                textoEquipos26 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p4"]) + ",";
                                                textoEquipos27 += pp(casosParametricosaCalcularManuel[j][k]["curva_2_p5"]) + ",";
                                                textoEquipos28 += pp(casosParametricosaCalcularManuel[j][k]["curva_3_p0"]) + ",";
                                                textoEquipos29 += pp(casosParametricosaCalcularManuel[j][k]["curva_3_p1"]) + ",";
                                                textoEquipos30 += pp(casosParametricosaCalcularManuel[j][k]["curva_3_p2"]) + ",";
                                                textoEquipos31 += pp(casosParametricosaCalcularManuel[j][k]["curva_3_p3"]) + ",";
                                                textoEquipos32 += pp(casosParametricosaCalcularManuel[j][k]["curva_3_p4"]) + ",";
                                                textoEquipos33 += pp(casosParametricosaCalcularManuel[j][k]["curva_3_p5"]) + ",";
                                                textoEquipos34 += pp(casosParametricosaCalcularManuel[j][k]["curva_4_p0"]) + ",";
                                                textoEquipos35 += pp(casosParametricosaCalcularManuel[j][k]["curva_4_p1"]) + ",";
                                                textoEquipos36 += pp(casosParametricosaCalcularManuel[j][k]["curva_4_p2"]) + ",";
                                                textoEquipos37 += pp(casosParametricosaCalcularManuel[j][k]["curva_4_p3"]) + ",";
                                                textoEquipos38 += pp(casosParametricosaCalcularManuel[j][k]["curva_4_p4"]) + ",";
                                                textoEquipos39 += pp(casosParametricosaCalcularManuel[j][k]["curva_4_p5"]) + ",";
                                                textoEquipos40 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p_0"]) + ",";
                                                textoEquipos41 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p_1"]) + ",";
                                                textoEquipos42 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p_2"]) + ",";
                                                textoEquipos43 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p_3"]) + ",";
                                                textoEquipos44 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p_4"]) + ",";
                                                textoEquipos45 += pp(casosParametricosaCalcularManuel[j][k]["curva_5_p_5"]) + ",";
                                                textoEquipos46 += pp(casosParametricosaCalcularManuel[j][k]["curva_6_p_0"]) + ",";
                                                textoEquipos47 += pp(casosParametricosaCalcularManuel[j][k]["curva_6_p_1"]) + ",";
                                                textoEquipos48 += pp(casosParametricosaCalcularManuel[j][k]["curva_6_p_2"]) + ",";
                                                textoEquipos49 += pp(casosParametricosaCalcularManuel[j][k]["curva_6_p_3"]) + ",";
                                                textoEquipos50 += pp(casosParametricosaCalcularManuel[j][k]["curva_6_p_4"]) + ",";
                                                textoEquipos51 += pp(casosParametricosaCalcularManuel[j][k]["curva_6_p_5"]) + ",";
                                                textoEquipos52 += pp(casosParametricosaCalcularManuel[j][k]["curva_7_p0"]) + ",";
                                                textoEquipos53 += pp(casosParametricosaCalcularManuel[j][k]["curva_7_p1"]) + ",";
                                                textoEquipos54 += pp(casosParametricosaCalcularManuel[j][k]["curva_7_p2"]) + ",";
                                                textoEquipos55 += pp(casosParametricosaCalcularManuel[j][k]["curva_7_p3"]) + ",";
                                                textoEquipos56 += pp(casosParametricosaCalcularManuel[j][k]["curva_7_p4"]) + ",";
                                                textoEquipos57 += pp(casosParametricosaCalcularManuel[j][k]["curva_7_p5"]) + ",";
                                                }
                                            }

                                        } else {
                                            if (casosParametricosaCalcularManuel[j]["nombre"] == $scope.equipo[x].nombreequipo) {
                                                textoEquipos3 += pp(casosParametricosaCalcularManuel[j]["fabricante"]) + ",";
                                                textoEquipos4 += pp(casosParametricosaCalcularManuel[j]["modelo"]) + ",";
                                                textoEquipos5 += pp(casosParametricosaCalcularManuel[j]["tipo"]) + ",";
                                                textoEquipos6 += pp(casosParametricosaCalcularManuel[j]["capacidad_nominal_calefaccion_kw"]) + ",";
                                                textoEquipos7 += pp(casosParametricosaCalcularManuel[j]["capacidad_nominal_refrigeracion_kw"]) + ",";
                                                textoEquipos8 += pp(casosParametricosaCalcularManuel[j]["COP nominal"]) + ",";
                                                textoEquipos9 += pp(casosParametricosaCalcularManuel[j]["EER nominal"]) + ",";
                                                textoEquipos10 += pp(casosParametricosaCalcularManuel[j]["temperatura_impulsion_agua_max_refrigeracion"]) + ",";
                                                textoEquipos11 += pp(casosParametricosaCalcularManuel[j]["temperatura_impulsion_min_refrigeracion"]) + ",";
                                                textoEquipos12 += pp(casosParametricosaCalcularManuel[j]["temperatura_impulsion_agua_max_calefaccion"]) + ",";
                                                textoEquipos13 += pp(casosParametricosaCalcularManuel[j]["temperatura_impulsion_min_calefaccion"]) + ",";
                                                textoEquipos14 += pp(casosParametricosaCalcularManuel[j]["prl_min"]) + ",";
                                                textoEquipos15 += pp(casosParametricosaCalcularManuel[j]["prl_max"]) + ",";
                                                textoEquipos16 += pp(casosParametricosaCalcularManuel[j]["curva_1_p0"]) + ",";
                                                textoEquipos17 += pp(casosParametricosaCalcularManuel[j]["curva_1_p1"]) + ",";
                                                textoEquipos18 += pp(casosParametricosaCalcularManuel[j]["curva_1_p2"]) + ",";
                                                textoEquipos19 += pp(casosParametricosaCalcularManuel[j]["curva_1_p3"]) + ",";
                                                textoEquipos20 += pp(casosParametricosaCalcularManuel[j]["curva_1_p4"]) + ",";
                                                textoEquipos21 += pp(casosParametricosaCalcularManuel[j]["curva_1_p5"]) + ",";
                                                textoEquipos22 += pp(casosParametricosaCalcularManuel[j]["curva_2_p0"]) + ",";
                                                textoEquipos23 += pp(casosParametricosaCalcularManuel[j]["curva_2_p1"]) + ",";
                                                textoEquipos24 += pp(casosParametricosaCalcularManuel[j]["curva_2_p2"]) + ",";
                                                textoEquipos25 += pp(casosParametricosaCalcularManuel[j]["curva_2_p3"]) + ",";
                                                textoEquipos26 += pp(casosParametricosaCalcularManuel[j]["curva_2_p4"]) + ",";
                                                textoEquipos27 += pp(casosParametricosaCalcularManuel[j]["curva_2_p5"]) + ",";
                                                textoEquipos28 += pp(casosParametricosaCalcularManuel[j]["curva_3_p0"]) + ",";
                                                textoEquipos29 += pp(casosParametricosaCalcularManuel[j]["curva_3_p1"]) + ",";
                                                textoEquipos30 += pp(casosParametricosaCalcularManuel[j]["curva_3_p2"]) + ",";
                                                textoEquipos31 += pp(casosParametricosaCalcularManuel[j]["curva_3_p3"]) + ",";
                                                textoEquipos32 += pp(casosParametricosaCalcularManuel[j]["curva_3_p4"]) + ",";
                                                textoEquipos33 += pp(casosParametricosaCalcularManuel[j]["curva_3_p5"]) + ",";
                                                textoEquipos34 += pp(casosParametricosaCalcularManuel[j]["curva_4_p0"]) + ",";
                                                textoEquipos35 += pp(casosParametricosaCalcularManuel[j]["curva_4_p1"]) + ",";
                                                textoEquipos36 += pp(casosParametricosaCalcularManuel[j]["curva_4_p2"]) + ",";
                                                textoEquipos37 += pp(casosParametricosaCalcularManuel[j]["curva_4_p3"]) + ",";
                                                textoEquipos38 += pp(casosParametricosaCalcularManuel[j]["curva_4_p4"]) + ",";
                                                textoEquipos39 += pp(casosParametricosaCalcularManuel[j]["curva_4_p5"]) + ",";
                                                textoEquipos40 += pp(casosParametricosaCalcularManuel[j]["curva_5_p_0"]) + ",";
                                                textoEquipos41 += pp(casosParametricosaCalcularManuel[j]["curva_5_p_1"]) + ",";
                                                textoEquipos42 += pp(casosParametricosaCalcularManuel[j]["curva_5_p_2"]) + ",";
                                                textoEquipos43 += pp(casosParametricosaCalcularManuel[j]["curva_5_p_3"]) + ",";
                                                textoEquipos44 += pp(casosParametricosaCalcularManuel[j]["curva_5_p_4"]) + ",";
                                                textoEquipos45 += pp(casosParametricosaCalcularManuel[j]["curva_5_p_5"]) + ",";
                                                textoEquipos46 += pp(casosParametricosaCalcularManuel[j]["curva_6_p_0"]) + ",";
                                                textoEquipos47 += pp(casosParametricosaCalcularManuel[j]["curva_6_p_1"]) + ",";
                                                textoEquipos48 += pp(casosParametricosaCalcularManuel[j]["curva_6_p_2"]) + ",";
                                                textoEquipos49 += pp(casosParametricosaCalcularManuel[j]["curva_6_p_3"]) + ",";
                                                textoEquipos50 += pp(casosParametricosaCalcularManuel[j]["curva_6_p_4"]) + ",";
                                                textoEquipos51 += pp(casosParametricosaCalcularManuel[j]["curva_6_p_5"]) + ",";
                                                textoEquipos52 += pp(casosParametricosaCalcularManuel[j]["curva_7_p0"]) + ",";
                                                textoEquipos53 += pp(casosParametricosaCalcularManuel[j]["curva_7_p1"]) + ",";
                                                textoEquipos54 += pp(casosParametricosaCalcularManuel[j]["curva_7_p2"]) + ",";
                                                textoEquipos55 += pp(casosParametricosaCalcularManuel[j]["curva_7_p3"]) + ",";
                                                textoEquipos56 += pp(casosParametricosaCalcularManuel[j]["curva_7_p4"]) + ",";
                                                textoEquipos57 += pp(casosParametricosaCalcularManuel[j]["curva_7_p5"]) + ",";
                                            }
                                        }
                                    }

                                            if (textoEquipos3 != "(") {
                                                textoEquipos3 = textoEquipos3.substring(0, textoEquipos3.length - 1);
                                                textoEquipos4 = textoEquipos4.substring(0, textoEquipos4.length - 1);
                                                textoEquipos5 = textoEquipos5.substring(0, textoEquipos5.length - 1);
                                                textoEquipos6 = textoEquipos6.substring(0, textoEquipos6.length - 1);
                                                textoEquipos7 = textoEquipos7.substring(0, textoEquipos7.length - 1);
                                                textoEquipos8 = textoEquipos8.substring(0, textoEquipos8.length - 1);
                                                textoEquipos9 = textoEquipos9.substring(0, textoEquipos9.length - 1);
                                                textoEquipos10 = textoEquipos10.substring(0, textoEquipos10.length - 1);
                                                textoEquipos11 = textoEquipos11.substring(0, textoEquipos11.length - 1);
                                                textoEquipos12 = textoEquipos12.substring(0, textoEquipos12.length - 1);
                                                textoEquipos13 = textoEquipos13.substring(0, textoEquipos13.length - 1);
                                                textoEquipos14 = textoEquipos14.substring(0, textoEquipos14.length - 1);
                                                textoEquipos15 = textoEquipos15.substring(0, textoEquipos15.length - 1);
                                                textoEquipos16 = textoEquipos16.substring(0, textoEquipos16.length - 1);
                                                textoEquipos17 = textoEquipos17.substring(0, textoEquipos17.length - 1);
                                                textoEquipos18 = textoEquipos18.substring(0, textoEquipos18.length - 1);
                                                textoEquipos19 = textoEquipos19.substring(0, textoEquipos19.length - 1);
                                                textoEquipos20 = textoEquipos20.substring(0, textoEquipos20.length - 1);
                                                textoEquipos21 = textoEquipos21.substring(0, textoEquipos21.length - 1);
                                                textoEquipos22 = textoEquipos22.substring(0, textoEquipos22.length - 1);
                                                textoEquipos23 = textoEquipos23.substring(0, textoEquipos23.length - 1);
                                                textoEquipos24 = textoEquipos24.substring(0, textoEquipos24.length - 1);
                                                textoEquipos25 = textoEquipos25.substring(0, textoEquipos25.length - 1);
                                                textoEquipos26 = textoEquipos26.substring(0, textoEquipos26.length - 1);
                                                textoEquipos27 = textoEquipos27.substring(0, textoEquipos27.length - 1);
                                                textoEquipos28 = textoEquipos28.substring(0, textoEquipos28.length - 1);
                                                textoEquipos29 = textoEquipos29.substring(0, textoEquipos29.length - 1);
                                                textoEquipos30 = textoEquipos30.substring(0, textoEquipos30.length - 1);
                                                textoEquipos31 = textoEquipos31.substring(0, textoEquipos31.length - 1);
                                                textoEquipos32 = textoEquipos32.substring(0, textoEquipos32.length - 1);
                                                textoEquipos33 = textoEquipos33.substring(0, textoEquipos33.length - 1);
                                                textoEquipos34 = textoEquipos34.substring(0, textoEquipos34.length - 1);
                                                textoEquipos35 = textoEquipos35.substring(0, textoEquipos35.length - 1);
                                                textoEquipos36 = textoEquipos36.substring(0, textoEquipos36.length - 1);
                                                textoEquipos37 = textoEquipos37.substring(0, textoEquipos37.length - 1);
                                                textoEquipos38 = textoEquipos38.substring(0, textoEquipos38.length - 1);
                                                textoEquipos39 = textoEquipos39.substring(0, textoEquipos39.length - 1);
                                                textoEquipos40 = textoEquipos40.substring(0, textoEquipos40.length - 1);
                                                textoEquipos41 = textoEquipos41.substring(0, textoEquipos41.length - 1);
                                                textoEquipos42 = textoEquipos42.substring(0, textoEquipos42.length - 1);
                                                textoEquipos43 = textoEquipos43.substring(0, textoEquipos43.length - 1);
                                                textoEquipos44 = textoEquipos44.substring(0, textoEquipos44.length - 1);
                                                textoEquipos45 = textoEquipos45.substring(0, textoEquipos45.length - 1);
                                                textoEquipos46 = textoEquipos46.substring(0, textoEquipos46.length - 1);
                                                textoEquipos47 = textoEquipos47.substring(0, textoEquipos47.length - 1);
                                                textoEquipos48 = textoEquipos48.substring(0, textoEquipos48.length - 1);
                                                textoEquipos49 = textoEquipos49.substring(0, textoEquipos49.length - 1);
                                                textoEquipos50 = textoEquipos50.substring(0, textoEquipos50.length - 1);
                                                textoEquipos51 = textoEquipos51.substring(0, textoEquipos51.length - 1);
                                                textoEquipos52 = textoEquipos52.substring(0, textoEquipos52.length - 1);
                                                textoEquipos53 = textoEquipos53.substring(0, textoEquipos53.length - 1);
                                                textoEquipos54 = textoEquipos54.substring(0, textoEquipos54.length - 1);
                                                textoEquipos55 = textoEquipos55.substring(0, textoEquipos55.length - 1);
                                                textoEquipos56 = textoEquipos56.substring(0, textoEquipos56.length - 1);
                                                textoEquipos57 = textoEquipos57.substring(0, textoEquipos57.length - 1);

                                                textoEquipos3 = textoEquipos3 + ')';
                                                textoEquipos4 = textoEquipos4 + ')';
                                                textoEquipos5 = textoEquipos5 + ')';
                                                textoEquipos6 = textoEquipos6 + ')';
                                                textoEquipos7 = textoEquipos7 + ')';
                                                textoEquipos8 = textoEquipos8 + ')';
                                                textoEquipos9 = textoEquipos9 + ')';
                                                textoEquipos10 = textoEquipos10 + ')';
                                                textoEquipos11 = textoEquipos11 + ')';
                                                textoEquipos12 = textoEquipos12 + ')';
                                                textoEquipos13 = textoEquipos13 + ')';
                                                textoEquipos14 = textoEquipos14 + ')';
                                                textoEquipos15 = textoEquipos15 + ')';
                                                textoEquipos16 = textoEquipos16 + ')';
                                                textoEquipos17 = textoEquipos17 + ')';
                                                textoEquipos18 = textoEquipos18 + ')';
                                                textoEquipos19 = textoEquipos19 + ')';
                                                textoEquipos20 = textoEquipos20 + ')';
                                                textoEquipos21 = textoEquipos21 + ')';
                                                textoEquipos22 = textoEquipos22 + ')';
                                                textoEquipos23 = textoEquipos23 + ')';
                                                textoEquipos24 = textoEquipos24 + ')';
                                                textoEquipos25 = textoEquipos25 + ')';
                                                textoEquipos26 = textoEquipos26 + ')';
                                                textoEquipos27 = textoEquipos27 + ')';
                                                textoEquipos28 = textoEquipos28 + ')';
                                                textoEquipos29 = textoEquipos29 + ')';
                                                textoEquipos30 = textoEquipos30 + ')';
                                                textoEquipos31 = textoEquipos31 + ')';
                                                textoEquipos32 = textoEquipos32 + ')';
                                                textoEquipos33 = textoEquipos33 + ')';
                                                textoEquipos34 = textoEquipos34 + ')';
                                                textoEquipos35 = textoEquipos35 + ')';
                                                textoEquipos36 = textoEquipos36 + ')';
                                                textoEquipos37 = textoEquipos37 + ')';
                                                textoEquipos38 = textoEquipos38 + ')';
                                                textoEquipos39 = textoEquipos39 + ')';
                                                textoEquipos40 = textoEquipos40 + ')';
                                                textoEquipos41 = textoEquipos41 + ')';
                                                textoEquipos42 = textoEquipos42 + ')';
                                                textoEquipos43 = textoEquipos43 + ')';
                                                textoEquipos44 = textoEquipos44 + ')';
                                                textoEquipos45 = textoEquipos45 + ')';
                                                textoEquipos46 = textoEquipos46 + ')';
                                                textoEquipos47 = textoEquipos47 + ')';
                                                textoEquipos48 = textoEquipos48 + ')';
                                                textoEquipos49 = textoEquipos49 + ')';
                                                textoEquipos50 = textoEquipos50 + ')';
                                                textoEquipos51 = textoEquipos51 + ')';
                                                textoEquipos52 = textoEquipos52 + ')';
                                                textoEquipos53 = textoEquipos53 + ')';
                                                textoEquipos54 = textoEquipos54 + ')';
                                                textoEquipos55 = textoEquipos55 + ')';
                                                textoEquipos56 = textoEquipos56 + ')';
                                                textoEquipos57 = textoEquipos57 + ')';
                                            }
                                   }
                                   else{

                                        textoEquipos3 = pp($scope.equipo[x].valoresservicio1);
                                        textoEquipos4 = pp($scope.equipo[x].valoresservicio2);
                                        textoEquipos5 = pp($scope.equipo[x].valoresservicio3);
                                        textoEquipos6 = pp($scope.equipo[x].atr7);
                                        textoEquipos7 = pp($scope.equipo[x].atr10);
                                        textoEquipos8 = pp($scope.equipo[x].atr1);
                                        textoEquipos9 = pp($scope.equipo[x].atr4);
                                        textoEquipos10 = pp($scope.equipo[x].valoresservicio6);
                                        textoEquipos11 = pp($scope.equipo[x].valoresservicio7);
                                        textoEquipos12 = pp($scope.equipo[x].valoresservicio8);
                                        textoEquipos13 = pp($scope.equipo[x].valoresservicio9);
                                        textoEquipos14 = pp($scope.equipo[x].valoresservicio10);
                                        textoEquipos15 = pp($scope.equipo[x].valoresservicio11);
                                        textoEquipos16 = pp($scope.equipo[x].valoresservicio12);
                                        textoEquipos17 = pp($scope.equipo[x].valoresservicio13);
                                        textoEquipos18 = pp($scope.equipo[x].valoresservicio14);
                                        textoEquipos19 = pp($scope.equipo[x].valoresservicio15);
                                        textoEquipos20 = pp($scope.equipo[x].valoresservicio16);
                                        textoEquipos21 = pp($scope.equipo[x].valoresservicio17);
                                        textoEquipos22 = pp($scope.equipo[x].valoresservicio18);
                                        textoEquipos23 = pp($scope.equipo[x].valoresservicio19);
                                        textoEquipos24 = pp($scope.equipo[x].valoresservicio20);
                                        textoEquipos25 = pp($scope.equipo[x].valoresservicio21);
                                        textoEquipos26 = pp($scope.equipo[x].valoresservicio22);
                                        textoEquipos27 = pp($scope.equipo[x].valoresservicio23);
                                        textoEquipos28 = pp($scope.equipo[x].valoresservicio24);
                                        textoEquipos29 = pp($scope.equipo[x].valoresservicio25);
                                        textoEquipos30 = pp($scope.equipo[x].valoresservicio26);
                                        textoEquipos31 = pp($scope.equipo[x].valoresservicio27);
                                        textoEquipos32 = pp($scope.equipo[x].valoresservicio28);
                                        textoEquipos33 = pp($scope.equipo[x].valoresservicio29);
                                        textoEquipos34 = pp($scope.equipo[x].valoresservicio30);
                                        textoEquipos35 = pp($scope.equipo[x].valoresservicio31);
                                        textoEquipos36 = pp($scope.equipo[x].valoresservicio32);
                                        textoEquipos37 = pp($scope.equipo[x].valoresservicio33);
                                        textoEquipos38 = pp($scope.equipo[x].valoresservicio34);
                                        textoEquipos39 = pp($scope.equipo[x].valoresservicio35);
                                        textoEquipos40 = pp($scope.equipo[x].valoresservicio36);
                                        textoEquipos41 = pp($scope.equipo[x].valoresservicio37);
                                        textoEquipos42 = pp($scope.equipo[x].valoresservicio38);
                                        textoEquipos43 = pp($scope.equipo[x].valoresservicio39);
                                        textoEquipos44 = pp($scope.equipo[x].valoresservicio40);
                                        textoEquipos45 = pp($scope.equipo[x].valoresservicio41);
                                        textoEquipos46 = pp($scope.equipo[x].valoresservicio42);
                                        textoEquipos47 = pp($scope.equipo[x].valoresservicio43);
                                        textoEquipos48 = pp($scope.equipo[x].valoresservicio44);
                                        textoEquipos49 = pp($scope.equipo[x].valoresservicio45);
                                        textoEquipos50 = pp($scope.equipo[x].valoresservicio46);
                                        textoEquipos51 = pp($scope.equipo[x].valoresservicio47);
                                        textoEquipos52 = pp($scope.equipo[x].valoresservicio48);
                                        textoEquipos53 = pp($scope.equipo[x].valoresservicio49);
                                        textoEquipos54 = pp($scope.equipo[x].valoresservicio50);
                                        textoEquipos55 = pp($scope.equipo[x].valoresservicio51);
                                        textoEquipos56 = pp($scope.equipo[x].valoresservicio52);
                                        textoEquipos57 = pp($scope.equipo[x].valoresservicio53);
                                  }
                                    textoEquipos += '       ' + textoEquipos3 + ' //Fabricante\r\n';
                                    
                                    textoEquipos += '       ' + textoEquipos4 + ' //MODELO\r\n';
                                    
                                    textoEquipos += '       ' + textoEquipos5 + ' //TIPO \r\n';
                                    textoEquipos += '       1 //Precio_euros\r\n';
                                    textoEquipos += '       ' + pp($scope.equipo[x].numequiposiguales) + ' //Numero_Equipos\r\n';
                                    
                                    if (idServicio == "32") {
                                        if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg != "-") {
                                            textoEquipos += '       ' + textoEquipos7 + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                            textoEquipos += '       ' + textoEquipos6 + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                            contEquiposCasos++;
                                            contEquiposCasos++;
                                        } else {
                                            if ($scope.equipo[x].busa != "-") {
                                                if (tempbusamax > 12) {
                                                    textoEquipos += '       ' + pp($scope.equipo[x].atr10) + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                                    textoEquipos += '       ' + textoEquipos6 + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                                    contEquiposCasos++;
                                                } else {
                                                    textoEquipos += '       ' + textoEquipos7 + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                                    textoEquipos += '       ' + pp($scope.equipo[x].atr7) + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                                    contEquiposCasos++;
                                                }
                                            } else {
                                                if (tempbusamax > 12) {
                                                    textoEquipos += '       ' + pp($scope.equipo[x].atr10) + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                                    textoEquipos += '       ' + textoEquipos6 + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                                    contEquiposCasos++;
                                                } else {
                                                    textoEquipos += '       ' + textoEquipos7 + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                                    textoEquipos += '       ' + pp($scope.equipo[x].atr7) + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                                    contEquiposCasos++;
                                                }
                                            }
                                        }
                                    } else if (idServicio == "33") {
                                        textoEquipos += '       ' + textoEquipos7 + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                        textoEquipos += '       ' + textoEquipos6 + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                        contEquiposCasos++;
                                        contEquiposCasos++;
                                    } else if (idServicio == "34") {
                                        textoEquipos += '       ' + textoEquipos7 + ' //Capacidad_Nominal_Refrigeracion_kW\r\n';
                                        textoEquipos += '       ' + pp($scope.equipo[x].atr7) + ' //Capacidad_Nominal_Calefaccion_kW\r\n';
                                        contEquiposCasos++;
                                    }
                                    textoEquipos += '       ' + textoEquipos9 + ' //EER_Nominal\r\n';
                                    textoEquipos += '       ' + textoEquipos8 + ' //COP_Nominal\r\n';
                                    textoEquipos += '       ' + '       1 //FactorUso\r\n';
                                    textoEquipos += '       ' + '       5.00 //Diferencia de Temperatura para cálculo de flujo másico\r\n';
                                    textoEquipos += '       ' + textoEquipos10 + ' //Temperatura_Impulsion_Agua_Max_Refrigeracion\r\n';
                                    textoEquipos += '       ' + textoEquipos11 + ' //Temperatura_Impulsion_Min_Refrigeracion\r\n';
                                    textoEquipos += '       ' + '       7 //Temperatura consigna de Refrigeración\r\n';
                                    textoEquipos += '       ' + textoEquipos12 + ' //Temperatura_Impulsion_agua_Max_Calefaccion\r\n';
                                    textoEquipos += '       ' + textoEquipos13 + ' //Temperatura_Impulsion_Min_Calefaccion\r\n';
                                    textoEquipos += '       ' + '       42 //Temperatura consigna de Recuperación\r\n';
                                    textoEquipos += '       ' + textoEquipos14 + ' //PRL_min\r\n';
                                    textoEquipos += '       1 //PLR_opt\r\n';
                                    textoEquipos += '       ' + textoEquipos15 + ' //PRL_max\r\n';
                                    textoEquipos += '       ' + textoEquipos16 + ' //Curva_1_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos17 + ' //Curva_1_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos18 + ' //Curva_1_P2\r\n';
                                    textoEquipos += '       ' + textoEquipos19 + ' //Curva_1_P3\r\n';
                                    textoEquipos += '       ' + textoEquipos20 + ' //Curva_1_P4\r\n';
                                    textoEquipos += '       ' + textoEquipos21 + ' //Curva_1_P5\r\n';
                                    textoEquipos += '       ' + textoEquipos22 + ' //Curva_2_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos23 + ' //Curva_2_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos24 + '//Curva_2_P2\r\n';
                                    textoEquipos += '       ' + textoEquipos25 + '//Curva_2_P3\r\n';
                                    textoEquipos += '       ' + textoEquipos26 + '//Curva_2_P4\r\n';
                                    textoEquipos += '       ' + textoEquipos27 + '//Curva_2_P5\r\n';
                                    textoEquipos += '       ' + textoEquipos40 + '//Curva_5_P_0\r\n';
                                    textoEquipos += '       ' + textoEquipos41 + '//Curva_5_P_1\r\n';
                                    textoEquipos += '       ' + textoEquipos42 + '//Curva_5_P_2\r\n';
                                    textoEquipos += '       ' + textoEquipos43 + '//Curva_5_P_3\r\n';
                                    textoEquipos += '       ' + textoEquipos44 + '//Curva_5_P_4\r\n';
                                    textoEquipos += '       ' + textoEquipos45 + '//Curva_5_P_5\r\n';
                                    textoEquipos += '       ' + textoEquipos52 + ' //Curva_7_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos53 + ' //Curva_7_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos54 + ' //Curva_7_P2\r\n';
                                    textoEquipos += '       ' + textoEquipos55 + ' //Curva_7_P3\r\n';
                                    textoEquipos += '       ' + textoEquipos56 + '//Curva_7_P4\r\n';
                                    textoEquipos += '       ' + textoEquipos57 + '//Curva_7_P5\r\n';
                                    textoEquipos += '       ' + textoEquipos28 + '//Curva_3_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos29 + '//Curva_3_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos30 + '//Curva_3_P2\r\n';
                                    textoEquipos += '       ' + textoEquipos31 + '//Curva_3_P3\r\n';
                                    textoEquipos += '       ' + textoEquipos32 + '//Curva_3_P4\r\n';
                                    textoEquipos += '       ' + textoEquipos33 + '//Curva_3_P5\r\n';
                                    textoEquipos += '       ' + textoEquipos34 + '//Curva_4_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos35 + '//Curva_4_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos36 + '//Curva_4_P2\r\n';
                                    textoEquipos += '       ' + textoEquipos37 + '//Curva_4_P3\r\n';
                                    textoEquipos += '       ' + textoEquipos38 + '//Curva_4_P4\r\n';
                                    textoEquipos += '       ' + textoEquipos39 + '//Curva_4_P5\r\n';
                                    textoEquipos += '       ' + textoEquipos46 + '//Curva_6_P0\r\n';
                                    textoEquipos += '       ' + textoEquipos47 + '//Curva_6_P1\r\n';
                                    textoEquipos += '       ' + textoEquipos48 + '//Curva_6_P2\r\n';
                                    textoEquipos += '       ' + textoEquipos49 + '//Curva_6_P3\r\n';
                                    textoEquipos += '       ' + textoEquipos50 + '//Curva_6_P4\r\n';
                                    textoEquipos += '       ' + textoEquipos51 + '//Curva_6_P5\r\n';
                                    if (numBombas > 1) {
                                        numcasosParametricos.push(numBombas);
                                    }

                                    if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg != "-") {
                                        if (parseFloat(tempbusgmax) > parseFloat(tempbusamax)) {
                                            ley.push($scope.equipo[x].nombreequipo);
                                            //textoEquipos += '       ' + tempbusamin + '\r\n';
                                            var existe = false;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == tempbusamax) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push(tempbusamax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            if (busAlimenta != "7" &amp;&amp; busAlimenta != "8") {
                                                ley.push("ACTIVACION-CALOR");
                                                ley.push(tempbusamax);
                                                ley.push(tempbusamin);
                                                ley.push($scope.equipo[x].busa);
                                                ley.push('L' + (contEquipos));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesCalor.push(ley);
                                                ley = [];
                                            } else {
                                                ley.push("ACTIVACION-FRIO");
                                                ley.push(tempbusamax);
                                                ley.push(tempbusamin);
                                                ley.push($scope.equipo[x].busa);
                                                ley.push('L' + (contEquipos));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesFrio.push(ley);
                                                ley = [];
                                            }
                                            ley.push($scope.equipo[x].nombreequipo);
                                            //textoEquipos += '       ' + tempbusgmax + '\r\n';
                                            var existe = false;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == tempbusgmax) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push(tempbusgmax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            if (busGenera != "7" &amp;&amp; busGenera != "8") {
                                                ley.push("ACTIVACION-CALOR");
                                                ley.push(tempbusgmax);
                                                ley.push(tempbusgmin);
                                                ley.push($scope.equipo[x].busg);
                                                ley.push('L' + (contEquipos + 1));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesCalor.push(ley);
                                                ley = [];
                                            } else {
                                                ley.push("ACTIVACION-FRIO");
                                                ley.push(tempbusgmax);
                                                ley.push(tempbusgmin);
                                                ley.push($scope.equipo[x].busg);
                                                ley.push('L' + (contEquipos + 1));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesFrio.push(ley);
                                                ley = [];
                                            }
                                        } else {
                                            ley.push($scope.equipo[x].nombreequipo);
                                            //textoEquipos += '       ' + tempbusgmax + '\r\n';
                                            var existe = false;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == tempbusgmax) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push(tempbusgmax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push(tempbusgmax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            if (busGenera != "7" &amp;&amp; busGenera != "8") {
												if(idServicio != "34"){
                                                ley.push("ACTIVACION-CALOR");
                                                ley.push(tempbusgmax);
                                                ley.push(tempbusgmin);
                                                ley.push($scope.equipo[x].busg);
                                                ley.push('L' + (contEquipos));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesCalor.push(ley);
                                                ley = [];
												}
                                            } else {
                                                ley.push("ACTIVACION-FRIO");
                                                ley.push(tempbusgmax);
                                                ley.push(tempbusgmin);
                                                ley.push($scope.equipo[x].busg);
                                                ley.push('L' + (contEquipos));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesFrio.push(ley);
                                                ley = [];
                                            }
                                            ley.push($scope.equipo[x].nombreequipo);
                                            //textoEquipos += '       ' + tempbusamin + '\r\n';
                                            var existe = false;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == tempbusamax) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push(tempbusamax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            if (busAlimenta != "7" &amp;&amp; busAlimenta != "8") {
												if(idServicio != "34"){
                                                ley.push("ACTIVACION-CALOR");
                                                ley.push(tempbusamax);
                                                ley.push(tempbusamin);
                                                ley.push($scope.equipo[x].busa);
                                                ley.push('L' + (contEquipos + 1));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesCalor.push(ley);
                                                ley = [];
												}
                                            } else {
                                                ley.push("ACTIVACION-FRIO");
                                                ley.push(tempbusamax);
                                                ley.push(tempbusamin);
                                                ley.push($scope.equipo[x].busa);
                                                ley.push('L' + (contEquipos + 1));

                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesFrio.push(ley);
                                                ley = [];
                                            }
                                        }

                                    } 
                                    else {
                                        if ($scope.equipo[x].busa != "-") {
                                            ley.push($scope.equipo[x].nombreequipo);
                                            //textoEquipos += '       ' + tempbusamin + '\r\n';
                                            var existe = false;
                                            if (temperaturas.length > 0) {
                                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                                    if (temperaturas[z][0] == tempbusamax) {
                                                        existe = true;
                                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                                    }
                                                }
                                                if (existe == false) {
                                                    temperatura.push(tempbusamax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                            } else {
                                                temperatura.push(tempbusamax);
                                                temperatura.push(1);
                                                temperatura.push(1);
                                                temperaturas.push(temperatura);
                                                temperatura = [];
                                            }
                                            if (busAlimenta != "7" &amp;&amp; busAlimenta != "8") {
												if(idServicio != "34"){
                                                ley.push("ACTIVACION-CALOR");
                                                ley.push(tempbusamax);
                                                ley.push(tempbusamin);
                                                ley.push($scope.equipo[x].busa);
                                                ley.push('L' + (contEquipos));
                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesCalor.push(ley);
                                                ley = [];
												}
                                            } else {
                                                ley.push("ACTIVACION-FRIO");
                                                ley.push(tempbusamax);
                                                ley.push(tempbusamin);
                                                ley.push($scope.equipo[x].busa);
                                                ley.push('L' + (contEquipos));
                                                ley.push(1);
                                                ley.push(idServicio);
                                                leyesFrio.push(ley);
                                                ley = [];
                                            }

                                        }
                                        else {
                                            if ($scope.equipo[x].busg != "-") {
                                                ley.push($scope.equipo[x].nombreequipo);
                                                //textoEquipos += '       ' + tempbusgmax + '\r\n';
                                                var existe = false;
                                                if (temperaturas.length > 0) {
                                                    for (var z = 0; z &lt; temperaturas.length; z++) {
                                                        if (temperaturas[z][0] == tempbusgmax) {
                                                            existe = true;
                                                            temperaturas[z][1] = temperaturas[z][1] + 1;
                                                        }
                                                    }
                                                    if (existe == false) {
                                                        temperatura.push(tempbusgmax);
                                                        temperatura.push(1);
                                                        temperatura.push(1);
                                                        temperaturas.push(temperatura);
                                                        temperatura = [];
                                                    }
                                                } else {
                                                    temperatura.push(tempbusgmax);
                                                    temperatura.push(1);
                                                    temperatura.push(1);
                                                    temperaturas.push(temperatura);
                                                    temperatura = [];
                                                }
                                                if (busGenera != "7" &amp;&amp; busGenera != "8") {
													if(idServicio != "34"){
                                                    ley.push("ACTIVACION-CALOR");
                                                    ley.push(tempbusgmax);
                                                    ley.push(tempbusgmin);
                                                    ley.push($scope.equipo[x].busg);
                                                    ley.push('L' + (contEquipos));
                                                    ley.push(1);
                                                    ley.push(idServicio);
                                                    leyesCalor.push(ley);
                                                    ley = [];
													}
                                                } else {
                                                    ley.push("ACTIVACION-FRIO");
                                                    ley.push(tempbusgmax);
                                                    ley.push(tempbusgmin);
                                                    ley.push($scope.equipo[x].busg);
                                                    ley.push('L' + (contEquipos));
                                                    ley.push(1);
                                                    ley.push(idServicio);
                                                    leyesFrio.push(ley);
                                                    ley = [];
                                                }
                                            }
                                        }
                                    }
                                    if ($scope.equipo[x].busa != "-" &amp;&amp; $scope.equipo[x].busg != "-") {
                                            textoEquipos += '       L' + contEquipos + ' //Ley de control primera\r\n';
                                            oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
                                            contEquipos++;
											if(idServicio != "34"){
											textoEquipos += '       L' + contEquipos + ' //Ley de control segunda\r\n';
                                        oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
                                        contEquipos++;
											}else{
												textoEquipos += '		//Ley de control segunda\r\n';
											}
                                    } else {
                                        if ($scope.equipo[x].busa != "-") {
                                            if (busAlimenta != "7" &amp;&amp; busAlimenta != "8"){
                                             
                                            textoEquipos += '       //Ley de control primera\r\n';
                                                textoEquipos += '         L' + contEquipos + '  //Ley de control segunda\r\n';
                                            oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
                                            contEquipos++;
                                            
                                        } else {
                                                textoEquipos += '       L' + contEquipos + '//Ley de control primera\r\n';
                                                textoEquipos += '       //Ley de control segunda\r\n';
                                                oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
                                                contEquipos++;
                                        }
                                    }else {
                                    if ($scope.equipo[x].busg != "-") {
                                        if (busGenera != "7" &amp;&amp; busGenera != "8") {
                                            textoEquipos += '       //Ley de control primera\r\n';
                                            textoEquipos += '           L' + contEquipos + '//Ley de control segunda\r\n';
											oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
											contEquipos++;
                                        } else {
                                                    textoEquipos += '       L' + contEquipos + '//Ley de control primera\r\n';
                                                    textoEquipos += '       //Ley de control segunda\r\n';
                                                    oLeyes.aLeyes.push('L' + contEquipos);// MMR:AñADIR LEY
                                                    contEquipos++;
                                                }
                                            }
                                        }
                                    }
                                    textoEquipos += '       \r\n';
                                    Aleyesdecontrol.push(oLeyes);
                                    oLeyes = new Ley();
                                    textoEquipos3 = '(';
                                    textoEquipos4 = '(';
                                    textoEquipos5 = '(';
                                    textoEquipos6 = '(';
                                    textoEquipos7 = '(';
                                    textoEquipos8 = '(';
                                    textoEquipos9 = '(';
                                    textoEquipos10 = '(';
                                    textoEquipos11 = '(';
                                    textoEquipos12 = '(';
                                    textoEquipos13 = '(';
                                    textoEquipos14 = '(';
                                    textoEquipos15 = '(';
                                    textoEquipos16 = '(';
                                    textoEquipos17 = '(';
                                    textoEquipos18 = '(';
                                    textoEquipos19 = '(';
                                    textoEquipos20 = '(';
                                    textoEquipos21 = '(';
                                    textoEquipos22 = '(';
                                    textoEquipos23 = '(';
                                    textoEquipos24 = '(';
                                    textoEquipos25 = '(';
                                    textoEquipos26 = '(';
                                    textoEquipos27 = '(';
                                    textoEquipos28 = '(';
                                    textoEquipos29 = '(';
                                    textoEquipos30 = '(';
                                    textoEquipos31 = '(';
                                    textoEquipos32 = '(';
                                    textoEquipos33 = '(';
                                    textoEquipos34 = '(';
                                    textoEquipos35 = '(';
                                    textoEquipos36 = '(';
                                    textoEquipos37 = '(';
                                    textoEquipos38 = '(';
                                    textoEquipos39 = '(';
                                    textoEquipos40 = '(';
                                    textoEquipos41 = '(';
                                    textoEquipos42 = '(';
                                    textoEquipos43 = '(';
                                    textoEquipos44 = '(';
                                    textoEquipos45 = '(';
                                    textoEquipos46 = '(';
                                    textoEquipos36 = '(';
                                    textoEquipos47 = '(';
                                    textoEquipos48 = '(';
                                    textoEquipos49 = '(';
                                    textoEquipos50 = '(';
                                    textoEquipos51 = '(';
                                    textoEquipos52 = '(';
                                    textoEquipos53 = '(';
                                    textoEquipos54 = '(';
                                    textoEquipos55 = '(';
                                    textoEquipos56 = '(';
                                    textoEquipos57 = '(';
                                }

                            }

                        }
                    }
                    }
                    funcionmickael = function () {
                        //Sacamos la temperatura de asignada a los equipos
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            if ($scope.equipo[x].nombre == "Calefacción Media" &amp;&amp; $scope.equipo[x].nuex == "Nuevo") {
                                busgf = $scope.equipo[x].busa;
                                media = true;
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp;
                                        "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                        tempfGM = parseFloat($scope.busesCaso[y].tempmax);
                                        tempfGm = parseFloat($scope.busesCaso[y].tempmin);
                                        busGenera = $scope.busesCaso[y].idbus;
                                        if (hayfantasma == true &amp;&amp; busGenera == "3") {
                                            tempfGM += 5;
                                            tempfGm += 5;
                                        }
                                        break;
                                    }
                                }
                            }
                            if ($scope.equipo[x].nombre == "ACS" &amp;&amp; $scope.equipo[x].nuex == "Nuevo") {
                                busaf = $scope.equipo[x].busa;
                                servacs = true;
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp;
                                        "Nuevo" == $scope.busesCaso[y].nuex &amp;&amp; "Nuevo" == $scope.equipo[x].nuex &amp;&amp; idCaso == $scope.equipo[x].idcaso) {
                                        tempfAM = parseFloat($scope.busesCaso[y].tempmax);
                                        tempfAm = parseFloat($scope.busesCaso[y].tempmin);
                                        busAlimenta = $scope.busesCaso[y].idbus;
                                        if (hayfantasma == true &amp;&amp; busAlimenta == "3") {
                                            tempfAM += 5;
                                            tempfAm += 5;
                                        }
                                        break;
                                    }
                                }
                            }
                            if ($scope.equipo[x].nombre == "Caldera condensación") {
                                conden = true;
                            }
                        }
                        //Creamos el intercambiador fantasma
                        textoEquipos += '[COMPLEMENTO=Intercambiadores] //El nombre del complemento coincide con el nombre de la tabla de dichos complementos\r\n';
                        oLeyes.nombre = ' ICfantasma';
                        var textoEquipos2 = "";
                        textoEquipos += '       16 //Número de datos\r\n';
                        ley.push(' ICfantasma');
                        textoEquipos += '       ICfantasma //Nombre del complemento\r\n';


                        textoEquipos2 += '       ' + busgf + ' //Nombre del colector\r\n';
                        textoEquipos2 += '       ' + busaf + ' //Nombre del colector\r\n';

                        textoEquipos += '       2 //Número de colectores a los que está conectado\r\n';
                        textoEquipos += textoEquipos2;
                        textoEquipos += '       0 //id en Base de Datos\r\n';
                        textoEquipos += '       16 //idComplemento\r\n';
                        textoEquipos += '       PIDIM //Fabricante\r\n';
                        textoEquipos += '       PIDIM //MODELO\r\n';
                        textoEquipos += '       PIDIM //TIPO \r\n';

                        textoEquipos += '       1 //Volumen_m3\r\n';
                        textoEquipos += '       0.8 //Efectividad constante\r\n';
                        textoEquipos += '       200.0 //Potencia_Util_kW  \r\n';
                        textoEquipos += '       5.0 //Diferencia de Temperatura para cálculo de flujo másico \r\n';

                        if (tempfGM > tempfAM) {
                            textoEquipos += '       ' + tempfAM + ' //Temperatura de consigna 	\r\n';
                            var existe = false;
                            if (temperaturas.length > 0) {
                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                    if (temperaturas[z][0] == tempfAM) {
                                        existe = true;
                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                    }
                                }
                                if (existe == false) {
                                    temperatura.push(tempfAM);
                                    temperatura.push(1);
                                    temperatura.push(1);
                                    temperaturas.push(temperatura);
                                    temperatura = [];
                                }
                            } else {
                                temperatura.push(tempfAM);
                                temperatura.push(1);
                                temperatura.push(1);
                                temperaturas.push(temperatura);
                                temperatura = [];
                            }
                            ley.push("ACTIVACION-FRIO");

                            ley.push(tempfAM);
                            ley.push(tempfAm);
                            ley.push(busaf);
                            ley.push('L' + contEquipos);
                            ley.push(3);
                            ley.push("16");
                            leyesCalor.push(ley);
                            oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                            Aleyesdecontrol.push(oLeyes);
                            oLeyes = new Ley();
                            ley = [];

                            ley.push(' ICfantasma');
                            ley.push("ACTIVACION-FRIO");

                            ley.push(tempfGM);
                            ley.push(tempfGm);
                            ley.push(busgf);
                            ley.push('L' + contEquipos);
                            ley.push(3);
                            ley.push("16");
                            leyesCalor.push(ley);
                            oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                            Aleyesdecontrol.push(oLeyes);
                            oLeyes = new Ley();
                            ley = [];
                            var existe = false;
                            if (temperaturas.length > 0) {
                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                    if (temperaturas[z][0] == tempfAM) {
                                        existe = true;
                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                    }
                                }
                                if (existe == false) {
                                    temperatura.push(tempfAM);
                                    temperatura.push(1);
                                    temperatura.push(1);
                                    temperaturas.push(temperatura);
                                    temperatura = [];
                                }
                            } else {
                                temperatura.push(tempfAM);
                                temperatura.push(1);
                                temperatura.push(1);
                                temperaturas.push(temperatura);
                                temperatura = [];
                            }



                        }
                        else {
                            textoEquipos += '       ' + tempfGM + ' //Temperatura de consigna 	\r\n';
                            var existe = false;
                            if (temperaturas.length > 0) {
                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                    if (temperaturas[z][0] == tempfGM) {
                                        existe = true;
                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                    }
                                }
                                if (existe == false) {
                                    temperatura.push(tempfGM);
                                    temperatura.push(1);
                                    temperatura.push(1);
                                    temperaturas.push(temperatura);
                                    temperatura = [];
                                }
                            } else {
                                temperatura.push(tempfGM);
                                temperatura.push(1);
                                temperatura.push(1);
                                temperaturas.push(temperatura);
                                temperatura = [];
                            }
                            ley.push("ACTIVACION-FRIO");

                            ley.push(tempfGM);
                            ley.push(tempfGm);
                            ley.push(busgf);
                            ley.push('L' + contEquipos);
                            ley.push(3);
                            ley.push(idComplemento);
                            leyesCalor.push(ley);
                            oLeyes.aLeyes.push('L' + contEquipos);// MMR: ESTA Y LAS 2 LINEAS INFERIORES TIENEN QUE ESTAR PARA PASARME UNA LEY, SI HAY DOS LEYS PARA UN MISMO EQUIPO, LA 2º ES ley2 (oLeyes.ley2)
                            Aleyesdecontrol.push(oLeyes);
                            oLeyes = new Ley();
                            ley = [];

                            var existe = false;
                            if (temperaturas.length > 0) {
                                for (var z = 0; z &lt; temperaturas.length; z++) {
                                    if (temperaturas[z][0] == tempfGM) {
                                        existe = true;
                                        temperaturas[z][1] = temperaturas[z][1] + 1;
                                    }
                                }
                                if (existe == false) {
                                    temperatura.push(tempfGM);
                                    temperatura.push(1);
                                    temperatura.push(1);
                                    temperaturas.push(temperatura);
                                    temperatura = [];
                                }
                            } else {
                                temperatura.push(tempfGM);
                                temperatura.push(1);
                                temperatura.push(1);
                                temperaturas.push(temperatura);
                                temperatura = [];
                            }

                        }




                        textoEquipos += '       550 //Precio (€) \r\n';
                        textoEquipos += '       L' + contEquipos + ' //Ley de control\r\n';

                        textoEquipos += '       \r\n';
                        contEquipos++;
                    }
                for (var j = 0; j &lt; $scope.busesCaso.length; j++) {
                    if ("Nuevo" == $scope.busesCaso[j].nuex) {
                        porC += parseFloat($scope.busesCaso[j].consumoc);
                        porF += parseFloat($scope.busesCaso[j].consumof);
                        porACS += parseFloat($scope.busesCaso[j].consumoacs);
                    }
                }
                if (porC &lt;= 100.0 &amp;&amp; porF &lt;= 100.0 &amp;&amp; porACS &lt;= 100.0) {
                
                    // -CODIGO MANUEL-
                    //ARCHIVO FOTIM
                    var Apanel = new Array();
                    var Acamposolar = new Array();
                    var Ainvbat = new Array();
                    var FVpredim;
                    var FValternativa;
                    var TFOTIM = '';
                    var clima;
                    var casoProvincia;
                    var numelectrico = 0;
                    var servelectrico = new Array();
                    var tservicio = '';
                    var Anombre = new Array();
                    for (var x = 0; x &lt; $scope.caso.length; x++) {
                        if ($scope.caso[x].id == idCaso) {
                            clima = $scope.caso[x].clima;
                            casoProvincia = $scope.caso[x].provincia; // SIN ACENTO
                        }
                    }
                    switch (clima) {
                        case "a1":
                            clima = "Alfa1";
                            break;
                        case "a2":
                            clima = "Alfa2";
                            break;
                        case "a3":
                            clima = "Alfa3";
                            break;
                        case "a4":
                            clima = "Alfa4";
                            break;
                    }
                    for (var conteq = 0; conteq &lt; $scope.equipo.length; conteq++) {
                        var equipoactual = $scope.equipo[conteq];
                        if (equipoactual.nombre.trim() == 'Monocristalino' || equipoactual.nombre.trim() == 'PERC' || equipoactual.nombre.trim() == 'Policristalino')
                            Apanel = Object.values(equipoactual)
                        else if (equipoactual.nombre.trim() == 'Li-ion + Inversor')
                            Ainvbat = Object.values(equipoactual);
                            if (equipoactual.tipo != "2" &amp;&amp; equipoactual.nuex =="Nuevo")
                            {
                                if(Anombre.includes(equipoactual.nombreequipo) == true)
                                {
                                    alert('ERROR: El equipo '+equipoactual.nombre+' tiene el nombre repetido con otro equipo. \r\nNombre del equipo = '+equipoactual.nombreequipo+'');
                                    return OcultarSpinner();
                                }
                            else
                                Anombre.push(equipoactual.nombreequipo);
                            }
                    }
                    if (Apanel.length != 0) // SI NO HAY FOTOVOLTAICA NO SE HACE EL ARCHIVO.
                    {
                        if ($scope.camposolarcaso == undefined || $scope.camposolarcaso == null || $scope.camposolarcaso == "false" || $scope.camposolarcaso == false ) {
                            alert('Debe definir campo solar para el equipo Fotovoltaico')
                            OcultarSpinner();
                            return updateNuevo();
                        }
                        if (clima == undefined || casoProvincia == undefined) {
                            alert('Debe especificar una Zona Climática y/o Provincia');
                            OcultarSpinner();
                            return updateComunidad(1);
                        }
                        Acamposolar = Object.values($scope.camposolarcaso)
                        if (Acamposolar[0] == 'SI') {
                            FVpredim = 0;
                            FValternativa = 1;
                        }
                        else {
                            FVpredim = 1;
                            FValternativa = 0;
                        }
                        casoProvincia = capitalprovincia(casoProvincia);
                        for (var contelect = 0; contelect &lt; $scope.equipo.length; contelect++) {
                            var servactual = $scope.equipo[contelect];
                if ((servactual.tipoequipo == "Electrico" || servactual.nombre == "Red Eléctrica") &amp;&amp; servactual.nuex == "Nuevo" ) {                               
                                numelectrico++;
                                switch (servactual.nombre) {
                                    case "Otros Eléctricos":
                                    case "Red Eléctrica":
                                        servelectrico.push("5");
                                        break;
                                    case "Vehículo Eléctrico":
                                        servelectrico.push("4");
                                        break;
                                    case "Iluminacion":
                                        servelectrico.push("8")
                                        break;
                                }
                            }
                        }
                        for (var contservelect = 0; contservelect &lt; servelectrico.length; contservelect++) {
                            tservicio += servelectrico[contservelect];
                            if ((contservelect == 0 || contservelect != servelectrico.length - 1) &amp;&amp; servelectrico.length > 1)
                                tservicio += ",";
                        }
                        if (Ainvbat.length == 0) {
                            Ainvbat = Array(70).fill(0)
                        }
                        if (FVpredim == 0) {
                            for (var contcamposolar = 8; contcamposolar &lt; Acamposolar.length; contcamposolar++) {
                                Acamposolar[contcamposolar] = 0;
                            }
                        }
                        if (FValternativa == 0) {
                            for (var contcamposolar = 1; contcamposolar &lt; 8; contcamposolar++) {
                                Acamposolar[contcamposolar] = 0;
                            }
                        }
                        if (FValternativa == 0 &amp;&amp; FVpredim == 0) {
                            alert('Debe definir un campo solar en el equipo fotovoltaico');
                            return updateNuevo();
                        }
                        //Creamos la sección de fotovoltaica
                        TFOTIM += '==============================================================================================\r\n';
                        TFOTIM += '.SECCION = FOTOVOLTAICA\r\n';
                        TFOTIM += '"Datos-Generales" = GENERAL\r\n';
                        TFOTIM += '\tPredimensionado = ' + FVpredim + '\r\n';
                        TFOTIM += '\tAlternativa = ' + FValternativa + '\r\n';
                        TFOTIM += '\tZONA_CLIMATICA = "Zona' + clima + '"\r\n';
                        TFOTIM += '\tCAPITAL_PROVINCIA = "' + casoProvincia + '"\r\n';
                        TFOTIM += '\tNUM_DEMANDAS = ' + numelectrico + '\r\n';
                        TFOTIM += '\tSERVICIOS = (' + tservicio + ')\r\n';
                        TFOTIM += '..\r\n';
                        TFOTIM += '------------------------------------------------------------------------------\r\n';
                        TFOTIM += '"Datos-Panel" = PANEL\r\n';
                        TFOTIM += '\tid_basedatos = ' + Apanel[0] + '\r\n';
                        TFOTIM += '\tpotencia_maxima = ' + Apanel[12] + '\r\n'; //Apanel[12] Apanel[20] - Atr |||||||  Apanel[21] Apanel[75] -valoresservicios
                        TFOTIM += '\tVmp = ' + Apanel[27] + '\r\n';
                        TFOTIM += '\tVoc = ' + Apanel[29] + '\r\n';
                        TFOTIM += '\tIcc = ' + Apanel[30] + '\r\n';
                        TFOTIM += '\teficiencia = ' + Apanel[13] + '\r\n';
                        TFOTIM += '\tareacelula = ' + parseFloat(Apanel[14]).toFixed(2) + '\r\n';
                        TFOTIM += '\tfactor_forma = ' + parseFloat(Apanel[31]).toFixed(2) + '\r\n';
                        TFOTIM += '\tpotencia_W_m2 = ' + Apanel[32] + '\r\n';
                        TFOTIM += '\tmaxima_tension_sistema = ' + Apanel[33] + '\r\n';
                        TFOTIM += '\tTONC = ' + Apanel[34] + '\r\n';
                        TFOTIM += '\tcoefTIsc = ' + Apanel[35] + '\r\n';
                        TFOTIM += '\tcoefTVoc = ' + Apanel[36] + '\r\n';
                        TFOTIM += '\tcoefTPmax = ' + Apanel[37] + '\r\n';
                        TFOTIM += '\tTminFunc = ' + Apanel[38] + '\r\n';
                        TFOTIM += '\tTmaxFunc = ' + Apanel[39] + '\r\n';
                        TFOTIM += '\tNcoef = ' + Apanel[40] + '\r\n';
                        TFOTIM += '\tNvar = ' + Apanel[41] + '\r\n';
                        TFOTIM += '\ta1 = ' + Apanel[42] + '\r\n';
                        TFOTIM += '\tb1 = ' + Apanel[43] + '\r\n';
                        TFOTIM += '\tc1 = ' + Apanel[44] + '\r\n';
                        TFOTIM += '\td1 = ' + Apanel[45] + '\r\n';
                        TFOTIM += '\ta2 = ' + parseFloat(Apanel[46]) + '\r\n';
                        TFOTIM += '\tb2 = ' + Apanel[47] + '\r\n';
                        TFOTIM += '\tc2 = ' + Apanel[48] + '\r\n';
                        TFOTIM += '\td2 = ' + Apanel[49] + '\r\n';
                        TFOTIM += '\tpeso = ' + Apanel[50] + '\r\n';
                        TFOTIM += '\talto = ' + Apanel[51] + '\r\n';
                        TFOTIM += '\tancho = ' + Apanel[52] + '\r\n';
                        TFOTIM += '\tprecio = ' + Apanel[24] + '\r\n';
                        TFOTIM += '..\r\n';
                        TFOTIM += '------------------------------------------------------------------------------\r\n';
                        TFOTIM += '"Datos-Inversor" = INVERSOR\r\n';  //Ainvbat[12] Ainvbat[20] - Atr |||||||  Ainvbat[21] Ainvbat[75] -valoresservicios
                        TFOTIM += '\tid_basedatos = ' + Ainvbat[0] + '\r\n';
                        TFOTIM += '\tNumero_seguidores_mppt = ' + Ainvbat[16] + '\r\n';
                        TFOTIM += '\tpn_cc = ' + Ainvbat[29] + '\r\n';
                        TFOTIM += '\tpmax_ca = ' + Ainvbat[15] + '\r\n';
                        TFOTIM += '\teficienciaEURO = ' + Ainvbat[31] + '\r\n';
                        TFOTIM += '\tvoltajemin = ' + Ainvbat[32] + '\r\n';
                        TFOTIM += '\tvoltajemax = ' + Ainvbat[33] + '\r\n';
                        TFOTIM += '\tvoltajemin_mppt = ' + Ainvbat[34] + '\r\n';
                        TFOTIM += '\tvoltajemax_mppt = ' + Ainvbat[35] + '\r\n';
                        TFOTIM += '\tintensidadmax_cc_a = ' + Ainvbat[36] + '\r\n';
                        TFOTIM += '\tmaxima_potencia = ' + parseFloat(Ainvbat[38]).toFixed(2) + '\r\n';
                        TFOTIM += '\teficienciamax = ' + Ainvbat[39] + '\r\n';
                        TFOTIM += '\ttension_min_trabajo = ' + Ainvbat[40] + '\r\n';
                        TFOTIM += '\ttension_max_trabajo = ' + Ainvbat[41] + '\r\n';
                        TFOTIM += '\ttension_arranque_sistema = ' + Ainvbat[42] + '\r\n';
                        TFOTIM += '\ttension_umbral = ' + Ainvbat[42] + '\r\n';
                        TFOTIM += '\tmin_potencia_operacion = ' + parseFloat(Ainvbat[17]).toFixed(2) + '\r\n';
                        TFOTIM += '\tpeso = ' + Ainvbat[45] + '\r\n';
                        TFOTIM += '\tprecio = ' + Ainvbat[27] + '\r\n';
                        TFOTIM += '..\r\n';
                        TFOTIM += '------------------------------------------------------------------------------\r\n';
                        TFOTIM += '"Datos-bateria" = BATERIA\r\n';
                        TFOTIM += '\tid_basedatos = ' + Ainvbat[0] + '\r\n';
                        TFOTIM += '\tcapacidad_nominal = ' + Ainvbat[46] + '\r\n';
                        TFOTIM += '\tcapacidad_util = ' + Ainvbat[18] + '\r\n';
                        TFOTIM += '\trango_min = ' + Ainvbat[48] + '\r\n';
                        TFOTIM += '\trango_max = ' + Ainvbat[49] + '\r\n';
                        TFOTIM += '\tvoltaje_nominal = ' + Ainvbat[50] + '\r\n';
                        TFOTIM += '\tpotencia_carga = ' + Ainvbat[51] + '\r\n';
                        TFOTIM += '\tpotencia_descarga = ' + Ainvbat[52] + '\r\n';
                        TFOTIM += '\tcorriente_max_carga = ' + Ainvbat[53] + '\r\n';
                        TFOTIM += '\tcorriente_max_descarga = ' + Ainvbat[54] + '\r\n';
                        TFOTIM += '\teficiencia_carga = ' + Ainvbat[55] + '\r\n';
                        TFOTIM += '\teficiencia_descarga = ' + Ainvbat[56] + '\r\n';
                        TFOTIM += '\tprofundidad_descarga = ' + Ainvbat[57] + '\r\n';
                        TFOTIM += '\tvida_util = ' + Ainvbat[20] + '\r\n';
                        TFOTIM += '\tciclos = ' + Ainvbat[19] + '\r\n';
                        TFOTIM += '\teficiencia_max_carga = ' + Ainvbat[60] + '\r\n';
                        TFOTIM += '\teficiencia_max_descarga = ' + Ainvbat[61] + '\r\n';
                        TFOTIM += '\tmaxima_potencia_salida = ' + Ainvbat[62] + '\r\n';
                        TFOTIM += '\tpotencia_constante = ' + Ainvbat[63] + '\r\n';
                        TFOTIM += '\tpeso = ' + Ainvbat[64] + '\r\n';
                        TFOTIM += '\tprecio = ' + Ainvbat[26] + '\r\n'; //¿-5?'+Ainvbat[5]+'\r\n';
                        TFOTIM += '..\r\n';
                        TFOTIM += '------------------------------------------------------------------------------\r\n';
                        TFOTIM += '"Datos-camposolar" = CAMPO-SOLAR\r\n';
                        TFOTIM += '\tnumeropaneles_serie_string = ' + Acamposolar[1] + '\r\n';
                        TFOTIM += '\tnstrings = ' + Acamposolar[2] + '\r\n';
                        TFOTIM += '\tfactor_anual_perdidas_sombras = ' + Acamposolar[3] + '\r\n';
                        TFOTIM += '\tazimut_campo = ' + Acamposolar[4] + '\r\n';
                        TFOTIM += '\tinclinacion_paneles = ' + Acamposolar[5] + '\r\n';
                        TFOTIM += '\tseparacion_hileras = ' + Acamposolar[6] + '\r\n';
                        TFOTIM += '\taltura_modulo = ' + Acamposolar[7] + '\r\n';
                        TFOTIM += '..\r\n';
                        TFOTIM += '------------------------------------------------------------------------------\r\n';
                        TFOTIM += '"Datos-prediseno" = PREDISENO\r\n';
                        if (FVpredim == 0)
                        {
                            Acamposolar[8] = "NO";
                            Acamposolar[13] = "NO";
                            Acamposolar[21] = "NO";
                        }
                        TFOTIM += '\tSuperficie disponible = "' + Acamposolar[8] + '"\r\n';
                        if (Acamposolar[8] == "NO")
                        {
                            Acamposolar[9] = 0;
                            Acamposolar[10] = 0;
                            Acamposolar[11] = 0
                            Acamposolar[12] = 0;
                            Acamposolar[14] = 0;
                        }
                        TFOTIM += '\tdimension1 = ' + Acamposolar[9] + '\r\n';
                        TFOTIM += '\tdimension2 = ' + Acamposolar[10] + '\r\n';
                        TFOTIM += '\tangulo = ' + Acamposolar[11] + '\r\n';
                        TFOTIM += '\tareabrutadisponible = ' + Acamposolar[12] + '\r\n';
                        TFOTIM += '\tinclinada = "' + Acamposolar[13] + '"\r\n';
                        if (Acamposolar[13] == "NO")
                            Acamposolar[14] = 0;
                        TFOTIM += '\tinclinacion = ' + Acamposolar[14] + '\r\n';
                        TFOTIM += '\tpotenciapico = "' + Acamposolar[15] + '"\r\n';
                        if (Acamposolar[15] == "NO") {
                            Acamposolar[16] = 0;
                            Acamposolar[17] = 0;
                            Acamposolar[18] = 0;
                        }
                        TFOTIM += '\tvalor = ' + Acamposolar[16] + '\r\n';
                        TFOTIM += '\tvalormin = ' + Acamposolar[17] + '\r\n';
                        TFOTIM += '\tvalormax = ' + Acamposolar[18] + '\r\n';
                        TFOTIM += '\tporcentajecubierto = "' + Acamposolar[21] + '"\r\n';
                        if (Acamposolar[21] == "NO") {
                            Acamposolar[22] = 0;
                            Acamposolar[23] = 0;
                            Acamposolar[24] = 0;
                        }
                        TFOTIM += '\tvaloresperado = ' + Acamposolar[22] + '\r\n';
                        TFOTIM += '\tvalormind = ' + Acamposolar[23] + '\r\n';
                        TFOTIM += '\tvalormaxd = ' + Acamposolar[24] + '\r\n';
                        TFOTIM += '..\r\n';
                        TFOTIM += '------------------------------------------------------------------------------\r\n';
                        TFOTIM += '.FIN-SECCION\r\n';
                        TFOTIM += '==============================================================================================\r\n';

                        $http.post("GenerarArchivoFV.php", { 'md5': nombremd5, 'contenido': TFOTIM })
                            .success(function (data) {
                                console.log(data);
                                if (data.length &lt; 100) {
                                    alert("Archivo PVDIM generado con éxito");
                                    Hborrardatos.BorrarFV();
                                    OcultarSpinner();
                                } else {
                                    alert("ERROR: El archivo no se ha generado");
                                    OcultarSpinner();
                                }
                            })
                            .catch(function (error) {
                                alert('Se ha encontrado el siguiente error:\r\n  ' + error.status + ' ' + error.statusText + '\n : ' + error.data + '');
                                return OcultarSpinner();
                            })
                    }
                    
                    //ARCHIVO PIDIM
                    var TSALTARIM = '';
                    var rutasaltarim = 'C:\\ProgramasTMT\\GasNatural\\PIDIM\\AlmacenCasos\\CASOSTERMINADOS\\' + nombremd5 + '.SALTARIM \r\n';
                    for (var x = 0; x &lt; $scope.caso.length; x++) {
                        if ($scope.caso[x].id == idCaso) {
                            localidad = $scope.caso[x].provincia;
                            meteorologia = diccionarioMeteorologia(localidad);
                            break;
                        }
                    }
                    for (var numcol = 0; numcol &lt; $scope.busesCaso.length; numcol++) {
                        var samplecolactual = $scope.busesCaso[numcol];
                        if (samplecolactual.nuex == "Nuevo" &amp;&amp; samplecolactual.idbus != 9 &amp;&amp; samplecolactual.idbus != "" &amp;&amp; samplecolactual.idbus != 5) {
                            samplecolectores.push(samplecolactual);
                        }
                    }
                    if (samplecolectores.length == 0) {
                        alert('ERROR: Debe definir una Nueva Instalación')
                        OcultarSpinner();
                        return updateNuevo();
                    }
                    //TEMPORAL , HASTA QUE QUITEN LOS EQUIPOS ASOCIADOS A LA PISCINA
                    var buspiscina;
                    for (var eqpiscina = 0; eqpiscina &lt; $scope.equipo.length; eqpiscina++) {
                        if ($scope.equipo[eqpiscina].nombre == "Piscina" &amp;&amp; $scope.equipo[eqpiscina].nuex == "Nuevo") {
                            buspiscina = $scope.equipo[eqpiscina].busa;
                            break;
                        }
                    }
                    //TEMPORAL , HASTA QUE QUITEN LOS EQUIPOS ASOCIADOS A LA PISCINA QUITAR DEL IF DE ABAJO LOS BUSPISCINA
                    for (var eqnuevos = 0; eqnuevos &lt; $scope.equipo.length; eqnuevos++) {
                        if ($scope.equipo[eqnuevos].nuex == "Nuevo" &amp;&amp; $scope.equipo[eqnuevos].nombre != "Piscina" &amp;&amp; ($scope.equipo[eqnuevos].busa == buspiscina || $scope.equipo[eqnuevos].busg == buspiscina)) {
                            alert('El servicio Piscina en la Nueva instalación no puede tener equipos asociados');
                            OcultarSpinner();
                            return updateNuevo();
                        }
                        if ($scope.equipo[eqnuevos].nuex == "Nuevo" &amp;&amp; $scope.equipo[eqnuevos].nombre != "Piscina") {
                            switch ($scope.equipo[eqnuevos].tipo) {
                                case "1":
                                case "4":
                                    sampleequipos.push($scope.equipo[eqnuevos]);
                                    break;
                                case "2":
                                    sampleservicios.push($scope.equipo[eqnuevos]);
                                    break;
                                case "3":
                                    samplecomplementos.push($scope.equipo[eqnuevos]);
                                    break;
                            }
                        }
                    }
                    //IC FANTASMA 
                    var serfan = 0;
                    var buscalfan;
                    var busacsfan;
                    var equipofan;
                    var hayfantasma;
                    var tempacsfan;
                    var tempcalfan;
                    for (var contserfan = 0; contserfan &lt; sampleservicios.length; contserfan++) {
                        var serviciofanactual = sampleservicios[contserfan];
                        if (serviciofanactual.nombre == "Calefacción Media") {
                            serfan++;
                            buscalfan = serviciofanactual.busa;
                        }
                        if (serviciofanactual.nombre == "ACS") {
                            serfan++;
                            busacsfan = serviciofanactual.busa;
                        }
                    }
                    if (serfan == 2) {
                        for (var numcolf = 0; numcolf &lt; samplecolectores.length; numcolf++) {
                            var colectorleido = samplecolectores[numcolf]
                            if (colectorleido.nombre == busacsfan)
                                tempacsfan = colectorleido.tempmax;
                            if (colectorleido.nombre == buscalfan)
                                tempcalfan = colectorleido.tempmax;
                        }
                        for (var conteqfan = 0; conteqfan &lt; sampleequipos.length; conteqfan++) {
                            equipofan = sampleequipos[conteqfan]
                            if ((equipofan.busg == buscalfan || equipofan.busa == buscalfan) &amp;&amp; Math.abs(tempcalfan - tempacsfan) &lt;= 5)
                                hayfantasma = true;
                        }
                    }
                    if (hayfantasma == true)
                        funcionmickael();
                    bdlEquipos(hayfantasma);
                    var PARAMETRICO = '';
                    var numCasos = equiposParam.length;
                    PARAMETRICO += '[PARAMETRICO] \r\n';
                    if (equiposParam.length>0){
                        PARAMETRICO += numCasos + '//Número de casos a simular \r\n';
                    PARAMETRICO +='(';
                    for (var casosContador=0; casosContador &lt; equiposParam.length; casosContador++) {
                        PARAMETRICO += (casosContador+1)+',';
                    }
                    PARAMETRICO = PARAMETRICO.substring(0, PARAMETRICO.length - 1);
                    PARAMETRICO += ') // Casos a simular\r\n';
                   } else {
                        PARAMETRICO +='1//Número de casos a simular \r\n';
                        PARAMETRICO += '(1)//Casos a simular \r\n';
                   }
                    for (var numcol = 0; numcol &lt; samplecolectores.length; numcol++) {
                        var colectorleido = samplecolectores[numcol]
                        colectoractual = new Colector();
                        colectoractual.nombre = colectorleido.nombre;
                        for (var numref = 0; numref &lt; $scope.bus.length; numref++) {
                            colectorreferencia = $scope.bus[numref];
                            if (colectorleido.idbus == colectorreferencia.id) {
                                if (colectorreferencia.idtipobus == 1 || (colectorreferencia.idtipobus == 3 &amp;&amp; (colectorreferencia.nombre != "Electricidad" || colectorreferencia.nombre != "Ninguno"))) {
                                    colectoractual.tipocolector = "CALOR";
                                    if (hayfantasma == true &amp;&amp; colectoractual.nombre == buscalfan)
                                        colectoractual.temperatura = parseInt(tempacsfan) + 5;
                                    else
                                        colectoractual.temperatura = colectorleido.tempmax;
                                    break;
                                }
                                else if (colectorreferencia.idtipobus == 2) {
                                    colectoractual.tipocolector = "FRIO";
                                    colectoractual.temperatura = colectorleido.tempmin;
                                    break;
                                }
                            }
                        }
                        //obtenemos los equipos asignados a este colector
                        for (var conteq = 0; conteq &lt; sampleequipos.length; conteq++) {
                            samplebusg = sampleequipos[conteq].busg;
                            samplebusa = sampleequipos[conteq].busa;
                            if (colectorleido.nombre == samplebusg || colectorleido.nombre == samplebusa) {
                                numbus = getnumcolectores(samplebusa, samplebusg);
                                contadorequipos++;
                                tipoequipo = equiposalternativas(sampleequipos[conteq]);
                                tipoequipo = quitarcorchetes(tipoequipo);
                                nombrequipo = sampleequipos[conteq].nombreequipo;
                                equipoactual = new EquipoColector(samplebusa, samplebusg, numbus, tipoequipo, nombrequipo)
                                if (equipoactual.tipoequipo == "EQUIPO=RendimientoConstante" &amp;&amp; equipoactual.numbus == 2)
                                {   
                                    let nb = 0;
                                    if (colectoractual.nombre == samplebusg)  nb = 1;
                                    if (colectoractual.nombre == samplebusa)  nb = 2;
                                    let equipoexistentedoble = Object.assign({}, equipoactual, {nombreequipo:nombrequipo+" "+nb});
                                    arrayequipos.push(equipoexistentedoble);
                                }
                                else
                                arrayequipos.push(equipoactual);
                            }
                        }
                        //obtenemos los complementos asignados a este colector
                        if (hayfantasma == true &amp;&amp; (colectoractual.nombre == busacsfan || colectoractual.nombre == buscalfan)) {
                            var ICfantasma = { busa: buscalfan, busg: busacsfan, numbus: 2, tipocomplemento: 'COMPLEMENTO=Intercambiadores', nombrecomplemento: 'ICfantasma' }
                            arraycomplementos.push(ICfantasma);
                        }
                        for (var contcom = 0; contcom &lt; samplecomplementos.length; contcom++) {
                            samplebusg = samplecomplementos[contcom].busg;
                            samplebusa = samplecomplementos[contcom].busa;
                            if (colectorleido.nombre == samplebusg || colectorleido.nombre == samplebusa) {
                                numbus = getnumcolectores(samplebusa, samplebusg);
                                tipocomplemento = complementosalternativas(samplecomplementos[contcom]);
                                tipocomplemento = quitarcorchetes(tipocomplemento);
                                nombrecomplemento = samplecomplementos[contcom].nombreequipo;
                                complementoactual = new ComplementoColector(samplebusa, samplebusg, numbus, tipocomplemento, nombrecomplemento)
                                arraycomplementos.push(complementoactual);
                            }
                        }
                        //obtenemos el servicio asignado a este colector comparandolo con la tabla $scope.uso
                        for (var contser = 0; contser &lt; sampleservicios.length; contser++) {
                            for (var contuso = 0; contuso &lt; $scope.uso.length; contuso++) {
                                servicioreferencia = $scope.uso[contuso];
                                samplebusg = sampleservicios[contser].busg;
                                samplebusa = sampleservicios[contser].busa;
                                if (servicioreferencia.nombre == sampleservicios[contser].nombre &amp;&amp; (colectorleido.nombre == samplebusg || colectorleido.nombre == samplebusa)) {
                                    tiposervicio = serviciosalternativas(servicioreferencia.id);
                                    tiposervicio = quitarcorchetes(tiposervicio);
                                    nombreservicio = sampleservicios[contser].nombre + ' ' + sampleservicios[contser].id;
                                    servicioactual = new ServicioColector(tiposervicio, nombreservicio);

                                }
                            }

                        }
                        //asignamos los equipos / complementos / servicios al colector actual.
                        colectoractual.equiposcolector = arrayequipos;
                        colectoractual.complementoscolector = arraycomplementos;
                        colectoractual.serviciocolector = servicioactual;
                        colectoractual.numerodatos = 8 + (colectoractual.equiposcolector.length + colectoractual.complementoscolector.length) * 2;
                        colectores.push(colectoractual);
                        arrayequipos = [];
                        arraycomplementos = [];

                    }
                    //ordenamos los colectores por temperaturas
                    function compare(a, b) {
                        if (parseInt(a.temperatura) &lt; parseInt(b.temperatura))
                            return -1;
                        if (parseInt(a.temperatura) > parseInt(b.temperatura))
                            return 1;
                        return 0;
                    };
                    colectores.sort(compare);
                    //escribimos el texto
                    TSALTARIM += '[SALTARIM]\r\n';
                    TSALTARIM += '\t1\t//Número de datos\r\n';
                    TSALTARIM += '\t' + rutasaltarim + '\r\n';
                    TLOC += '[LOCALIDAD]\r\n';
                    TLOC += '\t2\t//Número de datos\r\n';
                    TLOC += '\t' + localidad + '\t//Nombre de la localidad \r\n';
                    TLOC += '\tC:\\CDCYR\\Libreria\\Meteorologia\\' + meteorologia + '\t//Fichero tipo met de datos climáticos \r\n';
                    TCA += '\t' + (colectores.length + 1) + '\t//Número de datos \r\n';
                    TCA += '\t' + colectores.length + '\t//Número colectores activos ordenados por temperatura\r\n';
                    for (contcol = 0; contcol &lt; colectores.length; contcol++) {
                        colectoractual = colectores[contcol];
                        TCA += '\t' + colectoractual.nombre + '\r\n';
                        TC += TCcabecera.replace('numero', '' + colectoractual.nombre + '');
                        TC += '\t' + colectoractual.numerodatos + '\t//Número de datos \r\n';
                        TC += '\t' + colectoractual.nombre + '\t//Nombre propio del colector\r\n';
                        TC += '\t' + colectoractual.tipocolector + '\t//Tipo de colector\r\n';
                        TC += '\t' + colectoractual.temperatura + '\t//Temperatura consigna del colector\r\n';
                        TC += '\t' + colectoractual.equiposcolector.length + '\t//Número de equipos generadores\r\n';
                        for (var conteq = 0; conteq &lt; colectoractual.equiposcolector.length; conteq++) {
                            equipoactual = colectoractual.equiposcolector[conteq];
                            TC += '\t\t' + equipoactual.tipoequipo + '\t//Tipo equipo\r\n';
                            TC += '\t\t' + equipoactual.nombreequipo + '\t//Nombre equipo\r\n';
                        }
                        TC += '\t' + colectoractual.complementoscolector.length + '\t//Número de complementos conectados al colector\r\n';
                        for (var contcom = 0; contcom &lt; colectoractual.complementoscolector.length; contcom++) {
                            complementoactual = colectoractual.complementoscolector[contcom];
                            TC += '\t\t' + complementoactual.tipocomplemento + '\t//Tipo complemento\r\n';
                            TC += '\t\t' + complementoactual.nombrecomplemento + '\t//Nombre complemento\r\n';
                        }
                        TC += '\t' + colectoractual.serviciocolector.numeroservicio + '\t//Número de servicios del colector\r\n';
                        TC += '\t\t' + colectoractual.serviciocolector.tiposervicio + '\t//Tipo servicio\r\n';
                        TC += '\t\t' + colectoractual.serviciocolector.nombreservicio + '\t//Nombre servicio\r\n';
                    }
                    //Texto resultados detallados
                    if (variablesconsumo != undefined)
                    {
                    for (contvar = 0; contvar &lt; variablesconsumo[0].tipovariableconsumo.length; contvar++)   //COLECTORES
                    {
                        for (contcol = 0; contcol &lt; colectores.length; contcol++) {
                            colectoractual = colectores[contcol];
                            if (colectoractual == undefined)
                                break;
                            variableactual = variablesconsumo[0].tipovariableconsumo[contvar];
                            TRD += '\tCOLECTOR\t//Tipo de agrupación\r\n';
                            TRD += '\t\t' + colectoractual.nombre + '\t//Nombre del colector\r\n';
                            TRD += '\t\t' + variableactual + '\t//Tipo de resultado\r\n';
                        }
                    }
                    for (contvar = 0; contvar &lt; variablesconsumo[1].tipovariableconsumo.length; contvar++)    //SERVICIOS
                    {
                        for (contcol = 0; contcol &lt; colectores.length; contcol++) {
                            colectoractual = colectores[contcol];
                            variableactual = variablesconsumo[1].tipovariableconsumo[contvar];
                            if (variableactual == "FRACCIÓN DEMANDA CUBIERTA")
                                variableactual = "FUNCIONAMIENTO";
                            TRD += '\tSERVICIO\t//Tipo de agrupación\r\n';
                            TRD += '\t\t' + colectoractual.serviciocolector.nombreservicio + '\t//Número de servicios del colector\r\n';
                            TRD += '\t\t' + variableactual + '\t//Tipo de resultado\r\n';
                        }
                    }
                    for (contcol = 0; contcol &lt; colectores.length; contcol++) //EQUIPOS
                    {
                        colectoractual = colectores[contcol];
                        for (var conteq = 0; conteq &lt; colectoractual.equiposcolector.length; conteq++) {
                            equipoactual = colectoractual.equiposcolector[conteq];
                            if (nombrequiporepetido.includes(equipoactual.nombreequipo) == false)
                                for (contvar = 0; contvar &lt; variablesconsumo[2].tipovariableconsumo.length; contvar++) {
                                    variableactual = variablesconsumo[2].tipovariableconsumo[contvar];
                                    if (variableactual == "FUNCIONAMIENTO")
                                        for (contcontrol = 0; contcontrol &lt; Aleyesdecontrol.length; contcontrol++) {
                                            leyactual = Aleyesdecontrol[contcontrol];
                                            if (leyactual.nombre == equipoactual.nombreequipo) {
                                                for (var contley = 0; contley &lt; leyactual.aLeyes.length; contley++) {
                                                    TRD += '\tCONTROL\t//Tipo de agrupación\r\n';
                                                    TRD += '\t\t' + leyactual.aLeyes[contley] + '\t//Nombre de control\r\n';
                                                    TRD += '\t\t' + variableactual + '\t//Tipo de resultado\r\n';
                                                    TRD += TRDeq;
                                                    TRDeq = '';
                                                }
                                                break;
                                            }
                                        }
                                    if (equipoactual == undefined || variableactual == "FUNCIONAMIENTO")
                                        break;
                                    escribeequipo = function () {
                                        TRDeq += '\t' + equipoactual.tipoequipo + '\t//Tipo de agrupación\r\n';
                                        TRDeq += '\t\t' + equipoactual.nombreequipo + '\t\t//Nombre equipo\r\n';
                                        TRDeq += '\t\t' + variableactual + '\t\t//Tipo de resultado\r\n';
                                    }
                                    switch (equipoactual.tipoequipo) {
                                        case "EQUIPO=BombaCalor":
                                            if (equipoactual.numbus == 2)
                                                escribeequipo();
                                            else if (variableactual != "POTENCIA_RECUPERADA[W]")
                                                escribeequipo();
                                            break;
                                        case "EQUIPO=AbsorcionSimple":
                                            if (variableactual != "POTENCIA_RECUPERADA[W]")
                                                escribeequipo();
                                            break;
                                        case "EQUIPO=Caldera":
                                        case "EQUIPO=RendimientoConstante":
                                        case "EQUIPO=SolarTermica":
                                            if (variableactual != "POTENCIA_RECUPERADA[W]" &amp;&amp; variableactual != "TEMPERATURA_2[C]" &amp;&amp; variableactual != "CAUDAL_2[kg/s]")
                                                escribeequipo();
                                            break;
                                    }
                                }
                            if (nombrequiporepetido.includes(equipoactual.nombreequipo) == false)
                                nombrequiporepetido.push(equipoactual.nombreequipo);
                        }
                        if (contcol == colectores.length - 1)
                            TRD += TRDeq;
                    }
                    for (contcol = 0; contcol &lt; colectores.length; contcol++)   //COMPLEMENTOS POR PROBAR
                    {
                        colectoractual = colectores[contcol];
                        for (var contcom = 0; contcom &lt; colectoractual.complementoscolector.length; contcom++) {
                            complementoactual = colectoractual.complementoscolector[contcom];
                            for (contvar = 0; contvar &lt; variablesconsumo[3].tipovariableconsumo.length; contvar++) {
                                variableactual = variablesconsumo[3].tipovariableconsumo[contvar];
                                if (complementoactual == undefined)
                                    break;
                                if (complementoactual.nombrecomplemento != "ICfantasma" &amp;&amp; complementoactual.tipocomplemento == "COMPLEMENTO=Intercambiadores" &amp;&amp; nombrecomplementorepetido.includes(complementoactual.nombrecomplemento) == false) {
                                    TRD += '\t' + complementoactual.tipocomplemento.toUpperCase() + '\t//Tipo de agrupación\r\n';
                                    TRD += '\t\t' + complementoactual.nombrecomplemento + '\t\t//Nombre equipo\r\n';
                                    TRD += '\t\t' + variableactual + '\t\t//Tipo de resultado\r\n';
                                }
                            }
                            if (nombrecomplementorepetido.includes(complementoactual.nombrecomplemento) == false)
                                nombrecomplementorepetido.push(complementoactual.nombrecomplemento);
                        }
                    }
                }
                    var numLeyesC = 0;
                    var contPosLeyC = 1;
                    var contPosLeyD = 1;
                    var temp = 0;
                    var pos = 0;
                    var contnumC=0;
                    //Creamos las leyes de control de calor
                    var leyesOrdenadas= new Array();
                    var leyesCreadas= new Array();
                    for (var z = 0; z &lt; priCalor.length; z++) {
                    for (var y = 0; y &lt; leyesCalor.length; y++) {
                                if (leyesCalor[y][6] == priCalor[z][0] &amp;&amp; 1 == priCalor[z][0]) {
                                    if (leyesCalor[y][7] == priCalor[z][1]) {
                                        leyesOrdenadas.push(leyesCalor[y]);
                                    }
                            }
                            
                               else if (leyesCalor[y][6] == priCalor[z][0] &amp;&amp; 4 == priCalor[z][0]) {
                                    leyesOrdenadas.push(leyesCalor[y]);
                                }
                               else if (leyesCalor[y][6] == priCalor[z][0] &amp;&amp; 3 == priCalor[z][0]) {
                                    var leyIntercambiadorRep = false;
                                    var tempInterGuardado=0.0;
                                    var tempInterNuevo = 0.0;
                                    for (var l = 0; l &lt; leyesOrdenadas.length;l++) {
                                        if (leyesOrdenadas[l][0] == leyesCalor[y][0]) {
                                            leyIntercambiadorRep = true;
                                            tempInterGuardado = parseFloat(leyesOrdenadas[l][6]);
                                            tempInterNuevo = parseFloat(leyesCalor[y][6]);
                                            posIntercambiador=y;
                                            posIntercambiadorG = l;
                                            break;
                                        }
                                    } if (leyIntercambiadorRep == false){
                                    leyesOrdenadas.push(leyesCalor[y]);
                                    } else if (leyIntercambiadorRep == true &amp;&amp; tempInterGuardado > tempInterNuevo) {
                                        leyesOrdenadas[posIntercambiadorG] = leyesCalor[posIntercambiador];
                                    }
                                
                                }
                            }
                            }


                    //Establecemos un orden para las leyes de calor
                    for (var y = 0; y &lt; leyesOrdenadas.length; y++) {
                                    contnumC = 1;
                                    numLeyesC = 0;
                        temp = parseInt(leyesOrdenadas[y][2]);
                                    pos = y;
                        for (var u = 0; u &lt; leyesOrdenadas.length; u++) {
                            if (leyesOrdenadas[u][4] == leyesOrdenadas[pos][4]) {
                                            numLeyesC++;
                                        }
                                    }
                                    for (var u = 0; u &lt; leyesCreadas.length; u++) {
                                        if (leyesCreadas[u] == leyesOrdenadas[pos][4]) {
                                            contnumC++;
                                        }
                                    }
                        if (leyesOrdenadas[pos][6] == "1" &amp;&amp; leyesOrdenadas[pos][7] == "1") {


                        } else if (leyesOrdenadas[pos][6] == "1" &amp;&amp; leyesOrdenadas[pos][7] == "2") {

                                    }
                        
                                    else {
                            TLEY += '[CONTROL=' + leyesOrdenadas[pos][5] + '] //Ley de control para un equipo\r\n';
                                    TLEY += '       3 //Número de datos\r\n';
                            TLEY += '     Control ' + leyesOrdenadas[pos][0] + ' //Nombre de la ley\r\n';
                            TLEY += '        ' + leyesOrdenadas[pos][1] + ' //Tipo de control: ACTIVACION-CALOR, ACTIVACION-FRIO, LEY-CONTROL\r\n';
                                    for (var i = 0; i &lt; temperaturas.length; i++) {
                                            if (temperaturas[i][0] == leyesOrdenadas[pos][2]) {
                                                var temp2 = (parseInt(leyesOrdenadas[pos][2]) - parseInt(leyesOrdenadas[pos][3])) / (numLeyesC + 2);
                                                var Tact = parseInt(leyesOrdenadas[pos][2]) - contnumC * temp2;
                                            temperaturas[i][2] = temperaturas[i][2] + 1;
                                        }
                                    }

                                        TLEY += '      ' + Tact + ' //Temperatura de activación\r\n';
                                    }
                        leyesCreadas.push(leyesOrdenadas[pos][4]);
                                    contPosLeyC++;
                                }
                            
                        
                    
                    leyesCreadas=[]; 
                    var leyesOrdenadas =[];
                    for (var z = 0; z &lt; priFrio.length; z++) {
                    for (var y = 0; y &lt; leyesFrio.length; y++) {
                            if (leyesFrio[y][6] == priFrio[z][0] &amp;&amp; 1 == priFrio[z][0]) {
                                if (leyesFrio[y][7] == priFrio[z][1]) {
                                    leyesOrdenadas.push(leyesFrio[y]);
                                }
                            }

                            else if (leyesFrio[y][6] == priFrio[z][0] &amp;&amp; 4 == priFrio[z][0]) {
                                leyesOrdenadas.push(leyesFrio[y]);
                            }
                            else if (leyesFrio[y][6] == priFrio[z][0] &amp;&amp; 3 == priFrio[z][0]) {
                                leyesOrdenadas.push(leyesFrio[y]);
                            }
                        }
                    }


                    //Lo mismo para los colectores de tipo frío
                    for (var y = 0; y &lt; leyesOrdenadas.length; y++) {
                                    contnumC = 1;
                        numLeyesC = 0;
                        temp = parseInt(leyesOrdenadas[y][2]);
                                    pos = y;
                        for (var u = 0; u &lt; leyesOrdenadas.length; u++) {
                            if (leyesOrdenadas[u][4] == leyesOrdenadas[pos][4]) {
                                numLeyesC++;
                                        }
                                    }
                                    for (var u = 0; u &lt; leyesCreadas.length; u++) {
                            if (leyesCreadas[u] == leyesOrdenadas[pos][4]) {
                                            contnumC++;
                                        }
                                    }
                        if (leyesOrdenadas[pos][6] == "1" &amp;&amp; leyesOrdenadas[pos][7] == "1") {


                        } else if (leyesOrdenadas[pos][6] == "1" &amp;&amp; leyesOrdenadas[pos][7] == "2") {

                        }
                        else if (leyesOrdenadas[pos][6] == "3") {

                        }
                        else {
                            TLEY += '[CONTROL=' + leyesOrdenadas[pos][5] + '] //Ley de control para un equipo\r\n';
                                    TLEY += '       3 //Número de datos\r\n';
                            TLEY += '     Control ' + leyesOrdenadas[pos][0] + ' //Nombre de la ley\r\n';
                            TLEY += '        ' + leyesOrdenadas[pos][1] + ' //Tipo de control: ACTIVACION-CALOR, ACTIVACION-FRIO, LEY-CONTROL\r\n';
                                    for (var i = 0; i &lt; temperaturas.length; i++) {
                                if (temperaturas[i][0] == leyesOrdenadas[pos][2]) {
                                    var temp2 = (parseInt(leyesOrdenadas[pos][2]) - parseInt(leyesOrdenadas[pos][3])) / (numLeyesC + 2);
                                    var Tact = parseInt(leyesOrdenadas[pos][3]) + contnumC * temp2;
                                            temperaturas[i][2] = temperaturas[i][2] + 1;
                                        }
                                    }

                                    TLEY += '      ' + Tact  + ' //Temperatura de activación\r\n';
                        }
                        leyesCreadas.push(leyesOrdenadas[pos][4]);
                        contPosLeyC++;
                    }
                    //Creamos las leyes de control de diferencial
                    for (var y = 0; y &lt; leyesDiferencial.length; y++) {
                        pos = y;
                        TLEY += '[CONTROL=' + leyesDiferencial[pos][5] + '] //Ley de control para un equipo\r\n';
                        TLEY += '       4 //Número de datos\r\n';
                        TLEY += '     Control ' + leyesDiferencial[pos][0] + ' //Nombre de la ley\r\n';
                        TLEY += '        ' + leyesDiferencial[pos][1] + ' //Tipo de control: ACTIVACION-CALOR, ACTIVACION-FRIO, LEY-CONTROL\r\n';
                        for (var i = 0; i &lt; temperaturas.length; i++) {
                            if (temperaturas[i][0] == leyesDiferencial[pos][2]) {
                                var temp2 = (parseInt(leyesDiferencial[pos][2]) - parseInt(leyesDiferencial[pos][3])) / (temperaturas[i][1]);
                                var Tact = parseInt(leyesDiferencial[pos][2]) + temp2 * temperaturas[i][2];
                                temperaturas[i][2] = temperaturas[i][2] + 1;
                            }
                        }
                        TLEY += '      1 // valor nominal\r\n';
                        TLEY += '      10 // valor nominal\r\n';
                        contPosLeyD++;
                    }
                    //Generamos el archivo de consumo
                    var numerodatos = TRD.split(/\r\n|\r|\n/).length - 1;
                    TRDC += '\t' + (numerodatos + 5) + '\t//Número de datos \r\n';
                    TRDC += '\tResultados Detallados\t//Nombre de la agrupación \r\n';
                    TRDC += '\tC:\\ProgramasTMT\\GasNatural\\PIDIM\\AlmacenCasos\\CASOSTERMINADOS\\' + nombremd5 + '.RESPIDIM\t //Fichero resultados\r\n';
                    TRDC += '\tTABULADOR\t//Tipo de separador \r\n';
                    TRDC += '\t3600\t//Paso de tiempo en segundos \r\n';
                    TRDC += '\t' + (numerodatos / 3) + '\t//Número de variables a escribir \r\n';
                    texto = PARAMETRICO+ TSALTARIM + TLOC + TCA + TC + textoEquipos + TLEY + TRDC + TRD;
                    $http.post("GenerarArchivoConsumos.php", { 'md5': nombremd5, 'contenido': texto })
                        .success(function (data) {
                            console.log(data);
                            if (data.length &lt; 100) {
                                alert("Archivo PIDIM generado con éxito");
                                Hborrardatos.BorrarConsumos();
                                Hborrardatos.BorrarInforme();
                                OcultarSpinner();
                            } else {
                                alert("ERROR: El archivo no se ha generado");
                                OcultarSpinner();
                            }
                        })
                        .catch(function (error) {
                            alert('Se ha encontrado el siguiente error:\r\n  ' + error.data + '');
                            return OcultarSpinner();
                        });
                } else {

                    if (porC > 100.0) {
                        alert("ERROR: El porcentaje de consumo total de calor no puede superar el 100%");
                    }
                    if (porF > 100.0) {
                        alert("ERROR: El porcentaje de consumo total de frío no puede superar el 100%");
                    }
                    if (porACS > 100.0) {
                        alert("ERROR: El porcentaje de consumo total de ACS no puede superar el 100%");
                    }
                    return OcultarSpinner();
                }
            }).catch(function (error) {
                alert('Ha habido un error en calcular demandas :\r\n ' + error.data + '');
                return OcultarSpinner();
            })
        }
         /**

            *Guardamos los valores de los selectores del consumo

            * @return  {void}

            */
        guardarvarconsumosel = function () {
			equiposParam = [1];
            var agrupacionactual;
            var tipoactual;
            var variablesconsumo = new Array();
            var arraytipos = new Array();
            //Sacamos las variables de consumo y corregimos los valores
            var agrupaciones = $('#bodyvariables >table >tbody > tr td:first-child');
            for (var contagrupacion = 0; contagrupacion &lt; agrupaciones.length; contagrupacion++) {
                tipoactual = $('#bodyvariables >table >tbody > tr:eq(' + contagrupacion + ') td:eq(1) input')
                etiquetatipoactual = $('#bodyvariables >table >tbody > tr:eq(' + contagrupacion + ') td:eq(1) #etiquetatipo')
                agrupacionactual = new VariablesConsumoSel();
                arraytipos = [];
                agrupacionactual.nombreagrupacion = agrupaciones[contagrupacion].innerText.trim().toUpperCase();
                for (var conttipo = 0; conttipo &lt; tipoactual.length; conttipo++)
                    if (tipoactual[conttipo].checked == true) {
                        var etiqueta = etiquetatipoactual[conttipo].innerText.trim();
                        var etiqueta1 = quitarcorchetes(etiqueta);
                        var etiqueta2 = etiqueta.substring("", etiqueta.lastIndexOf("[")).toUpperCase();
                        var etiquetafinal = etiqueta2 + '[' + etiqueta1 + ']';
                        if (etiquetafinal == "[]") {
                            etiquetafinal = etiqueta.toUpperCase();
                        }
                        arraytipos.push(etiquetafinal);
                    }
                agrupacionactual.tipovariableconsumo = arraytipos;
                variablesconsumo.push(agrupacionactual); // obj final.
            }
            var cont = 0;
            for (var vc = 0; vc &lt; variablesconsumo.length; vc++)
           {
               if (variablesconsumo[vc].tipovariableconsumo.length == 0)
               cont++;
           }
           if (cont &lt; 4)
            updateAlternativas(variablesconsumo);
           else
           {
               alert('Debe seleccionar almenos una variable a representar');
               return;
           }
        }
         /**

            *Calculamos el número de colectores por equipo

            * @return  {void}

            */
        getnumcolectores = function (busa, busg) {
            if (busg != busa &amp;&amp; (busg != "-" &amp;&amp; busa != "-"))
                return 2;
            else
                return 1;
        }
         /**

            *Eliminamos los corchetes de determinadas variables

            * @return  {void}

            */
        quitarcorchetes = function (str) {
            str = str.substring(str.lastIndexOf("[") + 1, str.lastIndexOf("]"));
            return str;
        }
         /**

            *Funciones para asignar valores

            * @return  {void}

            */
        function VariablesConsumoSel(nombreagrupacion, tipovariableconsumo) {
            this.nombreagrupacion = nombreagrupacion;
            this.tipovariableconsumo = tipovariableconsumo;
        }
        function Colector(numerodatos, nombre, tipocolector, temperatura, equiposcolector, complementoscolector, serviciocolector) {
            this.numerodatos = numerodatos;
            this.nombre = nombre;
            this.tipocolector = tipocolector;
            this.temperatura = temperatura;
            this.equiposcolector = equiposcolector;
            this.complementoscolector = complementoscolector;
            this.serviciocolector = serviciocolector;
        }
        function EquipoColector(busa, busg, numbus, tipoequipo, nombreequipo) {
            this.busa = busa;
            this.busg = busg;
            this.numbus = numbus;
            this.tipoequipo = tipoequipo;
            this.nombreequipo = nombreequipo;
        }
        function ComplementoColector(busa, busg, numbus, tipocomplemento, nombrecomplemento) {
            this.busa = busa;
            this.busg = busg;
            this.numbus = numbus;
            this.tipocomplemento = tipocomplemento;
            this.nombrecomplemento = nombrecomplemento;
        }
        function ServicioColector(tiposervicio, nombreservicio) {
            this.numeroservicio = "1";
            this.tiposervicio = tiposervicio;
            this.nombreservicio = nombreservicio;
        }
        function Ley(nombre) {
            this.nombre = nombre;
            this.aLeyes = new Array();
        }
         /**

            *Cargamos facturación
            * @return  {void}

            */
        updateFacturacion = function () {
            vaciarcontenido();
            //Creamos la sección de factuación
            var menu = "";
            menu += "&lt;div>";
            menu += "&lt;span style='margin-top:10px;'>Datos económicos&lt;/span>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Interés nominal [%]&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='any' class='+100 -0  float' type='number' max='100' min='0' id='interes'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='5'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Inflación [%]&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='any' class='+100 -0  float' type='number' max='100' min='0' id='inflacion'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='3'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Periodo de explotación CCV [años]&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='any' class='+100 -0  float' type='number' max='100' min='0' id='periodo'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='30'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Coste de mantenimiento(€/año)&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='any' class='+100000 -0  float' type='number' max='100000' min='0' id='mantenimiento'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Subvenciones(€/año)&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='any' class='+100000 -0  float' type='number' max='100000' min='0' id='subvenciones'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Reducción impuestos(€/año)&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='any' class='+110000000 -0  float' type='number' max='100000' min='0' id='reduccionimpuestos'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0'>&lt;/br>";
            menu += "&lt;/div>";
            menu += "&lt;div>";
            menu += "&lt;span style='margin-top:10px;'>Costes energéticos&lt;/span>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Coste gas propano [€/kWh]&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='0.01' class='+100 -0  float' type='number' max='100' min='0' id='propano'  style='margin-top:10px;transform: scale(1);text-align: center; margin-left: 20px;' value='0.08'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Coste biomasa [€/kWh]&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='0.01' class='+100 -0  float' type='number' max='100' min='0' id='biomasa'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0.04'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Coste gasóleo [€/kWh]&lt;/span>&lt;/br>";
            menu += "&lt;input maxlength='5' step='0.01' class='+100 -0  float' type='number' max='100' min='0' id='gasoleo'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0.1'>&lt;/br>";
            menu += "&lt;/div>";
            menu += "&lt;span style='margin-top:10px;'>Tensión:&lt;/span>&lt;/br>";
            menu += "&lt;select id='tension' style='width: auto;text-align: center; text-align-last: center;'>";
            menu += "&lt;option value='0' hidden > - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>Baja tensión&lt;/option>";
            menu += "&lt;option value='2'>Alta tensión&lt;/option>";
            menu += "&lt;/select>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Tipos de tarifas:&lt;/span>&lt;/br>";
            menu += "&lt;select id='tipoTarifa' onchange='cargaTarifa()'style='width: auto;text-align: center; text-align-last: center;'>";
            menu += "&lt;option value='0' hidden > - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>3.0 A&lt;/option>";
            menu += "&lt;option value='2'>3.1 A&lt;/option>";
            menu += "&lt;option value='3'>6.0 A&lt;/option>";
            menu += "&lt;option value='4'>6.1 A&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;table  id='TarifasFijas' class='table'>";
            menu += "&lt;tr>";
            menu += "&lt;th style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%; '>Tarifas fijas&lt;/th>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>P" + x + "&lt;/td>\n";
            menu += "&lt;/tr>";
            menu += "&lt;tr>";
            menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>Término Fijo(€/kW año)&lt;/td>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='border:solid 1px black;background-color: #d5c7b9;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>0&lt;/td>\n";
            menu += "&lt;/tr>";
            menu += "&lt;tr>";
            menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>Término Variable(€/kWh)&lt;/td>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='border:solid 1px black;background-color: #d5c7b9;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>0&lt;/td>\n";
            menu += "&lt;/tr>";

            menu += "&lt;tr>";
            menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>Potencia contratada(Kw día)&lt;/td>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='border:solid 1px black;background-color: #d5c7b9;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>0&lt;/td>\n";
            menu += "&lt;/tr>";
            menu += "&lt;/table>";

            menu += "&lt;span style='margin-top:10px;'>Seleccionar tarifa de gas&lt;/span>";
            menu += "&lt;select id='tipoTarifaGas' style='width: auto;text-align: center; text-align-last: center;'>";
            menu += "&lt;option value='0' hidden > - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>Tarifa 3.2(5-50 MWh)&lt;/option>";
            menu += "&lt;option value='2'>Tarifa 3.3(50-100 MWh)&lt;/option>";
            menu += "&lt;option value='3'>Tarifa 3.4(100-8000 MWh)&lt;/option>";
            menu += "&lt;option value='4'>Tarifa 3.5(> 8000 MWh)&lt;/option>";
            menu += "&lt;/select>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Características de la tarifa&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Término fijo (€/mes)&lt;/span>";
            menu += "&lt;input maxlength='3' step='0.01' class='+100 -0  float' type='number' max='100' min='0' id='fijo'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='3.33'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Término variable (€/kWh)&lt;/span>";
            menu += "&lt;input maxlength='5' step='0.01' class='+10000 -0  float' type='number' max='10000' min='0' id='variable'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='0.15'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Consumo máximo tarifa (MWh/año)&lt;/span>";
            menu += "&lt;input maxlength='5' step='0.01' class='+10000 -0  float' type='number' max='10000' min='0' id='consumo'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='10'>&lt;/br>";
            menu += "&lt;button class='btnMenu' style='margin-top: 50px;background-color:orange;display:flex;' onclick='GuardarDatosFacturacion()'>Guardar&lt;/button>"

            document.getElementById("contenido").innerHTML = menu;
            //Cargamos los valores si los hubiera en la base de datos
            oTabla = document.querySelector("#TarifasFijas");
            oCeldas = oTabla.getElementsByTagName("td");
            for (var i = 0; i &lt; oCeldas.length; i++) {
                oCeldas[i].addEventListener("keydown", writingCapFacturacion);
            }
            if ($scope.facturacion.length > 0) {
                document.getElementById("interes").value = $scope.facturacion[0].interes;
                document.getElementById("inflacion").value = $scope.facturacion[0].inflacion;
                document.getElementById("periodo").value = $scope.facturacion[0].periodo;
                document.getElementById("mantenimiento").value = $scope.facturacion[0].costemantenimiento;
                document.getElementById("subvenciones").value = $scope.facturacion[0].subvenciones;
                document.getElementById("reduccionimpuestos").value = $scope.facturacion[0].reduccionimpuestos;
                document.getElementById("propano").value = $scope.facturacion[0].costegas;
                document.getElementById("biomasa").value = $scope.facturacion[0].costebiomasa;
                document.getElementById("gasoleo").value = $scope.facturacion[0].costegasoleo;
            }
            if ($scope.tarifaElectrica.length > 0) {
                for (var y = 0; y &lt; document.getElementById("tension").options.length; y++) {
                    if (document.getElementById("tension").options[y].text == $scope.tarifaElectrica[0].tension) {
                        document.getElementById("tension").value = document.getElementById("tension").options[y].value;
                        break;
                    }
                }
                for (var y = 0; y &lt; document.getElementById("tipoTarifa").options.length; y++) {
                    if (document.getElementById("tipoTarifa").options[y].text == $scope.tarifaElectrica[0].tarifa) {
                        document.getElementById("tipoTarifa").value = document.getElementById("tipoTarifa").options[y].value;
                        break;
                    }
                }
                document.getElementById('TarifasFijas').rows[1].cells[1].innerHTML = $scope.tarifaElectrica[0].tfija1;
                document.getElementById('TarifasFijas').rows[1].cells[2].innerHTML = $scope.tarifaElectrica[0].tfija2;
                document.getElementById('TarifasFijas').rows[1].cells[3].innerHTML = $scope.tarifaElectrica[0].tfija3;
                document.getElementById('TarifasFijas').rows[1].cells[4].innerHTML = $scope.tarifaElectrica[0].tfija4;
                document.getElementById('TarifasFijas').rows[1].cells[5].innerHTML = $scope.tarifaElectrica[0].tfija5;
                document.getElementById('TarifasFijas').rows[1].cells[6].innerHTML = $scope.tarifaElectrica[0].tfija6;
                document.getElementById('TarifasFijas').rows[2].cells[1].innerHTML = $scope.tarifaElectrica[0].tvariable1;
                document.getElementById('TarifasFijas').rows[2].cells[2].innerHTML = $scope.tarifaElectrica[0].tvariable2;
                document.getElementById('TarifasFijas').rows[2].cells[3].innerHTML = $scope.tarifaElectrica[0].tvariable3;
                document.getElementById('TarifasFijas').rows[2].cells[4].innerHTML = $scope.tarifaElectrica[0].tvariable4;
                document.getElementById('TarifasFijas').rows[2].cells[5].innerHTML = $scope.tarifaElectrica[0].tvariable5;
                document.getElementById('TarifasFijas').rows[2].cells[6].innerHTML = $scope.tarifaElectrica[0].tvariable6;
                document.getElementById('TarifasFijas').rows[3].cells[1].innerHTML = $scope.tarifaElectrica[0].tpotencia1;
                document.getElementById('TarifasFijas').rows[3].cells[2].innerHTML = $scope.tarifaElectrica[0].tpotencia2;
                document.getElementById('TarifasFijas').rows[3].cells[3].innerHTML = $scope.tarifaElectrica[0].tpotencia3;
                document.getElementById('TarifasFijas').rows[3].cells[4].innerHTML = $scope.tarifaElectrica[0].tpotencia4;
                document.getElementById('TarifasFijas').rows[3].cells[5].innerHTML = $scope.tarifaElectrica[0].tpotencia5;
                document.getElementById('TarifasFijas').rows[3].cells[6].innerHTML = $scope.tarifaElectrica[0].tpotencia6;
                cargaTarifa();
            }
            if ($scope.tarifaElectrica.length > 0) {
                for (var y = 0; y &lt; document.getElementById("tipoTarifaGas").options.length; y++) {
                    if (document.getElementById("tipoTarifaGas").options[y].text == $scope.tarifaGas[0].tarifagas) {
                        document.getElementById("tipoTarifaGas").value = document.getElementById("tipoTarifaGas").options[y].value;
                        break;
                    }
                }

                document.getElementById("fijo").value = $scope.tarifaGas[0].terminofijo;
                document.getElementById("variable").value = $scope.tarifaGas[0].terminovariable;
                document.getElementById("consumo").value = $scope.tarifaGas[0].consumomaximotarifa;
            }
            OcultarSpinner();
        }
        /**

            *Cargamos los datos de tarifa eléctrica
            * @return  {void}

            */
        cargarTarifaElectrica = function () {
            //Creamos la sección de factuación
            var menu = "";
            menu += "&lt;span style='margin-top:10px;'>Tensión:&lt;/span>&lt;/br>";
            menu += "&lt;select id='tension' style='width: auto;text-align: center; text-align-last: center;'>";
            menu += "&lt;option value='0' hidden > - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>Baja tensión&lt;/option>";
            menu += "&lt;option value='2'>Alta tensión&lt;/option>";
            menu += "&lt;/select>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Tipos de tarifas:&lt;/span>&lt;/br>";
            menu += "&lt;select id='tipoTarifa' onchange='cargaTarifa()'style='width: auto;text-align: center; text-align-last: center;'>";
            menu += "&lt;option value='0' hidden > - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>3.0 A&lt;/option>";
            menu += "&lt;option value='2'>3.1 A&lt;/option>";
            menu += "&lt;option value='3'>6.1 A&lt;/option>";
            menu += "&lt;option value='4'>6.1 A&lt;/option>";
            menu += "&lt;/select>";
            menu += "&lt;table  id='TarifasFijas' class='table'>";
            menu += "&lt;tr>";
            menu += "&lt;th style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>Tarifas fijas&lt;/th>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>P" + x + "&lt;/td>\n";
            menu += "&lt;/tr>";
            menu += "&lt;tr>";
            menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>T.Fijo(€/kW año)&lt;/td>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>0&lt;/td>\n";
            menu += "&lt;/tr>";
            menu += "&lt;tr>";
            menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>T.Variable(€/kW año)&lt;/td>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>0&lt;/td>\n";
            menu += "&lt;/tr>";

            menu += "&lt;tr>";
            menu += "&lt;td style='background-color: lightblue;border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>Potencia contratada(kw/h)&lt;/td>\n";
            for (var x = 1; x &lt; 7; x++)
                menu += "&lt;td style='border:solid 1px black;text-align:center;vertical-align:center;width:30px;height:25px;font-size:75%;'>0&lt;/td>\n";
            menu += "&lt;/tr>";
            menu += "&lt;/table>";
            menu += "&lt;button class='btnMenu' style='margin-top: 50px;background-color:orange;display:flex;' onclick='updateFacturacion()'>Volver&lt;/button>";
            menu += "&lt;button class='btnMenu' style='margin-top: 50px;background-color:orange;display:flex;' onclick='GuardarDatosTarifaE()'>Guardar&lt;/button>"
            document.getElementById("contenido").innerHTML = menu;
            //Cargamos los valores si los hubiera en la base de datos
            if ($scope.tarifaElectrica.length > 0) {
                for (var y = 0; y &lt; document.getElementById("tension").options.length; y++) {
                    if (document.getElementById("tension").options[y].text == $scope.tarifaElectrica[0].tension) {
                        document.getElementById("tension").value = document.getElementById("tension").options[y].value;
                        break;
                    }
                }
                for (var y = 0; y &lt; document.getElementById("tipoTarifa").options.length; y++) {
                    if (document.getElementById("tipoTarifa").options[y].text == $scope.tarifaElectrica[0].tarifa) {
                        document.getElementById("tipoTarifa").value = document.getElementById("tipoTarifa").options[y].value;
                        break;
                    }
                }
                document.getElementById('TarifasFijas').rows[1].cells[1].innerHTML = $scope.tarifaElectrica[0].tfija1;
                document.getElementById('TarifasFijas').rows[1].cells[2].innerHTML = $scope.tarifaElectrica[0].tfija2;
                document.getElementById('TarifasFijas').rows[1].cells[3].innerHTML = $scope.tarifaElectrica[0].tfija3;
                document.getElementById('TarifasFijas').rows[1].cells[4].innerHTML = $scope.tarifaElectrica[0].tfija4;
                document.getElementById('TarifasFijas').rows[1].cells[5].innerHTML = $scope.tarifaElectrica[0].tfija5;
                document.getElementById('TarifasFijas').rows[1].cells[6].innerHTML = $scope.tarifaElectrica[0].tfija6;
                document.getElementById('TarifasFijas').rows[2].cells[1].innerHTML = $scope.tarifaElectrica[0].tvariable1;
                document.getElementById('TarifasFijas').rows[2].cells[2].innerHTML = $scope.tarifaElectrica[0].tvariable2;
                document.getElementById('TarifasFijas').rows[2].cells[3].innerHTML = $scope.tarifaElectrica[0].tvariable3;
                document.getElementById('TarifasFijas').rows[2].cells[4].innerHTML = $scope.tarifaElectrica[0].tvariable4;
                document.getElementById('TarifasFijas').rows[2].cells[5].innerHTML = $scope.tarifaElectrica[0].tvariable5;
                document.getElementById('TarifasFijas').rows[2].cells[6].innerHTML = $scope.tarifaElectrica[0].tvariable6;
                document.getElementById('TarifasFijas').rows[3].cells[1].innerHTML = $scope.tarifaElectrica[0].tpotencia1;
                document.getElementById('TarifasFijas').rows[3].cells[2].innerHTML = $scope.tarifaElectrica[0].tpotencia2;
                document.getElementById('TarifasFijas').rows[3].cells[3].innerHTML = $scope.tarifaElectrica[0].tpotencia3;
                document.getElementById('TarifasFijas').rows[3].cells[4].innerHTML = $scope.tarifaElectrica[0].tpotencia4;
                document.getElementById('TarifasFijas').rows[3].cells[5].innerHTML = $scope.tarifaElectrica[0].tpotencia5;
                document.getElementById('TarifasFijas').rows[3].cells[6].innerHTML = $scope.tarifaElectrica[0].tpotencia6;
            }
            OcultarSpinner();
        }
        /**

            *cargamos las tarifas en función del tipo escogido
            
            * @return  {void}

            */
        cargaTarifa = function () {
            //Dependiendo del tipo de tarifa activamos o desactivamos ciertos elementos de la sección
            if (document.getElementById("tipoTarifa").options[document.getElementById("tipoTarifa").selectedIndex].value == "1" || document.getElementById("tipoTarifa").options[document.getElementById("tipoTarifa").selectedIndex].value == "2") {
                document.getElementById('TarifasFijas').rows[1].cells[1].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[2].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[3].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[4].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[1].cells[5].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[1].cells[6].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[1].cells[4].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[1].cells[5].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[1].cells[6].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[2].cells[1].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[2].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[3].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[4].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[2].cells[5].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[2].cells[6].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[2].cells[4].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[2].cells[5].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[2].cells[6].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[1].cells[1].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[2].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[3].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[4].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[1].cells[5].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[1].cells[6].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[2].cells[1].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[2].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[3].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[4].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[2].cells[5].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[2].cells[6].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[3].cells[1].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[2].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[3].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[4].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[3].cells[5].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[3].cells[6].contentEditable = "false";
                document.getElementById('TarifasFijas').rows[3].cells[4].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[3].cells[5].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[3].cells[6].innerHTML = "0";
                document.getElementById('TarifasFijas').rows[3].cells[1].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[2].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[3].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[4].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[3].cells[5].style.backgroundColor = "#d5c7b9";
                document.getElementById('TarifasFijas').rows[3].cells[6].style.backgroundColor = "#d5c7b9";
            } else if (document.getElementById("tipoTarifa").options[document.getElementById("tipoTarifa").selectedIndex].value == "3" || document.getElementById("tipoTarifa").options[document.getElementById("tipoTarifa").selectedIndex].value == "4") {
                document.getElementById('TarifasFijas').rows[1].cells[1].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[2].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[3].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[4].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[5].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[6].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[1].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[2].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[3].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[4].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[5].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[2].cells[6].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[1].cells[1].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[2].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[3].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[4].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[5].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[1].cells[6].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[1].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[2].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[3].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[4].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[5].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[2].cells[6].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[1].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[2].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[3].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[4].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[5].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[6].contentEditable = "true";
                document.getElementById('TarifasFijas').rows[3].cells[1].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[2].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[3].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[4].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[5].style.backgroundColor = "white";
                document.getElementById('TarifasFijas').rows[3].cells[6].style.backgroundColor = "white";
            }
        }
        /**

            *Cargamos los datos de la tarifa de gas          
            * @return  {void}

            */
        cargarTarifaGas = function () {
            //Creamos la sección de factuación
            var menu = "";
            menu += "&lt;span style='margin-top:10px;'>Seleccionar tarifa de gas&lt;/span>";
            menu += "&lt;select id='tipoTarifaGas' style='width: auto;text-align: center; text-align-last: center;'>";
            menu += "&lt;option value='0' hidden > - Selecciona -&lt;/option>";
            menu += "&lt;option value='1'>Tarifa 3.2(5-50 MWh)&lt;/option>";
            menu += "&lt;option value='2'>Tarifa 3.3(50-100 MWh)&lt;/option>";
            menu += "&lt;option value='3'>Tarifa 3.4(100-8000 MWh)&lt;/option>";
            menu += "&lt;option value='4'>Tarifa 3.5(> 8000 MWh)&lt;/option>";
            menu += "&lt;/select>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Caracterísitcas de la tarifa&lt;/span>";
            menu += "&lt;span style='margin-top:10px;'>Término fijo (€/mes)&lt;/span>";
            menu += "&lt;input maxlength='3' step='any' class='+1000 -1  natural' type='number' max='100' min='0' id='fijo'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='10'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Término variable (€/kWh)&lt;/span>";
            menu += "&lt;input maxlength='5' step='any' class='+1000 -1  natural' type='number' max='10000' min='0' id='variable'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='10'>&lt;/br>";
            menu += "&lt;span style='margin-top:10px;'>Consumo máximo tarifa (MWh/año)&lt;/span>";
            menu += "&lt;input maxlength='5' step='any' class='+1000 -1  natural' type='number' max='10000' min='0' id='consumo'  style='margin-top:10px;transform: scale(1);text-align: center;margin-left: 20px;' value='10'>&lt;/br>";
            menu += "&lt;button class='btnMenu' style='margin-top: 50px;background-color:orange;display:flex;' onclick='updateFacturacion()'>Volver&lt;/button>";
            menu += "&lt;button class='btnMenu' style='margin-top: 50px;background-color:orange;display:flex;' onclick='GuardarDatosTarifaG()'>Guardar&lt;/button>";
            document.getElementById("contenido").innerHTML = menu;
            //Cargamos los valores si los hubiera en la base de datos
            if ($scope.tarifaGas.length > 0) {
                for (var y = 0; y &lt; document.getElementById("tipoTarifaGas").options.length; y++) {
                    if (document.getElementById("tipoTarifaGas").options[y].text == $scope.tarifaGas[0].tarifagas) {
                        document.getElementById("tipoTarifaGas").value = document.getElementById("tipoTarifaGas").options[y].value;
                        break;
                    }
                }

                document.getElementById("fijo").value = $scope.tarifaGas[0].terminofijo;
                document.getElementById("variable").value = $scope.tarifaGas[0].terminovariable;
                document.getElementById("consumo").value = $scope.tarifaGas[0].consumomaximotarifa;
            }
            OcultarSpinner();
        }
        /**

            *Guardamos los datos de la facturación       
            * @return  {void}

            */
        GuardarDatosFacturacion = function () {
            var texto = '';
            var tarifa = '';
            var todoCorrecto=true;
            //Comprobamos que los valores de lso campos son correctos
            if (document.getElementById('tension').value=="0") {
                alert('ERROR: Seleccione un campo en tensión');
                todoCorrecto = false;
            }
            if (document.getElementById('tipoTarifa').value == "0") {
                alert('ERROR: Seleccione un campo en tipo de tarifa');
                todoCorrecto = false;
            }
            if (document.getElementById('tipoTarifaGas').value == "0") {
                alert('ERROR: Seleccione un campo en tipo de tarifa de gas');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('interes').value) == false) {
                alert('ERROR: El campo interes con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('inflacion').value) == false) {
                alert('ERROR: El campo inflacion con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('periodo').value) == false) {
                alert('ERROR: El campo periodo con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('subvenciones').value) == false) {
                alert('ERROR: El campo subvenciones con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('reduccionimpuestos').value) == false) {
                alert('ERROR: El campo reduccionimpuestos con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('propano').value) == false) {
                alert('ERROR: El campo propano con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('biomasa').value) == false) {
                alert('ERROR: El campo biomasa con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('gasoleo').value) == false) {
                alert('ERROR: El campo gasoleo con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[1].cells[1].innerHTML) == false) {
                alert('ERROR: El campo término fijo P1 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[1].cells[2].innerHTML) == false) {
                alert('ERROR: El campo término fijo P2 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[1].cells[3].innerHTML) == false) {
                alert('ERROR: El campo término fijo P3 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[1].cells[4].innerHTML) == false) {
                alert('ERROR: El campo término fijo P4 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[1].cells[5].innerHTML) == false) {
                alert('ERROR: El campo término fijo P5 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[1].cells[6].innerHTML) == false) {
                alert('ERROR: El campo término fijo P6 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[2].cells[1].innerHTML) == false) {
                alert('ERROR: El campo término variable P1 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[2].cells[2].innerHTML) == false) {
                alert('ERROR: El campo término variable P2 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[2].cells[3].innerHTML) == false) {
                alert('ERROR: El campo término variable P3 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[2].cells[4].innerHTML) == false) {
                alert('ERROR: El campo término variable P4 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[2].cells[5].innerHTML) == false) {
                alert('ERROR: El campo término variable P5 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[2].cells[6].innerHTML) == false) {
                alert('ERROR: El campo término variable P6 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[3].cells[1].innerHTML) == false) {
                alert('ERROR: El campo potencia contratada P1 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[3].cells[2].innerHTML) == false) {
                alert('ERROR: El campo potencia contratada P2 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[3].cells[3].innerHTML) == false) {
                alert('ERROR: El campo potencia contratada P3 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[3].cells[4].innerHTML) == false) {
                alert('ERROR: El campo potencia contratada P4 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[3].cells[5].innerHTML) == false) {
                alert('ERROR: El campo potencia contratada P5 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('TarifasFijas').rows[3].cells[6].innerHTML) == false) {
                alert('ERROR: El campo potencia contratada P6 con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('fijo').value) == false) {
                alert('ERROR: El campo tarifa término fijo con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('variable').value) == false) {
                alert('ERROR: El campo término variable con valores no numéricos');
                todoCorrecto = false;
            }
            if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('consumo').value) == false) {
                alert('ERROR: El campo consumo máximo tarifa con valores no numéricos');
                todoCorrecto = false;
            }
            if (todoCorrecto == true){
                //Borramos los valores anteriores y después los insertamos
            $http.post("borrarFacturacion.php", { 'idcaso': idCaso, 'base':1 })
                .success(function () {
                    $http.post("insertarFacturacion.php", {
                        'idcaso': idCaso, 'interes': document.getElementById('interes').value,
                        'inflacion': document.getElementById('inflacion').value,
                        'periodo': document.getElementById('periodo').value,
                        'costemantenimiento': document.getElementById('mantenimiento').value,
                        'subvenciones': document.getElementById('subvenciones').value,
                        'reduccionimpuestos': document.getElementById('reduccionimpuestos').value,
                        'costegas': document.getElementById('propano').value,
                        'costebiomasa': document.getElementById('biomasa').value,
                        'costegasoleo': document.getElementById('gasoleo').value,
                        'base':1
                    }).success(function (data) {
                        console.log(data);
                        //recargamos las tablas con valores actualizados
                        $http.post('facturacion.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                            $scope.facturacion = data;
                            ADfacturacion = data;
                            $http.post("borrarTarifaElectrica.php", { 'idcaso': idCaso,'base':1 })
                                .success(function () {
                                    $http.post("insertarTarifaElectrica.php", {
                                        'idcaso': idCaso, 'tension': document.getElementById("tension").options[document.getElementById("tension").selectedIndex].text,
                                        'tarifa': document.getElementById("tipoTarifa").options[document.getElementById("tipoTarifa").selectedIndex].text,
                                        'tfija1': document.getElementById('TarifasFijas').rows[1].cells[1].innerHTML,
                                        'tfija2': document.getElementById('TarifasFijas').rows[1].cells[2].innerHTML,
                                        'tfija3': document.getElementById('TarifasFijas').rows[1].cells[3].innerHTML,
                                        'tfija4': document.getElementById('TarifasFijas').rows[1].cells[4].innerHTML,
                                        'tfija5': document.getElementById('TarifasFijas').rows[1].cells[5].innerHTML,
                                        'tfija6': document.getElementById('TarifasFijas').rows[1].cells[6].innerHTML,
                                        'tvariable1': document.getElementById('TarifasFijas').rows[2].cells[1].innerHTML,
                                        'tvariable2': document.getElementById('TarifasFijas').rows[2].cells[2].innerHTML,
                                        'tvariable3': document.getElementById('TarifasFijas').rows[2].cells[3].innerHTML,
                                        'tvariable4': document.getElementById('TarifasFijas').rows[2].cells[4].innerHTML,
                                        'tvariable5': document.getElementById('TarifasFijas').rows[2].cells[5].innerHTML,
                                        'tvariable6': document.getElementById('TarifasFijas').rows[2].cells[6].innerHTML,
                                        'tpotencia1': document.getElementById('TarifasFijas').rows[3].cells[1].innerHTML,
                                        'tpotencia2': document.getElementById('TarifasFijas').rows[3].cells[2].innerHTML,
                                        'tpotencia3': document.getElementById('TarifasFijas').rows[3].cells[3].innerHTML,
                                        'tpotencia4': document.getElementById('TarifasFijas').rows[3].cells[4].innerHTML,
                                        'tpotencia5': document.getElementById('TarifasFijas').rows[3].cells[5].innerHTML,
                                        'tpotencia6': document.getElementById('TarifasFijas').rows[3].cells[6].innerHTML,
                                        'base':1
                                    }).success(function (data) {
                                        console.log(data);

                                        //recargamos las tablas de tarifa eléctrica con valores actualizados
                                        $http.post('tarifaElectrica.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                                            $scope.tarifaElectrica = data;
                                            //Borramos los valores anteriores y después los insertamos
                                            $http.post("borrarTarifaGas.php", { 'idcaso': idCaso, 'base':1 })
                                                .success(function () {
                                                    $http.post("insertarTarifaGas.php", {
                                                        'idcaso': idCaso,
                                                        'tarifagas': document.getElementById("tipoTarifaGas").options[document.getElementById("tipoTarifaGas").selectedIndex].text,
                                                        'terminofijo': document.getElementById('fijo').value,
                                                        'terminovariable': document.getElementById('variable').value,
                                                        'consumomaximotarifa': document.getElementById('consumo').value,
                                                        'base':1
                                                    }).success(function (data) {
                                                        console.log(data);
                                                        //recargamos las tablas de tarifa gascon valores actualizados
                                                        $http.post('tarifaGas.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                                                            $scope.tarifaGas = data;
                                                            alert("Datos guardados correctamente");
                                                            if ($scope.facturacion.length > 0 &amp;&amp; $scope.tarifaElectrica.length > 0 &amp;&amp; $scope.tarifaGas.length > 0) {
                                                                tarifa = $scope.tarifaElectrica[0].tarifa;
                                                                for (var x = 0; x &lt; tarifa.length; x++) {
                                                                    if (tarifa[x] == '(') {
                                                                        tarifa.substring(0, x);
                                                                    }
                                                                }
                                                                //Creamos la sección de facturación para el motor de cálculo
                                                                texto += '==============================================================================================\r\n';
                                                                texto += '.SECCION = TARIFAS\r\n';
                                                                texto += '"Datos-economicos" = ECONOMICOS\r\n';
                                                                texto += 'Interes_nominal = ' + $scope.facturacion[0].interes + '\r\n';
                                                                texto += 'Inflacion = ' + $scope.facturacion[0].inflacion + '\r\n';
                                                                texto += 'CCV = ' + $scope.facturacion[0].periodo + '\r\n';
                                                                texto += 'Coste_propano = ' + $scope.facturacion[0].costegas + '\r\n';
                                                                texto += 'Coste_biomasa =' + $scope.facturacion[0].costebiomasa + '\r\n';
                                                                texto += 'Coste_gasoleo = ' + $scope.facturacion[0].costegasoleo + '\r\n';
                                                                texto += '    ..\r\n';
                                                                texto += '------------------------------------------------------------------------------\r\n';
                                                                texto += '"Tarifa-electrica" = ELECTRICA\r\n';
                                                                texto += 'Nivel_tension = "' + $scope.tarifaElectrica[0].tension + '"\r\n';
                                                                texto += 'Tipo_tarifa = "' + tarifa + '"\r\n';
                                                                texto += 'Termino_fijo = (' + $scope.tarifaElectrica[0].tfija1 + ', ' + $scope.tarifaElectrica[0].tfija2 + ', ' + $scope.tarifaElectrica[0].tfija3 + ', ' + $scope.tarifaElectrica[0].tfija4 + ', ' + $scope.tarifaElectrica[0].tfija5 + ', ' + $scope.tarifaElectrica[0].tfija6 + ')\r\n';
                                                                texto += 'Termino_variable = (' + $scope.tarifaElectrica[0].tvariable1 + ', ' + $scope.tarifaElectrica[0].tvariable2 + ', ' + $scope.tarifaElectrica[0].tvariable3 + ', ' + $scope.tarifaElectrica[0].tvariable4 + ', ' + $scope.tarifaElectrica[0].tvariable5 + ', ' + $scope.tarifaElectrica[0].tvariable6 + ')\r\n';
                                                                texto += 'Potencia_contratada = (' + $scope.tarifaElectrica[0].tpotencia1 + ', ' + $scope.tarifaElectrica[0].tpotencia2 + ', ' + $scope.tarifaElectrica[0].tpotencia3 + ', ' + $scope.tarifaElectrica[0].tpotencia4 + ', ' + $scope.tarifaElectrica[0].tpotencia5 + ', ' + $scope.tarifaElectrica[0].tpotencia6 + ')\r\n';
                                                                texto += '    ..\r\n';
                                                                texto += '------------------------------------------------------------------------------\r\n';
                                                                texto += '"Tarifa-gas" = GAS\r\n';
                                                                texto += 'Tipo_tarifa = "' + $scope.tarifaGas[0].tarifagas + '"\r\n';
                                                                texto += 'Termino_fijo = ' + $scope.tarifaGas[0].terminofijo + '\r\n';
                                                                texto += 'Termino_variable = ' + $scope.tarifaGas[0].terminovariable + '\r\n';
                                                                texto += 'Consumo_maximo = ' + $scope.tarifaGas[0].consumomaximotarifa + '\r\n';
                                                                texto += '    ..\r\n';
                                                                texto += '------------------------------------------------------------------------------\r\n';
                                                                texto += '.FIN - SECCION\r\n';
                                                                texto += '==============================================================================================\r\n';
                                                                $http.post("GenerarArchivoFacturacion.php", { 'md5': nombremd5, 'contenido': texto })
                                                                    .success(function (data) {
                                                                        console.log(data);
                                                                        if (data.length &lt; 100) {
                                                                            alert("Archivo generado con éxito");
                                                                            OcultarSpinner();
                                                                        } else {
                                                                            alert("ERROR: El archivo no se ha generado");
                                                                            OcultarSpinner();
                                                                        }
                                                                      
                                                                    })
                                                                    .catch(function (error) {
                                                                        alert('Se ha encontrado el siguiente error:\r\n  ' + error.status + ' ' + error.statusText + '\n : ' + error.data + '');
                                                                        return OcultarSpinner();
                                                                    })
                                                                document.getElementById("menu").style.display = "none";
                                                            } else {
                                                                alert("ERROR: Facturación no está definida");
                                                                updateFacturacion();
                                                            }
                                                            vaciarcontenido();
                                                        });
                                                    });
                                                });
                                        });
                                    });
                                });
                        });
                    });
                });
                }
        }
        //Guardamos los datos de la facturación
        updateOptimizacion = async function () {


        }
        /**

            *Dibujamos los buses de la tabla    
            * @return  {void}

            */
        dibujarBuses = function (bus, bus2, colG, colA, longitud) {
            //Dibujamos los colectores asignados al equipo
            for (var x = 0; x &lt; equipos.length; x++) {
                if (bus2 > 0) {
                    if (equipos[x][3] == "C" + bus2 || equipos[x][2] == "C" + bus2) {
                        for (var y = x; y &lt; longitud; y++) {
                            if (typeof (document.getElementById("C" + bus2 + "-" + equipos[y][0])) !== "undefined" &amp;&amp; colA != 0) {
                                document.getElementById("C" + bus2 + "-" + equipos[y][0]).style.visibility = "visible";
                                document.getElementById("C" + bus2 + "-" + equipos[y][0] + "e").style.visibility = "visible";
                                document.getElementById("C" + bus2 + "-" + equipos[y][0] + "s").style.visibility = "visible";
                                document.getElementById("C" + bus2 + "-" + equipos[y][0] + "se").style.visibility = "visible";
                            }
                        }
                    }
                }
                if (bus > 0) {
                    if (equipos[x][2] == "C" + bus || equipos[x][3] == "C" + bus) {
                        for (var y = x; y &lt; longitud; y++) {
                            if (typeof (document.getElementById("C" + bus + "-" + equipos[y][0])) !== "undefined" &amp;&amp; colG != 0) {
                                document.getElementById("C" + bus + "-" + equipos[y][0]).style.visibility = "visible";
                                document.getElementById("C" + bus + "-" + equipos[y][0] + "e").style.visibility = "visible";
                                document.getElementById("C" + bus + "-" + equipos[y][0] + "s").style.visibility = "visible";
                                document.getElementById("C" + bus + "-" + equipos[y][0] + "se").style.visibility = "visible";
                            }
                        }
                    }
                }
            }
        }
        /**

            *Cargamos el menú de edificio existente  
            * @return  {void}

            */
        updateExistente = function () {
            document.getElementById('capturar').style.display = 'block';
            colector = [];
            colectores = [];
            equipos = [];
            caracteristicas = [];
            numFlechas = [];
            numFlechasInversa = [];
            numLineas = [];
            numLineasInversa = [];
            cont = 1;
            var equipoE = false;
            exismod = 0;
            numColector = 1;
            sistema = 0;
            $http.post('equipos.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                $scope.equipo = data;
                $http.post('busesCaso.php', { 'idcaso': idCaso, 'nuex': "Existente",'base':1  }).success(function (data) {
                    $scope.busesCaso = data;

                    for (var x = 0; x &lt; $scope.equipo.length; x++) {
                        if ($scope.equipo[x].nuex == "Existente") {
                            equipoE = true;
                        }
                    }
                    document.getElementById("esquema").style.display = "table";
                    document.getElementById("menu").style = "background-color: white;left:45%;width:auto;";
                    document.getElementById("contenido").style.display = "none";
                    document.getElementById("contenido").innerHTML = "";
                    document.getElementById("lineas").innerHTML = "";
                    document.getElementById("imagenes").style.display = "none";
                    menu = "";
                    num = "0";
                    var esquema = "";
                    var edificio = "";
                    for (var x = 0; x &lt; $scope.caso.length; x++) {
                        if ($scope.caso[x].nombre == nombreCaso) {
                            edificio = $scope.caso[x].idedificio;
                        }
                    }
                   
                    //Recalculamos la distancia de nuevo para situarlo en el centro
                    var widthBody = $(document.getElementById("body")).width();
                    
                    document.getElementById("esquema").innerHTML = esquema;
                    var widthBody = ($(document.getElementById("body")).width() / 2);
                    var widthEsquema = ($(document.getElementById("esquema")).width() / 2);
                    distancia = widthBody - widthEsquema;
                    document.getElementById("esquema").style.left = distancia;
                    document.getElementById("esquema2").innerHTML = "";
                    document.getElementById("lineas").innerHTML = "";
                    if (equipoE == true) {
                        abrir();
                    } else {
                        updatePredefinido(edificio);
                    }
                });
            });
        }
        /**

            *Cargamos el menú de edificio nuevo  
            * @return  {void}

            */
        updateNuevo = function () {
            equiposfiltrados = [];
            nuevainstalacion = 0;
            document.getElementById('capturar').style.display = 'block';
            colector = [];
            colectores = [];
            equipos = [];
            caracteristicas = [];
            numFlechas = [];
            numFlechasInversa = [];
            numLineas = [];
            numLineasInversa = [];
            $scope.selectedColumn = null;
            $scope.selectedRow = null;
            $scope.selectedTDx = null;
            $scope.selectedTDy = null;
            exismod = 1;
            var equipoN = false;
            sistema = 1;
            //Cargamos el menú y las tablas de la base de datos
            document.getElementById("esquema").innerHTML = "";
            document.getElementById("esquema2").innerHTML = "";
            document.getElementById("esquema").style.display = "table";
            document.getElementById("menu").style = "background-color: white;left:45%;width:auto;";
            document.getElementById("contenido").style.display = "none";
            document.getElementById("contenido").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("imagenes").style.display = "none";
            $http.post('equipos.php', { 'idcaso': idCaso, 'base':1 }).success(function (data) {
                $scope.equipo = data;
                $http.post('busesCaso.php', { 'idcaso': idCaso, 'nuex': "Nuevo",'base':1  }).success(function (data) {
                    $scope.busesCaso = data;
                    for (var x = 0; x &lt; $scope.equipo.length; x++) {
                        if ($scope.equipo[x].nuex == "Nuevo") {
                            equipoN = true;
                        }
                    }
                    if ($scope.equipo.length > 0) {
                        if (equipoN == false) {
                            cargarTablaNuevo();
                        } else {
                            abrir();
                        }
                    } else {
                        alert("ERROR: El sistema existente no está definido");
                        document.getElementById("esquema").innerHTML = "";
                        document.getElementById("menu").innerHTML = "";
                    }
                });
            });
        }
         /**

            *Cargamos la tabla de nueva instalación
            * @return  {void}

            */
        cargarTablaNuevo = function () {
        sistema=0;
            colector = [];
            colectores = [];
            equipos = [];
            caracteristicas = [];
            numFlechas = [];
            numFlechasInversa = [];
            numLineas = [];
            numLineasInversa = [];
            document.getElementById("esquema").innerHTML = "";
            document.getElementById("esquema").style.display = "table";
            document.getElementById("menu").style = "background-color: white;left:45%;width:auto;";
            document.getElementById("contenido").style.display = "none";
            document.getElementById("contenido").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("imagenes").style.display = "none";
            $('#tnuevainstalacion').modal('show');
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                if ($scope.caso[x].nombre == nombreCaso) {
                    edificio = $scope.caso[x].idedificio;
                }
            }
            //Funcion para poner X.
            
            for (var x = 1; x &lt; document.getElementById("tnueva").rows.length; x++) {
                for (var y = 1; y &lt; document.getElementById("tnueva").rows[x].cells.length - 1; y++) {
                    document.getElementById("tnueva").rows[x].cells[y].innerHTML = "";
                }
            }
            //Cargamos los equipos asignados a la instalación por defecto según el edificio
            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                var contC = 1;
                var contT = 1;
                var contB = 1;
                var contE = 1;
                var contI = 1;
                var contI87 = 1;
                var contCT = 1;
                var contCA = 1;
                var contP = 1;
                var contCo = 1;
                var contFC = 1;
                var contFS = 1;
                var contCM = 1;
                var contA = 1;
                //Los equipos existentes los tomamos de nuestra instalación de referencia
                if ($scope.equipo[x].nuex == "Existente") {
                    if ($scope.equipo[x].nombre == "Caldera" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[1].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[1].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[1].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[1].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[1].innerHTML = "X";
                        contC++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[1].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }

                    if ($scope.equipo[x].nombre == "Solar Térmica" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[2].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[2].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[2].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[2].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[2].innerHTML = "X";
                        contT++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[2].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Bomba de Calor" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[3].innerHTML = "X";
                        contB++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Enfriadora" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[4].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[4].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[4].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[4].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[4].innerHTML = "X";
                        contE++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[4].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Interacumulador eléctrico" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[7].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[7].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[7].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[7].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[7].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[7].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Máquina absorción simple efecto" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[19].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[19].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[19].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[19].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[19].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[19].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Caldera de condensación" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[11].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[11].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[11].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[11].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[11].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[11].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Caldera de biomasa" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[13].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[13].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[13].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[13].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[13].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[13].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Bomba de calor aire-agua" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[14].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[14].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[14].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[14].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[14].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[14].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Bomba de calor agua-agua" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[15].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[15].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[15].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[15].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[15].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[15].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Solar Térmica Captador plano" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[16].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {17
                                document.getElementById("tnueva").rows[3].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Solar Térmica Captador plano" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[16].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[16].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[16].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if (($scope.equipo[x].nombre == "Otros Eléctricos" || $scope.equipo[x].nombre == "Iluminacion" || $scope.equipo[x].nombre == "Vehículo Eléctrico") &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[29].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[29].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[29].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[29].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[29].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[29].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Solar Térmica Tubos de vacio" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[17].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[17].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[17].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[17].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[17].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[17].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Autonomo Calor" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[3].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            
                        }
                    }
                    if ($scope.equipo[x].nombre == "Autonomo Frio" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[3].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[3].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            
                        }
                    }
                    /*
                    if ($scope.equipo[x].nombre == "Autonomo Calor" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[3].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                           
                        }
                    }
                    if ($scope.equipo[x].nombre == "Autonomo Frio" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[3].innerHTML = "X";
                        contI++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[3].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    */
                    if ($scope.equipo[x].nombre == "Intercambiador de calor" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[8].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[8].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[8].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[8].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[8].innerHTML = "X";
                        contI87++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[8].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Calor Tecnico o Lavanderia" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[21].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[21].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[21].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[21].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[21].innerHTML = "X";
                        contCT++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[21].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Calefacción Alta" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[22].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[22].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[22].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[22].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[22].innerHTML = "X";
                        contCA++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[22].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Piscina" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[23].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[23].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[23].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[23].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[23].innerHTML = "X";
                        contP++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[23].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if (($scope.equipo[x].nombre == "Iluminacion" || $scope.equipo[x].nombre == "Otros Eléctricos" || $scope.equipo[x].nombre == "Vehículo Eléctrico") &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[28].innerHTML = "X";
                        contP++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[6].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[9].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[12].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[15].cells[28].innerHTML = nomBuses[8];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[7].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[10].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[13].cells[28].innerHTML = nomBuses[8];
                                document.getElementById("tnueva").rows[16].cells[28].innerHTML = nomBuses[8];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Condensacion" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[24].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[24].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[24].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[24].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[24].innerHTML = "X";
                        contCo++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[24].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Frio Climatizacion" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[25].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[25].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[25].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[25].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[25].innerHTML = "X";
                        contFC++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[25].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Frio Subcero" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[26].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[26].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[26].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[26].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[26].innerHTML = "X";
                        contFS++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[26].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Calefacción Media" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[27].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[27].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[27].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[27].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[27].innerHTML = "X";
                        contCM++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[27].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "ACS" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[28].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[28].innerHTML = "X";
                        contA++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[28].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Acumulación solar" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[6].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[6].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[6].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[6].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[6].innerHTML = "X";
                        contCM++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[6].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                    if ($scope.equipo[x].nombre == "Acumulación ACS" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                        document.getElementById("tnueva").rows[1].cells[5].innerHTML = "X";
                        document.getElementById("tnueva").rows[5].cells[5].innerHTML = "X";
                        document.getElementById("tnueva").rows[8].cells[5].innerHTML = "X";
                        document.getElementById("tnueva").rows[11].cells[5].innerHTML = "X";
                        document.getElementById("tnueva").rows[14].cells[5].innerHTML = "X";
                        contA++;
                        for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busg &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[2].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[6].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[9].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[12].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[15].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                            if ($scope.busesCaso[y].nombre == $scope.equipo[x].busa &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                document.getElementById("tnueva").rows[3].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[7].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[10].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[13].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];
                                document.getElementById("tnueva").rows[16].cells[5].innerHTML = nomBuses[$scope.busesCaso[y].idbus - 1];

                            }
                        }
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioUsoBusNuip1.length; x++) {
                if ($scope.edificioUsoBusNuip1[x].iduso == "2" &amp;&amp; edificio == $scope.edificioUsoBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[22].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip1[x].idbus != "6") {
                        document.getElementById("tnueva").rows[7].cells[22].innerHTML = nomBuses[$scope.edificioUsoBusNuip1[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip1[x].iduso == "5" &amp;&amp; edificio == $scope.edificioUsoBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[23].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip1[x].idbus != "6") {
                        document.getElementById("tnueva").rows[7].cells[23].innerHTML = nomBuses[$scope.edificioUsoBusNuip1[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip1[x].iduso == "7" &amp;&amp; edificio == $scope.edificioUsoBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[25].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip1[x].idbus != "6") {
                        document.getElementById("tnueva").rows[7].cells[25].innerHTML = nomBuses[$scope.edificioUsoBusNuip1[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip1[x].iduso == "15" &amp;&amp; edificio == $scope.edificioUsoBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[27].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip1[x].idbus != "6") {
                        document.getElementById("tnueva").rows[7].cells[27].innerHTML = nomBuses[$scope.edificioUsoBusNuip1[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip1[x].iduso == "16" &amp;&amp; edificio == $scope.edificioUsoBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[28].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip1[x].idbus != "6") {
                        document.getElementById("tnueva").rows[7].cells[28].innerHTML = nomBuses[$scope.edificioUsoBusNuip1[x].idbus - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioComplementoBusip1.length; x++) {
                if ($scope.edificioComplementoBusip1[x].nombre == "Acumulación ACS" &amp;&amp; edificio == $scope.edificioComplementoBusip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[5].innerHTML = "X";
                    if ($scope.edificioComplementoBusip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip1[x].nombre == "Acumulación solar" &amp;&amp; edificio == $scope.edificioComplementoBusip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[6].innerHTML = "X";
                    if ($scope.edificioComplementoBusip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip1[x].idcomplemento == "17" &amp;&amp; edificio == $scope.edificioComplementoBusip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[8].innerHTML = "X";
                    if ($scope.edificioComplementoBusip1[x].idbusgenera != "6") {
                    } document.getElementById("tnueva").rows[6].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusgenera - 1];
                    if ($scope.edificioComplementoBusip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip1[x].idcomplemento == "18" &amp;&amp; edificio == $scope.edificioComplementoBusip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[9].innerHTML = "X";
                    if ($scope.edificioComplementoBusip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip1[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusExip1.length; x++) {
                if ($scope.edificioServicioBusExip1[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusExip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[1].innerHTML = "X";
                    if ($scope.edificioServicioBusExip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip1[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusExip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[2].innerHTML = "X";
                    if ($scope.edificioServicioBusExip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip1[x].idservicio == "3" &amp;&amp; edificio == $scope.edificioServicioBusExip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[3].innerHTML = "X";
                    if ($scope.edificioServicioBusExip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip1[x].idservicio == "4" &amp;&amp; edificio == $scope.edificioServicioBusExip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[4].innerHTML = "X";
                    if ($scope.edificioServicioBusExip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip1[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusExip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[7].innerHTML = "X";
                    if ($scope.edificioServicioBusExip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip1[x].idbusalimenta - 1];
                    }
                    document.getElementById("tnueva").rows[5].cells[29].innerHTML = "X";
                    document.getElementById("tnueva").rows[6].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    document.getElementById("tnueva").rows[7].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusNuip1.length; x++) {
                if ($scope.edificioServicioBusNuip1[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[16].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip1[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[17].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip1[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[19].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
                /*
                if ($scope.edificioServicioBusNuip1[x].idservicio == "19" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[20].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }*/
                if ($scope.edificioServicioBusNuip1[x].idservicio == "28" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[11].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip1[x].idservicio == "29" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[13].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip1[x].idservicio == "32" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[14].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip1[x].idservicio == "33" &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                    document.getElementById("tnueva").rows[5].cells[15].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip1[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[6].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip1[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[7].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip1[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioUsoBusNuip2.length; x++) {
                if ($scope.edificioUsoBusNuip2[x].iduso == "2" &amp;&amp; edificio == $scope.edificioUsoBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[22].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip2[x].idbus != "6") {
                        document.getElementById("tnueva").rows[10].cells[22].innerHTML = nomBuses[$scope.edificioUsoBusNuip2[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip2[x].iduso == "5" &amp;&amp; edificio == $scope.edificioUsoBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[23].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip2[x].idbus != "6") {
                        document.getElementById("tnueva").rows[10].cells[23].innerHTML = nomBuses[$scope.edificioUsoBusNuip2[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip2[x].iduso == "7" &amp;&amp; edificio == $scope.edificioUsoBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[25].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip2[x].idbus != "6") {
                        document.getElementById("tnueva").rows[10].cells[25].innerHTML = nomBuses[$scope.edificioUsoBusNuip2[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip2[x].iduso == "15" &amp;&amp; edificio == $scope.edificioUsoBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[27].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip2[x].idbus != "6") {
                        document.getElementById("tnueva").rows[10].cells[27].innerHTML = nomBuses[$scope.edificioUsoBusNuip2[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip2[x].iduso == "16" &amp;&amp; edificio == $scope.edificioUsoBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[28].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip2[x].idbus != "6") {
                        document.getElementById("tnueva").rows[10].cells[28].innerHTML = nomBuses[$scope.edificioUsoBusNuip2[x].idbus - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioComplementoBusip2.length; x++) {
                if ($scope.edificioComplementoBusip2[x].nombre == "Acumulación ACS" &amp;&amp; edificio == $scope.edificioComplementoBusip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[5].innerHTML = "X";
                    if ($scope.edificioComplementoBusip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip2[x].nombre == "Acumulación solar" &amp;&amp; edificio == $scope.edificioComplementoBusip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[6].innerHTML = "X";
                    if ($scope.edificioComplementoBusip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip2[x].idcomplemento == "17" &amp;&amp; edificio == $scope.edificioComplementoBusip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[8].innerHTML = "X";
                    if ($scope.edificioComplementoBusip2[x].idbusgenera != "6") {
                    } document.getElementById("tnueva").rows[9].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusgenera - 1];
                    if ($scope.edificioComplementoBusip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip2[x].idcomplemento == "18" &amp;&amp; edificio == $scope.edificioComplementoBusip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[9].innerHTML = "X";
                    if ($scope.edificioComplementoBusip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip2[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusExip2.length; x++) {
                if ($scope.edificioServicioBusExip2[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusExip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[1].innerHTML = "X";
                    if ($scope.edificioServicioBusExip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip2[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusExip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[2].innerHTML = "X";
                    if ($scope.edificioServicioBusExip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip2[x].idservicio == "3" &amp;&amp; edificio == $scope.edificioServicioBusExip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[3].innerHTML = "X";
                    if ($scope.edificioServicioBusExip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip2[x].idservicio == "4" &amp;&amp; edificio == $scope.edificioServicioBusExip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[4].innerHTML = "X";
                    if ($scope.edificioServicioBusExip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip2[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusExip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[7].innerHTML = "X";
                    if ($scope.edificioServicioBusExip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip2[x].idbusalimenta - 1];
                    }
                    document.getElementById("tnueva").rows[8].cells[29].innerHTML = "X";
                    document.getElementById("tnueva").rows[9].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    document.getElementById("tnueva").rows[10].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusNuip2.length; x++) {
                if ($scope.edificioServicioBusNuip2[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[16].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip2[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[17].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip2[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[19].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
                /*
                if ($scope.edificioServicioBusNuip2[x].idservicio == "19" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[20].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }*/
                if ($scope.edificioServicioBusNuip2[x].idservicio == "28" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[11].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip2[x].idservicio == "29" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[13].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip2[x].idservicio == "32" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[14].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip2[x].idservicio == "33" &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                    document.getElementById("tnueva").rows[8].cells[15].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip2[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[9].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip2[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[10].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip2[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioUsoBusNuip3a.length; x++) {
                if ($scope.edificioUsoBusNuip3a[x].iduso == "2" &amp;&amp; edificio == $scope.edificioUsoBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[22].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3a[x].idbus != "6") {
                        document.getElementById("tnueva").rows[13].cells[22].innerHTML = nomBuses[$scope.edificioUsoBusNuip3a[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3a[x].iduso == "5" &amp;&amp; edificio == $scope.edificioUsoBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[23].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3a[x].idbus != "6") {
                        document.getElementById("tnueva").rows[13].cells[23].innerHTML = nomBuses[$scope.edificioUsoBusNuip3a[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3a[x].iduso == "7" &amp;&amp; edificio == $scope.edificioUsoBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[25].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3a[x].idbus != "6") {
                        document.getElementById("tnueva").rows[13].cells[25].innerHTML = nomBuses[$scope.edificioUsoBusNuip3a[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3a[x].iduso == "15" &amp;&amp; edificio == $scope.edificioUsoBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[27].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3a[x].idbus != "6") {
                        document.getElementById("tnueva").rows[13].cells[27].innerHTML = nomBuses[$scope.edificioUsoBusNuip3a[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3a[x].iduso == "16" &amp;&amp; edificio == $scope.edificioUsoBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[28].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3a[x].idbus != "6") {
                        document.getElementById("tnueva").rows[13].cells[28].innerHTML = nomBuses[$scope.edificioUsoBusNuip3a[x].idbus - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioComplementoBusip3a.length; x++) {
                if ($scope.edificioComplementoBusip3a[x].nombre == "Acumulación ACS" &amp;&amp; edificio == $scope.edificioComplementoBusip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[5].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip3a[x].nombre == "Acumulación solar" &amp;&amp; edificio == $scope.edificioComplementoBusip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[6].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip3a[x].idcomplemento == "17" &amp;&amp; edificio == $scope.edificioComplementoBusip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[8].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3a[x].idbusgenera != "6") {
                    } document.getElementById("tnueva").rows[12].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusgenera - 1];
                    if ($scope.edificioComplementoBusip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip3a[x].idcomplemento == "18" &amp;&amp; edificio == $scope.edificioComplementoBusip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[9].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip3a[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusExip3a.length; x++) {
                if ($scope.edificioServicioBusExip3a[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusExip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[1].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3a[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusExip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[2].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3a[x].idservicio == "3" &amp;&amp; edificio == $scope.edificioServicioBusExip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[3].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3a[x].idservicio == "4" &amp;&amp; edificio == $scope.edificioServicioBusExip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[4].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3a[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusExip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[7].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip3a[x].idbusalimenta - 1];
                    }
                    document.getElementById("tnueva").rows[11].cells[29].innerHTML = "X";
                    document.getElementById("tnueva").rows[12].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    document.getElementById("tnueva").rows[13].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusNuip3a.length; x++) {
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[16].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[17].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[19].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }

                if ($scope.edificioServicioBusNuip3a[x].idservicio == "19" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[20].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                    document.getElementById("tnueva").rows[11].cells[29].innerHTML = "X";
                    document.getElementById("tnueva").rows[12].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    document.getElementById("tnueva").rows[13].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                }
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "28" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[11].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "29" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[13].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "32" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[14].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3a[x].idservicio == "33" &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                    document.getElementById("tnueva").rows[11].cells[15].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3a[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[12].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3a[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[13].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip3a[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioUsoBusNuip3b.length; x++) {
                if ($scope.edificioUsoBusNuip3b[x].iduso == "2" &amp;&amp; edificio == $scope.edificioUsoBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[22].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3b[x].idbus != "6") {
                        document.getElementById("tnueva").rows[16].cells[22].innerHTML = nomBuses[$scope.edificioUsoBusNuip3b[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3b[x].iduso == "5" &amp;&amp; edificio == $scope.edificioUsoBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[23].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3b[x].idbus != "6") {
                        document.getElementById("tnueva").rows[16].cells[23].innerHTML = nomBuses[$scope.edificioUsoBusNuip3b[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3b[x].iduso == "7" &amp;&amp; edificio == $scope.edificioUsoBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[25].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3b[x].idbus != "6") {
                        document.getElementById("tnueva").rows[16].cells[25].innerHTML = nomBuses[$scope.edificioUsoBusNuip3b[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3b[x].iduso == "15" &amp;&amp; edificio == $scope.edificioUsoBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[27].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3b[x].idbus != "6") {
                        document.getElementById("tnueva").rows[16].cells[27].innerHTML = nomBuses[$scope.edificioUsoBusNuip3b[x].idbus - 1];
                    }
                }
                if ($scope.edificioUsoBusNuip3b[x].iduso == "16" &amp;&amp; edificio == $scope.edificioUsoBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[28].innerHTML = "X";
                    if ($scope.edificioUsoBusNuip3b[x].idbus != "6") {
                        document.getElementById("tnueva").rows[16].cells[28].innerHTML = nomBuses[$scope.edificioUsoBusNuip3b[x].idbus - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioComplementoBusip3b.length; x++) {
                if ($scope.edificioComplementoBusip3b[x].nombre == "Acumulación ACS" &amp;&amp; edificio == $scope.edificioComplementoBusip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[5].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[5].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip3b[x].nombre == "Acumulación solar" &amp;&amp; edificio == $scope.edificioComplementoBusip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[6].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[6].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip3b[x].idcomplemento == "17" &amp;&amp; edificio == $scope.edificioComplementoBusip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[8].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3b[x].idbusgenera != "6") {
                    } document.getElementById("tnueva").rows[15].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusgenera - 1];
                    if ($scope.edificioComplementoBusip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[8].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioComplementoBusip3b[x].idcomplemento == "18" &amp;&amp; edificio == $scope.edificioComplementoBusip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[9].innerHTML = "X";
                    if ($scope.edificioComplementoBusip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusgenera - 1];
                    } if ($scope.edificioComplementoBusip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[9].innerHTML = nomBuses[$scope.edificioComplementoBusip3b[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusExip3b.length; x++) {
                if ($scope.edificioServicioBusExip3b[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusExip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[1].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[1].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3b[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusExip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[2].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusExip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[2].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3b[x].idservicio == "3" &amp;&amp; edificio == $scope.edificioServicioBusExip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[3].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[3].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3b[x].idservicio == "4" &amp;&amp; edificio == $scope.edificioServicioBusExip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[4].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[4].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusExip3b[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusExip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[7].innerHTML = "X";
                    if ($scope.edificioServicioBusExip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusExip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[7].innerHTML = nomBuses[$scope.edificioServicioBusExip3b[x].idbusalimenta - 1];
                    }
                    document.getElementById("tnueva").rows[14].cells[29].innerHTML = "X";
                    document.getElementById("tnueva").rows[15].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    document.getElementById("tnueva").rows[16].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                }
            }
            for (var x = 0; x &lt; $scope.edificioServicioBusNuip3b.length; x++) {
                if ($scope.edificioServicioBusNuip3b[x].idservicio == "1" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[16].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    }
                    if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[16].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3b[x].idservicio == "2" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[17].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[17].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3b[x].idservicio == "5" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[19].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[19].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }

                if ($scope.edificioServicioBusNuip3b[x].idservicio == "19" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[20].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[20].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                    document.getElementById("tnueva").rows[14].cells[29].innerHTML = "X";
                    document.getElementById("tnueva").rows[15].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    document.getElementById("tnueva").rows[16].cells[29].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                }

                if ($scope.edificioServicioBusNuip3b[x].idservicio == "28" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[11].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[11].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3b[x].idservicio == "29" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[13].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[13].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3b[x].idservicio == "33" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[15].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[15].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }
                if ($scope.edificioServicioBusNuip3b[x].idservicio == "32" &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                    document.getElementById("tnueva").rows[14].cells[14].innerHTML = "X";
                    if ($scope.edificioServicioBusNuip3b[x].idbusgenera != "6") {
                        document.getElementById("tnueva").rows[15].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusgenera - 1];
                    } if ($scope.edificioServicioBusNuip3b[x].idbusalimenta != "6") {
                        document.getElementById("tnueva").rows[16].cells[14].innerHTML = nomBuses[$scope.edificioServicioBusNuip3b[x].idbusalimenta - 1];
                    }
                }
            }
            for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                document.getElementById("tnueva").rows[19].cells[x].innerHTML = "";
                document.getElementById("tnueva").rows[20].cells[x].innerHTML = "";
            }
            /*
            document.getElementById("esquema").style.display = "none";
            document.getElementById("imagenes").style.display = "flex";
            document.getElementById("menu").style = "background-color: none";
            num = "1";
 
            document.getElementById("esquema2").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("contenido").innerHTML = "";
            */
        }
        /**

            *Cargamos el sistema seleccionado
            * @return  {void}

            */
        cargarNuevaInstalacion = function (instalacion) {
            nuevainstalacion = 1;
            cont = 1;
            numColector = 1;
            colector = [];
            colectores = [];
            equipos = [];
            caracteristicas = [];
            numFlechas = [];
            numFlechasInversa = [];
            numLineas = [];
            numLineasInversa = [];
            var menu = "";
            document.getElementById("esquema").innerHTML = "";
            document.getElementById("esquema").style.display = "table";
            document.getElementById("menu").style = "background-color: white;left:45%;width:auto;";
            document.getElementById("contenido").style.display = "none";
            document.getElementById("contenido").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("imagenes").style.display = "none";
            //Creamos de nuevo los botones y su funcionalidad
            menu += "&lt;button class='btnMenu' id='foto' style='background-color:orange;margin-left: 10px;' onclick='guardarCaso()'> Guardar&lt;/button>";
            if (exismod == 0) {
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updatePredefinido(" + edificio + ")'> Existente&lt;/button>";
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2(" + exismod + ")'> Configurar&lt;/button>";
            } else {
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;'onclick='cargarTablaNuevo()'> Nuevo&lt;/button>";
                menu += "&lt;button class='btnMenu' style='margin-left: 10px;' onclick='updateMenu2(" + exismod + ")'> Configurar&lt;/button>";
            }
            var widthBody = ($(document.getElementById("body")).width() / 2);
            var widthEsquema = ($(document.getElementById("esquema")).width() / 2);
            distancia = widthBody - widthEsquema;
            document.getElementById("esquema").style.left = distancia;
            document.getElementById("esquema2").innerHTML = "";
            document.getElementById("lineas").innerHTML = "";
            document.getElementById("menu").innerHTML = menu;
            //cargamos en la última sección de la tabla los equipos de la sección correspondiente
            //Carga en la fila correspondiente el equipo que está marcado con una X en su celda
            switch (instalacion) {
                case 0:
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[19].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[20].cells[x].innerHTML = "";
                    }
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        if (document.getElementById("tnueva").rows[1].cells[x].innerHTML == "X") {
                            document.getElementById("tnueva").rows[18].cells[x].innerHTML = document.getElementById("tnueva").rows[1].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[19].cells[x].innerHTML = document.getElementById("tnueva").rows[2].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[20].cells[x].innerHTML = document.getElementById("tnueva").rows[3].cells[x].innerHTML;
                        }
                    }
                    sistema = 1;
                    break;
                case 1:
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[19].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[20].cells[x].innerHTML = "";
                    }
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[5].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        if (document.getElementById("tnueva").rows[5].cells[x].innerHTML == "X") {
                            document.getElementById("tnueva").rows[18].cells[x].innerHTML = document.getElementById("tnueva").rows[5].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[19].cells[x].innerHTML = document.getElementById("tnueva").rows[6].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[20].cells[x].innerHTML = document.getElementById("tnueva").rows[7].cells[x].innerHTML;
                        }
                    }
                    sistema = 2;
                    break;
                case 2:
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[19].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[20].cells[x].innerHTML = "";
                    }
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[8].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        if (document.getElementById("tnueva").rows[8].cells[x].innerHTML == "X") {
                            document.getElementById("tnueva").rows[18].cells[x].innerHTML = document.getElementById("tnueva").rows[8].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[19].cells[x].innerHTML = document.getElementById("tnueva").rows[9].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[20].cells[x].innerHTML = document.getElementById("tnueva").rows[10].cells[x].innerHTML;
                        }
                    }
                    sistema = 3;
                    break;
                case 3:
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[19].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[20].cells[x].innerHTML = "";
                    }
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[11].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        if (document.getElementById("tnueva").rows[11].cells[x].innerHTML == "X") {
                            document.getElementById("tnueva").rows[18].cells[x].innerHTML = document.getElementById("tnueva").rows[11].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[19].cells[x].innerHTML = document.getElementById("tnueva").rows[12].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[20].cells[x].innerHTML = document.getElementById("tnueva").rows[13].cells[x].innerHTML;
                        }
                    }
                    sistema = 4;
                    break;
                case 4:
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[1].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[19].cells[x].innerHTML = "";
                        document.getElementById("tnueva").rows[20].cells[x].innerHTML = "";
                    }
                    for (var x = 1; x &lt; document.getElementById("tnueva").rows[14].cells.length - 1; x++) {
                        document.getElementById("tnueva").rows[18].cells[x].innerHTML = "";
                        if (document.getElementById("tnueva").rows[14].cells[x].innerHTML == "X") {
                            document.getElementById("tnueva").rows[18].cells[x].innerHTML = document.getElementById("tnueva").rows[14].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[19].cells[x].innerHTML = document.getElementById("tnueva").rows[15].cells[x].innerHTML;
                            document.getElementById("tnueva").rows[20].cells[x].innerHTML = document.getElementById("tnueva").rows[16].cells[x].innerHTML;
                        }
                    }
                    sistema = 5;
                    break;
                case 5:
                if(sistema!=0){
                    combinacionesparametrico = [];
                    if (document.getElementById("tnueva").rows[19].cells[3].innerHTML == "30-35") {
                        updateBusUso(17, "3", "1");
                        updateTable(6, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[20].cells[3].innerHTML == "15-20") {
                        updateBusUso(18, "3", "1");
                        updateTable(7, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[21].innerHTML == "X") {
                        updateBusUso(1, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[22].innerHTML == "X") {
                        updateBusUso(2, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[27].innerHTML == "X") {
                        updateBusUso(15, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[28].innerHTML == "X") {
                        updateBusUso(16, "3", "1");
                    } if (document.getElementById("tnueva").rows[18].cells[24].innerHTML == "X") {
                        updateBusUso(4, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[23].innerHTML == "X") {
                        updateBusUso(5, "3", "1");
                    }
                    
                    if (document.getElementById("tnueva").rows[18].cells[25].innerHTML == "X") {
                        updateBusUso(7, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[26].innerHTML == "X") {
                        updateBusUso(8, "3", "1");
                    }


                        for (var x = 0; x &lt; $scope.equipo.length; x++) {

                            if ($scope.equipo[x].nombre == "Caldera" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(1, "3", "4");
                                document.getElementById("tnueva").rows[18].cells[1].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Solar Térmica" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(2, "3", "4");
                                document.getElementById("tnueva").rows[18].cells[2].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Bomba de Calor" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(3, "3", "4");
                                document.getElementById("tnueva").rows[18].cells[3].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Enfriadora" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(4, "3", "4");
                                document.getElementById("tnueva").rows[18].cells[4].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Interacumulador eléctrico" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(5, "3", "4");
                                document.getElementById("tnueva").rows[18].cells[7].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Caldera de condensación" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(8, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Caldera de biomasa" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(9, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Bomba de calor aire-agua" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(10, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Bomba de calor agua-agua" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(11, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Planta enfriadora con recuperación" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(12, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Solar Térmica Captador plano" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(13, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Solar Térmica Tubos de vacio" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(14, "3", "4");
                            }
                            if ($scope.equipo[x].nombre == "Máquina absorción simple efecto" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateTable(16, "3", "4");
                            }

                            if (($scope.equipo[x].nombre == "Intercambiador" || $scope.equipo[x].nombre == "Intercambiador de calor") &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateComplemento(17, "3", "4");
                                document.getElementById("tnueva").rows[18].cells[8].innerHTML = "";
                            }

                            if ($scope.equipo[x].nombre == "Acumulación ACS" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateComplemento(9, "3", "1");
                                document.getElementById("tnueva").rows[18].cells[5].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Acumulación solar" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateComplemento(9, "3", "2");
                                document.getElementById("tnueva").rows[18].cells[6].innerHTML = "";
                            }
                            if ($scope.equipo[x].nombre == "Almacenamiento sensible" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                updateComplemento(9, "3", "4");
                            }
                            if ($scope.equipo[x].tipo != "1" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                var electrico = false;
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if (($scope.equipo[x].busg == $scope.busesCaso[y].nombre || $scope.equipo[x].busa == $scope.busesCaso[y].nombre) &amp;&amp; $scope.busesCaso[y].idbus == "9") {
                                        electrico = true;
                                    }
                                }

                                if ($scope.equipo[x].nombre == "Otros Eléctricos" &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; electrico == true) {
                                    document.getElementById("tnueva").rows[18].cells[29].innerHTML = "";
                                    updateBusUso(12, "3", "2");
                                }
                                if ($scope.equipo[x].nombre == "Iluminacion" &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; electrico == true) {
                                    document.getElementById("tnueva").rows[18].cells[29].innerHTML = "";
                                    updateBusUso(13, "3", "2");
                                }
                                if ($scope.equipo[x].nombre == "Vehículo Eléctrico" &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; electrico == true) {
                                    document.getElementById("tnueva").rows[18].cells[29].innerHTML = "";
                                    updateBusUso(14, "3", "2");
                                }
                                if ($scope.equipo[x].nombre == "Interacumulador eléctrico" &amp;&amp; $scope.equipo[x].busg == $scope.equipo[x].busa &amp;&amp; electrico == true) {
                                    updateTable(5, "3", "4");
                                }
                                if ($scope.equipo[x].nombre == " Li-ion" &amp;&amp; $scope.equipo[x].busg == $scope.equipo[x].busa &amp;&amp; electrico == true) {
                                    updateComplemento(1, "3", "4");
                                }
                                if ($scope.equipo[x].nombre == " Batería de flujo" &amp;&amp; $scope.equipo[x].busg == $scope.equipo[x].busa &amp;&amp; electrico == true) {
                                    updateComplemento(2, "3", "4");
                                }
                                if ($scope.equipo[x].nombre == " Niquel-Cadmio" &amp;&amp; $scope.equipo[x].busg == $scope.equipo[x].busa &amp;&amp; electrico == true) {
                                    updateComplemento(3, "3", "4");
                                }
                                if ($scope.equipo[x].nombre == " Pb-Ácido avanzadas" &amp;&amp; $scope.equipo[x].busg == $scope.equipo[x].busa &amp;&amp; electrico == true) {
                                    updateComplemento(4, "3", "4");
                                }
                                if ($scope.equipo[x].nombre == " metal-aire" &amp;&amp; $scope.equipo[x].busg == $scope.equipo[x].busa &amp;&amp; electrico == true) {
                                    updateComplemento(5, "3", "4");
                                }
                            }
                        }
                    
                    if (document.getElementById("tnueva").rows[18].cells[29].innerHTML == "X") {
                        updateBusUso(12, "3", "2");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[1].innerHTML == "X") {
                        updateTable(1, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[2].innerHTML == "X") {
                        updateTable(2, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[3].innerHTML == "X" &amp;&amp; document.getElementById("tnueva").rows[19].cells[3].innerHTML != "30-35") {
                        updateTable(3, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[4].innerHTML == "X") {
                        updateTable(4, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[7].innerHTML == "X") {
                        updateTable(5, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[16].innerHTML == "X") {
                        updateTable(1, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[17].innerHTML == "X") {
                        updateTable(2, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[19].innerHTML == "X") {
                        updateTable(5, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[20].innerHTML == "X") {
                        updateTable(19, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[11].innerHTML == "X") {
                        updateTable(28, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[13].innerHTML == "X") {
                        updateTable(29, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[14].innerHTML == "X") {
                        updateTable(32, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[15].innerHTML == "X") {
                        updateTable(33, "3", "1");
                    }
                    
                    if (document.getElementById("tnueva").rows[18].cells[5].innerHTML == "X") {
                        updateComplemento(9, "3", "1");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[6].innerHTML == "X") {
                        updateComplemento(9, "3", "2");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[8].innerHTML == "X") {
                        updateComplemento(17, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[9].innerHTML == "X") {
                        updateComplemento(18, "3", "4");
                    }
                    if (document.getElementById("tnueva").rows[18].cells[10].innerHTML == "X") {
                        updateComplemento(19, "3", "4");
                    }
                    $('#tnuevainstalacion').modal('hide');
                } else {
                alert("ERROR:Seleccione uno de los sistemas");
                }
                    break;


            }

        }
        /**

            *Creamos el botón servicio junto con su línea/s y flecha/s
            * @return  {void}

            */
        updateTable = function (serv, tipo, tipoServ) {
            var tempI = false;
            var tipoEquipo = "";
            var definido;
            var busGE;
            var numEquipos = 1;
            var busGT;
            var busAE;
            var busAT;
            var add;
            var add2;
            var nombre;
            var tipoServicio = "";
            var nombre2;
            var colG = "";
            var colA = "";
            var equipoEx = 0;
            var equipo = new Array();

            for (var x = 0; x &lt; $scope.caso.length; x++) {
                if ($scope.caso[x].nombre == nombreCaso) {
                    edificio = $scope.caso[x].idedificio;
                }
            }
            if (tipo == "1") {
                /*Sacamos el valor del bus/es seleccionado y el valor de nuevo/existente dependiendo del origen de la llamada a la función
                realizando los ajustes a los colectores y a los nombres de los equipos que fueran necesarios*/
                busGE = $('input[name="idBusGenera"]:checked').val();
                if (busGE == 10 || busGE == "10" || busGE == "0" || typeof (busGE) === "undefined") {
                    busGE = "-";
                } else {
                    busGE = busGE.substring(1, busGE.length);
                    busGE = parseInt(busGE);
                }

                busAE = $('input[name="idBusAlimenta"]:checked').val();

                if (busAE == 10 || busAE == "10" || busAE == "0" || typeof (busAE) === "undefined") {
                    busAE = "-";
                } else {
                    busAE = busAE.substring(1, busAE.length);
                    busAE = parseInt(busAE);
                }
                if (tipoServ == "4") {
                    nombre = $scope.serviciosEx[serv - 1].nombre;
                } else {
                    nombre = $scope.servicios[serv - 1].nombre;
                }
                if (exismod == "0") {
                    busGT = "1";
                    busAT = "1";
                } else {
                    busGT = "0";
                    busAT = "0";
                }
                if (busGE == "-" &amp;&amp; busAE == "-") {
                    alert("ERROR: Debe haber al menos un bus conectado a un colector");
                    return;
                }
                if (busGE ==busAE) {
                    alert("ERROR: Los dos colectores deben ser diferentes");
                    return;
                }
                if (tipoServ == "4") {
                    nombre2 = $scope.serviciosEx[serv - 1].nombre;
                    tipoEquipo = $scope.serviciosEx[serv - 1].nombretabladatos;
                    tipoServicio = $scope.serviciosEx[serv - 1].id;


                } else {
                    tipoEquipo = $scope.servicios[serv - 1].nombretabladatos;
                    tipoServicio = $scope.servicios[serv - 1].id;
                    if ($scope.servicios[serv - 1].id == "28") {
                        nombre2 = "Caldera condensación";
                    } else {
                        nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                    }
                }
                for (var x = 0; x &lt; equipos.length; x++) {
                    if (parseInt(equipos[x][0]) >= cont) {
                        cont = parseInt(equipos[x][0]) + 1;
                    }
                }
                definido = "no";
                $('#myModal3').modal('hide');
                $('#myModal').modal('hide');
            }
            else if (tipo == "2") {
                busGE = $scope.equipo[serv].busg;
                numEquipos = $scope.equipo[serv].numequiposiguales;
                if (busGE != "-") {
                    busGE = busGE.substring(1, busGE.length);
                    busGE = parseInt(busGE);
                }
               
                busGT = $scope.equipo[serv].nuex;
                if (busGT == "Nuevo") {
                    busGT = "0";
                } else {
                    busGT = "1";
                }
                busAE = $scope.equipo[serv].busa;
                for (var x = 0; x &lt; $scope.bus.length; x++) {
                    if ($scope.bus[x].nombre == busAE) {
                        busAE = $scope.bus[x].id;
                    }
                }
                if (busAE != "-") {
                    busAE = busAE.substring(1, busAE.length);
                    busAE = parseInt(busAE);
                }
                busAT = $scope.equipo[serv].nuex;
                if (busAT == "Nuevo") {
                    busAT = "0";
                } else {
                    busAT = "1";
                }
                definido = $scope.equipo[serv].definido;
                nombre2 = $scope.equipo[serv].nombre;
                cont = $scope.equipo[serv].id;
                cont = cont - 1;
                if (tipoServ == "1") {
                    for (var x = 0; x &lt; $scope.servicios.length; x++) {
                        nombre = $scope.servicios[x].nombre;

                        if ($scope.servicios[x].id == "28") {
                            nombre3 = "Caldera condensación";
                        } else {
                            nombre3 = nombre.substring(nombre.indexOf(":") + 1);
                        }
                        if (nombre2 == nombre3) {
                            tipoServicio = $scope.servicios[x].id;
                            tipoEquipo = $scope.servicios[x].nombretabladatos;
                        }

                    }
                } else {
                    for (var x = 0; x &lt; $scope.serviciosEx.length; x++) {
                        if ($scope.serviciosEx[x].nombre == nombre2) {
                            tipoServicio = $scope.serviciosEx[x].id;
                            tipoEquipo = $scope.serviciosEx[x].nombretabladatos;
                        }
                    }
                }
               
                $('#myModal').modal('hide');
                $('#myModal3').modal('hide');
                
            }
            else if (tipo == "3") {
                definido = "no";
                if (exismod == 1) {
                    busGT = "0";
                    busAT = "0";
                } else {
                    busGT = "1";
                    busAT = "1";
                }
                if (tipoServ == "4") {

                    nombre2 = Number($scope.serviciosEx[serv - 1].id);
                    tipoServicio = nombre2;
                    tipoEquipo = $scope.serviciosEx[tipoServicio - 1].nombretabladatos;
                    switch (sistema) {
                        case 0:
                            
                            if (serv == "6") {
                                busGE = "14";
                                busAE = "-";
                            } else if (serv == "7") {
                                busGE = "15";
                                busAE = "-";
                            } else {
                                for (var x = 0; x &lt; $scope.edificioServicioBusEx.length; x++) {
                                    if ($scope.edificioServicioBusEx[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusEx[x].idedificio) {
                                        busGE = $scope.edificioServicioBusEx[x].idbusgenera;
                                        if (busGE == "10" || busGE == "6") {
                                            busGE = "-";
                                        }
                                        busAE = $scope.edificioServicioBusEx[x].idbusalimenta;
                                        if (busAE == "10" || busAE == "6") {
                                            busAE = "-";
                                        }
                                        if (serv == "5") {
                                            busGE = "11";
                                        }
                                    }
                                }
                            }
                            // }
                            break;
                        case 1:
                            if (serv == "6") {
                                busGE = "14";
                                busAE = "-";
                            } else if (serv == "7") {
                                busGE = "15";
                                busAE = "-";
                            } else {
                                nombre2 = $scope.serviciosEx[tipoServicio - 1].nombre;
                                for (var x = 0; x &lt; $scope.equipo.length; x++) {
                                    if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente") {

                                        for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                            if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                                colG = $scope.equipo[y].nombre;
                                            }
                                            if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                                colA = $scope.equipo[y].nombre;
                                            }
                                        }

                                        numEquipos = $scope.equipo[x].numequiposiguales;
                                        busGE = $scope.equipo[x].busg;
                                        if (busGE == "10" || busGE == "6") {
                                            busGE = "-";
                                        } else {
                                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                                if ($scope.busesCaso[y].nombre == busGE) {
                                                    busGE = $scope.busesCaso[y].idbus;
                                                }
                                            }
                                        }
                                        equipoEx = x;
                                        definido = $scope.equipo[x].definido;

                                        busAE = $scope.equipo[x].busa;
                                        if (busAE == "10" || busAE == "6") {
                                            busAE = "-";
                                        } else {
                                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                                if ($scope.busesCaso[y].nombre == busAE) {
                                                    busAE = $scope.busesCaso[y].idbus;
                                                }
                                            }
                                        }
                                      
                                    }
                                }
                            }
                            break;
                        case 2:
                            nombre2 = $scope.serviciosEx[tipoServicio - 1].nombre;
                            loop3:
                            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                                guardado = false;
                                if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                    guardado = true;
                                    cargado=false;
                                    loop4:
                                    for (var y=0;y&lt;equipos.length;y++) {
                                        if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                            cargado=true;
                                            break loop4;
                                        }
                                    }
                                    if (cargado == false){
                                        break loop3;
                                        }    
                                }
                               
                            }
                            if (guardado == true) {
                                for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                    if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colG = $scope.equipo[y].nombre;
                                    }
                                    if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colA = $scope.equipo[y].nombre;
                                    }
                                }

                                numEquipos = $scope.equipo[x].numequiposiguales;
                                busGE = $scope.equipo[x].busg;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busGE) {
                                            busGE = (y + 1);
                                        }
                                    }
                                }
                                busGT = "1";
                                busAT = "1";
                                equipoEx = x;
                                definido = $scope.equipo[x].definido;
                                busAE = $scope.equipo[x].busa;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busAE) {
                                            busAE = (y + 1);
                                        }
                                    }
                                }
                            }
                            else {
                                if (serv == "6") {
                                    busGE = "14";
                                    busAE = "-";

                                } else if (serv == "7") {
                                    busGE = "15";
                                    busAE = "-";

                                } else {
                                    for (var x = 0; x &lt; $scope.edificioServicioBusExip1.length; x++) {
                                        if ($scope.edificioServicioBusExip1[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusExip1[x].idedificio) {
                                            busGE = $scope.edificioServicioBusExip1[x].idbusgenera;
                                            if (busGE == "10" || busGE == "6") {
                                                busGE = "-";
                                            }
                                            busAE = $scope.edificioServicioBusExip1[x].idbusalimenta;
                                            if (busAE == "10" || busAE == "6") {
                                                busAE = "-";
                                            }

                                        }
                                    }
                                }
                            }


                            break;
                        case 3:
                            nombre2 = $scope.serviciosEx[tipoServicio - 1].nombre;
                            loop3:
                            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                                guardado = false;
                                if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                    guardado = true;
                                    cargado = false;
                                    loop4:
                                    for (var y = 0; y &lt; equipos.length; y++) {
                                        if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                            cargado = true;
                                            break loop4;
                                        }
                                    }

                                    if (cargado == false) {
                                        break loop3;
                                    }
                             }

                            }
                            if (guardado == true) {
                                for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                    if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colG = $scope.equipo[y].nombre;
                                    }
                                    if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colA = $scope.equipo[y].nombre;
                                    }
                                }

                                numEquipos = $scope.equipo[x].numequiposiguales;
                                busGE = $scope.equipo[x].busg;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busGE) {
                                            busGE = (y + 1);
                                        }
                                    }
                                }
                                busGT = "1";
                                busAT = "1";
                                equipoEx = x;
                                definido = $scope.equipo[x].definido;
                                busAE = $scope.equipo[x].busa;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busAE) {
                                            busAE = (y + 1);
                                        }
                                    }
                                }
                            }
                            else {
                                if (serv == "6") {
                                    busGE = "14";
                                    busAE = "-";

                                } else if (serv == "7") {
                                    busGE = "15";
                                    busAE = "-";

                                } else {
                                    for (var x = 0; x &lt; $scope.edificioServicioBusExip2.length; x++) {
                                        if ($scope.edificioServicioBusExip2[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusExip2[x].idedificio) {
                                            busGE = $scope.edificioServicioBusExip2[x].idbusgenera;
                                            if (busGE == "10" || busGE == "6") {
                                                busGE = "-";
                                            }
                                            busAE = $scope.edificioServicioBusExip2[x].idbusalimenta;
                                            if (busAE == "10" || busAE == "6") {
                                                busAE = "-";
                                            }

                                        }
                                    }
                                }
                            }

                            break;
                        case 4:
                            nombre2 = $scope.serviciosEx[tipoServicio - 1].nombre;
                            loop3:
                            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                                guardado = false;
                                if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                    guardado = true;
                                    cargado = false;
                                    loop4:
                                    for (var y = 0; y &lt; equipos.length; y++) {
                                        if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                            cargado = true;
                                            break loop4;
                                        }
                                    }
                                    
                                    if (cargado == false) {
                                        break loop3;
                                    }
                                }

                            }
                            if (guardado == true) {
                                for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                    if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colG = $scope.equipo[y].nombre;
                                    }
                                    if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colA = $scope.equipo[y].nombre;
                                    }
                                }

                                numEquipos = $scope.equipo[x].numequiposiguales;
                                busGE = $scope.equipo[x].busg;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busGE) {
                                            busGE = (y + 1);
                                        }
                                    }
                                }
                                busGT = "1";
                                busAT = "1";
                                equipoEx = x;
                                definido = $scope.equipo[x].definido;
                                busAE = $scope.equipo[x].busa;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busAE) {
                                            busAE = (y + 1);
                                        }
                                    }
                                }
                            }
                            else {
                                if (serv == "6") {
                                    busGE = "14";
                                    busAE = "-";

                                } else if (serv == "7") {
                                    busGE = "15";
                                    busAE = "-";

                                } else {
                                    for (var x = 0; x &lt; $scope.edificioServicioBusExip3a.length; x++) {
                                        if ($scope.edificioServicioBusExip3a[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusExip3a[x].idedificio) {
                                            busGE = $scope.edificioServicioBusExip3a[x].idbusgenera;
                                            if (busGE == "10" || busGE == "6") {
                                                busGE = "-";
                                            }
                                            busAE = $scope.edificioServicioBusExip3a[x].idbusalimenta;
                                            if (busAE == "10" || busAE == "6") {
                                                busAE = "-";
                                            }

                                        }
                                    }
                                }
                            }
                            break;
                        case 5:
                            nombre2 = $scope.serviciosEx[tipoServicio - 1].nombre;
                            loop3:
                            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                                guardado = false;
                                if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                    guardado = true;
                                    cargado = false;
                                    loop4:
                                    for (var y = 0; y &lt; equipos.length; y++) {
                                        if ( equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                            cargado = true;
                                            break loop4;
                                        }
                                    }

                                    if (cargado == false) {
                                        break loop3;
                                    }
                                }

                            }
                            if (guardado == true) {
                                for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                    if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colG = $scope.equipo[y].nombre;
                                    }
                                    if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colA = $scope.equipo[y].nombre;
                                    }
                                }

                                numEquipos = $scope.equipo[x].numequiposiguales;
                                busGE = $scope.equipo[x].busg;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busGE) {
                                            busGE = (y + 1);
                                        }
                                    }
                                }
                                busGT = "1";
                                busAT = "1";
                                equipoEx = x;
                                definido = $scope.equipo[x].definido;
                                busAE = $scope.equipo[x].busa;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busAE) {
                                            busAE = (y + 1);
                                        }
                                    }
                                }
                            }
                            else {
                                if (serv == "6") {
                                    busGE = "14";
                                    busAE = "-";

                                } else if (serv == "7") {
                                    busGE = "15";
                                    busAE = "-";
                                } else {
                                    for (var x = 0; x &lt; $scope.edificioServicioBusExip3b.length; x++) {
                                        if ($scope.edificioServicioBusExip3b[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusExip3b[x].idedificio) {
                                            busGE = $scope.edificioServicioBusExip3b[x].idbusgenera;
                                            if (busGE == "10" || busGE == "6") {
                                                busGE = "-";
                                            }
                                            busAE = $scope.edificioServicioBusExip3b[x].idbusalimenta;
                                            if (busAE == "10" || busAE == "6") {
                                                busAE = "-";
                                            }

                                        }
                                    }
                                }
                            }
                            break;
                    }
                }
                else {
                    nombre2 = Number($scope.servicios[serv - 1].id);
                    tipoServicio = nombre2;
                    tipoEquipo = $scope.servicios[tipoServicio - 1].nombretabladatos;

                    switch (sistema) {
                        case 1:
                            for (var x = 0; x &lt; $scope.equipo.length; x++) {
                                if ($scope.edificioServicioBusNuip1[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                                    busGE = $scope.edificioServicioBusNuip1[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioServicioBusNuip1[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                            break;
                        case 2:
                            for (var x = 0; x &lt; $scope.edificioServicioBusNuip1.length; x++) {
                                if ($scope.edificioServicioBusNuip1[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusNuip1[x].idedificio) {
                                    busGE = $scope.edificioServicioBusNuip1[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioServicioBusNuip1[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                            break;
                        case 3:
                            for (var x = 0; x &lt; $scope.edificioServicioBusNuip2.length; x++) {
                                if ($scope.edificioServicioBusNuip2[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusNuip2[x].idedificio) {
                                    busGE = $scope.edificioServicioBusNuip2[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioServicioBusNuip2[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                            break;
                        case 4:
                            for (var x = 0; x &lt; $scope.edificioServicioBusNuip3a.length; x++) {
                                if ($scope.edificioServicioBusNuip3a[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusNuip3a[x].idedificio) {
                                    busGE = $scope.edificioServicioBusNuip3a[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioServicioBusNuip3a[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                            break;
                        case 5:
                            for (var x = 0; x &lt; $scope.edificioServicioBusNuip3b.length; x++) {
                                if ($scope.edificioServicioBusNuip3b[x].idservicio == serv &amp;&amp; edificio == $scope.edificioServicioBusNuip3b[x].idedificio) {
                                    busGE = $scope.edificioServicioBusNuip3b[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioServicioBusNuip3b[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                            break;
                    }
                }
                if (nombre2 == 28) {
                    nombre2 = "Caldera condensación";
                    busGE = "3";
                    busAE = "3";
                } else {
                    if (tipoServ == "4") {
                        nombre2 = $scope.serviciosEx[tipoServicio - 1].nombre;
                    } else {
                        nombre2 = $scope.servicios[tipoServicio - 1].nombre;
                    }
                    nombre2 = nombre2.substring(nombre2.indexOf(":") + 1);
                }
                // if (mismo==true) {
                if (colG == "" &amp;&amp; colA == "") {
                    for (var x = 0; x &lt; colectores.length; x++) {

                        if (busGE == colectores[x][1]) {
                            busGE = colectores[x][0];
                            busGE = busGE.substring(1, busGE.length);
                            busGE = parseInt(busGE);
                        }
                        if (busAE == colectores[x][1]) {
                            busAE = colectores[x][0];
                            busAE = busAE.substring(1, busAE.length);
                            busAE = parseInt(busAE);
                        }
                    }
                } else {
                    for (var x = 0; x &lt; equipos.length; x++) {
                        if (equipos[x][1] == colG) {
                            busGE = equipos[x][3];
                            busGE = busGE.substring(1, busGE.length);
                            busGE = parseInt(busGE);
                        }
                        if (equipos[x][1] == colA) {
                            busAE = equipos[x][3];
                            busAE = busAE.substring(1, busAE.length);
                            busAE = parseInt(busAE);
                        }
                    }
                }

                $('#myModal').modal('hide');
                $('#myModal3').modal('hide');
            }
            //Si solo tiene bus genera
            if (busGE > 0 &amp;&amp; (typeof busAE === "undefined" || busAE == "-") &amp;&amp; tempI == false) {
                console.log(nombre2,busGE);
                var colectorG = "";
                var colector = "";
                var numBusGE = 0;
                //Almacenamos el número de la línea y flecha
                numFlechas.push(cont);
                numLineas.push(cont);
                numFlechasInversa.push(cont);
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                //Hace falta añadir el tipo de servicio
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (busGE == colectores[x][1]) {
                        colectorG = (x + 1);
                    }
                }
                if (tipoServ == "4") {
                    add += "&lt;td class='servicios'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasEx(4,0," + busGE + ",0," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                } else {
                    add += "&lt;td class='servicios'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicas(1,0," + busGE + ",0," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                }
                var busCG = 0;
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (parseInt(colectores[x][1]) == busGE &amp;&amp; x &lt; numColector) {
                        numBusGE++;
                    }
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    if (busGE == busC) {
                        colectorG = colectores[x][1];
                        if (colectorG == "11") {
                            colectorG = "3";
                        }
                        if (colectorG == "14") {
                            colectorG = "4";
                        }
                        if (colectorG == "15") {
                            colectorG = "6";
                        }
                        busCG = busC;
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "' style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "'id='" + colectores[x][0] + "-" + cont + "'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "e' style='width:13.375px;'>&lt;/td>\n";
                    }
                }
                
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 = "&lt;tr id='trSerEspacio" + cont + "'>\n";
                add2 += "&lt;td class='servicios' style='height:15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='height:15px'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC) {
                        colectorG = colectores[x][1];
                        if (colectorG == "11") {
                            colectorG = "3";
                        }
                        if (colectorG == "14") {
                            colectorG = "4";
                        }
                        if (colectorG == "15") {
                            colectorG = "6";
                        }
                        busCG = busC;
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s' style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s' style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "se' style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                lineasCreadas[busC - 1] = true;
                //Ponemos a true el radio del bus correspondiente

                //sacamos los valores para calcular la posición de la flecha y la línea
                alturaSer = document.getElementsByClassName("servicios")[document.getElementsByClassName("servicios").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCG + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea
                leftLineas = long + distancia - 2;
                widthLineas = izq - (leftB + long) + 5;
                topLineas = topB + (alt / 2) + 80;
                leftFlecha = long + distancia - 10;
                topFlecha = topB + (alt / 2) + 67;
                var linea = "&lt;section class='connectingLines" + colectorG + "' id='lineaSer" + cont + "' style='left:" + leftLineas + "px; top:" + topLineas + "px; width:" + widthLineas + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //Creamos la flecha
                var flecha = "&lt;img class='flecha" + colectorG + "' src='flecha" + colectorG + ".png'   id='flechaSer" + cont + "'style='left:" + (leftLineas + widthLineas - 30) + "px; top:" + topFlecha + "px;'>";
                var flecha2 = "&lt;img class='flecha" + colectorG + "' src='flechaInversa" + colectorG + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 10) + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que esté definido
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        if (tipoServ == "4") {
                            document.getElementById(cont).style.border = "thick solid red";
                            equipo = [cont, nombre2, "C" + busCG, "-", "Existente", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        } else {
                            document.getElementById(cont).style.border = "thick solid green";
                            equipo = [cont, nombre2, "C" + busCG, "-", "Nuevo", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        }
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "-", "Existente", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        if (tipoServ == "4") {
                            document.getElementById(cont).style.border = "solid 1px black";
                            equipo = [cont, nombre2, "C" + busCG, "-", "Existente", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        } else {
                            document.getElementById(cont).style.border = "solid 1px black";
                            equipo = [cont, nombre2, "C" + busCG, "-", "Nuevo", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        }
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "-", "Existente", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //Si está definido cargamos los valores en características
                if (definido == "si") {
                    equipos[equipos.length - 1][8] = $scope.equipo[equipoEx].idcontador;
                    equipos[equipos.length - 1][9] = $scope.equipo[equipoEx].nombreequipo;
                    caracteristicas[equipos.length - 1][0] = $scope.equipo[equipoEx].atr1;
                    caracteristicas[equipos.length - 1][1] = $scope.equipo[equipoEx].atr2;
                    caracteristicas[equipos.length - 1][2] = $scope.equipo[equipoEx].atr3;
                    caracteristicas[equipos.length - 1][3] = $scope.equipo[equipoEx].atr4;
                    caracteristicas[equipos.length - 1][4] = $scope.equipo[equipoEx].atr5;
                    caracteristicas[equipos.length - 1][5] = $scope.equipo[equipoEx].atr6;
                    caracteristicas[equipos.length - 1][6] = $scope.equipo[equipoEx].atr7;
                    caracteristicas[equipos.length - 1][7] = $scope.equipo[equipoEx].atr8;
                    caracteristicas[equipos.length - 1][8] = $scope.equipo[equipoEx].atr9;
                    caracteristicas[equipos.length - 1][9] = $scope.equipo[equipoEx].atr10;
                    caracteristicas[equipos.length - 1][10] = $scope.equipo[equipoEx].atr11;
                    caracteristicas[equipos.length - 1][11] = $scope.equipo[equipoEx].atr12;
                    caracteristicas[equipos.length - 1][12] = $scope.equipo[equipoEx].atr13;
                    caracteristicas[equipos.length - 1][13] = $scope.equipo[equipoEx].atr14;
                    caracteristicas[equipos.length - 1][14] = $scope.equipo[equipoEx].atr15;
                    caracteristicas[equipos.length - 1][15] = $scope.equipo[equipoEx].atr16;
                    valoresServiciosComplementos[equipos.length - 1][0] = $scope.equipo[equipoEx].valoresservicio1;
                    valoresServiciosComplementos[equipos.length - 1][1] = $scope.equipo[equipoEx].valoresservicio2;
                    valoresServiciosComplementos[equipos.length - 1][2] = $scope.equipo[equipoEx].valoresservicio3;
                    valoresServiciosComplementos[equipos.length - 1][3] = $scope.equipo[equipoEx].valoresservicio4;
                    valoresServiciosComplementos[equipos.length - 1][4] = $scope.equipo[equipoEx].valoresservicio5;
                    valoresServiciosComplementos[equipos.length - 1][5] = $scope.equipo[equipoEx].valoresservicio6;
                    valoresServiciosComplementos[equipos.length - 1][6] = $scope.equipo[equipoEx].valoresservicio7;
                    valoresServiciosComplementos[equipos.length - 1][7] = $scope.equipo[equipoEx].valoresservicio8;
                    valoresServiciosComplementos[equipos.length - 1][8] = $scope.equipo[equipoEx].valoresservicio9;
                    valoresServiciosComplementos[equipos.length - 1][9] = $scope.equipo[equipoEx].valoresservicio10;
                    valoresServiciosComplementos[equipos.length - 1][10] = $scope.equipo[equipoEx].valoresservicio11;
                    valoresServiciosComplementos[equipos.length - 1][11] = $scope.equipo[equipoEx].valoresservicio12;
                    valoresServiciosComplementos[equipos.length - 1][12] = $scope.equipo[equipoEx].valoresservicio13;
                    valoresServiciosComplementos[equipos.length - 1][13] = $scope.equipo[equipoEx].valoresservicio14;
                    valoresServiciosComplementos[equipos.length - 1][14] = $scope.equipo[equipoEx].valoresservicio15;
                    valoresServiciosComplementos[equipos.length - 1][15] = $scope.equipo[equipoEx].valoresservicio16;
                    valoresServiciosComplementos[equipos.length - 1][16] = $scope.equipo[equipoEx].valoresservicio17;
                    valoresServiciosComplementos[equipos.length - 1][17] = $scope.equipo[equipoEx].valoresservicio18;
                    valoresServiciosComplementos[equipos.length - 1][18] = $scope.equipo[equipoEx].valoresservicio19;
                    valoresServiciosComplementos[equipos.length - 1][19] = $scope.equipo[equipoEx].valoresservicio20;
                    valoresServiciosComplementos[equipos.length - 1][20] = $scope.equipo[equipoEx].valoresservicio21;
                    valoresServiciosComplementos[equipos.length - 1][21] = $scope.equipo[equipoEx].valoresservicio22;
                    valoresServiciosComplementos[equipos.length - 1][22] = $scope.equipo[equipoEx].valoresservicio23;
                    valoresServiciosComplementos[equipos.length - 1][23] = $scope.equipo[equipoEx].valoresservicio24;
                    valoresServiciosComplementos[equipos.length - 1][24] = $scope.equipo[equipoEx].valoresservicio25;
                    valoresServiciosComplementos[equipos.length - 1][25] = $scope.equipo[equipoEx].valoresservicio26;
                    valoresServiciosComplementos[equipos.length - 1][26] = $scope.equipo[equipoEx].valoresservicio27;
                    valoresServiciosComplementos[equipos.length - 1][27] = $scope.equipo[equipoEx].valoresservicio28;
                    valoresServiciosComplementos[equipos.length - 1][28] = $scope.equipo[equipoEx].valoresservicio29;
                    valoresServiciosComplementos[equipos.length - 1][29] = $scope.equipo[equipoEx].valoresservicio30;
                    valoresServiciosComplementos[equipos.length - 1][30] = $scope.equipo[equipoEx].valoresservicio31;
                    valoresServiciosComplementos[equipos.length - 1][31] = $scope.equipo[equipoEx].valoresservicio32;
                    valoresServiciosComplementos[equipos.length - 1][32] = $scope.equipo[equipoEx].valoresservicio33;
                    valoresServiciosComplementos[equipos.length - 1][33] = $scope.equipo[equipoEx].valoresservicio34;
                    valoresServiciosComplementos[equipos.length - 1][34] = $scope.equipo[equipoEx].valoresservicio35;
                    valoresServiciosComplementos[equipos.length - 1][35] = $scope.equipo[equipoEx].valoresservicio36;
                    valoresServiciosComplementos[equipos.length - 1][36] = $scope.equipo[equipoEx].valoresservicio37;
                    valoresServiciosComplementos[equipos.length - 1][37] = $scope.equipo[equipoEx].valoresservicio38;
                    valoresServiciosComplementos[equipos.length - 1][38] = $scope.equipo[equipoEx].valoresservicio39;
                    valoresServiciosComplementos[equipos.length - 1][39] = $scope.equipo[equipoEx].valoresservicio40;
                    valoresServiciosComplementos[equipos.length - 1][40] = $scope.equipo[equipoEx].valoresservicio41;
                    valoresServiciosComplementos[equipos.length - 1][41] = $scope.equipo[equipoEx].valoresservicio42;
                    valoresServiciosComplementos[equipos.length - 1][42] = $scope.equipo[equipoEx].valoresservicio43;
                    valoresServiciosComplementos[equipos.length - 1][43] = $scope.equipo[equipoEx].valoresservicio44;
                    valoresServiciosComplementos[equipos.length - 1][44] = $scope.equipo[equipoEx].valoresservicio45;
                    valoresServiciosComplementos[equipos.length - 1][45] = $scope.equipo[equipoEx].valoresservicio46;
                    valoresServiciosComplementos[equipos.length - 1][46] = $scope.equipo[equipoEx].valoresservicio47;
                    valoresServiciosComplementos[equipos.length - 1][47] = $scope.equipo[equipoEx].valoresservicio48;
                    valoresServiciosComplementos[equipos.length - 1][48] = $scope.equipo[equipoEx].valoresservicio49;
                    valoresServiciosComplementos[equipos.length - 1][49] = $scope.equipo[equipoEx].valoresservicio50;
                    valoresServiciosComplementos[equipos.length - 1][50] = $scope.equipo[equipoEx].valoresservicio51;
                    valoresServiciosComplementos[equipos.length - 1][51] = $scope.equipo[equipoEx].valoresservicio52;
                    valoresServiciosComplementos[equipos.length - 1][52] = $scope.equipo[equipoEx].valoresservicio53;
                    valoresServiciosComplementos[equipos.length - 1][53] = $scope.equipo[equipoEx].valoresservicio54;
                    valoresServiciosComplementos[equipos.length - 1][54] = $scope.equipo[equipoEx].valoresservicio55;
                    valoresServiciosComplementos[equipos.length - 1][55] = $scope.equipo[equipoEx].valoresservicio56;
                    valoresServiciosComplementos[equipos.length - 1][56] = $scope.equipo[equipoEx].valoresservicio57;
                    valoresServiciosComplementos[equipos.length - 1][57] = $scope.equipo[equipoEx].valoresservicio58;
                    valoresServiciosComplementos[equipos.length - 1][58] = $scope.equipo[equipoEx].valoresservicio59;
                    valoresServiciosComplementos[equipos.length - 1][59] = $scope.equipo[equipoEx].valoresservicio60;
                    valoresServiciosComplementos[equipos.length - 1][60] = $scope.equipo[equipoEx].valoresservicio61;
                    valoresServiciosComplementos[equipos.length - 1][61] = $scope.equipo[equipoEx].valoresservicio62;
                    valoresServiciosComplementos[equipos.length - 1][62] = $scope.equipo[equipoEx].valoresservicio63;
                    valoresServiciosComplementos[equipos.length - 1][63] = $scope.equipo[equipoEx].valoresservicio64;
                    valoresServiciosComplementos[equipos.length - 1][64] = $scope.equipo[equipoEx].valoresservicio65;
                    valoresServiciosComplementos[equipos.length - 1][65] = $scope.equipo[equipoEx].valoresservicio66;
                    valoresServiciosComplementos[equipos.length - 1][66] = $scope.equipo[equipoEx].valoresservicio67;
                    valoresServiciosComplementos[equipos.length - 1][67] = $scope.equipo[equipoEx].valoresservicio68;
                    valoresServiciosComplementos[equipos.length - 1][68] = $scope.equipo[equipoEx].valoresservicio69;
                    valoresServiciosComplementos[equipos.length - 1][69] = $scope.equipo[equipoEx].valoresservicio70;
                    valoresServiciosComplementos[equipos.length - 1][70] = $scope.equipo[equipoEx].valoresservicio71;
                    valoresServiciosComplementos[equipos.length - 1][71] = $scope.equipo[equipoEx].valoresservicio72;
                    valoresServiciosComplementos[equipos.length - 1][72] = $scope.equipo[equipoEx].valoresservicio73;
                    valoresServiciosComplementos[equipos.length - 1][73] = $scope.equipo[equipoEx].valoresservicio74;
                    valoresServiciosComplementos[equipos.length - 1][74] = $scope.equipo[equipoEx].valoresservicio75;
                }
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado
                
                cont++;
                dibujarBuses(busCG, 0, colectorG, 0, equipos.length);
            }
            //Si solo tiene bus alimenta
            if (busAE > 0 &amp;&amp; (typeof busGE === "undefined" || busGE == "-") &amp;&amp; tempI == false) {
                //Si el contador de servicios es 0
                var colectorA = "";
                var colector = "";
                var numBusAE = 0;
                //Almacenamos el número de la línea y flecha
                numFlechasInversa.push(cont);
                numLineasInversa.push(cont);
                numFlechas.push(cont);
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                //Hace falta añadir el tipo de servicio
                if (tipoServ == "4") {
                    add += "&lt;td class='servicios'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasEx(4,1,0," + busAE + "," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                } else {
                    add += "&lt;td class='servicios'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicas(1,1,0," + busAE + "," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                }
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                var busCA = 0;
                for (var x = 0; x &lt; colectores.length; x++) {

                    if (parseInt(colectores[x][1]) == busAE &amp;&amp; x &lt; numColector) {
                        numBusAE++;
                    }
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busAE == busC) {
                        colectorA = colectores[x][1];
                        if (colectorA == "11") {
                            colectorA = "3";
                        }
                        if (colectorA == "14") {
                            colectorA = "4";
                        }
                        if (colectorA == "15") {
                            colectorA = "6";
                        }
                        busCA = busC;
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "' style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "e' style='width:13.375px;'>&lt;/td>\n";
                    }
                }
                
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 = "&lt;tr id='trSerEspacio" + cont + "'>\n";
                add2 += "&lt;td class='servicios' style='height:15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='height:15px'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busAE == busC) {
                        colectorA = colectores[x][1];
                        if (colectorA == "11") {
                            colectorA = "3";
                        }
                        if (colectorA == "14") {
                            colectorA = "4";
                        }
                        if (colectorA == "15") {
                            colectorA = "6";
                        }
                        busCA = busC;
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s' style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s' style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "se' style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                //Ponemos a true el radio del bus correspondiente
                lineasCreadas[busC - 1] = true;

                //sacamos los valores para calcular la posición de la flecha y la línea
                alturaSer = document.getElementsByClassName("servicios")[document.getElementsByClassName("servicios").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCA + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea
                leftLineasInversa = long + distancia - 2;
                widthLineasInversa = izq - (leftB + long) + 5;
                topLineasInversa = topB + (alt / 2) + 100;
                leftFlechaInversa = long - 10 + distancia;
                topFlechaInversa = topB + (alt / 2) + 87;
                var flecha = "&lt;img class='flecha" + colectorA + "' src='flecha" + colectorA + ".png'   id='flechaSer" + cont + "A'style='left:" + (leftLineasInversa + widthLineasInversa - 28) + "px; top:" + topFlechaInversa + "px;'>";
                var flecha2 = "&lt;img class='flecha" + colectorA + "' src='flechaInversa" + colectorA + ".png'   id='flechaSerInversa" + cont + "A'style='left:" + (leftFlechaInversa) + "px; top:" + topFlechaInversa + "px;'>";
                //creamos la flecha
                var linea = "&lt;section class='connectingLines" + colectorA + "' id='lineaSerInversa" + cont + "' style='left:" + leftLineasInversa + "px; top:" + topLineasInversa + "px; width:" + widthLineasInversa + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //Almacenamos en equipos el equipo creado y comprobamos que esté definido
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        if (tipoServ == "4") {
                            document.getElementById(cont).style.border = "thick solid red";
                            equipo = [cont, nombre2, "-", "C" + busCA, "Existente", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        } else {
                            document.getElementById(cont).style.border = "thick solid green";
                            equipo = [cont, nombre2, "-", "C" + busCA, "Nuevo", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        }
                    } else {
                        equipo = [cont, nombre2, "-", "C" + busCA, "Existente", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        if (tipoServ == "4") {
                            document.getElementById(cont).style.border = "solid 1px black";
                            equipo = [cont, nombre2, "-", "C" + busCA, "Existente", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        } else {
                            document.getElementById(cont).style.border = "solid 1px black";
                            equipo = [cont, nombre2, "-", "C" + busCA, "Nuevo", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        }
                    } else {
                        equipo = [cont, nombre2, "-", "C" + busCA, "Existente", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //Si está definido cargamos los valores en características
                if (definido == "si") {
                    equipos[equipos.length - 1][8] = $scope.equipo[equipoEx].idcontador;
                    equipos[equipos.length - 1][9] = $scope.equipo[equipoEx].nombreequipo;
                    caracteristicas[equipos.length - 1][0] = $scope.equipo[equipoEx].atr1;
                    caracteristicas[equipos.length - 1][1] = $scope.equipo[equipoEx].atr2;
                    caracteristicas[equipos.length - 1][2] = $scope.equipo[equipoEx].atr3;
                    caracteristicas[equipos.length - 1][3] = $scope.equipo[equipoEx].atr4;
                    caracteristicas[equipos.length - 1][4] = $scope.equipo[equipoEx].atr5;
                    caracteristicas[equipos.length - 1][5] = $scope.equipo[equipoEx].atr6;
                    caracteristicas[equipos.length - 1][6] = $scope.equipo[equipoEx].atr7;
                    caracteristicas[equipos.length - 1][7] = $scope.equipo[equipoEx].atr8;
                    caracteristicas[equipos.length - 1][8] = $scope.equipo[equipoEx].atr9;
                    caracteristicas[equipos.length - 1][9] = $scope.equipo[equipoEx].atr10;
                    caracteristicas[equipos.length - 1][10] = $scope.equipo[equipoEx].atr11;
                    caracteristicas[equipos.length - 1][11] = $scope.equipo[equipoEx].atr12;
                    caracteristicas[equipos.length - 1][12] = $scope.equipo[equipoEx].atr13;
                    caracteristicas[equipos.length - 1][13] = $scope.equipo[equipoEx].atr14;
                    caracteristicas[equipos.length - 1][14] = $scope.equipo[equipoEx].atr15;
                    caracteristicas[equipos.length - 1][15] = $scope.equipo[equipoEx].atr16;
                    valoresServiciosComplementos[equipos.length - 1][0] = $scope.equipo[equipoEx].valoresservicio1;
                    valoresServiciosComplementos[equipos.length - 1][1] = $scope.equipo[equipoEx].valoresservicio2;
                    valoresServiciosComplementos[equipos.length - 1][2] = $scope.equipo[equipoEx].valoresservicio3;
                    valoresServiciosComplementos[equipos.length - 1][3] = $scope.equipo[equipoEx].valoresservicio4;
                    valoresServiciosComplementos[equipos.length - 1][4] = $scope.equipo[equipoEx].valoresservicio5;
                    valoresServiciosComplementos[equipos.length - 1][5] = $scope.equipo[equipoEx].valoresservicio6;
                    valoresServiciosComplementos[equipos.length - 1][6] = $scope.equipo[equipoEx].valoresservicio7;
                    valoresServiciosComplementos[equipos.length - 1][7] = $scope.equipo[equipoEx].valoresservicio8;
                    valoresServiciosComplementos[equipos.length - 1][8] = $scope.equipo[equipoEx].valoresservicio9;
                    valoresServiciosComplementos[equipos.length - 1][9] = $scope.equipo[equipoEx].valoresservicio10;
                    valoresServiciosComplementos[equipos.length - 1][10] = $scope.equipo[equipoEx].valoresservicio11;
                    valoresServiciosComplementos[equipos.length - 1][11] = $scope.equipo[equipoEx].valoresservicio12;
                    valoresServiciosComplementos[equipos.length - 1][12] = $scope.equipo[equipoEx].valoresservicio13;
                    valoresServiciosComplementos[equipos.length - 1][13] = $scope.equipo[equipoEx].valoresservicio14;
                    valoresServiciosComplementos[equipos.length - 1][14] = $scope.equipo[equipoEx].valoresservicio15;
                    valoresServiciosComplementos[equipos.length - 1][15] = $scope.equipo[equipoEx].valoresservicio16;
                    valoresServiciosComplementos[equipos.length - 1][16] = $scope.equipo[equipoEx].valoresservicio17;
                    valoresServiciosComplementos[equipos.length - 1][17] = $scope.equipo[equipoEx].valoresservicio18;
                    valoresServiciosComplementos[equipos.length - 1][18] = $scope.equipo[equipoEx].valoresservicio19;
                    valoresServiciosComplementos[equipos.length - 1][19] = $scope.equipo[equipoEx].valoresservicio20;
                    valoresServiciosComplementos[equipos.length - 1][20] = $scope.equipo[equipoEx].valoresservicio21;
                    valoresServiciosComplementos[equipos.length - 1][21] = $scope.equipo[equipoEx].valoresservicio22;
                    valoresServiciosComplementos[equipos.length - 1][22] = $scope.equipo[equipoEx].valoresservicio23;
                    valoresServiciosComplementos[equipos.length - 1][23] = $scope.equipo[equipoEx].valoresservicio24;
                    valoresServiciosComplementos[equipos.length - 1][24] = $scope.equipo[equipoEx].valoresservicio25;
                    valoresServiciosComplementos[equipos.length - 1][25] = $scope.equipo[equipoEx].valoresservicio26;
                    valoresServiciosComplementos[equipos.length - 1][26] = $scope.equipo[equipoEx].valoresservicio27;
                    valoresServiciosComplementos[equipos.length - 1][27] = $scope.equipo[equipoEx].valoresservicio28;
                    valoresServiciosComplementos[equipos.length - 1][28] = $scope.equipo[equipoEx].valoresservicio29;
                    valoresServiciosComplementos[equipos.length - 1][29] = $scope.equipo[equipoEx].valoresservicio30;
                    valoresServiciosComplementos[equipos.length - 1][30] = $scope.equipo[equipoEx].valoresservicio31;
                    valoresServiciosComplementos[equipos.length - 1][31] = $scope.equipo[equipoEx].valoresservicio32;
                    valoresServiciosComplementos[equipos.length - 1][32] = $scope.equipo[equipoEx].valoresservicio33;
                    valoresServiciosComplementos[equipos.length - 1][33] = $scope.equipo[equipoEx].valoresservicio34;
                    valoresServiciosComplementos[equipos.length - 1][34] = $scope.equipo[equipoEx].valoresservicio35;
                    valoresServiciosComplementos[equipos.length - 1][35] = $scope.equipo[equipoEx].valoresservicio36;
                    valoresServiciosComplementos[equipos.length - 1][36] = $scope.equipo[equipoEx].valoresservicio37;
                    valoresServiciosComplementos[equipos.length - 1][37] = $scope.equipo[equipoEx].valoresservicio38;
                    valoresServiciosComplementos[equipos.length - 1][38] = $scope.equipo[equipoEx].valoresservicio39;
                    valoresServiciosComplementos[equipos.length - 1][39] = $scope.equipo[equipoEx].valoresservicio40;
                    valoresServiciosComplementos[equipos.length - 1][40] = $scope.equipo[equipoEx].valoresservicio41;
                    valoresServiciosComplementos[equipos.length - 1][41] = $scope.equipo[equipoEx].valoresservicio42;
                    valoresServiciosComplementos[equipos.length - 1][42] = $scope.equipo[equipoEx].valoresservicio43;
                    valoresServiciosComplementos[equipos.length - 1][43] = $scope.equipo[equipoEx].valoresservicio44;
                    valoresServiciosComplementos[equipos.length - 1][44] = $scope.equipo[equipoEx].valoresservicio45;
                    valoresServiciosComplementos[equipos.length - 1][45] = $scope.equipo[equipoEx].valoresservicio46;
                    valoresServiciosComplementos[equipos.length - 1][46] = $scope.equipo[equipoEx].valoresservicio47;
                    valoresServiciosComplementos[equipos.length - 1][47] = $scope.equipo[equipoEx].valoresservicio48;
                    valoresServiciosComplementos[equipos.length - 1][48] = $scope.equipo[equipoEx].valoresservicio49;
                    valoresServiciosComplementos[equipos.length - 1][49] = $scope.equipo[equipoEx].valoresservicio50;
                    valoresServiciosComplementos[equipos.length - 1][50] = $scope.equipo[equipoEx].valoresservicio51;
                    valoresServiciosComplementos[equipos.length - 1][51] = $scope.equipo[equipoEx].valoresservicio52;
                    valoresServiciosComplementos[equipos.length - 1][52] = $scope.equipo[equipoEx].valoresservicio53;
                    valoresServiciosComplementos[equipos.length - 1][53] = $scope.equipo[equipoEx].valoresservicio54;
                    valoresServiciosComplementos[equipos.length - 1][54] = $scope.equipo[equipoEx].valoresservicio55;
                    valoresServiciosComplementos[equipos.length - 1][55] = $scope.equipo[equipoEx].valoresservicio56;
                    valoresServiciosComplementos[equipos.length - 1][56] = $scope.equipo[equipoEx].valoresservicio57;
                    valoresServiciosComplementos[equipos.length - 1][57] = $scope.equipo[equipoEx].valoresservicio58;
                    valoresServiciosComplementos[equipos.length - 1][58] = $scope.equipo[equipoEx].valoresservicio59;
                    valoresServiciosComplementos[equipos.length - 1][59] = $scope.equipo[equipoEx].valoresservicio60;
                    valoresServiciosComplementos[equipos.length - 1][60] = $scope.equipo[equipoEx].valoresservicio61;
                    valoresServiciosComplementos[equipos.length - 1][61] = $scope.equipo[equipoEx].valoresservicio62;
                    valoresServiciosComplementos[equipos.length - 1][62] = $scope.equipo[equipoEx].valoresservicio63;
                    valoresServiciosComplementos[equipos.length - 1][63] = $scope.equipo[equipoEx].valoresservicio64;
                    valoresServiciosComplementos[equipos.length - 1][64] = $scope.equipo[equipoEx].valoresservicio65;
                    valoresServiciosComplementos[equipos.length - 1][65] = $scope.equipo[equipoEx].valoresservicio66;
                    valoresServiciosComplementos[equipos.length - 1][66] = $scope.equipo[equipoEx].valoresservicio67;
                    valoresServiciosComplementos[equipos.length - 1][67] = $scope.equipo[equipoEx].valoresservicio68;
                    valoresServiciosComplementos[equipos.length - 1][68] = $scope.equipo[equipoEx].valoresservicio69;
                    valoresServiciosComplementos[equipos.length - 1][69] = $scope.equipo[equipoEx].valoresservicio70;
                    valoresServiciosComplementos[equipos.length - 1][70] = $scope.equipo[equipoEx].valoresservicio71;
                    valoresServiciosComplementos[equipos.length - 1][71] = $scope.equipo[equipoEx].valoresservicio72;
                    valoresServiciosComplementos[equipos.length - 1][72] = $scope.equipo[equipoEx].valoresservicio73;
                    valoresServiciosComplementos[equipos.length - 1][73] = $scope.equipo[equipoEx].valoresservicio74;
                    valoresServiciosComplementos[equipos.length - 1][74] = $scope.equipo[equipoEx].valoresservicio75;
                }
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado
                
                cont++;
                dibujarBuses(0, busCA, 0, colectorA, equipos.length);
            }
            //Si tiene ambos
            if (busAE > 0 &amp;&amp; busGE > 0 &amp;&amp; tempI == false) {
                //Si el contador de servicios es 0
                //Almacenamos el número de la línea y flecha
                numFlechasInversa.push(cont);
                numFlechas.push(cont);
                if (busGE != busAE) {
                    numFlechas.push(cont + "A");
                    numFlechasInversa.push(cont + "A");
                    numLineasInversa.push(cont);
                }
                numLineas.push(cont);
                var colectorG = "";
                var colectorA = "";
                var colector = "";
                var numBusGE = 0;
                var numBusAE = 0;
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                //Hace falta añadir el tipo de servicio
                if (tipoServ == "4") {
                    add += "&lt;td class='servicios'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasEx(4,2," + busGE + "," + busAE + "," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                } else {
                    add += "&lt;td class='servicios'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicas(1,2," + busGE + "," + busAE + "," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                }
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                var busCG = 0;
                var busCA = 0;
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (parseInt(colectores[x][1]) == busGE &amp;&amp; x &lt; numColector) {
                        numBusGE++;
                    }
                    if (parseInt(colectores[x][1]) == busAE &amp;&amp; x &lt; numColector) {
                        numBusAE++;
                    }
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC || busAE == busC) {
                        if (busGE == busC) {
                            colectorG = colectores[x][1];
                            if (colectorG == "11") {
                                colectorG = "3";
                            }
                            if (colectorG == "14") {
                                colectorG = "4";
                            }
                            if (colectorG == "15") {
                                colectorG = "6";
                            }
                            busCG = busC;
                        }
                        if (busAE == busC) {
                            colectorA = colectores[x][1];
                            if (colectorA == "11") {
                                colectorA = "3";
                            }
                            if (colectorA == "14") {
                                colectorA = "4";
                            }
                            if (colectorA == "15") {
                                colectorA = "6";
                            }
                            busCA = busC;
                        }

                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "' style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "' >&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "e' style='width:13.375px;'>&lt;/td>\n";
                    }
                }
                
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;

                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 = "&lt;tr id='trSerEspacio" + cont + "'>\n";
                add2 += "&lt;td class='servicios' style='height:15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='height:15px'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC || busAE == busC) {
                        if (busGE == busC) {
                            colectorG = colectores[x][1];
                            if (colectorG == "11") {
                                colectorG = "3";
                            }
                            if (colectorG == "14") {
                                colectorG = "4";
                            }
                            if (colectorG == "15") {
                                colectorG = "6";
                            }
                            busCG = busC;
                        }
                        if (busAE == busC) {
                            colectorA = colectores[x][1];
                            if (colectorA == "11") {
                                colectorA = "3";
                            }
                            if (colectorA == "14") {
                                colectorA = "4";
                            }
                            if (colectorA == "15") {
                                colectorA = "6";
                            }
                            busCA = busC;
                        }

                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s'style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s' style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "se' style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                //Ponemos a true el radio del bus correspondiente
                lineasCreadas[busCA - 1] = true;
                lineasCreadas[busCG - 1] = true;

                //sacamos los valores para calcular la posición de la flecha y la línea alimenta
                alturaSer = document.getElementsByClassName("servicios")[document.getElementsByClassName("servicios").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCG + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea alimenta
                leftLineas = long + distancia - 2;
                widthLineas = izq - (leftB + long) + 5;
                topLineas = topB + (alt / 2) + 70;
                leftFlecha = long + distancia - 10;
                topFlecha = topB + (alt / 2) + 57;
                var linea = "&lt;section class='connectingLines" + colectorG + "' id='lineaSer" + cont + "' style='left:" + leftLineas + "px; top:" + topLineas + "px; width:" + widthLineas + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //creamos la flecha alimenta
                var flecha = "&lt;img class='flecha" + colectorG + "' src='flecha" + colectorG + ".png'   id='flechaSer" + cont + "'style='left:" + (leftLineas + widthLineas - 30) + "px; top:" + topFlecha + "px;'>";
                var flecha2 = "&lt;img class='flecha" + colectorG + "' src='flechaInversa" + colectorG + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 10) + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que esté definido
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        if (tipoServ == "4") {
                            document.getElementById(cont).style.border = "thick solid red";
                            equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Existente", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        } else {
                            document.getElementById(cont).style.border = "thick solid green";
                            equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Nuevo", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        }
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Existente", "no", tipoServ, tipoEquipo, 0, 0, numEquipos];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        if (tipoServ == "4") {
                            document.getElementById(cont).style.border = "solid 1px black";
                            equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Existente", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        } else {
                            document.getElementById(cont).style.border = "solid 1px black";
                            equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Nuevo", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                            equipos.push(equipo);
                        }
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Existente", "si", tipoServ, tipoEquipo, 0, 0, numEquipos];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //Si está definido cargamos los valores en características
                if (definido == "si") {
                    equipos[equipos.length - 1][8] = $scope.equipo[equipoEx].idcontador;
                    equipos[equipos.length - 1][9] = $scope.equipo[equipoEx].nombreequipo;
                    caracteristicas[equipos.length - 1][0] = $scope.equipo[equipoEx].atr1;
                    caracteristicas[equipos.length - 1][1] = $scope.equipo[equipoEx].atr2;
                    caracteristicas[equipos.length - 1][2] = $scope.equipo[equipoEx].atr3;
                    caracteristicas[equipos.length - 1][3] = $scope.equipo[equipoEx].atr4;
                    caracteristicas[equipos.length - 1][4] = $scope.equipo[equipoEx].atr5;
                    caracteristicas[equipos.length - 1][5] = $scope.equipo[equipoEx].atr6;
                    caracteristicas[equipos.length - 1][6] = $scope.equipo[equipoEx].atr7;
                    caracteristicas[equipos.length - 1][7] = $scope.equipo[equipoEx].atr8;
                    caracteristicas[equipos.length - 1][8] = $scope.equipo[equipoEx].atr9;
                    caracteristicas[equipos.length - 1][9] = $scope.equipo[equipoEx].atr10;
                    caracteristicas[equipos.length - 1][10] = $scope.equipo[equipoEx].atr11;
                    caracteristicas[equipos.length - 1][11] = $scope.equipo[equipoEx].atr12;
                    caracteristicas[equipos.length - 1][12] = $scope.equipo[equipoEx].atr13;
                    caracteristicas[equipos.length - 1][13] = $scope.equipo[equipoEx].atr14;
                    caracteristicas[equipos.length - 1][14] = $scope.equipo[equipoEx].atr15;
                    caracteristicas[equipos.length - 1][15] = $scope.equipo[equipoEx].atr16;
                    valoresServiciosComplementos[equipos.length - 1][0] = $scope.equipo[equipoEx].valoresservicio1;
                    valoresServiciosComplementos[equipos.length - 1][1] = $scope.equipo[equipoEx].valoresservicio2;
                    valoresServiciosComplementos[equipos.length - 1][2] = $scope.equipo[equipoEx].valoresservicio3;
                    valoresServiciosComplementos[equipos.length - 1][3] = $scope.equipo[equipoEx].valoresservicio4;
                    valoresServiciosComplementos[equipos.length - 1][4] = $scope.equipo[equipoEx].valoresservicio5;
                    valoresServiciosComplementos[equipos.length - 1][5] = $scope.equipo[equipoEx].valoresservicio6;
                    valoresServiciosComplementos[equipos.length - 1][6] = $scope.equipo[equipoEx].valoresservicio7;
                    valoresServiciosComplementos[equipos.length - 1][7] = $scope.equipo[equipoEx].valoresservicio8;
                    valoresServiciosComplementos[equipos.length - 1][8] = $scope.equipo[equipoEx].valoresservicio9;
                    valoresServiciosComplementos[equipos.length - 1][9] = $scope.equipo[equipoEx].valoresservicio10;
                    valoresServiciosComplementos[equipos.length - 1][10] = $scope.equipo[equipoEx].valoresservicio11;
                    valoresServiciosComplementos[equipos.length - 1][11] = $scope.equipo[equipoEx].valoresservicio12;
                    valoresServiciosComplementos[equipos.length - 1][12] = $scope.equipo[equipoEx].valoresservicio13;
                    valoresServiciosComplementos[equipos.length - 1][13] = $scope.equipo[equipoEx].valoresservicio14;
                    valoresServiciosComplementos[equipos.length - 1][14] = $scope.equipo[equipoEx].valoresservicio15;
                    valoresServiciosComplementos[equipos.length - 1][15] = $scope.equipo[equipoEx].valoresservicio16;
                    valoresServiciosComplementos[equipos.length - 1][16] = $scope.equipo[equipoEx].valoresservicio17;
                    valoresServiciosComplementos[equipos.length - 1][17] = $scope.equipo[equipoEx].valoresservicio18;
                    valoresServiciosComplementos[equipos.length - 1][18] = $scope.equipo[equipoEx].valoresservicio19;
                    valoresServiciosComplementos[equipos.length - 1][19] = $scope.equipo[equipoEx].valoresservicio20;
                    valoresServiciosComplementos[equipos.length - 1][20] = $scope.equipo[equipoEx].valoresservicio21;
                    valoresServiciosComplementos[equipos.length - 1][21] = $scope.equipo[equipoEx].valoresservicio22;
                    valoresServiciosComplementos[equipos.length - 1][22] = $scope.equipo[equipoEx].valoresservicio23;
                    valoresServiciosComplementos[equipos.length - 1][23] = $scope.equipo[equipoEx].valoresservicio24;
                    valoresServiciosComplementos[equipos.length - 1][24] = $scope.equipo[equipoEx].valoresservicio25;
                    valoresServiciosComplementos[equipos.length - 1][25] = $scope.equipo[equipoEx].valoresservicio26;
                    valoresServiciosComplementos[equipos.length - 1][26] = $scope.equipo[equipoEx].valoresservicio27;
                    valoresServiciosComplementos[equipos.length - 1][27] = $scope.equipo[equipoEx].valoresservicio28;
                    valoresServiciosComplementos[equipos.length - 1][28] = $scope.equipo[equipoEx].valoresservicio29;
                    valoresServiciosComplementos[equipos.length - 1][29] = $scope.equipo[equipoEx].valoresservicio30;
                    valoresServiciosComplementos[equipos.length - 1][30] = $scope.equipo[equipoEx].valoresservicio31;
                    valoresServiciosComplementos[equipos.length - 1][31] = $scope.equipo[equipoEx].valoresservicio32;
                    valoresServiciosComplementos[equipos.length - 1][32] = $scope.equipo[equipoEx].valoresservicio33;
                    valoresServiciosComplementos[equipos.length - 1][33] = $scope.equipo[equipoEx].valoresservicio34;
                    valoresServiciosComplementos[equipos.length - 1][34] = $scope.equipo[equipoEx].valoresservicio35;
                    valoresServiciosComplementos[equipos.length - 1][35] = $scope.equipo[equipoEx].valoresservicio36;
                    valoresServiciosComplementos[equipos.length - 1][36] = $scope.equipo[equipoEx].valoresservicio37;
                    valoresServiciosComplementos[equipos.length - 1][37] = $scope.equipo[equipoEx].valoresservicio38;
                    valoresServiciosComplementos[equipos.length - 1][38] = $scope.equipo[equipoEx].valoresservicio39;
                    valoresServiciosComplementos[equipos.length - 1][39] = $scope.equipo[equipoEx].valoresservicio40;
                    valoresServiciosComplementos[equipos.length - 1][40] = $scope.equipo[equipoEx].valoresservicio41;
                    valoresServiciosComplementos[equipos.length - 1][41] = $scope.equipo[equipoEx].valoresservicio42;
                    valoresServiciosComplementos[equipos.length - 1][42] = $scope.equipo[equipoEx].valoresservicio43;
                    valoresServiciosComplementos[equipos.length - 1][43] = $scope.equipo[equipoEx].valoresservicio44;
                    valoresServiciosComplementos[equipos.length - 1][44] = $scope.equipo[equipoEx].valoresservicio45;
                    valoresServiciosComplementos[equipos.length - 1][45] = $scope.equipo[equipoEx].valoresservicio46;
                    valoresServiciosComplementos[equipos.length - 1][46] = $scope.equipo[equipoEx].valoresservicio47;
                    valoresServiciosComplementos[equipos.length - 1][47] = $scope.equipo[equipoEx].valoresservicio48;
                    valoresServiciosComplementos[equipos.length - 1][48] = $scope.equipo[equipoEx].valoresservicio49;
                    valoresServiciosComplementos[equipos.length - 1][49] = $scope.equipo[equipoEx].valoresservicio50;
                    valoresServiciosComplementos[equipos.length - 1][50] = $scope.equipo[equipoEx].valoresservicio51;
                    valoresServiciosComplementos[equipos.length - 1][51] = $scope.equipo[equipoEx].valoresservicio52;
                    valoresServiciosComplementos[equipos.length - 1][52] = $scope.equipo[equipoEx].valoresservicio53;
                    valoresServiciosComplementos[equipos.length - 1][53] = $scope.equipo[equipoEx].valoresservicio54;
                    valoresServiciosComplementos[equipos.length - 1][54] = $scope.equipo[equipoEx].valoresservicio55;
                    valoresServiciosComplementos[equipos.length - 1][55] = $scope.equipo[equipoEx].valoresservicio56;
                    valoresServiciosComplementos[equipos.length - 1][56] = $scope.equipo[equipoEx].valoresservicio57;
                    valoresServiciosComplementos[equipos.length - 1][57] = $scope.equipo[equipoEx].valoresservicio58;
                    valoresServiciosComplementos[equipos.length - 1][58] = $scope.equipo[equipoEx].valoresservicio59;
                    valoresServiciosComplementos[equipos.length - 1][59] = $scope.equipo[equipoEx].valoresservicio60;
                    valoresServiciosComplementos[equipos.length - 1][60] = $scope.equipo[equipoEx].valoresservicio61;
                    valoresServiciosComplementos[equipos.length - 1][61] = $scope.equipo[equipoEx].valoresservicio62;
                    valoresServiciosComplementos[equipos.length - 1][62] = $scope.equipo[equipoEx].valoresservicio63;
                    valoresServiciosComplementos[equipos.length - 1][63] = $scope.equipo[equipoEx].valoresservicio64;
                    valoresServiciosComplementos[equipos.length - 1][64] = $scope.equipo[equipoEx].valoresservicio65;
                    valoresServiciosComplementos[equipos.length - 1][65] = $scope.equipo[equipoEx].valoresservicio66;
                    valoresServiciosComplementos[equipos.length - 1][66] = $scope.equipo[equipoEx].valoresservicio67;
                    valoresServiciosComplementos[equipos.length - 1][67] = $scope.equipo[equipoEx].valoresservicio68;
                    valoresServiciosComplementos[equipos.length - 1][68] = $scope.equipo[equipoEx].valoresservicio69;
                    valoresServiciosComplementos[equipos.length - 1][69] = $scope.equipo[equipoEx].valoresservicio70;
                    valoresServiciosComplementos[equipos.length - 1][70] = $scope.equipo[equipoEx].valoresservicio71;
                    valoresServiciosComplementos[equipos.length - 1][71] = $scope.equipo[equipoEx].valoresservicio72;
                    valoresServiciosComplementos[equipos.length - 1][72] = $scope.equipo[equipoEx].valoresservicio73;
                    valoresServiciosComplementos[equipos.length - 1][73] = $scope.equipo[equipoEx].valoresservicio74;
                    valoresServiciosComplementos[equipos.length - 1][74] = $scope.equipo[equipoEx].valoresservicio75;
                }
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //sacamos los valores para calcular la posición de la flecha y la línea genera
                alturaSer = document.getElementsByClassName("servicios")[document.getElementsByClassName("servicios").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCA + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea genera
                leftLineasInversa = long + distancia - 2;
                widthLineasInversa = izq - (leftB + long);
                topLineasInversa = topB + (alt / 2) + 90;
                leftFlechaInversa = long + distancia - 10;
                topFlechaInversa = topB + (alt / 2) + 77;
                if (busGE != busAE) {
                    var linea = "&lt;section class='connectingLines" + colectorA + "' id='lineaSerInversa" + cont + "' style='left:" + leftLineasInversa + "px; top:" + topLineasInversa + "px; width:" + widthLineasInversa + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                    //creamos la flecha genera
                    var flecha = "&lt;img class='flecha" + colectorA + "' src='flecha" + colectorA + ".png'   id='flechaSer" + cont + "A'style='left:" + (leftLineasInversa + widthLineasInversa - 28) + "px; top:" + topFlechaInversa + "px;'>";
                    var flecha2 = "&lt;img class='flecha" + colectorA + "' src='flechaInversa" + colectorA + ".png'   id='flechaSerInversa" + cont + "A'style='left:" + (leftFlechaInversa) + "px; top:" + topFlechaInversa + "px;'>";
                    //Almacenamos en equipos el equipo creado y comprobamos que sea nuevo o existente
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                }

                cont++;
                dibujarBuses(busCG, busCA, colectorG, colectorA, equipos.length);


            }

        }
         /**

            *Creamos el botón complemento junto con su línea/s y flecha/s
            * @return  {void}

            */
        updateComplemento = function (comp, tipo, excep) {
            var tipoEquipo = "";
            var definido;
            var busGE;
            var busGT;
            var busAE;
            var busAT;
            var add;
            var add2;
            var nombre;
            var tipoServicio = "";
            var nombre2;
            var mismo = true;
            var colG = "";
            var colA = "";
            var equipo = new Array();
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                if ($scope.caso[x].nombre == nombreCaso) {
                    edificio = $scope.caso[x].idedificio;
                }
            }
            
            if (tipo == "1") {
                var solar = false;
                var acuSolar = false;
                for (var x = 0; x &lt; equipos.length; x++) {
                    if (equipos[x][1] == " mase planos" || equipos[x][1] == " Tubo de vacío" || equipos[x][1] == "Solar Térmica") {
                        solar = true;
                    }
                    if (equipos[x][1] == "Acumulación solar") {
                        acuSolar = true;
                    }
                }
                /*Sacamos el valor del bus/es seleccionado y el valor de nuevo/existente dependiendo del origen de la llamada a la función
                realizando los ajustes a los colectores y a los nombres de los equipos que fueran necesarios*/
                busGE = $('input[name="idBusGeneraC"]:checked').val();
                if (busGE == 10 || busGE == "10" || typeof (busGE) === "undefined") {
                    busGE = "-";
                } else {
                    busGE = busGE.substring(1, busGE.length);
                    busGE = parseInt(busGE);
                }
                if (comp == "16" || comp == "17" || comp == "18" || comp == "19") {
                    busAE = $('input[name="idBusAlimentaC"]:checked').val();
                } else {
                    busAE = "10"
                }
                if (busAE == 10 || busAE == "10" || typeof (busAE) === "undefined") {
                    busAE = "-";
                } else {
                    busAE = busAE.substring(1, busAE.length);
                    busAE = parseInt(busAE);
                }
                if (exismod == "0") {
                    busGT = "1";
                    busAT = "1";
                } else {
                    busGT = "0";
                    busAT = "0";
                }
                if (busGE == busAE) {
                    alert("ERROR: Los dos colectores deben ser diferentes");
                    return;
                }
                for (var x = 0; x &lt; equipos.length; x++) {
                    if (parseInt(equipos[x][0]) >= cont) {
                        cont = parseInt(equipos[x][0]) + 1;
                    }
                }
                nombre = $scope.complementos[comp - 1].nombre;
                tipoEquipo = $scope.complementos[comp - 1].nombretabladatos;
                tipoServicio = $scope.complementos[comp - 1].id;
                definido = "no";
                if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                    if (solar == true &amp;&amp; acuSolar == false) {
                        nombre2 = "Acumulación solar";
                    } else if (solar == true &amp;&amp; acuSolar == true) {
                        nombre2 = "Acumulación ACS";
                    } else if (solar == false &amp;&amp; acuSolar == false) {
                        nombre2 = "Almacenamiento sensible";
                    }
                } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                    nombre2 = "Intercambiador de calor";
                } else {
                    nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                }
                $('#myModalComplemento2').modal('hide');
                $('#myModalComplemento').modal('hide');

            }
            else if (tipo == "2") {
                busGE = $scope.equipo[comp].busg;
                for (var x = 0; x &lt; $scope.bus.length; x++) {
                    if ($scope.bus[x].nombre == busGE) {
                        busGE = $scope.bus[x].id;
                    }
                }
                busGT = $scope.equipo[comp].nuex;
                if (busGT == "Nuevo") {
                    busGT = "0";
                } else {
                    busGT = "1";
                }
                if (busGE != "-") {
                    busGE = busGE.substring(1, busGE.length);
                    busGE = parseInt(busGE);
                }
                busAE = $scope.equipo[comp].busa;
                for (var x = 0; x &lt; $scope.bus.length; x++) {
                    if ($scope.bus[x].nombre == busAE) {
                        busAE = $scope.bus[x].id;
                    }
                }
                busAT = $scope.equipo[comp].nuex;
                if (busAT == "Nuevo") {
                    busAT = "0";
                } else {
                    busAT = "1";
                }
                if (busAE != "-") {
                    busAE = busAE.substring(1, busAE.length);
                    busAE = parseInt(busAE);
                }
                equipoEx = comp;
                definido = $scope.equipo[comp].definido;
                nombre2 = $scope.equipo[comp].nombre;
                cont = $scope.equipo[comp].id;
                cont = cont - 1;
                for (var x = 0; x &lt; $scope.complementos.length; x++) {
                    nombre = $scope.complementos[x].nombre;
                    if ($scope.complementos[x].id == "8" || $scope.complementos[x].id == "9" || $scope.complementos[x].id == "10" || $scope.complementos[x].id == "11" || $scope.complementos[x].id == "12") {
                        if (nombre2 == "Acumulación ACS" || nombre2 == "Acumulación solar") {
                            nombre3 = nombre2;
                        } else {
                            nombre3 = "Almacenamiento sensible";
                        }
                    } else if ($scope.complementos[x].id == "16" || $scope.complementos[x].id == "17" || $scope.complementos[x].id == "18" || $scope.complementos[x].id == "19") {
                        if (sistema == 0 &amp;&amp; nombre2 == "Intercambiador") {
                            nombre3 = "Intercambiador";
                        } else {
                            nombre3 = "Intercambiador de calor";
                        }
                    } else {
                        nombre3 = nombre.substring(nombre.indexOf(":") + 1);
                    }
                    if (nombre3 == nombre2) {
                        tipoServicio = $scope.complementos[x].id;
                        tipoEquipo = $scope.complementos[tipoServicio - 1].nombretabladatos;
                    }
                }
                if (nombre2 == "Acumulación ACS" || nombre2 == "Acumulación solar") {
                    tipoServicio = $scope.complementos[8].id;
                    tipoEquipo = $scope.complementos[tipoServicio - 1].nombretabladatos;
                }
            }
            else if (tipo == "3") {
                var guardado = false;
                nombre2 = Number($scope.complementos[comp - 1].id);
                tipoServicio = nombre2;



                tipoServicio = comp;
                tipoEquipo = $scope.complementos[tipoServicio - 1].nombretabladatos;
                switch (sistema) {
                    case 0:
                        busGT = "1";
                        busAT = "1";
                        for (var x = 0; x &lt; $scope.edificioComplementoBusEx.length; x++) {
                            if ($scope.edificioComplementoBusEx[x].idcomplemento == comp &amp;&amp; edificio == $scope.edificioComplementoBusEx[x].idedificio) {
                                nombre2 = $scope.edificioComplementoBusEx[x].nombre;
                                if ($scope.edificioComplementoBusEx[x].idcomplemento == "9") {

                                    for (var y = 0; y &lt; equipos.length; y++) {
                                        if (nombre2 == equipos[y][1]) {
                                            nombre2 = "Acumulación ACS";
                                        }
                                    }
                                }
                                busGE = $scope.edificioComplementoBusEx[x].idbusgenera;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                }
                                busAE = $scope.edificioComplementoBusEx[x].idbusalimenta;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                }
                            }
                        }
                        definido = "no";
                        break;
                    case 1:
                        busGT = "1";
                        busAT = "1";
                        if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                            if (excep == "1") {
                                nombre2 = "Acumulación ACS";
                            } else if (excep == "2") {
                                nombre2 = "Acumulación solar";
                            } else {
                                nombre2 = "Almacenamiento sensible";
                            }
                        } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                            nombre2 = "Intercambiador";
                        } else {
                            nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                        }
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; $scope.equipo[x].idcaso == idCaso) {

                                for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                    if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colG = $scope.equipo[y].nombre;
                                    }
                                    if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                        colA = $scope.equipo[y].nombre;
                                    }
                                }
                                busGE = $scope.equipo[x].busg;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busGE) {
                                            busGE = (y + 1);
                                        }
                                    }
                                }
                                equipoEx = x;
                                definido = $scope.equipo[x].definido;
                                busAE = $scope.equipo[x].busa;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                } else {
                                    for (var y = 0; y &lt; colectores.length; y++) {
                                        if (colectores[y][0] == busAE) {
                                            busAE = (y + 1);
                                        }
                                    }
                                }
                                if (colG != colA &amp;&amp; colG != "" &amp;&amp; colA != "" &amp;&amp; busAE == busGE &amp;&amp; busAE != "-" &amp;&amp; busGE != "-") {
                                    mismo = false;
                                }
                            }
                        }
                        if (nombre2 == "Intercambiador") {
                            nombre2 = "Intercambiador de calor";
                        }
                        break;
                    case 2:
                        if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                            if (excep == "1") {
                                nombre2 = "Acumulación ACS";
                            } else if (excep == "2") {
                                nombre2 = "Acumulación solar";
                            } else {
                                nombre2 = "Almacenamiento sensible";
                            }
                        } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                            nombre2 = "Intercambiador";
                        } else {
                            nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                        }
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; $scope.equipo[x].idcaso == idCaso) {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            } else if ($scope.equipo[x].nombre == "Intercambiador de calor" &amp;&amp; nombre2 =="Intercambiador" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            }
                        }

                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }

                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busg;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busGE) {
                                        busGE = (y + 1);
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;
                            definido = $scope.equipo[x].definido;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busAE) {
                                        busAE = (y + 1);
                                    }
                                }
                            }
                            if (busAE != busGE &amp;&amp; busAE != "-" &amp;&amp; busGE != "-") {
                                mismo = false;
                                }
                        }
                        else {
                            definido = "no";
                            busGT = "0";
                            busAT = "0";
                            for (var x = 0; x &lt; $scope.edificioComplementoBusip1.length; x++) {
                                if ($scope.edificioComplementoBusip1[x].idcomplemento == comp &amp;&amp; edificio == $scope.edificioComplementoBusip1[x].idedificio) {
                                    if ($scope.edificioComplementoBusip1[x].idcomplemento == "9") {
                                        nombre2 = $scope.edificioComplementoBusip1[x].nombre;
                                        for (var y = 0; y &lt; equipos.length; y++) {
                                            if (nombre2 == equipos[y][1] || nombre2 == "Acumulación ACS") {
                                                nombre2 = "Acumulación ACS";
                                            }
                                        }
                                    }
                                    busGE = $scope.edificioComplementoBusip1[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioComplementoBusip1[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                        }
                        if (nombre2 == "Intercambiador") {
                            nombre2 = "Intercambiador de calor";
                        }
                        break;

                    case 3:
                        if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                            if (excep == "1") {
                                nombre2 = "Acumulación ACS";
                            } else if (excep == "2") {
                                nombre2 = "Acumulación solar";
                            } else {
                                nombre2 = "Almacenamiento sensible";
                            }
                        } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                            nombre2 = "Intercambiador";
                        } else {
                            nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                        }
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; $scope.equipo[x].idcaso == idCaso) {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            } else if ($scope.equipo[x].nombre == "Intercambiador de calor" &amp;&amp; nombre2 == "Intercambiador" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            }
                        }

                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }

                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busg;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busGE) {
                                        busGE = (y + 1);
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;
                            definido = $scope.equipo[x].definido;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busAE) {
                                        busAE = (y + 1);
                                    }
                                }
                            } 
                            if (busAE != busGE &amp;&amp; busAE != "-" &amp;&amp; busGE != "-") {
                                mismo = false;
                            }
                        }
                        else {
                            definido = "no";
                            busGT = "0";
                            busAT = "0";
                            for (var x = 0; x &lt; $scope.edificioComplementoBusip1.length; x++) {
                                if ($scope.edificioComplementoBusip1[x].idcomplemento == comp &amp;&amp; edificio == $scope.edificioComplementoBusip1[x].idedificio) {
                                    if ($scope.edificioComplementoBusip1[x].idcomplemento == "9") {
                                        nombre2 = $scope.edificioComplementoBusip1[x].nombre;
                                        for (var y = 0; y &lt; equipos.length; y++) {
                                            if (nombre2 == equipos[y][1] || nombre2 == "Acumulación ACS") {
                                                nombre2 = "Acumulación ACS";
                                            }
                                        }
                                    }
                                    busGE = $scope.edificioComplementoBusip1[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioComplementoBusip1[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                        }
                        if (nombre2 == "Intercambiador") {
                            nombre2 = "Intercambiador de calor";
                        }
                        break;
                    case 4:
                        if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                            if (excep == "1") {
                                nombre2 = "Acumulación ACS";
                            } else if (excep == "2") {
                                nombre2 = "Acumulación solar";
                            } else {
                                nombre2 = "Almacenamiento sensible";
                            }
                        } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                            nombre2 = "Intercambiador";
                        } else {
                            nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                        }
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; $scope.equipo[x].idcaso == idCaso) {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            } else if ($scope.equipo[x].nombre == "Intercambiador de calor" &amp;&amp; nombre2 == "Intercambiador" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            }
                        }
                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }

                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busg;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busGE) {
                                        busGE = (y + 1);
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;
                            definido = $scope.equipo[x].definido;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busAE) {
                                        busAE = (y + 1);
                                    }
                                }
                            }
                            if (busAE != busGE &amp;&amp; busAE != "-" &amp;&amp; busGE != "-") {
                                mismo = false;
                            }
                        }
                        else {
                            definido = "no";
                            busGT = "0";
                            busAT = "0";
                            for (var x = 0; x &lt; $scope.edificioComplementoBusip3a.length; x++) {
                                if ($scope.edificioComplementoBusip3a[x].idcomplemento == comp &amp;&amp; edificio == $scope.edificioComplementoBusip3a[x].idedificio) {
                                    if ($scope.edificioComplementoBusip3a[x].idcomplemento == "9") {
                                        nombre2 = $scope.edificioComplementoBusip3a[x].nombre;
                                        for (var y = 0; y &lt; equipos.length; y++) {
                                            if (nombre2 == equipos[y][1] || nombre2 == "Acumulación ACS") {
                                                nombre2 = "Acumulación ACS";
                                            }
                                        }
                                    }
                                    busGE = $scope.edificioComplementoBusip3a[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioComplementoBusip3a[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                        }
                        if (nombre2 == "Intercambiador") {
                            nombre2 = "Intercambiador de calor";
                        }
                        break;
                    case 5:
                        if ($scope.complementos[comp - 1].id == "8" || $scope.complementos[comp - 1].id == "9" || $scope.complementos[comp - 1].id == "10" || $scope.complementos[comp - 1].id == "11" || $scope.complementos[comp - 1].id == "12") {
                            if (excep == "1") {
                                nombre2 = "Acumulación ACS";
                            } else if (excep == "2") {
                                nombre2 = "Acumulación solar";
                            } else {
                                nombre2 = "Almacenamiento sensible";
                            }
                        } else if ($scope.complementos[comp - 1].id == "16" || $scope.complementos[comp - 1].id == "17" || $scope.complementos[comp - 1].id == "18" || $scope.complementos[comp - 1].id == "19") {
                            nombre2 = "Intercambiador";
                        } else {
                            nombre2 = nombre.substring(nombre.indexOf(":") + 1);
                        }
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente" &amp;&amp; $scope.equipo[x].idcaso == idCaso) {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            } else if ($scope.equipo[x].nombre == "Intercambiador de calor" &amp;&amp; nombre2 == "Intercambiador" &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                var cargado = false;

                                loop4:
                                for (var y = 0; y &lt; equipos.length; y++) {
                                    if (equipos[y][9] != 0 &amp;&amp; equipos[y][9] == $scope.equipo[x].nombreequipo &amp;&amp; equipos[y][1] == $scope.equipo[x].nombre) {
                                        cargado = true;
                                        break loop4;
                                    }
                                }
                                if (cargado == false) {
                                    break loop3;
                                } 
                            }
                        }
                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }

                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busg;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busGE) {
                                        busGE = (y + 1);
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;
                            definido = $scope.equipo[x].definido;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; colectores.length; y++) {
                                    if (colectores[y][0] == busAE) {
                                        busAE = (y + 1);
                                    }
                                }
                            }
                            if (busAE != busGE &amp;&amp; busAE != "-" &amp;&amp; busGE != "-") {
                                mismo = false;
                            }
                        }
                        else {
                            definido = "no";
                            busGT = "0";
                            busAT = "0";
                            for (var x = 0; x &lt; $scope.edificioComplementoBusip3b.length; x++) {
                                if ($scope.edificioComplementoBusip3b[x].idcomplemento == comp &amp;&amp; edificio == $scope.edificioComplementoBusip3b[x].idedificio) {
                                    if ($scope.edificioComplementoBusip3b[x].idcomplemento == "9") {
                                        nombre2 = $scope.edificioComplementoBusip3b[x].nombre;
                                        for (var y = 0; y &lt; equipos.length; y++) {
                                            if (nombre2 == equipos[y][1] || nombre2 == "Acumulación ACS") {
                                                nombre2 = "Acumulación ACS";
                                            }
                                        }
                                    }
                                    busGE = $scope.edificioComplementoBusip3b[x].idbusgenera;
                                    if (busGE == "10" || busGE == "6") {
                                        busGE = "-";
                                    }
                                    busAE = $scope.edificioComplementoBusip3b[x].idbusalimenta;
                                    if (busAE == "10" || busAE == "6") {
                                        busAE = "-";
                                    }
                                }
                            }
                        }
                        if (nombre2 == "Intercambiador") {
                            nombre2 = "Intercambiador de calor";
                        }
                        break;
                }

                if (mismo == true) {
                    for (var x = 0; x &lt; colectores.length; x++) {

                        if (busGE == colectores[x][1]) {
                            busGE = colectores[x][0];
                            busGE = busGE.substring(1, busGE.length);
                            busGE = parseInt(busGE);
                        }
                        if (busAE == colectores[x][1]) {
                            busAE = colectores[x][0];
                            busAE = busAE.substring(1, busAE.length);
                            busAE = parseInt(busAE);
                        }
                    }
                } else {
                    for (var x = 0; x &lt; equipos.length; x++) {
                        if (equipos[x][1] == colG) {
                            busGE = equipos[x][3];
                            busGE = busGE.substring(1, busGE.length);
                            busGE = parseInt(busGE);
                        }
                        if (equipos[x][1] == colA) {
                            busAE = equipos[x][3];
                            busAE = busAE.substring(1, busAE.length);
                            busAE = parseInt(busAE);
                        }
                    }
                }
                if (excep == "1") {
                    nombre2 = "Acumulación ACS";
                } else if (excep == "2") {
                    nombre2 = "Acumulación solar";
                }


            }
            //Si solo tiene bus genera
            if (busGE > 0 &amp;&amp; (typeof busAE === "undefined" || busAE == "-")) {
                var colector = "";
                var colectorG = "";
                //Almacenamos el número de la línea y flecha
                numFlechas.push(cont);
                numLineas.push(cont);
                numFlechasInversa.push(cont);
                //Creamos la fila del botón con su número correspondiente
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (busGE == colectores[x][1]) {
                        colectorG = (x + 1);
                    }
                }
                add = "&lt;tr id='trSer" + cont + "'>\n";
                add += "&lt;td class='complementos'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasComplemento(3,0," + busGE + ",0," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                var busCG = 0;
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (parseInt(colectores[x][1]) == busGE &amp;&amp; x &lt; numColector) {
                        numBusGE++;
                    }
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC) {
                        colectorG = colectores[x][1];
                        if (colectorG == "11") {
                            colectorG = "3";
                        }
                        if (colectorG == "14") {
                            colectorG = "4";
                        }
                        if (colectorG == "15") {
                            colectorG = "6";
                        }
                        busCG = busC;
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "'style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "'id='" + colectores[x][0] + "-" + cont + "'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "e'style='width:13.375px;'>&lt;/td>\n";
                    }
                }
               
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 += "&lt;td class='complementos' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='max-height: 15px'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC) {
                        colectorG = colectores[x][1];
                        if (colectorG == "11") {
                            colectorG = "3";
                        }
                        if (colectorG == "14") {
                            colectorG = "4";
                        }
                        if (colectorG == "15") {
                            colectorG = "6";
                        }
                        busCG = busC;
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s'style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s'style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "se'style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                lineasCreadas[busC - 1] = true;
                //Ponemos a true el radio del bus correspondiente
                //sacamos los valores para calcular la posición de la flecha y la línea
                alturaSer = document.getElementsByClassName("complementos")[document.getElementsByClassName("complementos").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCG + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea
                leftLineas = long + distancia - 2;
                widthLineas = izq - (leftB + long) + 5;
                topLineas = topB + (alt / 2) + 80;
                leftFlecha = long + distancia - 10;
                topFlecha = topB + (alt / 2) + 67;
                var linea = "&lt;section class='connectingLines" + colectorG + "' id='lineaSer" + cont + "' style='left:" + leftLineas + "px; top:" + topLineas + "px; width:" + widthLineas + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //Creamos la flecha
                var flecha = "&lt;img class='flecha" + colectorG + "' src='flecha" + colectorG + ".png'   id='flechaSer" + cont + "'style='left:" + (leftLineas + widthLineas - 30) + "px; top:" + topFlecha + "px;'>";
                var flecha2 = "&lt;img class='flecha" + colectorG + "' src='flechaInversa" + colectorG + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 10) + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que esté definido
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        equipo = [cont, nombre2, "C" + busCG, "-", "Nuevo", "no", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid green";
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "-", "Existente", "no", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        equipo = [cont, nombre2, "C" + busCG, "-", "Nuevo", "si", "3", tipoEquipo.id, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "-", "Existente", "si", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //Si está definido cargamos los valores en características
                if (definido == "si") {
                    equipos[equipos.length - 1][8] = $scope.equipo[equipoEx].idcontador;
                    equipos[equipos.length - 1][9] = $scope.equipo[equipoEx].nombreequipo;
                    caracteristicas[equipos.length - 1][0] = $scope.equipo[equipoEx].atr1;
                    caracteristicas[equipos.length - 1][1] = $scope.equipo[equipoEx].atr2;
                    caracteristicas[equipos.length - 1][2] = $scope.equipo[equipoEx].atr3;
                    caracteristicas[equipos.length - 1][3] = $scope.equipo[equipoEx].atr4;
                    caracteristicas[equipos.length - 1][4] = $scope.equipo[equipoEx].atr5;
                    caracteristicas[equipos.length - 1][5] = $scope.equipo[equipoEx].atr6;
                    caracteristicas[equipos.length - 1][6] = $scope.equipo[equipoEx].atr7;
                    caracteristicas[equipos.length - 1][7] = $scope.equipo[equipoEx].atr8;
                    caracteristicas[equipos.length - 1][8] = $scope.equipo[equipoEx].atr9;
                    caracteristicas[equipos.length - 1][9] = $scope.equipo[equipoEx].atr10;
                    caracteristicas[equipos.length - 1][10] = $scope.equipo[equipoEx].atr11;
                    caracteristicas[equipos.length - 1][11] = $scope.equipo[equipoEx].atr12;
                    caracteristicas[equipos.length - 1][12] = $scope.equipo[equipoEx].atr13;
                    caracteristicas[equipos.length - 1][13] = $scope.equipo[equipoEx].atr14;
                    caracteristicas[equipos.length - 1][14] = $scope.equipo[equipoEx].atr15;
                    caracteristicas[equipos.length - 1][15] = $scope.equipo[equipoEx].atr16;
                    valoresServiciosComplementos[equipos.length - 1][0] = $scope.equipo[equipoEx].valoresservicio1;
                    valoresServiciosComplementos[equipos.length - 1][1] = $scope.equipo[equipoEx].valoresservicio2;
                    valoresServiciosComplementos[equipos.length - 1][2] = $scope.equipo[equipoEx].valoresservicio3;
                    valoresServiciosComplementos[equipos.length - 1][3] = $scope.equipo[equipoEx].valoresservicio4;
                    valoresServiciosComplementos[equipos.length - 1][4] = $scope.equipo[equipoEx].valoresservicio5;
                    valoresServiciosComplementos[equipos.length - 1][5] = $scope.equipo[equipoEx].valoresservicio6;
                    valoresServiciosComplementos[equipos.length - 1][6] = $scope.equipo[equipoEx].valoresservicio7;
                    valoresServiciosComplementos[equipos.length - 1][7] = $scope.equipo[equipoEx].valoresservicio8;
                    valoresServiciosComplementos[equipos.length - 1][8] = $scope.equipo[equipoEx].valoresservicio9;
                    valoresServiciosComplementos[equipos.length - 1][9] = $scope.equipo[equipoEx].valoresservicio10;
                    valoresServiciosComplementos[equipos.length - 1][10] = $scope.equipo[equipoEx].valoresservicio11;
                    valoresServiciosComplementos[equipos.length - 1][11] = $scope.equipo[equipoEx].valoresservicio12;
                    valoresServiciosComplementos[equipos.length - 1][12] = $scope.equipo[equipoEx].valoresservicio13;
                    valoresServiciosComplementos[equipos.length - 1][13] = $scope.equipo[equipoEx].valoresservicio14;
                    valoresServiciosComplementos[equipos.length - 1][14] = $scope.equipo[equipoEx].valoresservicio15;
                    valoresServiciosComplementos[equipos.length - 1][15] = $scope.equipo[equipoEx].valoresservicio16;
                    valoresServiciosComplementos[equipos.length - 1][16] = $scope.equipo[equipoEx].valoresservicio17;
                    valoresServiciosComplementos[equipos.length - 1][17] = $scope.equipo[equipoEx].valoresservicio18;
                    valoresServiciosComplementos[equipos.length - 1][18] = $scope.equipo[equipoEx].valoresservicio19;
                    valoresServiciosComplementos[equipos.length - 1][19] = $scope.equipo[equipoEx].valoresservicio20;
                    valoresServiciosComplementos[equipos.length - 1][20] = $scope.equipo[equipoEx].valoresservicio21;
                    valoresServiciosComplementos[equipos.length - 1][21] = $scope.equipo[equipoEx].valoresservicio22;
                    valoresServiciosComplementos[equipos.length - 1][22] = $scope.equipo[equipoEx].valoresservicio23;
                    valoresServiciosComplementos[equipos.length - 1][23] = $scope.equipo[equipoEx].valoresservicio24;
                    valoresServiciosComplementos[equipos.length - 1][24] = $scope.equipo[equipoEx].valoresservicio25;
                    valoresServiciosComplementos[equipos.length - 1][25] = $scope.equipo[equipoEx].valoresservicio26;
                    valoresServiciosComplementos[equipos.length - 1][26] = $scope.equipo[equipoEx].valoresservicio27;
                    valoresServiciosComplementos[equipos.length - 1][27] = $scope.equipo[equipoEx].valoresservicio28;
                    valoresServiciosComplementos[equipos.length - 1][28] = $scope.equipo[equipoEx].valoresservicio29;
                    valoresServiciosComplementos[equipos.length - 1][29] = $scope.equipo[equipoEx].valoresservicio30;
                    valoresServiciosComplementos[equipos.length - 1][30] = $scope.equipo[equipoEx].valoresservicio31;
                    valoresServiciosComplementos[equipos.length - 1][31] = $scope.equipo[equipoEx].valoresservicio32;
                    valoresServiciosComplementos[equipos.length - 1][32] = $scope.equipo[equipoEx].valoresservicio33;
                    valoresServiciosComplementos[equipos.length - 1][33] = $scope.equipo[equipoEx].valoresservicio34;
                    valoresServiciosComplementos[equipos.length - 1][34] = $scope.equipo[equipoEx].valoresservicio35;
                    valoresServiciosComplementos[equipos.length - 1][35] = $scope.equipo[equipoEx].valoresservicio36;
                    valoresServiciosComplementos[equipos.length - 1][36] = $scope.equipo[equipoEx].valoresservicio37;
                    valoresServiciosComplementos[equipos.length - 1][37] = $scope.equipo[equipoEx].valoresservicio38;
                    valoresServiciosComplementos[equipos.length - 1][38] = $scope.equipo[equipoEx].valoresservicio39;
                    valoresServiciosComplementos[equipos.length - 1][39] = $scope.equipo[equipoEx].valoresservicio40;
                    valoresServiciosComplementos[equipos.length - 1][40] = $scope.equipo[equipoEx].valoresservicio41;
                    valoresServiciosComplementos[equipos.length - 1][41] = $scope.equipo[equipoEx].valoresservicio42;
                    valoresServiciosComplementos[equipos.length - 1][42] = $scope.equipo[equipoEx].valoresservicio43;
                    valoresServiciosComplementos[equipos.length - 1][43] = $scope.equipo[equipoEx].valoresservicio44;
                    valoresServiciosComplementos[equipos.length - 1][44] = $scope.equipo[equipoEx].valoresservicio45;
                    valoresServiciosComplementos[equipos.length - 1][45] = $scope.equipo[equipoEx].valoresservicio46;
                    valoresServiciosComplementos[equipos.length - 1][46] = $scope.equipo[equipoEx].valoresservicio47;
                    valoresServiciosComplementos[equipos.length - 1][47] = $scope.equipo[equipoEx].valoresservicio48;
                    valoresServiciosComplementos[equipos.length - 1][48] = $scope.equipo[equipoEx].valoresservicio49;
                    valoresServiciosComplementos[equipos.length - 1][49] = $scope.equipo[equipoEx].valoresservicio50;
                    valoresServiciosComplementos[equipos.length - 1][50] = $scope.equipo[equipoEx].valoresservicio51;
                    valoresServiciosComplementos[equipos.length - 1][51] = $scope.equipo[equipoEx].valoresservicio52;
                    valoresServiciosComplementos[equipos.length - 1][52] = $scope.equipo[equipoEx].valoresservicio53;
                    valoresServiciosComplementos[equipos.length - 1][53] = $scope.equipo[equipoEx].valoresservicio54;
                    valoresServiciosComplementos[equipos.length - 1][54] = $scope.equipo[equipoEx].valoresservicio55;
                    valoresServiciosComplementos[equipos.length - 1][55] = $scope.equipo[equipoEx].valoresservicio56;
                    valoresServiciosComplementos[equipos.length - 1][56] = $scope.equipo[equipoEx].valoresservicio57;
                    valoresServiciosComplementos[equipos.length - 1][57] = $scope.equipo[equipoEx].valoresservicio58;
                    valoresServiciosComplementos[equipos.length - 1][58] = $scope.equipo[equipoEx].valoresservicio59;
                    valoresServiciosComplementos[equipos.length - 1][59] = $scope.equipo[equipoEx].valoresservicio60;
                    valoresServiciosComplementos[equipos.length - 1][60] = $scope.equipo[equipoEx].valoresservicio61;
                    valoresServiciosComplementos[equipos.length - 1][61] = $scope.equipo[equipoEx].valoresservicio62;
                    valoresServiciosComplementos[equipos.length - 1][62] = $scope.equipo[equipoEx].valoresservicio63;
                    valoresServiciosComplementos[equipos.length - 1][63] = $scope.equipo[equipoEx].valoresservicio64;
                    valoresServiciosComplementos[equipos.length - 1][64] = $scope.equipo[equipoEx].valoresservicio65;
                    valoresServiciosComplementos[equipos.length - 1][65] = $scope.equipo[equipoEx].valoresservicio66;
                    valoresServiciosComplementos[equipos.length - 1][66] = $scope.equipo[equipoEx].valoresservicio67;
                    valoresServiciosComplementos[equipos.length - 1][67] = $scope.equipo[equipoEx].valoresservicio68;
                    valoresServiciosComplementos[equipos.length - 1][68] = $scope.equipo[equipoEx].valoresservicio69;
                    valoresServiciosComplementos[equipos.length - 1][69] = $scope.equipo[equipoEx].valoresservicio70;
                    valoresServiciosComplementos[equipos.length - 1][70] = $scope.equipo[equipoEx].valoresservicio71;
                    valoresServiciosComplementos[equipos.length - 1][71] = $scope.equipo[equipoEx].valoresservicio72;
                    valoresServiciosComplementos[equipos.length - 1][72] = $scope.equipo[equipoEx].valoresservicio73;
                    valoresServiciosComplementos[equipos.length - 1][73] = $scope.equipo[equipoEx].valoresservicio74;
                    valoresServiciosComplementos[equipos.length - 1][74] = $scope.equipo[equipoEx].valoresservicio75;
                }
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado
                
                cont++;
                dibujarBuses(busCG, 0, colectorG, 0, equipos.length);
            }
            //Si solo tiene bus alimenta
            if (busAE > 0 &amp;&amp; (typeof busGE === "undefined" || busGE == "-")) {
                //Si el contador de servicios es 0
                
                //Almacenamos el número de la línea y flecha
                var colector = "";
                var colectorA = "";
                var numBusAE = 0;
                numFlechasInversa.push(cont);
                numLineasInversa.push(cont);
                numFlechas.push(cont);
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (busAE == colectores[x][1]) {
                        colectorA = (x + 1);
                    }
                }
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                add += "&lt;td class='complementos'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasComplemento(3,1," + busAE + ",0," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                var busCA = 0;
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (parseInt(colectores[x][1]) == busAE &amp;&amp; x &lt; numColector) {
                        numBusAE++;
                    }
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busAE == busC) {
                        colectorA = colectores[x][1];
                      
                        if (colectorA == "11") {
                            colectorA = "3";
                        }
                        if (colectorA == "14") {
                            colectorA = "4";
                        }
                        if (colectorA == "15") {
                            colectorA = "6";
                        }
                        busCA = busC;
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "'style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "'id='" + colectores[x][0] + "-" + cont + "'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "e'style='width:13.375px;'>&lt;/td>\n";
                    }
                }
                
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 += "&lt;td class='complementos' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='max-height: 15px'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busAE == busC) {
                        colectorA = colectores[x][1];
                        if (colectorA == "11") {
                            colectorA = "3";
                        }
                        if (colectorA == "14") {
                            colectorA = "4";
                        }
                        if (colectorA == "15") {
                            colectorA = "6";
                        }
                        busCA = busC;
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s'style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s'style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "se' style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                //Ponemos a true el radio del bus correspondiente
                lineasCreadas[busC - 1] = true;
                //sacamos los valores para calcular la posición de la flecha y la línea
                alturaSer = document.getElementsByClassName("complementos")[document.getElementsByClassName("complementos").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCA + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea
                leftLineasInversa = long + distancia - 2;
                widthLineasInversa = izq - (leftB + long) + 5;
                topLineasInversa = topB + (alt / 2) + 100;
                leftFlechaInversa = long - 10 + distancia;
                topFlechaInversa = topB + (alt / 2) + 87;
                var linea = "&lt;section class='connectingLines" + colectorA + "' id='lineaSerInversa" + cont + "' style='left:" + leftLineasInversa + "px; top:" + topLineasInversa + "px; width:" + widthLineasInversa + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //creamos la flecha
                var flecha = "&lt;img class='flecha" + colectorA + "' src='flecha" + colectorA + ".png'   id='flechaSer" + cont + "A'style='left:" + (leftLineasInversa + widthLineasInversa - 30) + "px; top:" + topFlechaInversa + "px;'>";
                var flecha2 = "&lt;img class='flecha" + colectorA + "' src='flechaInversa" + colectorA + ".png'   id='flechaSerInversa" + cont + "A'style='left:" + (leftFlechaInversa) + "px; top:" + topFlechaInversa + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que esté definido
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        equipo = [cont, nombre2, "-", "C" + busCA, "Nuevo", "no", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid green";
                    } else {
                        equipo = [cont, nombre2, "-", "C" + busCA, "Existente", "no", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        equipo = [cont, nombre2, "-", "C" + busCA, "Nuevo", "si", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    } else {
                        equipo = [cont, nombre2, "-", "C" + busCA, "Existente", "si", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //Si está definido cargamos los valores en características
                if (definido == "si") {
                    equipos[equipos.length - 1][8] = $scope.equipo[equipoEx].idcontador;
                    equipos[equipos.length - 1][9] = $scope.equipo[equipoEx].nombreequipo;
                    caracteristicas[equipos.length - 1][0] = $scope.equipo[equipoEx].atr1;
                    caracteristicas[equipos.length - 1][1] = $scope.equipo[equipoEx].atr2;
                    caracteristicas[equipos.length - 1][2] = $scope.equipo[equipoEx].atr3;
                    caracteristicas[equipos.length - 1][3] = $scope.equipo[equipoEx].atr4;
                    caracteristicas[equipos.length - 1][4] = $scope.equipo[equipoEx].atr5;
                    caracteristicas[equipos.length - 1][5] = $scope.equipo[equipoEx].atr6;
                    caracteristicas[equipos.length - 1][6] = $scope.equipo[equipoEx].atr7;
                    caracteristicas[equipos.length - 1][7] = $scope.equipo[equipoEx].atr8;
                    caracteristicas[equipos.length - 1][8] = $scope.equipo[equipoEx].atr9;
                    caracteristicas[equipos.length - 1][9] = $scope.equipo[equipoEx].atr10;
                    caracteristicas[equipos.length - 1][10] = $scope.equipo[equipoEx].atr11;
                    caracteristicas[equipos.length - 1][11] = $scope.equipo[equipoEx].atr12;
                    caracteristicas[equipos.length - 1][12] = $scope.equipo[equipoEx].atr13;
                    caracteristicas[equipos.length - 1][13] = $scope.equipo[equipoEx].atr14;
                    caracteristicas[equipos.length - 1][14] = $scope.equipo[equipoEx].atr15;
                    caracteristicas[equipos.length - 1][15] = $scope.equipo[equipoEx].atr16;
                    valoresServiciosComplementos[equipos.length - 1][0] = $scope.equipo[equipoEx].valoresservicio1;
                    valoresServiciosComplementos[equipos.length - 1][1] = $scope.equipo[equipoEx].valoresservicio2;
                    valoresServiciosComplementos[equipos.length - 1][2] = $scope.equipo[equipoEx].valoresservicio3;
                    valoresServiciosComplementos[equipos.length - 1][3] = $scope.equipo[equipoEx].valoresservicio4;
                    valoresServiciosComplementos[equipos.length - 1][4] = $scope.equipo[equipoEx].valoresservicio5;
                    valoresServiciosComplementos[equipos.length - 1][5] = $scope.equipo[equipoEx].valoresservicio6;
                    valoresServiciosComplementos[equipos.length - 1][6] = $scope.equipo[equipoEx].valoresservicio7;
                    valoresServiciosComplementos[equipos.length - 1][7] = $scope.equipo[equipoEx].valoresservicio8;
                    valoresServiciosComplementos[equipos.length - 1][8] = $scope.equipo[equipoEx].valoresservicio9;
                    valoresServiciosComplementos[equipos.length - 1][9] = $scope.equipo[equipoEx].valoresservicio10;
                    valoresServiciosComplementos[equipos.length - 1][10] = $scope.equipo[equipoEx].valoresservicio11;
                    valoresServiciosComplementos[equipos.length - 1][11] = $scope.equipo[equipoEx].valoresservicio12;
                    valoresServiciosComplementos[equipos.length - 1][12] = $scope.equipo[equipoEx].valoresservicio13;
                    valoresServiciosComplementos[equipos.length - 1][13] = $scope.equipo[equipoEx].valoresservicio14;
                    valoresServiciosComplementos[equipos.length - 1][14] = $scope.equipo[equipoEx].valoresservicio15;
                    valoresServiciosComplementos[equipos.length - 1][15] = $scope.equipo[equipoEx].valoresservicio16;
                    valoresServiciosComplementos[equipos.length - 1][16] = $scope.equipo[equipoEx].valoresservicio17;
                    valoresServiciosComplementos[equipos.length - 1][17] = $scope.equipo[equipoEx].valoresservicio18;
                    valoresServiciosComplementos[equipos.length - 1][18] = $scope.equipo[equipoEx].valoresservicio19;
                    valoresServiciosComplementos[equipos.length - 1][19] = $scope.equipo[equipoEx].valoresservicio20;
                    valoresServiciosComplementos[equipos.length - 1][20] = $scope.equipo[equipoEx].valoresservicio21;
                    valoresServiciosComplementos[equipos.length - 1][21] = $scope.equipo[equipoEx].valoresservicio22;
                    valoresServiciosComplementos[equipos.length - 1][22] = $scope.equipo[equipoEx].valoresservicio23;
                    valoresServiciosComplementos[equipos.length - 1][23] = $scope.equipo[equipoEx].valoresservicio24;
                    valoresServiciosComplementos[equipos.length - 1][24] = $scope.equipo[equipoEx].valoresservicio25;
                    valoresServiciosComplementos[equipos.length - 1][25] = $scope.equipo[equipoEx].valoresservicio26;
                    valoresServiciosComplementos[equipos.length - 1][26] = $scope.equipo[equipoEx].valoresservicio27;
                    valoresServiciosComplementos[equipos.length - 1][27] = $scope.equipo[equipoEx].valoresservicio28;
                    valoresServiciosComplementos[equipos.length - 1][28] = $scope.equipo[equipoEx].valoresservicio29;
                    valoresServiciosComplementos[equipos.length - 1][29] = $scope.equipo[equipoEx].valoresservicio30;
                    valoresServiciosComplementos[equipos.length - 1][30] = $scope.equipo[equipoEx].valoresservicio31;
                    valoresServiciosComplementos[equipos.length - 1][31] = $scope.equipo[equipoEx].valoresservicio32;
                    valoresServiciosComplementos[equipos.length - 1][32] = $scope.equipo[equipoEx].valoresservicio33;
                    valoresServiciosComplementos[equipos.length - 1][33] = $scope.equipo[equipoEx].valoresservicio34;
                    valoresServiciosComplementos[equipos.length - 1][34] = $scope.equipo[equipoEx].valoresservicio35;
                    valoresServiciosComplementos[equipos.length - 1][35] = $scope.equipo[equipoEx].valoresservicio36;
                    valoresServiciosComplementos[equipos.length - 1][36] = $scope.equipo[equipoEx].valoresservicio37;
                    valoresServiciosComplementos[equipos.length - 1][37] = $scope.equipo[equipoEx].valoresservicio38;
                    valoresServiciosComplementos[equipos.length - 1][38] = $scope.equipo[equipoEx].valoresservicio39;
                    valoresServiciosComplementos[equipos.length - 1][39] = $scope.equipo[equipoEx].valoresservicio40;
                    valoresServiciosComplementos[equipos.length - 1][40] = $scope.equipo[equipoEx].valoresservicio41;
                    valoresServiciosComplementos[equipos.length - 1][41] = $scope.equipo[equipoEx].valoresservicio42;
                    valoresServiciosComplementos[equipos.length - 1][42] = $scope.equipo[equipoEx].valoresservicio43;
                    valoresServiciosComplementos[equipos.length - 1][43] = $scope.equipo[equipoEx].valoresservicio44;
                    valoresServiciosComplementos[equipos.length - 1][44] = $scope.equipo[equipoEx].valoresservicio45;
                    valoresServiciosComplementos[equipos.length - 1][45] = $scope.equipo[equipoEx].valoresservicio46;
                    valoresServiciosComplementos[equipos.length - 1][46] = $scope.equipo[equipoEx].valoresservicio47;
                    valoresServiciosComplementos[equipos.length - 1][47] = $scope.equipo[equipoEx].valoresservicio48;
                    valoresServiciosComplementos[equipos.length - 1][48] = $scope.equipo[equipoEx].valoresservicio49;
                    valoresServiciosComplementos[equipos.length - 1][49] = $scope.equipo[equipoEx].valoresservicio50;
                    valoresServiciosComplementos[equipos.length - 1][50] = $scope.equipo[equipoEx].valoresservicio51;
                    valoresServiciosComplementos[equipos.length - 1][51] = $scope.equipo[equipoEx].valoresservicio52;
                    valoresServiciosComplementos[equipos.length - 1][52] = $scope.equipo[equipoEx].valoresservicio53;
                    valoresServiciosComplementos[equipos.length - 1][53] = $scope.equipo[equipoEx].valoresservicio54;
                    valoresServiciosComplementos[equipos.length - 1][54] = $scope.equipo[equipoEx].valoresservicio55;
                    valoresServiciosComplementos[equipos.length - 1][55] = $scope.equipo[equipoEx].valoresservicio56;
                    valoresServiciosComplementos[equipos.length - 1][56] = $scope.equipo[equipoEx].valoresservicio57;
                    valoresServiciosComplementos[equipos.length - 1][57] = $scope.equipo[equipoEx].valoresservicio58;
                    valoresServiciosComplementos[equipos.length - 1][58] = $scope.equipo[equipoEx].valoresservicio59;
                    valoresServiciosComplementos[equipos.length - 1][59] = $scope.equipo[equipoEx].valoresservicio60;
                    valoresServiciosComplementos[equipos.length - 1][60] = $scope.equipo[equipoEx].valoresservicio61;
                    valoresServiciosComplementos[equipos.length - 1][61] = $scope.equipo[equipoEx].valoresservicio62;
                    valoresServiciosComplementos[equipos.length - 1][62] = $scope.equipo[equipoEx].valoresservicio63;
                    valoresServiciosComplementos[equipos.length - 1][63] = $scope.equipo[equipoEx].valoresservicio64;
                    valoresServiciosComplementos[equipos.length - 1][64] = $scope.equipo[equipoEx].valoresservicio65;
                    valoresServiciosComplementos[equipos.length - 1][65] = $scope.equipo[equipoEx].valoresservicio66;
                    valoresServiciosComplementos[equipos.length - 1][66] = $scope.equipo[equipoEx].valoresservicio67;
                    valoresServiciosComplementos[equipos.length - 1][67] = $scope.equipo[equipoEx].valoresservicio68;
                    valoresServiciosComplementos[equipos.length - 1][68] = $scope.equipo[equipoEx].valoresservicio69;
                    valoresServiciosComplementos[equipos.length - 1][69] = $scope.equipo[equipoEx].valoresservicio70;
                    valoresServiciosComplementos[equipos.length - 1][70] = $scope.equipo[equipoEx].valoresservicio71;
                    valoresServiciosComplementos[equipos.length - 1][71] = $scope.equipo[equipoEx].valoresservicio72;
                    valoresServiciosComplementos[equipos.length - 1][72] = $scope.equipo[equipoEx].valoresservicio73;
                    valoresServiciosComplementos[equipos.length - 1][73] = $scope.equipo[equipoEx].valoresservicio74;
                    valoresServiciosComplementos[equipos.length - 1][74] = $scope.equipo[equipoEx].valoresservicio75;
                }
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado
                
                cont++;
                dibujarBuses(0, busCA, 0, colectorA, equipos.length);
            }
            //Si tiene ambos
            if (busAE > 0 &amp;&amp; busGE > 0) {
                //Si el contador de servicios es 0
                //Almacenamos el número de la línea y flecha
                numFlechas.push(cont);
                numFlechasInversa.push(cont);
                if (busGE != busAE) {
                    numFlechas.push(cont + "A");
                    numFlechasInversa.push(cont + "A");
                    numLineasInversa.push(cont);
                }
                numLineas.push(cont);
                var busCG = 0;
                var busCA = 0;
                var colector = "";
                var colectorG = "";
                var colectorA = "";
                var numBusAE = 0;
                var numBusGE = 0;
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                add += "&lt;td class='complementos'> &lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasComplemento(3,2," + busGE + "," + busAE + "," + cont + "," + tipoServicio + ")'>" + nombre2 + "&lt;/button>&lt;/td>\n";
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    if (parseInt(colectores[x][1]) == busGE &amp;&amp; x &lt; numColector) {
                        numBusGE++;
                    }
                    if (parseInt(colectores[x][1]) == busAE &amp;&amp; x &lt; numColector) {
                        numBusAE++;
                    }
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC || busAE == busC) {
                        if (busGE == busC) {
                            colectorG = colectores[x][1];
                            if (colectorG == "11") {
                                colectorG = "3";
                            }
                            if (colectorG == "14") {
                                colectorG = "4";
                            }
                            if (colectorG == "15") {
                                colectorG = "6";
                            }
                            busCG = busC;
                        }
                        if (busAE == busC) {
                            colectorA = colectores[x][1];
                            if (colectorA == "11") {
                                colectorA = "3";
                            }
                            if (colectorA == "14") {
                                colectorA = "4";
                            }
                            if (colectorA == "15") {
                                colectorA = "6";
                            }
                            busCA = busC;
                        }
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "' style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "' >&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x][0] + "-" + cont + "e' style='width:13.375px;'>&lt;/td>\n";
                    }
                }
                
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 += "&lt;td class='complementos' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='max-height: 15px'>&lt;/td>\n";
                for (var x = 0; x &lt; colectores.length; x++) {
                    var busC = colectores[x][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busGE == busC || busAE == busC) {
                        if (busGE == busC) {
                            colectorG = colectores[x][1];
                            if (colectorG == "11") {
                                colectorG = "3";
                            }
                            if (colectorG == "14") {
                                colectorG = "4";
                            }
                            if (colectorG == "15") {
                                colectorG = "6";
                            }
                            busCG = busC;
                        }
                        if (busAE == busC) {
                            colectorA = colectores[x][1];
                            if (colectorA == "11") {
                                colectorA = "3";
                            }
                            if (colectorA == "14") {
                                colectorA = "4";
                            }
                            if (colectorA == "15") {
                                colectorA = "6";
                            }
                            busCA = busC;
                        }
                        add2 += "&lt;td class='bus" + colector + "'id='" + colectores[x][0] + "-" + cont + "s' style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x][0] + "-" + cont + "s'style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio1" + colector + "' id='" + colectores[x][0] + "-" + cont + "se'style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                //Ponemos a true el radio del bus correspondiente
                lineasCreadas[busCA - 1] = true;
                lineasCreadas[busCG - 1] = true;
                //sacamos los valores para calcular la posición de la flecha y la línea alimenta
                alturaSer = document.getElementsByClassName("servicios")[document.getElementsByClassName("servicios").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCG + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea alimenta
                leftLineas = long + distancia - 2;
                widthLineas = izq - (leftB + long) + 5;
                topLineas = topB + (alt / 2) + 70;
                leftFlecha = long + distancia - 10;
                topFlecha = topB + (alt / 2) + 57;
                var linea = "&lt;section class='connectingLines" + colectorG + "' id='lineaSer" + cont + "' style='left:" + leftLineas + "px; top:" + topLineas + "px; width:" + widthLineas + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //creamos la flecha alimenta
                var flecha = "&lt;img class='flecha" + colectorG + "' src='flecha" + colectorG + ".png'   id='flechaSer" + cont + "'style='left:" + (leftLineas + widthLineas - 30) + "px; top:" + topFlecha + "px;'>";
                var flecha2 = "&lt;img class='flecha" + colectorG + "' src='flechaInversa" + colectorG + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 10) + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que esté definido
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Nuevo", "no", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid green";
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Existente", "no", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Nuevo", "si", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    } else {
                        equipo = [cont, nombre2, "C" + busCG, "C" + busCA, "Existente", "si", "3", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //Si está definido cargamos los valores en características
                if (definido == "si") {
                    equipos[equipos.length - 1][8] = $scope.equipo[equipoEx].idcontador;
                    equipos[equipos.length - 1][9] = $scope.equipo[equipoEx].nombreequipo;
                    caracteristicas[equipos.length - 1][0] = $scope.equipo[equipoEx].atr1;
                    caracteristicas[equipos.length - 1][1] = $scope.equipo[equipoEx].atr2;
                    caracteristicas[equipos.length - 1][2] = $scope.equipo[equipoEx].atr3;
                    caracteristicas[equipos.length - 1][3] = $scope.equipo[equipoEx].atr4;
                    caracteristicas[equipos.length - 1][4] = $scope.equipo[equipoEx].atr5;
                    caracteristicas[equipos.length - 1][5] = $scope.equipo[equipoEx].atr6;
                    caracteristicas[equipos.length - 1][6] = $scope.equipo[equipoEx].atr7;
                    caracteristicas[equipos.length - 1][7] = $scope.equipo[equipoEx].atr8;
                    caracteristicas[equipos.length - 1][8] = $scope.equipo[equipoEx].atr9;
                    caracteristicas[equipos.length - 1][9] = $scope.equipo[equipoEx].atr10;
                    caracteristicas[equipos.length - 1][10] = $scope.equipo[equipoEx].atr11;
                    caracteristicas[equipos.length - 1][11] = $scope.equipo[equipoEx].atr12;
                    caracteristicas[equipos.length - 1][12] = $scope.equipo[equipoEx].atr13;
                    caracteristicas[equipos.length - 1][13] = $scope.equipo[equipoEx].atr14;
                    caracteristicas[equipos.length - 1][14] = $scope.equipo[equipoEx].atr15;
                    caracteristicas[equipos.length - 1][15] = $scope.equipo[equipoEx].atr16;
                    valoresServiciosComplementos[equipos.length - 1][0] = $scope.equipo[equipoEx].valoresservicio1;
                    valoresServiciosComplementos[equipos.length - 1][1] = $scope.equipo[equipoEx].valoresservicio2;
                    valoresServiciosComplementos[equipos.length - 1][2] = $scope.equipo[equipoEx].valoresservicio3;
                    valoresServiciosComplementos[equipos.length - 1][3] = $scope.equipo[equipoEx].valoresservicio4;
                    valoresServiciosComplementos[equipos.length - 1][4] = $scope.equipo[equipoEx].valoresservicio5;
                    valoresServiciosComplementos[equipos.length - 1][5] = $scope.equipo[equipoEx].valoresservicio6;
                    valoresServiciosComplementos[equipos.length - 1][6] = $scope.equipo[equipoEx].valoresservicio7;
                    valoresServiciosComplementos[equipos.length - 1][7] = $scope.equipo[equipoEx].valoresservicio8;
                    valoresServiciosComplementos[equipos.length - 1][8] = $scope.equipo[equipoEx].valoresservicio9;
                    valoresServiciosComplementos[equipos.length - 1][9] = $scope.equipo[equipoEx].valoresservicio10;
                    valoresServiciosComplementos[equipos.length - 1][10] = $scope.equipo[equipoEx].valoresservicio11;
                    valoresServiciosComplementos[equipos.length - 1][11] = $scope.equipo[equipoEx].valoresservicio12;
                    valoresServiciosComplementos[equipos.length - 1][12] = $scope.equipo[equipoEx].valoresservicio13;
                    valoresServiciosComplementos[equipos.length - 1][13] = $scope.equipo[equipoEx].valoresservicio14;
                    valoresServiciosComplementos[equipos.length - 1][14] = $scope.equipo[equipoEx].valoresservicio15;
                    valoresServiciosComplementos[equipos.length - 1][15] = $scope.equipo[equipoEx].valoresservicio16;
                    valoresServiciosComplementos[equipos.length - 1][16] = $scope.equipo[equipoEx].valoresservicio17;
                    valoresServiciosComplementos[equipos.length - 1][17] = $scope.equipo[equipoEx].valoresservicio18;
                    valoresServiciosComplementos[equipos.length - 1][18] = $scope.equipo[equipoEx].valoresservicio19;
                    valoresServiciosComplementos[equipos.length - 1][19] = $scope.equipo[equipoEx].valoresservicio20;
                    valoresServiciosComplementos[equipos.length - 1][20] = $scope.equipo[equipoEx].valoresservicio21;
                    valoresServiciosComplementos[equipos.length - 1][21] = $scope.equipo[equipoEx].valoresservicio22;
                    valoresServiciosComplementos[equipos.length - 1][22] = $scope.equipo[equipoEx].valoresservicio23;
                    valoresServiciosComplementos[equipos.length - 1][23] = $scope.equipo[equipoEx].valoresservicio24;
                    valoresServiciosComplementos[equipos.length - 1][24] = $scope.equipo[equipoEx].valoresservicio25;
                    valoresServiciosComplementos[equipos.length - 1][25] = $scope.equipo[equipoEx].valoresservicio26;
                    valoresServiciosComplementos[equipos.length - 1][26] = $scope.equipo[equipoEx].valoresservicio27;
                    valoresServiciosComplementos[equipos.length - 1][27] = $scope.equipo[equipoEx].valoresservicio28;
                    valoresServiciosComplementos[equipos.length - 1][28] = $scope.equipo[equipoEx].valoresservicio29;
                    valoresServiciosComplementos[equipos.length - 1][29] = $scope.equipo[equipoEx].valoresservicio30;
                    valoresServiciosComplementos[equipos.length - 1][30] = $scope.equipo[equipoEx].valoresservicio31;
                    valoresServiciosComplementos[equipos.length - 1][31] = $scope.equipo[equipoEx].valoresservicio32;
                    valoresServiciosComplementos[equipos.length - 1][32] = $scope.equipo[equipoEx].valoresservicio33;
                    valoresServiciosComplementos[equipos.length - 1][33] = $scope.equipo[equipoEx].valoresservicio34;
                    valoresServiciosComplementos[equipos.length - 1][34] = $scope.equipo[equipoEx].valoresservicio35;
                    valoresServiciosComplementos[equipos.length - 1][35] = $scope.equipo[equipoEx].valoresservicio36;
                    valoresServiciosComplementos[equipos.length - 1][36] = $scope.equipo[equipoEx].valoresservicio37;
                    valoresServiciosComplementos[equipos.length - 1][37] = $scope.equipo[equipoEx].valoresservicio38;
                    valoresServiciosComplementos[equipos.length - 1][38] = $scope.equipo[equipoEx].valoresservicio39;
                    valoresServiciosComplementos[equipos.length - 1][39] = $scope.equipo[equipoEx].valoresservicio40;
                    valoresServiciosComplementos[equipos.length - 1][40] = $scope.equipo[equipoEx].valoresservicio41;
                    valoresServiciosComplementos[equipos.length - 1][41] = $scope.equipo[equipoEx].valoresservicio42;
                    valoresServiciosComplementos[equipos.length - 1][42] = $scope.equipo[equipoEx].valoresservicio43;
                    valoresServiciosComplementos[equipos.length - 1][43] = $scope.equipo[equipoEx].valoresservicio44;
                    valoresServiciosComplementos[equipos.length - 1][44] = $scope.equipo[equipoEx].valoresservicio45;
                    valoresServiciosComplementos[equipos.length - 1][45] = $scope.equipo[equipoEx].valoresservicio46;
                    valoresServiciosComplementos[equipos.length - 1][46] = $scope.equipo[equipoEx].valoresservicio47;
                    valoresServiciosComplementos[equipos.length - 1][47] = $scope.equipo[equipoEx].valoresservicio48;
                    valoresServiciosComplementos[equipos.length - 1][48] = $scope.equipo[equipoEx].valoresservicio49;
                    valoresServiciosComplementos[equipos.length - 1][49] = $scope.equipo[equipoEx].valoresservicio50;
                    valoresServiciosComplementos[equipos.length - 1][50] = $scope.equipo[equipoEx].valoresservicio51;
                    valoresServiciosComplementos[equipos.length - 1][51] = $scope.equipo[equipoEx].valoresservicio52;
                    valoresServiciosComplementos[equipos.length - 1][52] = $scope.equipo[equipoEx].valoresservicio53;
                    valoresServiciosComplementos[equipos.length - 1][53] = $scope.equipo[equipoEx].valoresservicio54;
                    valoresServiciosComplementos[equipos.length - 1][54] = $scope.equipo[equipoEx].valoresservicio55;
                    valoresServiciosComplementos[equipos.length - 1][55] = $scope.equipo[equipoEx].valoresservicio56;
                    valoresServiciosComplementos[equipos.length - 1][56] = $scope.equipo[equipoEx].valoresservicio57;
                    valoresServiciosComplementos[equipos.length - 1][57] = $scope.equipo[equipoEx].valoresservicio58;
                    valoresServiciosComplementos[equipos.length - 1][58] = $scope.equipo[equipoEx].valoresservicio59;
                    valoresServiciosComplementos[equipos.length - 1][59] = $scope.equipo[equipoEx].valoresservicio60;
                    valoresServiciosComplementos[equipos.length - 1][60] = $scope.equipo[equipoEx].valoresservicio61;
                    valoresServiciosComplementos[equipos.length - 1][61] = $scope.equipo[equipoEx].valoresservicio62;
                    valoresServiciosComplementos[equipos.length - 1][62] = $scope.equipo[equipoEx].valoresservicio63;
                    valoresServiciosComplementos[equipos.length - 1][63] = $scope.equipo[equipoEx].valoresservicio64;
                    valoresServiciosComplementos[equipos.length - 1][64] = $scope.equipo[equipoEx].valoresservicio65;
                    valoresServiciosComplementos[equipos.length - 1][65] = $scope.equipo[equipoEx].valoresservicio66;
                    valoresServiciosComplementos[equipos.length - 1][66] = $scope.equipo[equipoEx].valoresservicio67;
                    valoresServiciosComplementos[equipos.length - 1][67] = $scope.equipo[equipoEx].valoresservicio68;
                    valoresServiciosComplementos[equipos.length - 1][68] = $scope.equipo[equipoEx].valoresservicio69;
                    valoresServiciosComplementos[equipos.length - 1][69] = $scope.equipo[equipoEx].valoresservicio70;
                    valoresServiciosComplementos[equipos.length - 1][70] = $scope.equipo[equipoEx].valoresservicio71;
                    valoresServiciosComplementos[equipos.length - 1][71] = $scope.equipo[equipoEx].valoresservicio72;
                    valoresServiciosComplementos[equipos.length - 1][72] = $scope.equipo[equipoEx].valoresservicio73;
                    valoresServiciosComplementos[equipos.length - 1][73] = $scope.equipo[equipoEx].valoresservicio74;
                    valoresServiciosComplementos[equipos.length - 1][74] = $scope.equipo[equipoEx].valoresservicio75;
                }
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //sacamos los valores para calcular la posición de la flecha y la línea genera
                alturaSer = document.getElementsByClassName("complementos")[document.getElementsByClassName("complementos").length - 1];
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCA + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(alturaSer).width();
                //creamos la línea genera
                leftLineasInversa = long + distancia - 2;
                widthLineasInversa = izq - (leftB + long - 3);
                topLineasInversa = topB + (alt / 2) + 90;
                leftFlechaInversa = long + distancia - 10;
                topFlechaInversa = topB + (alt / 2) + 77;
                if (busGE != busAE) {
                    var linea = "&lt;section class='connectingLines" + colectorA + "' id='lineaSerInversa" + cont + "' style='left:" + leftLineasInversa + "px; top:" + topLineasInversa + "px; width:" + widthLineasInversa + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                    //creamos la flecha genera
                    var flecha = "&lt;img class='flecha" + colectorA + "' src='flecha" + colectorA + ".png'   id='flechaSer" + cont + "A'style='left:" + (leftLineasInversa + widthLineasInversa - 30) + "px; top:" + topFlechaInversa + "px;'>";
                    var flecha2 = "&lt;img class='flecha" + colectorA + "' src='flechaInversa" + colectorA + ".png'   id='flechaSerInversa" + cont + "A'style='left:" + (leftFlechaInversa) + "px; top:" + topFlechaInversa + "px;'>";
                    //Almacenamos en equipos el equipo creado y comprobamos que sea nuevo o existente
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                }//Caragamos la función buses y hacemos visible los buses anteriores al servicio creado de alimenta
                
                cont++;
                dibujarBuses(busCG, busCA, colectorG, colectorA, equipos.length);
            }
            $('#myModalComplemento3').modal('hide');
        }
        /**

            *Creamos el botón uso junto con su línea/s y flecha/s
            * @return  {void}

            */
        updateBusUso = function (uso, tipo) {
            var tipoEquipo = "";
            var tipoServicio = "";
            var add;
            var add2;
            var definido;
            var busGE = "";
            var busGT;
            var busAE;
            var busAT;
            var nombre;
            var conc = 0.0;
            var conf = 0.0;
            var conacs = 0.0;
            var equipo = new Array();
            var uso2 = uso;
            var media = false;
            var conden = false;
            var servacs = false;
            var nomedia = true;
            var noservacs = true;
            var todoCorrecto = true;
            var tempMax=0.0;
            var tempMin = 0.0;
            if (uso > 8) {
                uso2 = uso - 3;
            }
            for (var x = 0; x &lt; equipos.length; x++) {
                if (equipos[x][1] == "Calefacción Media") {
                    nomedia = false;
                }
                if (equipos[x][1] == "ACS") {
                    noservacs = false;
                }
                if (equipos[x][1] == "Caldera condensación") {
                    conden = true;
                }
            }
            if (uso == "15") {
                media = true;
            }
            if (uso == "16") {
                servacs = true;
            }
            for (var x = 0; x &lt; $scope.caso.length; x++) {
                if ($scope.caso[x].nombre == nombreCaso) {
                    edificio = $scope.caso[x].idedificio;
                }
            }
            /*Sacamos el valor del bus/es seleccionado y el valor de nuevo/existente dependiendo del origen de la llamada a la función
                realizando los ajustes a los colectores y a los nombres de los equipos que fueran necesarios*/
            if (tipo == "1") {
                busGE = $('input[name="idBusGenera"]:checked').val();
                busAE = "-";
                if (exismod == "0") {
                    busGT = "1";
                    busAT = "1";
                } else {
                    busGT = "0";
                    busAT = "0";
                }
                for (var x = 0; x &lt; equipos.length; x++) {
                    if (parseInt(equipos[x][0]) >= cont) {
                        cont = parseInt(equipos[x][0]) + 1;
                    }
                    if (equipos[x][1] == $scope.uso[uso2 - 1].nombre) {
                        alert('ERROR:No se pueden cargar dos servicios iguales');
                        todoCorrecto = false;
                    }
                }
                if (uso == "1" || uso == "2" || uso == "3" || uso == "4" || uso == "5" || uso == "7" || uso == "8" || uso == "11" || uso == "15" || uso == "16") {
                    if (/^[0-9]*$/.test(document.getElementById('tempMaxG').value) == false) {
                        alert('ERROR: El campo temperatura máxima con valores no numéricos');
                        todoCorrecto = false;
                    }

                    if (/^[-]?\d+$/.test(document.getElementById('tempMinG').value) == false) {
                        alert('ERROR: El campo temperatura mínima con valores no numéricos');
                        todoCorrecto = false;
                    }
                    if (parseFloat(document.getElementById('tempMaxG').value) &lt;= parseFloat(document.getElementById('tempMinG').value)) {
                        alert('ERROR: La temperatura mínima no puede ser menor ni igual que la máxima');
                        todoCorrecto = false;
                    }

                    if (uso == "1" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 120 || parseFloat(document.getElementById('tempMinG').value) &lt; 30)) {
                        alert('ERROR: La temperatura del servicio calor técnico debe ser mayor que 30 y menor que 120 ');
                        todoCorrecto = false;
                    }
                    if (uso == "2" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 120 || parseFloat(document.getElementById('tempMinG').value) &lt; 60)) {
                        alert('ERROR: La temperatura del servicio cal. alta debe ser mayor que 60 y menor que 120 ');
                        todoCorrecto = false;
                    }
                    if (uso == "15" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 100 || parseFloat(document.getElementById('tempMinG').value) &lt; 30)) {
                        alert('ERROR: La temperatura del servicio cal. media debe ser mayor que 30 y menor que 100 ');
                        todoCorrecto = false;
                    }
                    if (uso == "4" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 50 || parseFloat(document.getElementById('tempMinG').value) &lt; 30)) {
                        alert('ERROR: La temperatura del servicio condensación debe ser mayor que 30 y menor que 50 ');
                        todoCorrecto = false;
                    }

                    if (uso == "7" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 20 || parseFloat(document.getElementById('tempMinG').value) &lt; 0)) {
                        alert('ERROR: La temperatura del servicio frío climatización debe ser mayor que 0 y menor que 20 ');
                        todoCorrecto = false;
                    }
                    if (uso == "8" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 0 || parseFloat(document.getElementById('tempMinG').value) &lt; -30)) {
                        alert('ERROR: La temperatura del servicio frío subcero debe ser mayor que -30 y menor que 0 ');
                        todoCorrecto = false;
                    }
                    if (uso == "11" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 90 || parseFloat(document.getElementById('tempMinG').value) &lt; 30)) {
                        alert('ERROR: La temperatura del servicio ACS debe ser mayor que 30 y menor que 90 ');
                        todoCorrecto = false;
                    }
                    if (uso == "17" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 40 || parseFloat(document.getElementById('tempMinG').value) &lt; 25)) {
                        alert('ERROR: La temperatura del servicio autónomo calor debe ser mayor que 25 y menor que 40 ');
                        todoCorrecto = false;
                    }
                    if (uso == "18" &amp;&amp; (parseFloat(document.getElementById('tempMaxG').value) > 35 || parseFloat(document.getElementById('tempMinG').value) &lt; 15)) {
                        alert('ERROR: La temperatura del servicio autónomo frío debe ser mayor que 15 y menor que 35 ');
                        todoCorrecto = false;
                    }
                }
                if (uso == "1" || uso == "2" || uso == "3" || uso == "4" || uso == "5" || uso == "15") {
                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('porConC').value) == false) {
                        alert('ERROR: El campo consumo con valores no numéricos');
                        todoCorrecto = false;


                    }
                    if (parseFloat(document.getElementById('porConC').value) > 100.0 &amp;&amp; parseFloat(document.getElementById('porConC').value) &lt;= 0.0) {
                        alert('ERROR: El campo consumo debe ser mayor que 0 y menor que 100');
                        todoCorrecto = false;


                    }
                }
                if (uso == "7" || uso == "8" || uso == "5") {
                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('porConF').value) == false) {
                        alert('ERROR: El campo consumo con valores no numéricos');
                        todoCorrecto = false;


                    }
                    if (parseFloat(document.getElementById('porConF').value) > 100.0 &amp;&amp; parseFloat(document.getElementById('porConF').value) &lt;= 0.0) {
                        alert('ERROR: El campo consumo debe ser mayor que 0 y menor que 100');
                        todoCorrecto = false;


                    }
                }
                if (uso == "16" || uso == "5") {
                    if (/^[0-9]+([,.][0-9]+)?$/.test(document.getElementById('porConACS').value) == false) {
                        alert('ERROR: El campo consumo con valores no numéricos');
                        todoCorrecto = false;


                    }
                    if (parseFloat(document.getElementById('porConACS').value) > 100.0 &amp;&amp; parseFloat(document.getElementById('porConACS').value) &lt;= 0.0) {
                        alert('ERROR: El campo consumo debe ser mayor que 0 y menor que 100');
                        todoCorrecto = false;


                    }
                }
                busGE = parseInt(busGE);
                tipoServicio = $scope.uso[uso2 - 1].id;
                nombre = $scope.uso[uso2 - 1].nombre;
                tipoEquipo = $scope.uso[uso2 - 1].idtipouso;
                tipoEquipo = $scope.tipoUso[tipoEquipo - 1].nombre;
                definido = "no";
                busGE = parseInt(busGE);
                if (uso == "1" || uso == "2" || uso == "3" || uso == "4" || uso == "5" || uso == "17") {
                    conc = document.getElementById("porConC").value;
                }
                if (uso == "7" || uso == "8" || uso == "5" || uso == "18") {
                    conf = document.getElementById("porConF").value;
                }
                if (uso == "16" || uso == "5") {
                    conacs = document.getElementById("porConACS").value;
                }
                if (todoCorrecto == true) {
                    
                    
                    for (var x = 0; x &lt; colectores.length; x++) {
                        var colectorAux = colectores[x][0];
                        colectorAux = colectorAux.substring(1, colectorAux.length);
                        if (parseInt(colectorAux) >= numColector) {
                            numColector = parseInt(colectorAux) + 1;
                        }
                    }
                    if (uso == "9" || uso == "10" || uso == "11" || uso == "12" || uso == "13" || uso == "14") {
                        colector = ["C" + numColector, busGE, "0", "0", "0", "0", "0"];
                    } else {
                        colector = ["C" + numColector, busGE, document.getElementById("tempMaxG").value, document.getElementById("tempMinG").value, conc, conf, conacs];
                    }
                    colectores.push(colector);
                    busGE = numColector;
                    $('#myModalUso3').modal('hide');
                    document.getElementById("tempGU").innerHTML = "";
                }
            }
            else if (tipo == "2") {
                busAE = $scope.equipo[uso].busg;
                for (var x = 0; x &lt; $scope.bus.length; x++) {
                    if ($scope.bus[x].nombre == busAE) {
                        busAE = $scope.bus[x].id;
                    }
                }
                busGT = $scope.equipo[uso].nuex;
                if (busGT == "Nuevo") {
                    busGT = "0";
                } else {
                    busGT = "1";
                }
                busGE = numColector;
                busAT = $scope.equipo[uso].nuex;
                if (busAT == "Nuevo") {
                    busAT = "0";
                } else {
                    busAT = "1";
                }
                definido = $scope.equipo[uso].definido;
                nombre = $scope.equipo[uso].nombre;
                cont = $scope.equipo[uso].id;
                cont = cont - 1;
                for (var x = 0; x &lt; $scope.uso.length; x++) {
                    if ($scope.uso[x].nombre == nombre) {
                        tipoServicio = $scope.uso[x].id;
                        tipoEquipo = $scope.tipoUso[$scope.uso[x].idtipouso - 1].nombre;
                    }
                }
                for (var x = 0; x &lt; $scope.busesCaso.length; x++) {
                    if ($scope.equipo[uso].busa == $scope.busesCaso[x].nombre &amp;&amp; $scope.busesCaso[x].nuex == $scope.equipo[uso].nuex) {
                        colector = [$scope.busesCaso[x].nombre, $scope.busesCaso[x].idbus, $scope.busesCaso[x].tempmax, $scope.busesCaso[x].tempmin, $scope.busesCaso[x].consumoc, $scope.busesCaso[x].consumof, $scope.busesCaso[x].consumoacs];
                        colectores.push(colector);
                        numColector = $scope.busesCaso[x].nombre;
                        numColector = numColector.substring(1, numColector.length);
                        numColector = parseInt(numColector);
                    }
                }
            }
            else if (tipo == "3") {
                var guardado = false;
                var consC = "0.0";
                var consF = "0.0";
                var consACS = "0.0";
                switch (sistema) {
                    case 0:
                        nombre = $scope.uso[uso2 - 1].nombre;
                        idUso = $scope.uso[uso2 - 1].idtipouso;
                        tipoEquipo = $scope.tipoUso[idUso - 1].nombre;
                        for (var x = 0; x &lt; $scope.edificioUsoBusEx.length; x++) {
                            if ($scope.edificioUsoBusEx[x].iduso == uso &amp;&amp; edificio == $scope.edificioUsoBusEx[x].idedificio) {
                                busGE = $scope.edificioUsoBusEx[x].idbus;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                }
                            }
                        }
                        busAE = "-";
                        break;
                    case 1:
                        nombre2 = $scope.uso[uso2 - 1].nombre;
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            if ($scope.equipo[x].nombre == nombre2 &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                nombre = nombre2;
                                busGE = $scope.equipo[x].busg;
                                if (busGE == "10" || busGE == "6") {
                                    busGE = "-";
                                } else {
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == busGE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                            busGE = $scope.busesCaso[y].idbus;
                                        }
                                    }
                                }
                                busAE = $scope.equipo[x].busa;
                                if (busAE == "10" || busAE == "6") {
                                    busAE = "-";
                                } else {
                                    for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                        if ($scope.busesCaso[y].nombre == busAE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                            busAE = $scope.busesCaso[y].idbus;
                                        }
                                    }
                                }
                            }
                        }
                        busGE = busAE;
                        busAE = "-";
                        break;
                    case 2:
                        nombre = $scope.uso[uso2 - 1].nombre;
                        idUso = $scope.uso[uso2 - 1].idtipouso;
                        tipoEquipo = $scope.tipoUso[idUso - 1].nombre;
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                break loop3;

                            }
                        }
                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }
                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                if ($scope.equipo[x].busa == $scope.busesCaso[y].nombre &amp;&amp; $scope.busesCaso[y].nuex == $scope.equipo[x].nuex) {
                                    $scope.busesCaso[y].consumoc;
                                    consC = $scope.busesCaso[y].consumoc;
                                    consF = $scope.busesCaso[y].consumof;
                                    consACS = $scope.busesCaso[y].consumoacs;
                                    tempMax = $scope.busesCaso[y].tempmax;
                                    tempMin = $scope.busesCaso[y].tempmin;
                                }
                            }
                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busa;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busGE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busGE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busAE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busAE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGE = busAE;
                            busAE = "-";
                        }

                        else {
                            if (uso == "15") {
                                busGE = "3";
                            }
                            else if (uso == "16") {
                                busGE = "11";
                            } else {
                                for (var x = 0; x &lt; $scope.edificioUsoBusNuip1.length; x++) {
                                    if ($scope.edificioUsoBusNuip1[x].iduso == uso &amp;&amp; edificio == $scope.edificioUsoBusNuip1[x].idedificio) {
                                        busGE = $scope.edificioUsoBusNuip1[x].idbus;
                                        if (busGE == "10" || busGE == "6") {
                                            busGE = "-";
                                        }
                                    }
                                }
                            }
                        }

                        break;
                    case 3:
                        nombre = $scope.uso[uso2 - 1].nombre;
                        idUso = $scope.uso[uso2 - 1].idtipouso;
                        tipoEquipo = $scope.tipoUso[idUso - 1].nombre;
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                break loop3;

                            }
                        }
                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }
                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                if ($scope.equipo[x].busa == $scope.busesCaso[y].nombre &amp;&amp; $scope.busesCaso[y].nuex == $scope.equipo[x].nuex) {
                                    $scope.busesCaso[y].consumoc;
                                    consC = $scope.busesCaso[y].consumoc;
                                    consF = $scope.busesCaso[y].consumof;
                                    consACS = $scope.busesCaso[y].consumoacs;
                                    tempMax = $scope.busesCaso[y].tempmax;
                                    tempMin = $scope.busesCaso[y].tempmin;
                                }
                            }
                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busa;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busGE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busGE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busAE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busAE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGE = busAE;
                            busAE = "-";
                        } else {
                            if (uso == "15") {
                                busGE = "3";
                            }
                            else if (uso == "16") {
                                busGE = "11";
                            } else {
                                for (var x = 0; x &lt; $scope.edificioUsoBusNuip2.length; x++) {
                                    if ($scope.edificioUsoBusNuip2[x].iduso == uso &amp;&amp; edificio == $scope.edificioUsoBusNuip2[x].idedificio) {
                                        busGE = $scope.edificioUsoBusNuip2[x].idbus;
                                        if (busGE == "10" || busGE == "6") {
                                            busGE = "-";
                                        }
                                        busAE = $scope.edificioUsoBusNuip2[x].idbus;
                                        if (busAE == "10" || busAE == "6") {
                                            busAE = "-";
                                        }
                                    }
                                }
                            }

                        }

                        break;
                    case 4:
                        nombre = $scope.uso[uso2 - 1].nombre;
                        idUso = $scope.uso[uso2 - 1].idtipouso;
                        tipoEquipo = $scope.tipoUso[idUso - 1].nombre;
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                break loop3;

                            }
                        }
                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }
                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                if ($scope.equipo[x].busa == $scope.busesCaso[y].nombre &amp;&amp; $scope.busesCaso[y].nuex == $scope.equipo[x].nuex) {
                                    $scope.busesCaso[y].consumoc;
                                    consC = $scope.busesCaso[y].consumoc;
                                    consF = $scope.busesCaso[y].consumof;
                                    consACS = $scope.busesCaso[y].consumoacs;
                                    tempMax = $scope.busesCaso[y].tempmax;
                                    tempMin = $scope.busesCaso[y].tempmin;
                                }
                            }
                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busa;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busGE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busGE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busAE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busAE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGE = busAE;
                            busAE = "-";
                        } else {
                            if (uso == "15") {
                                busGE = "3";
                            }
                            else if (uso == "16") {
                                busGE = "11";
                            } else {
                                for (var x = 0; x &lt; $scope.edificioUsoBusNuip3a.length; x++) {
                                    if ($scope.edificioUsoBusNuip3a[x].iduso == uso &amp;&amp; edificio == $scope.edificioUsoBusNuip3a[x].idedificio) {
                                        busGE = $scope.edificioUsoBusNuip3a[x].idbus;
                                        if (busGE == "10" || busGE == "6") {
                                            busGE = "-";
                                        }
                                    }
                                }
                            }
                            if (uso == "12" || uso == "13" || uso == "14") {
                                busGE = "9";
                                nombre = "Red Eléctrica";
                            }

                        }

                        break;
                    case 5:
                        nombre = $scope.uso[uso2 - 1].nombre;
                        idUso = $scope.uso[uso2 - 1].idtipouso;
                        tipoEquipo = $scope.tipoUso[idUso - 1].nombre;
                        loop3:
                        for (var x = 0; x &lt; $scope.equipo.length; x++) {
                            guardado = false;
                            if ($scope.equipo[x].nombre == nombre &amp;&amp; $scope.equipo[x].nuex == "Existente") {
                                guardado = true;
                                break loop3;

                            }
                        }
                        if (guardado == true) {
                            for (var y = 0; y &lt; $scope.equipo.length; y++) {
                                if ($scope.equipo[x].busg == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colG = $scope.equipo[y].nombre;
                                }
                                if ($scope.equipo[x].busa == $scope.equipo[y].busa &amp;&amp; $scope.equipo[y].tipo == "2") {
                                    colA = $scope.equipo[y].nombre;
                                }
                            }
                            for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                if ($scope.equipo[x].busa == $scope.busesCaso[y].nombre &amp;&amp; $scope.busesCaso[y].nuex == $scope.equipo[x].nuex) {
                                    $scope.busesCaso[y].consumoc;
                                    consC = $scope.busesCaso[y].consumoc;
                                    consF = $scope.busesCaso[y].consumof;
                                    consACS = $scope.busesCaso[y].consumoacs;
                                    tempMax = $scope.busesCaso[y].tempmax;
                                    tempMin = $scope.busesCaso[y].tempmin;
                                }
                            }
                            numEquipos = $scope.equipo[x].numequiposiguales;
                            busGE = $scope.equipo[x].busa;
                            if (busGE == "10" || busGE == "6") {
                                busGE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busGE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busGE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGT = "1";
                            busAT = "1";
                            equipoEx = x;

                            busAE = $scope.equipo[x].busa;
                            if (busAE == "10" || busAE == "6") {
                                busAE = "-";
                            } else {
                                for (var y = 0; y &lt; $scope.busesCaso.length; y++) {
                                    if ($scope.busesCaso[y].nombre == busAE &amp;&amp; $scope.busesCaso[y].nuex == "Existente") {
                                        busAE = $scope.busesCaso[y].idbus;
                                    }
                                }
                            }
                            busGE = busAE;
                            busAE = "-";
                        } else {
                            if (uso == "15") {
                                busGE = "3";
                            }
                            else if (uso == "16") {
                                busGE = "11";
                            } else {
                                for (var x = 0; x &lt; $scope.edificioUsoBusNuip3b.length; x++) {
                                    if ($scope.edificioUsoBusNuip3b[x].iduso == uso &amp;&amp; edificio == $scope.edificioUsoBusNuip3b[x].idedificio) {
                                        busGE = $scope.edificioUsoBusNuip3b[x].idbus;
                                        if (busGE == "10" || busGE == "6") {
                                            busGE = "-";
                                        }
                                    }
                                }
                            }
                            if (uso == "12" || uso == "13" || uso == "14") {
                                busGE = "9";
                                nombre = "Red Eléctrica";
                            }
                        }

                        break;
                }
                if (exismod == 1) {
                    busGT = "0";
                    busAT = "0";
                } else {
                    busGT = "1";
                    busAT = "1";
                }
                definido = "no";
                busGE = parseInt(busGE);
                if (busGE != "9") {
                    var busT = busGE;
                    if (busGE == "14") {
                        var busT = "12";
                    }
                    if (busGE == "15") {
                        var busT = "13";
                    }
                    if (uso == "16") {
                        colector = ["C" + numColector, busGE, $scope.bus[busT - 1].tmax, $scope.bus[busT - 1].tmin, "0.0", "0.0", "100.0"];
                    }
                    else if (uso == "7" || uso == "8" || uso == "18") {
                        colector = ["C" + numColector, busGE, $scope.bus[busT - 1].tmax, $scope.bus[busT - 1].tmin, "0.0", "100.0", "0.0"];
                    }
                    else if (uso == "1" || uso == "2" || uso == "3" || uso == "4" || uso == "15" || uso == "17") {
                        colector = ["C" + numColector, busGE, $scope.bus[busT - 1].tmax, $scope.bus[busT - 1].tmin, "100.0", "0.0", "0.0"];
                    }
                    else if (uso == "5") {
                        colector = ["C" + numColector, busGE, $scope.bus[busT - 1].tmax, $scope.bus[busT - 1].tmin, "100.0", "100.0", "100.0"];
                    }


                }
                else {
                    colector = ["C" + numColector, busGE, "0.0", "0.0", "0.0", "0.0", "0.0"];
                }
                if (guardado == true) {
                    colector = ["C" + numColector, busGE, tempMax, tempMin, consC, consF, consACS];
                }
                colectores.push(colector);
                if ((media == true || servacs == true) &amp;&amp; conden == true &amp;&amp; nomedia == false &amp;&amp; noservacs == false) {
                    for (var x = 0; x &lt; colectores.length; x++) {
                        if (colectores[x][1] == "3") {
                            colectores[x][2] = "" + (parseInt(colectores[x][2]) + 5);
                            colectores[x][3] = "" + (parseInt(colectores[x][3]) + 5);
                        }
                    }
                }
                busGE = numColector;
            }

            //Si solo tiene bus genera
            if (busGE > 0 &amp;&amp; (typeof busAE === "undefined" || busAE == "-") &amp;&amp; todoCorrecto == true) {
                var colectorG;
                var colector;
                var busCG = 0;
                var numBusGE = 0;

                //Si el contador de servicios es 0
                //Almacenamos el número de la línea y flecha
                numFlechas.push(cont);
                numLineas.push(cont);
                numFlechasInversa.push(cont);
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "' >\n";
                add += "&lt;td class='servicios' style='width:120px'>&lt;/td>\n";
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                for (var x = 1; x &lt; colectores.length + 1; x++) {
                    if (parseInt(colectores[x - 1][1]) == busGE &amp;&amp; (x - 1) &lt; numColector) {
                        numBusGE++;
                    }
                    var busC = colectores[x - 1][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x - 1][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busC == numColector) {

                        busCG = busC;
                        colectorG = colectores[x - 1][1];
                        if (colectorG == "11") {
                            colectorG = "3";
                        }
                        if (colectorG == "14") {
                            colectorG = "4";
                        }
                        if (colectorG == "15") {
                            colectorG = "6";
                        }
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x - 1][0] + "-" + cont + "' style='visibility:visible'>&lt;/td>\n";
                    } else {
                        add += "&lt;td class='bus" + colector + "' id='" + colectores[x - 1][0] + "-" + cont + "'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add += "&lt;td class='espacio" + colector + "' id='" + colectores[x - 1][0] + "-" + cont + "e' style='width:13.375px;'>&lt;/td>\n";
                    }
                }
               
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicasUso(2,0," + busGE + ",0," + cont + "," + numColector + ")'>" + nombre + "&lt;/button>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "'>\n";
                add2 += "&lt;td class='servicios' style='height:15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='height:15px'>&lt;/td>\n";
                for (var x = 1; x &lt; colectores.length + 1; x++) {
                    var busC = colectores[x - 1][0];
                    busC = busC.substring(1, busC.length);
                    busC = parseInt(busC);
                    colector = colectores[x - 1][1];
                    if (colector == "11") {
                        colector = "3";
                    }
                    if (colector == "14") {
                        colector = "4";
                    }
                    if (colector == "15") {
                        colector = "6";
                    }
                    if (busC == numColector) {
                        colectorG = colectores[x - 1][1];
                        if (colectorG == "11") {
                            colectorG = "3";
                        }
                        if (colectorG == "14") {
                            colectorG = "4";
                        }
                        if (colectorG == "15") {
                            colectorG = "6";
                        }

                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x - 1][0] + "-" + cont + "s'style='height:15px;visibility:visible'>&lt;/td>\n";
                    } else {
                        add2 += "&lt;td class='bus" + colector + "' id='" + colectores[x - 1][0] + "-" + cont + "s'style='height:15px;'>&lt;/td>\n";
                    }
                    if (x != (colectores.length + 1)) {
                        add2 += "&lt;td class='espacio" + colector + "' id='" + colectores[x - 1][0] + "-" + cont + "se'style='height:15px;width:13.375px'>&lt;/td>\n";
                    }
                }
                add2 += "&lt;td class='espacio9U' style='height:15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='height:15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                if (busGE == "14") {
                    colectorG = "4";
                }
                if (busGE == "15") {
                    colectorG = "6";
                }

                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                lineasCreadas[cont - 1] = true;
                //Ponemos a true el radio del bus correspondiente
                if (equipos.length > 0) {
                    for (var x = 0; x &lt; equipos.length; x++) {
                        var busC = equipos[x][0];
                        row = document.getElementById('trSer' + busC);
                        y = row.insertCell(document.getElementById("trSer" + busC).cells.length - 2);
                        y.className = "bus" + colectorG;
                        y.id = "C" + numColector + "-" + busC;
                        y = row.insertCell(document.getElementById("trSer" + busC).cells.length - 2);
                        y.className = "espacio" + colectorG;
                        y.id = "C" + numColector + "-" + busC + "e";
                        row = document.getElementById('trSerEspacio' + busC);
                        y = row.insertCell(document.getElementById("trSerEspacio" + busC).cells.length - 2);
                        y.className = "bus" + colectorG;
                        y.id = "C" + numColector + "-" + busC + "s";
                        y = row.insertCell(document.getElementById("trSerEspacio" + busC).cells.length - 2);
                        y.className = "espacio" + colectorG;
                        y.id = "C" + numColector + "-" + busC + "se";
                    }
                }
                if (equipos.length > 0) {


                    for (var x = 0; x &lt; equipos.length; x++) {
                        var busModG = 0;
                        var busModA = 0;
                        var numeroC = equipos[x][2];
                        if (numeroC != "-") {
                            for (var y = 0; y &lt; colectores.length > 0; y++) {
                                if (numeroC == colectores[y][0]) {
                                    numeroC = colectores[y][1];
                                }
                            }
                        }
                        var numeroC1 = equipos[x][3];
                        if (numeroC1 != "-") {
                            for (var y = 0; y &lt; colectores.length > 0; y++) {
                                if (numeroC1 == colectores[y][0]) {
                                    numeroC1 = colectores[y][1];
                                }
                            }
                        }
                        for (var y = 1; y &lt; colectores.length + 1; y++) {
                            if (parseInt(colectores[y - 1][1]) == numeroC &amp;&amp; (y - 1) &lt; numColector) {
                                busModG++;
                            }
                            if (parseInt(colectores[y - 1][1]) == numeroC1 &amp;&amp; (y - 1) &lt; numColector) {
                                busModA++;
                            }
                        }
                        if (equipos[x][6] == "3" || equipos[x][6] == "1" || equipos[x][6] == "4") {
                            if (numeroC != "-") {
                                left = document.getElementById(equipos[x][2] + "-" + equipos[x][0]);
                                altura = document.getElementsByClassName("btnSerUso")[x];
                                izq = $(left).position().left;
                                long = $(left).width();
                                topB = $(altura).position().top;
                                leftB = $(altura).position().left;
                                topLineas = topB + (alt / 2) + 70;
                                topFlecha = topB + (alt / 2) + 57;
                                leftLineas = long + distancia;
                                widthLineas = izq - (leftB + 120);
                                //widthLineas = izq - (leftB + long) + 5;
                                topLineas = topB + (alt / 2) + 70;
                                leftFlecha = long + distancia - 10;
                                document.getElementById("lineaSer" + equipos[x][0]).style.width = widthLineas + "px";
                                document.getElementById("flechaSer" + equipos[x][0]).style.left = (izq + distancia - 28) + "px";
                                document.getElementById("flechaSerInversa" + equipos[x][0]).style.top = topFlecha + "px";
                                document.getElementById("lineaSer" + equipos[x][0]).style.top = topLineas + "px";
                                document.getElementById("flechaSer" + equipos[x][0]).style.top = topFlecha + "px";
                            }
                            if (numeroC1 != "-" &amp;&amp; equipos[x][2] != equipos[x][3]) {
                                left = document.getElementById(equipos[x][3] + "-" + equipos[x][0]);
                                altura = document.getElementsByClassName("btnSerUso")[x];
                                izq = $(left).position().left;
                                long = $(left).width();
                                topB = $(altura).position().top;
                                leftB = $(altura).position().left;
                                leftLineasInversa = long + distancia;
                                widthLineasInversa = izq - (leftB + 120);
                                topLineasInversa = topB + (alt / 2) + 90;
                                leftFlechaInversa = long + distancia - 10;
                                topFlechaInversa = topB + (alt / 2) + 77;
                                document.getElementById("lineaSerInversa" + equipos[x][0]).style.width = (widthLineasInversa) + "px";
                                document.getElementById("flechaSer" + equipos[x][0] + "A").style.left = (izq + distancia - 28) + "px";
                                document.getElementById("flechaSerInversa" + equipos[x][0] + "A").style.top = topFlechaInversa + "px";
                                document.getElementById("lineaSerInversa" + equipos[x][0]).style.top = topLineasInversa + "px";
                                document.getElementById("flechaSer" + equipos[x][0] + "A").style.top = topFlechaInversa + "px";
                            }
                        } else {
                            left = document.getElementById(equipos[x][3] + "-" + equipos[x][0]);
                            altura = document.getElementsByClassName("btnSerUso")[x];
                            izq = $(left).position().left;
                            long = $(left).width();
                            topB = $(altura).position().top;
                            leftB = $(altura).position().left;
                            topLineas = topB + (alt / 2) + 80;
                            topFlecha = topB + (alt / 2) + 67;
                            widthLineas = leftB - izq - 10;
                            leftLineas = izq + long + distancia;
                            leftFlecha = leftB - 25 + distancia;
                            document.getElementById("flechaSerInversa" + equipos[x][0]).style.left = (leftLineas - 8) + "px";
                            document.getElementById("lineaSer" + equipos[x][0]).style.left = leftLineas + "px";
                            document.getElementById("lineaSer" + equipos[x][0]).style.width = (widthLineas) + "px";
                            document.getElementById("flechaSer" + equipos[x][0]).style.left = leftFlecha + "px";
                            document.getElementById("flechaSerInversa" + equipos[x][0]).style.top = topFlecha + "px";
                            document.getElementById("lineaSer" + equipos[x][0]).style.top = topLineas + "px";
                            document.getElementById("flechaSer" + equipos[x][0]).style.top = topFlecha + "px";
                        }
                    }
                }
                //sacamos los valores para calcular la posición de la flecha y la línea
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementById("C" + busCG + "-" + cont);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(left).width();
                //creamos la línea
                leftLineas = izq + long + distancia + 2;
                widthLineas = leftB - izq - 20;
                topLineas = topB + (alt / 2) + 80;
                leftFlecha = leftB - 25 + distancia;
                topFlecha = topB + (alt / 2) + 67;
                var linea = "&lt;section class='connectingLines" + colectorG + "' id='lineaSer" + cont + "' style='left:" + leftLineas + "px; top:" + topLineas + "px; width:" + widthLineas + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //Creamos la flecha
                var flecha2 = "&lt;img class='flecha" + colectorG + "' src='flechaInversa" + colectorG + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 8) + "px; top:" + topFlecha + "px;'>";
                var flecha = "&lt;img class='flecha" + colectorG + "' src='flecha" + colectorG + ".png'   id='flechaSer" + cont + "'style='left:" + leftFlecha + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que sea nuevo o existente
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        equipo = [cont, nombre, "-", "C" + numColector, "Nuevo", "no", "2", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid green";
                    } else {
                        equipo = [cont, nombre, "-", "C" + numColector, "Existente", "no", "2", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busGT == "0") {
                        equipo = [cont, nombre, "C" + numColector, "-", "Nuevo", "si", "2", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    } else {
                        equipo = [cont, nombre, "C" + numColector, "-", "Existente", "si", "2", tipoEquipo, 0, 0, 1];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado
                
                cont++;
                numColector++;
                dibujarBuses(0, busCG, 0, colectorG, equipos.length);
            }
            //Si solo tiene bus alimenta
            if (busAE > 0 &amp;&amp; (typeof cont === "undefined" || cont == "-") &amp;&amp; todoCorrecto == true) {
                //Si el contador de servicios es 0
                //Almacenamos el número de la línea y flecha
                numFlechasInversa.push(cont);
                numLineasInversa.push(cont);
                numFlechas.push(cont);
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                add += "&lt;td class='servicios'> &lt;/td>\n";
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                add += "&lt;td class='bus1'>&lt;/td>\n";
                add += "&lt;td class='espacio12'>&lt;/td>\n";
                add += "&lt;td class='bus2'>&lt;/td>\n";
                add += "&lt;td class='espacio23'>&lt;/td>\n";
                add += "&lt;td class='bus3'>&lt;/td>\n";
                add += "&lt;td class='espacio34'>&lt;/td>\n";
                add += "&lt;td class='bus4'>&lt;/td>\n";
                add += "&lt;td class='espacio45'>&lt;/td>\n";
                add += "&lt;td class='bus5'>&lt;/td>\n";
                add += "&lt;td class='espacio56'>&lt;/td>\n";
                add += "&lt;td class='bus6'>&lt;/td>\n";
                add += "&lt;td class='espacio67'>&lt;/td>\n";
                add += "&lt;td class='bus7'>&lt;/td>\n";
                add += "&lt;td class='espacio78'>&lt;/td>\n";
                add += "&lt;td class='bus8'>&lt;/td>\n";
                add += "&lt;td class='espacio89'>&lt;/td>\n";
                add += "&lt;td class='bus9'>&lt;/td>\n";
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicas(2,1,0," + busAE + "," + cont + ")' data-toggle='modal' data-target='#myModalFormularioUso'>" + nombre + "&lt;/button>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 += "&lt;td class='servicios' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus1' style='height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio12' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus2' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio23' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus3' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio34' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus4' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio45' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus5' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio56' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus6' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio67' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus7' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio78' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus8' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio89' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus9' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                //Ponemos a true el radio del bus correspondiente
                lineasCreadas[busAE - 1] = true;
                //sacamos los valores para calcular la posición de la flecha y la línea
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementsByClassName("bus" + busAE);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(altura).width();
                //creamos la línea
                leftLineas = izq + long + distancia;
                widthLineas = leftB - izq - 20;
                topLineas = topB + (alt / 2) + 100;
                leftFlecha = leftB - 30 + distancia;
                topFlecha = topB + (alt / 2) + 87;
                var linea = "&lt;section class='connectingLines" + busAE + "' id='lineaSerInversa" + cont + "' style='left:" + leftLineasInversa + "px; top:" + topLineasInversa + "px; width:" + widthLineasInversa + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //creamos la flecha
                var flecha2 = "&lt;img class='flecha" + busAE + "' src='flechaInversa" + busAE + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 10) + "px; top:" + topFlecha + "px;'>";
                var flecha = "&lt;img class='flecha" + busAE + "' src='flecha" + busAE + ".png'   id='flechaSer" + cont + "'style='left:" + leftFlecha + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que sea nuevo o existente
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        equipo = [cont, nombre, "-", $scope.bus[busAE - 1].nombre, "Nuevo", "no", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid green";
                    } else {
                        equipo = [cont, nombre, "-", $scope.bus[busAE - 1].nombre, "Existente", "no", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        equipo = [cont, nombre, $scope.bus[busAE - 1].nombre, "-", "Nuevo", "si", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    } else {
                        equipo = [cont, nombre, $scope.bus[busAE - 1].nombre, "-", "Existente", "si", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado
                
                cont++;
                dibujarBuses(0, parseInt(busAE), equipos.length);
            }
            //Si tiene ambos
            if (busAE > 0 &amp;&amp; cont > 0 &amp;&amp; todoCorrecto == true) {
                //Almacenamos el número de la línea y flecha
                numFlechasInversa.push(cont);
                if (busGE != busAE) {
                    numFlechas.push(cont * 2);
                    numFlechasInversa.push(cont * 2);
                    numLineasInversa.push(cont);
                }
                numLineas.push(cont);
                numFlechas.push(cont);
                //Creamos la fila del botón con su número correspondiente
                add = "&lt;tr id='trSer" + cont + "'>\n";
                add += "&lt;td class='servicios'> &lt;/td>\n";
                add += "&lt;td class='espacioS1'>&lt;/td>\n";
                add += "&lt;td class='bus1'>&lt;/td>\n";
                add += "&lt;td class='espacio12'>&lt;/td>\n";
                add += "&lt;td class='bus2'>&lt;/td>\n";
                add += "&lt;td class='espacio23'>&lt;/td>\n";
                add += "&lt;td class='bus3'>&lt;/td>\n";
                add += "&lt;td class='espacio34'>&lt;/td>\n";
                add += "&lt;td class='bus4'>&lt;/td>\n";
                add += "&lt;td class='espacio45'>&lt;/td>\n";
                add += "&lt;td class='bus5'>&lt;/td>\n";
                add += "&lt;td class='espacio56'>&lt;/td>\n";
                add += "&lt;td class='bus6'>&lt;/td>\n";
                add += "&lt;td class='espacio67'>&lt;/td>\n";
                add += "&lt;td class='bus7'>&lt;/td>\n";
                add += "&lt;td class='espacio78'>&lt;/td>\n";
                add += "&lt;td class='bus8'>&lt;/td>\n";
                add += "&lt;td class='espacio89'>&lt;/td>\n";
                add += "&lt;td class='bus9'>&lt;/td>\n";
                add += "&lt;td class='espacio9U'>&lt;/td>\n";
                add += "&lt;td class='Usos'>&lt;button class='btnSerUso' id='" + cont + "' onclick='updateCaracteristicas(2,2," + busGE + "," + busAE + "," + cont + "," + numColector + ")' data-toggle='modal' data-target='#myModalFormularioUso'>" + nombre + "&lt;/button>&lt;/td>\n";
                add += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add;
                //Creamos el espacio entre las filas de los botones
                add2 = "&lt;tr id='trSerEspacio" + cont + "' style='max-height: 15px'>\n";
                add2 += "&lt;td class='servicios' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacioS1' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus1' style='height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio12' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus2' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio23' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus3' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio34' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus4' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio45' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus5' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio56' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus6' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio67' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus7' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio78' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus8' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio89' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='bus9' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='espacio9U' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;td class='UsosEspacio' style='max-height: 15px'>&lt;/td>\n";
                add2 += "&lt;/tr>\n";
                document.getElementById("esquema").innerHTML = document.getElementById("esquema").innerHTML + add2;
                //Ponemos a true el número de buses generado y las líneas generadas
                busesGenerados = new Array(true, true, true, true, true, true, true, true, true);
                //Ponemos a true el radio del bus correspondiente
                lineasCreadas[busAE - 1] = true;
                lineasCreadas[busGE - 1] = true;
                //sacamos los valores para calcular la posición de la flecha y la línea alimenta
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                left = document.getElementsByClassName("bus" + busGE);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(altura).width();
                //creamos la línea alimenta
                leftLineas = izq + distancia + 5;
                widthLineas = leftB - izq - 4;
                topLineas = topB + (alt / 2) + 70;
                leftFlecha = leftB - 32 + distancia;
                topFlecha = topB + (alt / 2) + 57;
                var linea = "&lt;section class='connectingLines" + busGE + "' id='lineaSer" + cont + "' style='left:" + leftLineas + "px; top:" + topLineas + "px; width:" + widthLineas + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                //creamos la flecha alimenta
                var flecha2 = "&lt;img class='flecha" + busGE + "' src='flechaInversa" + busGE + ".png'   id='flechaSerInversa" + cont + "'style='left:" + (leftLineas - 10) + "px; top:" + topFlecha + "px;'>";
                var flecha = "&lt;img class='flecha" + busGE + "' src='flecha" + busGE + ".png'   id='flechaSer" + cont + "'style='left:" + leftFlecha + "px; top:" + topFlecha + "px;'>";
                //Almacenamos en equipos el equipo creado y comprobamos que sea nuevo o existente
                if (definido == "no") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        equipo = [cont, nombre, $scope.bus[busGE - 1].nombre, "-", "Nuevo", "no", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid green";
                    } else {
                        equipo = [cont, nombre, $scope.bus[busGE - 1].nombre, "-", "Existente", "no", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "thick solid red";
                    }
                } else if (definido == "si") {
                    //comprobamos que sea nuevo o existente
                    if (busAT == "0") {
                        equipo = [cont, nombre, $scope.bus[busGE - 1].nombre, "-", "Nuevo", "si", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    } else {
                        equipo = [cont, nombre, $scope.bus[busGE - 1].nombre, "-", "Existente", "si", "2", tipoEquipo, 0, 0];
                        equipos.push(equipo);
                        document.getElementById(cont).style.border = "solid 1px black";
                    }
                }
                nombreEquipo.push(0);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                caracteristicas.push(caracteristica);
                caracteristica = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                valoresServiciosComplementos.push(valoresServicio);
                valoresServicio = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                //sacamos los valores para calcular la posición de la flecha y la línea genera
                altura = document.getElementsByClassName("btnSerUso")[document.getElementsByClassName("btnSerUso").length - 1];
                console.log(busAE);
                left = document.getElementsByClassName("bus" + busAE);
                izq = $(left).position().left;
                topB = $(altura).position().top;
                alt = $(altura).height();
                leftB = $(altura).position().left;
                long = $(altura).width();
                //creamos la línea genera
                leftLineasInversa = izq + distancia + 5;
                widthLineasInversa = leftB - izq - 4;
                topLineasInversa = topB + (alt / 2) + 90;
                leftFlechaInversa = leftB - 30 + distancia;
                topFlechaInversa = topB + (alt / 2) + 77;
                if (busGE != busAE) {
                    var linea = "&lt;section class='connectingLines" + busAE + "' id='lineaSerInversa" + cont + "' style='left:" + leftLineasInversa + "px; top:" + topLineasInversa + "px; width:" + widthLineasInversa + "px; -webkit-transform:rotate(" + + "deg); transform:rotate(" + 0 + "deg);'>&lt;/section > ";
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + linea;
                    //creamos la flecha genera
                    var flecha = "&lt;img class='flecha" + busAE + "' src='flecha" + busAE + ".png'   id='flechaSer" + (cont * 2) + "'style='left:" + (leftLineasInversa + widthLineasInversa - 30) + "px; top:" + topFlechaInversa + "px;'>";
                    var flecha2 = "&lt;img class='flecha" + busAE + "' src='flechaInversa" + busAE + ".png'   id='flechaSerInversa" + (cont * 2) + "'style='left:" + (leftFlechaInversa) + "px; top:" + topFlechaInversa + "px;'>";
                    //Almacenamos en equipos el equipo creado y comprobamos que sea nuevo o existente
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha;
                    document.getElementById("lineas").innerHTML = document.getElementById("lineas").innerHTML + flecha2;
                }
                //Caragamos la función buses y hacemos visible los buses anteriores al servicio creado de alimenta
                
                cont++;
                dibujarBuses(parseInt(busGE), parseInt(busAE), equipos.length);
            } if (uso == 17 &amp;&amp; tipo == 1 &amp;&amp; todoCorrecto == true) {
                updateTable(6, "3", "4");
            }
            if (uso == 18 &amp;&amp; tipo == 1 &amp;&amp; todoCorrecto == true) {
                updateTable(7, "3", "4");
            }
            
            $('#my').modal('hide');
        }
        /**

            *Almacenamos la batería inversor
            * @return  {void}

            */
        guardarbateriainversor = function () {
            $scope.guardadobateriainversor = {};
            $scope.guardadobateriainversor.select = [];
            $scope.guardadobateriainversor.selecttext = [];
            $scope.guardadobateriainversor.input = [];
            for (var contselect = 0; contselect &lt; $('#columndivcampo select').length; contselect++) {
                var selectactual = $('#columndivcampo select')[contselect];
                if (selectactual.value == 0) {
                    alert('ERROR: Hay algún campo sin seleccionar');
                    return false;
                }
                $scope.guardadobateriainversor.select[contselect] = selectactual.value;
                $scope.guardadobateriainversor.selecttext[contselect] = selectactual.selectedOptions[0].textContent;
            }
            for (var continput = 0; continput &lt; $('#columndivcampo input').length; continput++) {
                var inputactual = $('#columndivcampo input')[continput];
                if (inputactual.value == '') {
                    alert('ERROR: Hay algún campo vacío');
                    return false;
                }
                $scope.guardadobateriainversor.input[continput] = inputactual.value;
            }
            $('#myModalCaracteristicas').modal('hide');
        }
        /**

            *Cargamos los datos de la batería inversor
            * @return  {void}

            */
        cargarbateriainversor = function (equipoguardado) {
            var event = new Event("change", { bubbles: true });
            if (equipoguardado != undefined) {
                for (var contvalores = 0; contvalores &lt; $('#columndivcampo select').length + $('#columndivcampo input').length; contvalores++)
                    $.each(equipoguardado, function (index, value) {
                        if (index == 'atr' + (contvalores + 1) + '') {
                            if (contvalores &lt; 3) {
                                $('#columndivcampo select')[contvalores].value = value;
                                $('#columndivcampo select')[contvalores].disabled = false;
                                $('#columndivcampo select')[contvalores].style.backgroundColor = 'white';
                                $('#columndivcampo select')[contvalores].dispatchEvent(event);
                            }
                            else {
                                $('#columndivcampo input')[contvalores - 3].value = value;
                                $('#columndivcampo input')[contvalores - 3].disabled = false;
                            }
                        }
                    });
            }
            if ($scope.guardadobateriainversor != undefined &amp;&amp; $scope.guardadobateriainversor.select != undefined &amp;&amp; $scope.guardadobateriainversor.input != undefined) {
                for (var contselect = 0; contselect &lt; $('#columndivcampo select').length; contselect++) {
                    var selectactual = $('#columndivcampo select')[contselect];
                    selectactual.value = $scope.guardadobateriainversor.select[contselect];
                    selectactual.disabled = false;
                    selectactual.style.backgroundColor = "white";
                    selectactual.dispatchEvent(event);

                }
                for (var continput = 0; continput &lt; $('#columndivcampo input').length; continput++) {
                    var inputactual = $('#columndivcampo input')[continput];
                    inputactual.value = $scope.guardadobateriainversor.input[continput];
                    inputactual.disabled = false;
                }
            }
            else
                return;
        }
        /**

            *Actualizamos los valores de la batería inversor
            * @return  {void}

            */
        updatebateriainversor = async function (header, cont, clase, equipoguardado, tipo, tipo2, gen, ali) {
            document.getElementById('caracteristicas').innerHTML = '';
            //FUNCIONES
            function CamposBateriaInversor(camposselector, camposinversor, camposbateria) {
                this.camposselector = camposselector;
                this.camposinversor = camposinversor;
                this.camposbateria = camposbateria;
            }
            function ValoresBateriaInversor(valoresselector, valoresinversor, valoresbateria) {
                this.valoresselector = valoresselector;
                this.valoresinversor = valoresinversor;
                this.valoresbateria = valoresbateria;
            }
            function nextselect(nexttarget) {

                while (nexttarget) {
                    if (nexttarget.matches('select'))
                        break;
                    if (!nexttarget.matches('select')) {
                        nexttarget = nexttarget.nextElementSibling;
                        continue;
                    }
                }
                return nexttarget;
            }
            function selactivate() {
                var oEvento = event || window.event;
                var target = oEvento.target;
                if (target == $('#columndivcampo select')[$('#columndivcampo select').length - 1])
                    filtroinput();
                var nexttarget = target.nextElementSibling;
                nexttarget = nextselect(nexttarget);
                if (nexttarget == null)
                    return;
                nexttarget.disabled = false;
                nexttarget.style.backgroundColor = "white";
                filtro(target, nexttarget);
                if (target == $('#columndivcampo select')[0]) {
                    for (var contval = 1; contval &lt; $('#columndivcampo select').length; contval++)
                        $('#columndivcampo select')[contval].value = 0;
                    $('#columndivcampo select')[$('#columndivcampo select').length - 1].disabled = true;
                    $('#columndivcampo select')[$('#columndivcampo select').length - 1].style.backgroundColor = "#ebebe4";
                }
                else if (nexttarget.value != 0)
                    nexttarget.value = 0;
                for (var continput = 0; continput &lt; $('#columndivcampo input').length; continput++) {
                    $('#columndivcampo input')[continput].disabled = true;
                    $('#columndivcampo input')[continput].value = 0;
                }
            }
            function filtro(target, nexttarget) {
                var seleccion1 = target.selectedOptions[0].textContent;
                var vindex;
                var filtrado = $scope.bateriainversor.filter(function (el, i, self) {
                    if (target == $('#columndivcampo select')[0]) {
                        vindex = 4;
                        return el[Object.keys(self[0])[2]] == seleccion1;
                    }
                    if (target == $('#columndivcampo select')[1]) {
                        vindex = 3;
                        return el[Object.keys(self[0])[4]] == seleccion1;
                    }
                });
                var Aoptions = new Array();
                for (var s1 = 1; s1 &lt; nexttarget.options.length; s1++) {
                    for (contfiltro = 0; contfiltro &lt; filtrado.length; contfiltro++) {
                        var valoractual = Object.values(filtrado[contfiltro])[vindex]
                        if (Aoptions.includes(nexttarget.options[s1].innerText) == false)
                            nexttarget.options[s1].style = 'display:none';
                        if (nexttarget.options[s1].innerText == valoractual) {
                            Aoptions.push(nexttarget.options[s1].innerText);
                            nexttarget.options[s1].style = 'display:initial';
                        }
                    }
                }
            }
            filtroinput = function () {
                var filtrado = $scope.bateriainversor.filter(function (el, i, self) {
                    return el[Object.keys(self[0])[3]] == $('#columndivcampo select')[$('#columndivcampo select').length - 1].selectedOptions[0].textContent;
                });
                var filtrado2 = filtrado.filter(function (el, i, self) {
                    return el[Object.keys(self[0])[4]] == $('#columndivcampo select')[$('#columndivcampo select').length - 2].selectedOptions[0].textContent;
                });
                $scope.bateriainversorseleccionado = filtrado2[0];
                for (var continput = 0; continput &lt; $('#columndivcampo input').length; continput++) {
                    $('#columndivcampo input')[continput].disabled = false;
                    $.each(filtrado2[0], function (index, value) {
                        if ($('#columndivcampo input')[continput].previousSibling.textContent == index)
                            $('#columndivcampo input')[continput].value = value;
                    })
                }
            }
            //CARGA BASE DATOS
            await $http.get('selbateriainversor.php').success(function (data) {
                $scope.bateriainversor = data;
            });
            //Declaración de variables
            var Acampos = Object.getOwnPropertyNames($scope.bateriainversor[0]);
            var Acamposshow = new Array();
            var Aetiquetacampos = new Array();
            var Ocampos = new CamposBateriaInversor();
            var Avalores = new Array();
            var Ovalores = new ValoresBateriaInversor([], [], []);
            var Ovaloractual = new Object();
            var labels = new Array();
            var selects = new Array();
            var options = new Array();
            var inputs = new Array();
            //Creación de elementos
            var label1 = document.createElement('label');
            label1.innerText = 'Datos Inversor';
            label1.style = 'margin-top: 10px;display: flex;justify-content: center;'
            var label2 = document.createElement('label');
            label2.innerText = 'Datos Batería';
            label2.style = 'margin-top: 10px;display: flex;justify-content: center;'
            labels.push(label1, label2);
            var columndiv1 = document.createElement('div');
            columndiv1.id = "columndivcampo";
            columndiv1.style = "display:flex;flex-direction:column;"
            var option0 = document.createElement('option');
            option0.text = '- Selecciona -';
            option0.value = '0';
            option0.setAttribute('hidden', 'selected');

            var buttonsfooter = '&lt;button type="button" onclick="guardarValoresComplemento(' + cont + ',' + clase + ')" class="btn btn-primary pull-left">Aceptar&lt;/button> &lt;button type="button" class="btn btn-default" onclick="borrarButton(' + tipo + ',' + tipo2 + ',' + gen + ',' + ali + ',' + cont + ')">Borrar&lt;/button> &lt;button type="button"class="btn btn-secondary" data-dismiss="modal">Cancelar&lt;/button>'
            // PREPARACION CONTENT
            Acamposshow.push(Acampos[2], Acampos[4], Acampos[3], Acampos[9], Acampos[16], Acampos[23], Acampos[26], Acampos[38], Acampos[37]);
            for (contcampo = 0; contcampo &lt; Acamposshow.length; contcampo++) {
                var campoactual = Aetiquetacampos[contcampo];
                campoactual = document.createElement('span');
                campoactual.id = Acamposshow[contcampo];
                campoactual.innerText = Acamposshow[contcampo];
                campoactual.style = '    margin-top: 10px;';
                Aetiquetacampos.push(campoactual);
                if (Aetiquetacampos.length == 3) {
                    for (var x = 0; x &lt; Object.keys(Ocampos).length; x++) {
                        if (Ocampos[Object.keys(Ocampos)[x]] == undefined) {
                            Ocampos[Object.keys(Ocampos)[x]] = Aetiquetacampos;
                            Aetiquetacampos = [];
                            break;
                        }
                    }
                }
            }
            for (var contcolumna = 0; contcolumna &lt; Object.keys(Ocampos).length; contcolumna++) {
                for (var cont = 0; cont &lt; Object.values(Ocampos)[contcolumna].length; cont++) {
                    for (var contfila = 0; contfila &lt; $scope.bateriainversor.length; contfila++) //para valores
                    {
                        $.each($scope.bateriainversor[contfila], function (index, value) {
                            if (Object.values(Ocampos)[contcolumna][cont].innerText == index &amp;&amp; Avalores.includes(value) == false)
                                Avalores.push(value);
                        })
                    }
                    Ovaloractual[Object.values(Ocampos)[contcolumna][cont].innerText] = Avalores;
                    Ovalores[Object.keys(Ovalores)[contcolumna]].push(Ovaloractual);
                    Ovaloractual = new Object();
                    Avalores = [];
                }
            }
            //ATTACH CONTENT
            document.getElementById('caracteristicas').appendChild(header);
            document.getElementById('caracteristicas').appendChild(columndiv1);
            document.getElementById('footerCaracteristicas').innerHTML = buttonsfooter;
            for (var contcolumna = 0; contcolumna &lt; Object.keys(Ocampos).length; contcolumna++) {
                for (var cont = 0; cont &lt; Object.values(Ocampos)[contcolumna].length; cont++) {
                    if (contcolumna == 1 &amp;&amp; cont == 0) {
                        columndiv1.appendChild(labels[0]);

                    }
                    else if (contcolumna == 2 &amp;&amp; cont == 0)
                        columndiv1.appendChild(labels[1]);

                    columndiv1.appendChild(Object.values(Ocampos)[contcolumna][cont]);

                    if (contcolumna != 0) {
                        inputs[cont] = document.createElement('input');
                        inputs[cont].setAttribute('type', 'number');
                        inputs[cont].id = 'inputInversor' + cont + '' + contcolumna + '';
                        inputs[cont].style = 'text-align: center;transform: scale(1);width: fit-content;'
                        inputs[cont].setAttribute('disabled', 'true');
                        columndiv1.appendChild(inputs[cont]);
                    }
                    if (contcolumna == 0) {
                        selects[cont] = document.createElement('select');
                        selects[cont].id = 'sel' + cont;
                        selects[cont].style = 'width: fit-content;';
                        columndiv1.appendChild(selects[cont]);
                        selects[cont].addEventListener('change', selactivate);
                        selects[cont].appendChild(option0.cloneNode(true));
                        for (var contoption = 0; contoption &lt; Object.values(Object.values(Ovalores)[contcolumna][cont])[0].length; contoption++) {
                            options[contoption] = document.createElement('option');
                            options[contoption].text = Object.values(Object.values(Ovalores)[contcolumna][cont])[0][contoption];
                            options[contoption].value = (contoption + 1);
                            selects[cont].appendChild(options[contoption]);
                        }
                        options = [];
                    }

                }
            }
            for (var blocksel = 1; blocksel &lt; $('#columndivcampo select').length; blocksel++) {
                $('#columndivcampo select')[blocksel].disabled = true;
                $('#columndivcampo select')[blocksel].style.backgroundColor = "#ebebe4";
            }

            // CARGA DATOS 
            cargarbateriainversor(equipoguardado);
            // $('#myModalCaracteristicas').modal('show');



        }
        //Conectamos con la base de datos y obtenemos los valores de las distintas tablas
        $http.post('casos.php', { 'idusuario': usuario, 'base':1 }).success(function (data) {
            $scope.caso = data;
            ADcaso = data;
            $http.post('usuarios.php',{'base':1 }).success(function (data) {
                $scope.usuarios = data;
                ADusuarios = data;
                for (var contuser = 0; contuser &lt; $scope.usuarios.length; contuser++)
                    if ($scope.usuarios[contuser].id == usuario)
                        user = $scope.usuarios[contuser];
                document.getElementById('menuPrincipal').style.visibility = "visible";
                opciones.style.visibility = "visible";
                OcultarSpinner();
                var status = 2;
                menudisabled(status);
            });
        });
        $http.post('consumoContador.php',{'base':1 }).success(function (data) {
            $scope.consumo = data;
            ADconsumo = data;
        });
        $http.get('previsionbevphev.php').success(function (data) {
            $scope.prevision = data;
            ADprev = data;
        });
        $http.get('seleccionEdificio.php').success(function (data) {
            $scope.edificio = data;
        });
        $http.get('construccionesDefecto.php').success(function (data) {
            $scope.construcciones = data;
            ADcons = data;
        });
        $http.post('comunidades.php',{'base':1 }).success(function (data) {
            $scope.comunidad = data;
        });
        $http.post('provincia.php',{'base':1 }).success(function (data) {
            $scope.provincia = data;
        });
        $http.get('localidad.php').success(function (data) {
            $scope.localidad = data;
        });
        $http.get('valoresHorarios.php').success(function (data) {
            $scope.valoreshorarios = data;
        });
        $http.get('seleccionBus.php').success(function (data) {
            $scope.bus = data;
            ADbus = data;
        });
        $http.get('complementos.php').success(function (data) {
            $scope.complementos = data;
        });
        $http.get('relacionComplementoBus.php').success(function (data) {
            $scope.complementoBus = data;
        });
        $http.get('relacionEdificioComplementoBusEx.php').success(function (data) {
            $scope.edificioComplementoBusEx = data;
        });
        $http.get('relacionEdificioComplementoBusip1.php').success(function (data) {
            $scope.edificioComplementoBusip1 = data;
        });
        $http.get('relacionEdificioComplementoBusip2.php').success(function (data) {
            $scope.edificioComplementoBusip2 = data;
        });
        $http.get('relacionEdificioComplementoBusip3a.php').success(function (data) {
            $scope.edificioComplementoBusip3a = data;
        });
        $http.get('relacionEdificioComplementoBusip3b.php').success(function (data) {
            $scope.edificioComplementoBusip3b = data;
        });
        $http.get('uso.php').success(function (data) {
            $scope.uso = data;
        });
        $http.get('relacionServicioBus.php').success(function (data) {
            $scope.servicioBus = data;
        });
        /*
        $http.get('relacionservicioservicio.php').success(function (data) {
            $scope.servicioServicio = data;
        });
        */
        $http.get('tipocomplemento.php').success(function (data) {
            $scope.tipoComplemento = data;
        });
        $http.get('selectoresServicios1.php').success(function(data) {
            $scope.captadores = data;
            Oequipo["captadores planos"] = data;
        });
        $http.get('selectoresServicios2.php').success(function(data) {
            $scope.tubosVacio = data;
            Oequipo["Tubo de vacío"] = data;
        });
        $http.get('selectoresServicios5.php').success(function(data) {
            $scope.mase = data;
            Oequipo["Simple efecto"] = data;
        });
        $http.get('selectoresServicios27.php').success(function (data) {
            $scope.calderasbt = data;
            Oequipo["Baja temperatura"] = data;
        });
        $http.get('selectoresServicios28.php').success(function (data) {
            $scope.calderascondensacion = data;
            Oequipo["Caldera condensación"] = data;
        });
        $http.get('selectoresServicios29.php').success(function (data) {
            $scope.calderasbiomasa = data;
            Oequipo["Calderas de biomasa"] = data;
        });
        $http.get('selectoresServicios32.php').success(function (data) {
            $scope.bombacaloraireagua = data;
            Oequipo["Bomba de calor aire agua"] = data;
        });
        $http.get('selectoresServicios33.php').success(function (data) {
            $scope.bombacaloraguaagua = data;
            Oequipo["Bomba de calor agua agua"] = data;
        });
        $http.get('selectoresServicios34.php').success(function (data) {
            $scope.enfriadorarecuperacion = data;
            Oequipo["Enfriadora con recuperación"] = data;
        });
        $http.get('tipoedificio.php').success(function (data) {
            $scope.tipoEdificio = data;
        });
        $http.get('tiposervicio.php').success(function (data) {
            $scope.tipoServicio = data;
        });
        $http.get('tipouso.php').success(function (data) {
            $scope.tipoUso = data;
        });
        $http.get('relacionEdificioServicioBus.php').success(function (data) {
            $scope.edificioServicioBus = data;
        });
        $http.get('relacionEdificioServicioBusEx.php').success(function (data) {
            $scope.edificioServicioBusEx = data;
        });
        $http.get('relacionEdificioServicioBusExip1.php').success(function (data) {
            $scope.edificioServicioBusExip1 = data;
        });
        $http.get('relacionEdificioServicioBusExip2.php').success(function (data) {
            $scope.edificioServicioBusExip2 = data;
        });
        $http.get('relacionEdificioServicioBusExip3a.php').success(function (data) {
            $scope.edificioServicioBusExip3a = data;
        });
        $http.get('relacionEdificioServicioBusExip3b.php').success(function (data) {
            $scope.edificioServicioBusExip3b = data;
        });
        $http.get('relacionEdificioServicioBusNuip1.php').success(function (data) {
            $scope.edificioServicioBusNuip1 = data;
        });
        $http.get('relacionEdificioServicioBusNuip2.php').success(function (data) {
            $scope.edificioServicioBusNuip2 = data;
        });
        $http.get('relacionEdificioServicioBusNuip3a.php').success(function (data) {
            $scope.edificioServicioBusNuip3a = data;
        });
        $http.get('relacionEdificioServicioBusNuip3b.php').success(function (data) {
            $scope.edificioServicioBusNuip3b = data;
        });
        $http.get('relacionEdificioUsoBus.php').success(function (data) {
            $scope.edificioUsoBus = data;
        });
        $http.get('relacionEdificioUsoBusEx.php').success(function (data) {
            $scope.edificioUsoBusEx = data;
        });
        $http.get('relacionEdificioUsoBusip1.php').success(function (data) {
            $scope.edificioUsoBusNuip1 = data;
        });
        $http.get('relacionEdificioUsoBusip2.php').success(function (data) {
            $scope.edificioUsoBusNuip2 = data;
        });
        $http.get('relacionEdificioUsoBusip3a.php').success(function (data) {
            $scope.edificioUsoBusNuip3a = data;
        });
        $http.get('relacionEdificioUsoBusip3b.php').success(function (data) {
            $scope.edificioUsoBusNuip3b = data;
        });
        $http.get('seleccionServicios.php').success(function (data) {
            $scope.servicios = data;
        });
        $http.get('seleccionServiciosEx.php').success(function (data) {
            $scope.serviciosEx = data;
        });
        $http.get('usoBus.php').success(function (data) {
            $scope.usobus = data;
        });
        $http.get('diasTipo.php', {'base':1}).success(function (data) {
            $scope.tipodias = data;
        });
        $http.get('casoDiasTipo.php').success(function (data) {
            $scope.casotipodias = data;
        });
        $http.get('unidadesFuncionales.php').success(function (data) {
            $scope.funcionales = data;
        });
        $http.get('unidadesGenericas.php', { 'idusuario': usuario, }).success(function (data) {
            $scope.genericas = data;
        });
        $http.get('composicionGenericas.php').success(function (data) {
            $scope.compgenericas = data;
        });
        // $http.get('vehiculoElectricoAvanzado.php').success(function (data) {
        //     $scope.vehiculoElectricoAvanzado = data;
        // });
        $http.get('ve_uf_unidadesfuncionales.php').success(function (data) {
            $scope.ve_uf_unidadesfuncionales = data;
        });
        $http.get('usuarios.php',{'base':1 }).success(function (data) {
            $scope.usuarios = data;
            ADusuarios = data;
            $scope.tipousuario = false;
            $scope.isEven = function () {
                for (var x = 0; x &lt; $scope.usuarios.length; x++) {
                    if ($scope.usuarios[x].id == usuario) {
                        if ($scope.usuarios[x].ua == "si")
                            return true;
                        else
                            return false;
                    }
                }
            }
        });
    });
}]);
window.onerror = function () {
    OcultarSpinner();
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed Jul 01 2020 15:15:51 GMT+0200 (GMT+02:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
